### エクスポート (基本監査ログ)

#### 目的・用途

本機能は、管理者として、基本監査ログの全件エクスポートを行う機能である。

#### 利用方法

管理画面の「ログ管理」にある「エクスポート」メニューから、基本監査ログのエクスポートを実行できる。

#### 利用可能なロール

|ロール|システム管理者|リポジトリ管理者|サブリポジトリ管理者|登録ユーザー|一般ユーザー|ゲスト(未ログイン)|
|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
|利用可否|○|○|||||

#### 機能内容

  - 「エクスポート」（Export）ボタン  
    Exportボタンを押すと、全件出力を実行してよいかの確認ダイアログを表示する。確認ダイアログで実行/キャンセルを選択する。

      - 「Execute」ボタン

          - 「実行」ボタンを押すと、確認用ダイアログを閉じて基本監査ログの全件エクスポートを行う。

          - 実行後はダウンロードのURLを画面上に表示する。

          - URLをクリックするとzipファイル(export\_log.zip)をダウンロードする。  
            なお、このzipファイルにコンテンツファイルは含まれていない。

          - 他のユーザーがエクスポート実行中の場合、Exportボタンを非活性化する。

          - Celeryが起動していない場合は「実行」ボタンを非活性化する．「Celery is not running.」のエラーメッセージを表示する．

      - 「キャンセル」ボタン

          - 「キャンセル」ボタンを押すと、基本監査ログの全件エクスポートを行なわずわ、確認用ダイアログを閉じる。

  - 「キャンセル」（Cancel）ボタン  
    初期状態は非活性とし、Exportを実行している時に活性とする。  
    Exportを実行している時に、キャンセルボタンを押すと、Export処理のキャンセルを行う。  
    ボタンを押すと、全件エクスポートの処理をキャンセルしてよいかの確認ダイアログを表示する。

      - 「実行」ボタン

          - 「実行」ボタンを押すと、基本監査ログの全件エクスポートを行わず、確認用ダイアログを閉じる。

      - 「キャンセル」ボタン

          - 「キャンセル」ボタンを押すと、全件エクスポート処理のキャンセルを行わず、確認用ダイアログを閉じる。

#### 関連モジュール

  - weko\_logging
  - weko\_admin
  - invenio\_files\_rest:ダウンロードファイル生成のみに使用

#### 処理概要

  - 一括出力（一括エクスポート）画面表示時に以下の処理が行われる。

      - weko\_logging.admin.ExportLogAdminView.index メソッドが呼び出され画面を表示する。

  - 一括出力（一括エクスポート）画面

      - 一括出力画面を表示している間、３秒ごとに weko\_logging.static.js.weko\_logging.export.js の checkExportStatus メソッドが呼び出される。このメソッド下でcheck\_export\_statusメソッドが呼び出され、これによってceleryが起動しているか、エクスポートできるかを確認する。

      - celeryが起動していない、uri\_statusがfalseの場合は「エクスポート」ボタンを不活性化する。

      - 「エクスポート」ボタンを押し、更にポップアップの「Excute」ボタンを押下する。その場合、 weko\_logging.static.js.weko\_logging.export.js の handleExport メソッドによって export\_user\_activity\_log メソッドが呼び出され、更に export\_all\_user\_activity\_logs メソッドを呼び出す。これらによってエクスポートする基本監査ログを集め、ダウンロードURLを生成し、表示させる。

          - エクスポートして、URLが表示されるまでの間に、「キャンセル」ボタンを押し、「execute」ボタンを押す。その場合、 weko\_logging.admin.ExportLogAdminView.cancel\_export メソッドが呼び出され、ダウンロードURLの生成、表示をキャンセルする。

      - 画面上に表示されたダウンロードURLを押下する。その場合、 weko\_logging.admin.ExportLogAdminView.download\_user\_activity\_log メソッドにて、 FileInstance.get\_by\_uriメソッドが呼び出され、ダウンロードファイルを生成し、ダウンロードする。なお、ダウンロードされるファイル形式はzipであり、基本監査ログのファイル形式はtsv形式である。

          - 出力されるtsvファイルのファイル名: `user_activity_logs_yyMMddhhmmss.tsv`

      - エクスポート中にcheck\_celery\_is\_runメソッド、get\_export\_statusメソッドでエクスポートに必要な情報がとれない場合、ダウンロードURLは表示されない。

#### 更新履歴

| 日付 | GitHubコミットID | 更新内容 |
| --- | --- | --- |
| 2025/06/06 | d4285ebc75428677dc8c314171a631c6bbb1bfee | 初版作成 |