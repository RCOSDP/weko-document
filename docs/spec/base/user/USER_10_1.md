# ワークスペース：アイテム一覧情報取得

## 目的・用途

本機能は、リポジトリ管理者と登録ユーザーとして、アイテム一覧情報取得して、絞り込み条件や検索条件を設定することでアイテムを表示できる。また、表示したアイテムをTSV形式で出力し保存出来る。

## 利用方法

画面ヘッダの右側の［▼］ボタンをクリックし、プルダウンから「Workspace」を選択しアイテム一覧画面に遷移する。

 ## 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

  - アイテム一覧画面

  - 画面ヘッダの右側の［▼］ボタンをクリックし、プルダウンから「Workspace」を選択しアイテム一覧画面に遷移する。

      - アイテム一覧の表示項目を以下に示す
          - 「お気に入りアイコンボタン」
            - アイテムのお気に入り状況を表示する

          - 「タイトル」
            - 押下することでアイテム詳細画面に遷移する

          - 「DOIラベル」
            - リンク付けありで表示され、DOI情報を確認すると該当アイテムを既読に更新する

          - 「リソースタイプ」
            - リソースタイプを表示する

          - 「アイテム編集ボタン」
            - 押下することでアイテム編集画面に遷移する

          - 「既読未読アイコンボタン」
            - アイテムの既読・未読の状況を表示する

          - 「著者」
            - 著者名を表示する

          - 「アクセス数」
            - アクセス数を表示する
          - 「ステータス」
            - OAアシスト機能と連携してアイテムのステータスを表示する

          - 「アイテムチェックボタン」
            - 押下することでアイテムを選択する

          - 「雑誌名/会議名」
            - 雑誌名と会議名を表示する

          - 「巻（号）」
            - 巻（号）を表示する

          - 「資金別ラベル」
            - 助成機関名と研究課題名を表示する

          - 「ダウンロード数」
            - ダウンロード数を表示する

          - 「フィードバックメールの設定状況アイコン」
            - フィードバックメールの有無を表示する

          - 「出版年月日」
            - 出版年月日を表示する

          - 「関連リンク」
            - リンクから関連情報を確認すると、該当アイテムを既読に更新する

          - 「本文ファイル有無ラベル」
            - ファイルの状態とそのファイルの件数を表示する
            - 例：　「本文ファイル (10)： 公開（3）、エンバーゴ（5）、 制限公開（2）」

          - 「関連情報」
            - 関連情報タイプ、関連情報タイトル、関連情報URLリンクを表示する

  - デフォルト条件設定
      - アイテム一覧画面のグルーピングボタン、絞込み表示ボタン、並び替え項目及びページング件数より絞込表示を行う。

      - デフォルト条件の項目を以下に示す

          - 「リソースタイプ」
            ：Inputの形式で表示される。

          - 「査読の有無」
            ：CheckBoxの形式で表示される。

          - 「論文への関連の有無」
            ：CheckBoxの形式で表示される。

          - 「根拠データへの関連の有無」
            ：CheckBoxの形式で表示される。

          - 「資金別情報-助成機関名」
            ：Inputの形式で表示される。

          - 「資金別情報-研究課題名」
            ：Inputの形式で表示される。

          - 「本文ファイル有無」
            ：CheckBoxの形式で表示される。

          - 「お気に入りの有無」
            ：CheckBoxの形式で表示される。
    
  - 検索機能
    - アイテム一覧画面左上の検索内容入力欄に情報を入力することで、検索結果がアイテム一覧に表示される。
      - 検索条件はDOI、タイトル、雑誌名、会議名、資金名からインクリメンタルリサーチ機能で検索できる。
      - 検索結果が0件の場合、「検索条件と十分に一致する結果が見つかりません」というメッセージが表示される。

    - インクリメンタルサーチ機能内容
      - 検索処理の流れ
      1. アイテム一覧取得API (get_es_itemlist) を呼び出し、全データを取得する

      2. 検索ボックスに入力されると、全データに該当情報検索を行う

      3. 該当する項目をリスト化、最大6件を表示する（6件以下であれば、全件表示する）

      4. 検索処理を取得した全データより実行する

      5. 検索ワード選択肢で指定した項目を検索対象として設定する

      6. 検索キーワードから部分一致で検索、検索結果を表示する

      7. データの更新によってリストが自動更新され画面に反映する

  - アイテム出力

    - ログインしているユーザーが「アイテム出力」ボタンを押下することでアイテム一覧画面に表示されているアイテム、またはチェックボックスで選択している項目をTSV形式で出力し保存する。

    - 出力ファイル名：「itemlist_workspace_export_YYYYMMDDhhmmss.tsv」

    -  出力時にエラーが発生した場合は、「出力時にエラーが出ました」というメッセージを表示する。

    - アイテム出力カラムフォーマット

    | 論理名                       | 物理名                        | 出力フォーマット      |
    |------------------------------|-------------------------------|----------------------|
    | お気に入りステータス         | favoriteSts                   | 0または1             |
    | 既読未読ステータス           | readSts                       | 0または1             |
    | 査読チェック状況             | peerReviewSts                 | 0または1             |
    | タイトル                     | title                         | 文字列               |
    | DOIリンク                    | doi                           | 文字列               |
    | リソースタイプ               | resourceType                  | 文字列               |
    | 著者名                       | authorName                    | 文字列               |
    | アクセス数                   | accessCnt                     | 数字                 |
    | アイテムステータス           | itemSts                       | 数字                 |
    | 雑誌名                       | magazineName                  | 文字列               |
    | 会議名                       | conferenceName                | 文字列               |
    | 巻                           | volume                        | 文字列               |
    | 号                           | issue                         | 文字列               |
    | 資金別情報機関名             | funderName                    | 文字列               |
    | 資金別情報課題名             | awardTitle                    | 文字列               |
    | ダウンロード数               | downloadCnt                   | 数字                 |
    | フィードバックメールステータス| fbEmailSts                    | 0または1             |
    | 出版年月日                   | publicationDate                | YYYY-MM-DD           |
    | 関連情報タイプ               | relationType                  | 文字列               |
    | 関連情報タイトル             | relationTitle                 | 文字列               |
    | 関連情報URLやDOI             | relationUrl                   | 文字列               |
    | 論文への関連チェック状況      | connectionToPaperSts          | 0または1             |
    | 根拠データへの関連チェック状況| connectionToDatasetSts        | 文字列               |
    | 本文ファイル数               | fileCnt                       | 数字                 |
    | 公開ファイル数               | publicCnt                     | 数字                 |
    | エンバーゴ数                 | embargoedCnt                  | 数字                 |
    | 制限公開ファイル数           | restrictedPublicationCnt      | 数字                 |
         

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_deposit
  - > weko\_items_ui
  - > weko\_workflow

<!-- end list -->

  - > 処理概要

> 画面ヘッダの右側の［▼］ボタンをクリックし、プルダウンから「Workspace」を押下するとget_workspace_itemlistが呼び出されアイテム一覧情報を取得する。

- 取得処理

#### デフォルト絞り込み条件取得処理

下記の条件でデフォルト絞り込み条件を取得する。

| 取得対象         | 取得条件         | 取得内容           |
|------------------|------------------|--------------------|
| workspace_default_conditionsテーブル | ログインユーザーID | デフォルト条件JSON |

- 取得できる場合はデフォルト条件JSONを設定する。
- 取得できなかった場合（正常終了）は各条件をNULLで設定する。
- 取得できなかった場合（異常終了）はアイテム一覧情報取得を異常終了する

#### Elasticsearchからアイテム一覧取得処理

既存のopensearch取得処理を流用し、下記の条件でアイテム一覧情報を取得する。

| 取得対象           | 取得条件                 | 取得内容               |
|--------------------|--------------------------|------------------------|
| [prefix]-weko-item | 該当メソッドのパラメータ | 該当メソッドのリターン |

- 取得できなかった場合（正常終了）はアイテム一覧情報取得処理を正常終了とする。
- 取得できなかった場合（異常終了）はアイテム一覧情報取得APIを異常終了とする。

#### お気に入り・既読未読ステータス取得処理

下記の条件でお気に入り・既読未読ステータスを取得する。

| 取得対象                        | 取得条件         | 取得内容           |
|---------------------------------|------------------|--------------------|
| workspace_status_managementテーブル | ログインユーザーID | お気に入りステータスと既読未読ステータス |

- 取得できる場合は各ステータスを設定する。
- 取得できなかった場合（正常終了）はデフォルトfalseで設定する。
- 取得できなかった場合（異常終了）は該当レコードIDをスキップする。

#### アクセス数・ダウンロード数取得処理

下記の条件でアクセス数・ダウンロード数を取得する。

| 取得対象                        | 取得条件                 | 取得内容               |
|---------------------------------|--------------------------|------------------------|
| [prefix]-stats-record-view,[prefix]-stats-file-download | レコードID | アクセス数とダウンロード数 |

- 取得できる場合はアクセス数を設定する。
- 取得できなかった場合（正常終了）はデフォルト0を設定する。
- 取得できなかった場合（異常終了）は該当レコードIDをスキップする。

#### アイテムステータス取得処理

下記の条件でアイテムステータスを取得する。

| 取得対象                   | 取得条件   | 取得内容    |
|----------------------------|------------|-------------|
| OaStatusモデルのレコード    | アイテムPID | OAステータス |

- 取得できる場合は下記の変換仕様に従い変換する。
- 取得できなかった場合（正常終了）はデフォルト0で設定する。
- 取得できなかった場合（異常終了）は該当レコードIDをスキップする。

- OAアシスト機能とWeko側のステータス変換仕様

| OAアシスト機能で使用しているステータス（日本語） | OAアシスト機能で使用しているステータス（英語） | 変換仕様 | Weko側のステータス（日本語） | Weko側のステータス（英語） |
|----------------------------------|----------------------------------|--------|----------------------|----------------------|
| 未処理                           | Unprocessed                      | →      | 未連携               | Unlinked             |
| 未処理 保留中                    | Unprocessed Pending              | →      | 未連携               | Unlinked             |
| 処理中 メタデータ登録済           | Processing Metadata Registered   | →      | メタデータ登録済      | Metadata Registered  |
| 処理中 メタデータ登録済（本文依頼済） | Processing Metadata Registered (Fulltext Requested) | → | 本文依頼中           | Fulltext Requested   |
| 処理中 メタデータ登録済（本文入手済） | Processing Metadata Registered (Fulltext Obtained) | → | 本文提供済           | Fulltext Provided    |
| 処理中 メタデータ未登録（本文依頼済） | Processing Metadata Not Registered (Fulltext Requested) | → | 未連携（本文依頼中） | Unlinked (Fulltext Requested) |
| 処理中 メタデータ未登録（本文入手済） | Processing Metadata Not Registered (Fulltext Obtained) | → | 未連携（本文提供済） | Unlinked (Fulltext Provided) |
| 処理済 本文公開済（OA）           | Processed Fulltext Opened (OA)   | →      | OA                   | OA                   |
| 処理済 本文登録済（エンバーゴあり） | Processed Fulltext Registered (Embargo) | → | （エンバーゴ期間内）⇒エンバーゴ<br>（経過後）⇒OA済 | Embargo OA           |
| 処理済（非OA） メタデータ公開済（本文非公開） | Processed (Not OA) Metadata Opened (Fulltext Not Opened) | → | 非OA                 | Not OA               |
| 処理済（非OA） メタデータ公開済（本文制限公開） | Processed (Not OA) Metadata Opened (Fulltext Opened Limitedly) | → | 制限公開             | Opened Limitedly     |
| 登録不可 著者の連絡先不明・不達   | Unregistrable No Contact Information/Undeliverable | → | 未連携               | Unlinked             |
| 登録不可 著者からの返信なし       | Unregistrable No Reply           | →      | 未連携               | Unlinked             |
| 登録不可 著者・共著者の許諾なし   | Unregistrable No Permission      | →      | 未連携               | Unlinked             |
| 登録不可 登録可能原稿なし         | Unregistrable No Fulltext        | →      | 未連携               | Unlinked             |
| 登録不可 他の理由（登録不可）     | Unregistrable Other Reasons      | →      | 未連携               | Unlinked             |
| 登録見送り 他でOA済               | Excluded Already Opened Elsewhere | →     | OA済み（外部サイト）  | Opened Elsewhere     |
| 登録見送り 助成区分が即時OAの対象外 | Excluded Not Funded by Designated FA | →   | 未連携               | Unlinked             |
| 登録見送り 筆頭著者が他機関所属   | Excluded Not Affiliated First Author | →   | 未連携               | Unlinked             |
| 登録見送り 重複通知               | Excluded Overlapped Content      | →      | 未連携               | Unlinked             |
| 登録見送り 他の理由（登録見送り） | Excluded Other Reasons           | →      | 未連携               | Unlinked             |

#### ユーザー名取得処理

下記の条件でユーザー名を取得する。

| 取得対象                | 取得条件         | 取得内容                        |
|-------------------------|------------------|---------------------------------|
| userprofiles_userprofile | ログインユーザーID | userprofiles_userprofileのusername |

- 取得したユーザー名がNULL、または取得できない場合はユーザーのメールアドレスを設定する。
- 取得処理が異常終了の場合は該当レコードIDをスキップする。

#### デフォルト絞り込み条件更新処理

下記の条件で「workspace_default_conditions」テーブルのデフォルト条件JSON項目内容の更新を行う。

| 更新対象                        | 更新条件         | 更新内容               |
|-------------------------------|------------------|------------------------|
| workspace_default_conditionsテーブル | ログインユーザーID | デフォルト条件JSON項目 |


  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2025/06/06</p>
</blockquote></td>
<td>057e4d8985a4b5526c0db7f07f717a4bb45bc984</td>
<td>初版作成</td>
</tr>
</tbody>
</table>


