# アクティビティ一覧表示

## 目的・用途

アクティビティとは、ワークフローを用いてアイテムに対する活動を管理するインスタンスである。

![](media/media/image1.png)

アクティビティ一覧はアイテムが登録中／編集中／終了のいずれであるかを一覧化して管理している機能である。

## 利用方法

WEKO3へログイン後、\[WorkFlow\]タブを押下することで、アクティビティ一覧が表示される。

アイテムを登録するには、アクティビティ一覧の\[New Activity\]ボタンを押下することで、ワークフロー一覧が表示される。

## 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

## 機能内容

### 1. アクティビティ一覧を表示する

  - TOPページから「ワークフロー」タブを押すと、アクティビティ一覧が状態別に表示される
    
      - デフォルト：「Todo」タブ
    
      - アクティビティに対して、以下の情報を表示する

<table>
<thead>
<tr class="header">
<th>#</th>
<th>表示項目</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>No.</td>
<td>　</td>
</tr>
<tr class="even">
<td>2</td>
<td>作成日（Created）</td>
<td><p>アクティビティの作成日付<br />
フォーマット：YYYY-MM-DD</p>
<p>デフォルト値としてサーバ日付を設定する（サーバ日付は/api/admin/get_server_dateから取得する）</p></td>
</tr>
<tr class="odd">
<td>3</td>
<td>更新日（Updated）</td>
<td>アクティビティの更新日付<br />
フォーマット：YYYY-MM-DD</td>
</tr>
<tr class="even">
<td>4</td>
<td>Activity</td>
<td>アクティビティID<br />
リンクを押すと、ワークフローの該当アクション画面に遷移する</td>
</tr>
<tr class="odd">
<td>5</td>
<td>アイテム（Item）</td>
<td>アイテムのタイトル※1</td>
</tr>
<tr class="even">
<td>6</td>
<td>ワークフロー（WorkFlow）</td>
<td>ワークフロー名</td>
</tr>
<tr class="odd">
<td>7</td>
<td>アクション（Action）</td>
<td>アクティビティの実行中アクション</td>
</tr>
<tr class="even">
<td>8</td>
<td>ステータス（Status）</td>
<td>アクティビティのステータス<br />
「作業中」(Doing)：アクティビティが登録中/編集中/承認待ち<br />
「作業済」(Done)：アクティビティが終了<br />
「中止」(Canceled)：アクティビティが強制終了</td>
</tr>
<tr class="odd">
<td>9</td>
<td>User</td>
<td>アイテム編集中はアクティビティを作成したユーザーのメールアドレス、Approval後は承認者のメールアドレスを表示する</td>
</tr>
</tbody>
</table>

  - 各タブの概要
    
      - 「ToDo」タブ
        
          - 登録者または、処理権限を有するユーザーに対して、登録中/編集中のアクティビティを表示する
        
          - 承認者の場合、承認待ちのアクティビティも表示する
    
      - 「Wait」タブ
        
          - 登録者または、処理権限を有するユーザーに対して、承認者の承認待ちのアクティビティを表示する
    
      - 「すべて（All）」タブ
        
          - 登録者または、処理権限を有するユーザーに対して、登録中/編集中／完了のアクティビティを表示する（承認待ちのものは表示しない）
        
          - 承認者の場合、承認待ちのアクティビティも表示する
        
          - アクティビティ一覧のダウンロード、クリアができる。

  - 
  - 各タブに表示される内容

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>ToDo</th>
<th>Wait</th>
<th>All</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>システム管理者</td>
<td>自分で作成したアイテムの承認待ちのもの<br />
自分が入力途中のもの<br />
他のシステム管理者が作成したアイテムの承認待ちのもの<br />
リポジトリ管理者が作成したアイテムの承認待ちのもの<br />
コミュニティ管理者が作成したアイテムの承認待ちのもの<br />
登録者が作成したアイテムの承認待ちのもの<br />
代理登録が設定されたアクティビティは表示される</td>
<td>　</td>
<td>自分で作成したアイテムの承認待ちのもの<br />
自分が入力途中のもの<br />
自分が入力をキャンセルしたアクティビティ<br />
他のシステム管理者が作成したアイテムの承認待ちのもの<br />
他のシステム管理者の入力途中のもの<br />
他のシステム管理者が入力をキャンセルしたアクティビティ<br />
リポジトリ管理者が作成したアイテムの承認待ちのもの<br />
リポジトリ管理者の入力途中のもの<br />
リポジトリ管理者が入力をキャンセルしたアクティビティ<br />
コミュニティ管理者が作成したアイテムの承認待ちのもの<br />
コミュニティ管理者の入力途中のもの<br />
コミュニティ管理者が入力をキャンセルしたアクティビティ<br />
登録者が作成したアイテムの承認待ちのもの<br />
登録者の入力途中のもの<br />
登録者が入力をキャンセルしたアクティビティ</td>
</tr>
<tr class="even">
<td>リポジトリ管理者</td>
<td>自分で作成したアイテムの承認待ちのもの<br />
自分が入力途中のもの<br />
システム管理者が作成したアイテムの承認待ちのもの<br />
他のリポジトリ管理者が作成したアイテムの承認待ちのもの<br />
コミュニティ管理者が作成したアイテムの承認待ちのもの<br />
登録者が作成したアイテムの承認待ちのもの<br />
代理登録が設定されたアクティビティは表示される</td>
<td>　</td>
<td>自分で作成したアイテムの承認待ちのもの<br />
自分が入力途中のもの<br />
自分が入力をキャンセルしたアクティビティ<br />
システム管理者が作成したアイテムの承認待ちのもの<br />
システム管理者の入力途中のもの<br />
システム管理者が入力をキャンセルしたアクティビティ<br />
他のリポジトリ管理者が作成したアイテムの承認待ちのもの<br />
他のリポジトリ管理者の入力途中のもの<br />
他のリポジトリ管理者が入力をキャンセルしたアクティビティ<br />
コミュニティ管理者が作成したアイテムの承認待ちのもの<br />
コミュニティ管理者の入力途中のもの<br />
コミュニティ管理者が入力をキャンセルしたアクティビティ<br />
登録者が作成したアイテムの承認待ちのもの<br />
登録者の入力途中のもの<br />
登録者が入力をキャンセルしたアクティビティ</td>
</tr>
<tr class="odd">
<td>コミュニティ管理者</td>
<td>自分で作成したアイテムの承認待ちのもの<br />
自分が入力途中のもの<br />
<strong>（以下は権限あるインデックスに登録したアイテムであれば）</strong><br />
システム管理者が作成したアイテムの承認待ちのもの<br />
リポジトリ管理者が作成したアイテムの承認待ちのもの<br />
他のコミュニティ管理者が作成したアイテムの承認待ちのもの<br />
登録者が作成したアイテムの承認待ちのもの<br />
代理登録が設定されたアクティビティは表示される</td>
<td>　</td>
<td>自分で作成したアイテムの承認待ちのもの<br />
自分が入力途中のもの<br />
自分が入力をキャンセルしたアクティビティ<br />
<strong>（以下は権限あるインデックスに登録したアイテムであれば）</strong><br />
システム管理者が作成したアイテムの承認待ちのもの<br />
システム管理者の入力途中のもの<br />
システム管理者が入力をキャンセルしたアクティビティ<br />
リポジトリ管理者が作成したアイテムの承認待ちのもの<br />
リポジトリ管理者の入力途中のもの<br />
リポジトリ管理者が入力をキャンセルしたアクティビティ<br />
他のコミュニティ管理者が作成したアイテムの承認待ちのもの<br />
他のコミュニティ管理者が入力途中のアクティビティ<br />
他のコミュニティ管理者が入力をキャンセルしたアクティビティ<br />
登録者が作成したアイテムの承認待ちのもの<br />
登録者の入力途中のもの<br />
登録者が入力をキャンセルしたアクティビティ</td>
</tr>
<tr class="even">
<td>登録者</td>
<td><p>自分が入力途中のもの<br />
代理登録が設定されたアクティビティは表示されない</p>
<p>※</p></td>
<td>自分で作成したアイテムの承認待ちのものを表示する</td>
<td><p>自分が入力途中のもの<br />
自分が入力をキャンセルしたアクティビティ</p>
<p>※</p></td>
</tr>
</tbody>
</table>

※何らかのフローでAction Userに指定されており、実行中アクションがそれであるワークフローはすべて表示される

  - 代理登録機能
    
      - アクティビティのItem RegistrationアクションにあるContributorエリアに"Other User"としてユーザ名またはEmailを設定しておけば、設定されたユーザは、該当アイテムに「編集」ボタンが表示されて、アイテムの編集をすることが可能

  - ゲストユーザーがアクティビティ一覧のURLを直接入力してアクセスしようとした際はログイン画面に移動する

  - ![](media/media/image2.png)![](media/media/image2.png)![](media/media/image2.png)![](media/media/image2.png)![](media/media/image2.png)承認アクションが複数ある場合の挙動は以下の通り

  - 
### 2. アクティビティ一覧にフィルタリングとページングできる

  - フィルタリング
    
      - フィルタリングがアクティビティ一覧の上部に表示される
        
          - デフォルトの表示項目：登録日（Created）  
            登録日での開始日：1年前の当日
        
          - 「フィルターを追加▼」をクリックすると、以下の追加可能なフィルタリストを表示し、フィルタ名をクリックすると当該フィルタの入力エリアを追加する
            
              - ワークフロー
            
              - User
            
              - アイテム
            
              - ステータス  
                選択肢：作業中、作業済、中止
        
          - 各フィルタ項目の入力形式／検索方式／初期値
            
              - 登録日（日付／範囲指定／(自)1年前の当日(至)入力なし ）常設とする
            
              - アイテム（テキスト／前方一致／入力なし）。複数可。
            
              - ワークフロー（テキスト／前方一致／入力なし）。複数可。
            
              - ステータス（チェックボックス／完全一致／選択なし）。１つのみ。
            
              - User（テキスト／完全一致／入力なし）。複数可。
        
          - 追加されたフィルタの入力エリアに\[×\]ボタンを押すと、該当フィルターの入力エリアを削除する
        
          - 設定したフィルタは\[Apply(適用)\]ボタンを押下することで一覧に適用される
        
          - 表示されている条件についてAND検索する
        
          - 適用されたフィルタの内容は各タブ（ToDo, Wait, All）間で引き継がれる

  - ページング
    
      - ページ当たりの表示数（Display Number）をプルダウンより選択できる
    
      - 選択可能な件数は「20, 50, 75, 100」でデフォルトは「20」とする
    
      - ページングナビゲーションを操作することで、表示内容が切り替わる
    
      - 表示数は、ToDo、Wait、Allタブそれぞれ個別に適用される

  - アクティビティとアイテムとの関連は以下の通り。
    
      - アイテムを新規登録：　アクティビティXが作られる
    
      - アイテムAとして登録してワークフロー終了：　アイテムAはアクティビティXに紐づいている
    
      - アイテムAを編集する：　アクティビティYが作られ、編集中のアイテムAはアクティビティYに紐づく
    
      - アイテムAの編集完了（バージョンを上げない）：　編集後のアイテムAはアクティビティYに紐づいている。編集前のアイテムAはアクティビティXに紐づいたまま
    
      - 再度アイテムAを編集する：　アクティビティZが作られ、編集中のアイテムAはアクティビティZに紐づく
    
      - アイテムAの編集完了（バージョンを上げる）：　アイテムA(ver2)がアクティビティZに紐づく。アイテムA(ver1)はアクティビティYに紐づいたまま

### 3. TSVファイルダウンロード**

> **アク**ティビティをDBから物理削除する前のバックアップとして、TSVファイルにアクティビティログをダウンロードする。
> 
> 【前**提条件】**

  - > **利用**者のロールが、システム管理者またはリポジトリ管理者であること。

  - > アクティビティ一覧で、「すべて（All）」タブの内容を表示していること。

  - > 表示中のフィルタリング条件で、アクティビティが１件以上表示されていること。

  - > insta**nce.cfg(invenio.cfg) で、DELETE\_ACTIVITY\_LOG\_ENABLE = Trueであること。**

> **［**ダウンロード（Download）］ボタンを押すと、表示中のフィルタリング条件に従った内容のTSVファイルがダウンロードされる。
> 
> TS**Vファイルに書き込まれる件数は、以下の定数によって制限されている。**

  - > **パス：**modules**/weko-workflow/weko\_workflow/config.py**
    
      - > **設定キー：WEKO\_WORKFLOW\_ACTIVITYLOG\_BULK\_MAX**

> 制限**より多い件数のアクティビティログをダウンロードするときは、workflow\_activityテーブルのid降順で制限まで取得する。**

**4. アクティビティ削除**

> **アク**ティビティを、表示中の全件または１件物理削除する。
> 
> 【前**提条件】**

  - > **利用**者のロールが、システム管理者またはリポジトリ管理者であること。

  - > アクティビティ一覧で、「すべて（All）」タブの内容を表示していること。

  - > 表示中のフィルタリング条件で、アクティビティが１件以上表示されていること。

  - > insta**nce.cfg(invenio.cfg) で、DELETE\_ACTIVITY\_LOG\_ENABLE = Trueであること。**

> **［**ダウンロード（Download）］ボタンの隣に表示されている［クリア（Clear）］ボタンを押すと、表示中のフィルタリング条件に従ったアクティビティが全件物理削除される。
> 
> アクティビティ一覧の各行に表示されている［クリア（Clear）］ボタンを押すと、その行のアクティビティが物理削除される。
> 
> 削除時、確認ダイアログを表示することで確認を行う。
> 
> 実行中のアクティビティを削除する場合は、アクティビティを強制終了する。
> 
> 削除すると同時に削除対象のアクティビティのTSVファイルがダウンロードされる。
> 
> 全件**削除時、削除件数は以下の定数によって制限されている。**

  - > **パス：modules/weko-workflow/weko\_workflow/config.py**
    
      - > **設定キー：WEKO\_WORKFLOW\_ACTIVITYLOG\_BULK\_MAX**

> **制限より多い件数のアクティビティを削除するときは、workflow\_activityテーブルのid降順で制限に達するまで削除する。**

  - > 関連モジュール

<!-- end list -->

  - > weko\_workflow

<!-- end list -->

  - > 処理概要

1\. 設定

> アクティビティの各タブを定義する（開発に使用している）

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-workflow/weko_workflow/config.py#L278-L182>

  - > 設定キー及び設定値：

> WEKO\_WORKFLOW\_TODO\_TAB = 'todo'
> 
> WEKO\_WORKFLOW\_WAIT\_TAB = 'wait'
> 
> WEKO\_WORKFLOW\_ALL\_TAB = 'all'

2\. 実装方法

> 対応しているモジュール：weko\_workflow
> 
> アクティビティ一覧

  - > ログインしているユーザーの権限に応じてデータを「get\_activity\_list」メソッドでデータベースから取得する
    
      - > 「Todo」タブに対して
        
          - > 管理者の権限には、以下の条件でデータを取得する

> 【条件】  
> ステータス：作業中、承認待ちではない

  - > フローに設定されている承認者には、追加で以下の条件でデータを取得する

> 【条件】  
> ステータス：作業中、承認待ち  
> アクティビティの承認者

  - > 他の権限には、以下の条件でデータを取得する

> 【条件】  
> ステータス：作業中、承認待ちではない  
> アクティビティの作成者、または代理者

  - > 「Wait」タブに対して
    
      - > 該当承認者には、以下の条件でデータを取得する

> ステータス：作業中、承認待ち

  - > 取得されたデータをUIに以下のテンプレートで表示する

> テンプレート： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-workflow/weko_workflow/templates/weko_workflow/activity_list.html>
> 
> デフォルトの表示数：20  
> ページ：1
> 
> フィルタリング

  - > アクティビティ一覧での「適用」ボタンを押すと、UIに入力されているフィルタリングの情報を検索条件とし、満たすデータを「filter\_conditions」メソッドでデータベースから取得する  
    > フィルタリングの対象：「createdfrom」、「createdto」、「workflow」、「user」、「item」、「status」

  - > フィルタリングされたデータをUIに選択されている表示数で表示する

> ページング

  - > データをデータベースから取得する時、表示数を元に、表示のページを取得されたアクティビティ一の総数で数える

> TSVファイルダウンロード

  - > views.py::download\_activitylog()メソッド

> アクティビティ削除

  - > views.py::clear\_activitylog()メソッド

【補足】

  - > バージョンを「上げる/上げない」それぞれのアクティビティの挙動
    
    1.  > アイテムバージョンを上げないときにはアクティビティはver1に紐づく
    
    2.  > 編集終了後にver2になったときにはアクティビティはver2に紐づく

  - > アクティビティが生成されるタイミングは、以下の時点
    
    1.  > アクティビティの作成画面（workflow/activity/new）に［新規］（New）ボタンを押す時点
    
    2.  > アイテム詳細画面に［編集］（Edit）ボタンを押す時点

  - > アイテム編集時、バージョンを変えない場合はアクティビティが増えていく

  - > ワークフロー一覧のユーザはユーザメールアドレスが表示される

  - > ワークフロー一覧のwaitに表示されるものは承認待ちの状態。  
    > 処理（承認）できる権限は、システム管理者、リポジトリ管理者、該当のコミュニティ管理者、または【Administration \> ワークフロー管理（WorkFlow） \> フロー（Flow List）画面】の該当のフローにて、「Approval」に指定されているアクションロール、アクションユーザ

  - > アクティビティが終了とするとき、アクティビティのアクションが「End」に移動、「End」アクションのステータスが「作業済」となる。

  - > アイテム編集時、アイテムバージョンを上げた場合、アイテムを新規レコードとして作成し、アイテムの情報を保存する

  - > 過去のアイテムが、どのアクティビティに紐づいていたのかの関係は画面上確認ができない。  
    > 各アイテムバージョンの情報及び、アクティビティの情報は【Administration \> レコード管理（Records） \> 永続識別子（Persistent Identifier）】画面で管理されている。

  - > アクティビティが生成されると新規UUIDへ紐づけを行う

  - > アイテム削除したアクティビティもAllタブには残る。アクティビティのリンクを押下すると、エラー画面が表示される。

> アイテムメタデータのエスケープ処理は以下の通り。インデックス名や著者名に対しても同様に処理する

  - > メタデータ保存時
    
      - > メタデータをJSON形式で保存。メタデータの文字で、JSON形式の文字の同じと文字がある場合、JSONに「￥"」に変換して保存する。

  - > メタデータの出力時
    
      - > OAI-PMH出力  
        > DBに保存しているメタデータから、pythonでOAI-PMH出力される。  
        > python処理でJSONからの「￥"」文字を「"」に変換して出力するため、OAI-PMH出力時にメタデータと同じように表示される
    
      - > NFKD正規化を行う。
    
      - > 一括エクスポート、JSON出力  
        > エクスポートファイルの形式によって、特殊文字がエスケープされる。  
        > 一括エクスポートファイルの形式は「.tsv」であり、「"」を「""」文字に変換して出力する。  
        > JSON出力ファイルの形式は「.json」であり、出力時の処理は上記のDB保存の処理と同様。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>
