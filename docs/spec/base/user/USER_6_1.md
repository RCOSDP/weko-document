
### ランキング

  - > 目的・用途

本機能は、アイテムの閲覧回数やファイルのダウンロード回数やアイテムの作成ユーザーなどのランキングを閲覧する機能である。

  - > 利用方法

【Administration \> Setting (設定) \> Ranking (ランキング表示)からランキングの機能を設定し、トップ画面からランキングのリンクを押下することで、設定に沿ったアイテムがランキング方式で表示される。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

1\. ランキングに対して設定する

  - リポジトリ管理者として、【Administration \> Setting (設定) \> Ranking (ランキング表示)画面】にランキングの機能に対して設定を実行する
    
      - 設定項目は以下の通りである

<table>
<thead>
<tr class="header">
<th>#</th>
<th>設定項目</th>
<th>設定方法</th>
<th>デフォルト</th>
<th>概要</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>「ランキングの表示/非表示」（Show/Hide Ranking）</td>
<td>・「オン」（On）</td>
<td>「オフ」（Off）</td>
<td>Web画面でランキングタブの表示可否を設定する</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>・「オフ」（Off）</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>2</td>
<td>「新着アイテムとして判断する期間」（Period To Judge As New Item）</td>
<td>N日（Day）</td>
<td>14日</td>
<td>新規に登録されたアイテムとして判断する期間。アイテム登録日からの経過日数を指定する。ただし、設定できる範囲は1日～30日とする</td>
</tr>
<tr class="even">
<td>3</td>
<td>「統計期間」（Statistical Period）</td>
<td>N日（Day）</td>
<td>365日</td>
<td>ランキングとして表示する期間。本日から何日前までを集計期間とするかを指定する。ただし、設定できる範囲は1~3650日とする</td>
</tr>
<tr class="odd">
<td>4</td>
<td>「表示する順位」（Display Rank）</td>
<td>N位</td>
<td>10位</td>
<td>ランキングとして表示する順位を指定する.最大値を100位までとする</td>
</tr>
<tr class="even">
<td>5</td>
<td>「ランキング」（Rankings）</td>
<td>・「最も閲覧されたアイテム」（The Most Viewed Items）</td>
<td>チェックボックスの<br />
チェックなし</td>
<td>Web画面で表示するランキングの種類を設定する。チェックボックス方式で、複数選択可能とする。<br />
チェックの付いた項目をWeb画面のランキングタブに表示する。</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>・「最もダウンロードされたアイテム」（Most Downloaded Items）</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>・「最もアイテムを作成したユーザー」（User Who Created The Most Items）</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>・「最も検索されたキーワード」（Most Searched Keywords）</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>・「新着アイテム」（New Items）</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - 「保存」（Save）ボタンを押すと、画面上の設定情報を保存し、メッセージを画面上部に表示する  
    メッセージ：  
    日本語：「設定を変更しました」  
    英語：「Successfully Changed Settings.」

  - 以下のエラー条件に１つでも当てはまる場合、「保存」（Save）ボタンを押すと、エラーメッセージを画面上部に表示する  
    エラー条件：  
    ・「新着アイテムとして判断する期間」で1～30以外の自然数を設定した場合  
    ・「統計期間」で1\~3650以外の自然数を設定した場合  
    ・「表示する順位」で1\~10以外の自然数を設定した場合  
    エラーメッセージ：  
    日本語：「設定変更に失敗しました」  
    英語：「Failurely Changed Settings.」

  - 「新着アイテムとして判断する期間」「統計期間」「表示する順位」で文字列や小数、負の値、０など、上記のエラー条件以外の値を入れた場合、入力欄に「指定されている形式で入力してください」というポップアップを表示する

  - 「削除」（Delete）ボタンを押すと、入力中の値が破棄され、入力前の保存された設定情報を表示する

2\. ランキングの情報を表示する

  - トップページから「ランキング」（Ranking）タブを押下すると、ランキング画面に遷移する
    
      - 【Administration \> Setting (設定)\> Ranking (ランキング表示)画面】の「ランキング」（Ranking）の設定に応じて、チェックを入れている項目をランキング画面に表示する
    
      - 「ランキング」（Ranking）タブはゲスト以上のユーザーが閲覧可能とする
    
      - 画面上部に集計期間を表示する。
        
          - 表示方法：『集計期間：YYYY-MM-DD \~ YYYY-MM-DD』
        
          - 集計期間は【Administration \> Setting (設定)\> Ranking (ランキング表示)画面】の統計期間を参照する
    
      - 画面の構成は、【Administration \> Setting (設定)\> Ranking(ランキング表示)画面】に表示するランキングの項目で、チェックボックスにチェックがついている項目のランキングが表示される
    
      - 画面に表示される順位は、【Administration \> Setting (設定) \> Ranking(ランキング表示)画面】のチェックボックスの項目順で表示される
    
      - アイテムが直接紐づいているインデックスとその上位のインデックスについて、１つでも非公開の設定のものがある場合はランキング画面に表示しない。また、ログイン時はどのユーザでログインをしても、ゲストと同じランキング画面を表示する

  - ランキング画面に表示項目は以下の通りである
    
      - 「最も閲覧されたアイテム」（Most Viewed Item）
        
          - 表示方法：『n　(集計値)　アイテム名』  
            「n」：順位  
            「(集計値)」:該当アイテムの集計値（全バージョンのcountの合計値）  
            「アイテム名」：該当アイテム名
        
          - アイテム名はリンク形式で表示される。リンクを押下すると、該当アイテムの詳細画面へ遷移する  
            ※権限によってアイテムの詳細画面が表示できない場合は、参照権限がない旨の画面を表示する
    
      - 「新着アイテムとして判断する期間」（Period To Judge As New Item）
        
          - 表示方法：『ｎ　(集計値)　アイテム名』  
            「n」：順位  
            「(集計値)」：該当アイテムの集計値  
            「アイテム名」：該当アイテム名
        
          - アイテム名はリンク形式で表示される。リンクを押下すると、該当アイテムの詳細画面へ遷移する  
            ※権限によってアイテムの詳細画面が表示できない場合は、参照権限がない旨の画面を表示する
    
      - 「最もダウンロードされたアイテム」（Most Downloaded Items）
        
          - 表示方法：『ｎ　(集計値)　アイテム名』  
            「n」：順位  
            「(集計値)」：該当アイテムの集計値  
            「アイテム名」：該当アイテム名
        
          - アイテム名はリンク形式で表示される。リンクを押下すると、該当アイテムの詳細画面へ遷移する  
            ※権限によってアイテムの詳細画面が表示できない場合は、参照権限がない旨の画面を表示する
    
      - 「最もアイテムを作成したユーザー」（User Who Created The Most Items）
        
          - 表示方法：『ｎ　(集計値)　ユーザ名』  
            「n」：順位  
            「(集計値)」：集計値  
            「アイテム名」：該当ユーザ名
        
          - ユーザ名はリンク形式にはしない（画面表示のみ）
        
          - 表示するデータにユーザ名が存在しない場合は、「None」として表示させる
    
      - 「最も検索されたキーワード」（Most Searched Keywords）
        
          - 表示方法：『ｎ　位（集計値）　キーワード』  
            「n」：順位  
            「(集計値)」：集計値  
            「キーワード」：検索されたキーワード
        
          - 簡易検索の検索フィールドに入力されたキーワードを集計対象とする
        
          - キーワードを入力せずに検索した場合(全件検索)は、ランキングの集計対象外とする  
            その他、簡易検索以外の検索（詳細検索、インデックス検索、ファセット検索など）に関してもランキングの集計対象外とする
        
          - キーワードはリンク形式で表示される。リンクを押下すると、該当のキーワードで検索したときの検索結果画面へ遷移する
    
      - 「新着アイテム」（New Items）
        
          - 表示方法：『登録日　アイテム名』
        
          - アイテム名はリンク形式で表示される。リンクを押下すると、該当アイテムの詳細画面へ遷移する  
            ※権限によってアイテムの詳細画面が表示できない場合は、参照権限がない旨の画面を表示する

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_items\_ui

  - > invenio\_stats

  - > weko\_admin

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - > 対応しているモジュール：weko\_items\_ui, invebio\_stats

  - > トップ画面からランキングのリンクを押下する(/ranking)ことで、weko\_items\_ui.views.rankingが呼び出される。
    
      - > weko\_admin.models.RankingSettingを呼び出し、【Administration \> Setting (設定) \> Ranking (ランキング表示)】で設定したランキングの条件をranking\_settingsテーブルから取得する。
    
      - > weko\_items\_ui.utils.get\_rankingを呼び出す。
        
          - > inveio\_stats.util.QueryRankingHelper.getを呼び出してログ集計した結果を取得する。
        
          - > weko\_items\_ui.utils.get\_permission\_recordを呼び出して、「公開」となっているアイテムをランキングリストとして取得する。
    
      - > flask.templating.render\_templateを呼び出してランキングリストを渡し、「WEKO\_ITEMS\_UI\_RANKING\_TEMPLATE」に沿ってランキングを作成して表示する。

  - > 「WEKO\_ITEMS\_UI\_RANKING\_TEMPLATE」：weko\_items\_ui.config \#L57
    
      - > 設定値：\`weko\_items\_ui/ranking.html’

  - 集計方法について
    
      - 集計期間はAdmin側の集計期間で設定した日数とする
    
      - 集計するタイミングは定期バッチ（日次）で収集する
    
      - 事前集計を定期的に実行するタイミングは、Config設定で変更可能とする
    
      - 「Ranking」タブを表示したタイミングで、事前に集計しておいたランキング情報を参照して表示する
    
      - 最も閲覧されたアイテムランキングの集計方法について
        
          - 集計対象は集計開始時点で「公開」されているものとする
        
          - 閲覧回数は、事前にinvenio-statsにてログ集計した値とする
        
          - 閲覧回数は、全ドメインで集計した値とする
        
          - 所属インデックスの閲覧件数をまとめてカウントする( [~~\#21580\#note-22~~](https://redmine.devops.rcos.nii.ac.jp/issues/21580#note-22) )
    
      - 最もダウンロードされたアイテムの集計方法について
        
          - 集計対象は集計開始時点で「公開」されているものとする
        
          - ダウンロード回数は、事前にinvenio-statsにてログ集計した値とする
        
          - ダウンロード回数は、全ドメインで集計した値とする
        
          - ダウンロード回数は、通常ファイルダウンロード回数を対象とする
    
      - 最もアイテムを作成したユーザーの集計方法について
        
          - ユーザ数は、事前にinvenio-statsにてログ集計した値とする
        
          - ユーザ数は、全ロールで集計した値とする
    
      - 最も検索されたキーワードの集計方法について
        
          - キーワードは、事前にinvenio-statsにてログ集計した値とする
        
          - ランキング画面にあるキーワードのリンクを押下した場合も集計対象とする
    
      - 新着アイテムの集計方法について
        
          - 集計時を基点に、Admin側で設定した「新着アイテムとして判断する期間」の日数の前までの期間（経過日数）を新着アイテムの対象とする  
            【例】「新着アイテムとして判断する期間」を5日として、4/9に集計したときには、4/4～4/9に登録されたアイテムが新着アイテムとなる

  - 集計結果について
    
      - 最も閲覧されたアイテムランキング、最もダウンロードされたアイテム、最もアイテムを作成したユーザー、最も検索されたキーワード
        
          - 出力順は、集計した値の多い順とする
        
          - 集計値が同じもの（同一順位のもの）は、順位は同じものとし、以降の順位は同一のものだけ繰り下がった順位とする  
            例えば、3位のアイテムが3つある場合、1位, 2位, 3位, 3位, 3位, 6位という並びになる
        
          - 集計値が同じもの（同一順位のもの）の出力順はアイテム名の順にソートする
        
          - 集計値が同じもの（同一順位のもの）のうち、表示する順位を超える場合、表示する順位の数で切る  
            例えば、3位のアイテムが3つ(A, B, C)あり、表示する順位が4位までとした場合、1位, 2位, 3位(A), 3位(B)とする
    
      - 新着アイテム
        
          - 出力順は、新着アイテムの登録日の日付が新しい順とする
        
          - 登録日が同じものは登録時間の新しい順とする
        
          - 登録日が同じもののうち、表示する順位を超える場合、表示する順位の数で切る  
            例えば、4/4のアイテムが5つあり、表示する順位が3位までとした場合、登録日時の新しい上位3つを表示する

【補足】

  - 最も検索されたキーワードの集計について、"キーワード"とは検索窓から入力した文字列そのままのことを指す。  
    たとえば「Hello World」と入力して検索した場合、「Hello World」として集計される（HelloとWorldでキーワードは分割されない）

  - 最も検索されたキーワードに除外するキーワードの設定はしていない。  
    そのため、冠詞などのストップワードやネガティブなワードなどは除外せずにランキングに表示される

  - "非公開アイテム"、"アイテムが直接紐づいているインデックスとその上位のインデックスに１つでも非公開の設定のものがある"、"アイテムの所属インデックスが未来の公開日"の場合、  
    最も閲覧されたアイテム、最もダウンロードされたアイテム、新着アイテムに該当のアイテムは表示されない。

  - ログイン時はどのユーザでログインをしても、ゲストと同じランキング画面を表示する

  - ランキングの［New Items］に削除済アイテムは表示対象外とする

  - アイテムの公開日が「未来日」のものについてランキング表示対象外とする

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td></td>
<td></td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/11/11</p>
</blockquote></td>
<td>v0.9.27</td>
<td>閲覧回数の計算手法を明記</td>
</tr>
</tbody>
</table>
