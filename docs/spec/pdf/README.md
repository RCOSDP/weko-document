### 簡易検索（全文検索・キーワード検索）

<!-- end list -->

#### 目的・用途

本機能は、ユーザーがアイテムを検索する際に用いる機能である。  
タイトルや著者名等の項目を指定せず、全ての項目を対象に検索を行うことで、目的のアイテムを見つけることができる。

#### 利用方法

メインコンテンツ」ウィジェットの［トップ（Top）］タブにある検索テキストボックスに文字列を入力し、入力エリア右隣の［検索（Search）］ボタンを押下することで、検索結果が表示される<span id="_Item_Registration：フィードバックメール機能" class="anchor"></span>。

#### 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

#### 機能内容

<!-- end list -->

  - 「メインコンテンツ」ウィジェットの「トップ」タブ画面の上部にアイテム検索エリアを設ける。

  - アイテム検索エリア
    
      - 検索テキストボックスを表示する。
    
      - 検索方式ラジオボタン（［全文（Full text）］と［キーワード（Keyword）］）を表示する。
        
          - ［全文（Full text）］ラジオボタンにチェックを入れる場合、  
            登録されたアイテムのメタデータと登録されたコンテンツの内容から検索される。
        
          - ［キーワード（Keyword）］ラジオボタンにチェックを入れる場合、  
            登録されたアイテムのメタデータから検索される。
        
          - デフォルトでは［全文（Full text）］ラジオボタンにチェックが入った状態である。
    
      - 検索テキストボックス右隣にある［検索（Search）］ボタンを押下することで、入力された文字列でアイテム検索を行う。
        
          - ［検索（Search）］ボタンを押下せず、テキストボックス内にカーソルキーがある状態でエンターキーを押下することでも検索できる。
        
          - > 検索文字列を入力しない場合、検索条件無しとする。（登録データの全件を対象とした検索となる。）
        
          - > 文字間に空白を入れることでAND検索を行うことができる。
        
          - > 以下の特殊な意味をもつ英字のみでは検索を行うことができない。  
            > a, an, and, are, as, at, be, but, by, for, if, in, into, is, it, no, not, of, on, or, such, that, the, their, then, there, these, they, this, to, was, will, with
        
          - > 以下の特殊文字は検索時に指定できる。  
            > 入力された特別文字は内部的にエスケープする。  
            > \+ - = && || \! ( ) { } \[ \] ^ " \~ \* ? : \\ /  
            > エスケープできない文字(「\<」「\>」)で検索を行った場合は、「’\<’,’\>’は検索に使用できません。」とエラーメッセージを表示する。
    
      - > \[検索（Search）\]ボタンの右にある［詳細検索（Advanced）］ボタンを押下することで、詳細検索エリアを表示する。詳細検索については[USER-1-2: 詳細検索](\\l)を参照。
    
      - 検索を行うと、検索結果がトップページ画面の検索結果エリアに表示される。

検索結果は【Administration \> 設定（Setting） \> 検索設定（Search）画面】での設定の通りに表示される。詳細については、[USER-2-1一覧形式表示](#一覧形式表示)を参照。

検索結果エリア

  - ［エクスポート（Export）］ボタンを表示する。  
    ボタンを押下すると、一括出力画面に遷移して、アイテムの情報をエクスポートできる。アイテムの一括出力については[USER-2-4: アイテム一括出力](#アイテム一括出力)を参照。

  - アイテム表示の設定エリア  
    デフォルト値について、設定されている【Administration \> 設定（Setting） \> 検索設定（Search）画面】の検索結果表示設定エリアから取得する。
    
      - ［表示順］（Display Order）プルダウンリスト：検索結果の表示順を選択する。  
        選択肢は【Administration \> 設定（Setting） \> 検索設定（Search）画面】での「表示する」リストとする。
    
      - 順序プルダウン：昇順、降順を選択する。  
        選択肢は「asc, desc」とする。
    
      - ［表示数］（Display Number）プルダウンリスト選択肢は「20,50,75,100」とする。

  - アイテム一覧表示
    
      - アイテムタイトルがリンク形式で表示される。  
        リンクをクリックすると、該当アイテム詳細画面に遷移する。
    
      - 表示されるアイテムはロールによって異なる。  
        システム管理者、リポジトリ管理者、コミュニティ管理者の場合はすべて表示される。  
        ただし、制限公開されているアイテムについては、公開日までシステム管理者と登録者のみ閲覧可能となる。  
        登録ユーザー、一般ユーザー、ゲストの場合はpublicなインデックスツリー内のpublicなアイテムのみ表示される。  
        ただし、登録ユーザーに関しては自身で登録したアイテムのみPrivateであっても検索対象となる。

  - ページング機能を設ける。
    
      - ページングナビゲーションを操作することで、表示内容が切り替わる。

<!-- end list -->

#### 関連モジュール

##### weko\_search\_ui：検索結果をUIに表示する

config.WEKO_SEARCH_UI_JSTEMPLATE_LIST_RESULTS : アイテム一覧のテンプレート

##### weko\_records

utils.sort_meta_data_by_options: 

##### weko\_items\_ui

##### weko\_theme

<!-- end list -->

#### 処理概要

> メインコンテンツ」ウィジェットの、［トップ（Top）］タブ上部にアイテム検索エリアを表示する。

  - > アイテム検索エリアには検索文字列を入力するテキストボックス、［検索（Search）］ボタン、［詳細検索（Advanced）］ボタン、全文/キーワードの検索方式を切り替えるラジオボタンを表示する。

> メインコンテンツ」ウィジェットの［トップ（Top）］タブにある検索テキストボックスに文字列を入力し、入力エリア右隣の［検索（Search）］ボタンを押下することで、weko\_search\_ui.views.searchメソッドが呼び出され、検索の処理を実行する。検索文字列を入力しない場合、登録データの全件を対象とした検索を行う。

  - > ［検索（Search）］ボタンを押下せず、テキストボックス内にカーソルキーがある状態でエンターキーを押下することでも、同様に検索処理を実行する。

> 検索処理後、メインコンテンツ」ウィジェットの［トップ（Top）］タブに検索結果エリアを表示する。検索結果エリアの表示形式はdb内のSearchManagementテーブルの情報から作成される。

  - > 検索結果エリアにはエクスポートボタン、アイテムの表示順、表示数の現在の設定、検索結果のアイテム一覧、ページングナビゲーションを表示する。

  - > 最初に検索した際は、アイテム表示に関する設定のデフォルト値として、【Administration \> 設定（Setting） \> 検索設定（Search）画面】での［検索結果表示設定］エリアで設定された値を取得し、取得した値に従って表示する。

> ［エクスポート（Export）］ボタンを押下すると一括出力画面に遷移し、アイテムの情報をエクスポートできる。アイテムの一括出力については[USER-2-4: アイテム一括出力](\\l)を参照。
> 
> アイテムタイトルのリンクをクリックすると、該当アイテムの詳細画面に遷移する。
> 
> アイテムの表示順、表示数のプルダウンを選択すると、検索結果エリアでのアイテムの表示を選択した表示順、表示数に変更する処理を行う。

#### 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2022/04/28</p>
</blockquote></td>
<td>57247ecce9b5e0879a2538687e446e0ea310129c</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>v0.9.22対応</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>


### [詳細検索](https://redmine.devops.rcos.nii.ac.jp/projects/weko-dev-doc/wiki/%E8%A9%B3%E7%B4%B0%E6%A4%9C%E7%B4%A2)

  - > 目的・用途

本機能は、ユーザーがアイテムを検索する際に用いる機能である。  
タイトルや著者名等の項目を指定し、複数の項目を掛け合わせて検索を行うことで、目的のアイテムを見つけることができる。

  - > 利用方法

トップページ画面の\[Top\]タブにあるキーワード検索テキストボックスの右側にある\[詳細検索（Advanced）\]ボタンを押下する。  
詳細検索条件入力エリアが表示されるので、条件を入力し、詳細検索エリアの最下部にある\[検索(Search)\]ボタンを押下することで、検索結果が表示される。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - トップページ画面［トップ（Top）］タブの上部に設けたアイテム検索エリア内に、詳細検索条件を入力できるボタン（\[詳細検索(Advanced)\]ボタン）を設ける。

  - \[検索（Sesrch）\]ボタンの右にある\[詳細検索(Advanced)\]ボタンを押下すると、詳細検索エリアを展開表示する。
    
      - 詳細検索エリアを展開表示すると、本ボタンは［閉じる（Close）］ボタンに置換される。［閉じる（Close）］ボタンを押下することで、詳細検索エリアを非表示とする。詳細検索エリアを非表示にすると、本ボタンは\[詳細検索(Advanced)\]ボタンに置換される。

  - 簡易検索のテキストフィールドと詳細検索の各項目とのAND検索を行うことが可能とする。
    
      - 詳細検索では、検索方式ラジオボタン（［全文（Full text）］と［キーワード（Keyword）］）は簡易検索と同じものを使用する。  
        各検索方式は簡単検索と同じ仕様とする。

  - テキストボックスに入力して検索を行う場合、文字間に空白を入れることでAND検索を行うことができる。

  - 以下の特殊な意味をもつ英字のみでは検索を行うことができない。  
    a, an, and, are, as, at, be, but, by, for, if, in, into, is, it, no, not, of, on, or, such, that, the, their, then, there, these, they, this, to, was, will, with

  - 以下の特殊文字は検索時に指定できる。  
    入力された特別文字は内部的にエスケープする。  
    \+ - = && || \! ( ) { } \[ \] ^ " \~ \* ? : \\ /  
    エスケープできない文字(「\<」「\>」)で検索を行った場合は、「’\<’,’\>’は検索に使用できません。」とエラーメッセージを表示する。

  - 日付入力において、妥当ではない日付が入力された場合は「Field does not validate」とエラーメッセージを表示する。

検索項目は【Administration \> 設定（Setting） \> 検索設定（Search）画面】の詳細検索条件設定エリアの通りに表示される。設定については[ADMIN-14-11: 検索設定](#検索設定)を参照。

  - 詳細検索条件設定エリアの［初期選択（Initial Condition）］カラムにチェックが入っている項目は、初期状態で詳細検索エリアに表示される。

  - 各詳細検索条件の項目は、詳細検索条件設定エリアで表示されている順番で表示される。

  - ［使用項目（Useable Item）］カラムにチェックが入っている項目は初期状態では表示せず、検索条件項目のプルダウンで選択できるものとする。

  - ［アイテムタイプ（Item Type）］の検索条件項目については、現在システムに登録されているアイテムタイプを取得し、表示する。

  - 既に選択されている検索条件項目は、検索条件項目プルダウンで非活性（選択できない状態）とする。

各検索条件について、入力方式に応じて以下のいずれかの適当な入力エリアを設ける。

  - テキストボックス

  - チェックボックス

  - プルダウン

  - 範囲入力（\[テキスト\] To\[テキスト\]）

  - 日付範囲入力（範囲入力＋カレンダー入力）

  - geo\_distance

表 1-2‑1　初期登録を行った環境で詳細検索エリアに初期表示される項目

<table>
<thead>
<tr class="header">
<th><strong>No.</strong></th>
<th><strong>検索項目</strong></th>
<th><strong>入力エリア</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>タイトル<br />
(Title)</td>
<td>テキストボックス</td>
</tr>
<tr class="even">
<td>2</td>
<td>著者名<br />
(Author Name)</td>
<td>テキストボックス</td>
</tr>
<tr class="odd">
<td>3</td>
<td>件名<br />
(Subject)</td>
<td>テキストボックス、チェックボックス</td>
</tr>
<tr class="even">
<td>4</td>
<td>地域<br />
(Region)</td>
<td>テキストボックス</td>
</tr>
<tr class="odd">
<td>5</td>
<td>内容記述<br />
(Description)</td>
<td>テキストボックス</td>
</tr>
<tr class="even">
<td>6</td>
<td>出版者<br />
(Publisher)</td>
<td>テキストボックス</td>
</tr>
<tr class="odd">
<td>7</td>
<td>寄与者<br />
(Contributor)</td>
<td>テキストボックス</td>
</tr>
<tr class="even">
<td>8</td>
<td>コンテンツ作成日<br />
(Contents Created Date)</td>
<td>日付範囲入力、チェックボックス</td>
</tr>
<tr class="odd">
<td>9</td>
<td>フォーマット<br />
(Format)</td>
<td>テキストボックス</td>
</tr>
<tr class="even">
<td>10</td>
<td>ID</td>
<td>テキストボックス、チェックボックス</td>
</tr>
<tr class="odd">
<td>11</td>
<td>雑誌名<br />
(Journal Title)</td>
<td>テキストボックス</td>
</tr>
<tr class="even">
<td>12</td>
<td>資源タイプ<br />
(Resource Type)</td>
<td>チェックボックス</td>
</tr>
<tr class="odd">
<td>13</td>
<td>アイテムタイプ<br />
(Item Type)</td>
<td>チェックボックス</td>
</tr>
<tr class="even">
<td>14</td>
<td>言語<br />
(Language)</td>
<td>チェックボックス</td>
</tr>
<tr class="odd">
<td>15</td>
<td>期間<br />
(Period)</td>
<td>テキストボックス</td>
</tr>
<tr class="even">
<td>16</td>
<td>学位取得日<br />
(Academic Degree Date)</td>
<td>テキストボックス</td>
</tr>
<tr class="odd">
<td>17</td>
<td>著者版フラグ<br />
(Author Version Flag)</td>
<td>プルダウン</td>
</tr>
<tr class="even">
<td>18</td>
<td>学位番号<br />
(Academic Degree Number)</td>
<td>テキストボックス</td>
</tr>
<tr class="odd">
<td>19</td>
<td>学位名<br />
(Degree Name)</td>
<td>テキストボックス</td>
</tr>
<tr class="even">
<td>20</td>
<td>学位授与機関<br />
(Institution For Academic Degree)</td>
<td>テキストボックス</td>
</tr>
<tr class="odd">
<td>21</td>
<td>著者ID<br />
(Author ID)</td>
<td>テキストボックス</td>
</tr>
<tr class="even">
<td>22</td>
<td>Index</td>
<td>チェックボックス</td>
</tr>
<tr class="odd">
<td>23</td>
<td>License</td>
<td>チェックボックス</td>
</tr>
<tr class="even">
<td>24</td>
<td>テキスト1<br />
(text1)</td>
<td>テキストボックス</td>
</tr>
<tr class="odd">
<td>25</td>
<td>float_JA_1</td>
<td>数値範囲入力</td>
</tr>
<tr class="even">
<td>26</td>
<td>geopoint_JA_1</td>
<td>geo_distance</td>
</tr>
</tbody>
</table>

検索項目ごとにある「X」ボタンを押すことで、検索条件を削除できる。

検索条件の表示の下に［検索条件追加（Add Search Condition）］ボタンを設ける。

  - ［検索条件追加（Add Search Condition）］ボタンを押下すると、検索条件エリアを追加する。

  - 選択されていない項目をデフォルト値とする。

  - 入力欄が検索可能な項目の件数と同数になった場合、このボタンは非活性とする。

［クリア（Clear）］ボタンを押下すると、入力された検索条件を取消する。

日付を入力する検索項目について、テキストボックスを押下するとカレンダーのボタンが表示され、日付を選択することで、検索条件を入力できるものとする。

  - 入力テキストフィールドでの入力とGUIでの入力の両方を可能とする。

  - GUIを使用した場合は「YYYYMMDD」を指定できる。

  - テキストフィールドから入力した場合は「YYYYMMDD」「YYYYMM」「YYYY」を指定できる。

  - 上記以外の入力値を指定した場合は「Field does not validate」を表示し、アイテム検索はできない。

［検索（Search）］ボタンを押すことで、検索条件でアイテムの検索を実施し、検索結果がトップページ画面の検索結果エリアに表示される。

  - JPCOARスキーマのマッピングでアイテム検索する。

  - 検索方式：AND

  - テキストボックス内にカーソルキーがある状態でエンターキーを押下することでも検索できる。

<!-- end list -->

  - 検索結果は【Administration \> 設定（Setting） \> 検索設定（Search）画面】での設定の通りに表示される。詳細については、[USER-2-1一覧形式表示](#一覧形式表示)を参照。

<!-- end list -->

  - 検索結果エリア
    
      - ［エクスポート（Export）］ボタンを表示する。  
        ボタンを押下すると、一括出力画面に遷移して、アイテムの情報をエクスポートできる。アイテムの一括出力については[USER-2-4: アイテム一括出力](#アイテム一括出力)を参照。
    
      - アイテム表示の設定エリア  
        デフォルト値について、設定されている【Administration \> 設定（Setting） \> 検索設定（Search）画面】の検索結果表示設定エリアから取得する。
        
          - ［表示順］（Display Order）プルダウンリスト：検索結果の表示順を選択する。  
            選択肢は【Administration \> 設定（Setting） \> 検索設定（Search）画面】での「表示する」リストとする。
        
          - 順序プルダウン：昇順、降順を選択する。  
            選択肢は「asc, desc」とする。
        
          - ［表示数］（Display Number）プルダウンリスト  
            選択肢は「20,50,75,100」とする。
    
      - アイテム一覧表示
        
          - アイテムタイトルがリンク形式で表示される。  
            リンクをクリックすると、該当アイテム詳細画面に遷移する。
        
          - 表示されるアイテムはロールによって異なる。  
            システム管理者、リポジトリ管理者、コミュニティ管理者の場合はすべて表示される。  
            ただし、制限公開されているアイテムについては、公開日までシステム管理者と登録者のみ閲覧可能となる。  
            登録ユーザー、一般ユーザー、ゲストの場合はpublicなインデックスツリー内のpublicなアイテムのみ表示される。  
            ただし、登録ユーザーに関しては自身で登録したアイテムのみPrivateであっても検索対象となる。
    
      - ページング機能を設ける。
        
          - ページングナビゲーションを操作することで、表示内容が切り替わる。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_search\_ui：検索結果をUIに表示する

  - > weko\_schema\_ui

  - > weko\_items\_ui

  - > weko\_theme

<!-- end list -->

  - > 処理概要

> メインコンテンツ」ウィジェットの［トップ（Top）］タブ上部にアイテム検索エリアを表示する。

  - > アイテム検索エリアには検索文字列を入力するテキストボックス、［検索（Search）］ボタン、［詳細検索（Advanced）］ボタン、全文(Full Text)/キーワード(Keyword)の検索方式を切り替えるラジオボタンを表示する。

> ［詳細検索(Advanced)］ボタンを押下すると、詳細検索エリアを展開表示する。

  - 詳細検索エリアで初期表示される検索項目は【Administration \> 設定（Setting） \> 検索設定（Search）画面】の詳細検索条件設定エリアで［初期選択（Initial Condition）］カラムにチェックが入っている項目である。

  - 詳細検索エリアが表示されている状態の時、［詳細検索(Advanced)］ボタンは［閉じる(Close)］ボタンに置換される。［閉じる(Close)］ボタンを押下することで、詳細検索エリアを非表示とする。詳細検索エリアを非表示にすると、再度［詳細検索(Advanced)］ボタンに置換される。

> 既に選択されている検索条件項目は、プルダウンで非活性（選択できない状態）とする。
> 
> 検索項目ごとにある「X」ボタンを押すことで、検索条件を削除できる。
> 
> 検索条件の表示の下にある［検索条件追加（Add Search Condition）］ボタンを押下すると、選択されていない項目の検索条件エリアを追加する。

  - 選択されていない検索項目がない場合、このボタンは非活性とする。

> 詳細検索条件を指定して、入力エリア右隣の［検索(Search)］ボタンを押下することで、weko\_search\_ui.views.searchメソッドが呼び出され、検索の処理を実行する。検索文字列を入力しない場合、登録データの全件を対象とした検索を行う。

  - > ［検索］ボタンを押下せず、テキストボックス内にカーソルキーがある状態でエンターキーを押下することでも検索処理を実行する。

<!-- end list -->

  - > 検索項目の選択肢は、weko\_search\_ui.config.py WEKO\_SEARCH\_KEYWORDS\_DICTで設定している。

  - > 検索項目と対応するキーを表 1-2‑2に示す。
    
      - > weko\_schema\_ui.mappings.v6.weko.item-v1.0.0.jsonにてElasticsearchでの文字解析方法を設定している。
    
      - > FullText: 全文検索

表 1-2‑2　検索項目と対応するキー

<table>
<thead>
<tr class="header">
<th><strong>No.</strong></th>
<th><strong>検索項目</strong></th>
<th><strong>検索方式</strong></th>
<th><strong>検索用のキー</strong></th>
<th><strong>備考</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>タイトル<br />
(Title)</td>
<td>FullText</td>
<td><p>search_title,</p>
<p>search_title.ja</p></td>
<td></td>
</tr>
<tr class="even">
<td>2</td>
<td>著者名<br />
(Author Name)</td>
<td>FullText</td>
<td>search_creator, search_creator.ja</td>
<td></td>
</tr>
<tr class="odd">
<td>3</td>
<td>件名<br />
(Subject)</td>
<td>Keyword</td>
<td>subject.subjectScheme</td>
<td></td>
</tr>
<tr class="even">
<td>4</td>
<td>地域<br />
(Region)</td>
<td>Keyword</td>
<td>geoLocation.geoLocationPlace</td>
<td></td>
</tr>
<tr class="odd">
<td>5</td>
<td>内容記述<br />
(Description)</td>
<td>FullText</td>
<td>search_des, search_des.ja</td>
<td></td>
</tr>
<tr class="even">
<td>6</td>
<td>出版者<br />
(Publisher)</td>
<td>FullText</td>
<td>search_publisher. search_publisher.ja</td>
<td></td>
</tr>
<tr class="odd">
<td>7</td>
<td>寄与者<br />
(Contributor)</td>
<td>FullText</td>
<td>search_contributor, search_contributor.ja</td>
<td></td>
</tr>
<tr class="even">
<td>8</td>
<td>コンテンツ作成日<br />
(Contents Created Date)</td>
<td>Keyword</td>
<td>date.dateType, file.date.dateType</td>
<td>date.dateTypeが'file.date.dateType'キーで検索される</td>
</tr>
<tr class="odd">
<td>9</td>
<td>フォーマット<br />
(Format)</td>
<td>Keyword</td>
<td>file.mimeType</td>
<td></td>
</tr>
<tr class="even">
<td>10</td>
<td>ID</td>
<td>FullText</td>
<td></td>
<td>※表 1-2‑3参照<br />
追加検索用のキーはKeyword方式</td>
</tr>
<tr class="odd">
<td>11</td>
<td>雑誌名<br />
(Journal Title)</td>
<td>FullText</td>
<td>sourceTitle, sourceTitle.ja</td>
<td></td>
</tr>
<tr class="even">
<td>12</td>
<td>資源タイプ<br />
(ResourceType)</td>
<td></td>
<td>type.raw</td>
<td></td>
</tr>
<tr class="odd">
<td>13</td>
<td>アイテムタイプ<br />
(ItemType)</td>
<td>FullText</td>
<td>itemtype</td>
<td></td>
</tr>
<tr class="even">
<td>14</td>
<td>言語<br />
(Language)</td>
<td>Keyword</td>
<td>language</td>
<td></td>
</tr>
<tr class="odd">
<td>15</td>
<td>期間<br />
(Period)</td>
<td>Keyword</td>
<td>temporal</td>
<td></td>
</tr>
<tr class="even">
<td>16</td>
<td>学位取得日<br />
(Academic Degree Date)</td>
<td></td>
<td>dateGranted</td>
<td></td>
</tr>
<tr class="odd">
<td>17</td>
<td>著者版フラグ<br />
(Author Version Flag)</td>
<td>FullText</td>
<td>versionType</td>
<td></td>
</tr>
<tr class="even">
<td>18</td>
<td>学位番号<br />
(Academic Degree Number)</td>
<td>FullText</td>
<td>dissertationNumber</td>
<td></td>
</tr>
<tr class="odd">
<td>19</td>
<td>学位名<br />
(Degree Name)</td>
<td>FullText</td>
<td>degreeName, degreeName.ja</td>
<td></td>
</tr>
<tr class="even">
<td>20</td>
<td>学位授与機関<br />
(Institution For Academic Degree)</td>
<td>FullText</td>
<td>degreeGrantor. degreeGrantorName, dgName, dgName.ja</td>
<td><p>degreeGrantorNameが' dgName, dgName.ja 'キーで検索される</p>
<p>degreeGrantorNameはキーワード方式</p></td>
</tr>
<tr class="odd">
<td>21</td>
<td>著者ID<br />
(Author ID)</td>
<td>Keyword</td>
<td>creator.nameIdentifier</td>
<td></td>
</tr>
<tr class="even">
<td>22</td>
<td>Index</td>
<td>FullText</td>
<td>path.tree</td>
<td>入力したIndex IDに所属するアイテムを検索<br />
※入力したIndex ID下にある子インデックスに所属するアイテムの検索まではしない</td>
</tr>
<tr class="odd">
<td>23</td>
<td>License</td>
<td></td>
<td>content.licensetype.raw</td>
<td>ファイル情報プロパティのライセンス情報を検索<br />
※権利情報プロパティ(dc:rights)の検索は実施しない</td>
</tr>
<tr class="even">
<td>24</td>
<td>テキスト1<br />
(text1)</td>
<td>Keyword</td>
<td>Text1</td>
<td></td>
</tr>
<tr class="odd">
<td>24</td>
<td>float_JA_1</td>
<td>float_range</td>
<td>float_range1</td>
<td></td>
</tr>
<tr class="even">
<td>25</td>
<td>geopoint_JA_1</td>
<td>geo_point</td>
<td>geo_point1</td>
<td></td>
</tr>
</tbody>
</table>

表 1-2‑3　 IDの選択肢と対応するキー

| **No.** | **選択肢**     | **検索用のキー**                 | **追加検索用のキー**           |
| ------- | ----------- | -------------------------- | ---------------------- |
| 1       | identifier  | relation.relatedIdentifier | identifierType=\*      |
| 2       | URI         | identifier                 | identifierType=\*      |
| 3       | fullTextURL | file.URI                   | objectType=\*          |
| 4       | selfDOI     | identifierRegistration     | identifierType=\*      |
| 5       | ISBN        | relation.relatedIdentifier | identifierType=ISBN    |
| 6       | ISSN        | sourceIdentifier           | identifierType=ISSN    |
| 7       | NCID        | relation.relatedIdentifier | identifierType=NCID    |
| 8       | NCID        | sourceIdentifier           | identifierType=NCID    |
| 9       | pmid        | relation.relatedIdentifier | identifierType=PMID    |
| 10      | doi         | relation.relatedIdentifier | identifierType=DOI     |
| 11      | NAID        | relation.relatedIdentifier | identifierType=NAID    |
| 12      | ichushi     | relation.relatedIdentifier | identifierType=ICHUSHI |

> 検索処理後、「メインコンテンツ」ウィジェットの［トップ（Top）］タブに検索結果エリアを表示する。

  - > ［検索結果］エリアにはエクスポートボタン、アイテムの表示順、表示数の現在の設定、検索結果のアイテム一覧、ページングナビゲーションを表示する。

  - > 最初に検索した際は、アイテム表示に関する設定のデフォルト値として、【Administration \> 設定（Setting） \> 検索設定（Search）画面】での検索結果表示設定エリアで設定された値を取得し、取得した値に従って表示する。

> ［エクスポート（Export）］ボタンを押下すると一括出力画面に遷移し、アイテムの情報をエクスポートできる。アイテムの一括出力については[USER-2-4: アイテム一括出力](\\l)を参照。
> 
> アイテムタイトルのリンクをクリックすると、該当アイテムの詳細画面に遷移する。
> 
> アイテムの表示順、表示数のプルダウンを選択すると、検索結果エリアでのアイテムの表示を選択した表示順、表示数に変更する処理を行う。

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2022/04/28</p>
</blockquote></td>
<td>57247ecce9b5e0879a2538687e446e0ea310129c</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>v0.9.22対応</td>
</tr>
</tbody>
</table>
### [インデックス検索](https://redmine.devops.rcos.nii.ac.jp/projects/weko-dev-doc/wiki/%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%83%84%E3%83%AA%E3%83%BC%E6%A4%9C%E7%B4%A2)

  - > 目的・用途

本機能は、ユーザーが「インデックスツリー」エリアまたは、「インデックスリンク」エリアからインデックスを選択してアイテムを検索する際に用いる機能である。  
選択したインデックスに所属するアイテムを検索することができる。

  - > 利用方法

メインコンテンツ」ウィジェットの［トップ（Top）］タブにある［インデックスツリー］エリア、または「インデックスリンク」エリアを使用する。インデックス名を選択することで、選択したインデックスに所属するアイテムを検索する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 設定されているインデックスツリーが存在し、インデックスリンク表示を有効に設定している時、トップページ画面の［インデックスツリー(Index Tree)］エリアの上部に［インデックスリンク(Index Link)］エリアを表示する。
    
      - ［インデックスリンク］エリアは［インデックスツリー］エリアと同じ表示幅で表示する。
    
      - 【Administration \> インデックスツリー管理 \> ツリー編集（Edit Tree）】画面にてインデックスツリーを追加することができる。詳細は[ADMIN-3-1 ツリー編集](\\l)を参照すること。
    
      - ［インデックスリンク］エリアの表示設定は【Administration \> 設定（Setting） \> インデックスリンク表示（Index Link）画面】で行う。設定については[ADMIN-14-2: インデックスリンク表示](#インデックスリンク表示)を参照。
        
          - デフォルト設定：無効

  - ［インデックスリンク］エリアには、インデックスリンク表示を有効に設定しているインデックスをプルダウンの選択肢として表示する。
    
      - インデックスごとのインデックスリンクの表示設定は【Administration \> インデックスツリー(Index Tree)管理 \> ツリー編集（Edit Tree）画面】で行う。設定については[ADMIN-3-1: ツリー編集](#ツリー編集)を参照すること。
        
          - デフォルト設定：すべての初期設定されるインデックスについて無効
        
          - 表示名の言語は「英語」「日本語」とする。
        
          - 表示画面で指定した言語の言語リソースが設定されていない場合は英語表示とする。
    
      - ユーザーの閲覧権限があるインデックスを「インデックスリンク」プルダウンに表示する。
    
      - 親インデックスに閲覧権限がなく、その親に連なる子インデックスに閲覧権限がある場合、子インデックスのインデックスリンクは表示されない。

  - 設定されているインデックスツリーが存在し、インデックスツリーを表示する設定にしている場合、トップページ画面［トップ（Top）］タブ内の［インデックスツリー（Index Tree）］エリアに、各インデックスへのリンクを表示する。
    
      - 【Administration \> インデックスツリー管理 \> ツリー編集（Edit Tree）】画面にてインデックスツリーを追加、編集、設定することができる。詳細は[ADMIN-3-1 ツリー編集](#_ツリー編集)を参照すること。
    
    <!-- end list -->
    
      - インデックスツリーの表示設定は【Administration \> 設定（Setting） \> 検索設定（Search）画面】の［インデックスツリー／ファセット表示設定］エリアでの設定に応じて表示される。設定については[ADMIN-14-11: 検索設定](#検索設定)を参照すること。
        
          - インデックスツリーのデフォルト表示設定：表示（Display）
    
    <!-- end list -->
    
      - インデックスが子インデックスを持つ場合、インデックスの左の図形▶をクリックすると、子インデックスへのリンクを当該インデックスの下に表示する。再度クリックすると子インデックスを非表示とする。
    
      - インデックスが子インデックスを持たない場合、インデックスの左の図形は▷とする。
    
      - ［インデックスツリー（Index Tree）］エリアの見出しのリンク［インデックスツリー］は、「Root Index」へのリンクとする。
    
      - > 閲覧権限を持たないユーザーに対しては、非公開インデックスは表示しないものとする。
    
      - 親インデックスに閲覧権限がなく、その親に連なる子インデックスに閲覧権限がある場合、親だけでなく子インデックスのインデックスリンクも表示されない。
    
      - ツリー編集画面にて「表示範囲」項目を設定している場合、設定された数を超える子インデックスは初回で表示されず、\[more...\]を押すことでそれらが表示されるようになる。詳細は[ADMIN-3-1 ツリー編集](#_ツリー編集)を参照すること

  - ［インデックスツリー（Index Tree）］エリアのリンク、または\[インデックスリンク\]エリアのプルダウンを押下すると、当該インデックスに所属する子インデックスとアイテムを検索できる。
    
      - トップページ画面［トップ］タブ内の［Index List］エリアに選択したインデックスに所属するインデックスのリストを、［アイテムリスト］エリアに選択したインデックスに所属するアイテムのリストを表示する。
    
      - > 閲覧権限を持たないユーザーに対しては、検索結果に非公開インデックスは表示しないものとする。

<!-- end list -->

  - > ［Index List］エリア
    
      - エリア内の上部にパンくずリストを表示する。  
        パンくずリストのリンクを押下すると、上位のインデックスへ遷移可能とする。  
        なお、「Root Index」の場合はパンくずリストを表示しない。
    
      - > 選択したインデックスに所属する子インデックスのリストを表示する。
        
          - 各インデックスをリンク形式で以下のテンプレートのように表示する。  
            リンクをクリックすると、当該インデックスを検索条件としたアイテム検索を実施する。

> テンプレート：
> 
> インデックス名 + 空白文字 + "\<" + インデックスID + "\>"

  - インデックスIDはリポジトリ管理者以上の権限のみに対して表示する。

<!-- end list -->

  - 各インデックスに所属しているアイテムの公開アイテム件数と非公開のアイテム及び、公開日が未来であるアイテムの合計件数をPrivateのアイテム件数として表示する。なお、ゲストユーザーの場合、非公開のアイテム件数は表示されず、表示可能なアイテムの件数を表示する。
    
      - 子インデックスがあれば、全ての子インデックスに所属しているアイテムの件数を取得する。
    
      - 非公開のインデックスであれば、そのインデックスに所属しているアイテムを非公開のアイテムとして数える。

  - インデックスの初期表示設定が「Root Index」のとき、または［インデックスツリー］エリアの見出しのリンク［インデックスツリー］を押下したとき、［インデックスリスト(Index List)］エリアに「Root Index」の子インデックスのリストが表示され、パンくずリストは表示しない。  
    ※コミュニティ画面の「Root Index」は［アイテムリスト(Item Lists)］エリアを表示する。

  - 「Root Index」以外の最下層でないインデックスを表示した際、［インデックスリスト(Index List)］エリアにはパンくずリストと下位のインデックスを表示する。
    
      - 該当インデックスにリンクするアイテムがある場合はアイテムリストにアイテムを表示する。
    
      - 該当インデックスにリンクするアイテムが無い場合はアイテムリストのエリアのみ表示する。

  - 「Root Index」以外の最下層のインデックスを表示した際、［インデックスリスト(Index List)］エリアにはパンくずリストを表示する。
    
      - 該当インデックスにリンクするアイテムがある場合はアイテムリストにアイテムを表示する。
    
      - 該当インデックスにリンクするアイテムが無い場合はアイテムリストのエリアのみ表示する。

  - 検索結果は、【Administration \> インデックスツリー管理 \> ツリー編集（Edit Tree）画面】の［表示形式(検索結果) ］（Display Format(Search Results)）の設定に応じて表示される。設定については[ADMIN-3-1: ツリー編集](#ツリー編集)を参照すること。
    
      - 「一覧形式」（List）
        
          - インデックスリスト
        
          - インデックス.サムネイル画像
        
          - インデックス雑誌情報  
            （【Administration \> インデックスツリー管理 \> 雑誌情報　画面】で該当インデックスの雑誌情報を出力する設定がされている場合のみ表示される。）
        
          - インデックスコメント
        
          - 表示しているインデックスの検索URL  
            インデックス雑誌情報を出力する設定がされている場合のみ表示される。
        
          - アイテムリスト（一覧形式）
    
      - 「目次形式」（Table Of Contents）
        
          - インデックスリスト
        
          - インデックスサムネイル画像
        
          - インデックスコメント
        
          - アイテムリスト（目次形式）

  - インデックス雑誌情報としては、雑誌情報を登録済みであり、【Administration \> インデックスツリー管理 \> 雑誌情報　画面】で「出力する」に設定されている場合のみ、以下の雑誌情報を初期表示する。雑誌情報の登録、設定については[ADMIN-3-2: 雑誌情報](#雑誌情報-1)を参照すること。
    
      - 雑誌名
    
      - 出版者
    
      - 言語
    
      - eISSN / eISBN
    
      - 表示しているインデックスの検索URL
    
      - その他の登録されている雑誌情報は、初期表示では［▷詳細］リンクを表示し、非表示とする。［▷詳細］リンクをクリックすると、情報が表示される。詳細は[USER-2-3 雑誌情報](#雑誌情報-1)を参照すること

  - インデックスサムネイル画像は、【Administration \> インデックスツリー管理(Index Tree) \> ツリー編集（Edit Tree）画面】に設定されたサムネイル画像から取得し、表示する。

<!-- end list -->

  - インデックスコメントは、【Administration \> インデックスツリー管理(Index Tree) \> ツリー編集（Edit Tree）画面】に設定された「コメント」（Comment）から取得し、表示する。［アイテムリスト］エリア
    
      - インデックスに所属するアイテムの検索結果を表示する。
    
      - アイテムリストの表示についての詳細は  
        一覧形式表示の際は[USER-2-1一覧形式表示](#一覧形式表示)を、目次形式表示の際は[USER-2-2 目次形式表示](#目次形式表示)を参照すること。デフォルトでは一覧形式表示で表示される。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_search\_ui：検索結果をUIに表示する

  - > weko\_index\_tree

  - > weko\_theme

  - 
<!-- end list -->

  - > 処理概要

<!-- end list -->

  - インデックスリンクを表示する設定にしている時に、トップページ画面にアクセスする。  
    この操作によって、weko\_theme.views.indexメソッドにてget\_weko\_contentsを呼び出し、更にget\_index\_link\_listを呼び出して、インデックスリンクの情報を取得し、プルダウンに表示する。
    
      - なお、インデックスリンクがONになっているか否かはget\_index\_link\_listメソッドで確認する。

  - インデックスツリーを表示する設定にしている場合、トップページ画面にアクセスする。  
    この操作によって、weko\_index\_tree.rest.getメソッドにてget\_browsing\_treeメソッドまたは、get\_more\_browsing\_treeメソッドで設定されたインデックスツリー情報をredisから取得し、「インデックスツリー」エリアを表示する。
    
      - なお、インデックスツリーの表示は以下のソースコードを元にしている。<https://github.com/RCOSDP/weko-angular/blob/master/app-tree-items-detail/src/app/tree-list2/tree-list2.component.html>
    
    <!-- end list -->
    
      - > ［インデックスツリー］エリアには、現在設定されているインデックスツリーのリンクを表示する。
    
      - > 閲覧権限のないインデックスはweko\_index\_tree.utils. reduce\_index\_by\_roleメソッドにてroleにアクセス権限がないインデックスを非表示とする。
    
    <!-- end list -->
    
      - インデックスが子インデックスを持つ場合、インデックスの左の図形▶をクリックすると、子インデックスへのリンクを当該インデックスの下に表示し、図形を▼に変化させる。再度図形▼をクリックすると子インデックスを非表示とする。

> メインコンテンツ」ウィジェットの［トップ（Top）］タブ内に表示される、［インデックスツリー］エリア内のインデックスのリンクを押下する、または、\[インデックスリンク\]エリアのプルダウンからインデックスを選択する。この操作によって以下の処理をする。

  - > weko\_search\_ui.static.js.weko\_search\_ui.app getPathNameメソッドを呼び出す。そして、get\_path\_name\_dictメソッドによってindexテーブルより選択したインデックスのパンくずリストを取得する。なお、権限がないインデックスはfilter\_index\_list\_by\_roleメソッドで非表示になる。

  - > 検索結果の表示設定が一覧形式の時、選択したインデックスに登録されている公開設定の雑誌情報をweko\_search\_ui.views.searchメソッドにてget\_journal\_infoを使って取得し、表示する。処理の詳細についてはUSER-2-3雑誌情報を参照すること

  - > weko\_search\_ui.static.js.weko\_search\_ui.app.getChildListメソッドを呼び出す。そして、get\_child\_listメソッドによってindexテーブルより選択したインデックスに所属する子インデックスのデータを取得し、表示する。

  - > weko\_search\_ui.static.js.weko\_search\_ui.app.dispaly\_comment\_journalメソッドにて、format\_commentを呼び出し、コメントを整形し表示する。

  - > weko\_search\_ui.rest.IndexSearchResource.getメソッドにて、searchインスタンスで処理を行い、インデックスに所属するアイテムの情報を取得する。

  - > invenio\_records\_rest.serializers.response.search\_responsifyメソッドを呼び出し、アイテムリストにて表示する情報(リンク、メタデータ表示設定など)を取得する。

> ［アイテムリスト］エリア
> 
> 取得してある該当インデックスに所属するアイテム情報を表示する。

  - > アイテムリストについての処理概要は一覧形式表示の際はUSER-2-1一覧形式表示を、目次形式表示の際はUSER-2-2 目次形式表示を参照してください。デフォルトでは一覧形式表示で表示されます。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2022/05/10</p>
</blockquote></td>
<td>57247ecce9b5e0879a2538687e446e0ea310129c</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>v0.9.22対応</td>
</tr>
</tbody>
</table>

### ファセット検索

  - > 目的・用途

本機能は、ユーザーがアクセス制限やデータタイプなどの検索条件を選択して、アイテムを絞り込む際に用いる機能である。  
複数の項目を選択して絞り込むことで、目的のアイテムに効率よく辿り着くことができる。

  - > 利用方法

トップページ画面の［Top］タブにあるインデックスツリーエリアの下にあるファセット検索エリアを利用する。  
ファセット検索の項目名をクリックまたは対応するチェックボックスをオンにした際に、当該項目で検索を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - ファセット検索を表示する設定にしている場合、トップページ画面［トップ（Top）］タブ内のインデックスツリー（Index Tree）エリアの下に、ファセット検索エリアを表示する。
    
      - ファセット検索の表示設定は【Administration \> 設定（Setting） \> 検索設定（Search）画面】の［インデックスツリー／ファセット表示設定］エリアでの設定に応じて表示される。設定については[ADMIN-14-11: 検索設定](#検索設定)を参照。
        
          - ファセット検索のデフォルト表示設定：非表示

ファセット検索機能の対象はアイテム一覧画面のみとする。

ファセット検索の対象とする項目は【Administration \> 設定（Setting） \> ファセット検索　画面】で設定する。設定については[ADMIN-14-12: ファセット検索](#ファセット検索-1)を参照。

  - メインコンテンツ」ウィジェットの［トップ（Top）］タブに表示されるファセット検索エリアの表示順はファセット項目の登録順(ID順)とする。

  - デフォルト設定で表示されるのは以下の検索項目とする。
    
      - データの言語(Data Language)
    
      - アクセス制限(Access)
    
      - 地域(Location)
    
      - 時間的範囲(Temporal)
    
      - トピック(Topic)
    
      - 配布者(Distributor)
    
      - データタイプ(Data Type)

ファセット検索の対象項目のマッピングに対応するデータを持つ登録アイテムがある場合、各項目のプルダウンに選択肢と、各選択肢に該当する登録アイテム数を表示する。ただし、表示される登録アイテムの数は、ユーザーのロールの閲覧範囲内の登録アイテム数をカウントしたものとなる。

  - ファセット検索の対象項目のマッピングに対応するデータを持つ登録アイテムがない場合、検索対象項目のエリアは表示し、プルダウンの選択肢には「No options」と表示する。

ファセット検索の項目のプルダウンを選択した際に、当該項目で検索を行う。  
選択を解除した際にも同様に検索を行う。

  - ファセット検索を単独で行った場合の検索結果は検索結果エリアに表示する。

  - 簡易検索や詳細検索の検索結果をファセット検索により絞り込むことを可能とする。検索情報はAND条件として検索を実行し、検索結果エリアに結果を表示する。
    
      - 簡易・詳細検索→ファセット検索：AND条件とした検索が実行される。
    
      - ファセット検索→簡易・詳細検索：ファセット検索の条件は反映されない。

  - > インデックス検索とファセット検索を組み合わせてアイテム検索を行うことを可能とする。検索情報はAND条件として検索を実行し、アイテムリストエリアに検索結果を表示する。アイテムリストエリアでの検索結果の表示については、[USER-1-3: インデックスリンク検索](#_インデックスリンク検索)を参照。
    
      - インデックス検索→ファセット検索：AND条件とした検索が実行される。
    
      - ファセット検索→インデックス検索：ファセット検索の条件は反映されない。

<!-- end list -->

  - トップページ画面［トップ］タブ内の検索結果エリアに、選択した項目に当てはまるデータを持つアイテムのリストを表示する。

  - 検索結果エリア
    
      - アイテムの検索結果は【Administration \> 設定（Setting） \> 検索設定（Search）画面】の［検索結果表示設定］の通りに表示される。設定については[ADMIN-14-11: 検索設定](\\l)を参照。
    
      - ［エクスポート（Export）］ボタンを表示する。  
        ボタンを押下すると、一括出力画面に遷移して、アイテムの情報をエクスポートできる。アイテムの一括出力については[USER-2-4: アイテム一括出力](#アイテム一括出力)を参照。
    
      - アイテム表示の設定エリア  
        デフォルト値について、設定されている【Administration \> 設定（Setting） \> 検索設定（Search）画面】の検索結果表示設定エリアから取得する。
        
          - ［表示順］（Display Order）プルダウンリスト：検索結果の表示順を選択する。  
            選択肢は【Administration \> 設定（Setting） \> 検索設定（Search）画面】での「表示する」リストとする。
        
          - 順序プルダウン：昇順、降順を選択する。  
            選択肢は「asc, desc」とする。
        
          - アイテムタイトルがリンク形式で表示される。  
            リンクをクリックすると、該当アイテム詳細画面に遷移する。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > invenio\_records\_rest：ファセット検索を実施する

  - > weko\_search\_ui：検索結果をUIに表示する

  - > weko-react/app-facet-search：weko\_searchのjsファイルを生成する

  - > weko\_schema\_ui：検索用のJPCOARスキーマのマッピングを行う

  - > weko\_items\_ui

  - > weko\_theme

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - ファセット検索を表示する設定にしている場合、メインコンテンツ」ウィジェットの［トップ（Top）］タブにアクセスすると、インデックスツリーエリアの下に、現在設定されている項目のファセット検索エリアを表示する。

> １つのファセット項目の中に表示される件数はconfigファイルで設定される。初期値は以下の通り。
> 
> weko/blob/develop/modules/weko-admin/weko\_admin/config.py  
> WEKO\_ADMIN\_FACET\_SEARCH\_SETTING\_BUCKET\_SIZE = 1000
> 
> JPCOARの索引定義（/weko-schema-ui/weko\_schema\_ui/mappings/v6/weko/item-v1.0.0.json）にファセット検索用の項目をマッピングする。

ファセット検索の対象項目のマッピングに対応するデータを持つ登録アイテムが存在する場合、当該ファセット項目のプルダウンに選択肢と、各選択肢に該当する登録アイテム数を表示する。

  - 現在のファセット検索の対象を「get\_facet\_search\_list」メソッドで取得する。  
    パス： <https://github.com/RCOSDP/weko-react/blob/5a0f077939ebd520294e16ec241c26f78bff5338/app-facet-search/src/App.js#L43>

> 各ファセット項目エリア内のプルダウンに表示されている選択肢を押下することで、選択した内容を検索条件として以下の検索処理を実行する。

  - > 「invenio-records-rest」モジュールの「/api/records」APIを呼び出す。

  - > 上記のAPIでは、「RECORDS\_REST\_FACETS\[SEARCH\_UI\_SEARCH\_INDEX\]」コンフィグを元にマッピング情報を取得し、条件を満たすアイテムを検索する。

> 各ファセット項目の選択を解除した際にも同様に検索処理を行う。
> 
> 選択肢を押下した後、メインコンテンツ」ウィジェットの［トップ（Top）］タブに検索結果を表示する。

  - ファセット検索を単独で行った場合の検索結果は検索結果エリアに表示する。

  - 簡易検索や詳細検索の検索結果をファセット検索により絞り込むことを可能とする。検索情報はAND条件として検索を実行し、検索結果エリアに結果を表示する。
    
      - 簡易・詳細検索→ファセット検索：AND条件とした検索が実行される。
    
      - ファセット検索→簡易・詳細検索：ファセット検索の条件は反映されない。

  - インデックス検索とファセット検索を組み合わせてアイテム検索を行うことを可能とする。検索情報はAND条件として検索を実行し、アイテムリストエリアに検索結果を表示する。
    
      - > インデックス検索→ファセット検索：AND条件とした検索が実行される。
    
      - ファセット検索→インデックス検索：ファセット検索の条件は反映されない。アイテムリストエリアでの検索結果の表示については、[USER-1-3: インデックスリンク検索](#_インデックスリンク検索)を参照。

  - > 検索結果エリアには、選択した項目に当てはまるデータを持つアイテムのリストを表示する。
    
      - > 検索結果エリアにはエクスポートボタン、検索結果のアイテム一覧、アイテム表示の設定エリア、ページングナビゲーションを表示する。
        
          - > アイテム表示の設定エリアにはアイテムの表示順の現在の設定を表示する。
        
          - > 最初に検索した際は、アイテム表示に関する設定のデフォルト値として、【Administration \> 設定（Setting） \> 検索設定（Search）画面】での［検索結果表示設定］エリアで設定された値を取得し、取得した値に従って表示する。

> ［エクスポート（Export）］ボタンを押下すると一括出力画面に遷移し、アイテムの情報をエクスポートできる。アイテムの一括出力については[USER-2-4: アイテム一括出力](\\l)を参照。
> 
> アイテムタイトルのリンクをクリックすると、該当アイテムの詳細画面に遷移する。
> 
> アイテムの表示順のプルダウンを選択すると、検索結果エリアでのアイテムの表示を選択した表示順に変更する処理を行う。

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2022/05/12</p>
</blockquote></td>
<td>5401f42b6db01103bd1ad4a948025dda1dadb6ed</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>v0.9.22対応</td>
</tr>
</tbody>
</table>

### [RSS](https://redmine.devops.rcos.nii.ac.jp/projects/weko-dev-doc/wiki/RSS)

  - > 目的・用途

本機能は、WEKO RSS配信新着情報を取得し、インデックス単位で購読が可能となる機能である。

  - > 利用方法

インデックス検索を行った際、検索結果のインデックスに対応するRSSアイコンを押下することで、WEKO RSS配信新着情報を取得し、該当アイテム一覧のRSSを出力できる。  
また、新着アイテムのウィジェットが設定されている画面にアクセスした際に、画面に表示されているRSSアイコンを押下することで、該当アイテム一覧のRSSを出力できる。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - インデックス検索をした際に表示されるトップページ画面［トップ（Top）］タブ内の［インデックスリスト(Index List）］エリアに、RSSアイコンを表示する設定としているインデックスが表示された時、当該インデックスの右側にRSSアイコンを表示する。
    
      - RSSアイコンの表示設定は【Administration \> インデックスツリー管理 \> ツリー編集（Edit Tree）画面】で行う。設定については[ADMIN-3-1: ツリー編集](#_ツリー編集)を参照。
        
          - RSSアイコンのデフォルト表示設定：非表示

新着アイテムのウィジェットが設定されており、RSS配信を行う設定である場合、［新着アイテムウィジェット］エリア内右上にRSSアイコンを表示する。

  - 新着アイテムのウィジェット、RSS配信の設定は【Administration \> ウェブデザイン管理 \> ウィジェット　画面】で行う。設定については[ADMIN-4-1: ウィジェット](#ウィジェット)を参照。
    
      - RSS配信のデフォルト設定：配信しない

RSSアイコンを押下すると、WEKO RSS配信情報を取得し、該当アイテム一覧のRSSを出力する。

  - RSSの文書は、ブラウザの別タブに表示する。

<!-- end list -->

  - RSS文書には、以下の情報を記載する。
    
      - タイトル（WEKO3）
    
      - RSS文書のリンク
    
      - （インデックスが指定されている場合）当該インデックスに設定されているコメント
        
          - 当該インデックスにコメントが設定されていない場合は、インデックスの名前
        
          - インデックスが指定されていない場合はサイト名（WEKO3）
    
      - RSSで配信するデータを取得した日時
    
      - 条件に合致するアイテムの登録データ
        
          - インデックス検索結果で表示されているRSSアイコンを押下した場合、対応するインデックスの配下に登録されているアイテムのデータを設定されている条件で取得し、表示する。
            
              - UIから登録アイテムのデータを取得する条件を変更することはできない。
            
              - デフォルト設定は、選択したインデックスの配下に存在するアイテム検索結果のうち、2週間前以降に登録されたアイテムデータを20件まで取得し、言語データは英語を取得することとする。
        
          - 新着アイテムウィジェットで表示されているRSSアイコンを押下した場合、【Administration \> ウェブデザイン管理 \> ウィジェット　画面】で設定した日数前の日時以降に登録されたアイテムのデータを、設定した表示件数まで取得し表示する。
        
          - アイテムの登録データとして表示するのは以下の項目とする。
            
              - 論文情報
            
              - アイテムタイトル
            
              - パーマリンク
            
              - rdfへのURL
            
              - 著者名
            
              - 出版社
            
              - 雑誌名
            
              - ISSN
            
              - 巻
            
              - 号
            
              - 開始ページ
            
              - 終了ページ
            
              - 発行年月日
            
              - 抄録
            
              - 発行年月日

  - 対応するインデックスの配下に登録されているアイテムの各項目は、対応する登録データがない場合は空タグとして表示する。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_index\_tree：RSS出力するデータを取得する

  - > weko\_records：検索結果をRSS形式にシリアライズする

  - > weko\_gridlayout：RSS形式のデータをXMLフォーマットでビルドする

  - > weko\_search\_ui：検索結果をUIに表示する

  - > weko\_schema\_ui：検索用のJPCOARスキーマのマッピングを行う

  - > weko\_items\_ui

  - > weko\_theme：ウィジェットのテンプレートを作成する

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - インデックス検索をした際に表示されるトップページ画面［トップ（Top）］タブ内の［インデックスリスト(Index List）］エリアに、RSSアイコンを表示する設定としているインデックスが表示された時、当該インデックス配下に登録されているアイテムの情報を配信するRSSアイコンを表示する。

  - 新着アイテムのウィジェットが設定されており、RSS配信を行う設定である場合、［新着アイテムウィジェット］エリア内右上に新着アイテムの情報を配信するRSSアイコンを表示する。

  - RSSアイコンを押下すると、それぞれ対応するapiリクエストを送信することで該当するアイテムの登録データを取得し、RSS文書として別タブに出力する。

  - > WEKO RSS配信新着情報取得APIについて
    
      - > ［インデックスリスト（Index List）］エリアに表示されるRSSアイコンの押下で呼び出すAPIと、［新着アイテムウィジェット］エリアに表示されるRSSアイコンの押下で呼び出すAPIは異なる。
    
      - > エンドポイント（URI）
        
          - > ［インデックスリスト（Index List）］エリアのRSS

> /api/rss.xml

  - > ［新着アイテムウィジェット］エリアのRSS

> /rss/records

  - > RSSのバージョンは1.0に対応することとする。

  - > リクエストパラメータ
    
      - > RSS配信を行う新着アイテム情報の取得に用いるパラメータを、表 1-6‑1に示す。

表 1-6‑1 WEKO RSS配信を行う新着アイテム情報取得に用いるパラメータ

<table>
<thead>
<tr class="header">
<th><blockquote>
<p>項番</p>
</blockquote></th>
<th><blockquote>
<p>パラメータ</p>
</blockquote></th>
<th><blockquote>
<p>内容</p>
</blockquote></th>
<th><blockquote>
<p>デフォルト値</p>
</blockquote></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>1</p>
</blockquote></td>
<td><blockquote>
<p>index_id</p>
</blockquote></td>
<td><blockquote>
<p>選択したインデックスのインデックスID。複数指定不可。<br />
0以下の値が指定された場合は全インデックスを検索する。</p>
</blockquote></td>
<td><blockquote>
<p>0</p>
</blockquote></td>
</tr>
<tr class="even">
<td><blockquote>
<p>2</p>
</blockquote></td>
<td><blockquote>
<p>page</p>
</blockquote></td>
<td><blockquote>
<p>取得する検索結果一覧のページ番号を指定する。１以下の値が指定された場合は１ページ目を表示する。検索結果一覧の最大ページを超える値が指定された場合は、最後の結果一覧を表示する。</p>
</blockquote></td>
<td><blockquote>
<p>1</p>
</blockquote></td>
</tr>
<tr class="odd">
<td><blockquote>
<p>3</p>
</blockquote></td>
<td><blockquote>
<p>count</p>
</blockquote></td>
<td><blockquote>
<p>表示する検索結果件数を指定する。100以上の値が指定された場合は100として処理する。設定されない場合、または0以下の値が指定された場合は、デフォルトで設定されている表示件数として処理する。</p>
</blockquote></td>
<td><blockquote>
<p>20</p>
</blockquote></td>
</tr>
<tr class="even">
<td><blockquote>
<p>4</p>
</blockquote></td>
<td><blockquote>
<p>term</p>
</blockquote></td>
<td><blockquote>
<p>新着アイテムとして扱う日数を指定する。指定されない場合、または0以下の値が指定された場合は、デフォルトで指定されている日数として処理する。</p>
</blockquote></td>
<td><blockquote>
<p>14</p>
</blockquote></td>
</tr>
<tr class="odd">
<td><blockquote>
<p>5</p>
</blockquote></td>
<td><blockquote>
<p>lang</p>
</blockquote></td>
<td><blockquote>
<p>検索結果の言語を指定する。指定がない場合はデフォルト設定とする。GUIからのリンクの場合、ユーザーが画面表示している言語と一致させる。</p>
</blockquote></td>
<td><blockquote>
<p>en</p>
</blockquote></td>
</tr>
</tbody>
</table>

  - > ［インデックスリスト（Index List）］エリアでの RSS配信時にアイテム情報を取得するリクエストパラメータについて
    
      - > パラメータはindex\_id, page, count, term, langの5項目とする。
    
      - > 各パラメータのデフォルト値はweko\_index\_tree/config.pyで設定し、変更可能とする。  
        > パス：  
        > <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-index-tree/weko_index_tree/config.py#L69-L82>
    
    <!-- end list -->
    
      - > 選択されたインデックスのインデックスIDをパラメータindex\_idに設定し、他のパラメータはデフォルト値を設定する。
    
      - > 表示件数の設定値の上限はweko\_index\_tree/config.pyで設定し、変更可能とする。
        
          - > 表示件数の設定値の上限の値は100とする。

> WEKO\_INDEX\_TREE\_RSS\_COUNT\_LIMIT = 100

  - > 指定されたインデックスの配下のインデックスもデータの取得対象に含める。

<!-- end list -->

  - > ［新着アイテムウィジェット］エリアでのRSS配信時にアイテム情報を取得するリクエストパラメータについて
    
      - > termの値は【Administration \> ウェブデザイン管理 \> ウィジェット　画面】の「New date」の値を使用する。
    
      - > countの値は新着ウィジェットの「Display Results」の値を使用する。

<!-- end list -->

  - 取得したアイテムデータをRSS文書に出力するための処理は、［インデックスリスト(Index List）］エリアのRSSアイコンを押下した場合も［新着アイテムウィジェット］エリアのRSSアイコンを押下した場合も共通であり、weko\_gridlayout/utils.pyのbuild\_rss\_xmlで行っている。

<!-- end list -->

  - > レスポンスフォーマット  
    > 【ソートキー】  
    > 　第1ソートキー： 公開日  
    > 　第2ソートキー： タイトル

  - > 新着アイテムのRSSの配信仕様は、別紙「新着アイテムのRSSの配信仕様.xlsx」を参照。RSS表示条件
    
      - > アイテムが直接紐づいているインデックスとその上位のインデックスについて、１つでも非公開の設定のものがある場合の挙動は表 1-6‑2の通りである。

表 1-6‑2 非公開のインデックスに紐づくアイテムのRSS表示

<table>
<thead>
<tr class="header">
<th>ユーザー</th>
<th>表示制御</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>未ログイン</td>
<td>URLにアクセスしてもアイテム情報を出力しない。</td>
</tr>
<tr class="even">
<td>アイテム登録者以外の一般ユーザー(General User)</td>
<td>URLにアクセスしてもアイテム情報を出力しない。</td>
</tr>
<tr class="odd">
<td>アイテム登録者(Contributor)</td>
<td>URLにアクセスした場合アイテム情報を出力する。</td>
</tr>
<tr class="even">
<td>管理者ユーザー<br />
(Community Administrator, Repository Administrator, System Administrator)</td>
<td>URLにアクセスした場合アイテム情報を出力する。</td>
</tr>
</tbody>
</table>

  - > 登録されているアイテムが非公開の場合、当該アイテム登録者もしくは管理者ユーザーがRSS出力操作を行った際にのみ、アイテム情報は出力される。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2022/05/19</p>
</blockquote></td>
<td>fae7741b21184fd216806f01d6019a321f97edd5</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>v0.9.22対応</td>
</tr>
</tbody>
</table>### 一覧形式表示

  - > 目的・用途

本機能は、検索結果を「一覧形式表示」の形式で表示する機能である。

  - > 利用方法

1.【Administration \> インデックスツリー管理(Index Tree) \> ツリー編集(Edit Tree) 】の編集するインデックスツリーを選択する。

2.「表示形式(検索結果)」の選択肢から「一覧形式」を設定する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

1検索結果を表示する

  - > 簡易検索、詳細検索は一覧形式表示である。  
    > また、インデックス検索結果の表示は、  
    > 【Administration \> インデックスツリー管理(Index Tree) \> ツリー編集(Edit Tree)\> 】での「表示形式(検索結果)」（Display Format(Search Results)）に応じて、インデックス検索結果が表示される。  
    > インデックスリストについての記述は[USER-1-3インデックス検索](\\l)を参照すること。\[アイテムリスト\]エリア
    
      - アイテムの検索結果は【Administration \> 設定（Setting） \> 検索設定（Search）画面】の［検索結果表示設定］の通りに表示される。設定については[ADMIN-14-11: 検索設定](\\l)を参照すること。
    
      - ［エクスポート（Export）］ボタンを表示する。  
        ボタンを押下すると、一括出力画面に遷移して、アイテムの情報をエクスポートできる。アイテムの一括出力については[USER-2-4: アイテム一括出力](#アイテム一括出力)を参照すること。
    
    <!-- end list -->
    
      - アイテム表示の設定エリア  
        デフォルト値について、設定されている【Administration \> 設定（Setting） \> 検索設定（Search）画面】での「検索結果表示設定」エリアから取得する。
        
          - 「表示順」（Display Order）プルダウンリスト：検索結果の表示順を選択する。  
            選択肢は【Administration \> 設定（Setting） \> 検索設定（Search）画面】での「表示する」リストとする。
        
          - 順序プルダウン：昇順、降順を選択する  
            選択肢は「asc, desc」とする。
        
          - 「表示数」（Display Number）プルダウンリスト  
            選択肢は「20,50,75,100」とする。
    
      - アイテムリスト一覧
        
          - アイテムタイトルがリンク形式で表示される。  
            リンクをクリックすると、該当アイテム詳細画面に移動する。
        
          - アイテムリストに表示されるタイトルリンクの表示言語は、以下の表示順に従う。
        
          - 優先度は「Web画面の表示言語＞ローマ字＞英語＞アイテム登録時の１つ目の言語＞言語無しで登録した時の１つ目の値」とする。
        
          - アイテムタイトルの下に「Show List」の設定がONになっているメタデータを表示する。設定方法の詳細は[ADMIN-1-1 メタデータ](#メタデータ)を参照すること。簡易なものを次ページで記述する。

  - 同じ言語の値が複数ある場合は、アイテム詳細画面の表示順とあわせて、１つ目のプロパティの値を表示する。

  - ページング機能を設ける。
    
      - ページングナビゲーションを操作することで、表示内容が切り替わる。

  - アイテムリストの表示仕様について
    
      - "Root Index"表示時
        
          - 「アイテムリスト(Item Lists)」エリアは非表示(エリアごと表示しない)とする  
            ※"Root Index"にリンクを持つアイテムは無いため
        
          - コミュニティ画面の"Root Index"は「アイテムリスト(Item Lists)」エリアを表示する。  
            ※リポジトリの"Root Index"では無いため
    
      - "Root Index"以外のインデックス表示時
        
          - 該当のインデックスにリンクを持つアイテムがある場合、「アイテムリスト(Item Lists)」エリアを表示し、リンクするアイテムを表示する。
        
          - 該当のインデックスにリンクを持つアイテムが無い場合、「アイテムリスト(Item Lists)」エリアは表示する。ただし、\[エクスポート(Export)\]ボタン，表示順(Display Order)，表示数(Display Number)のプルダウン項目は非表示とする。（エリアのみ表示される）※エクスポートする対象となるアイテムが表示されている場合にエクスポートボタンを表示する仕様のため。表示順・表示数も同様。

  - アイテムリストのメタデータ表示仕様について
    
      - > メタデータ表示条件  
        > メタデータ項目の設定「Show List」が"ON"かつ、その項目がメタデータとしてアイテムに設定されている場合、アイテムリストへ表示される。
    
      - > 「Show List」の設定方法  
        > 【Administration \> アイテムタイプ管理(Item Types) \> メタデータ(Metadata)】画面で編集したいアイテムタイプを選択後、各メタデータのオプションの「Show List」の設定をチェックする。
    
      - > その他のプロパティ設定については[ADMIN-1-1 メタデータ](#メタデータ)を参照すること
    
      - > 1つも「Show List」がONになっていない場合、アイテムリストでのメタデータの表示内容は空となる。
    
      - > 「Specify Newline」について  
        > 「Show List」の設定がONのとき、各プロパティのオプション「Specify Newline」の設定のON/OFFを選択することができる。この設定によって、アイテムリストのメタデータの出力方法が異なる。
        
          - > 「Specify Newline」をONにすることでアイテムリストに表示される際、ONにしたメタデータの上に改行を入れて表示される。OFFの場合は「,」で区切られて横に並べて表示される。
            
              - 「Specify Newline」の設定がONの場合  
                出力されるプロパティの項目の値は単独1行で表示される。  
                例えば、「ページ数」と「終了ページ」のみ、「Show List」がＯＮになっていて、かつ、「終了ページ」のみが「Specify Newline」がＯＮの時、「ページ数」の項目が「1000」, 「終了ページ」の項目が「123」の場合、アイテムリストには以下のように表示される。

> 1000
> 
> 123

  - 「Specify Newline」の設定がOFF  
    出力されるプロパティの項目の値は「,」区切りで表示される  
    例えば、「ページ数」の項目が「1000」, 「終了ページ」の項目が「123」の場合、アイテムリストには以下のように表示される。

> 1000,123

  - アイテムリストの各アイテム情報表示時、リンクタイトルは各アイテム情報表示の最状部に表示される。

  - コンテンツファイルがある場合  
    ファイル情報が拡張子のリンク形式で表示される。  
    リンクをマウスオーバーすると、登録されているコンテンツファイルのラベル（無い場合はファイル名）が表示される。  
    拡張子のリンクを押下すると、該当のコンテンツファイルがダウンロードされる。  
    コンテンツファイルがあるが拡張子が無い場合、ファイル情報が"unknown"のリンク形式で表示される。

  - コンテンツファイルが無い場合、  
    ファイル情報が"URL"のリンク形式で表示される。  
    リンクをマウスオーバーすると、登録されているコンテンツファイルのラベル（無い場合はファイル名）が表示される。  
    "URL"のリンクを押下すると、該当のURLのリンク先へ遷移する。

  - オプション機能の変更  
    親プロパティの「Show List」のみ操作可能である。

  - 複数表示の場合、  
    アイテムに複数のコンテンツファイルやURLが登録されている場合、横並びで拡張子やURLのリンクが表示される。  
    表示する順序はアイテム詳細画面の順序と同じである。  
    アイテムリストの枠を超えるコンテンツファイル数がある場合は「…」と表示する。  
    「…」を押下するとアイテム詳細画面に遷移する。

  - サムネイルファイルについて  
    アイテムにサムネイルファイルがアップロードされている場合、アイテムリストにサムネイルファイルを表示する。
    
      - アイテムタイプのサムネイルプロパティのオプションで「Show List」が"ON"になっているときに、アイテムリストへアップロードされたサムネイルファイルを表示する。
    
      - 表示する位置は ファイル情報の左上側とし、右側にアイテムの情報を表示する。
    
      - アイテムに複数のサムネイルファイルがアップロードされている場合、アイテム詳細画面の１つ目のサムネイルファイルを表示する。
    
      - サムネイルファイルの画像の表示サイズについて、以下のConfigファイルで設定する。（アイテム詳細画面と同じ設定。初期値は100px）
    
      - <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/config.py#L310>  
        「WEKO\_RECORDS\_UI\_DEFAULT\_MAX\_WIDTH\_THUMBNAIL = 100」
    
      - アップロードされているサムネイルファイルの画像の横幅が設定値を超える場合、横幅は設定値に自動調整し、あわせて縦の長さも元の画像の比率にあわせて自動調整する。
    
      - サムネイルを表示するエリアは固定とし、アイテムリストの幅を狭くしても、サムネイルを表示するエリアは変更しないものとする。

<!-- end list -->

  - Show Listにチェックがある場合、言語の表示順に従ってタイトルを表示する。

  - タイトルが複数ある場合は、他の項目と同様、１つだけ表示する。

  - 言語の表示順は上記と同様、「Web画面の表示言語＞英語＞アイテム登録時の１つ目の言語＞言語無しで登録した時の１つ目の値」とする。

  - タイトルプロパティに言語がある場合の表示条件は以下に従う

<table>
<thead>
<tr class="header">
<th>　</th>
<th>プロパティの<br />
Show Listチェック有</th>
<th>プロパティの<br />
Show Listチェック無し</th>
<th>タイトル属性のみ<br />
Show Listチェック有</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>アイテム<br />
リスト</td>
<td>日本語</td>
<td>表示順に従って<br />
タイトルが1回表示されること</td>
<td>タイトルは表示されないこと</td>
<td>表示順に従って<br />
タイトルが1回表示されること</td>
</tr>
<tr class="even">
<td></td>
<td>English</td>
<td>表示順に従って<br />
タイトルが1回表示されること</td>
<td>タイトルは表示されないこと</td>
<td>表示順に従って<br />
タイトルが1回表示されること</td>
</tr>
<tr class="odd">
<td>検索結果</td>
<td>日本語</td>
<td>表示順に従って<br />
タイトルが1回表示されること</td>
<td>タイトルは表示されないこと</td>
<td>表示順に従って<br />
タイトルが1回表示されること</td>
</tr>
<tr class="even">
<td></td>
<td>English</td>
<td>表示順に従って<br />
タイトルが1回表示されること</td>
<td>タイトルは表示されないこと</td>
<td>表示順に従って<br />
タイトルが1回表示されること</td>
</tr>
</tbody>
</table>

  - タイトルプロパティに言語が無い場合の表示条件は以下に従う

<table>
<thead>
<tr class="header">
<th>　</th>
<th>プロパティの<br />
Show Listチェック有</th>
<th>プロパティの<br />
Show Listチェック無し</th>
<th>タイトル属性の<br />
Show Listチェック有</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>アイテム<br />
リスト</td>
<td>日本語</td>
<td>表示順に従って<br />
タイトルが1回表示されること</td>
<td>タイトルは表示されないこと</td>
<td>表示順に従って<br />
タイトルが1回表示されること</td>
</tr>
<tr class="even">
<td></td>
<td>English</td>
<td>表示順に従って<br />
タイトルが1回表示されること</td>
<td>タイトルは表示されないこと</td>
<td>表示順に従って<br />
タイトルが1回表示されること</td>
</tr>
<tr class="odd">
<td>検索結果</td>
<td>日本語</td>
<td>表示順に従って<br />
タイトルが1回表示されること</td>
<td>タイトルは表示されないこと</td>
<td>表示順に従って<br />
タイトルが1回表示されること</td>
</tr>
<tr class="even">
<td></td>
<td>English</td>
<td>表示順に従って<br />
タイトルが1回表示されること</td>
<td>タイトルは表示されないこと</td>
<td>表示順に従って<br />
タイトルが1回表示されること</td>
</tr>
</tbody>
</table>

  - > 関連モジュール

<!-- end list -->

  - > weko\_search\_ui

  - > weko\_items\_ui

  - > weko\_records\_ui
    
      - > invenio\_records\_rest

<!-- end list -->

  - > 処理概要

> ［アイテムリスト］エリアの表示

  - > このエリアには、\[エクスポート\]ボタン、表示順プルダウンを２つ、表示数プルダウンを１つ上部に配置し、それらの下に選択したインデックスに所属するアイテムを表示する。
    
      - > \[エクスポート（Export）］ボタンについて  
        > 押下すると一括出力画面に遷移し、アイテムの情報をエクスポートできる。アイテムの一括出力については[USER-2-4: アイテム一括出力](#アイテム一括出力)を参照すること
    
      - > 表示順プルダウンについて
        
          - > アイテムの表示順の現在の設定を表示する。
        
          - > アイテム表示に関する設定のデフォルト値として、【Administration \> 設定（Setting） \> 検索設定（Search）画面】での［検索結果表示設定］エリアで設定された値を取得し、取得した値に従って表示する。
        
          - > 設定された値はsearchメソッドにてsearch\_managementテーブルから取得する。また、テーブルに値が存在していない場合、初期値をmodules.weko-admin.weko\_admin.config.py内の変数WEKO\_ADMIN\_MANAGEMENT\_OPTIONSから設定する。
    
      - > アイテムの表示について  
        > 検索結果を表示する際、以下の処理を行う。
        
          - > invenio\_records\_rest.serializers.response.search\_responsifyを呼び出す。このメソッド下でsort\_meta\_data\_by\_optionsメソッドを呼び出し、item\_typeテーブルのrender列の中のキー「showlist」と「isSpecifyNewline」を参照する。それらの値からリンク下に表示するメタデータ情報を生成し、表示する。

> アイテムタイトルのリンクをクリックすると、該当アイテムの詳細画面に遷移する。アイテム詳細画面の処理については[USER-3-1 メタデータ表示](#メタデータ表示)を参照すること。
> 
> アイテムの表示順のプルダウンを選択すると、［アイテムリスト］エリアでのアイテムの表示を選択した表示順に変更する処理を行う。また、表示数のプルダウンを選択すると、選択した表示数に変更する処理を行う。表示数変更の処理はページリロードを伴う。  
> weko-search-ui.weko\_search\_ui.templates.weko\_search\_ui.body\_contentsを参照すること。

  - 
<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### 目次形式表示

<!-- end list -->

  - > 目的・用途

本機能は、インデックス検索結果を表示する際の形式である「目次形式表示」を定義する機能である。

  - > 利用方法

1.【Administration \> インデックスツリー管理(Index Tree) \> ツリー編集(Edit Tree)】で編集するインデックスツリーを選ぶ。

2.「表示形式(検索結果)」の選択肢から「目次形式」を設定する。

3\. インデックスリンク検索または、インデックスツリー検索を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - > インデックス検索結果の表示は、  
    > 【Administration \> インデックスツリー管理(Index Tree) \> ツリー編集(Edit Tree)\> 】での「表示形式(検索結果)」（Display Format(Search Results)）に応じて、インデックス検索結果が表示される。  
    > また、インデックスリストについては[USER-1-3インデックス検索](#_インデックスリンク検索)を参照すること。

  - > \[アイテムリスト\]エリア
    
      - > 見出しによるグループ分け表示の条件  
        > メタデータ項目の「見出し」の設定「Show List」が"ON"かつ、その項目がアイテムに設定されている場合、アイテムリストへ表示される。
    
      - > 見出しの「Show List」設定方法
        
          - > 【Administration \> アイテムタイプ管理(Item Types) \> メタデータ(Metadata)】にてプルダウンから該当するアイテムタイプ(例：Thesis, conference paperなど)を選択する。そこのメタデータ項目「見出し」エリアの「Show List」にチェックを入れることで見出しのグループ分けがアイテムリストに表示されるようになる。既存アイテムタイプではほぼ設定されていない。
        
          - > 見出しに類するメタデータ項目が３つあり、その内設定順番が「大見出し」、「小見出し」、「言語」であるものは見出しによるグループ分けに対応している。
    
      - > 見出しのグループ分けについて
        
          - > 【Administration \> 設定(Setting) \> 検索設定(Setting) \> 検索結果表示設定】画面の項目「デフォルトソート条件(インデックス検索)」の表示順で表示される。
        
          - > 目次形式表示の時、順番を変えるプルダウンがないため、一般ユーザー側からは変えることはできない。
        
          - > アイテムが表示された際”上下で並んだアイテムが同じ見出し”であったなら見出しでグルーピングされる。見出しが設定されていないアイテムがグループ分けされているアイテムの下に来るとグループ分けされているように見える。  
            > アイテムの「見出し」プロパティの「大見出し」と「小見出し」の値でグルーピングして表示する。  
            > また、「言語」の"ja"または"en"が登録されている場合にアイテムリストに見出しの情報を表示する。
    
      - グループごとに、「大見出し」と「小見出し」の値を「:」区切りで表示する
        
          - 表示形式
            
              - {大見出し} : {小見出し}
            
              - {大見出し} 　　　　　　※小見出しの値が無い場合
            
              - : {小見出し}　　　　　 ※大見出しの値が無い場合
        
          - 「見出し」プロパティの「大見出し」と「小見出し」の値がないアイテムは、見出しがないグループとしてアイテムを配置する
        
          - アイテムの「見出し」プロパティに「言語」の"ja"または"en"が繰り返し登録されている場合、登録した先頭の各「言語」の「見出し」プロパティの値が「大見出し」と「小見出し」として表示される
        
          - 画面の表示言語が"日本語"または"English"以外の場合、登録した先頭の「言語」の「見出し」プロパティの値が「大見出し」と「小見出し」として表示される

> 論文１：　大見出しA，小見出しa
> 
> 論文２：　大見出しA，小見出しa
> 
> 論文３：　大見出しA，小見出しb
> 
> 論文４：　大見出しB，小見出しc
> 
> 論文５：　大見出しB，小見出しa
> 
> 論文６：　大見出しA，(未設定)
> 
> 論文７：　(未設定)，小見出しa
> 
> 論文８：　(未設定)，(未設定)
> 
> の場合、以下のように表示される。
> 
> 大見出しA : 小見出しa
> 
> 　論文１
> 
> 　論文２
> 
> 大見出しA : 小見出しb
> 
> 　論文３
> 
> 大見出しB : 小見出しc
> 
> 　論文４
> 
> 大見出しB : 小見出しa
> 
> 　論文５
> 
> 大見出しA
> 
> 　論文６
> 
> : 小見出しa
> 
> 　論文７
> 
> 　論文８

  - Web画面の言語を切り替えると、アイテムに登録されている見出しの言語を参照して表示する見出しの内容を変更する。  
    （例えば、アイテムに言語(ja)の見出しAと言語(en)の見出しBが登録されている場合、Web画面の言語が日本語の場合は見出しAを、英語の場合は見出しBが表示される）  
    ただし、Web画面の言語を切り替えた場合に参照する言語が無い場合は、言語を切り替えても見出しの表示は変わらない。  
    （前述の例で言語(en)が登録されていない場合は、Web画面の言語を英語にしても見出しAが表示される）

  - 同じ言語で複数の見出しがある場合は、アイテムに登録されているデータの一番目を見出しとする。  
    （例えば、アイテムに言語(ja)の見出しCと言語(ja)の見出しDが登録されており、アイテム詳細画面で見出しC, 見出しDの順で表示されている場合、アイテムリストには見出しCが表示される）

<!-- end list -->

  - タイトル  
    「一覧表示」でのタイトルと同様に表示する。

  - ページ番号  
    「書誌情報」プロパティの「開始ページ」と「終了ページ」の値を表示する。
    
      - > 以下のように表示
    
      - させる
        
          - 「開始ページ」-「終了ページ」
        
          - 「開始ページ」（終了ページを設定しない場合）
        
          - 「終了ページ」（開始ページを設定しない場合）
        
          - 表示なし（開始ページ、終了ページを設定しない場合）

【補足】

  - 目次形式において、各アイテム行の背景の色は白色固定となる。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_search\_ui：検索結果をUIに表示する

  - > weko\_index\_tree

  - > weko\_items\_ui
    
      - > weko\_records\_ui

<!-- end list -->

  - > 処理概要

> ［アイテムリスト］エリアの表示

  - > このエリアには、上部に\[エクスポート\]ボタンを配置し、その下に選択したインデックスに所属するアイテムを表示する。
    
      - > \[エクスポート（Export）］ボタンについて  
        > 押下すると一括出力画面に遷移し、アイテムの情報をエクスポートできる。アイテムの一括出力については[USER-2-4: アイテム一括出力](#アイテム一括出力)を参照すること
    
      - > アイテムリスト（目次形式）の表示
        
          - > 【Administration \> 設定（Setting） \> 検索設定（Search）画面】での［検索結果表示設定］エリアで設定された値を取得し、取得した値に従ってリンクタイトルを表示する。
        
          - > 設定された値はsearchメソッドにてsearch\_managementテーブルから取得する。また、テーブルで値が存在しない場合、初期値をmodules.weko-admin. weko\_admin.config.py内の変数WEKO\_ADMIN\_MANAGEMENT\_OPTIONSから設定する。
            
              - > 見出しのグループについて  
                > メタデータの「見出し(Heading)」が設定されていて、なおかつ「見出し(Heading)」が「Show List」の設定がONになっていた場合、アイテムごとにweko\_search\_ui.rest.getメソッドにてget\_heading\_infoを使用してrecords\_metadataテーブルから「attribute\_name」が「Heading」である「subitem\_heading\_banner\_headline」、「subitem\_heading\_headline」を取得し、それぞれ「大見出し」「小見出し」とする。大見出しと小見出しの組み合わせでグループを決める。
            
              - > グループ分けの条件  
                > 大見出し、小見出しの組み合わせが一致し、なおかつ上下に並んでいるとき同じグループで分けられる。
            
              - > 「Show List」設定について  
                > 【Administration \> アイテムタイプ管理(Item Types) \> メタデータ(Metadata)】にてプルダウンから該当するアイテムタイプ(例：Thesis, conference paperなど)を選択する。メタデータ項目「見出し」エリアの「Show List」にチェックを入れることで表示されるようになる。デフォルトではほぼ設定されていない。設定はitem\_typeテーブルのrender列の中のキー「showlist」に保存され、その値でweko\_search\_ui.rest.getメソッドにて表示の可否を決めている。
        
          - > ページ番号  
            > 「書誌情報」プロパティの「開始ページ」と「終了ページ」の値を表示する。なお、「開始ページ」のみある場合は「開始ページ」のみを、「終了ページ」のみある場合は「終了ページ」のみを表示する。  
            > どちらも設定されていない場合、ページ番号は表示されない。  
            > なお、「開始ページ」と「終了ページ」はweko\_search\_ui.rest.get にてrecords\_metadataテーブルの「Page Start」「Page End」から取得し、表示する。
        
          - > アイテムタイトルのリンクをクリックすると、該当アイテムの詳細画面に遷移する。アイテム詳細画面の処理については[USER-3-1 メタデータ表示](\\l)を参照すること。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### 雑誌情報

<!-- end list -->

  - > 目的・用途

本機能は、インデックスの雑誌情報を管理（追加・編集・削除）、エクスポート時の出力を設定する機能である

  - > 利用方法

1.【Administration \> インデックスツリー管理(Index Tree) \> ツリー編集(Edit Tree)】で編集するインデックスツリーを選ぶ。

2.「表示形式(検索結果)」の選択肢から「一覧形式」を設定する。

3.【Administration \> インデックスツリー管理(Index Tree) \> 雑誌情報(Journal Information)】で編集するインデックツリーを選ぶ。

4\. ジャーナルエリアの「Output」を選び、雑誌情報の必須項目他を設定し、保存する。

5\. インデックス検索を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

1 インデックスの雑誌情報を追加する

  - インデックスの雑誌情報の表示は、  
    【Administration \> インデックスツリー管理(Edit Tree) \> 雑誌情報(Journal Information)】での「表示形式(検索結果)」（Display Format(Search Results)）が「一覧形式(List)」である場合のみである。
    
      - インデックス雑誌情報  
        【Administration \> インデックスツリー管理(Edit Tree) \> 雑誌情報(Journal Information)】にて雑誌情報を登録済み、および「出力する」に設定されている場合のみ、以下のインデックス情報および雑誌情報を初期表示する。
        
          - > インデックスリスト
        
          - > インデックス.サムネイル画像
        
          - > 「タイトル」
        
          - 雑誌情報.雑誌名
        
          - 雑誌情報.別タイトル
        
          - 雑誌情報.出版者
        
          - 雑誌情報.言語
        
          - 雑誌情報.プリント版ISSN / プリント版ISBN
        
          - 雑誌情報.eISSN / eISBN
        
          - インデックス.コメント
        
          - 表示しているインデックスの検索URL
    
      - 詳細表示リンク  
        その他の登録されている雑誌情報は、初期表示では［▷詳細］リンクを表示し、非表示とする。［▷詳細］リンクをクリックすると、以下の情報が表示される。
        
          - カバー範囲
        
          - 変遷前誌のタイトルID
        
          - NCID
        
          - プリント版ISSN/プリント版ISBN
        
          - 最古オンライン巻号の出版年月日
        
          - NDL請求記号
        
          - 提供最古号
        
          - 資料種別
        
          - 提供最新号
        
          - 提供最新巻
        
          - タイトルヨミ
        
          - NDL書誌ID
        
          - 提供最古巻
        
          - カバー範囲に関する注記
        
          - シリーズのタイトルID
        
          - J-STAGE資料コード（雑誌名の略称）
        
          - その他のタイトル（他の言語でのタイトルなど）
        
          - 最新オンライン巻号の出版年月日
        
          - 医中誌ジャーナルコード
        
          - エンバーゴ情報
        
          - アクセスモデル

  - 【Administration \> インデックスツリー管理(Edit Tree) \> 雑誌情報(Journal Information)】でのインデックスツリーにインデックスを選択した状態でインデックスの雑誌情報が設定できる
    
      - 「Root Index」を選択する場合、雑誌情報の入力エリアが非活性とする
    
      - 一覧形式表示する際の雑誌情報出力の設定エリア
        
          - 「ジャーナル(Journal)」に、「Output」/「Do not output」ラジオボタンで設定できる。初期値は「Do not output」である
            
              - 「Output」を選択する場合、設定されたインデックスの雑誌情報を表示させる。
            
              - 「Do not output」を選択する場合、すでに登録済みの情報があればデータはそのまま保持して画面表示のみ非表示とする。
            
              - 必須項目を入力後、最下部の「保存」ボタンを押下することで雑誌情報の初期登録は完了となる。
            
              - 必須項目は「タイトル(Title)」、「最古オンライン巻号の出版年月日(Date of first issue available online)」、「カバー範囲(Coverage depth)」、「資料種別(Publication type)」、「アクセスモデル(Access type)」、「言語(langueage)」である。
            
              - 項目の詳細については[ADMIN-3-2 雑誌情報](#雑誌情報-1)を参照すること。

2 インデックスの雑誌情報をKBART形式で出力できる

  - 本機能は、RabbitMQ/Celeryを用いて非同期バッチ処理とする。

  - 登録された雑誌情報は、  
    ERDB（Electronic Resources Database = 電子リソース管理データベース）が  
    取り込めるKBART2拡張形式で出力可能とする　【参考情報】 [ERDB-JP連携マニュアル.pdf](https://redmine.devops.rcos.nii.ac.jp/attachments/download/4308/ERDB-JP%E9%80%A3%E6%90%BA%E3%83%9E%E3%83%8B%E3%83%A5%E3%82%A2%E3%83%AB.pdf)
    
      - 出力対象は、インデックスの雑誌出力設定が "出力する（Output）" となっているもの全てとする
    
      - 出力項目は、「 [WEKO\_KBART出力項目一覧\_v1.17.xlsx](https://redmine.devops.rcos.nii.ac.jp/attachments/download/4677/WEKO_KBART%E5%87%BA%E5%8A%9B%E9%A0%85%E7%9B%AE%E4%B8%80%E8%A6%A7_v1.17.xlsx) 」に記載される下記 34項目 とする
    
      - 出力形式は、tsv形式とする。
    
      - 出力は自動で行われる。デフォルトでは1日おきに出力される。間隔の変更、手動での出力方法については処理概要を参照すること
    
      - 出力されたファイルのweb上での確認方法について  
        出力された際には、最も新しく出力されたファイルの名前が  
        URL:「自機関のリポジトリURL」＋「/static/weko/kbart/filelist.txt」  
        に出力され、確認できる。  
          
        「自機関のリポジトリURL」＋「/static/weko/kbart/”確認したいファイルの名前”」で出力されたファイルを確認できる。  
        例https://192.168.56.103/static/weko/kbart/WEKO\_AllTitles\_2023-07-25.txt
    
      - 出力順序は、下記項目を上から順に出力する
        
        1.  publication\_title
        
        2.  print\_identifier
        
        3.  online\_identifier
        
        4.  date\_first\_issue\_online
        
        5.  num\_first\_vol\_online
        
        6.  num\_first\_issue\_online
        
        7.  date\_last\_issue\_online
        
        8.  num\_last\_vol\_online
        
        9.  num\_last\_issue\_online
        
        10. title\_url
        
        11. first\_author
        
        12. title\_id
        
        13. embargo\_info
        
        14. coverage\_depth
        
        15. notes
        
        16. publisher\_name
        
        17. publication\_type
        
        18. date\_monograph\_published\_print
        
        19. date\_monograph\_published\_online
        
        20. monograph\_volume
        
        21. monograph\_edition
        
        22. first\_editor
        
        23. parent\_publication\_title\_id
        
        24. preceding\_publication\_title\_id
        
        25. access\_type
        
        26. language
        
        27. title\_alternative
        
        28. title\_transcription
        
        29. ncid
        
        30. ndl\_callno
        
        31. ndl\_bibid
        
        32. jstage\_code
        
        33. ichushi\_code
        
        34. deleted
    
      - 雑誌情報出力処理（RabbitMQ/Celery非同期処理）について、出力インターバルをコンフィグファイルに設定可能とする
    
      - また、雑誌情報の出力結果をログ出力できる
        
          - ログ出力は invenio-loggingを利用して実装する
        
          - ログ出力内容は以下とする  
            （ただし、ステータスコードはinvenio-loggingの仕様に準拠する）

| \# | ログレベル | ステータスコード | ログ内容                 |
| -- | ----- | -------- | -------------------- |
| 1  | INFO  | 0        | 正常終了                 |
| 2  | ERROR | 1        | 不明なエラーによる終了          |
| 3  | ERROR | 3        | 多重実行エラーにより実行が行われなかった |
| 4  | ERROR | 100      | データ取得エラー(DBエラー)      |
| 5  | ERROR | 101      | 設定ファイル不正エラー          |

  - > 関連モジュール

<!-- end list -->

  - > weko\_search\_ui

  - > weko-indextree-journal

<!-- end list -->

  - > 処理概要

雑誌情報の表示

  - 雑誌情報の表示
    
      - > 雑誌情報の設定が「出力する」になっていて、かつ、雑誌情報が設定されている状態でインデックスツリー検索、またはインデックスリンク検索を行う。その時、weko\_search\_ui.views.searchメソッドにてget\_journal\_infoを使ってそのインデックスに所属する雑誌情報を取得し、表示する。  
        > なお、「出力する」の設定はjournalテーブルの列「is\_output」を参照する。
    
      - > 初期表示は雑誌情報をキー名"publication\_title"、"publisher\_name"、"language”、"online\_identifier"、"openSearchUrl"の順に値を表示していく。詳細表示のキー名についてはweko\_search\_ui.indexlist.htmlを参照すること

  - 雑誌情報設定画面の処理については[ADMIN-3-2 雑誌情報](#雑誌情報-1)を参照すること。

  - 雑誌情報出力処理について。
    
      - 雑誌情報出力処理はweko\_indextree\_journal.tasks.export\_journal\_taskメソッドで行われ、kbart2拡張形式のtxtファイルで出力される。同ディレクトリにfilelist.txtとして出力されたファイル名を記載したtxtファイルも出力する。
    
      - デフォルトの実行スケジュールは以下のセロリタスクで設定される。  
        パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/scripts/instance.cfg>
    
      - タスク名：「indextree-journal-export-journal」
    
      - スケジュールを変更したい場合は、キー’schedule’の値を変更すること

> 'indextree-journal-export-journal': {
> 
> 'task': 'weko\_indextree\_journal.tasks.export\_journal\_task',
> 
> 'schedule': timedelta(days=1),
> 
> 'args': \[('p\_path')\],
> 
> },

  - 雑誌情報出力結果をログ出力の処理について、  
    別紙「weko-logging-instruction.xlsx」 を参照すること。

  - ファイルの出力先
    
      - var/instance/static/weko/kbart（web container）
    
      - 以下のコマンドを実行することで、ファイルの参照が可能

> docker-compose exec web bash
> 
> cdvirtualenv
> 
> cd var/instance/static/weko/kbart
> 
> ls

  - filelist.txt（ファイル名の情報）  
    var/instance/static/weko/kbart/filelist.txt

  - 登録済みの雑誌情報：
    
      - 例：  
        var/instance/static/weko/kbart/WEKO\_AllTitles\_2021-09-28.txt  
        var/instance/static/weko/kbart/WEKO\_AllTitles\_2021-09-27.txt

<!-- end list -->

  - ログの出力先
    
      - /work/weko\_devXX/celery.log
    
      - ログはファイル出力であり、APIは実装していない。登録された雑誌情報をログファイルで出力している。
    
      - 雑誌情報を含むcelery.logのサンプルは [こちら](https://redmine.devops.rcos.nii.ac.jp/attachments/26367/celery.log)

  - 手動での雑誌情報出力方法について  
    以下のコードをターミナルに入力する。

> docker-compose exec -u root web celery -A invenio\_app.celery call weko\_indextree\_journal.tasks.export\_journal\_task --args='\[{"p\_path":"var/instance/static/weko/kbart/"}\]'

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>

### アイテム一括出力

  - > 目的・用途

本機能は、検索結果に表示されているアイテムの情報を一括で出力する機能である。

なお、出力されるファイル形式はjson,tsv,bibである。

  - > 利用方法

1\. 【Administration \> 設定(Setting) \> アイテム一括出力(Item Export)画面】の「Allow/Disallow Item Exporting」及び「Export File Contents」をOnに設定する。

2\. いずれかのアイテム検索を行う。

3\. 検索結果エリア、あるいはアイテムリストエリア内にある\[エクスポート(Export)\]ボタンを押下する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【Administration \> 設定(Setting) \> アイテム一括出力(Item Export)画面】に「Allow/Disallow Item Exporting」及び「Export File Contents」がOnに設定している場合
    
      - 検索結果一覧画面に「エクスポート」（Export）ボタンを押下すると、アイテム一括出力画面に遷移する。
    
      - アイテム一括出力画面にボタンを押下したときの検索結果一覧画面のアイテム名を全てリストとして表示する。  
        ※権限によって詳細画面で表示されないメタデータはリストに表示されない。
        
          - アイテムの順序は、ページを読み込んだ際の検索結果一覧の画面を引き継ぐ（並び替えや表示数を変更している場合も反映しないが、変更した後ページリロードをすると反映される。）
        
          - 「Items to Export」エリアの表示内容は以下の通りである。
            
              - 「チェックボックス」、「Item」、「Message」、「No. of Files」  
                が横に並んだ表を表示する。
            
              - 「チェックボックス」の列  
                　すべての項目にチェックボックスを設ける。
                
                  - 列の一番上のチェックボックスを押下することで表示されているページの列全てのチェックボックスのON/OFFができる。
                
                  - 各アイテムのチェックボックスを押下することでON/OFFができる。
                
                  - チェックボックスにチェックが入っているアイテムはエクスポートされる。
            
              - 「Item」の列  
                　各アイテムの名称がリンクとなって表示される。押下するとそのアイテムの詳細画面に遷移する。
            
              - 「Message」の列  
                　システムからのメッセージを表示する。（エラーメッセージ）
            
              - 「No. of Files」  
                　各アイテムのコンテンツファイルの件数を表示する。
    
      - 選択したアイテム数がコンフィグで設定した最大アイテム数を超えた場合、表の上にメッセージが表示される。  
        メッセージ：「Exceeded number of selectable items.」
        
          - アイテム一括出力画面にある「エクスポート」（Export）ボタンが非活性になる。
        
          - チェックを外したときに選択しているアイテムが最大アイテム数以下になった場合は、画面上のメッセージは非表示となり、ボタンも活性化する。
    
      - コンテンツファイルの出力有無
        
          - 「File Contents」エリアにコンテンツファイルも含めて出力するかどうかをラジオボタンで選択できる。
        
          - ラジオボタン：「Do Not Export File Contents」、「Export File Contents」
        
          - 初期値：「Do Not Export File Contents」
    
      - 一括出力する形式の選択
        
          - 「Export Format」エリアに一括出力する形式を選択できる
        
          - 選択できる項目：アイテムの詳細画面でExportできる項目と同様（JSON, BIBTEX）とする
        
          - 初期値：「JSON」
    
      - 「戻る」（Back）ボタン  
        ボタンを押すと、検索結果一覧画面に戻る
    
      - 「エクスポート」（Export）ボタン  
        チェックボックスにチェックがついているアイテムに関してExportできる

  - 【Administration \> 設定(Setting) \> アイテム一括出力(Item Export)画面】の「Allow/Disallow Item Exporting」がOffに設定している場合、  
    検索結果一覧画面に「エクスポート(Export)」ボタンを表示しない。

  - 【Administration \> 設定(Setting) \> アイテム一括出力(Item Export)画面】に「Allow/Disallow Item Exporting」がOnに設定している、かつ「Export File Contents」がOffに設定している場合
    
      - 検索結果一覧画面に「エクスポート(Export)」ボタンを表示する。
    
      - 「File Contents」エリアにコンテンツファイルを出力するかどうかのラジオボタンを非活性にする。
    
      - 「File Contents」エリアの上部にコンテンツファイルが出力できない旨のメッセージを表示する。  
        メッセージ：「File contents cannot be exported.」

  - アイテム一括出力時にダウンロード権限がないものを確認する。
    
      - アイテム一括出力画面を表示したタイミングで、各アイテムのコンテンツの権限を確認し、コンテンツファイルのダウンロード権限が無い場合、該当アイテム行での"Message"列にメッセージを表示する。  
        メッセージ：「Contains restricted content」
    
      - コンテンツのダウンロード権限は、アイテム登録時に設定するコンテンツの公開情報を参照する。[USER-3-2 コンテンツファイル管理](#コンテンツファイル管理)の章を参照すること。

  - エクスポートされるディレクトリ構造

> export.zip
> 
> ├── bag-info.txt
> 
> ├── bagit.txt
> 
> ├── manifest-sha256.txt
> 
> ├── manifest-sha512.txt
> 
> ├── tagmanifest-sha256.txt
> 
> ├── tagmanifest-sha512.txt
> 
> └── data

  - 「data」フォルダーの中身
    
      - エクスポート形式はJSONの場合

> data
> 
> ├──\[アイテムタイプ名(アイテムタイプバージョン)\].tsv
> 
> └──recid\[recidの値\]
> 
> 　　├──ファイル名（コンテンツファイルがある場合）
> 
> 　　└── recid\_\[recidの値\]\_metadata.json

  - エクスポート形式はBIBTEXの場合

> data
> 
> ├──\[アイテムタイプ名(アイテムタイプバージョン)\].bib
> 
> └──recid\[recidの値\]
> 
> 　　├──ファイル名（コンテンツファイルがある場合）
> 
> 　　└── recid\_\[recidの値\]\_metadata.json

  - Items to Exportに表示されるファイル情報は以下のように制御する
    
      - 「公開しない」に設定したファイル情報はItems to ExportのNo. of Filesにはカウントされない
    
      - 「公開しない」に設定したファイル情報はItems to Exportでも出力されない

  - エクスポートの処理は以下の通り
    
      - Unicode正規化（NFKD）を実施する。
    
      - 特別な文字（\&EMPTY&）を変換する（ [~~\#23229~~](https://redmine.devops.rcos.nii.ac.jp/issues/23229) ）
    
      - メタデータをエスケープして出力する（ MarkupSafeライブラリ による処理）
    
      - 改行コード（\\n）→\<br/\> に変換する（ [~~\#23229\#note-6~~](https://redmine.devops.rcos.nii.ac.jp/issues/23229#note-6) ）

  - エクスポートできるファイルサイズは定数「 WEKO\_ITEMS\_UI\_EXPORT\_MAX\_FILE\_SIZE 」にて制限できる。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_items\_ui

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 検索結果画面で「エクスポート」ボタンを押下すると、weko\_search\_ui.app.checkForRestrictedContentメソッドとweko\_items\_ui.views.exportメソッドが呼び出される。  
    前者のメソッドでcheck\_restricted\_contentが呼び出され、検索結果の中でダウンロード制限がついていないアイテム情報を取得する。  
    後者のメソッドでは、アイテムエクスポートの設定、検索結果ロード時の検索設定を取得し、  
    それらが反映したアイテムリストを表示する。

  - 「エクスポート」ボタンを押下するとweko\_search\_ui.static.js.weko\_search\_ui.app.exportItemsメソッドが呼び出され、同ファイルのgetExportItemsMetadataを呼び出し選択したアイテムのメタデータを取得する。その取得したメタデータに不足した必須項目があるかを同ファイルのvalidateBibtexExportメソッドで確認し、足りなかったらエラーメッセージをウェブ上に表示する。  
    問題ない場合、weko\_items.ui.views.exportメソッドにてexport\_itemsメソッドを呼び出し、zipファイルを出力する。  
      
    以下は出力するファイルごとの処理を記述する。

  - **コンテンツファイルを含める場合はBagit形式でアイテムを一括出力する**
    
      - 仕様書： 別紙「WEKO3\_BagIt.pptx」を参照すること。
    
      - weko\_items\_ui.utils.export\_itemsメソッドにてbagit.make\_bagを実行することでbagitファイルを生成する。
    
      - コンテンツファイルを含める場合、エクスポート時には登録ファイルが1つのzipファイルに圧縮されてダウンロードされる
    
      - zipファイルは階層構成（Bagit形式）で出力できる
    
      - コンテンツファイルは個々に個別のディレクトリが作成され、その中に出力される（ディレクトリには連番が振られる）
    
      - 一括出力されるアイテムのファイル形式は、アイテム一括出力画面の出力形式に合わせる

  - **ダウンロードするメタデータファイル（tsvファイル）**
    
      - 「Item to Export」エリアの「Export Format」項目でJSONを選び、エクスポートボタンを押す。この操作によって、weko\_items\_ui.utils.export\_itemsメソッドにてwrite\_filesメソッドが呼び出され、JSON形式でtsvファイルが出力される。  
        tsvの形式についてはweko\_items\_ui.utils.make\_stats\_fileメソッドを参照すること。
    
      - ファイル名ルール：\[アイテムタイプ名(アイテムタイプバージョン)\].tsv
    
      - 基本仕様
        
          - TSV形式とする
        
          - 文字コードはBOM無しUTF-8、改行コードはCR+LFとする
        
          - アイテムタイプ毎にファイルを分けて出力する
        
          - ファイル名は「アイテム\_タイプ名.txt」とする
        
          - 1行で1アイテムを記載する
    
      - 詳細仕様
        
          - ヘッダ行
            
              - 先頭の5行はヘッダ行とする
            
              - ヘッダ行は、"\#"で開始する
        
          - ヘッダ各行の詳細
            
              - 1行目 ： アイテムタイプの名称を記載する
                
                  - 1カラム目 ： \#ItemType (固定)
                
                  - 2カラム目 ： アイテムタイプの名称を記載する
                
                  - 3カラム目 ： アイテムタイプのjsonschemaのURLを記載する
            
              - 2行目 ： 各メタデータ項目の内部キーを記載する
                
                  - 内部キーは、JSONPathのルールに従い記載する
            
              - 3行目 ： 各メタデータ項目のラベルを記載する
                
                  - メタデータの階層に応じて、各階層のラベルを"."で連結する
                
                  - 繰り返し可能な項目については、ラベルのサフィックスとして"\#"+連番(1〜)を記載する  
                    (例) 作成者\#1.作成者識別子\#1.作成者識別子
            
              - 4行目 ： 各メタデータがReadonlyであるかを記載する。
                
                  - メタデータがReadonly属性を持つ場合、該当するメタデータの列に”System”と記載する。
            
              - 5行目 ： 各メタデータの設定を記述する。
                
                  - 複数設定項目がある場合は、”,”で連結して記載する。  
                    (例)Required, Allow Multiple
        
          - 各カラム詳細
            
              - 1カラム目 ： アイテムのrecidを記載すること。アイテムの新規登録の場合は、"n"+連番をユーザーが記載する
            
              - 2カラム目 ： アイテムのランディングページのURIを記載する
            
              - 3カラム目〜4+nカラム目 ： アイテムの属するインデックスのIDを記載する  
                　複数指定可
            
              - 3+n+1カラム目〜 : アイテムタイプのメタデータをGUIの表示順に合わせて記載する
        
          - その他
            
              - インデックス  
                インデックスはインデックスIDを記載する
            
              - 作成者  
                WEKOの著者名DBに登録されている場合は、作成者の2階層目のデータとして、weko\_idを追加する【確認中】
            
              - ファイル  
                file\_path\#xxは、ファイルプロパティの\#xxと連番を合わせて対応する
        
          - メタデータファイル(tsv)サンプル  
            別紙「weko3\_tsvformat.xlsx」を参照

  - **各アイテムの情報 BIBTEX形式**  
    別紙「WEKOメタデータ取得API（JPCOAR\_BiBTEX）\_20200106NII案」を仕様書として参照すること
    
      - 「Item to Export」エリアの「Export Format」項目でBIBTEXを選び、エクスポートボタンを押す。この操作によって、weko\_items\_ui.utils.export\_itemsメソッドにてwrite\_bibtex\_filesメソッドが呼び出され、bibファイルが出力される。
    
      - ファイル名のルール：\[アイテムタイプ名(アイテムタイプバージョン)\].bib
    
      - 仕様書での「文献種別別出力フィールド」シート
        
          - 「○ ※必須」：必須項目  
            　一括出力の時に、必須チェックを行う。  
            weko\_items\_ui.utils.make\_bibtex\_dataメソッドにおいてチェックを行っている。
        
          - 「○」：任意項目（ある場合Exportする、ない場合はNULLとしてExportする(項目名のみ)）
        
          - 空白セル：Export対象外項目
    
      - 「○ ※必須」が入力されていない場合、「Export Format」で「BIBTEX」を選択したとき、「エクスポート」（Export）ボタンを押すと、  
        該当アイテム行でのMessageエリアに、以下のようなエラーメッセージを表示する  
        エラーメッセージ：  
        JP：「必須項目がありません」  
        EN：「Required item is not inputted.」
        
          - エラーになるアイテムは出力対象外となる。
    
      - ファイルサンプル  
        別紙「bibtex.txt」

  - **各アイテムのjsonファイル**
    
      - ファイル名ルール：recid\_\[recidの値\]\_metadata.json
    
      - 各アイテム詳細画面左下の「エクスポート」エリアの「JSON」リンクで展開される内容を出力する。

  - エクスポートの最大アイテム数は以下で設定する
    
      - /modules/weko-items-ui/weko\_items\_ui/config.py  
        　WEKO\_ITEMS\_UI\_DEFAULT\_MAX\_EXPORT\_NUM = 100

  - エクスポート処理実行時、weko\_items\_ui.utils.export\_itemsメソッドにてtempfile.TemporaryDirectoryによってtmpファイルが生成される。  
    テンポラリディレクトリのファイル名を以下のように設定する。  
    なお、tmpファイルはエクスポート処理実行後に自動的に削除される。
    
      - /home/invenio/.virtualenvs/invenio/var/instance/data/tmp/weko\_export\_xxxxxxxx

  - weko\_items\_ui.utils.export\_items  
    <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-items-ui/weko_items_ui/utils.py#L1423-L1507>

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/11/11</p>
</blockquote></td>
<td>V0.9.27</td>
<td></td>
</tr>
</tbody>
</table>
### メタデータ表示

  - > 目的・用途

本機能は、登録されたアイテムの詳細情報を閲覧できる機能である。

  - > 利用方法

アイテムのメタデータは、アイテムリストにおいて表示されているアイテムを押下することで表示される。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

1\. アイテムの詳細情報を表示する。

  - アイテムの詳細画面について、メタデータの表示を階層表示とする。
    
      - 表を階層ごとに分ける。
    
      - 階層表示は、アイテムタイプ設定における「プロパティの階層構造」に基づくものとする。

  - アイテム詳細画面のメタデータのラベルが複数言語表示される
    
      - ラベルの表示を、【Administration \> アイテムタイプ管理(ItemTypes) \>メタデータ (Metadata) 画面】の 「Localization Settings」 での「Japanese」/「English」テキストボックスに設定する。

  - アイテムの詳細画面での作成者について表示する。
    
      - アイテムの詳細画面に作成者の氏名リンクを以下の優先順位で表示する。
        
          - 言語の優先順位  
            1.1 UI表示言語に一致した言語の値  
            1.2 1.1が無い場合、入力順で最初に入力された言語の値
        
          - アイテムリストに表示される作成者について、画面表示と同じ言語の姓名を表示する。表示する姓名は、「Web画面の表示言語＞英語＞アイテム登録時の１つ目の言語＞言語無しで登録した時の１つ目の値」の表示順に従う。
        
          - 言語はアイテムリストには表示しない。
        
          - 姓、または名のみのフィールドを入力していた場合も同様に、「Web画面の表示言語＞英語＞アイテム登録時の１つ目の言語＞言語無しで登録した時の１つ目の値」の表示順に従って表示する。
        
          - 【Administration \> アイテムタイプ管理(ItemTypes) \> メタデータ (Metadata) 画面】の言語のサブプロパティの"Show List"のチェックを非活性とする。
        
          - 作成者の「姓名」「姓」「名」「別名」  
            1.1 作成者姓名  
            1.2 作成者姓  
            1.3 作成者名  
            1.4 作成者別名
    
      - 作成者の氏名リンクを押すと、作成者の詳細情報をフォームで表示する。
        
          - フォームのテンプレートを以下の通りである。

> \[タイトル\]
> 
> \[作成者識別子Scheme\] \[作成者識別子(作成者識別子URIのリンクを付く)\]
> 
> \[言語\]　\[作成者姓名\]
> 
> 　　　　\[作成者別名\]
> 
> 　　　　\[所属機関識別子Scheme\] \[所属機関識名\] \[所属機関識別子(所属機関識別子URIのリンクを付く)\]
> 
> \[リポジトリを検索する\]リンク

  - 説明
    
      - \[タイトル\]  
        作成者の氏名リンク
    
      - \[作成者識別子\]  
        作成者識別子の情報をまとめる。
    
      - \[作成者の情報\]
    
      - 言語のごとに氏名、所属項目をまとめる。  
        ・言語の表示順位に対して、システム言語設定順で言語を並べる。  
        ・ja-kanaがある場合、jaの直下に配置する。  
        ・言語がない場合、フォームの下部に配置する。
        
          - \[作成者姓名\]  
            同一言語で「姓名」が入力されている場合、「姓」「名」が表示されない。
    
      - \[リポジトリを検索する\]リンク  
        リンクを押すと、該当作成者名を条件とし、アイテム検索を実施する。

<!-- end list -->

  - アイテムの詳細画面での書誌情報について以下のようなテンプレートで表示する。
    
      - テンプレート

> \[言語\] : \[タイトル\]
> 
> 巻 {xxx}, 号 {xxx}, p. {開始ページ}-{終了ページ}, ページ数 {xxx}, 発行年 {YYYY-MM-DD} {YYYY-MM-DD}　（日本語の場合）
> 
> Volume {xxx}, Issue {xxx}, p. {開始ページ}-{終了ページ}, Number of Pages {xxx}, Issued Date {YYYY-MM-DD} {YYYY-MM-DD}　（英語の場合）

  - 注意
    
      - 画面表示の多言語化に対応できる。
    
      - \[XX\]がNull（空値）の場合は、「巻 \[XX\]」の部分をまるごと表示しない。
    
      - 終了ページ（\[EP\]）がNull（空値）の場合は、「-」を表示しない。
    
      - 書誌情報プロパティの情報は、以下の表示順に従う。
        
          - 雑誌名は「雑誌名, 」で１つのみ表示する。表示する雑誌名は、「Web画面の表示言語＞英語＞アイテム登録時の１つ目の言語＞言語無しで登録した時の１つ目の値」の表示順に従って表示する。
    
      - 言語はアイテムリストには表示しない。
    
      - 【Administration \> アイテムタイプ管理(ItemTypes) \> メタデータ (Metadata) 画面】の言語のサブプロパティの"Show List"のチェックを非活性とする。

2 Permalink欄の表示について

  - アイテム詳細画面にPermalinkをラベル無しで表示する。

  - DOI \> CNRIハンドル \> URI（https://FQDN/records/\*\*\*\*）の優先順位で表示する。

  - 表示を切り替えるタイミングは、DOI付与申請を含むワークフローが完了したタイミングとする。

  - Yハンドルは表示しない。

3\. アイテムの更新・削除操作

  - 登録者，またはリポジトリ管理者以上でログインしている場合、アイテムの「公開」または「非公開」を選択できる。

  - アイテムにDOIが付与されている場合、「公開」から「非公開」への変更を認めない。  
    　日本語：アイテムにDOIが付与されているため、アイテムを非公開にすることはできません。  
    　英語：You cannot keep an item private because it has a DOI.

  - 登録者，またはリポジトリ管理者以上でログインしている場合、アイテムの \[編集\] ボタンを表示する。ボタンを押下すると、ワークフロー画面に遷移する

  - 登録者，またはリポジトリ管理者以上でログインしている場合、アイテムの \[削除\] ボタンを表示する。ボタンを押下すると、該当アイテムを削除する

    - 過去バージョンがある場合は、最新バージョンに\[削除\]と\[Delete this version\]を表示する。過去バージョンの場合は、\[\Delete this version\]ボタン及び\[戻る\]ボタンを表示する。 

    - 最新バージョンの\[Delete this version\]ボタンが押下された場合は、最新バージョンを論理削除し、ひとつ前のバージョンを最新バージョンに変更する。その後、バージョン更新を行うと、論理削除された次バージョンとして作成する（論理削除されたバージョンは欠番となる）。

  - アイテムにDOIが付与されている場合、アイテムの削除を認めない。  
    　日本語：アイテムにDOIが付与されているため、アイテムを削除することはできません。  
    　英語：The item cannot be deleted because it has a DOI.

  - DOI付与済アイテムについて、アイテムが直接紐づいているインデックスとその上位のインデックスについて、１つでも非表示の設定のものがある場合、アイテムの非公開はできない。  
    　日本語：アイテムにDOIが付与されているため、アイテムを非公開にすることはできません。  
    　英語：You cannot keep an item private because it has a DOI.

  - DOI付与済アイテムの登録・更新時、アイテムが直接紐づいているインデックスとその上位のインデックスについて、全てのインデックス状態が「公開」かつハーベスト公開が「公開」であるインデックスとリンクしていない場合は登録・更新はできない。また、DOI付与済アイテムを公開日が未来のインデックスのみに紐づけることはできない。  
    　日本語：アイテムにDOIが付与されているため、インデックス状態が「公開」かつハーベスト公開が「公開」のインデックスに関連付けが必要です。  
    　英語：Since the item has a DOI, it must be associated with an index whose index status is "Public" and whose Harvest Publishing is "Public".

  - 新規にDOIを付与する際、アイテムが直接紐づいているインデックスとその上位のインデックスについて、全てのインデックス状態が「公開」かつハーベスト公開が「公開」であるインデックスとリンクしていない場合 は登録・更新はできない。また、「公開」であっても、公開日が未来のインデックスのみに紐づくアイテムにはDOI付与はできない

  - 編集ボタンの二重押し抑制する。また、複数人の同時編集が発生しないよう、Redisの「pid\_{}\_will\_be\_edit」で管理する。

4\. その他

  - アイテム詳細画面を印刷時、画面上に表示されていない文字列(URL)は印刷をしない。

  - Google Scholar meta tagについて
    
      - Google Scholar の実装にはGoogle Scholar meta tagが必要である。meta tag はOAI-PMHのXML出力と同じ機能を用いて出力される。
    
      - そのため、OAI-PMH出力をしなければ、Google Scholar meta tagは出力されない。OAI-PMH出力時に、メタデータをXMLに出力すると、該当の情報もGoogle Scholarのmeta tagに出力される。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_records\_ui

  - > weko\_deposit

  - > weko\_detail

  - > weko\_itemtypes\_ui

<!-- end list -->

  - > 処理概要

1\. 設定

  - 作成者のプロパティーキー
    
      - パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-deposit/weko_deposit/config.py#L130>
    
      - 設定キー：WEKO\_DEPOSIT\_SYS\_CREATOR\_KEY
    
      - 現在の設定値：

> WEKO\_DEPOSIT\_SYS\_CREATOR\_KEY = {
> 
> 'creator\_names': 'creatorNames',
> 
> 'creator\_name': 'creatorName',
> 
> 'creator\_lang': 'creatorNameLang',
> 
> 'family\_names': 'familyNames',
> 
> 'family\_name': 'familyName',
> 
> 'family\_lang': 'familyNameLang',
> 
> 'given\_names': 'givenNames',
> 
> 'given\_name': 'givenName',
> 
> 'given\_lang': 'givenNameLang',
> 
> 'alternative\_names': 'creatorAlternatives',
> 
> 'alternative\_name': 'creatorAlternative',
> 
> 'alternative\_lang': 'creatorAlternativeLang',
> 
> 'identifiers': 'nameIdentifiers',
> 
> 'creator\_mails': 'creatorMails',
> 
> 'affiliation\_name\_identifier\_scheme': 'affiliationNameIdentifierScheme',
> 
> 'affiliation\_names': 'affiliationNames',
> 
> 'affiliation\_name': 'affiliationName',
> 
> 'affiliation\_lang': 'affiliationNameLang',
> 
> 'affiliationNameIdentifiers': 'affiliationNameIdentifiers',
> 
> 'affiliation\_name\_identifier': 'affiliationNameIdentifier',
> 
> 'affiliation\_name\_identifier\_URI': 'affiliationNameIdentifierURI','creatorAffiliations': 'creatorAffiliations',
> 
> }

  - 書誌情報のプロパティーキー
    
      - パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-deposit/weko_deposit/config.py#L190-L198>
    
      - 設定キー：WEKO\_DEPOSIT\_BIBLIOGRAPHIC\_INFO\_SYS\_KEY
    
      - 現在の設定値：

> WEKO\_DEPOSIT\_BIBLIOGRAPHIC\_INFO\_SYS\_KEY = \[
> 
> 'bibliographic\_titles',
> 
> 'bibliographicPageEnd',
> 
> 'bibliographicIssueNumber',
> 
> 'bibliographicPageStart',
> 
> 'bibliographicVolumeNumber',
> 
> 'bibliographicNumberOfPages',
> 
> 'bibliographicIssueDates'
> 
> \]

  - 書誌情報に対して実装に使用するキーを設定
    
      - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-deposit/weko_deposit/config.py#L156>
    
      - 設定キー：WEKO\_DEPOSIT\_BIBLIOGRAPHIC\_INFO\_KEY
    
      - 現在の設定値：

> WEKO\_DEPOSIT\_BIBLIOGRAPHIC\_INFO\_KEY = \[
> 
> 'bibliographicVolumeNumber',
> 
> 'bibliographicIssueNumber',
> 
> 'p.',
> 
> 'bibliographicNumberOfPages',
> 
> 'bibliographicIssueDates'
> 
> \]

  - 書誌情報にて、上記のキーに応じてUIに表示するテキストを設定
    
      - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-deposit/weko_deposit/config.py#L165-L186>
    
      - 設定キー：WEKO\_DEPOSIT\_BIBLIOGRAPHIC\_TRANSLATIONS
    
      - 現在の設定値：

> WEKO\_DEPOSIT\_BIBLIOGRAPHIC\_TRANSLATIONS = {
> 
> 'bibliographicVolumeNumber': {
> 
> "en": "Volume",
> 
> "ja": "巻"
> 
> },
> 
> 'bibliographicIssueNumber': {
> 
> "en": "Issue",
> 
> "ja": "号"
> 
> },
> 
> 'p.': {
> 
> "en": "p.",
> 
> "ja": "p."
> 
> },
> 
> 'bibliographicNumberOfPages': {
> 
> "en": "Number of Pages",
> 
> "ja": "ページ数"
> 
> },
> 
> 'bibliographicIssueDates': {
> 
> "en": "Issued Date",
> 
> "ja": "発行年"
> 
> }

2\. 実装方法

  - モジュール：
    
      - weko-deposit：アイテムのメタデータを取得、処理するモジュールである。
    
      - weko-records-ui：アイテムのメタデータを表示するモジュールである。

  - アイテムのメタデータ表示
    
      - データベースから該当アイテムのメタデータを取得する。
    
      - 該当アイテムタイプに「非表示」と設定された属性を非表示とする。
    
      - 特別なプロパティー（作成者、書誌情報）があるかどうか、チェックする。
        
          - 書誌情報に対して、一つのサブアイテムキーが「WEKO\_DEPOSIT\_BIBLIOGRAPHIC\_INFO\_SYS\_KEY」一覧に属される場合、「書誌情報」とする。  
            表示言語を取得、該当するラベルを取得、以下のテンプレートで表示する。  
            テンプレート：  
            <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/templates/weko_records_ui/output_bibliographic_information_detail.html>
        
          - 作成者に対して、プロパティー情報に「attribute\_type = creator」が保存する場合、「作成者」とする。  
            表示言語を取得、該当するラベルを取得、以下のテンプレートで表示する。  
            テンプレート：  
            <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/templates/weko_records_ui/creator_detail_template.html>
    
      - > 残りプロパティーに対して表示言語を取得、該当するラベルを取得、以下のテンプレートで表示する。  
        > テンプレート：  
        > <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/templates/weko_records_ui/output_detail_data.html>

【補足】

  - 以下のサムネイル画像の情報がアイテム詳細画面に表示されている。  
    ・サムネイル画像名  
    ・サムネイル画像
    
      - サムネイル画像の表示サイズについて、横幅の最大値はデフォルトで「100px」としている。
    
      - アップロードされているサムネイル画像の横幅が「100px」を超える場合、横幅を「100px」に自動調整し、あわせて縦の長さも元の画像の比率にあわせて自動調整される。
    
      - なお、横幅の最大値の設定はコンフィグで設定可能：  
        <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/config.py>  
        「WEKO\_RECORDS\_UI\_DEFAULT\_MAX\_WIDTH\_THUMBNAIL = 100」

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>

### コンテンツファイル管理

  - > 目的・用途

本機能は、アイテムに登録されたファイルの情報を表示し、ファイルバージョンを管理する機能である。

  - > 利用方法

アイテム詳細画面のファイル一覧からファイルの情報の閲覧、【information】を押下して詳細情報の閲覧をし、【download】を押下してファイルのダウンロードを行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

1\. ファイルの情報を表示する

  - 【アイテム詳細画面】の上端にファイルの情報を表示するアイテム登録時に選択された表示形式に応じてファイルの情報を以下のように表示する
    
      - 表示形式： **簡易表示（Simple）**
        
          - 登録されたファイル一覧を表示する。「Name/File (名前 / ファイル)」列にファイル名を表示し、ラベルが登録されている場合はファイル名の代わりにラベルが表示される。  
            コンテンツファイルが登録されていない場合は、「Name/File (名前 / ファイル)」列に本文URLが表示される。ラベルが登録されている場合は本文URLの代わりにラベルが表示される。
            
              - ファイル名リンク：コンテンツファイルをダウンロードする。  
                コンテンツファイルが登録されていない場合はリンク先のURLへ遷移する。
            
              - オープンアクセス指定日より前は「Download is available from YYYY/MM/DD.」と表示する。日付が一桁の場合、0埋め表示をしない。  
                ログインしているロールが該当登録者、管理者以外の場合は、公開されていないファイルを選択すると、「権限が必要です (Permission required)」と表示する。STATS\_WEKO\_DEFAULT\_TIMEZONEに設定されたタイムゾーンに基づく時刻を表示する。
        
          - ファイルに対してのアクション
            
              - 【ダウンロード（Download）】：該当ファイルをダウンロードする。  
                コンテンツファイルが登録されていない場合はリンク先のURLへ遷移する。
            
              - 【Information】：該当ファイル詳細画面に移動する。
    
      - 表示形式： **詳細（Detail）**
        
          - 登録されたファイル一覧を表示する。「Name/File (名前 / ファイル)」列にファイル名を表示し、ラベルが登録されている場合はファイル名の代わりにラベルが表示される。  
            コンテンツファイルが登録されていない場合は、「Name/File (名前 / ファイル)」列に本文URLが表示される。ラベルが登録されている場合は本文URLの代わりにラベルが表示される。
            
              - ファイル名リンク：コンテンツファイルをダウンロードする。  
                コンテンツファイルが登録されていない場合はリンク先のURLへ遷移する。
            
              - オープンアクセス指定日より前は「「Download is available from YYYY/MM/DD.」と表示する。日付が一桁の場合、0埋め表示をしない。ログインしているロールが該当登録者、管理者以外の場合は、公開されていないファイルを選択すると、「権限が必要です (Permission required)」と表示する。
        
          - ファイルのライセンス
            
              - 「Write your own license」を選択した場合、テキストボックスに入力されたライセンス値を表示する。
            
              - 「Creative Commons」ライセンスから選択した場合、該当ライセンスアイコンを表示する。
                
                  - システムの表示言語が日本語の場合、ライセンスアイコンを押すと、日本語版のリンク先へ移動する。
                
                  - システムの表示言語が日本語以外の場合、ライセンスアイコンを押すと、英語版のリンク先へ移動する。
        
          - ファイルに対してのアクション
            
              - 【ダウンロード（Download）】：該当ファイルをダウンロードする。  
                コンテンツファイルが登録されていない場合はリンク先のURLへ遷移する。
            
              - 【Information】：該当ファイル詳細画面に移動する。
    
      - 表示形式： **プレビュー（Preview）**
        
          - ファイルのプレビューを表示する（プレビューの仕様について、「3-2.2 登録されたコンテンツファイル及び課金ファイルをプレビューできる」に参考する）
            
              - プレビューエリアを開閉する。
            
              - スライドナビゲーションで、プレビュー対象を切り替える。  
                コンテンツファイルが無い場合は表示形式をプレビュー (Preview)と選択してもプレビューエリアは表示しない。また、コンテンツファイルがない場合表示形式に関係なく、【プレビュー (Preview)】、【ダウンロード (Download)】ボタンを表示しない。  
                公開前のアイテムがある場合は「Cannot preview file」と表示する。  
                該当登録者、管理者以外で公開前のアイテムがある場合は「Restricted Access」と表示する。
        
          - ファイルサイズによりプレビューできない場合は、「Cannot preview file」の表示に、「 file size exceeded. 」が表示される。表示可能なファイルサイズの閾値は定数「WEKO\_ITEMS\_UI\_FILE\_SISE\_PREVIEW\_LIMIT」より設定できる。登録されたファイル一覧を表示する。
            
              - ファイル名リンク：コンテンツファイルをダウンロードする。  
                コンテンツファイルが登録されていない場合はリンク先のURLへ遷移する。
        
          - ファイルに対してのアクション
            
              - 【ダウンロード（Download）】：該当ファイルをダウンロードする。  
                コンテンツファイルが登録されていない場合はリンク先のURLへ遷移する。
            
              - 【Information】：該当ファイル詳細画面に移動する。
            
              - 【プレビュー（Preview）】：該当ファイルのプレビューをプレビューエリアに表示する。

2\. 登録されたコンテンツファイル及び課金ファイルをプレビューできる。

  - ファイルを登録する時、アイテム登録画面での表示形式を「プレビュー(Preview)」を選択すると、アイテム詳細画面に登録されたファイルをプレビューできる。

  - invenio-previewerが提供するすべてのファイルプレビューを利用できる。

  - 対応しているファイルタイプ：
    
      - Markdown
    
      - JSON/XML
    
      - CSV
    
      - PDF
    
      - Simple Images(PNG、JPG、GIF)
    
      - Zip
    
      - Jupiter Notebook(.jpynbファイル)
    
      - MS Office
    
      - 動画、音声(MP3、MP4、WEBM、OGG、WAV)

  - 複数ファイルを登録する場合、ファイルをスライド表示でプレビューできる。
    
      - プレビューエリアにスライドナビゲーションを表示する。
        
          - プレビュー切替はコンテンツファイル一覧の並びに依存する。
        
          - スライドナビゲーションにて、先頭（|\<）/前（＜）/次（＞）/末尾（\>|）のスライドへ移動できる。

  - > PDF形式のファイルに対して、PDFにはカバーページが付与される場合、PDFカバーページはコンテンツファイルの1ページ目に付与し、コンテンツファイルの中身と合わせてカバーページをプレビューに表示する

  - PDF形式のファイルのプレビューは、拡大率やページ数を変更する機能のあるツールバーに囲われた状態で表示される。

  - ファイルプレビューエリアを開閉できる

  - プレビューエリアでの上部に「プレビュー」リンクをクリックすると、ファイルプレビューエリアを開閉する。

  - 表示形式をプレビューとしたJPEGファイルは、ファイルバージョンの管理を行う。

3\. コンテンツファイル及び課金ファイルにアクセス制限がかけられている。

  - アクセス制限の内容を「5.2. 実装方法」での「(1)アイテム詳細画面に表示、ダウンロードする処理」を参照する。

4\. コンテンツファイルごとに更新履歴を表示する。

  - アイテム詳細画面の各ファイルの表示の【Information】ボタンを押すと、該当ファイル詳細画面に移動する。
    
      - アイテム詳細画面と同様にファイルのプレビューを表示する
    
      - ファイル情報の属性情報を表形式で表示する。アイテム登録／編集時に登録していない属性情報は表示されない
        
          - 公開日：　{YYYY}-{MM}-{DD} 形式　(※公開日は必須のため必ず表示される)。エンバーゴが指定されている場合は、エンバーゴ日。オープンアクセスの場合はアイテム公開日を表示する。
        
          - 表示名(FileName)：　ファイル情報の表示名
        
          - 本文URL(Text URL)：　{protocol}://{host}/records/{id}/files/{ファイル名} 形式
        
          - ラベル(Label)：　ファイル情報で入力したラベル名
        
          - オブジェクトタイプ(Object Type)：　ファイル情報で選択したオブジェクトタイプ
        
          - フォーマット(Format)：　システムが出力したフォーマットの値
        
          - サイズ(Size)：　システムが出力したサイズ、または手入力したサイズ（複数入力可能）
        
          - 日付タイプ(Date Type)：　ファイル情報で選択した日付タイプ（複数入力可能）
        
          - 日付(Date)：　{YYYY}-{MM}-{DD} 形式（複数入力可能）
        
          - バージョン情報(Version Information)：　アイテム登録／編集時に入力した値
    
      - ファイル詳細画面では、アイテム詳細画面のファイル情報に加えて、「バージョン」タブに更新履歴情報を表示する。  
        更新履歴の表示項目は、以下とする。

<table>
<thead>
<tr class="header">
<th>#</th>
<th>表示項目</th>
<th>説明</th>
<th>備考</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>バージョン（Version）</td>
<td>ファイルのバージョンを表示する<br />
最新バージョンはCurrentと表示する</td>
<td>コンテンツファイルが削除された場合は該当バージョンを論理削除する</td>
</tr>
<tr class="even">
<td>2</td>
<td>更新日時（Date Modified）</td>
<td>コンテンツファイルの登録日時</td>
<td>ISO8601のTZ付き形式とする<br />
形式：「YYYY-MM-DD hh:mm:ss」</td>
</tr>
<tr class="odd">
<td>3</td>
<td>オブジェクトファイル名（Object File Name）</td>
<td><p>コンテンツファイルにアクセス可能なリンクになっている</p>
<p>※ファイルサイズが大きい場合はマルチパートダウンロードのURLへ差し替えとなる。 マルチパートダウンロードの詳細は、[アイテム詳細]&gt;[コンテンツファイル管理]&gt;[ マルチパートダウンロード処理について]を参照</p></td>
<td>/api/files/BUCKET_ID/FileName</td>
</tr>
<tr class="even">
<td>4</td>
<td>ファイル容量（File Size）</td>
<td>ファイル容量をバイト表示する</td>
<td></td>
</tr>
<tr class="odd">
<td>5</td>
<td>ファイルハッシュ値（File Hash Value）</td>
<td></td>
<td>sha256ハッシュ値</td>
</tr>
<tr class="even">
<td>6</td>
<td>投稿者名（Contributor Name）</td>
<td>ファイルを登録したユーザ名</td>
<td>ゲストユーザの場合は非表示とする</td>
</tr>
<tr class="odd">
<td>7</td>
<td>表示/非表示（Show/Hide）</td>
<td>本項目は管理者またはアイテム登録者のみ表示される<br />
本項目を最新バージョンの行に表示しない<br />
また、"表示"に設定した場合、該当行が全ユーザに表示される</td>
<td></td>
</tr>
</tbody>
</table>

  - 該当アイテムが非公開と設定すれば、
    
      - 該当登録者、管理者以外の場合、ファイル詳細画面に移動せずに、「権限が必要です (Permission required)」を表示する
    
      - ゲストユーザの場合、ログインをリクエストする

  - ファイル詳細画面が既に表示される場合、ファイルが「公開しない」（Do not publish）と変更すれば、ファイル詳細画面をリロードする。  
    該当登録者、管理者以外（ゲストユーザーを含む）に対して、「アクセス制限」のエラーメッセージをプレビューエリアに表示する

  - ファイル情報エリアの表示／非表示は、以下の図の After の表に従って表示制御する  
    別紙「変更前後のマトリクス.png」を参照。
    
      - ※１　オープンアクセス指定日より前は「YYYY年MM月DD日からダウンロード可能です」とファイル情報エリアのName/File欄に表示する
    
      - ※２　登録ユーザ権限以下のユーザがログインした状態で、ファイル情報エリアのダウンロードボタン、プレビューボタンを押下した際、「権限が必要です (Permission required)」と表示する
    
      - ※３　「ログインユーザーのみ」の場合、「アクセス制限」（英「Restricted Access」）と表示する

  - コンテンツファイル登録時にオープンアクセス日を未来日に指定し、指定日より前に表示した場合、以下のメッセージをファイル情報エリアのName/File欄に表示する。オープンアクセス日はローカル時間で表示される。  
    (日)「YYYY年MM月DD日からダウンロード可能です」  
    (英)「Download is available from YYYY/MM/DD.」

  - ファイルのリンク、\[ダウンロード(Download)\]ボタン、\[プレビュー(Preview)\]ボタンを押下すると、ログイン画面を表示する（Shibboleth連携の場合はShibbolethログイン画面を表示する）
    
      - ログイン認証時、権限のチェックを行う。
        
          - ログインユーザーロール（上記マトリクス※2）の場合
            
              - ログイン認証後、以下のメッセージをポップアップ表示する。  
                (日)「YYYY年MM月DD日からダウンロード/プレビュー可能です」  
                (英)「Download / Preview is available from YYYY/MM/DD.」
            
              - 既にログインしている状態で、ファイル情報エリアのダウンロードボタンもしくはプレビューボタンを押下した際、上記メッセージを表示する
        
          - 登録ユーザーロール以上の権限の場合(登録ユーザ、リポジトリ管理者、コミュニティ管理者、システム管理者)
            
              - ログイン認証後、ファイルのダウンロード/プレビューが行える

  - ゲスト(非ログイン)ユーザが参照する場合、ファイル情報エリアを表示し、以下のメッセージをファイル情報エリアのName/File欄に表示する  
    (日)「アクセス制限」  
    (英)「Restricted Access」

  - ゲスト(非ログイン)ユーザがログイン認証後は、アイテム詳細表示画面に遷移する

  - アイテム詳細画面の各ファイルの「Actions」表示欄に「申請」ボタンを表示する。「申請」ボタンを押すと、アイテム登録時に指定した提供方法に応じたワークフローが起動すること
    
      - 提供方法に一致しないユーザが「申請」ボタンを押下した場合はモーダルで警告メッセージを表示する
    
      - 起動したワークフローが「作業済(Done)」になった際、ワークフローを起動したユーザにファイルのダウンロードリンクをメールで送信すること

5\. コンテンツファイルのアクセス制御

コンテンツファイルが「未来日」・「ログインユーザのみ」・「公開しない」設定であり、インデックス条件が、アイテムが所属するインデックスとその上位のインデックスが「公開」設定(未来日では無い)の場合、以下のようにアクセス制御を行う

  - Guest
    
      - 【ダウンロード (Download)】押下：　ログイン要求をする
    
      - DLのURLを入力：　ログイン要求をする  
        ※入力するURLは登録者(Contributor)以上がボタンを押下したときのURL( } )とする
    
      - ログイン要求でログインしたあと、ロールの種類に応じて画面遷移する
        
          - 登録者以外(ログインユーザ)：　"Permission required"を表示
        
          - 登録者以上：　DL可能
    
      - Informatonボタン押下：　ログイン要求をする
    
      - Informaton画面のURLを入力：　ログイン要求をする
    
      - ログイン要求でログインしたあと、ロールの種類に応じて画面遷移する
        
          - 登録者以外(ログインユーザ)：　"Permission required"を表示
        
          - 登録者以上：Information画面を表示

  - Authenticated User
    
      - 【ダウンロード (Download)】ボタン押下：　"Permission required"を表示する
    
      - DLのURLを入力：　"Permission required"を表示する  
        ※入力するURLは登録者(Contributor)以上がボタンを押下したときのURL( } )とする
    
      - 【Informaton】押下：　"Permission required"を表示する
    
      - 「Informaton」画面のURLを入力：　"Permission required"を表示する

<!-- end list -->

  - 「制限公開」設定のファイルについては、下記条件の場合、DLボタンの代わりにApply（申請）ボタンが表示される。
    
      - 1.対象のコンテンツ（＝ファイル）のアクセスロールが「制限公開」（open\_restricted)である。
    
      - 2.該当コンテンツをダウンロードする権限が、画面表示しているユーザ（未ログイン含む）に無い。
    
      - 　※アイテム登録者やリポジトリ管理者のみならず、申請によって権限を得ているログインユーザもダウンロード権限があるとみなす。
        
          - Applyボタン押下の処理は、本書「実装方法」の「ダウンロード処理について」にある、「アクセスが「制限公開」（Restricted Access）と設定されているコンテンツに対して」の説明を参照
    
    <!-- end list -->
    
      - Informaton画面にて、「シークレットURLボタン」が表示される。
        
          - 下記をすべて満たす場合表示
            
              - 1.アイテム登録者・またはリポジトリ管理者・システム管理者である。
            
              - 2.管理画面の制限公開画面にて、シークレットURLの表示が有効である。
            
              - 3.ファイルが「公開しない」である。または、ファイルが「オープンアクセス日を指定する」かつ指定日が未来日である。
        
          - シークレットURLボタンを押下すると、シークレットURLを発行し、画面表示しているユーザのメールアドレスにメール通知する。シークレットURLはURLを知っていれば誰でも対象のコンテンツファイルをダウンロードできるURL。（有効期限とダウンロード回数の制限を設定可能）

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko-records-ui

<!-- end list -->

  - > 処理概要

1\. 設定

  - ファイルをプレビュー表示するため、ファイルからPDF形式に変換し、テンポラリーフォルダーに書き込む処理を行う

  - テンポラリーフォルダーの初期値は「/var/tmp」であり、以下のConfigファイルで設定できる  
    <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-files-rest/invenio_files_rest/config.py#L128>
    
      - 設定キー：「FILES\_REST\_DEFAULT\_PDF\_SAVE\_PATH」
    
      - 現在の設定値：FILES\_REST\_DEFAULT\_PDF\_SAVE\_PATH = tempfile.gettempdir()

  - 予期せぬエラーによりファイルをテンポラリーフォルダーに書き込むことができない場合、以下のメッセージがプレビュー画面に表示される  
    メッセージ：「Unexpected server response (502) while retrieving PDF + ファイルパス」

2\. 実装方法

  - ファイルビューアのライブラリ：pdfjs-dist (ver. 1.4.192)

  - weko\_records\_ui.permissions.check\_file\_download\_permissionを使用する。

(1)アイテム詳細画面に表示、ダウンロードする処理

  - ファイル情報の表示処理について  
    アクセスしているユーザーの権限が管理者であるかどうか、weko\_records\_ui.permissions.check\_file\_download\_permissionにて「WEKO\_PERMISSION\_SUPER\_ROLE\_USER」を使用する
    
      - 権限が管理者の場合、アイテムに登録されるファイルの表示形式に応じてファイルの情報を取得し、表示する
    
      - 権限が管理者ではない場合、ユーザーの権限及びアクセス権限をチェックする
        
          - コンテンツファイルに対して
            
              - コンテンツのアクセスが「オープンアクセス」とした場合、ファイルの情報を取得し、表示する
            
              - コンテンツのアクセスが「オープンアクセス日を指定する」とした場合、以下のように制限する
                
                  - オープンアクセス日が経過していない場合、管理者または登録者、または設定されているグループに所属するユーザーには該当コンテンツファイルを表示、ダウンロードできる
                
                  - オープンアクセス日が経過していない場合、権限がないユーザーには該当コンテンツファイルを表示しない  
                    　 ⇒権限が無いユーザーには「「Download is available from YYYY/MM/DD.」と表示する
                
                  - オープンアクセス日が経過した場合、すべてのユーザーは該当コンテンツファイルを表示、ダウンロードができる
            
              - コンテンツのアクセスが「ログインユーザのみ」とした場合、以下のように制限する
                
                  - weko\_records\_ui.permissions.checl\_file\_download\_permissionでcheck\_user\_group\_permissionを呼び出して使用する。
                
                  - 設定されているグループに所属するユーザーには該当コンテンツファイルを表示する
                
                  - 設定されているグループに所属しないユーザーには、該当コンテンツファイルを表示しない
            
              - コンテンツのアクセスが「公開しない」とした場合、以下のように制限する
                
                  - weko\_records\_ui.permissions.checl\_file\_download\_permissionでcheck\_user\_permissionを呼び出して使用する。
                
                  - 管理者またはアイテム登録者には該当コンテンツファイルを表示する
                
                  - 権限がないユーザーには該当コンテンツファイルを表示しない
            
              - コンテンツのアクセスが「制限公開」とした場合、以下のように制限する
                
                  - 管理者またはアイテム登録者には該当コンテンツファイルを表示する
                
                  - 権限がないユーザーには、「アクセス制限（Restricted Access）」と表示する
                    
                      - 「Actions」に、ダウンロードボタンのかわりに、「申請」（Apply）ボタンを表示する
        
          - 課金ファイルに対して
            
              - コンテンツのアクセスを「オープンアクセス」とした場合、ファイルの情報を表示する
            
              - コンテンツのアクセスを「オープンアクセス日を指定する」とした場合、以下のように制限する  
                ・オープンアクセス日が経過していない場合、該当コンテンツファイルを表示する  
                ・オープンアクセス日が経過した場合、該当コンテンツファイルを表示しない
            
              - コンテンツのアクセスが「ログインユーザのみ」とした場合、  
                ・設定されているグループに所属するユーザーには該当コンテンツファイルを表示する  
                ・設定されているグループに所属しないユーザーには、該当コンテンツファイルを表示しない
            
              - コンテンツのアクセスが「公開しない」とした場合、ファイルの情報を表示しない

  - ダウンロード処理について
    
      - コンテンツファイルに対して  
        アイテム詳細画面に表示している、かつログインしている場合、ダウンロードできる
    
      - 課金ファイルに対して
        
          - コンテンツのアクセスが「オープンアクセス」とした場合、ファイルの情報を取得し、ダウンロードできる
        
          - コンテンツのアクセスが「オープンアクセス」以外とした場合、ファイルの情報を取得し、追加で以下の制限を実施する
            
              - 価格が設定されていないグループのユーザーは課金ファイルをダウンロードできない
                
                  - アイテム詳細画面及び課金ファイルのリンクを押下したときに、ダウンロード可能かを判断する  
                    ・ゲストユーザの場合：ログイン画面に遷移する  
                    ・設定されていないグループの場合：「本ファイルの参照権限がないためダウンロードできません。」とポップアップでエラーメッセージを表示する  
                    ・設定されているグループの場合：「本ファイルは課金ファイルです。 （価格：XXXXX）。 ダウンロードしますか。」とポップアップで確認メッセージを表示する  
                    　はい：ファイルをダウンロードする  
                    　いいえ：ファイルをダウンロードせず、自画面に戻る
            
              - 複数のグループに所属するユーザーには該当する価格の最低値が適用される
                
                  - アイテム詳細画面及びファイル詳細画面のコンテンツファイルのリンクを押下したときに、ユーザが所属しているグループを確認する  
                    対象のユーザが複数のグループに所属していた場合は、各グループで設定している課金ファイルの価格のうち、最低値のものを採用する
    
      - アクセスが「制限公開」（Restricted Access）と設定されているコンテンツに対して
        
          - weko\_records\_ui.permissions.check\_file\_download\_permissionでcheck\_open\_restricted\_permissionを呼び出して使用する。
        
          - 管理者または登録者に対して、アイテム詳細画面、ファイル詳細画面に、ファイルの情報を取得し、ダウンロードできる
        
          - 権限がないユーザーは、ファイルをダウンロードするために、利用申請を実施する必要がある
            
              - コンテンツのアクセスが「制限公開」で「提供方法：ロール」を「Guest(非ログインユーザ)」または「Contributor」等の任意のロールとした場合、以下の操作が行える
            
              - 提供方法に一致するユーザーがアイテム詳細画面の【申請 (Apply)」ボタンを押下した際に利用申請設定時に設定されている利用規約をモーダル画面に表示する
                
                  - 利用規約について
                    
                      - 利用規約文表示エリア上部に「利用規約 (Terms and Conditions)」を固定で表示する
                    
                      - 利用規約文表示エリア下部に「利用規約を確認の上、スクロール最下部にある「利用規約に同意する」にチェックを入れてください (I have read and agreed to the Terms and conditions)」を固定で表示する
                    
                      - \[利用規約に同意する」ラベルクリック時もチェックボックスのオンオフができるようにする
                    
                      - 利用規約を最後まで確認すると「利用規約に同意する」チェックボックスをチェックできる。チェック前は「次へ」ボタンを非活性とする
                
                  - 利用規約画面での「次へ」ボタンを押下する挙動について
                    
                      - 「 提供方法：ロール (Providing Method: Role)」が「Guest（非ログインユーザ）」で設定される場合、メールアドレスが入力できるモーダル画面が表示される。メールアドレスを入力し「Enable」ボタンを押下するとメールが送付される。
                    
                      -   - 受信したメール文のリンクをクリックするとワークフローに定義されているアクション画面（アイテム登録画面など）に遷移する
                        
                          - リンクはランダムなURLとトークン値から構成し、両者が一致した場合に利用登録ワークフローへのリンクとして機能する
                    
                      - 「Contributor」等の任意のロールが「 提供方法：ワークフロー (Providing Method: WorkFlow」で設定される場合、指定されたワークフローの画面に遷移する
                
                  - ワークフローが終了された時点、コンテンツファイルダウンロードのリンクをメールで追記する。リンクの有効期限とダウンロード回数は【Administration \> 設定 (Setting) \> 制限公開 (Restricted Access)画面】での「コンテンツファイルのダウンロード」(Content File Download)エリアで設定される
                
                  - ダウンロードのリンクへアクセスする時、リンクの有効期限とダウンロード回数が超えない場合、コンテンツファイルがダウンロードできる。ダウンロード回数がカウントダウンされる
                    
                      - weko\_records\_ui.utils.validate\_onetime\_download\_tokenを使用する。
                    
                      - 有効期限を超過した場合、エラーメッセージが表示される  
                        日本語：「ダウンロード有効期限を超過しています。」  
                        英語：「 The expiration date for download has been exceeded. 」
                    
                      - ダウンロード回数を超過した場合、エラーメッセージが表示される  
                        日本語：「ダウンロード上限回数を超過しています。」  
                        英語：「 The download limit has been exceeded. 」
                
                  - 上記によってコンテンツファイルがダウンロードできる間は、申請ボタンはダウンロードボタンになり、ダウンロードボタン押下でファイルをダウンロードできる。
                    
                      - 有効期限を超過した場合、またはダウンロード回数を超過した場合、画面を再表示すると権限が無くなったため申請ボタンに戻る。再表示せずにダウンロードボタンを押下した場合、権限エラーになる。
                    
                      - 申請ボタンからダウンロードボタンになるのは、そのアイテムの制限公開のコンテンツファイルすべて（承認が行われた時点でのすべて）である。
                    
                      - 有効期限とダウンロード回数はコンテンツファイルごとに管理される。一方で、リンクからのダウンロード、ダウンロードボタンからのダウンロードは同じ有効期限とダウンロード回数を参照する。（ダウンロード回数２回の場合に、リンクからのダウンロード１回、ダウンロードボタンからのダウンロード１回を行うと、ダウンロードの残り回数は０になる）
            
              - 制限公開用のコンテンツファイルでの提供方法に一致しないユーザが「申請」ボタンを押下した場合はモーダルで警告メッセージを表示する  
                警告メッセージ：  
                日本語：「このデータは利用できません（権限がないため）。」  
                英語：「This data is not available for this user.」
            
              - 制限公開で登録したコンテンツファイルを最初ダウンロードした際にユーザのアカウントに応じた利用報告ワークフローリンクをメールで通知できる
                
                  - 
                  - ゲストユーザの利用報告ワークフローに対して、  
                    リンクの有効期限は【Administration \> Setting \> Restricted Access画面】での「利用報告ワークフローへのアクセス」(Usage Report Workflow Access)エリアで設定される
                    
                      - 設定された有効期限を超過した場合、対象の利用報告ワークフローのステータスを「キャンセル」に自動で更新する
                    
                      - 設定された有効期限を超過したリンクにアクセスした場合は、エラーページを表示する  
                        日本語：「指定したリンクはアクセス有効期限を超過しています。 」  
                        英語：「The specified link has expired.」  
                        weko\_workflow.utils.validate\_guest\_activity\_expiredを使用する。

  - シークレットURLについて
    
      - シークレットURLへアクセスする時、URLの有効期限とダウンロード回数が超えない場合、コンテンツファイルがダウンロードできる。ダウンロード回数がカウントダウンされる
        
          - 有効期限を超過した場合、エラーメッセージが表示される
            
              - 日本語：「ダウンロード有効期限を超過しています。」
            
              - 英語：「 The expiration date for download has been exceeded. 」
        
          - ダウンロード回数を超過した場合、エラーメッセージが表示される
            
              - 日本語：「ダウンロード上限回数を超過しています。」
            
              - 英語：「 The download limit has been exceeded. 」
    
      - 有効期限とダウンロード回数は、URLごとに管理される。（制限公開の有効期限・ダウンロード回数とは別管理となる）
        
          - 
  - 「PDFカバーページ」処理について
    
      - ファイルのプレビュー及びファイルダウンロードにて、「PDFカバーページ」処理を実施する
    
      - weko\_records\_ui.admin.PdfCoverPageSettingView.indexを使用する。
    
      - 以下の条件を満たす場合、PDFカバーページを作成する
        
          - ファイルのプレビューの権限がある
        
          - 【Administration \> Setting \> PDF Cover Page】及び【Administration \> インデックスツリー管理 (Index Tree) \> ツリー編集 (Edit Tree)】でPDFカバーページの設定が有効になっている
        
          - 対象ファイルの形式は「PDF」形式である
        
          - 対象ファイルがパスワード付かない

  - プレビュー表示処理について
    
      - コンテンツファイルが「preview」の場合、詳細画面にプレビューを表示する。  
        weko\_records\_ui.utils.get\_file\_info\_listを使用する

(2) ファイル詳細画面に表示、ダウンロードする処理

  - 表示処理について
    
      - 該当アイテムが公開しているかどうか、チェックする
        
          - 該当アイテムが非公開である場合
            
              - ゲストユーザに対してログインリクエストとする
            
              - 該当登録者、管理者の場合、ファイルの情報（バージョン情報を含む）を取得し、表示する
            
              - 他の権限に対して、「権限が必要です」のエラーメッセージを表示する
        
          - 該当アイテムが公開している場合  
            (1)での「ファイル情報の表示処理について」のようにチェックする
    
      - 権限があるユーザには、該当するファイル詳細画面に表示する
    
      - 権限がないユーザには、「アクセス権限」のエラーメッセージを表示する

  - プレビュー表示処理について(1)での「プレビュー表示処理について」のようにチェックする

  - ダウンロード処理について  
    (1)での「ダウンロード処理について」のようにチェックする

(3)ファイルバージョンの情報をweko\_records\_ui.view.default\_view\_methodで取得し、更新履歴情報を表示する

  - データベースから該当ファイルの情報を以下のように取得する
    
      - 更新日時：files\_object.updated
    
      - オブジェクトファイル名：files\_objectkey
    
      - ファイル容量：files\_files.size
    
      - ファイルハッシュ値：files\_files.checksum
    
      - 投稿者名：userprofiles\_userprofile.username
    
      - 表示/非表示：files\_object.is\_show

【補足】

  - ファイルプレビューのビューアは、ファイルのアクセス権限と同様。  
    ファイルのアクセス権限がないユーザーは、ファイルプレビュー及びファイルの情報を見ることはできない

(4)マルチパートダウンロード処理について

  - 閾値を超えるサイズのファイルについては、マルチパートダウンロードを行う。マルチパートダウンロードは、本文URLとは異なるURLからファイルをダウンロードできる。

  - 閾値は、定数「MAX\_DOWNLOAD\_SIZE\_AT\_ONE\_TIME」にて設定できる。1パートあたりのサイズは、定数「 DOWNLOAD\_SIZE\_IN\_ONE\_PART」にて設定できる。

<!-- end list -->

  - ダウンロードのボタン・リンクを押下すると、大容量ファイルダウンロードを開始する旨のメッセージが表示される。

  - OK押下すると、「名前を付けて保存」のファイルピッカーを表示する。

  - ファイルピッカーにて、ダウンロードファイルの名前を指定すると、ファイルダウンロードが開始される。ダウンロード中は画面操作が行えなくなり、また画面を閉じるとダウンロードが中断されてしまう。

  - ダウンロード処理が完了すると、画面操作が行えるようになり、成功時は緑の帯で、失敗時は赤帯でメッセージが表示される。

  - マルチパートダウンロードでは、通常のダウンロードと同じファイルアクセス権限チェックが行われる。

  - マルチパートダウンロードでは、パートの一番最後のダウンロードのタイミングで統計情報が送信される。

  - マルチパートダウンロードでは、PDFカバーページには対応していない。

1TBファイルまではダウンロードの動作を確認済みだが、それより大きいファイルについては、動作を保証していない。

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/11/11</p>
</blockquote></td>
<td>V0.9.27</td>
<td></td>
</tr>
<tr class="odd">
<td>2023/12/22</td>
<td>4ec162bf3bdcf843df23863fbf7d5bb36ba875e4</td>
<td>W2023-42</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>
### アイテムバージョン管理

  - > 目的・用途

本機能は、アイテムを更新したバージョンの情報を表示し、アイテムバージョンを管理する機能である。

  - > 利用方法

アイテムバージョンは、アイテム詳細画面の右端にあるバージョンの一覧を押下することで表示される。  
アイテムバージョンの管理は、アイテム詳細画面の【編集 (Edit)】からバージョンの変更/維持を選択し、管理する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

1\. アイテムバージョン一覧を表示する

  - アイテム詳細画面での「バージョン (Versions)」領域にアイテムバージョン一覧を表示する
    
      - 4つの最新バージョンを以下のフォーマットで表示する
        
          - 「Ver.」 +バージョン番号
        
          - 更新日付。フォマード：YYYY-MM-DD hh:mm:ss.tttttt
    
      - 「Show all versions」リンクを押すと、すべてのバージョンを表示する

  - アイテムバージョン一覧から、バージョンリンクを押すと、該当バージョンのアイテム情報を反映する
    
      - T「here is a newer version of this record available.」のメッセージを画面上部に表示する
    
      - 最新バージョン以外のアイテムは更新できない（「編集」ボタンを非表示とする）
    
      - OAI-PMH出力のボタンを押すと、画面で表示しているバージョンを対象とする
    
      - JSON、BIBTEX出力のリンクを押すと、画面で表示しているバージョンを対象とする

2\. アイテム編集時にバージョンの変更／維持を選択できる

  - > アイテムの編集権限があるユーザーには、アイテム詳細画面での【編集（Edit）】ボタンを押すと、アイテムのメタデータが編集できる。  
    > アイテム編集画面に編集したアイテムのバージョンの変更／維持が選択できる。

  - バージョンの変更 (Upgrade Version)／維持 (Keep Version)の選択をアイテム編集画面の「バージョン管理」（Version Management）に表示する  
    必須項目とする

  - 初期値は維持 (Keep Version)

  - 選択肢：「バージョンを更新する」（Upgrade Version）、「バージョンを維持する」（Keep Version）
    
      - 「バージョンを更新する」を選択
        
          - 編集したアイテムのバージョンを新規バージョンとする
    
      - 「バージョンを維持する」を選択
        
          - バージョンを維持してアイテムを更新する
        
          - バージョンを維持して更新したことをアプリケーションのログに記録する

  - 【アイテム編集について】
    
      - アイテム編集時に旧バージョンは以前の公開ステータスが引き継がれること
    
      - バージョン数が10を超えても正しく登録できること
    
      - ItemRegistration画面のバージョンを更新／維持のラジオボタンについて、デフォルトで「バージョンを維持する」にチェックが入っていること

  - 【アイテム削除について】
    
      - アイテム詳細画面では以下のようになること  
        →旧バージョン：「削除」ボタンを非表示とする  
        →最新バージョン：「削除」ボタンを表示する  
        →「Delete This version」ボタンを押下すると当該バージョンのみのを削除する
    
      - ハーベストの時に、対象のアイテムが削除された場合（ハーベスト先のリポジトリからdelete情報を受け取った際）全バージョンを論理削除する
    
      - 一括削除（Administration\>アイテム (Items)\>一括削除 (Bulk Delete)）時に、対象としたアイテムのすべてのバージョンを論理削除する
    
      - 削除／復元（Administration\>レコード管理 (Records)\>レコードメタデータ (Record Metadata)で旧バージョンのみの論理削除はできないこと
    
      - 最新バージョン削除時は旧バージョンもすべて論理削除されること

3\. アイテムバージョンの表示/非表示を設定できる

【Administration \> アイテムタイプ管理 (Item Types) \>メタデータ (Meta)画面】から、アイテムタイプのバージョンの表示／非表示を設定できる

1.  > 過去のバージョンを表示（初期値）

2.  > 過去のバージョンは非表示

ログイン有無またユーザのロールによる区別は行わない

  - > 関連モジュール

<!-- end list -->

  - weko-records-ui

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - アイテムのバージョン一覧を表示する処理
    
      - 該当アイテムのpid\_ver、active\_versionsをweko\_records\_ui.view.default\_view\_methodで取得する
    
      - アイテムが下書きの状態の場合、アイテムバージョン一覧には表示しない。  
        \['\_deposit'\]\['status'\] == 'draft' の場合は取得したactive\_versionsを削除する。  
        <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/views.py#L423>
    
      - デフォルトとし、4つの最新バージョンをアイテム詳細画面に表示する
        
          - 表示内容：バージョン番号、更新日付
    
      - 「Show all versions」リンクを押すと、すべてバージョンを表示する

  - 該当バージョンのアイテムメタデータを表示する処理
    
      - アイテムバージョン一覧からバージョンをクリックすると、PIDの値を取得し、該当メタデータを取得し、表示する  
        weko\_records\_ui.templates.weko\_records\_ui.box.versionsにおいてinvenio\_records\_ui.recidを使用する。  
        <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/templates/weko_records_ui/box/versions.html>
    
      - OAI-PMH出力及びJSON、BIBTEX出力を実行する時、表示しているバージョンのPID値を取得し、実行する  
        invenio\_oaiserver.response.pyを使用する。

  - アイテムのバージョンダウンをする操作は無い（バージョンダウンをするためにはDB,ESで紐づいているファイルのデータの変更や削除をする必要があり、そのような実装はしていない）
    
      - 暫定対策( [WEKO3\_OPE-282](https://nii.backlog.jp/view/WEKO3_OPE-282#comment-1296314189) )
        
          - 旧バージョンのPIDのステータスを"D"にすることで、関連ファイルへのアクセスを防ぐことができる  
            ※ver.1 が表示されなくなるため、 ver.1へのアクセスもできなくなる。  
            　ただし、ver.2という表示が残るのと、物理ファイルは残る。

  - バージョンアップして更新した場合、古いバージョンのアイテムの公開状態はそのまま維持する（新しいバージョンは公開状態となる）

  - バージョン欄の時刻は UTC として表記されている。  
    JSTに切り替える機能は無く、切り替えるためには、 <https://invenio-i18n.readthedocs.io/en/latest/api.html#module-invenio_i18n.jinja2> を使用して実装する必要がある。
  
  - バージョン欄の時刻は pidstore_pid の pid_type: recid の updated カラムの日時を表示している。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### 引用情報表示

  - > 目的・用途

本機能は、引用情報を表示する機能である

  - > 利用方法

引用情報表示は、アイテム詳細画面のCite asエリアに表示される。表示のスタイルを「Start typing a citation style」から変更する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - アイテム詳細画面での「Cite as」エリアに引用情報を表示する
    
      - デフォルトスタイル：AAPG Bulletin

  - 「Start typing a citation style」テキストボックスに表示したいスタイルを選択できる
    
      - 「Start typing a citation style」テキストボックスにスタイルを入力すると、入力された値に合うスタイルが自動提案される
    
      - スタイルを選択すると、選択スタイルを適用した引用情報が\[Cite as\]エリアに表示される  
        選択スタイルが「Start typing a citation style」テキストボックスに表示される  
        ※それぞれのスタイルに応じて、UIに表示する引用情報が異なる

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_records\_ui

  - > invenio\_records\_rest

<!-- end list -->

  - > 処理概要

1\. 設定

> デフォルトスタイルを設定する

  - > パス：  
    > <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/templates/weko_records_ui/box/share.html#L50>

  - > デフォルトの設定値：「style= 'aapg-bulletin'」

> 表示内容

  - > 「n.d.」：「no date」の省略( <https://docs.citationstyles.org/en/v1.0.1/specification.html#date> )
    
      - datacite:dateにマッピングしているものを表示する  
        複数の項目をdatacite:dateにマッピングすると、ランダムに取得して表示する
    
      - 日付のフォーマットとして以下のものに対応する。データがない、もしくは以下のフォーマットに合致しない場合、「n.d.」となる。
        
          - YYYY
        
          - YYYY-MM
        
          - YYYY-MM-DD

> 以下にマッピングされた項目が出力される

  - > 作成者：jpcoar:creatorName

  - > 日付：datacite:date

  - > タイトル：dc:title

  - > 出版者：dc:publisher

  - > 開始ページ：jpcoar:pageStart

  - > 終了ページ：jpcoar:pageEnd

> 使用しているスタイル（packages.txt）

  - > citeproc-py-styles==0.1.2

2\. 実装方法

> モジュール：  
> invenio\_records\_rest.serializers.citeprocにおいてciteproc\_stylesを取得する。

  - > weko\_records：アイテムメタデータを取得するモジュールである

  - > invenio-records-rest：取得されたアイテムメタデータを引用情報として登録するモジュールである

> 引用情報の表示スタイルについて  
> アイテム詳細画面にアクセスする時、引用情報の表示スタイルを「invenio\_records\_rest」モジュールでの「citeproc\_styles」から、取得し表示する
> 
> 引用情報について

  - > アイテム詳細画面にアクセスすると、以下のようなアイテムメタデータをweko\_records.serializer.schemas.cslのRecordSchemaCSLJSON」で取得する
    
      - 公開日
    
      - その他のタイトル
    
      - 言語
    
      - 識別子登録(DOI)
    
      - 作成者
    
      - 内容記述
    
      - 号
    
      - 巻
    
      - 発行日
    
      - ページ数
    
      - 出版者
    
      - バージョン
    
      - id (pid\_value)

  - > 選択された表示スタイルによって、上記のアイテムの情報を取得し、「serialize」メソッドで引用情報とし登録し、UIに表示する  
    > invenio\_records\_rest.serializers/citeproc/CIteprocSerializerを使用する。

【補足】

> Cite asの情報での表示言語の優先度は以下の通りです。画面表示言語＞英語＞アイテム登録時のタイトルの言語

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>

### 統計情報表示

  - > 目的・用途

本機能は、アイテムの利用統計情報を閲覧する機能である

  - > 利用方法

アイテムの利用統計情報は、アイテム詳細画面の右端にあるViewsエリア、ファイル詳細画面(information)のstatsにおいて閲覧する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

1\. アイテムの利用統計情報を表示する

  - アイテムの利用統計情報の表示/非表示を設定する
    
      - 【Administration \> 設定 (Setting) \> 統計情報表示 (Stats)画面】での「レコード統計の表示/非表示」（Show/Hide Record Stats）エリアにアイテムの利用統計情報の表示/非表示を設定する
        
          - 「オン」（On）にすると、アイテム詳細表示画面に利用統計エリア\[Stats\]を表示する
        
          - 「オフ」（Off）にすると、アイテム詳細表示画面に利用統計エリア\[Stats\]を非表示とする
        
          - デフォルト：「オン」（On）
        
          - 「保存」（Save）ボタンを押すと、設定内容を保存し、メッセージを画面上部に表示する  
            メッセージ：  
            　日本語：「設定を変更しました」  
            　英語：「Successfully Changed Settings.」

  - アイテムの利用統計情報を表示する
    
      - アイテム単位の閲覧回数は、【アイテム詳細画面】での「Views」エリアに表示する
    
      - アイテム詳細画面に遷移する時に、「record\_viewed」というシグナルを読み取る  
        <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/views.py#L451-L456>
        
          - record\_viewedのシグナルはconfigで設定されたタイミング（数秒）で実行されて、閲覧回数をDBから取得しESに登録する。
    
      - record\_viewedのシグナル実行後、invenio-statsが閲覧回数をログ集計をする。 （invenioの処理）  
        <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/invenio_stats/views.py#L209-L212>
    
      - 閲覧回数は、全ドメインと各ドメイン毎（トップレベルドメイン毎）で集計値を表示する
        
          - 各ドメイン毎（トップレベルドメイン毎）はデフォルト表示を"非表示"とし、「詳細を確認」（See details）リンクを押すことで表示する
            
              - 確定できないドメインに対して、「UNKNOWN」として表示する
    
      - 閲覧回数は、集計機関プルダウン「Period」より年月を選択することで指定期間の数値を表示する
        
          - デフォルトは全期間の数値 (total)とする

2\. コンテンツファイル単位の統計情報を表示する

  - 【ファイル詳細画面 (Information)】での「統計」（Stats）タブにコンテンツファイル単位の統計情報を表示する
    
      - ダウンロード回数は、Downloadsエリアに表示する
    
      - ファイルをダウンロードされるたびに、「file\_downloaded」シグナルを読み取る。  
        このシグナルはDBからダウンロード回数を取得しESに登録する。  
        <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-files-rest/invenio_files_rest/views.py#L766>
    
      - 
      - 再生回数は、「再生回数」（Plays）エリアに表示する
    
      - ファイルをプレビューされるたびに、「file\_previewed」シグナルを読み取る。  
        このシグナルはDBから再生回数を取得しESに登録する。  
        <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-files-rest/invenio_files_rest/views.py#L764>
    
      - 「file\_downloaded」や「file\_previewed」シグナル実行後、invenio-statsがダウンロード回数と再生回数をログ集計してくれる　（invenioの処理）
    
      - 統計情報は、全ドメインと各ドメイン毎（トップレベルドメイン毎）で集計値を表示する
    
      - 各ドメイン毎（トップレベルドメイン毎）はデフォルト表示を"非表示"とし、「詳細を確認」（See details）リンクを押すことで表示する
        
          - 確定できないドメインに対して、「UNKNOWN」として表示する
    
      - 統計情報は、集計機関プルダウン「total」より年月を選択することで指定期間の数値を表示する
        
          - デフォルトは全期間の数値 (total) とする
    
      - ダウンロード回数と再生回数は、ファイルの差し替えを行った場合でも統計値は引き継いで集計する
    
      - 集計はCELERY\_BEAT\_SCHEDULEのstats-aggregate-events設定に従い実施される。デフォルトでは起動時のタイミングから１日毎に集計される。  
        <https://github.com/RCOSDP/weko/blob/v0.9.22/scripts/instance.cfg#L77>

> 'stats-aggregate-events': {
> 
> 'task': 'invenio\_stats.tasks.aggregate\_events',
> 
> 'schedule': timedelta(days=1),
> 
> 'args': \[('celery-task-agg', 'file-download-agg', 'file-preview-agg', 'item-create-agg', 'record-view-agg', 'search-agg', 'top-view-agg')\],
> 
> },

  - > 関連モジュール

<!-- end list -->

  - > weko\_records\_ui

  - > invenio\_stats

  - > invenio\_files\_rest

<!-- end list -->

  - > 処理概要

> アイテム詳細画面を開く際に、weko\_records\_ui.views.default\_view\_methodを呼び出して  
> record\_viewedに閲覧回数を送り出し、ESに回数を登録する。

  - > invenio\_stats.views.QueryRecordViewCountにおいて閲覧回数を取得する。

  - > weko-admin.models.AdminSettings.getから【Administration \> stas (統計情報)】で設定した統計情報の表示を読み取り、display\_statsがtrueの場合に統計情報を表示する。

> ファイル詳細画面を開く際に、weko\_records\_ui.view.get\_uriを呼び出してfile\_downloadedにファイルダウンロード回数を送り出し、ESに回数を登録する。  
> ファイルのプレビューが行われる際に、invenio\_file\_rest.views.ObjectResource.send\_objectを呼び出して、file\_previewedに再生回数を送り出し、ESに回数を登録する。

  - > invenio\_stats.views.QueryFileStatsCountにおいてダウンロード回数と再生回数を取得する。weko-admin.models.AdminSettings.getから【Administration \> stas (統計情報)】で設定した統計情報の表示を読み取り、display\_statsがtrueの場合に統計情報を表示する。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### 共有

  - > 目的・用途

本機能は、アイテムの詳細情報を共有する機能である。

  - > 利用方法

共有は、アイテム詳細画面の右端のShareエリアの共有ボタンを押下して行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 本機能に対応していた「AddThis」は2023年5月31日にサービスを終了しているため、共有機能を使用することは出来ない。

  - アイテム詳細画面での「共有」（Share）エリアに共有ボタンを表示する
    
      - 表示しておく共有ボタンをhtmlファイルに指定する
        
          - パス：  
            <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/templates/weko_records_ui/box/share.html#L25-L33>
        
          - 表示される共有ボタンは以下の通りである。また、共有アイコンをマウスホバーすると、共有サイト名を表示する
            
              - 「mendeley」
            
              - 「citeulike」(2019年サービス終了により表示されない)
            
              - 「twitter」
            
              - 「facebook」
            
              - 「print」
        
          - 「+」ボタンを設ける
            
              - 「+」ボタンをマウスホバーすると、共有サイト名一覧を表示する
            
              - 「+」ボタンを押すと、共有モデルを表示する

  - 共有ボタンを押すと、該当サイトに移動する

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > 対応しているモジュール：「weko\_records\_ui」

  - > 対応しているプラグイン：「AddThis」

<!-- end list -->

  - > 処理概要

> weko\_theme.static.js.addthis.addthis\_widgetにおいてAddThisのアイテムの共有を設定している。  
> <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-theme/weko_theme/static/js/addthis/addthis_widget.js>

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### エクスポート

  - > 目的・用途

本機能は、アイテム詳細画面から特定のアイテムの情報を設定されたスキーマ形式に出力する機能である。

  - > 利用方法

エクスポートは、アイテム詳細画面の右下にあるOAI-PMH, BIBTEX, JSONのボタンを押下することで、アイテムの情報がスキーマ形式に出力される。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

1\. OAI-PMHスキーマを管理

  - 【Administration \> アイテムタイプ管理 (Item Types) \> OAIスキーマ (OAI Schema)\> 作成画面】にOAI-PMHスキーマを設定できる  
    設定内容は以下の通りである
    
      - スキーマファイルをアップロードする。必須項目
        
          - DublinCore : 別紙の「oai\_dc」を参照。
        
          - JPCOAR：(<https://github.com/JPCOAR/schema/blob/master/1.0/jpcoar_scm.xsd>)  
            (<https://github.com/JPCOAR/schema/blob/master/2.0/jpcoar_scm.xsd>)
        
          - DDI : 別紙の「ddi\_2\_5\_1.zip」を参照。
    
      - ファイル名（File Name）。必須項目  
        アップロードされたスキーマファイルのファイル名を設定する
    
      - スキーマ名（Schema Name）。必須項目  
        OAI-PMH出力ができるため、以下のようなスキーマ名を設定する必要がある
        
          - DublinCoreスキーマ：「oai\_dc」
        
          - JPCOARスキーマ：「jpcoar\_1.0」
        
          - DDIスキーマ：「ddi」
    
      - ルート名（Root Name）。必須項目  
        OAI-PMH出力ができるため、以下のようなルート名を設定する必要がある
        
          - DublinCoreスキーマ：「dc」
        
          - JPCOARスキーマ：「jpcoar\_1.0」
        
          - DDIスキーマ：「codeBook」
    
      - ジップ名（Zip Name）  
        アップロードファイルのフォーマットはzipファイルの場合、必須項目になり、zipファイル名を入れる
    
      - スキーマロケーション（Schema Location）  
        スキーマの参照ロケーションを入れる
    
      - コメント（Comment）

2\. OAI-PMHスキーマをマッピング

  - 【Administration \>アイテムタイプ管理 ( Item Types) \>マッピング (Mapping)画面】：作成されたOAI-PMHスキーマにマッピングを実施
    
      - システムが付与する情報  
        「システムが付与したアイテムタイプ (親)」領域でWEKOでのシステム操作を介して作成されるデータをマッピング可能とする  
        対象データは、以下とする
        
          - 永続識別子（DOI）  
            https://schema.irdb.nii.ac.jp/ja/schema/17
        
          - 永続識別子（HDL）  
            <https://schema.irdb.nii.ac.jp/ja/schema/17>
        
          - 永続識別子（URI）  
            <https://schema.irdb.nii.ac.jp/ja/schema/17>
        
          - ファイル情報  
            <https://schema.irdb.nii.ac.jp/ja/schema/35>  
              
            updatedの日付のマッピングは、Getrecord、ListRecord、ListIdentifierのheaderにおいて、「datestamp=record.updated,」が使用されており、invenio\_records.api.get\_recordからDBのupdatedを取得している。  
              
            jpcoarスキーマガイドラインに記載されている以下の項目は不要となる
            
              - datacite:date dateType="Created"
            
              - datacite:date dateType="Updated"
    
      - アイテムタイプのメタデータ  
        「アイテムタイプ(親)」領域でアイテムタイプのメタデータをマッピング可能とする
        
          - DDI : 別紙「USER3-7\>DDIハーベスト規格ver2\_2019120」を参照。
        
          - [JPCOAR](https://support.irdb.nii.ac.jp/sites/default/files/2018-08/mapping_jpcoar_v1.0.1_1.pdf) (<https://support.irdb.nii.ac.jp/sites/default/files/2018-08/mapping_jpcoar_v1.0.1_1.pdf>)

3\. OAI-PMHのプロバイダ機能の有効・無効をインデックスごとに設定可能

  - 【Administration \> インデックスツリー管理 (Index Tree)\>ツリー編集 (Edit Tree)画面】での「ハーベスト公開 (Harvest Publish)」領域でインデックスごとにハーベスト公開制御を設定可能
    
      - 「公開する」（Open to public）チェックボックスにチェックを入れる場合、ハーベスト公開が有効になる  
        当該インデックス配下のアイテムについて、 OAI-PMHの出力を可能とする
        
          - OAI-PMHリクエスト（GetRecord）に対して、OAI-PMHの正常レスポンスを返す
        
          - アイテム詳細画面の「OAI-PMH」領域でのボタン押下に対して、OAI-PMHの正常レスポンスを返す
    
      - 「公開する」（Open to public）チェックボックスにチェックをはずす場合、ハーベスト公開が無効になる  
        当該インデックス配下のアイテムについて、 OAI-PMHの出力を不可とする
        
          - OAI-PMHリクエスト（GetRecord）に対して、OAI-PMHの「idDoesNotExist」エラーレスポンスを返す
        
          - アイテム詳細画面の「OAI-PMH」ボタン押下に対して、OAI-PMHの「idDoesNotExist」エラーレスポンスを返す
    
      - OAI-PMH機能の有効・無効の切り替え条件  
        リポジトリ管理者およびシステム管理者が切り替え可能。コミュニティ管理者は、コミュニティオーナーとなっている管理対象インデックスのみ切り替え可能。

<table>
<thead>
<tr class="header">
<th><strong>Verb</strong></th>
<th>WEKO3<br />
（oaiserver_identifyレコードなし)</th>
<th><strong>WEKO3<br />
</strong>（outPutSetting = f)</th>
<th><strong>WEKO3<br />
</strong>（outPutSetting = T)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>GetRecord</strong></td>
<td>出力なし<br />
（noRecordsMatch）</td>
<td><strong>出力</strong>なし<br />
（noRecordsMatch）</td>
<td><strong>出力</strong></td>
</tr>
<tr class="even">
<td><strong>ListRecords</strong></td>
<td>出力<strong>なし<br />
</strong>（noRecordsMatch）</td>
<td>出力なし（noRecordsMatch） ​</td>
<td><strong>出力</strong></td>
</tr>
<tr class="odd">
<td><strong>ListIdentifiers</strong></td>
<td>出力なし<br />
（noRecordsMatch）</td>
<td>出力なし<br />
（noRecordsMatch）</td>
<td>出力</td>
</tr>
<tr class="even">
<td><strong>ListMetadataFormats</strong></td>
<td><strong>出力</strong></td>
<td><strong>出力</strong></td>
<td><strong>出力</strong></td>
</tr>
<tr class="odd">
<td><strong>ListSets</strong></td>
<td>出力†</td>
<td>出力†</td>
<td><strong>出力</strong></td>
</tr>
<tr class="even">
<td><strong>Identify</strong></td>
<td><strong>出力</strong></td>
<td><strong>出力</strong></td>
<td><strong>出力</strong></td>
</tr>
</tbody>
</table>

※非公開状態にある**アイテム**は出力しない  
†ただし、非公開インデックス（非公開、OAI-PMH非公開）は出力しない

4\. アイテムのメタデータをOAI-PMH出力

  - 【前提条件】  
    「3.1. OAI-PMHスキーマを管理」及び「3.2. OAI-PMHスキーマをマッピング」が設定済み

  - 対応しているOAI-PMHスキーマ
    
      - JPCOAR
    
      - DDI
    
      - DublinCore

  - アイテム詳細画面での「OAI-PMH」領域にOAI-PMHスキーマボタンを押すと、該当フォーマットとしてアイテムのメタデータをOAI-PMH出力する
    
      - OAI-PMHの要求リクエストでエラーまたは例外状況が発生した場合に下記のOAI-PMHエラーを返せる  
        「3.6 エラーと例外状況 」(<https://www.nii.ac.jp/irp/archive/translation/oai-pmh2.0/OpenArchivesProtocol.htm#ErrorConditions>)  
        ※DDIマッピングがない場合のエラーコード修正は以下の様に設定されている。  
        <https://github.com/RCOSDP/weko/blob/0.9.22/modules/invenio-oaiserver/invenio_oaiserver/config.py#L207-L212>
    
      - 公開／非公開インデックスに属するアイテムのOAI-PMHの出力を制御する
        
          - アイテムが非公開の場合はdelete情報を出力する
        
          - アイテムが非公開インデックスにのみ属している場合は、アイテムが公開でも非公開でもdelete情報を出力する
        
          - アイテムが非公開インデックスと公開インデックスの両方に属している場合は、delete情報は出力しない（アイテムが公開の場合）
    
      - DOI有無での出力条件  
        インデックスの設定について、  
        ・「公開する」にチェックがついている、かつ「公開日が未来の日付」である  
        ・「ハーベスト公開」の「公開する」にチェックがついている  
        上記の条件を満たすとき、OAI-PMH出力は以下のように対応する。
        
          - アイテムにDOI付与がある場合  
            OAI-PMH出力しない  
            ListRecordsではrecordを出力しない  
            GetRecordではnoRecordsMatchを出力する
        
          - アイテムにDOI付与が無い場合  
            削除レコードを出力する  
            ListRecords、GetRecordでは\<header status="deleted"\>を出力する
    
      - 項目が複数登録される場合、DDIスキーマでの「titl」以外、繰り返し出力する
    
      - JPCOARのOAI-PMH出力にて、定められた統制語彙でない値が設定されている項目は対象外とする
        
          - 対象項目：以下の項目の属性「nameIdentifierScheme」の値
            
              - 作成者識別子（jpcoar:creator -\> jpcoar:nameIdentifier）
            
              - 寄与者識別子（jpcoar:contributor -\> jpcoar:nameIdentifier）
            
              - 権利者識別子（jpcoar:rightsHolder -\> jpcoar:nameIdentifier）
        
          - 定められた統制語彙は以下のリンクを参照する  
            <https://schema.irdb.nii.ac.jp/en/schema>
    
      - identifierTypeに関して、JPCOARのOAI-PMH出力では以下の通りに出力をする（※最大で3つ（URI、HDL、DOI）、最小で1つ（URIのみ）のidentifierが出力される）
        
          - URI（必ず存在する。https://FQDN/records/item\_id）：　"identifierType=URI" として出力する
        
          - HDLが存在する場合：　"identifierType=HDL" として出力する
        
          - DOIが存在する場合：　"identifierType=DOI" として出力する
    
      - DDIのOAI-PMH出力にて、親タグが言語ごとに繰返し出力できる
        
          - 対応している親タグ
            
              - 「stdyDscr\>citation」
            
              - 「stdyDscr\>stdyInfo」
            
              - 「stdyDscr\>method」
            
              - 「stdyDscr\>dataAccs」
            
              - 「stdyDscr\>othrStdyMat」
        
          - 「citation」親タグに対して出力を以下のように制限する
            
              - 「citation\>titlStmt\>titl」が繰り返し不可により、同一言語にtitlの値が複数定義される場合、最初に出るtitlを出力する
            
              - 「citation\>titlStmt\>titl」が必須項目により、titlの値が無い場合は取得する最初のtitlを設定する
            
              - 「citation\>rspStmt\>AuthEnty」にて「ja-kana」の言語を選択する場合、jaの扱いとして出力する
        
          - DDIスキーマにOAI-PMH出力構築  
            <https://ddialliance.org/sites/default/files/ddi-lite.html>

  - 以下のハーベスト出力条件に従って出力する
    
      - インデックスの公開／非公開、ハーベスト設定のON/OFFの設定は、アイテムが直接紐づいているインデックスとその上位のインデックスについても対象とする
    
      - 複数のインデックスに所属する場合、インデックスの公開が優先される。
    
      - 複数のインデックスに所属する場合、ハーベスト設定のOFFが優先される。

  - インデックス状態によるアイテム公開制御仕様：  
    別紙「ItemACL\_latest.xlsx」を参照。

  - アイテムの公開日について、以下の制御を行う
    
      - Administration \> ItemTypes \> Metadata でアイテムタイプの"公開日"の「Hide」オプションがON（非表示とする）の場合、アイテムの「公開日」はOAI-PMH出力しない
    
      - Admin \> ItemTypes \> Metadata でアイテムタイプの"公開日"の「Hide」オプションがOFF（表示する）の場合、アイテムの「公開日」をOAI-PMHに出力する

  - 公開日が未来日のアイテムに関しては以下の制御を行う
    
      - アイテムの公開日が未来日の場合
        
          - アイテムにDOI付与がある場合
            
              - OAI-PMH出力しない
            
              - ListRecordsではrecordを出力しない
            
              - GetRecordではidDoesNotExistを出力する
        
          - アイテムにDOI付与が無い場合
            
              - 削除レコードを出力する
            
              - ListRecords、GetRecordでは\<header status="deleted"\>を出力する
    
      - インデックスについて、以下の場合  
        　・「公開する」にチェックがついている、かつ「公開日が未来の日付」である  
        　・「ハーベスト公開」の「公開する」にチェックがついている
        
          - アイテムにDOI付与がある場合
            
              - OAI-PMH出力しない
            
              - ListRecordsではrecordを出力しない
            
              - GetRecordではidDoesNotExistを出力する
        
          - アイテムにDOI付与が無い場合
            
              - 削除レコードを出力する
            
              - ListRecords、GetRecordでは\<header status="deleted"\>を出力する

  - 親インデックスが非公開または公開日が未来の日付の場合のとき、非ログイン状態で以下の挙動をする
    
      - アイテム詳細画面やコンテンツファイルのURLに直接アクセスすると、ログイン画面に遷移する
    
      - OAI-PMHで\<header status="deleted"\>を出力する（DOIが付与されていない場合）
    
      - OAI-PMHのGetRecordでidDoesNotExistを出力する（DOIが付与されている場合）
    
      - ランキング表示で、当該インデックスのみに紐づいたアイテムは表示しない
    
      - 新着情報やインデックスのRSSで、当該インデックスのみに紐づいたアイテムは表示されない

5\. Sets

  - インデックス単位でのOAI-PMHによるSet提供ができる  
    当該Setには当該インデックスの下位のインデックスも含む

  - 【Administaration\>インデックスツリー編集 (Index Tree) \> Edit Tree画面】にて公開のインデックスを追加/更新/削除するとSetsの情報も自動的に反映される

  - 【Administration \> OAI-PMH \> Sets画面】でのSetsの設定が可能
    
      - Created: Sets 情報作成日時
    
      - Updated: Sets 情報更新日時
    
      - id: Sets 情報のID（システム設定)
    
      - Spec: インデックスパス ※パスの区切りは:(コロン)  
        例 1628576973067:1628576975817
    
      - Name: Sets 情報の名前(システムインデックス名)
    
      - Description: 概要
    
      - Search Pattern: 検索パターン ※パスの区切りは/(スラッシュ)  
        例 path:"1628576973067/1628576975817"

6\. Other Formats

  - アイテム詳細画面の「Other Formats」で以下の形式でアイテム情報を出力できる
    
      - > JSON
        
          - > アイテムのメタデータをJSON形式でエクスポートする。
        
          - > アイテム詳細画面のエクスポートエリアに表示されているJSONリンクを押下する。/records/\<item\_id\>/export/json
        
          - > 表示例は別紙「JSON出力例.txt」を参照。
        
          - > 設定
            
              - > <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/config.py#L198-L202>
            
              - > <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-records-rest/invenio_records_rest/serializers/__init__.py#L17>
        
          - > シリアライザ：
            
              - > <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-records-rest/invenio_records_rest/serializers/json.py#L70>
    
      - > BIBTEX
        
          - > アイテムのメタデータをBIBTEX形式でエクスポートする。
        
          - > アイテム詳細画面のエクスポートエリアに表示されているBIBTEXリンクを押下する。/records/\<item\_id\>/export/bibtex
        
          - > 表示例は別紙「BIBTEX出力例.txt」を参照。
        
          - > 設定
            
              - > <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/config.py#L203-L207>
            
              - > <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/templates/weko_records_ui/box/export.html>
        
          - > シリアライザ：
            
              - > <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-schema-ui/weko_schema_ui/serializers/WekoBibTexSerializer.py>

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko-schema-ui

  - > invenio-oaiserver

  - > invenio\_records

<!-- end list -->

  - > 処理概要

1\. 設定

  - プロバイダ不可の場合に対してのエラーコードを設定する  
    設定キー：OAISERVER\_CODE\_NO\_RECORDS\_MATCH  
    パス：  
    <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-oaiserver/invenio_oaiserver/config.py#L207>

  - プロバイダ不可の場合に対してのエラーメッセージを設定する  
    設定キー：OAISERVER\_MESSAGE\_NO\_RECORDS\_MATCH  
    パス：  
    <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-oaiserver/invenio_oaiserver/config.py#L210>

2\. 実装方法

  - OAI-PMHスキーマボタンを押すと、以下のフローを実施する

(1)「identifier」の値を元に、対象アイテムに対してプロバイダの有効・無効をチェックする

  - /oaiにアクセスすることで、invenio\_oaiserver.views.server.responseが呼び出され、リクエストのverbの値によってinvenio\_oaiserver.response.pyのが呼び出される。

  - verbの値によって呼び出されたでinvenio\_oaiserver.api.OaiIdentify.get\_allを呼び出す。そしてinvenio\_oaiserver.models.Identifyを呼び出して、「oaiserver\_identify」テーブルから「Administration＞OAI-PMH＞Identify」に設定したデータを取得して「Identify」の値とする。

  - 「Identify」の値を元にプロバイダ機能が無効の場合にinvenio\_oaiserver.response.get\_error\_code\_msgを呼び出して使用する。  
    なおverbの値がgetreccordの場合は、invenio\_oaiserver.response.errorを呼び出して使用する。

  - 以下のケースに当たれば、プロバイダ機能が無効とし、エラーレスポンスを返す
    
      - ケース
        
          - アイテムがプロバイダ機能の無効と設定しているインデックスに属する
        
          - アイテムが非公開と設定しているインデックスに属する
        
          - アイテムが非公開と設定する
    
      - エラー内容
        
          - エラーコード：コンフィグに設定している「OAISERVER\_CODE\_NO\_RECORDS\_MATCH」キー
        
          - > エラーメッセージ：コンフィグに設定している「OAISERVER\_MESSAGE\_NO\_RECORDS\_MATCH 」キー
        
          - > getrecordのエラーコード：errorに渡す引数  
            > 「idDoesNotExist」
        
          - > getrecordのエラーメッセージ：errorに渡す引数  
            > 「No matching identifier」

  - プロバイダ機能が有効になる場合、(2)に進む

(2)システムプロパティーを処理する  
(2.1)ファイル情報のプロパティー

  - invenio\_oaiserver.response.combine\_record\_file\_urlsを使用する。

  - ファイルのマッピングがメタデータレコードに含まれる場合、ファイルのURLを生成し、「File」プロパティーとし情報を返す

(2.2)識別子のプロパティー

  - invenio\_oaiserver.response. get\_identifierを使用する。

  - DOI、またはHDLのURLがメタデータレコードに含まれる場合、「system\_identifier\_doi」プロパティーとし情報を返す

  - DOI、またはHDLのURLがメタデータレコードに含まれない場合、レコードIDを元に、識別子の値を生成し、「system\_identifier\_doi」プロパティーとし情報を返す

(3)「\_init\_」メソッドで以下の情報を取得し、メタデータレコードにマッピングデータを組み込む

  - weko\_schema\_ui.schema.SchemaTree.\_init\_を使用する。

  - メタデータレコード

  - マッピングデータ

  - 非表示の属性

  - スキーマオブジェクト

(4)weko\_schema\_ui.schema.SchemaTree.create\_xmlで以下の処理を実施する  
(4.1)メタデータレコードでの各データを処理する

  - 非表示の属性に属するデータ、または値が空白のデータが対象外とする

  - 「get\_mapping\_value」関数でメタデータレコードをXML構成に変換する

(4.2)対象OAI-PMHスキーマがDDIスキーマであるかどうか、チェックする

  - 対象OAI-PMHスキーマがDDIスキーマの場合、以下の処理を実施する
    
      - 階層にある子タグ（node）をマージする
    
      - 繰り返し用の親タグを指定する。現在対応している親タグ（5件）は以下の通りである
        
          - 「stdyDscr\>citation」
        
          - 「stdyDscr\>stdyInfo」
        
          - 「stdyDscr\>method」
        
          - 「stdyDscr\>dataAccs」
        
          - 「stdyDscr\>othrStdyMat」

  - 対象OAI-PMHスキーマがDDIスキーマ以外の場合、(4.3)に進む

(4.3)メタデータレコードをOAI-PMHスキーマでの該当ノードに指定する  
(4.4)（4.3）での結果をOAI-PMHスキーマの構築にビルドし、該当スキーマのOAI-PMH出力を返す

  - 対象OAI-PMHスキーマがDDIスキーマの場合、追加で処理を実施する
    
      - (4.2)に指定された親タグを言語ごとに分ける
    
      - 「citation」親タグに対して以下のように制限する
        
          - 「citation\>titlStmt\>titl」が繰り返し不可により、同一言語にtitlの値が複数定義される場合、最初に出るtitlを出力する
        
          - 「citation\>titlStmt\>titl」が必須項目により、titlの値が無い場合は取得する最初のtitlを設定する
        
          - 「citation\>rspStmt\>AuthEnty」にて「ja-kana」の言語を選択する場合、jaの扱いとして出力する

  - １つのインデックスに対して１つのクエリを作成しているが、クエリの数(インデックスの件数が多い)が1024を超えている場合は、クエリのインデックスリスト部分を分割する

Elasticsearch の利用

  - scroll APIを利用している。 ESの index.max\_result\_window 以上の結果を取得することができる。
    
      - <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-oaiserver/invenio_oaiserver/query.py#L192>

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### Google Scholar メタデータ出力

  - > 目的・用途

<!-- end list -->

  - > 本機能は、アイテム詳細画面から特定のアイテム情報をGoogle Scholar向けにGoogle Scholar meta tagを付与した状態でアイテムメタデータを出力する機能である利用方法

アイテムリストから特定のアイテムを選択することで、アイテム詳細画面を構成する要素、構造化データのheaderのタグの一つとして、Google Scholar meta tagが付与されたアイテムメタデータが表示される。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - Google Scholar meta tagを利用することで、論文検索に特化したGoogle Scholarにメタデータを登録することが出来る。

  - Google Scholar の実装にはGoogle Scholar meta tagが必要である。meta tag はOAI-PMHのXML出力と同じ機能を用いて出力される。

  - そのため、OAI-PMH出力をしなければ、Google Scholar meta tagは出力されない。OAI-PMH出力時に、メタデータをXMLに出力すると、該当の情報もGoogle Scholarのmeta tagに出力される。  
    OAI-PMH出力時に、メタデータをXMLに出力すると、該当の情報もGoogle Scholarのmeta tagに出力される。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_records\_ui

<!-- end list -->

  - > 処理概要

1\. 設定

> jpcoarのマッピングとGoogle Scholar meta tagとの対応をtarget\_mapに設定する。  
> <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/utils.py#L1204-L1213>

  - > 設定タグ：  
    > target\_map = {

> 'dc:title': 'citation\_title',
> 
> 'jpcoar:creatorName': 'citation\_author',
> 
> 'dc:publisher': 'citation\_publisher',
> 
> 'jpcoar:subject': 'citation\_keywords',
> 
> 'jpcoar:sourceTitle': 'citation\_journal\_title',
> 
> 'jpcoar:volume': 'citation\_volume',
> 
> 'jpcoar:issue': 'citation\_issue',
> 
> 'jpcoar:pageStart': 'citation\_firstpage',
> 
> 'jpcoar:pageEnd': 'citation\_lastpage', }
> 
> Google Scholar出力をすることのできるリソースタイプ

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/config.py#L526-L574>

  - > 設定キー：「WEKO\_RECORDS\_UI\_GOOGLE\_SCHOLAR\_OUTPUT\_RESOURCE\_TYPE」

2\. 実装方法

> アイテムリストから特定のアイテムを選択し、アイテム詳細画面を表示する際に、get\_google\_scholar\_metaを使用して、画面を構成する要素として、Goggle Scholar meta tagをheaderのテンプレートに埋め込む。

  - > weko\_records\_ui.views.default\_view\_methodからweko\_records\_ui.utils.get\_google\_scholar\_metaを呼び出して使用する。

  - > アイテムの識別子としてoaiが含まれているかを確認する。
    
      - > OAI-PMH出力で使用されるjpcoarマッピングと置き換える形でGoogle Scholar meta tagを付与するため、OAI-PMH出力が出来る状態でなければGoogle Scholar meta tagを出力することは出来ない。
        
          - > 【前提条件】  
            > USER3-7「1. OAI-PMHスキーマを管理」及び「2. OAI-PMHスキーマをマッピング」が設定済み

  - > アイテムのリソースタイプがGoogle Scholar出力することができるか確認する。

  - > メタデータに含まれるjpcoarタグの種類に対応するGoogle Scholar meta tagをresリストに追加する。

> resリストをgoogle\_scholar\_metaで受け取り、templating.render\_templateを呼び出してアイテムメタデータを作成する。

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### Google Dataset メタデータ出力

  - > 目的・用途

本機能は、Google Dataset Search向けのメタデータを出力する機能である。

  - > 利用方法

  - > アイテムリストから特定のアイテムを選択することで、アイテム詳細画面を構成する要素、構造化データのheaderのタグの一つとして、Google Dataset meta tagが付与されたアイテムメタデータが表示される。利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - Google Dataset meta tagを利用することで、データ検索に特化したGoogle Dataset Searchにメタデータ を登録することが出来る。
    
      - > meta tagはSchema.orgを利用する。  
        > <https://schema.org/>

  - \- 当該アイテムがOAIPMH出力されること
    
      - > Google Dataset の実装にはGoogle Dataset meta tagが必要である。meta tag はOAI-PMHのXML出力と同じ機能を用いて出力される。
        
          - > そのため、OAI-PMH出力をしなければ、Google Scholar meta tagは出力されない。OAI-PMH出力時に、メタデータをXMLに出力すると、該当の情報もGoogle Scholarのmeta tagに出力される。  
            > OAI-PMH出力時に、メタデータをXMLに出力すると、該当の情報もGoogle Scholarのmeta tagに出力される。

  - \- 当該アイテムのアイテムタイプがJPCOARスキーマにマッピングされていること

  - \- dc:typeがdatasetであること

  - \- dc:titleが入力されていること

  - \- datacite:descriptionが50字以上であること

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_records\_ui

<!-- end list -->

  - > 処理概要

1\. 設定

> Google Dataaset出力をすることのできるリソースタイプ

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/config.py#L577>

  - > 設定キー：  
    > 「WEKO\_RECORDS\_UI\_GOOGLE\_DATASET\_RESOURCE\_TYPE = \[“dataset”\]」

> Google Dataset descriptionの最小文字数

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/config.py#L580>

  - > 設定キー：  
    > 「WEKO\_RECORDS\_UI\_GOOGLE\_DATASET\_DESCRIPTION\_MIN = 50」

> Google Dataset descriptionの最大文字数

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/config.py#L582>

  - > 設定キー：  
    > 「WEKO\_RECORDS\_UI\_GOOGLE\_DATASET\_DESCRIPTION\_MAX = 5000」

> 「WEKO\_RECORDS\_UI\_GOOGLE\_DATASET\_DISTRIBUTION\_BUNDLE」

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/config.py#L585-L592>

> jpcoarマッピングとGoogle Dataset meta tagとの対応:  
> 別紙「jpcoarスキーマ、schema.org対応表」参照。

2\. 実装方法

> アイテムリストから特定のアイテムを選択し、アイテム詳細画面を表示する際に、get\_google\_dataset\_metaを使用して、画面を構成する要素として、Google Dataset meta tagをheaderのテンプレートに埋め込む。

  - > weko\_records\_ui.views.default\_view\_methodからweko\_records\_ui.utils.get\_google\_dataset\_metaを呼び出して使用する。

  - > アイテムの識別子としてoaiが含まれているかを確認する。
    
      - > OAI-PMH出力で使用されるjpcoarマッピングと置き換える形でGoogle Dataset meta tagを付与するため、OAI-PMH出力が出来る状態でなければGoogle Dateset meta tagを出力することは出来ない。
        
          - > 【前提条件】  
            > USER3-7「1. OAI-PMHスキーマを管理」及び「2. OAI-PMHスキーマをマッピング」が設定済み

  - > リソースタイプがdatasetか確認する。

  - > Google Datasetにおけるデータの説明部分であるdescriptionが50字以上か確認する。5000字よりも多い場合、5000字以降は切り捨てて登録する。

  - > メタデータに含まれるjpcoarタグの種類に対応するGoogle Dataset meta tagをres\_dataリストに追加する。

> resリストをgoogle\_dataset\_metaで受け取り、templating.render\_templateを呼び出してアイテムメタデータを作成する。

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table># アクティビティ一覧表示

## 目的・用途

アクティビティとは、ワークフローを用いてアイテムに対する活動を管理するインスタンスである。

![](media/media/image1.png)

アクティビティ一覧はアイテムが登録中／編集中／終了のいずれであるかを一覧化して管理している機能である。

## 利用方法

WEKO3へログイン後、\[WorkFlow\]タブを押下することで、アクティビティ一覧が表示される。

アイテムを登録するには、アクティビティ一覧の\[New Activity\]ボタンを押下することで、ワークフロー一覧が表示される。

## 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

## 機能内容

### 1. アクティビティ一覧を表示する

  - TOPページから「ワークフロー」タブを押すと、アクティビティ一覧が状態別に表示される
    
      - デフォルト：「Todo」タブ
    
      - アクティビティに対して、以下の情報を表示する

<table>
<thead>
<tr class="header">
<th>#</th>
<th>表示項目</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>No.</td>
<td>　</td>
</tr>
<tr class="even">
<td>2</td>
<td>作成日（Created）</td>
<td><p>アクティビティの作成日付<br />
フォーマット：YYYY-MM-DD</p>
<p>デフォルト値としてサーバ日付を設定する（サーバ日付は/api/admin/get_server_dateから取得する）</p></td>
</tr>
<tr class="odd">
<td>3</td>
<td>更新日（Updated）</td>
<td>アクティビティの更新日付<br />
フォーマット：YYYY-MM-DD</td>
</tr>
<tr class="even">
<td>4</td>
<td>Activity</td>
<td>アクティビティID<br />
リンクを押すと、ワークフローの該当アクション画面に遷移する</td>
</tr>
<tr class="odd">
<td>5</td>
<td>アイテム（Item）</td>
<td>アイテムのタイトル※1</td>
</tr>
<tr class="even">
<td>6</td>
<td>ワークフロー（WorkFlow）</td>
<td>ワークフロー名</td>
</tr>
<tr class="odd">
<td>7</td>
<td>アクション（Action）</td>
<td>アクティビティの実行中アクション</td>
</tr>
<tr class="even">
<td>8</td>
<td>ステータス（Status）</td>
<td>アクティビティのステータス<br />
「作業中」(Doing)：アクティビティが登録中/編集中/承認待ち<br />
「作業済」(Done)：アクティビティが終了<br />
「中止」(Canceled)：アクティビティが強制終了</td>
</tr>
<tr class="odd">
<td>9</td>
<td>User</td>
<td>アイテム編集中はアクティビティを作成したユーザーのメールアドレス、Approval後は承認者のメールアドレスを表示する</td>
</tr>
</tbody>
</table>

  - 各タブの概要
    
      - 「ToDo」タブ
        
          - 登録者または、処理権限を有するユーザーに対して、登録中/編集中のアクティビティを表示する
        
          - 承認者の場合、承認待ちのアクティビティも表示する
    
      - 「Wait」タブ
        
          - 登録者または、処理権限を有するユーザーに対して、承認者の承認待ちのアクティビティを表示する
    
      - 「すべて（All）」タブ
        
          - 登録者または、処理権限を有するユーザーに対して、登録中/編集中／完了のアクティビティを表示する（承認待ちのものは表示しない）
        
          - 承認者の場合、承認待ちのアクティビティも表示する
        
          - アクティビティ一覧のダウンロード、クリアができる。

  - 
  - 各タブに表示される内容

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>ToDo</th>
<th>Wait</th>
<th>All</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>システム管理者</td>
<td>自分で作成したアイテムの承認待ちのもの<br />
自分が入力途中のもの<br />
リポジトリ管理者が作成したアイテムの承認待ちのもの<br />
コミュニティ管理者が作成したアイテムの承認待ちのもの<br />
登録者が作成したアイテムの承認待ちのもの<br />
代理登録が設定されたアクティビティは表示されない</td>
<td>　</td>
<td>自分で作成したアイテムの承認待ちのもの<br />
自分が入力途中のもの<br />
自分が入力をキャンセルしたアクティビティ<br />
リポジトリ管理者が作成したアイテムの承認待ちのもの<br />
リポジトリ管理者の入力途中のもの<br />
リポジトリ管理者が入力をキャンセルしたアクティビティ<br />
コミュニティ管理者が作成したアイテムの承認待ちのもの<br />
コミュニティ管理者の入力途中のもの<br />
コミュニティ管理者が入力をキャンセルしたアクティビティ<br />
登録者が作成したアイテムの承認待ちのもの<br />
登録者の入力途中のもの<br />
登録者が入力をキャンセルしたアクティビティ<br />
他のシステム管理者が入力途中のアクティビティ</td>
</tr>
<tr class="even">
<td>リポジトリ管理者</td>
<td>自分で作成したアイテムの承認待ちのもの<br />
自分が入力途中のもの<br />
システム管理者が作成したアイテムの承認待ちのもの<br />
コミュニティ管理者の承認待ちのもの<br />
登録者が作成したアイテムの承認待ちのもの<br />
代理登録が設定されたアクティビティは表示されない</td>
<td>　</td>
<td>自分で作成したアイテムの承認待ちのもの<br />
自分が入力途中のもの<br />
自分が入力をキャンセルしたアクティビティ<br />
システム管理者が作成したアイテムの承認待ちのもの<br />
システム管理者の入力途中のもの<br />
システム管理者が入力をキャンセルしたアクティビティ<br />
コミュニティ管理者が作成したアイテムの承認待ちのもの<br />
コミュニティ管理者の入力途中のもの<br />
コミュニティ管理者が入力をキャンセルしたアクティビティ<br />
登録者が作成したアイテムの承認待ちのもの<br />
登録者の入力途中のもの<br />
登録者が入力をキャンセルしたアクティビティ<br />
他のリポジトリ管理者が入力途中のアクティビティ</td>
</tr>
<tr class="odd">
<td>コミュニティ管理者</td>
<td>自分が入力途中のもの<br />
代理登録が設定されたアクティビティは表示されない<br />
自分で作成したアイテムの承認待ちのものは表示されない</td>
<td>　</td>
<td>自分で作成したアイテムの承認待ちのもの<br />
自分が入力途中のもの<br />
自分が入力をキャンセルしたアクティビティ<br />
他のコミュニティ管理者が入力途中のアクティビティ</td>
</tr>
<tr class="even">
<td>登録者</td>
<td><p>自分が入力途中のもの<br />
代理登録が設定されたアクティビティは表示されない</p>
<p>※</p></td>
<td>自分で作成したアイテムの承認待ちのものを表示する</td>
<td><p>自分が入力途中のもの<br />
自分が入力をキャンセルしたアクティビティ</p>
<p>※</p></td>
</tr>
</tbody>
</table>

※何らかのフローでAction Userに指定されており、実行中アクションがそれであるワークフローはすべて表示される

  - 代理登録機能
    
      - アクティビティのItem RegistrationアクションにあるContributorエリアに"Other User"としてユーザ名またはEmailを設定しておけば、設定されたユーザは、該当アイテムに「編集」ボタンが表示されて、アイテムの編集をすることが可能

  - ゲストユーザーがアクティビティ一覧のURLを直接入力してアクセスしようとした際はログイン画面に移動する

  - ![](media/media/image2.png)![](media/media/image2.png)![](media/media/image2.png)![](media/media/image2.png)![](media/media/image2.png)承認アクションが複数ある場合の挙動は以下の通り

  - 
### 2. アクティビティ一覧にフィルタリングとページングできる

  - フィルタリング
    
      - フィルタリングがアクティビティ一覧の上部に表示される
        
          - デフォルトの表示項目：登録日（Created）  
            登録日での開始日：1年前の当日
        
          - 「フィルターを追加▼」をクリックすると、以下の追加可能なフィルタリストを表示し、フィルタ名をクリックすると当該フィルタの入力エリアを追加する
            
              - ワークフロー
            
              - User
            
              - アイテム
            
              - ステータス  
                選択肢：作業中、作業済、中止
        
          - 各フィルタ項目の入力形式／検索方式／初期値
            
              - 登録日（日付／範囲指定／(自)1年前の当日(至)入力なし ）常設とする
            
              - アイテム（テキスト／前方一致／入力なし）。複数可。
            
              - ワークフロー（テキスト／前方一致／入力なし）。複数可。
            
              - ステータス（チェックボックス／完全一致／選択なし）。１つのみ。
            
              - User（テキスト／完全一致／入力なし）。複数可。
        
          - 追加されたフィルタの入力エリアに\[×\]ボタンを押すと、該当フィルターの入力エリアを削除する
        
          - 設定したフィルタは\[Apply(適用)\]ボタンを押下することで一覧に適用される
        
          - 表示されている条件についてAND検索する
        
          - 適用されたフィルタの内容は各タブ（ToDo, Wait, All）間で引き継がれる

  - ページング
    
      - ページ当たりの表示数（Display Number）をプルダウンより選択できる
    
      - 選択可能な件数は「20, 50, 75, 100」でデフォルトは「20」とする
    
      - ページングナビゲーションを操作することで、表示内容が切り替わる
    
      - 表示数は、ToDo、Wait、Allタブそれぞれ個別に適用される

  - アクティビティとアイテムとの関連は以下の通り。
    
      - アイテムを新規登録：　アクティビティXが作られる
    
      - アイテムAとして登録してワークフロー終了：　アイテムAはアクティビティXに紐づいている
    
      - アイテムAを編集する：　アクティビティYが作られ、編集中のアイテムAはアクティビティYに紐づく
    
      - アイテムAの編集完了（バージョンを上げない）：　編集後のアイテムAはアクティビティYに紐づいている。編集前のアイテムAはアクティビティXに紐づいたまま
    
      - 再度アイテムAを編集する：　アクティビティZが作られ、編集中のアイテムAはアクティビティZに紐づく
    
      - アイテムAの編集完了（バージョンを上げる）：　アイテムA(ver2)がアクティビティZに紐づく。アイテムA(ver1)はアクティビティYに紐づいたまま

### 3. TSVファイルダウンロード**

> **アク**ティビティをDBから物理削除する前のバックアップとして、TSVファイルにアクティビティログをダウンロードする。
> 
> 【前**提条件】**

  - > **利用**者のロールが、システム管理者またはリポジトリ管理者であること。

  - > アクティビティ一覧で、「すべて（All）」タブの内容を表示していること。

  - > 表示中のフィルタリング条件で、アクティビティが１件以上表示されていること。

  - > insta**nce.cfg(invenio.cfg) で、DELETE\_ACTIVITY\_LOG\_ENABLE = Trueであること。**

> **［**ダウンロード（Download）］ボタンを押すと、表示中のフィルタリング条件に従った内容のTSVファイルがダウンロードされる。
> 
> TS**Vファイルに書き込まれる件数は、以下の定数によって制限されている。**

  - > **パス：**modules**/weko-workflow/weko\_workflow/config.py**
    
      - > **設定キー：WEKO\_WORKFLOW\_ACTIVITYLOG\_BULK\_MAX**

> 制限**より多い件数のアクティビティログをダウンロードするときは、workflow\_activityテーブルのid降順で制限まで取得する。**

**4. アクティビティ削除**

> **アク**ティビティを、表示中の全件または１件物理削除する。
> 
> 【前**提条件】**

  - > **利用**者のロールが、システム管理者またはリポジトリ管理者であること。

  - > アクティビティ一覧で、「すべて（All）」タブの内容を表示していること。

  - > 表示中のフィルタリング条件で、アクティビティが１件以上表示されていること。

  - > insta**nce.cfg(invenio.cfg) で、DELETE\_ACTIVITY\_LOG\_ENABLE = Trueであること。**

> **［**ダウンロード（Download）］ボタンの隣に表示されている［クリア（Clear）］ボタンを押すと、表示中のフィルタリング条件に従ったアクティビティが全件物理削除される。
> 
> アクティビティ一覧の各行に表示されている［クリア（Clear）］ボタンを押すと、その行のアクティビティが物理削除される。
> 
> 削除時、確認ダイアログを表示することで確認を行う。
> 
> 実行中のアクティビティを削除する場合は、アクティビティを強制終了する。
> 
> 削除すると同時に削除対象のアクティビティのTSVファイルがダウンロードされる。
> 
> 全件**削除時、削除件数は以下の定数によって制限されている。**

  - > **パス：modules/weko-workflow/weko\_workflow/config.py**
    
      - > **設定キー：WEKO\_WORKFLOW\_ACTIVITYLOG\_BULK\_MAX**

> **制限より多い件数のアクティビティを削除するときは、workflow\_activityテーブルのid降順で制限に達するまで削除する。**

  - > 関連モジュール

<!-- end list -->

  - > weko\_workflow

<!-- end list -->

  - > 処理概要

1\. 設定

> アクティビティの各タブを定義する（開発に使用している）

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-workflow/weko_workflow/config.py#L278-L182>

  - > 設定キー及び設定値：

> WEKO\_WORKFLOW\_TODO\_TAB = 'todo'
> 
> WEKO\_WORKFLOW\_WAIT\_TAB = 'wait'
> 
> WEKO\_WORKFLOW\_ALL\_TAB = 'all'

2\. 実装方法

> 対応しているモジュール：weko\_workflow
> 
> アクティビティ一覧

  - > ログインしているユーザーの権限に応じてデータを「get\_activity\_list」メソッドでデータベースから取得する
    
      - > 「Todo」タブに対して
        
          - > 管理者の権限には、以下の条件でデータを取得する

> 【条件】  
> ステータス：作業中、承認待ちではない

  - > フローに設定されている承認者には、追加で以下の条件でデータを取得する

> 【条件】  
> ステータス：作業中、承認待ち  
> アクティビティの承認者

  - > 他の権限には、以下の条件でデータを取得する

> 【条件】  
> ステータス：作業中、承認待ちではない  
> アクティビティの作成者、または代理者

  - > 「Wait」タブに対して
    
      - > 該当承認者には、以下の条件でデータを取得する

> ステータス：作業中、承認待ち

  - > 取得されたデータをUIに以下のテンプレートで表示する

> テンプレート： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-workflow/weko_workflow/templates/weko_workflow/activity_list.html>
> 
> デフォルトの表示数：20  
> ページ：1
> 
> フィルタリング

  - > アクティビティ一覧での「適用」ボタンを押すと、UIに入力されているフィルタリングの情報を検索条件とし、満たすデータを「filter\_conditions」メソッドでデータベースから取得する  
    > フィルタリングの対象：「createdfrom」、「createdto」、「workflow」、「user」、「item」、「status」

  - > フィルタリングされたデータをUIに選択されている表示数で表示する

> ページング

  - > データをデータベースから取得する時、表示数を元に、表示のページを取得されたアクティビティ一の総数で数える

> TSVファイルダウンロード

  - > views.py::download\_activitylog()メソッド

> アクティビティ削除

  - > views.py::clear\_activitylog()メソッド

【補足】

  - > バージョンを「上げる/上げない」それぞれのアクティビティの挙動
    
    1.  > アイテムバージョンを上げないときにはアクティビティはver1に紐づく
    
    2.  > 編集終了後にver2になったときにはアクティビティはver2に紐づく

  - > アクティビティが生成されるタイミングは、以下の時点
    
    1.  > アクティビティの作成画面（workflow/activity/new）に［新規］（New）ボタンを押す時点
    
    2.  > アイテム詳細画面に［編集］（Edit）ボタンを押す時点

  - > アイテム編集時、バージョンを変えない場合はアクティビティが増えていく

  - > ワークフロー一覧のユーザはユーザメールアドレスが表示される

  - > ワークフロー一覧のwaitに表示されるものは承認待ちの状態。  
    > 処理（承認）できる権限は、システム管理者、リポジトリ管理者、該当のコミュニティ管理者、または【Administration \> ワークフロー管理（WorkFlow） \> フロー（Flow List）画面】の該当のフローにて、「Approval」に指定されているアクションロール、アクションユーザ

  - > アクティビティが終了とするとき、アクティビティのアクションが「End」に移動、「End」アクションのステータスが「作業済」となる。

  - > アイテム編集時、アイテムバージョンを上げた場合、アイテムを新規レコードとして作成し、アイテムの情報を保存する

  - > 過去のアイテムが、どのアクティビティに紐づいていたのかの関係は画面上確認ができない。  
    > 各アイテムバージョンの情報及び、アクティビティの情報は【Administration \> レコード管理（Records） \> 永続識別子（Persistent Identifier）】画面で管理されている。

  - > アクティビティが生成されると新規UUIDへ紐づけを行う

  - > アイテム削除したアクティビティもAllタブには残る。アクティビティのリンクを押下すると、エラー画面が表示される。

> アイテムメタデータのエスケープ処理は以下の通り。インデックス名や著者名に対しても同様に処理する

  - > メタデータ保存時
    
      - > メタデータをJSON形式で保存。メタデータの文字で、JSON形式の文字の同じと文字がある場合、JSONに「￥"」に変換して保存する。

  - > メタデータの出力時
    
      - > OAI-PMH出力  
        > DBに保存しているメタデータから、pythonでOAI-PMH出力される。  
        > python処理でJSONからの「￥"」文字を「"」に変換して出力するため、OAI-PMH出力時にメタデータと同じように表示される
    
      - > NFKD正規化を行う。
    
      - > 一括エクスポート、JSON出力  
        > エクスポートファイルの形式によって、特殊文字がエスケープされる。  
        > 一括エクスポートファイルの形式は「.tsv」であり、「"」を「""」文字に変換して出力する。  
        > JSON出力ファイルの形式は「.json」であり、出力時の処理は上記のDB保存の処理と同様。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>

### ワークフロー一覧表示

  - > 目的・用途

ワークフロー一覧はアイテムを登録するためにワークフローを選択する（アクティビティを新規作成する）機能である。

  - > 利用方法

ワークフロー一覧で、登録したいアイテムのワークフローの行にある\[新規（New）\]ボタンを押下することで、アイテム登録のワークフローが起動される。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

> 【アクティビティ一覧画面】から\[New Activity\]ボタンを押すと、【ワークフロー一覧画面】に移動する

  - 以下のようなワークフロー情報を表示する

| \# | 表示項目               | 説明       |
| -- | ------------------ | -------- |
| 1  | No.                |          |
| 2  | ワークフロー（WorkFlow）   | ワークフロー名  |
| 3  | アイテムタイプ（Item Type） | アイテムタイプ名 |
| 4  | フロー（Flow）          | フロー名     |
| 5  | ［新規］（New）ボタン       |          |

> ワークフロー一覧から、［新規］（New）ボタンを押すと、該当アクティビティを新規作成する

  - > ワークフロー一覧画面及びアクティビティへのアクセス制限がかけられる
    
      - アクセス権限のないユーザーは\[WorkFlow\]タブが表示されず、画面上の操作によってはワークフロー一覧画面に到達できないが、URLを用いて直接画面に移動しようとした場合には以下のようにしてアクセスを拒否する。
    
      - 同一ブラウザを使っての複数アクティビティの実行を制限する(v1.0.7追加)。

      - 同一アクティビティを複数ユーザが開けないようロックする（/workflow/activity/lock/<ActivityID>）。

  - > ゲストユーザーに対してログイン画面に移動する

  - > 権限がないユーザーに対して「権限が必要です」とのメッセージを表示する

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_workflow

<!-- end list -->

  - > 処理概要

> ワークフロー一覧

  - > \[New Activity\]ボタンを押すと、ワークフロー一覧の情報をデータベースから「new\_activity」メソッドで取得する。各ワークフローの情報は、WorkFlowクラスで扱われる。
    
      - > テーブル名：workflow\_workflow、workflow\_flow\_define、item\_type、files\_location
    
      - > 取得情報：

> ・flows\_id
> 
> ・flows\_name
> 
> ・itemtype\_id
> 
> ・itemtype
> 
> ・index\_tree\_id
> 
> ・flow\_id
> 
> ・flow\_define
> 
> ・is\_deleted
> 
> ・open\_restricted
> 
> ・location\_id
> 
> ・location
> 
> ・is\_gakuninrdm

  - > これらのうち、表示に使用するのは以下である。

> ・flows\_name
> 
> ・itemtype
> 
> ・flow\_define

  - > 取得されたワークフロー一覧の情報を以下のテンプレートで表示する
    
      - > <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-workflow/weko_workflow/templates/weko_workflow/workflow_list.html>

> ワークフローのactivity\_idの採番ロジックは以下の通り。  
> 「A-YYYYMMDD-nnnnn」の形式で生成される。（nnnnn=00001 を初期値としてアクティビティを生成する度にカウントアップする）
> 
> def get\_new\_activity\_id(self):
> 
> """Get new an activity ID.
> 
> :return: activity ID.
> 
> """
> 
> number = 1
> 
> try:
> 
> \# Table lock for calculate new activity id
> 
> if db.get\_engine().driver\!='pysqlite':
> 
> db.session.execute(
> 
> 'LOCK TABLE ' + ActivityCount.\_\_tablename\_\_ + ' IN EXCLUSIVE MODE')
> 
> \# Calculate activity\_id based on id
> 
> utc\_now = datetime.utcnow()
> 
> current\_date = utc\_now.strftime("%Y-%m-%d")
> 
> today\_count = ActivityCount.query.filter\_by(date=current\_date).one\_or\_none()
> 
> \# Cannot use '.with\_for\_update()'. FOR UPDATE is not allowed
> 
> \# with aggregate functions
> 
> if today\_count:
> 
> \# Calculate aid
> 
> number = today\_count.activity\_count + 1
> 
> if number \> current\_app.config\['WEKO\_WORKFLOW\_MAX\_ACTIVITY\_ID'\]:
> 
> raise IndexError('The number is out of range \\
> 
> (maximum is {}, current is {}'.format(current\_app.config\['WEKO\_WORKFLOW\_MAX\_ACTIVITY\_ID'\],number))
> 
> today\_count.activity\_count = number
> 
> else:
> 
> \# The default activity Id of the current day
> 
> \_activty\_count = ActivityCount(date=current\_date, activity\_count=number)
> 
> db.session.add(\_activty\_count)
> 
> prev\_counts = ActivityCount.query.filter(ActivityCount.date\<current\_date).all()
> 
> if prev\_counts:
> 
> for prev\_count in prev\_counts:
> 
> db.session.delete(prev\_count)
> 
> except SQLAlchemyError as ex:
> 
> raise ex
> 
> except IndexError as ex:
> 
> raise ex
> 
> \# Activity Id's format
> 
> activity\_id\_format = current\_app.\\
> 
> config\['WEKO\_WORKFLOW\_ACTIVITY\_ID\_FORMAT'\]
> 
> \# A-YYYYMMDD-NNNNN (NNNNN starts from 00001)
> 
> date\_str = utc\_now.strftime("%Y%m%d")
> 
> \# Define activity Id of day
> 
> return activity\_id\_format.format(
> 
> date\_str,
> 
> '{inc:05d}'.format(inc=number))

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>
### ワークフロー

  - > 目的・用途

フローは、アイテムの登録処理（アクション）の流れである

ワークフローは、フローとアイテムタイプの組み合わせである

  - > 利用方法

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

フローとワークフローの管理については、管理機能の[ADMIN-7-1: ワークフロー管理](\\l)を参照。

  - > 各アクションにあるボタンの動作は以下の通り。詳細は各アクションを参照

| **アクション**                     | **ボタン(日)** | **ボタン(英)** | **動作**           |
| ----------------------------- | ---------- | ---------- | ---------------- |
| OA Policy Confirmation（現在非対応） | 保存         | Save       | 画面の入力情報を保存する     |
|                               | 次へ         | Next       | 次のアクションへ遷移する     |
|                               | 強制終了       | Quit       | 現在のアクティビティを終了する  |
|                               | 戻る         | Back       | アクティビティ一覧画面に遷移する |
| ItemRegistration（メタデータ入力）     | 保存         | Save       | 画面の入力情報を保存する     |
|                               | 次へ         | Next       | 次のアクションへ遷移する     |
|                               | 強制終了       | Quit       | 現在のアクティビティを終了する  |
|                               | 戻る         | Back       | アクティビティ一覧画面に遷移する |
| ItemRegistration（インデックス選択）    | 保存         | Save       | 画面の入力情報を保存する     |
|                               | 次へ         | Next       | 次のアクションへ遷移する     |
|                               | 強制終了       | Quit       | 現在のアクティビティを終了する  |
|                               | 戻る         | Back       | アクティビティ一覧画面に遷移する |
| ItemRegistration（コメント入力）      | 保存         | Save       | 画面の入力情報を保存する     |
|                               | 次へ         | Next       | 次のアクションへ遷移する     |
|                               | 強制終了       | Quit       | 現在のアクティビティを終了する  |
|                               | 戻る         | Back       | 一つ前のアクションに戻る     |
|                               | 戻る         | Back       | アクティビティ一覧画面に遷移する |
| Item Link                     | 保存         | Save       | 画面の入力情報を保存する     |
|                               | 次へ         | Next       | 次のアクションへ遷移する     |
|                               | 強制終了       | Quit       | 現在のアクティビティを終了する  |
|                               | 戻る         | Back       | 一つ前のアクションに戻る     |
|                               | 戻る         | Back       | アクティビティ一覧画面に遷移する |
| Identifier Grant              | 保存         | Save       | 画面の入力情報を保存する     |
|                               | 次へ         | Next       | 次のアクションへ遷移する     |
|                               | 強制終了       | Quit       | 現在のアクティビティを終了する  |
|                               | 戻る         | Back       | 一つ前のアクションに戻る     |
|                               | 戻る         | Back       | アクティビティ一覧画面に遷移する |
| Approval                      | 却下         | Reject     | １つ前のアクションに戻る     |
|                               | 保存         | Save       | 画面の入力情報を保存する     |
|                               | 承認         | Approval   | アクティビティを承認する     |
|                               | 強制終了       | Quit       | 現在のアクティビティを終了する  |
|                               | 戻る         | Back       | 一つ前のアクションに戻る     |
|                               | 戻る         | Back       | アクティビティ一覧画面に遷移する |

  - > 関連モジュール

<!-- end list -->

  - > weko\_workflow

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - > 処理については個別の項目を参照

  - > 戻るボタンを押すと前のアクションに戻る。

  - > アイテム編集時のワークフロー選択ロジック
    
    - 登録時に利用したワークフローが選択される。
    
    - インポート登録時はワークフローが存在しないため、 
     
        1. アイテムタイプの条件と編集対象アイテムの"path"リスト情報がワークフローの登録先インデックスと完全一致のワークフローが選択される。
        
        2. 該当のワークフローがない場合は登録先インデックスが設定されていないワークフローを選択される。
        
        3. 同じく存在していない時に"Workflow setting does not exist."のエラーメッセージが表示される。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/11/11</p>
</blockquote></td>
<td>V0.9.27</td>
<td></td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>
### Item Registration

  - > 目的・用途

本機能は、アイテムを新規登録／編集するためのメタデータ登録、ファイルアップロード、代理投稿の有無、フィードバックメール設定、所属するインデックス選択をする際に用いる機能である。

  - > 利用方法

「Item Registration」アクションを含むフローを使ったワークフローによるアクティビティを開始していることを前提とする。

フローで「Item Registration」アクションより前に設定されたアクションが完了すると、「Item Registration」アクションが表示される。

ワークフローのアイテムタイプで定められた項目を入力後、\[次へ\]ボタンを押下することで、インデックス選択の画面に遷移する。

インデックス選択の画面で登録するアイテムが所属するインデックスを選択後、\[次へ\]ボタンを押下することで、次のアクションに進む。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>※</td>
<td></td>
</tr>
</tbody>
</table>

※一般ユーザーは、ロールとして利用可能に設定することはできないが、個別のユーザーをAction Userとして設定することはできる。

  - > 機能内容

<!-- end list -->

  - アイテムを編集する場合には、タイトルのリンクを押下すると、編集前のアイテムの情報をポップアップで表示する。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - 
<!-- end list -->

  - > 処理概要

> 処理についてはそれぞれの項目に記述する。

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>


### Item Registration：ファイルアップロード

#### 目的・用途

Item Registrationの一部として、ファイルをアップロードしてそのファイルの情報を設定する。

#### 利用方法

ファイルのプロパティが指定されているアイテムタイプのアイテム登録、編集を行うワークフローで、Item Registration画面を表示する。

#### 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>※</td>
<td></td>
</tr>
</tbody>
</table>

※一般ユーザーは、ロールとして利用可能に設定することはできないが、個別のユーザーをAction Userとして設定することはできる。

#### 機能内容

1\. ファイルを登録する

  - ファイルのプロパティが指定されているアイテムタイプのアイテム登録画面にファイル登録のエリアを表示する
    
      - ファイルおよび課金ファイル情報の入力エリアをアップロードエリア直下に表示する
        
          - 表示位置を固定する
        
          - 入力エリアを開閉できる

  - ファイル登録を以下のように実施する
    
      - ファイル登録
        
          - ファイル登録のエリアに「Click to select」ボタンを押すと、アップロードファイル選択ダイヤログを表示する
            
              - アップロードするローカルファイルを選択し、「Open」ボタンを押すと、選択されたファイルをファイル登録のエリアに追加する
            
              - 複数ファイルを選択できる
        
          - 「Drop files or folders here」のテキストボックスにドラッグ&ドロップすることでもファイルを追加できる
        
          - ファイルを追加した後、以下のようなファイルの情報を表示する
            
              - Filename：追加したファイル名
            
              - Size：ファイル容量のバイト
            
              - Progress：空白
            
              - Actions：ごみ箱ボタン
        
          - ファイル追加時に全文テキスト抽出対象（WEKO\_MIMETYPE\_WHITELIST\_FOR\_ES）の場合は抽出処理を行う。 抽出後の全文テキストサイズはWEKO\_DEPOSIT\_FILESIZE\_LIMIT以下となる。全文テキストとメタデータ合わせてElasticsearchのhttp.max_content_length（デフォルトは100MB）以下である必要がある。
        
          - 追加したファイルを削除する場合、ファイル行での「Actions」にあるごみ箱ボタンを押すと、該当ファイルを削除する
    
      - ファイル編集
        
          - 一括登録を実行中に他端末および実行端末でアイテムの\[編集\]ボタンを押下した場合  
            日本語：インポートを実行中のためアイテムの編集はできません。  
            英語：Item cannot be edited because the import is in progress.
    
      - ファイル削除
        
          - 一括登録を実行中に他端末および実行端末でアイテムの\[削除\]ボタンを押下した場合  
            日本語：インポートを実行中のためアイテムの削除はできません。  
            英語：Item cannot be deleted because the import is in progress.
    
      - ファイル差し替え
        
          - インポート機能による本文ファイルの差し替えの場合  
            以下の条件でアイテムのコンテンツファイルを編集すると、統計情報を引き継いで更新される  
            .file\_path \[xx\] を書き換え  
            該当ディレクトリにコンテンツファイルを配置  
            .metadata.item\_files \[xx\] .filename を書き換え  
            ファイル名が同名か、異なる名前かに関わらず、上記の条件でインポートファイルを作成した場合はファイルの差し替えとなる
            
              - \[xx\] は該当のアイテムにファイルが複数ある場合を考慮すること。また、ファイルの追加・削除に影響がないこと
        
          - 個別編集による本文ファイルの差し替えの場合  
            同名ファイル、または異なるファイル名で差し替えをする場合、Item Registrationのファイル情報プロパティでファイル名を選択するときに、差し替え後のファイル名がプルダウンで表示される
    
      - ファイルアップロード
        
          - 「Start upload」ボタンを押すと、追加しているファイルのアップロードを行う
            
              - 「Cancel」ボタンを「Start upload」ボタンの左側に表示する  
                「Cancel」ボタンを押すと、アップロードが強制中止する
            
              - ファイルでの「Progress」にアップロードの進捗を表示する
                
                  - アップロード中：アップロードのパーセントを表示する
                
                  - アップロード済み：  
                    成功の場合：「✓」アイコンを表示する  
                    失敗の場合：「Error 」を表示する
        
          - アップロードが完了すると、アップロードしたファイル名を「ファイル名」に自動設定する  
            ファイルが複数の場合は、ファイル情報入力エリアをその数分追加した上でそれぞれ設定する  
            ［Start upload］ボタンは非活性化する
    
      - マルチパートファイルアップロード
        
          - 定数「 FILES\_REST\_USE\_MULTIPART\_UPLOAD 」によって、マルチパートアップロード機能を有効にする。
        
          - 定数「 FILES\_REST\_RESUME\_CHUNK\_SIZE 」によって、マルチパートアップロード機能が用いられるファイルサイズの閾値を設定する。（閾値を下回る場合は、通常のファイルアップロードとなる）
        
          - 「Start upload」ボタンを押すと、追加しているファイルのアップロードを行う
            
              - 「Cancel」ボタンを「Start upload」ボタンの左側に表示する  
                「Cancel」ボタンを押すと、アップロードが強制中止する
            
              - ファイルでの「Progress」にアップロードの進捗を表示する
                
                  - レジュームチェック中：「Resuming...」を表示する
                
                  - アップロード完了処理中：「Processing...」を表示する
                
                  - アップロード中：アップロードのパーセントを表示する
                
                  - アップロード済み：  
                    成功の場合：「✓」アイコンを表示する  
                    失敗の場合：「Error 」を表示する。「Resume」ボタンを表示する。
        
          - アップロードが完了すると、アップロードしたファイル名を「ファイル名」に自動設定する  
            ファイルが複数の場合は、ファイル情報入力エリアをその数分追加した上でそれぞれ設定する  
            ［Start upload］ボタンは非活性化する
        
          - 「Resume」ボタン押下し、ファイルを再選択すると、失敗したファイルアップロードを再開できる。再開できる期間には、限度があり、 定数「FILES\_REST\_MULTIPART\_EXPIRES」で定義される。この定数は、ObjectStorageのライフサイクル期間の日付と合わせる必要がある。
    
      - ファイル情報の入力
        
          - コンテンツファイルについて
            
              - 「表示名」（FileName）
            
              - 「本文URL」（Text URL）
            
              - 「ラベル」（Lable）  
                アイテム詳細画面に表示するファイルのリンク名
            
              - 「オブジェクトタイプ」（Object Type）  
                選択肢：統制語彙（https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/35-.1）
            
              - 「フォーマット」（Format）
                
                  - ファイル名で、WEKO3にアップロードされたファイルが選択された場合は、そのファイルのフォーマット（mimeType）を判定して表示する
                
                  - システムで判定した値をユーザが修正することができるよう、テキストボックスにする
            
              - 「サイズ」（Size）
                
                  - ファイル名で、WEKO3にアップロードされたファイルが選択された場合は、そのファイルのサイズを判定して表示する
                
                  - システムで判定した値をユーザが修正することができるよう、テキストボックスにする
                
                  - 繰り返し可能であるようにする
            
              - 「日付」（Date）
                
                  - 日付のエリアは「日付タイプ」（Date Type）と「日付」（Date）を入力するエリア（カレンダーを表示する）を持つ
                
                  - 日付タイプには日付の統制語彙を選択できるようにするが、Availableは選択肢に含めない
                
                  - 繰り返し可能であるようにする
            
              - 「バージョン情報」（Version Information）
            
              - 「表示形式」（Preview）  
                選択肢：「詳細表示」（Detail）、「簡易表示」（Simple）、「プレビュー」（Preview）
            
              - 「ライセンス」（License）  
                選択肢：Creative Commonsのライセンス表記を設定できる、かつ自由に記述できる  
                Creative Commonsのライセンス表記：コンフィグファイルから取得する
                
                  - コンフィグでの設定の詳細は処理概要を参照
            
              - 「アクセス」（Access）
                
                  - オープンアクセス（Open Access）
                
                  - オープンアクセス日を指定する（Input Open Access Date）
                    
                      - オープンアクセス日を指定する必要がある
                
                  - ログインユーザーのみ（Registered User Only）
                    
                      - ユーザーグループを指定する必要がある
                
                  - 公開しない（Do not Publish）
                
                  - 制限公開（Limited Access）
                    
                      - コンテンツファイルのプロパティで定義されている場合のみ表示
                    
                      - 「制限公開」を選択している際は以下の項目を表示する
                        
                          - ［データタイプ］：プロパティ内で定義している選択肢を表示する
                        
                          - ［提供方法］：アイテム詳細画面で「申請」ボタンを押下した際、どの利用申請ワークフローを起動するか設定する。複数設定できる（繰り返し可）として、以下の項目を子項目とする
                            
                              - ［ワークフロー\]：  
                                【Administration \> ワークフロー管理（WorkFlow） \> ワークフロー（WorkFlow List）画面】で管理しているワークフローのうち「制限公開フラグ」が有効なものをリストに表示する
                            
                              - ［ロール］：Admin\>UserManagement\>Roleで管理しているロールと「非ログインユーザ」をリストに表示する
                        
                          - ［利用規約］：管理画面で登録した利用規約をリストで表示する。選択肢に「自由入力」を設け、選択した際はテキストエリアを表示する
        
          - 課金ファイルについて
            
              - 「表示名」（FileName）  
                アップロードされたファイル名を選択する
            
              - 「ラベル」（Lable）  
                アイテム詳細画面に表示するファイルのリンク名
            
              - 「オブジェクトタイプ」（Object Type）  
                選択肢：統制語彙（https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/35-.1）
            
              - 「バージョン情報」（Version Information）
            
              - 「表示形式」（Preview）  
                選択肢：「詳細表示」（Detail）、「簡易表示」（Simple）、「プレビュー」（Preview）
            
              - 「ライセンス」（License）  
                選択肢：Creative Commonsのライセンス表記を設定できる、かつ自由に記述できる  
                Creative Commonsのライセンス表記：コンフィグファイルから取得する　
            
              - 「アクセス」（Access）
                
                  - オープンアクセス
                
                  - オープンアクセス日を指定する（Input Open Access Date）
                    
                      - オープンアクセス日を指定する必要がある
                
                  - ログインユーザーのみ（Registered User Only）
                    
                      - ユーザーグループ及びグループごとの価格を指定する必要である
                
                  - 公開しない（Do not Publish）

2\. ファイルを差し替える

  - ファイルが添付されているアイテムを編集する際に、ファイルの差し替えを行うことができる
    
      - アイテム編集時にファイルが添付されている場合、Action欄に \[Replace\] ボタンが表示される
    
      - ファイルを差し替える場合は、\[Replace\] ボタンを押下して、差し替えるファイルを登録する
    
      - \[Replace\] ボタンを押下すると「アップロードファイル選択」ダイアログが開き、ファイルを選択すると、選択後のファイル名が画面上に赤文字で表示される。
    
      - \[Start upload\] ボタンを押下してファイルの取り込みを行うことで、差し替え前のファイル情報プロパティのファイル名、本文URL、フォーマット、サイズの情報が上書きされる

  - ファイルを差し替えた場合でも、統計情報を引き継がせる（差し替え前の値が維持されて合算される）ことができる。引き継がせるケースとしては以下の通り。
    
      - ファイルの差し替えと同時に「バージョンの変更」してアイテム更新
    
      - 「バージョンの変更」してアイテム更新後に、「keep」でファイルの差し替え

3\. ファイルのサムネイルを登録できる

  - 「サムネイル」（Thumbnail）パネルにファイルのサムネイルを登録できる
    
      - 「サムネイル」（Thumbnail）パネルに「Click to select」ボタンを押すと、アップロードファイル選択ダイヤログを表示する
        
          - 選択可能ファイルの拡張子：gif, jpg, jpe, jpeg, png, bmp
        
          - 一つのファイルのみ選択できる
        
          - 登録可能なファイル以外のファイルをアップロードしようとしたときにエラーメッセージをポップアップで表示する
            
              - 「画像ファイル（gif, jpg, jpe, jpeg, png, bmp）以外のファイルはアップロードできません」
    
      - ファイルを登録した後、以下のようなファイルの情報を表示する
        
          - ファイル名（Filename）：登録したファイル名
        
          - 容量（Size）：ファイル容量のバイト
        
          - 進捗（Progress）：「✓」アイコンを表示する
        
          - アクション（Actions）：「X」ボタン
    
      - 追加したファイルを削除する場合、「Actions」にてごみ箱ボタンを押すと、該当ファイルを削除する
    
      - ファイルが登録されている状態で、他のファイルをアップロードすると、後からアップロードしたファイルに置き換わる

<!-- end list -->

#### 関連モジュール

<!-- end list -->

- weko\_workflow
- weko\_deposit
- weko-records-ui

<!-- end list -->

#### 処理概要

#### weko-records-ui

> Creative Commonsのライセンス表記を設定する

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/scripts/instance.cfg#L248>

  - > 設定キー： 「WEKO\_RECORDS\_UI\_LICENSE\_DICT」

  - > 現在の設定値：


```
WEKO_RECORDS_UI_LICENSE_DICT = [
    {
        'name': _('write your own license'),
        'value': 'license_free',
    },
    # version 0
    {
        'name': _(
            'Creative Commons CC0 1.0 Universal Public Domain Designation'),
        'code': 'CC0',
        'href_ja': 'https://creativecommons.org/publicdomain/zero/1.0/deed.ja',
        'href_default': 'https://creativecommons.org/publicdomain/zero/1.0/',
        'value': 'license_12',
        'src': '88x31(0).png',
        'src_pdf': 'cc-0.png',
        'href_pdf': 'https://creativecommons.org/publicdomain/zero/1.0/'
                    'deed.ja',
        'txt': 'This work is licensed under a Public Domain Dedication '
               'International License.'
    },
    # version 3.0
    {
        'name': _('Creative Commons Attribution 3.0 Unported (CC BY 3.0)'),
        'code': 'CC BY 3.0',
        'href_ja': 'https://creativecommons.org/licenses/by/3.0/deed.ja',
        'href_default': 'https://creativecommons.org/licenses/by/3.0/',
        'value': 'license_6',
        'src': '88x31(1).png',
        'src_pdf': 'by.png',
        'href_pdf': 'http://creativecommons.org/licenses/by/3.0/',
        'txt': 'This work is licensed under a Creative Commons Attribution'
               ' 3.0 International License.'
    },
    {
        'name': _(
            'Creative Commons Attribution-ShareAlike 3.0 Unported '
            '(CC BY-SA 3.0)'),
        'code': 'CC BY-SA 3.0',
        'href_ja': 'https://creativecommons.org/licenses/by-sa/3.0/deed.ja',
        'href_default': 'https://creativecommons.org/licenses/by-sa/3.0/',
        'value': 'license_7',
        'src': '88x31(2).png',
        'src_pdf': 'by-sa.png',
        'href_pdf': 'http://creativecommons.org/licenses/by-sa/3.0/',
        'txt': 'This work is licensed under a Creative Commons Attribution'
               '-ShareAlike 3.0 International License.'
    },
    {
        'name': _(
            'Creative Commons Attribution-NoDerivs 3.0 Unported (CC BY-ND 3.0)'),
        'code': 'CC BY-ND 3.0',
        'href_ja': 'https://creativecommons.org/licenses/by-nd/3.0/deed.ja',
        'href_default': 'https://creativecommons.org/licenses/by-nd/3.0/',
        'value': 'license_8',
        'src': '88x31(3).png',
        'src_pdf': 'by-nd.png',
        'href_pdf': 'http://creativecommons.org/licenses/by-nd/3.0/',
        'txt': 'This work is licensed under a Creative Commons Attribution'
               '-NoDerivatives 3.0 International License.'

    },
    {
        'name': _(
            'Creative Commons Attribution-NonCommercial 3.0 Unported'
            ' (CC BY-NC 3.0)'),
        'code': 'CC BY-NC 3.0',
        'href_ja': 'https://creativecommons.org/licenses/by-nc/3.0/deed.ja',
        'href_default': 'https://creativecommons.org/licenses/by-nc/3.0/',
        'value': 'license_9',
        'src': '88x31(4).png',
        'src_pdf': 'by-nc.png',
        'href_pdf': 'http://creativecommons.org/licenses/by-nc/3.0/',
        'txt': 'This work is licensed under a Creative Commons Attribution'
               '-NonCommercial 3.0 International License.'
    },
    {
        'name': _(
            'Creative Commons Attribution-NonCommercial-ShareAlike 3.0 '
            'Unported (CC BY-NC-SA 3.0)'),
        'code': 'CC BY-NC-SA 3.0',
        'href_ja': 'https://creativecommons.org/licenses/by-nc-sa/3.0/deed.ja',
        'href_default': 'https://creativecommons.org/licenses/by-nc-sa/3.0/',
        'value': 'license_10',
        'src': '88x31(5).png',
        'src_pdf': 'by-nc-sa.png',
        'href_pdf': 'http://creativecommons.org/licenses/by-nc-sa/3.0/',
        'txt': 'This work is licensed under a Creative Commons Attribution'
               '-NonCommercial-ShareAlike 3.0 International License.'
    },
    {
        'name': _(
            'Creative Commons Attribution-NonCommercial-NoDerivs '
            '3.0 Unported (CC BY-NC-ND 3.0)'),
        'code': 'CC BY-NC-ND 3.0',
        'href_ja': 'https://creativecommons.org/licenses/by-nc-nd/3.0/deed.ja',
        'href_default': 'https://creativecommons.org/licenses/by-nc-nd/3.0/',
        'value': 'license_11',
        'src': '88x31(6).png',
        'src_pdf': 'by-nc-nd.png',
        'href_pdf': 'http://creativecommons.org/licenses/by-nc-nd/3.0/',
        'txt': 'This work is licensed under a Creative Commons Attribution'
               '-NonCommercial-ShareAlike 3.0 International License.'
    },
    # version 4.0
    {
        'name': _('Creative Commons Attribution 4.0 International (CC BY 4.0)'),
        'code': 'CC BY 4.0',
        'href_ja': 'https://creativecommons.org/licenses/by/4.0/deed.ja',
        'href_default': 'https://creativecommons.org/licenses/by/4.0/',
        'value': 'license_0',
        'src': '88x31(1).png',
        'src_pdf': 'by.png',
        'href_pdf': 'http://creativecommons.org/licenses/by/4.0/',
        'txt': 'This work is licensed under a Creative Commons Attribution'
               ' 4.0 International License.'
    },
    {
        'name': _(
            'Creative Commons Attribution-ShareAlike 4.0 International '
            '(CC BY-SA 4.0)'),
        'code': 'CC BY-SA 4.0',
        'href_ja': 'https://creativecommons.org/licenses/by-sa/4.0/deed.ja',
        'href_default': 'https://creativecommons.org/licenses/by-sa/4.0/',
        'value': 'license_1',
        'src': '88x31(2).png',
        'src_pdf': 'by-sa.png',
        'href_pdf': 'http://creativecommons.org/licenses/by-sa/4.0/',
        'txt': 'This work is licensed under a Creative Commons Attribution'
               '-ShareAlike 4.0 International License.'
    },
    {
        'name': _(
            'Creative Commons Attribution-NoDerivatives 4.0 International '
            '(CC BY-ND 4.0)'),
        'code': 'CC BY-ND 4.0',
        'href_ja': 'https://creativecommons.org/licenses/by-nd/4.0/deed.ja',
        'href_default': 'https://creativecommons.org/licenses/by-nd/4.0/',
        'value': 'license_2',
        'src': '88x31(3).png',
        'src_pdf': 'by-nd.png',
        'href_pdf': 'http://creativecommons.org/licenses/by-nd/4.0/',
        'txt': 'This work is licensed under a Creative Commons Attribution'
               '-NoDerivatives 4.0 International License.'
    },
    {
        'name': _(
            'Creative Commons Attribution-NonCommercial 4.0 International'
            ' (CC BY-NC 4.0)'),
        'code': 'CC BY-NC 4.0',
        'href_ja': 'https://creativecommons.org/licenses/by-nc/4.0/deed.ja',
        'href_default': 'https://creativecommons.org/licenses/by-nc/4.0/',
        'value': 'license_3',
        'src': '88x31(4).png',
        'src_pdf': 'by-nc.png',
        'href_pdf': 'http://creativecommons.org/licenses/by-nc/4.0/',
        'txt': 'This work is licensed under a Creative Commons Attribution'
               '-NonCommercial 4.0 International License.'
    },
    {
        'name': _(
            'Creative Commons Attribution-NonCommercial-ShareAlike 4.0'
            ' International (CC BY-NC-SA 4.0)'),
        'code': 'CC BY-NC-SA 4.0',
        'href_ja': 'https://creativecommons.org/licenses/by-nc-sa/4.0/deed.ja',
        'href_default': 'https://creativecommons.org/licenses/by-nc-sa/4.0/',
        'value': 'license_4',
        'src': '88x31(5).png',
        'src_pdf': 'by-nc-sa.png',
        'href_pdf': 'http://creativecommons.org/licenses/by-nc-sa/4.0/',
        'txt': 'This work is licensed under a Creative Commons Attribution'
               '-NonCommercial-ShareAlike 4.0 International License.'
    },
    {
        'name': _(
            'Creative Commons Attribution-NonCommercial-NoDerivatives 4.0 '
            'International (CC BY-NC-ND 4.0)'),
        'code': 'CC BY-NC-ND 4.0',
        'href_ja': 'https://creativecommons.org/licenses/by-nc-nd/4.0/deed.ja',
        'href_default': 'https://creativecommons.org/licenses/by-nc-nd/4.0/',
        'value': 'license_5',
        'src': '88x31(6).png',
        'src_pdf': 'by-nc-nd.png',
        'href_pdf': 'http://creativecommons.org/licenses/by-nc-nd/4.0/',
        'txt': 'This work is licensed under a Creative Commons Attribution'
               '-NonCommercial-ShareAlike 4.0 International License.'
    },
]
```

#### weko-deposit

```
WEKO_DEPOSIT_TEXTMIMETYPE_WHITELIST_FOR_ES = [
  'text/plain',
  'text/csv',
  'text/html',
  'text/tab-separated-values',
  'text/xml',
  'application/x-tex',
  'application/x-latex']

WEKO_MIMETYPE_WHITELIST_FOR_ES = [
    'application/msword',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
    'application/vnd.oasis.opendocument.text',
    'application/vnd.ms-excel',
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    'application/vnd.oasis.opendocument.spreadsheet',
    'application/vnd.ms-powerpoint',
    'application/vnd.openxmlformats-officedocument.presentationml.presentation',
    'application/vnd.oasis.opendocument.presentation',
    'application/pdf',
] + WEKO_DEPOSIT_TEXTMIMETYPE_WHITELIST_FOR_ES
```


```
WEKO_DEPOSIT_FILESIZE_LIMIT = 2 * 1024 * 1024
```

#### 実装方法

#### 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>
### Item Registration：メタデータ入力

#### 目的・用途

Item Registrationの一部として、画面上の入力欄でメタデータを設定する。

#### 利用方法

ワークフローで、Item Registration画面を表示する。

#### 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>※</td>
<td></td>
</tr>
</tbody>
</table>

※一般ユーザーは、ロールとして利用可能に設定することはできないが、個別のユーザーをAction Userとして設定することはできる。

#### 機能内容

1\. アイテムのメタデータを入力する

  - 【アイテム登録画面】に入力するアイテムのメタデータを表示する

  - 【Administration \> アイテムタイプ管理（Item Types） \> メタデータ（Meta）画面】で設定したOptionに応じて、アイテム登録/編集画面におけるアイテムタイプ項目の表示を制御する
    
      - メタデータ画面のItem Nameに対するOption属性に「Required」を設定した項目は、アイテム登録/編集画面の表示時に「Required」パネルに配置し、パネルを展開可能とする  
        「Required」を設定した項目のラベルの右側に「 \* 」と付けされる
        
          - Item Name配下のAttributeに対するOption属性「Required」はこの制御の対象としない
    
      - メタデータ画面のItem Nameに対するOption属性に「Multiple」、「List Display」、「Specify Newline」を設定したものを「Optional」パネルに配置し,パネルを開閉可能とする
    
      - 以下の項目は本ストーリーでの対応の対象としない
        
          - サムネイル（Thumbnail）
        
          - Contributor
        
          - 公開日（PubDate）
        
          - フィードバックメール送信先（Feedback Mail Destination）

  - 日付のフォーマットで定義されるプロパティまたは属性に対して、3つのフォーマット（YYYY-MM-DD、YYYY-MM、YYYY）が入力できる
    
      - 入力方法はカレンダー入力、または手入力である
    
      - デフォルト値はサーバ日付（/api/admin/get\_server\_date）を利用する
    
      - 無効な日付が入力された場合のチェックを行う
        
          - modules/weko-theme/weko\_theme/static/js/weko\_theme/search\_detail.js
        
          - modules/weko-theme/weko\_theme/static/js/weko\_theme/top\_page.js

  - 作成者プロパティへの著者情報の入力
    
      - 「著者DBから入力」（From author DB）ボタンを押下すると、著者DBの検索ウィンドウが表示される
    
      - 「検索」ボタンを押すと、【Administration \> 著者DB管理（Author Management） \> 編集（Edit）】で登録された著者DB一覧を表示する
    
      - ［入力（import）］ ボタンを押すと、選択した著者情報をメタデータの各エリアに入力する
    
      - 「Add Author」ボタンを押すと、著者登録画面が表示され著者情報を登録することができる（登録すると著者DB管理画面にも反映される）
    
      - 作成者識別子"WEKO"のデータ部分はユーザーでの編集は不可とする（作成者識別子Scheme, 作成者識別子URI, 作成者識別子はグレーアウトする）
    
      - アイテム登録時にDB, ESに"author\_link"という情報を持たせ、アイテムと著者DBの紐づけを行う
    
      - アイテムとの紐づけを行わない(解除する)場合は、「作成者」パネル内の各入力エリアの右上にある\[×\]で紐づけを解除する
    
      - アイテムで個別に編集した作成者の項目は、Adminの著者DBには反映されない。  
        なお、アイテムで個別に編集した後に著者DBから著者を取り込むと、個別編集した項目は上書きされる

2\. アイテムのメタデータを自動入力できる

  - Web APIのアカウント情報を設定する
    
      - 【Administration \> 設定（Setting） \> WebAPIアカウント（WebAPI Account）画面】にアイテムメタデータ自動入力機能で連携するWeb APIのアカウント情報を設定する  
        現在、CrossRefのみ対応している
    
      - 設定項目は以下とする
        
          - 「入力タイプ」（Input Type） ：タイプを選択する
        
          - 各種APIに必要なアカウント設定フィールド
            
              - 入力タイプで "CrossRef" を選択した場合は、以下の入力フィールドを表示する  
                「CrossRefクエリサービスアカウント」（CrossRef Query Services Account）
    
      - Saveボタンを押すと設定情報が保存される
    
      - 保存した設定情報は、アイテムメタデータ自動入力機能におけるAPIアカウント認証で使用する

  - アイテムメタデータを自動入力する
    
      - アイテムメタデータ登録画面に「メタデータ自動入力」（Automatic Metadata Input）ボタンを押すと、メタデータ自動入力のポップアップが表示される  
        「ID選択」プルダウンにタイプを選択し、「取得」（Get）ボタンを押すと書誌情報が取得される形とする

  - CrossRef API経由でアイテムメタデータを入力する
    
      - 「CrossRef」を選択し、DOIの値をテキストフィールドに入力して「取得」（Get）ボタンを押すと、【Administration \> 設定（Setting） \> WebAPIアカウント（WebAPI Account）画面】に設定されたAPIの利用にあたり必要なクレデンシャル情報(CrossRef Query Services Account)で書誌情報が取得される
        
          - 取得データは、アイテムの対応項目および対応するJPCOARマッピングが設定されたメタデータ項目に自動入力される  
            取得データの入力先メタデータ項目

| \# | 要素                                                              | JPCOARスキーマ                                      |
| -- | --------------------------------------------------------------- | ----------------------------------------------- |
| 1  | article\_title                                                  | dc:title                                        |
| 2  | author                                                          | jpcoar:creatorName                              |
| 3  | contributor(contributor\_role属性が editor, chair, translator)     | jpcoar:contributorName                          |
| 4  | contributor(contributor\_role属性が editor, chair, translator 以外)  | jpcoar:creatorName                              |
| 5  | organization(contributor\_role属性が editor, chair, translator)    | jpcoar:affiliationName                          |
| 6  | organization(contributor\_role属性が editor, chair, translator 以外) | jpcoar:affiliationName                          |
| 7  | journal\_title                                                  | jpcoar:sourceTitle                              |
| 8  | volume                                                          | jpcoar:volume                                   |
| 9  | issue                                                           | jpcoar:issue                                    |
| 10 | first\_page                                                     | jpcoar:pageStart                                |
| 11 | last\_page                                                      | jpcoar:pageEnd                                  |
| 12 | year                                                            | datacite:date(dateType="Issued")                |
| 13 | issn                                                            | jpcoar:sourceIdentifier(identifierType="ISSN")  |
| 14 | isbn                                                            | jpcoar:relatedIdentifier(identifierType="ISBN") |
| 15 | doi                                                             | jpcoar:relatedIdentifier(identifierType="DOI")  |

  - CiNii API経由でアイテムメタデータを入力する
    
      - 「CiNii」を選択し、CRIDをテキストフィールドに入力して「取得」（Get）ボタンを押すと書誌情報が取得される
    
      - 書誌情報の取得は、CiNii API を利用する  
        \[CiNii ResearchのJSON-LD\]  
        https://support.nii.ac.jp/ja/cir/r\_json
    
      - 取得データは、アイテムの対応項目および対応するJPCOARマッピング(jpcoar_v2_mapping)が設定されたメタデータ項目に自動入力される
        
        取得データの入力先メタデータ項目

| **データ**   | **パス**                                          | **対応するJPCOARマッピング**                   |
| --------- | ----------------------------------------------- | ------------------------------------- |
| タイトル      | dc:title                                        | dc:title                              |
| 別タイトル     | dcterms:alternative                             | dc:title                              |
| 成果物識別子    | productIdentifier.identifier(type=xx)           | jpcoar:relation                       |
| 著者名       | creator.foaf:name                               | jpcoar:creatorName                            |
| 著者識別子     | creator.personIdentifier                        |                                       |
| 著者所属名     | creator.jpcoar:affiliationName                  |                                       |
| 寄与者名      | contributor.foaf:name                           | jpcoar:contributorName |
| 寄与者所属名    | contributor.jpcoar:affiliationName              |                                       |
| 寄与者識別子    | contributor.personIdentifier                    |                                       |
| 収録物識別子    | publication.publicationidentifier               |                                       |
| 収録物名      | publication.prism:publicationName               | jpcoar:sourceTitle                 |
| 収録物発行日    | publication.prism:publicationDate               |                                       |
| 巻         | publication.prism:volume                        | jpcoar:volume                          |
| 号         | publication.prism:number                        | jpcoar:issue                          |
| 開始ページ     | publication.prism:startingPage                  | jpcoar:pageStart                    |
| 終了ページ     | publication.prism:endingPage                    | jpcoar:pageEnd                      |
| 総ページ数     | publication.jpcoar:numPages                     | jpcoar:numPages                       |
| 発行者       | publication.dc:publisher                        | dc:publisher                          |
| 日付        | publication.prism:publicationDate               | datacite:date               |
| 収録誌のNCID  | publication.publicationIdentifier(@type=NCID)   |jpcoar:sourceIdentifier                            |
| 収録誌のISSN  | publication.publicationIdentifier(@type=ISSN)   | jpcoar:sourceIdentifier                            |
| 学位授与番号    | ndl:dissertationNumber                          |                                       |
| 学位名       | ndl:degreeName                                  |                                       |
| 学位授与年月日   | ndl:dateGranted                                 |                                       |
| 学位授与機関識別子 | degreeAwardInstitution.institutionIdentifier    |                                       |
| 学位授与機関名   | degreeAwardInstitution.jpcoar:degreeGrantorName |                                       |
| 学会、会議名    | jpcoar:conferenceName                           |                                       |
| 開催地       | jpcoar:conferencePlace                          |                                       |
| 開催期間(開始日) | jpcoar:conferenceDate.jpcoar:startDay           |                                       |
| 開催期間(開始月) | jpcoar:conferenceDate.jpcoar:startMonth         |                                       |
| 開催期間(開始年) | jpcoar:conferenceDate.jpcoar:startYear          |                                       |
| 開催期間(終了日) | jpcoar:conferenceDate.jpcoar:endDay             |                                       |
| 開催期間(終了月) | jpcoar:conferenceDate.jpcoar:endDay             |                                       |
| 開催期間(終了年) | jpcoar:conferenceDate.jpcoar:endDay             |                                       |
| 助成機関名     | fundingProgram.notation                         |                                       |
| 関連物関連タイプ  | relatedProduct.relationType                     |                                       |
| 関連物識別子    | relatedProduct.productIdentifier                |                                       |
| 関連物タイトル   | relatedProduct.jpcoar:relatedTitle              |                                       |
| 抄録タイプ     | description.type                                | typeはAbstraction固定                    |
| 抄録本文      | description.notation                            | dc:description                        |
| 主題URL     | foaf:topic.@id                                  | jpcoar:subject                        |
| 主題タイトル    | foaf:topic.dc:title                             | jpcoar:subject                        |
| バージョン     | datacite:version                                |                                       |
| 言語        | dc:language                                     |                                       |

  - 指定したWEKOIDのデータを流用してアイテムメタデータを入力する
    
      - 「WEKOID」を選択し、recidの値をテキストフィールドに入力して「取得」（Get）ボタンを押すと、書誌情報が取得される
        
          - PersestentIdentifier.getを用い、pidstore\_pidテーブルからレコードID(object\_uuid)を取得する
        
          - JPCOARスキーママッピングが一致した項目について、メタデータを流用入力する
            
              - recidに指定したアイテムと、編集対象のアイテムのアイテムタイプが異なっていても、JPCOARマッピングが一致した項目について流用入力する
            
              - マッピングしていない項目は流用入力対象外とする
        
          - データ流用時（「Get」ボタン押下時）に、取り込み対象アイテムの参照権限があるか権限チェックを行う
            
              - 非公開のアイテムについては、自分が参照できるアイテムでなければ流用入力できない
            
              - ただし、参照権限があっても(ロールによらず)Hide設定がされた項目については流用入力できない

  - 制限公開用のアイテムタイプに対して、いくつかの項目が自動入力されて、アイテム登録画面に非活性の状態で表示される  
    対象項目は、以下のファイルを参照する
    
      - ファイル： 別紙「利用申請および利用報告アイテムタイプ.xlsx」
        
          - 「利用申請」シート：「利用申請」と「二段階利用申請」アイテムタイプの説明
        
          - 「利用報告」シート：「利用報告」アイテムタイプの説明

  - 「Automatic metadata input」からメタデータを自動入力した際、ISBN/ISSN/DOIはすべて「jpcoar:sourceIdentifier」にマッピングされるが、このマッピング情報がアイテムタイプに複数存在する場合は、１つ目（１番上）のプロパティにのみセットする

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > 「weko\_workflow」：アイテム編集可能な権限をチェックする処理モジュールである

  - > 「weko\_items\_ui」：メタデータ登録を管理する処理モジュールである

  - > 「weko-items-autofill」：メタデータ自動入力用のデータを取得する処理モジュールである

<!-- end list -->

  - > 処理概要

> 選択されたメタデータを表示する処理

  - > パネルがオープンか、クローズかの状態を取得する
    
      - > すべての項目に対してデフォルトの状態はクローズとする
    
      - > 「$rootScope.recordsVM.invenioRecordsSchema.required」から必須項目を取得し、それらの項目のパネルが初期としとオープンの状態とする

  - > パネルの中身に表示する処理はプロパティのデータを取得し、タイプに応じて以下のテンプレートで表示する
    
      - > form.html（https://github.com/inveniosoftware/invenio-records-js/blob/master/src/invenio-records-js/templates/form.html）
    
      - > decorators（https://github.com/inveniosoftware/invenio-records-js/tree/master/src/invenio-records-js/templates/decorators）

2\. 設定

| **設定**                           | **説明**               | **デフォルト値** | **実装箇所**                                        |
| -------------------------------- | -------------------- | ---------- | ----------------------------------------------- |
| WEKO\_ITEMS\_UI\_SAVE\_FREQUENCY | メタデータ登録画面における自動セーブ機能 | 10分        | modules/weko-items-ui/weko\_items\_ui/config.py |

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2024/04/14</p>
</blockquote></td>
<td>cd0183f59a16928be2511e33e4495a3376f143c9</td>
<td>v1.0.6</td>
</tr>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>

### Item Registration：代理投稿

  - > 目的・用途

Item Registrationの一部として、画面上の設定エリアで代理投稿者を指定する。

  - > 利用方法

アイテムメタデータ登録画面の\[Contributor\]エリアで「Other user」ラジオボタンを選択すると、ユーザ設定エリアが表示される。そこで入力されたユーザを代理投稿者として設定する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>※</td>
<td></td>
</tr>
</tbody>
</table>

※一般ユーザーは、ロールとして利用可能に設定することはできないが、個別のユーザーをAction Userとして設定することはできる。

  - > 機能内容

1\. アイテムに代理投稿を指定する

  - アイテムメタデータ登録画面に\[Contributor\]エリアを表示する

  - アイテムの登録者は、Contributorをシステムに登録されている他のユーザから選択できる  
    ただし、アイテム登録者は、他ユーザを選択してもContributorとして有効のままとする

  - デフォルトは\[This user\]とする（アイテム登録者のみをContributorとする）

  - 他のユーザから選択する場合は、\[Other users\]を選択する  
    選択すると、ユーザ設定エリア(下記2項目)が表示される
    
      - Username
    
      - Email

  - 上記の2項目に任意の文字列を入力すると、インクリメンタルサーチでヒットするユーザが候補一覧に自動表示される
    
      - ヒットするユーザが無い場合、「No result found」のメッセージを候補一覧に表示する

  - ユーザ候補一覧よりユーザを選択すると、該当ユーザの「Username」、「Email」が自動入力される

  - 「Username」及び「Email」を手動入力することもできる

  - ［次へ（Next）］ボタンを押したときに、以下のチェックを行う
    
      - 入力したUsernameが存在しない、または\[Other users\]を選択してユーザ設定エリアに何も入力していない場合は、指定されたユーザが存在しない旨メッセージを表示し、入力確定できない  
        メッセージ：  
        「Shared user information is not valid  
        Please check it again\!」
    
      - Usernameを入力しておらず、入力したEmailが存在しない場合は、Usernameの入力が必要である旨のメッセージを表示し、入力確定できない  
        メッセージ：  
        「An error ocurred while processing the input data\!  
        Cannot read properties of null (reading 'username')」
    
      - 入力ユーザがアイテム登録ユーザーであれば、メッセージを表示する  
        メッセージ：「You cannot specify yourself in "Other users" setting.」

  - Contributorとして指定されたユーザは、アイテム登録者と同様に該当アイテムの登録(編集)権限が付与される

  - Contributorの設定は1つのユーザのみできる

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > 「weko\_items\_ui」：代理投稿を登録する処理モジュールである

  - > 「weko\_workflow」：アイテム編集可能な権限をチェックする処理モジュールである

<!-- end list -->

  - > 処理概要

> アイテム登録/編集画面に代理投稿を登録する処理

  - > アイテム登録/編集画面で「Contributor」エリアのテキストボックスにクリックすると、「get\_search\_data」メソッドでデータを以下の情報から取得する
    
      - > 「Username」：「userprofiles\_userprofile.username」
    
      - > 「Email」：「accounts\_user.email」

  - > 「Contributor」エリアのテキストボックスに任意の文字列を入力すると、「autocomplete」メソッドで入力したテキストにヒットするデータを候補一覧に表示する

  - > ユーザ候補一覧よりユーザを選択すると、「validate\_user\_info」メソッドで選択したユーザー情報をチェックし、「get\_autofill\_data」メソッドで「Username」と「Email」テキストにユーザー情報を表示させる

  - > ［次へ（Next）］または［保存（Save）］ボタンを押すと、代理投稿としてユーザー情報を再度チェックする、問題なければ、入力したユーザーが「shared\_user\_id」としてメタデータに保存する

> アイテム編集の権限を確認する処理

  - > アクティビティにアクセスすると、「check\_authority\_action」メソッドでログインしているユーザーの権限をチェックし、管理者及び登録者以外、ログインしているユーザーIDが「shared\_user\_id」に属すれば、アクティビティ詳細画面に移動する

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### Item Registration：フィードバックメール機能

  - > 目的・用途

フィードバックメールの送信有無をアイテム単位で設定する。

  - > 利用方法

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>※</td>
<td></td>
</tr>
</tbody>
</table>

※一般ユーザーは、ロールとして利用可能に設定することはできないが、個別のユーザーをAction Userとして設定することはできる。

  - > 機能内容

【前提条件】

  - 【Administration \> 統計（Statistics） \> フィードバックメール（Feedback Mail）画面】で、フィードバックメールを送信する設定になっていること。

  - 詳細は、管理機能の[フィードバックメール](#_フィードバックメール)を参照。

  - アイテム登録画面の一番下での「フィードバックメール送信先」領域にフィードバックメール送信先を設定できる
    
      - ［著者DBから入力（From author DB）］ボタン
        
          - ボタンを押下すると、著者DBの検索ウィンドウが表示される
        
          - 「検索」ボタンを押すと、【Admin \> Setting \> Author Management \> Author ID 】登録された著者DB一覧を表示する
        
          - メールが設定されていない著者がいた場合でも著者を表示するが、Importボタンを非活性にする
            
              - メールアドレスがリストボックスに表示されていない著者を選択すると、リストボックス上にメールアドレスがインポートされる
            
              - メールアドレスがリストボックスに表示された著者を選択すると、以下のエラーメッセージを表示し、リストボックス上にインポートされない  
                エラーメッセージ：「Duplicate Email Addresses.」
    
      - リストボックス
        
          - 送信対象者となる著者のメールアドレスが表示される
        
          - メールアドレスはクリックすると選択できる
        
          - メールアドレスを選択している状態で、\[Delete\]ボタンを押下すると、選択した著者のメールアドレスがリストボックスから消える(送信対象者から外れる)
        
          - リストボックスはテキスト入力できる  
            テキスト入力されたデータの"先頭"と"末尾"にスペースがあった場合はトリム処理をした上で設定する
        
          - 次のアクションに進むタイミングで、リストボックス内のメールアドレスのバリデート処理(メールアドレスとして満たしているか)を行う。
        
          - バリデート処理で問題があった場合、エラーを表示して次のアクションには進めない。
            
              - 入力されたメールアドレスの形式が不正の場合、以下のエラーメッセージを表示する  
                エラーメッセージ：「Invalid email format.」
            
              - 入力されたメールアドレスが重複している場合、以下のエラーメッセージを表示する  
                エラーメッセージ：「Duplicate Email Addresses.」

  - フィードバックメール送信先の設定はアイテムタイプによらず表示されるものとする

  - フィードバックメール送信先は必須項目ではないため、入力しなくても次のアクションへ進める

  - フィードバックメール送信先はメタデータの登録・編集時のみ表示され、当該アイテムの登録者及び管理者は表示される  
    ただし、Contributorとして指定されたユーザは、 アイテム登録者と同様に該当アイテムの登録(編集)権限が付与されるため、フィードバックメール送信先も設定できるものとする

  - フィードバックメール送信先は、承認者が承認をした時点から有効となる

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - 
<!-- end list -->

  - > 処理概要

1\. 設定

> フィードバックメール送信タイミングを設定

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/scripts/instance.cfg#L98>

  - > 設定キー：「send-feedback-mail-schedules」

  - > 設定値: day\_of\_month、hour、minute  
    > 現在の設定値：day\_of\_month='1', hour=0, minute=0

> フィードバックメールの送信履歴の表示件数

  - > パス：modules/weko-admin/weko\_admin/config.py

  - > 設定値：WEKO\_ADMIN\_NUMBER\_OF\_SEND\_MAIL\_HISTORY = 20

> フィードバックメールの送信履歴の送信失敗の表示件数

  - > パス：modules/weko-admin/weko\_admin/config.py

  - > 設定値：WEKO\_ADMIN\_NUMBER\_OF\_FAILED\_MAIL = 10

> フィードバックメールの送信件数を設定

  - > パス：modules/weko-search-ui/weko\_search\_ui/config.py

  - > 設定値：WEKO\_SEARCH\_MAX\_FEEDBACK\_MAIL = 100

> １メールアドレスで送信できるアイテムの数： 最大10,000件を取得(ESの制限値)

2\. 実装方法

> 実装モジュール：weko-admin
> 
> 設定情報を保存する

  - > アイテム登録時、 フィードバックメール送信先を入力する場合、「Approval」ステップに承認した後、  
    > フィードバックメール送信先の情報を以下のように保存される
    
      - > データベースに保存する  
        > テーブル名：feedback\_mail\_list  
        > 保存情報：item\_id、mail\_list
    
      - > Elasticsearchに「feedback\_mail\_list」属性に保存する

  - > 【Administration \> 統計（Statistics） \> フィードバックメール（Feedback Mail）】に入力した情報をデータベースに以下のように保存する  
    > テーブル名：feedback\_email\_setting  
    > 保存情報：is\_sending\_feedback、manual\_mail

> フィードバックメール送信のフロー  
> celaryタスクでフィードバックメールを送信するかどうか、チェックする  
> 「schedule」に設定された時刻にフィードバックメール送信を「task」でのタスク（weko\_admin.tasks.send\_feedback\_mail）で実施する
> 
> (1) 「feed\_back\_email\_setting」の情報を「feedback\_email\_setting」テーブルから取得する
> 
> 　・「is\_sending\_feedback = false」の場合、何も処理しない
> 
> 　・「is\_sending\_feedback = true」の場合、(2)に進む
> 
> (2)Elasticsearchからフィードバックメールの情報を取得する
> 
> 　・アイテムごとの最新版に"feedback\_mail\_list"のデータがあるかどうか、チェックする
> 
> 　"feedback\_mail\_list"のデータがある場合、フィードバックメールの情報を取得する
> 
> (3)アイテムごとの統計情報を「invenio-stats」から「get\_list\_statistic\_data」メソッドで取得する
> 
> 　・閲覧回数
> 
> 　　アイテムID及び統計期間（年、月）の情報を元に「get\_item\_view」メソッドでアイテムごとの閲覧回数を取得する
> 
> 　・ファイルダウンロード回数
> 
> 　　バケツID（bucket\_id）及びファイル名及び統計期間（年、月）の情報を元に、「get\_item\_download」メソッドでファイルダウンロード回数を取得する
> 
> (4)フィードバックメール送信先ごとにアイテムをまとめ、以下の情報を合計する
> 
> 　・アイテム総数
> 
> 　・ファイル総数
> 
> 　・閲覧回数合計
> 
> 　・ファイルダウンロード回数合計
> 
> (5)送信除外対象者を「get\_banned\_mail」メソッドで取得し、送信除外対象者一覧に含まれてないメールアドレスへフィードバックメール送信を実施する
> 
> 　・送信が完了した後、送信履歴をデータベースに保存する
> 
> 　　テーブル名：feedback\_mail\_history
> 
> 　　履歴内容：id、start\_time、end\_time、stats\_date、total\_mail、failed\_mail
> 
> 　・送信が失敗になる場合、送信が失敗する情報をデータベースに保存する
> 
> 　　テーブル名：feedback\_mail\_failed
> 
> 　　履歴内容：id、history\_id、author\_id、mail
> 
> (6)送信履歴を【Admin \> Statistics \> Feedback Mail画面】に表示させる
> 
> 　送信失敗行にて、送信できなかった件数（「エラー」カラム）をアンカーで表示する
> 
> フィードバックメールを再送信する処理に対して「resend\_failed\_mail」のAPIを実施する  
> 再送信結果をデータベースでの該当レコードに更新する

3\. 手動実行

タスクを呼び出すことで任意のタイミングでフィードバックメールを送信する。

|                                                                           |
| ------------------------------------------------------------------------- |
| celery -A invenio\_app.celery call weko\_admin.tasks.send\_feedback\_mail |

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### Item Registration：インデックス指定

  - > 目的・用途

Item Registrationの一部として、登録先インデックスを指定する。

  - > 利用方法

ワークフローで登録先インデックスを指定している場合、アイテムの登録先インデックスはユーザの操作によらずワークフローで指定したものが設定され、インデックス指定はスキップされる。

ワークフローで登録先インデックスを指定していない場合、アイテムの登録先インデックスは画面上の操作によって設定される。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>※</td>
<td></td>
</tr>
</tbody>
</table>

※一般ユーザーは、ロールとして利用可能に設定することはできないが、個別のユーザーをAction Userとして設定することはできる。

  - > 機能内容

1\. ワークフローの登録先インデックスの設定

  - 【Administration \> ワークフロー管理（WorkFlow） \> ワークフロー（WorkFlow List）画面】で、各ワークフローの登録先インデックスを指定することができる。  
    詳細は、管理機能の[ADMIN-7-2: ワークフロー](#ワークフロー-2)を参照

2\. インデックスを指定する

  - 1\. で登録先インデックスを指定していないワークフローでのItem Registrationであることを前提とする。

  - インデックスツリーからアイテムを所属させるインデックスにチェックを入れる  
    アイテムは同時に複数のインデックスに所属させることができる

  - チェックしてインデックス名が「インデックス指定」（DESIGNATE INDEX）エリアに表示される

  - インデックスを指定した後、［次へ（Next）］ボタン、または「保存」（Save）ボタンを押す場合
    
      - 該当アイテムタイプのマッピングには、問題がある場合、エラーメッセージを表示する  
        エラーメッセージ：「Please make sure the item type mapping is correct.」
    
      - 問題ない場合、該当ワークフローでのステップに進める

  - インデックスを指定しないと、［次へ（Next）］ボタン、または［保存（Save）］ボタンを押すと、エラーメッセージを表示する  
    エラーメッセージ：「At least one index should be selected.」

  - ［強制終了（Quit）］ボタンを押すと、確認ダイヤログを表示する  
    メッセージ：JP：「このアクティビティを終了してもよろしいですか？」  
    　　　　　　EN：「Are you sure you want to quit the activity?」
    
      - ［継続（Continue）］ボタンを押すと、該当アクティビティが強制終了とする
    
      - ［キャンセル（Cancel）］ボタンを押すと、確認ダイヤログを閉じる

  - ［戻る（Back）］ボタンを押すと、「アクティビティ一覧」画面に移動する

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > 「weko\_deposit」：ESとrecords\_metadataテーブルへの登録を行う

  - > 「weko\_items\_ui」：ワークフローで登録先インデックスを指定している場合には、ここからweko\_depositの登録処理を呼び出す

  - > 「weko\_workflow」：アクティビティ全体の管理を行う

<!-- end list -->

  - > 処理概要

> アイテムの編集を行う場合、「Item Resistration」のアクション開始時に、get\_pid\_and\_recordメソッドで登録先インデックスの情報を取得する
> 
> 画面でインデックスを指定して［次へ（Next）］ボタンを押すと、weko\_depositのcommitメソッドでESとrecords\_metadataテーブルへの登録を行う
> 
> ワークフローで登録先インデックスを指定している場合には、画面にてweko\_items\_uiのiframe\_items\_indexメソッドを呼び出し→iframe\_items\_indexメソッド中でupdate\_index\_tree\_for\_recordメソッドを呼び出し→update\_index\_tree\_for\_recordメソッド中でweko\_depositのcommitメソッドを呼び出してESとrecords\_metadataテーブルへの登録を行う

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### Identifier Grant

  - > 目的・用途

<!-- end list -->

  - DOI未付与、かつDOI取り下げ済みではないアイテムに対してはDOIを付与する事が可能である

  - DOIのURL形式：\<ルートURL\>/\<Prefix\>/\<suffix\>
    
      - \<ルートURL\>：コンフィグファイルでの設定
    
      - \<Prefix\>：アドミン画面に指定されている値
    
      - \<suffix\>：コンフィグファイルでの設定値によって異なる

  - ハンドルのURL形式：\<ハンドルのURL\>/\<Prefix\>/\<ハンドルローカル名\>
    
      - \<ハンドルのURL\>：コンフィグファイルでの設定
    
      - \<Prefix\>：「handle\_creds.json 」ファイルに設定値  
        キー："prefix"
    
      - \<ハンドルローカル名\>：LHS（Local Handle Server）から返却される値で、ユニークの値

  - 外部機能として、  
    WEKOからDOI付与申請を行う場合は、IRDBのハーベスト処理で学術機関リポジトリデータベース(IRDB)を経由して、  
    JaLCに対してDOI付与を申請する事が可能である  
    　WEKO -\> IRDB -\> JaLC

<!-- end list -->

  - > 利用方法

ワークフロー一覧にて、ワークフローを選択後、「Identifier Grant」アクションが表示される。

※ワークフローのアクションの１つとして、「Identifier Grant」アクションが定義されていることが前提である

　ワークフローによっては、アクションの順番が異なるため、他のアクションから「Identifier Grant」アクションに遷移することもある

「Identifier Grant」アクションで必要な情報を選択／入力後、\[次へ\]ボタンを押下することで、次のアクションに進む。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>※</td>
<td></td>
</tr>
</tbody>
</table>

※一般ユーザーは、ロールとして利用可能に設定することはできないが、個別のユーザーをAction Userとして設定することはできる。

  - > 機能内容

DOI付与の種類

現在4つのDOI付与を以下のように対応している

  - JaLC DOI

  - JaLC CrossRef DOI

  - JaLC DataCite DOI

  - NDL JaLC DOI

1\. 構成

1.1. 外部からの設定

  - HANDLEツール（https://www.handle.net/tech\_manual/HandleTool\_Ver2.pdf）

  - CNRIのHANDLEツールを使い、ハンドルアクセスのURLを要求する。

1.2. 管理者からの設定

  - 【Administration \> 設定（Setting） \> 識別子（Identifier） \> 作成（Create）画面】
    
      - 「Prefix」領域より、テナント別に各DOI発行機関のプレフィックス情報を設定  
        　　プレフィックス設定項目：Reposiitory(必須)、JaLC DOI、JaLC CrossRef DOI、JaLC DataCite DOI、NDL JaLC DOI
    
      - 「Suffix」領域より、テナント別にサフィックスの前半部分を設定  
        　　サフィックス設定項目：Reposiitory(必須)、Semi-automatic suffix
    
      - 「Enable/Disable」領域より、テナント別に各DOI発行機関の利用可否を設定

  - 【Administration \> ワークフロー管理（WorkFlow） \> フロー（Flow List） \> Create Flowの画面】
    
      - フローにて「Item Registration」のアクション後に「Identifier Grant」のアクションを定義

  - 【Administration \> ワークフロー管理（WorkFlow） \> ワークフロー（WorkFlow List） \> Create WorkFlowの画面】
    
      - 「Identifier Grant」がフローに含まれるワークフローを定義

2\. 機能

2.1. 前提条件

  - 機能内容の「1. 構成」、処理概要の「2. サーバー設定」のように設定済みである

2.2. 識別子付与画においてDOI発行機関を選択可能

  - 選択肢
    
      - Not Grant（デフォルト）
    
      - JaLC DOI
    
      - JaLC CrossRef DOI
    
      - JaLC DataCite DOI
    
      - NDL JaLC DOI

2.3. PID発行機関が指定するメタデータ制約条件に基づきバリデート

  - 「Identifier Grant」画面から\[次へ（Next）\]ボタン押下時に、設定したPID発行機関と、アイテムの入力値を以下の資料で比較する  
    　　PID付与の制約条件の資料：　別紙「JPCOARv2\_JaLC\_Guideline\_appendix\_ver1.pdf」
    
      - 添付のPID付与の条件を満たしている場合  
        　・　\[次へ（Next）\]ボタン押下で次のアクションに進める
    
      - 添付のPID付与の条件を満たしていない場合  
        　・　「Item Registration」画面に遷移する  
        　・　画面上に「PID付与の条件を満たしていません。」とエラーメッセージを表示する  
        　・　制約条件と不適合なアイテムの項目の枠を、太い赤枠に変更する  
        　・　「Identifier Grant」アクションのステータスは「やり直し」となる

  - DOIの付与、削除等に関わらず、すべてのパターンでバリデーションチェックを実施する

  - JPCOARスキーマ ver.2.0において追加された資源タイプについて、以下の表に従いチェックを行う。バリデーション対象は設定ファイル（weko\_workflow/config.py）のDOI\_VALIDATION\_INFO、DOI\_VALIDATION\_INFO\_CROSSREF、DOI\_VALIDATION\_INFO\_DATACITEで指定する。
  - 「NDL JaLC DOI」を選択している場合、資源タイプ(dc:type)は「doctoral thesis」のみ許可される。それ以外を指定している場合、「Item Registration」画面に遷移し、「NDL JaLCに割り当てる場合、資源タイプは「doctoral thesis」である必要があります。」とエラーメッセージを表示する

| **資源タイプ（dc:type）**                                                                                                                                                                                                                                                                                                                                             | **コンテンツ種別**          |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------- |
| other, conference paper, data paper, departmental bulletin paper,editorial, journal article,periodical, review article,article,newspaper,software paper                                                                                                                                                                                                        | journalarticle\_type |
| thesis, bachelor thesis, master thesis,doctoral thesis                                                                                                                                                                                                                                                                                                         | thesis\_types        |
| technical report, research report, report,book, book part                                                                                                                                                                                                                                                                                                      | report\_types        |
| learning object, learning material                                                                                                                                                                                                                                                                                                                             | elearning\_type      |
| software, dataset, aggregated data,clinical trial data, compiled data, encoded data, experimental data, genomic data,geospatial data, laboratory notebook, measurement and test data,observational data, recorded data, simulation data,survey data, source code                                                                                               | dataset\_type        |
| internal report, policy report, report part,working paper, interactive resource,musical notation, research proposal,technical documentation, workflow,other, sound, patent,cartographic material, map, lecture, image,still image, moving image, video,conference object, conference proceedings,conference poster,manuscript, data management plan, interview | datageneral\_types   |

2.4. DOIを付与

  - DOI発行機関の選択肢から「Not Grant」を選択すると、付与を実施しない

  - 取り下げたアイテムはDOIを付与できない
    
      - DOIを一度取り下げたアイテムでは、  
        \[Identifier Grant\]アクション画面において DOIを付与できない旨のメッセージを表示し、当該アクションの実行はできない
    
      - メッセージ：「DOIを取り下げたアイテムにはDOIを付与できません」

  - 付与条件を満たしている場合、DOIを一度だけ付与する

  - コンフィグファイルでの設定値通りに、識別子付与画面にDOI発行のサフィックス表示を調整可能
    
      - 詳細は処理概要の「2. サーバー設定」を参照

  - サフィックス表示ごとにDOIを付与
    
      - ①自動連番の方法でのサフィックス（IDENTIFIER\_GRANT\_SUFFIX\_METHOD：0）  
        ・ 「Identifier Grant」画面に、設定されるプレフィックスおよびサフィックスを表示し、エンドユーザ側の設定は無し  
        ・ サフィックス値：RecordIDを設定する  
        　そのとき、サフィックスの桁数は10桁とし、RecordIDが10桁未満の場合は0埋めして設定する
    
      - ②半自動入力でのサフィックス（IDENTIFIER\_GRANT\_SUFFIX\_METHOD：1）  
        ・ 「Identifier Grant」画面に設定されるプレフィックスおよびサフィックスの前半部分を表示し、サフィックスの後半部分を入力可能  
        　　入力されたサフィックスの書式は以下の条件を満たすかどうかチェックする  
        　　-【条件】　　　　+ 「info:doi/\[DOIのPrefix\]/\[入力値\]」が255文字以内である  
        　　　　+ 他のアイテムで既に使用されているDOIではない  
        　　　　+ 取り下げられたDOIではない  
        　　　　+ DOIが入力されている(未入力ではない)  
        　　- 条件を満たしている場合、次のアクションに進める  
        　　- 条件を満たしていない場合、画面上にエラーメッセージを表示し、次のアクションには進めない  
        　　　　+ 未入力の場合：「DOIが入力されていません。」  
        　　　　+ エラーメッセージの内容は、該当条件のエラー内容を以下のように表示する　　　　　 (1)入力値が255文字を超えています  
        　　　　　 (2)他のアイテムで既に使用されているDOIのため、他のDOIを入力してください  
        　　　　　 (3)このDOIは取り下げられたため、他のDOIを入力してください  
        　　　　　 (4)DOIが入力されていません
    
      - ③自由入力でのサフィックス（IDENTIFIER\_GRANT\_SUFFIX\_METHOD：2）  
        ・ 「Identifier Grant」画面に設定されるプレフィックスを表示し、サフィックスを入力可能  
        ・ 入力されたサフィックスの書式チェックと処理は「半自動入力でのサフィックス」のような同じになる
      - NDL JaLC DOIの選択肢はIDENTIFIER_GRANT_SUFFIX_METHODの値にかかわらず③自動入力のサフィックスとなる

  - インデックス状態が「公開」かつハーベスト公開が「公開」であるインデックスとリンクしていない場合は登録・更新を認めない  
    　日本語：アイテムにDOIを付与する場合、インデックス状態が「公開」かつハーベスト公開が「公開」のインデックスとの関連付けが必要です。  
    　英語：When assigning a DOI to an item, it must be associated with an index whose index status is "Public" and Harvest Publishing is "Public".

  - 必須のマッピング項目がひとつのアイテムタイプ内に複数ある場合、複数あるうちのひとつに入力されていれば、DOI付与の条件を満たすものとする

  - DOI付与済みアイテムを新規登録後、編集時に必須項目の値の削除や必須項目のプロパティの削除はできない。  
    削除をした場合、［Identifier Grant］画面から［Item Registration］画面に遷移し、「PID付与の条件を満たしていません。」とエラーメッセージが表示される。

  - 編集時の資源タイプ（dc:type）の変更は、同じコンテンツ種類内でのみ許可される。それ以外の資源タイプにを変更した場合、インポートタブのチェック処理で「DOI付与済みアイテムの資源タイプの変更はできません。」とエラーメッセージが表示される。

2.5. 付与済みDOI及びCNRIハンドルを表示

　 アイテム詳細画面の パーマリンクエリアにDOIのURLを表示する

2.6. アイテムに付与したDOIを取り下げ

  - アイテム登録者は、アイテムに付与されたDOIを取り下げることができる  
    　　 (1) DOIが付与されたアイテムでは、 \[Identifier Grant\]アクション画面において \[DOIの取り下げ（Withdraw DOI）\]ボタン が表示される  
    　　　\[DOIの取り下げ（Withdraw DOI）\]ボタンを押さずに次アクションに進むことはできる

  - 　　(2) DOIを取り下げる場合は、\[DOIの取り下げ（Withdraw DOI）\]ボタンを押す  
    　　(3) \[DOIの取り下げ（Withdraw DOI）\]ボタンを押すと、確認メッセージとパスワード入力画面がモーダル表示される  
    　　　・ 取り下げをキャンセルする場合は、\[Cancel\]ボタンを押す  
    　　　・ 取り下げを続行する場合は、パスワード「DELETE」を入力のうえ\[継続（Continue）\]ボタンを押す  
    　　(4) 入力パスワードが正しい場合は、モーダル表示を閉じ、DOIを取り下げる．パスワードは大文字で「DELETE」  
    　　　・ DOIが取り下げられた旨のメッセージを表示する  
    　　　・ アイテムメタデータ項目のうち\[jpcoar:identifierRegistration\]（ID登録）にマッピングされるデータを空白にする  
    　　　・入力パスワードが正しくない場合は、メッセージ「Invalid password」を表示する。

  - また、DOIを取り下げたアイテムに対して、以下の対応もおこなう
    
      - パーマリンク表示は、もとのアイテム詳細URLに戻す

2.7. DOI及びハンドルのPIDステータスを管理

  - 【Administration \> レコード管理（Records） \> 永続識別子（Persistent Identifier）画面】にてPIDステータスを確認可能  
    　「PID Type」：doi/hdl  
    　「status」：REGISTERED/DELETED

  - DOI及びハンドルのPIDステータスは以下のテーブルに管理している。（－：ステータス管理しない）

| **PIDステータス** | **説明**                                                         | **DOI** | **ハンドル** | **対応箇所** |
| ------------ | -------------------------------------------------------------- | ------- | -------- | -------- |
| 登録済み         | DOIが登録された状態。                                                   | ○       | ○        | ○        |
| 取り下げ済み       | DOIが取り下げられた状態。DOI発行機関のAPIでコールが返ってくることを確認後「DOI取り下げ済み」のステータスとする。 | ○       | －        | ○        |

2.8. CNRIハンドルを付与

  - アイテムの新規登録時にクライアントからハンドルアクセスが要求され、  
    設定情報に基づき、クライアントのハンドルアクセスはリダイレクトされる

  - 「4.1. 前提条件」を満たしていると、アイテムの新規登録時にハンドルは必ずおこなわれる

  - アイテムに対してDOIを1つのみ付与できる制御について、CNRIを対象から外す

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > 「weko\_workflow」識別子付与全般を管理する

  - > 「weko\_handle」：register\_handleメソッドでCNRIハンドルを付与する

<!-- end list -->

  - > 処理概要

1\. 使用しているライブラリ

なし

2\. サーバー設定

> WEB環境にてCNRIローカルハンドルサーバ認証情報を設定

  - > weko\_handle.config.WEKO\_HANDLE\_CREDS\_JSON\_PATH に指定したディレクトリを作成  
    > デフォルト： /code/modules/resources  
    > ※「modules/weko-handle/weko\_handle/config.py」でのコンフィグをベースとする

> mkdir modules/resources

  - > 「cnri-handle」フォルダーから、「handle\_creds.json」を以下のコマンドでコピー

> cp ../cnri-handle/creds.json modules/resources/handle\_creds.json

  - > プライベートキーをコピー

> cp ../cnri-handle/privatekey.pem modules/resources/
> 
> cp ../cnri-handle/certificate\_only.pem modules/resources/
> 
> cp ../cnri-handle/privatekey.pem .
> 
> cp ../cnri-handle/certificate\_only.pem .

  - > ビルドを実施

> docker-compose exec web invenio collect -v && docker-compose exec web invenio assets build && docker-compose restart web

  - > ハンドル登録が失敗になる場合、ハンドルサーバーのキャッシュを削除する必要である。  
    > エラーのサンプル：

> \[2020-05-27 07:34:14,129\] ERROR in api: Handle 20.500.12465/0000000003 already exists: Could not register handle.
> 
> CNRIハンドルのURLをコンフィグファイルに設定

  - > コンフィグキー：WEKO\_SERVER\_CNRI\_HOST\_LINK

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-workflow/weko_workflow/config.py#L114>

> サフィックスの設定方法をコンフィグファイルに設定

  - > コンフィグキー：IDENTIFIER\_GRANT\_SUFFIX\_METHOD

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-workflow/weko_workflow/config.py#L56>

  - > 設定値：0、1、2  
    > 　　0：自動連番  
    > 　　1：半自動入力  
    > 　　2：自由入力

> 各DOI発行機関のルートURLをコンフィグファイルに設定

  - > コンフィグキー：IDENTIFIER\_GRANT\_LIST

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-workflow/weko_workflow/config.py#L48>

> invenio.cfg のコンフィグに設定しているものでオーバーライドできるように、current\_app.configを以下のように設定する
> 
> current\_app.config\['IDENTIFIER\_GRANT\_SUFFIX\_METHOD'\]
> 
> ※invenio.cfg に設定されないときのために、デフォルト値が設定されるよう weko\_workflow/config.py の「IDENTIFIER\_GRANT\_SUFFIX\_METHOD」は残す
> 
> modules/weko-handle/weko\_handle/config.py について
> 
> 12 WEKO\_HANDLE\_BASE\_TEMPLATE= 'weko\_handle/base.html'
> 
> 13 """Default base template for the demo page."""
> 
> 14
> 
> 15 WEKO\_HANDLE\_CREDS\_JSON\_PATH = '/code/modules/resources/handle\_creds.json'
> 
> 16 """Default dir contain Handle Cred Json."""
> 
> 17
> 
> 18 WEKO\_HANDLE\_ALLOW\_REGISTER\_CRNI = False
> 
> 19 """Allow registering CNRI."""

  - > 各パラメタについて、weko\_hanl.config.WEKO\_HANDLE\_CREDS\_JSON\_PATH をinvenio.cfg で指定した値で上書きし、利用できるように対応する

3\. 実装方法

「Item Registration」アクションから次のアクションに移動する時、アイテムにCNRI項目がなく、コンフィグでWEKO\_HANDLE\_ALLOW\_REGISTER\_CNRI = Trueである場合に、以下の処理を実施している。

> CNRIハンドルをregister\_handleメソッドで付与する

  - > LHS（Local Handle Server）にハンドルの登録を要求する  
    > ・ 登録が成功すると、LHSからハンドルアクセスのサフィックスが返却される。そうしたら、IdentifierHandle.register\_pidstoreメソッドでハンドル情報をデータベースでの「pidstore\_pid」テーブルに保存する  
    > ・ LHSからエラーを返却する場合、エラー内容をログファイルに出力する

> 「pidstore\_pid」テーブルの情報

<table>
<thead>
<tr class="header">
<th><strong>カラム名</strong></th>
<th><strong>DOI</strong></th>
<th><strong>HDL</strong></th>
<th><strong>備考</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>id</td>
<td>自動採番</td>
<td>自動採番</td>
<td>-</td>
</tr>
<tr class="even">
<td>pid_type</td>
<td>doi</td>
<td>hdl</td>
<td>-</td>
</tr>
<tr class="odd">
<td>pid_value</td>
<td>DOIのURL</td>
<td>HDLのURL</td>
<td>-</td>
</tr>
<tr class="even">
<td>pid_provider</td>
<td>-</td>
<td>-</td>
<td>-</td>
</tr>
<tr class="odd">
<td>status</td>
<td>R/D</td>
<td>R</td>
<td>R: Registered<br />
D: Deleted</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>object_type</td>
<td>rec</td>
<td>rec</td>
<td>-</td>
</tr>
<tr class="even">
<td>object_uuid</td>
<td>該当レコードのuuid値</td>
<td>該当レコードのuuid値</td>
<td>「records_metadata.id」から取得</td>
</tr>
<tr class="odd">
<td>created</td>
<td>作成日付</td>
<td>作成日付</td>
<td>-</td>
</tr>
<tr class="even">
<td>updated</td>
<td>更新日付</td>
<td>更新日付</td>
<td>-</td>
</tr>
</tbody>
</table>

「Identifier Grant」アクションの開始時に、doi\_identifierテーブルから識別子情報を取得する。

> リクエストからコミュニティIDを取得して、doi\_identifierテーブルのrepositoryと一致するものを取得する

  - > リクエストにコミュニティIDが含まれない場合は、repositoryが「Root Index」であるものを取得する

【補足】

> ワークフローのアクションで、「Identifier Grant」→「Item Registration」の順序だった場合、DOIは付与されない  
> ※「Identifier Grant」アクションには、「Not Grant」のみが表示される
> 
> \[DOIの取り下げ（Withdraw DOI）\]押下後、withdraw\_confirmメソッドでパスワードを参照する。

  - > 入力パスワードが正しい場合、アクティビティのworkflow\_action\_identifierを更新する。

> 「いずれか必須」のバリデーションチェックは以下の通り

1.  > Identifier Grant画面にDOI付与し、「Next」ボタンを押下すると、next\_actionメソッド中でcheck\_doi\_validation\_not\_pass メソッドを呼び出してDOIバリデーションチェックを行う

2.  > PID付与の制約条件表 (JPCOAR\_JaLC\_Guideline\_appendix\_v1.pdf ) を元に、資源タイプと、「いずれか必須」を指定しているDOIタイプの2つ条件をベースにチェックを行う
    
      - > 例：

> 資源タイプが「software」あるいは「dataset」、かつDOIタイプ：JaLCの場合、「いずれか必須」の項目は「位置情報」の以下の３つ項目となっている  
> 位置情報（点）、位置情報（空間）, 位置情報（自由記述）
> 
> <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-workflow/weko_workflow/utils.py#L338>
> 
> <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-workflow/weko_workflow/utils.py#L382>
> 
> <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-workflow/weko_workflow/utils.py#L653-L684>

3.  > 「いずれか必須」の項目を入力されたかをチェックするために、validattion\_item\_property\_either\_required関数を呼び出す

> <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-workflow/weko_workflow/utils.py#L641>

  - > 「いずれか必須」の項目のいずれかを入力された場合、エラーなしとして結果を返却する

  - > 「いずれか必須」の項目のいずれかも入力されない場合、エラーとして、エラーとなっている項目名の一覧を返却する

<!-- end list -->

4.  > アイテム登録画面に遷移する

> <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-workflow/weko_workflow/views.py#L1541-L1550>

5.  > アイテム登録画面にて、check\_validation\_error\_msgのAPIを呼び出し、返却された項目名一覧を取得し、赤文字で画面に表示する

> <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-items-ui/weko_items_ui/static/js/weko_items_ui/app.js#L2261-L2281>
> 
> <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-items-ui/weko_items_ui/views.py#L359-L363>
> 
> <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-items-ui/weko_items_ui/utils.py#L691-L697>

6.  > アイテム登録画面にて「いずれか必須」の項目を入力されたかチェックする

> <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-items-ui/weko_items_ui/static/js/weko_items_ui/app.js#L3904>
> 
> 入力された場合、次の画面に遷移する

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/11/11</p>
</blockquote></td>
<td>V09.27</td>
<td></td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>
### Item Link

  - > 目的・用途

本機能は、システムに登録している他のアイテムを関連付ける機能である。

  - > 利用方法

「Item Link」アクションを含むフローを使ったワークフローによるアクティビティを開始していることを前提とする。

フローで「Item Link」アクションより前に設定されたアクションが完了すると、「Item Link」アクションが表示される。

「Item Link」アクションで関連アイテムを指定後、\[次へ\]ボタンを押下することで、次のアクションに進む。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>※</td>
<td></td>
</tr>
</tbody>
</table>

※一般ユーザーは、ロールとして利用可能に設定することはできないが、個別のユーザーをAction Userとして設定することはできる。

  - > 機能内容

1\. 登録者として、アイテム間リンクを設定する

  - 【前提条件】
    
      - 【Administration \> ワークフロー管理（WorkFlow） \> フロー（Flow List） \> Create Flowの画面】「Item Registration」のアクション後に「Item Link」のアクションを行うフローを定義する
    
      - 【Administration \> ワークフロー管理（WorkFlow） \> ワークフロー（WorkFlow List） \> Create WorkFlowの画面】  
        「Item Link」がフローに含まれるワークフローを定義する

  - 【Item Link】画面にアイテム間リンクを設定する
    
      - インデックスツリーから任意のインデックスを選択する
        
          - 選択したインデックス名が「インデックスを指定」（Designate Index）エリアに表示される
        
          - 選択インデックス配下のアイテムが「アイテムリンク」(ItemLink）エリアに一覧表示される  
            一覧表示ソートは、アイテム検索結果一覧のデフォルトソートと同じとする
            
              - 「アイテムリンク」(ItemLink）エリアに表示項目は以下の通りである
                
                  - No.
                
                  - Title：アイテムのタイトル
                
                  - Item Type：対象アイテムタイプ
                
                  - Add
    
      - アイテム間リンクを設定したいアイテムの「Add」列に「+」ボタンを押すと、アイテムリンク表の上部にアイテム間リンクの関係性選択のプルダウンが表示される
    
      - プルダウンから関係性を選択する
    
      - 「Delete」ボタンを押すと、設定済みのアイテム間リンクを削除する

  - 「送信」（Next）ボタンを押すと、設定されたアイテム間リンクの情報をデータベースに保存し、ワークフロー定義通りの次アクションに進む

  - 「保存」（Save）ボタンを押すと、設定されたアイテム間リンクや入力したコメントの情報をデータベースに保存する。ワークフローを抜けた後、再度アクティビティを起動しても、設定したアイテム間リンクや、入力したコメントを保持したままとする

  - 選択したアイテム間リンク情報は、  
    JPCOARスキーマの jpcoar:relation -\> relationType にマッピングしてアイテムメタデータとして登録する

  - アイテム間の関係性：

| 関連性              | 内容           | junii2 | JPCOAR |
| ---------------- | ------------ | ------ | ------ |
| relateTo         | 関連している       |        |        |
| isVersionOf      | 異版である        | ○      | ○      |
| hasVersion       | 異版あり         | ○      | ○      |
| isReplacedBy     | 置換される        | ○      | ○      |
| replaces         | 置換する         | ○      | ○      |
| isRequiredBy     | 要件とされる       | ○      | ○      |
| requires         | 要件とする        | ○      | ○      |
| isPartOf         | 部分である        | ○      | ○      |
| hasPart          | 部分を持つ        | ○      | ○      |
| isReferencedBy   | 参照される        | ○      | ○      |
| references       | 参照する         | ○      | ○      |
| isFormatOf       | 別フォーマットである   | ○      | ○      |
| hasFormat        | 別フォーマットあり    | ○      | ○      |
| isSupplementedBy | ～によって補足されている |        | ○      |
| isSuppllementTo  | ～を補足している     |        | ○      |
| isIdenticalTo    | ～と同一である      |        | ○      |
| isDeriverdFrom   | ～に由来している     |        | ○      |
| isSourceOf       | ～の由来になっている   |        | ○      |
| isCitedBy        | ～によって引用されている |        | ○※     |
| Cites            | ～を引用している     |        | ○※     |

※JPCPAR2.0で追加（https://schema.irdb.nii.ac.jp/ja/schema/2.0/20）

2\. 設定されたアイテム間リンクを表示する

  - 設定されたアイテム間リンクは、アイテム詳細表示画面の「リンク」（Link）項目として表示される
    
      - リンクはリンク先アイテムの タイトルリンク とする  
        （複数アイテムあった場合はすべてのリンクを表示する）
    
      - リンクを選択すると、 リンク先アイテムのアイテム詳細表示画面に遷移する

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_workflow

  - > weko\_records：「get\_item\_link\_info」メソッドで、既存のアイテム間リンクの情報を取得する

  - > weko\_search\_ui：インデックスツリーからインデックスを選択したときに、「search」メソッドが呼び出される。「search」メソッドの中で「get\_item\_link\_info」メソッドを呼び出している

<!-- end list -->

  - > 処理概要

実装方法

> 新規アイテム登録時、アイテム間リンクを設定する処理

  - > アイテム間リンクの設定画面を表示する

> 「action\_endpoint 'item\_link'」の場合、以下の定義からアイテム間の関係性を取得、以下のテンプレートで取得した情報を表示する

  - > アイテム間の関係性の定義： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-workflow/weko_workflow/static/js/weko_workflow/workflow_item_link.js#L387>

  - > テンプレート： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-workflow/weko_workflow/templates/weko_workflow/item_link.html>

<!-- end list -->

  - > 「送信」（Next）または「保存」（Save）ボタンを押すと、設定されたアイテム間リンクや入力したコメントの情報をデータベースに保存する
    
      - > データベースの情報
        
          - > テーブル名：item\_reference
        
          - > フィールド名：

> ・src\_item\_pid
> 
> ・dst\_item\_pid
> 
> ・reference\_type
> 
> ・created
> 
> ・updated
> 
> アイテム編集時、アイテム間リンクを設定する処理

  - > アイテム間リンクの設定画面を表示する  
    > 「action\_endpoint 'item\_link'」の場合、及び該当アイテムのメタデータにアイテム間リンクの情報が存在している場合、「get\_item\_link\_info」メソッドで設定されたアイテム間リンクの情報を取得する
    
      - > 「get\_item\_link\_info」メソッドは、画面表示時とインデックス選択時に呼び出される
        
          - > 「get\_item\_link\_info」メソッドは、item\_referenceテーブルからsrc\_item\_pidフィールドと引数recidが一致するレコードをあるだけ取得して、加工したものを返す。
        
          - > src\_item\_pidフィールドは整数で保存されている。
        
          - > 画面表示時には、recidに使用する値が小数であってもそのまま「get\_item\_link\_info」メソッドを呼び出す。
        
          - > インデックス選択時には、recidに使用する値は小数点以下を切り捨てて「get\_item\_link\_info」メソッドを呼び出す。

  - > 「送信」（Next）または「保存」（Save）ボタンを押すときの処理は、新規アイテム登録時の処理と同じである

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### OA Policy Confirmation（現在非対応）

※本機能はv0.9.22時点で非対応の機能だが、ソース上に残っているため機能仕様書としては既存のものを残す。

  - > 目的・用途

本機能は、SHERPA/RoMEOのオープンアクセスポリシー情報を確認できる機能である。

  - > 利用方法

ワークフロー一覧にて、ワークフローを選択後、「OA Policy Confirmation」アクションが表示される。

※ワークフローのアクションの１つとして、「OA Policy Confirmation」アクションが定義されていることが前提である

　ワークフローによっては、アクションの順番が異なるため、他のアクションから「OA Policy Confirmation」アクションに遷移することもある

「OA Policy Confirmation」アクションで雑誌名の情報を選択後、\[次へ\]ボタンを押下することで、次のアクションに進む。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

1\. SHERPA/RoMEOのオープンアクセスポリシー情報を確認する

  - 【前提条件】
    
      - 【Admin \> WorkFlow \> Flow List \> Create Flowの画面】  
        フローにて「OA Policy Confirmation」のアクションを定義する
    
      - 【Admin \> WorkFlow \> WorkFlow List \> Create WorkFlowの画面】  
        「OA Policy Confirmation」がフローに含まれるワークフローを定義する

  - SHERPA/RoMEOのオープンアクセスポリシー情報を確認する
    
      - 【OAポリシー確認画面】での「ジャーナル」（Journal）テキストボックスに検索文字列を入力する
        
          - SHERPA/RoMEOへのインクリメンタルサーチを可能とする
        
          - 検索結果を一覧に表示する
    
      - 検索結果より任意の雑誌を選択すると、同一画面上に以下の当該雑誌情報を表示する
        
          - 雑誌名　+　SHERPA/RoMEO詳細表示画面への\[Detail\]リンク
        
          - RoMEOの情報（RoMEO colours）  
            <http://www.sherpa.ac.uk/romeoinfo.html#colours>
        
          - 「Paid OA」の情報
    
      - 「次へ」（Next）ボタンを押すと、次アクションに進む
        
          - 選択した雑誌名の情報がJPCOARマッピングを元に、アイテム登録画面に自動入力される  
            JPCOARの項目：「jpcoar:sourceTitle」
    
      - 「保存」（Save）ボタンを押すと、設定内容を保存する

  - SHERPA/RoMEO検索APIから取得するリクエスト結果を、Redisを利用してキャッシュDB化する  
    また、RedisのTTLはコンフィグ設定可能とする【確認必要】

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - 
<!-- end list -->

  - > 処理概要

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>

## Approval

  - > 目的・用途

本機能は、ワークフローにて、入力したメタデータの内容を認証する機能である。

本機能は承認者が使用することができる。

  - > 利用方法

承認者は、入力したデータの内容を認証（承認・却下・差し戻し）することができる。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>※</td>
<td></td>
</tr>
</tbody>
</table>

※一般ユーザーは、ロールとして利用可能に設定することはできないが、個別のユーザーをAction Userとして設定することはできる。

  - > 機能内容

1\. 承認者として、入力したメタデータの内容を認証する

  - 【前提条件】
    
      - 【Administration \> ワークフロー管理（WorkFlow） \> フロー（Flow List） \> Create Flowの画面】「Approval」のアクションを含むフローを定義する
    
      - 【Administration \> ワークフロー管理（WorkFlow） \> ワークフロー（WorkFlow List） \> Create WorkFlowの画面】  
        「Approval」がフローに含まれるワークフローを定義する

  - 入力したメタデータの内容を認証する
    
      - 「Approval」画面にて、「承認」（Approval）ボタンを押すと、アイテム登録が完了とする
    
      - 「Approval」画面にて、「保存」（Save）ボタンを押すと、入力したメタデータの内容を保存する
    
      - 「Approval」画面にて、「却下」（Reject）ボタンを押すと、ワークフローの１つ前アクションに戻る
    
      - 「Approval」画面にて、「強制終了」（Quit）ボタンを押すと、確認ダイヤログを表示する

> メッセージ：JP：「このアクティビティを終了してもよろしいですか？」  
> 　　　　　　EN：「Are you sure you want to quit the activity?」

  - 「継続」（Continue）ボタンを押すと、該当アクティビティが強制終了とする

  - 「キャンセル」（Cancel）ボタンを押すと、確認ダイヤログを閉じる

<!-- end list -->

  - 「Approval」画面へのアクセス権限がかけられる
    
      - ゲストユーザーに対してログイン画面に移動する
    
      - 権限がないユーザーに対して「権限が必要です」（Permission required）とのメッセージを表示する

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_workflow

<!-- end list -->

  - > 処理概要

> ［次へ（Next）］ボタンを押すと呼び出されるnext\_actionメソッド中で、action\_endpointが'approval'であるときに承認処理を行う。

  - > この後にアクションがない場合、メッセージ「server error」が表示されて承認に失敗する。
    
      - > ログにはメッセージ「next\_action: can not get next\_flow\_action」が出力される。

  - > アクティビティ中で識別子を付与する設定を行っていた場合、saving\_doi\_pidstoreメソッドで付与を行う。

  - > フィードバックメールを送信する設定になっている場合、update\_by\_list\_item\_idメソッドでfeedback\_mail\_listテーブルを更新する。

> 直後のアクションが「End」である場合、end\_activityメソッドでアクティビティの完了処理を行う。
> 
> 【補足】
> 
> ワークフローの各画面のモーダル、およびApproval画面から、ファイルをダウンロードできる。
> 
> ファイルサイズが閾値を超えていた場合はマルチパートダウンロードとなる。
> 
> マルチパートダウンロードの詳細は、\[アイテム詳細\]\>\[コンテンツファイル管理\]\>\[ マルチパートダウンロード処理について\]と同様

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### コミュニティ

  - > 目的・用途

本機能は、コミュニティの一覧表示と個別のコミュニティの表示を行う機能である

  - > 利用方法

管理画面でコミュニティを表示する設定にした状態で、トップページの「コミュニティ(Communities)」タブを選択する

※管理画面での設定は、[ADMIN-14-11: 検索設定](#検索設定)を参照

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - トップページから「コミュニティ(Communities)」タブを押すと、【コミュニティ(Communities)画面】に移動する
    
      - 表示項目は以下の通りである
        
          - コミュニティ検索のエリア  
            検索条件を入力して、キーボードでの「Enter」を押すと、コミュニティを検索し、検索結果が表示される
            
              - 初期表示では全件取得する
        
          - コミュニティ一覧のエリア
            
              - 【Administration \> コミュニティ管理（Communinites） \> コミュニティ（Community）画面】に作成されたコミュニティ一覧を表示する
            
              - デフォルトとして、コミュニティをランキングの順次で表示する
            
              - 各コミュニティに以下の表示項目を表示する
                
                  - コミュニティのタイトル（そのコミュニティへのリンク）
                
                  - コミュニティの説明
            
              - 「Sort By」プルダウンで、コミュニティの表示順次を選択できる  
                選択肢は「title」、「ranking」とする
            
              - ページングエリア

<!-- end list -->

  - コミュニティを表示する  
    コミュニティ名のリンクを押すと、該当コミュニティのページに移動する
    
      - 【Administration \> ウェブデザイン管理（Web Design） \> ページレイアウト（Page Layout）画面】に選択しているコミュニティのページレイアウトが登録されている場合、その設定通りにコミュニティが表示される
    
      - 選択しているコミュニティのページレイアウトが登録されていない場合、コミュニティは「Main contents」ウィジェットが配置されたページが表示される
    
      - ページレイアウトについては[ADMIN-4-2: ページレイアウト](\\l)を参照

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > invenio\_communities：画面表示を管理するモジュール

  - > weko\_theme：ページレイアウトを管理するモジュール

<!-- end list -->

  - > 処理概要

> 「コミュニティ(Communities)」タブを押すと、invenio\_communities.views.ui.community\_list関数が呼び出される
> 
> 画面表示には以下のテンプレートを使用する

  - > パス：https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-communities/invenio\_communities/templates/invenio\_communities/communities\_list.html

> 「コミュニティ(Communities)」タブを押すと、invenio\_communities.views.ui.community\_list関数が呼び出される

  - > 検索条件とソート条件に基づいてコミュニティを取得して表示する

> コミュニティのリンクを押すと、invenio\_communities.views.ui.view関数が呼び出される

  - > コミュニティのリンクは「/コミュニティID/?view=weko」となっており、コミュニティIDがview関数の引数となる

  - > 「?view=weko」の情報は使用しない（ソースの該当箇所がコメントアウトされている）

  - > 画面表示には以下のテンプレートを使用する
    
      - > パス：<https://github.com/RCOSDP/weko/blob/13c305a3048309dbda87a614ffedac18423820aa/modules/weko-theme/weko_theme/config.py#L76>

  - > テンプレート中でweko\_themeのwidget.jsを読み込んでおり、そのgetWidgetDesignSetting()関数でwidget\_design\_pageテーブルからページレイアウト情報を取得している

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### ランキング

  - > 目的・用途

本機能は、アイテムの閲覧回数やファイルのダウンロード回数やアイテムの作成ユーザーなどのランキングを閲覧する機能である。

  - > 利用方法

【Administration \> Setting (設定) \> Ranking (ランキング表示)からランキングの機能を設定し、トップ画面からランキングのリンクを押下することで、設定に沿ったアイテムがランキング方式で表示される。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

1\. ランキングに対して設定する

  - リポジトリ管理者として、【Administration \> Setting (設定) \> Ranking (ランキング表示)画面】にランキングの機能に対して設定を実行する
    
      - 設定項目は以下の通りである

<table>
<thead>
<tr class="header">
<th>#</th>
<th>設定項目</th>
<th>設定方法</th>
<th>デフォルト</th>
<th>概要</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>「ランキングの表示/非表示」（Show/Hide Ranking）</td>
<td>・「オン」（On）</td>
<td>「オフ」（Off）</td>
<td>Web画面でランキングタブの表示可否を設定する</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>・「オフ」（Off）</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>2</td>
<td>「新着アイテムとして判断する期間」（Period To Judge As New Item）</td>
<td>N日（Day）</td>
<td>14日</td>
<td>新規に登録されたアイテムとして判断する期間。アイテム登録日からの経過日数を指定する。ただし、設定できる範囲は1日～30日とする</td>
</tr>
<tr class="even">
<td>3</td>
<td>「統計期間」（Statistical Period）</td>
<td>N日（Day）</td>
<td>365日</td>
<td>ランキングとして表示する期間。本日から何日前までを集計期間とするかを指定する。ただし、設定できる範囲は1~3650日とする</td>
</tr>
<tr class="odd">
<td>4</td>
<td>「表示する順位」（Display Rank）</td>
<td>N位</td>
<td>10位</td>
<td>ランキングとして表示する順位を指定する.最大値を100位までとする</td>
</tr>
<tr class="even">
<td>5</td>
<td>「ランキング」（Rankings）</td>
<td>・「最も閲覧されたアイテム」（The Most Viewed Items）</td>
<td>チェックボックスの<br />
チェックなし</td>
<td>Web画面で表示するランキングの種類を設定する。チェックボックス方式で、複数選択可能とする。<br />
チェックの付いた項目をWeb画面のランキングタブに表示する。</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>・「最もダウンロードされたアイテム」（Most Downloaded Items）</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>・「最もアイテムを作成したユーザー」（User Who Created The Most Items）</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>・「最も検索されたキーワード」（Most Searched Keywords）</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>・「新着アイテム」（New Items）</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - 「保存」（Save）ボタンを押すと、画面上の設定情報を保存し、メッセージを画面上部に表示する  
    メッセージ：  
    日本語：「設定を変更しました」  
    英語：「Successfully Changed Settings.」

  - 以下のエラー条件に１つでも当てはまる場合、「保存」（Save）ボタンを押すと、エラーメッセージを画面上部に表示する  
    エラー条件：  
    ・「新着アイテムとして判断する期間」で1～30以外の自然数を設定した場合  
    ・「統計期間」で1\~3650以外の自然数を設定した場合  
    ・「表示する順位」で1\~10以外の自然数を設定した場合  
    エラーメッセージ：  
    日本語：「設定変更に失敗しました」  
    英語：「Failurely Changed Settings.」

  - 「新着アイテムとして判断する期間」「統計期間」「表示する順位」で文字列や小数、負の値、０など、上記のエラー条件以外の値を入れた場合、入力欄に「指定されている形式で入力してください」というポップアップを表示する

  - 「削除」（Delete）ボタンを押すと、入力中の値が破棄され、入力前の保存された設定情報を表示する

2\. ランキングの情報を表示する

  - トップページから「ランキング」（Ranking）タブを押下すると、ランキング画面に遷移する
    
      - 【Administration \> Setting (設定)\> Ranking (ランキング表示)画面】の「ランキング」（Ranking）の設定に応じて、チェックを入れている項目をランキング画面に表示する
    
      - 「ランキング」（Ranking）タブはゲスト以上のユーザーが閲覧可能とする
    
      - 画面上部に集計期間を表示する。
        
          - 表示方法：『集計期間：YYYY-MM-DD \~ YYYY-MM-DD』
        
          - 集計期間は【Administration \> Setting (設定)\> Ranking (ランキング表示)画面】の統計期間を参照する
    
      - 画面の構成は、【Administration \> Setting (設定)\> Ranking(ランキング表示)画面】に表示するランキングの項目で、チェックボックスにチェックがついている項目のランキングが表示される
    
      - 画面に表示される順位は、【Administration \> Setting (設定) \> Ranking(ランキング表示)画面】のチェックボックスの項目順で表示される
    
      - アイテムが直接紐づいているインデックスとその上位のインデックスについて、１つでも非公開の設定のものがある場合はランキング画面に表示しない。また、ログイン時はどのユーザでログインをしても、ゲストと同じランキング画面を表示する

  - ランキング画面に表示項目は以下の通りである
    
      - 「最も閲覧されたアイテム」（Most Viewed Item）
        
          - 表示方法：『n　(集計値)　アイテム名』  
            「n」：順位  
            「(集計値)」:該当アイテムの集計値（全バージョンのcountの合計値）  
            「アイテム名」：該当アイテム名
        
          - アイテム名はリンク形式で表示される。リンクを押下すると、該当アイテムの詳細画面へ遷移する  
            ※権限によってアイテムの詳細画面が表示できない場合は、参照権限がない旨の画面を表示する
    
      - 「新着アイテムとして判断する期間」（Period To Judge As New Item）
        
          - 表示方法：『ｎ　(集計値)　アイテム名』  
            「n」：順位  
            「(集計値)」：該当アイテムの集計値  
            「アイテム名」：該当アイテム名
        
          - アイテム名はリンク形式で表示される。リンクを押下すると、該当アイテムの詳細画面へ遷移する  
            ※権限によってアイテムの詳細画面が表示できない場合は、参照権限がない旨の画面を表示する
    
      - 「最もダウンロードされたアイテム」（Most Downloaded Items）
        
          - 表示方法：『ｎ　(集計値)　アイテム名』  
            「n」：順位  
            「(集計値)」：該当アイテムの集計値  
            「アイテム名」：該当アイテム名
        
          - アイテム名はリンク形式で表示される。リンクを押下すると、該当アイテムの詳細画面へ遷移する  
            ※権限によってアイテムの詳細画面が表示できない場合は、参照権限がない旨の画面を表示する
    
      - 「最もアイテムを作成したユーザー」（User Who Created The Most Items）
        
          - 表示方法：『ｎ　(集計値)　ユーザ名』  
            「n」：順位  
            「(集計値)」：集計値  
            「アイテム名」：該当ユーザ名
        
          - ユーザ名はリンク形式にはしない（画面表示のみ）
        
          - 表示するデータにユーザ名が存在しない場合は、「None」として表示させる
    
      - 「最も検索されたキーワード」（Most Searched Keywords）
        
          - 表示方法：『ｎ　位（集計値）　キーワード』  
            「n」：順位  
            「(集計値)」：集計値  
            「キーワード」：検索されたキーワード
        
          - 簡易検索の検索フィールドに入力されたキーワードを集計対象とする
        
          - キーワードを入力せずに検索した場合(全件検索)は、ランキングの集計対象外とする  
            その他、簡易検索以外の検索（詳細検索、インデックス検索、ファセット検索など）に関してもランキングの集計対象外とする
        
          - キーワードはリンク形式で表示される。リンクを押下すると、該当のキーワードで検索したときの検索結果画面へ遷移する
    
      - 「新着アイテム」（New Items）
        
          - 表示方法：『登録日　アイテム名』
        
          - アイテム名はリンク形式で表示される。リンクを押下すると、該当アイテムの詳細画面へ遷移する  
            ※権限によってアイテムの詳細画面が表示できない場合は、参照権限がない旨の画面を表示する

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_items\_ui

  - > invenio\_stats

  - > weko\_admin

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - > 対応しているモジュール：weko\_items\_ui, invebio\_stats

  - > トップ画面からランキングのリンクを押下する(/ranking)ことで、weko\_items\_ui.views.rankingが呼び出される。
    
      - > weko\_admin.models.RankingSettingを呼び出し、【Administration \> Setting (設定) \> Ranking (ランキング表示)】で設定したランキングの条件をranking\_settingsテーブルから取得する。
    
      - > weko\_items\_ui.utils.get\_rankingを呼び出す。
        
          - > inveio\_stats.util.QueryRankingHelper.getを呼び出してログ集計した結果を取得する。
        
          - > weko\_items\_ui.utils.get\_permission\_recordを呼び出して、「公開」となっているアイテムをランキングリストとして取得する。
    
      - > flask.templating.render\_templateを呼び出してランキングリストを渡し、「WEKO\_ITEMS\_UI\_RANKING\_TEMPLATE」に沿ってランキングを作成して表示する。

  - > 「WEKO\_ITEMS\_UI\_RANKING\_TEMPLATE」：weko\_items\_ui.config \#L57
    
      - > 設定値：\`weko\_items\_ui/ranking.html’

  - 集計方法について
    
      - 集計期間はAdmin側の集計期間で設定した日数とする
    
      - 集計するタイミングは定期バッチ（日次）で収集する
    
      - 事前集計を定期的に実行するタイミングは、Config設定で変更可能とする
    
      - 「Ranking」タブを表示したタイミングで、事前に集計しておいたランキング情報を参照して表示する
    
      - 最も閲覧されたアイテムランキングの集計方法について
        
          - 集計対象は集計開始時点で「公開」されているものとする
        
          - 閲覧回数は、事前にinvenio-statsにてログ集計した値とする
        
          - 閲覧回数は、全ドメインで集計した値とする
        
          - 所属インデックスの閲覧件数をまとめてカウントする( [~~\#21580\#note-22~~](https://redmine.devops.rcos.nii.ac.jp/issues/21580#note-22) )
    
      - 最もダウンロードされたアイテムの集計方法について
        
          - 集計対象は集計開始時点で「公開」されているものとする
        
          - ダウンロード回数は、事前にinvenio-statsにてログ集計した値とする
        
          - ダウンロード回数は、全ドメインで集計した値とする
        
          - ダウンロード回数は、通常ファイルダウンロード回数を対象とする
    
      - 最もアイテムを作成したユーザーの集計方法について
        
          - ユーザ数は、事前にinvenio-statsにてログ集計した値とする
        
          - ユーザ数は、全ロールで集計した値とする
    
      - 最も検索されたキーワードの集計方法について
        
          - キーワードは、事前にinvenio-statsにてログ集計した値とする
        
          - ランキング画面にあるキーワードのリンクを押下した場合も集計対象とする
    
      - 新着アイテムの集計方法について
        
          - 集計時を基点に、Admin側で設定した「新着アイテムとして判断する期間」の日数の前までの期間（経過日数）を新着アイテムの対象とする  
            【例】「新着アイテムとして判断する期間」を5日として、4/9に集計したときには、4/4～4/9に登録されたアイテムが新着アイテムとなる

  - 集計結果について
    
      - 最も閲覧されたアイテムランキング、最もダウンロードされたアイテム、最もアイテムを作成したユーザー、最も検索されたキーワード
        
          - 出力順は、集計した値の多い順とする
        
          - 集計値が同じもの（同一順位のもの）は、順位は同じものとし、以降の順位は同一のものだけ繰り下がった順位とする  
            例えば、3位のアイテムが3つある場合、1位, 2位, 3位, 3位, 3位, 6位という並びになる
        
          - 集計値が同じもの（同一順位のもの）の出力順はアイテム名の順にソートする
        
          - 集計値が同じもの（同一順位のもの）のうち、表示する順位を超える場合、表示する順位の数で切る  
            例えば、3位のアイテムが3つ(A, B, C)あり、表示する順位が4位までとした場合、1位, 2位, 3位(A), 3位(B)とする
    
      - 新着アイテム
        
          - 出力順は、新着アイテムの登録日の日付が新しい順とする
        
          - 登録日が同じものは登録時間の新しい順とする
        
          - 登録日が同じもののうち、表示する順位を超える場合、表示する順位の数で切る  
            例えば、4/4のアイテムが5つあり、表示する順位が3位までとした場合、登録日時の新しい上位3つを表示する

【補足】

  - 最も検索されたキーワードの集計について、"キーワード"とは検索窓から入力した文字列そのままのことを指す。  
    たとえば「Hello World」と入力して検索した場合、「Hello World」として集計される（HelloとWorldでキーワードは分割されない）

  - 最も検索されたキーワードに除外するキーワードの設定はしていない。  
    そのため、冠詞などのストップワードやネガティブなワードなどは除外せずにランキングに表示される

  - "非公開アイテム"、"アイテムが直接紐づいているインデックスとその上位のインデックスに１つでも非公開の設定のものがある"、"アイテムの所属インデックスが未来の公開日"の場合、  
    最も閲覧されたアイテム、最もダウンロードされたアイテム、新着アイテムに該当のアイテムは表示されない。

  - ログイン時はどのユーザでログインをしても、ゲストと同じランキング画面を表示する

  - ランキングの［New Items］に削除済アイテムは表示対象外とする

  - アイテムの公開日が「未来日」のものについてランキング表示対象外とする

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td></td>
<td></td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/11/11</p>
</blockquote></td>
<td>v0.9.27</td>
<td>閲覧回数の計算手法を明記</td>
</tr>
</tbody>
</table>
### ファイルアップロード

  - > 目的・用途

大容量データを安定的にWEKO3へアップロードする

  - > 利用方法

ユーザ画面のLarge File Uploadタブからファイルをアップロードする。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

  - 大容量のファイルアップロードを行う。

  - 大容量ファイルアップロード失敗した場合のレジュームアップロードを行う。

  - レジュームアップロードのため、ログインユーザ自身がアップロードしたファイルの履歴を確認できる

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > invenio-files-rest

<!-- end list -->

  - > 処理概要
    
      - 下記をJavaScriptから行うことでファイルアップロード・レジュームアップロードを実現する。
    
      - 新規アップロードの場合
        
          - files\_filesレコードを作成し、FileInstanceのUUIDを取得する
        
          - ObjectStorageへマルチパートアップロードの初期化APIを英クエストし、upload\_idを取得する
        
          - upload\_id, file\_idでfiles\_multipartrobjectレコードを追加する
    
      - レジュームアップロードの場合 upload\_idが正しい形式、有効かを検証するその後、新規アップロード・レジュームアップロード共通で下記を行う
        
          - ファイルをパートごとに分割し、files\_multipartobject\_partにすでにレコードが存在し、パートのハッシュ値を比較する
        
          - files\_multipartobject\_partにレコードが存在しない場合、ObjectStorageにパートをアップロードし、files\_multipartobject\_partにレコードを追加する

すべてのパートをアップロードし終えたら、ObjectStorageへマルチパートアップロードの完了APIをリクエストし、files\_multipartobjectレコードとfiles\_filesレコードを更新する

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/12/22</p>
</blockquote></td>
<td>4ec162bf3bdcf843df23863fbf7d5bb36ba875e4</td>
<td>W2023-42</td>
</tr>
</tbody>
</table>
### 言語切替

  - > 目的・用途

本機能は、ユーザーの操作によって表示言語を切り替えられるようにする機能である。

  - > 利用方法

画面のヘッダ部分にある表示言語切替のプルダウンを操作する。

または、「\[トップページURL\]/lang/\<lang\_code\>」のURLでアクセスする。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - ユーザー画面のヘッダ部分に表示言語切替のプルダウンを設ける
    
      - 選択肢は、【Administration \> 設定（Setting） \> 言語表示（Language）画面】での「登録言語」に指定されている言語一覧である
    
      - 「登録言語」に1番上の言語はデフォルト言語とする
    
      - 選択している言語に対応がない場合、表示言語は英語とする
    
      - 詳細は[ADMIN-14-3: 言語表示](\\l)参照。

  - URLを用いて本機能を利用する場合、【Administration \> 設定（Setting） \> 言語表示（Language）画面】に表示されている言語なら「登録言語」に指定されていない言語でも利用可能

  - URLに ?next=\<リダイレクト先のパス\> を付加することで、直接言語のページに遷移することができる
    
      - 例：\[トップページURL\]/lang/en?next=/workflow/

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > invenio-i18n（WEKOソース内にforkされていない）

<!-- end list -->

  - > 処理概要

> \<lang\_code\> で指定された言語コードが instance.config の BABEL\_DEFAULT\_LOCALE または I18N\_LANGUAGES で定義されたリストのキーに合致した場合、その言語が選択されたことをSessionに保存して言語切替を行ったページにリダイレクトしている。

  - > 保存先のSessionは、session\[current\_app.config\["I18N\_SESSION\_KEY"\]\]である。

  - > コンフィグI18N\_SESSION\_KEYのデフォルト値は”language”である。

> リストに無い言語コードが指定された場合は 404 を返す。

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### サインアップ

  - > 目的・用途

本機能は、ゲストが登録してユーザーになるための機能である。

  - > 利用方法

ユーザー画面のヘッダから「サインアップ」（Sign up）ボタンを押す。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - ユーザー画面から［サインアップ（Sign up）］ボタンを押すと、サインアップ画面に移動する

  - サインアップ画面を以下のように設ける
    
      - 表示言語はヘッダに選択しているシステム言語とする
    
      - メールアドレスとパスワードのテキストボックス
    
      - ［サインアップ（Sign Up）］ボタン、「ログイン」（Log In）リンク

  - ［サインアップ（Sign Up）］ボタンを押すと、入力した情報をチェックする
    
      - メールアドレスに対して
        
          - メール形式で入力すること
        
          - システムに登録されていないこと
    
      - パスワードのテキストボックスには、キーボードからは半角英数字のみ入力できるように入力制限がかかっている

  - チェック上、問題なければ、アカウントが登録されて、自動ログインされる  
    ※登録されたアカウントに対して、ロールが付与されない状態とする
    
      - トップページ画面の上部にメール確認用のリンクが送信された旨を通知する  
        通知内容：「Thank you. Confirmation instructions have been sent to {}.」

  - チェックに問題がある場合、エラーメッセージをテキストボックスの上部に表示させる
    
      - メールアドレス、またはパスワードを入力しない場合  
        エラーメッセージ：「{} not provided」
    
      - メールアドレスの形式が不正である場合  
        エラーメッセージ：「Invalid email address」
    
      - メールアドレスがシステムに登録されている場合  
        エラーメッセージ：「{} is already associated with an account.」
    
      - パスワードを6文字未満で入力する場合  
        エラーメッセージ：「Password must be at least 6 characters」

  - メール確認リンクにアクセスする
    
      - メール本文から、リンクをクリックすると、WEKOトップページに移動して、登録されたユーザーが自動ログインされる  
        また、トップページ画面の上部にメールが確認された旨を通知する  
        通知内容：「Thank you. Your email has been confirmed.」
    
      - アクセスリンクが送信されたリンクと統一しない場合、確認メールを再送信するため、メールの再入力画面に移動、登録メールを再入力するリクエストとする
        
          - メールアドレスを入力して、［確認を送信する（Send Confirmation）］ボタンを押すと、確認用のメールを再送信する

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > invenio\_accounts

<!-- end list -->

  - > 処理概要

> ［サインアップ（Sign Up）］ボタンを押すと、invenio\_accounts.tasks.send\_security\_emailにて、celeryタスクでメールを送信する
> 
> アカウント登録によって、accounts\_userテーブルにレコードが作成される

  - > 画面で入力したメールアドレスとパスワードが、ログイン時のemailとpasswordになる

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>

### ログイン

  - > 目的・用途

本機能は、サインアップ済みのユーザーがログインするための機能である。

  - > 利用方法

ユーザー画面のヘッダから［ログイン（Log in）］ボタンを押す。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - ユーザー画面のヘッダから［ログイン（Log in）］ボタンを押すと、ログイン画面に移動する
    
      - コンフィグの以下設定値の組み合わせに応じて、該当ログイン画面に移動する  
        （シボレスログイン処理について、[ADMIN-14-19: Shibboleth](\\l) を参照）
        
        1.  WEKO login only:
            
              - WEKO\_ACCOUNTS\_SHIB\_LOGIN\_ENABLED = False
        
        2.  WEKO login + Shibbolth(Idp):
            
              - WEKO\_ACCOUNTS\_SHIB\_LOGIN\_ENABLED = True
            
              - WEKO\_ACCOUNTS\_SHIB\_IDP\_LOGIN\_ENABLED = True
        
        3.  WEKO login + Shibbolth(DS):
            
              - WEKO\_ACCOUNTS\_SHIB\_LOGIN\_ENABLED = True
            
              - WEKO\_ACCOUNTS\_SHIB\_IDP\_LOGIN\_ENABLED = False
        
        4.  Shibbolth(Idp):
            
              - WEKO\_ACCOUNTS\_SHIB\_LOGIN\_ENABLED = True
            
              - WEKO\_ACCOUNTS\_SHIB\_IDP\_LOGIN\_ENABLED = True
            
              - WEKO\_ACCOUNTS\_SHIB\_INST\_LOGIN\_DIRECTLY\_ENABLED = True
        
        5.  Shibbolth(DS)
            
              - WEKO\_ACCOUNTS\_SHIB\_LOGIN\_ENABLED = True
            
              - WEKO\_ACCOUNTS\_SHIB\_IDP\_LOGIN\_ENABLED = False
            
              - WEKO\_ACCOUNTS\_SHIB\_DP\_LOGIN\_DIRECTLY\_ENABLED= True

  - WEKOのログイン画面からログインする
    
      - 表示言語はヘッダにて選択しているシステム言語とする
    
      - メールアドレスとパスワードのテキストボックスを設ける
    
      - ［ログイン（Log In）］ボタン、「サインアップ」（Sign Up）リンク、「パスワードをお忘れの方はこちら」（Forgot password?）リンクを設ける
        
          - ［ログイン（Log In）］ボタンを押すと、入力した情報で、ログインリクエストを送信する
            
              - 問題なければ、もともとのユーザー画面に移動する
            
              - エラーがあった場合、エラー内容を メールアドレスとパスワードのテキストボックスの上部に表示させる
                
                  - メールアドレス、またはパスワードを入力しない場合  
                    エラーメッセージ：「{} not provided」
                
                  - メールアドレス、またはパスワードを正しく入力しない場合  
                    エラーメッセージ：「Specified user does not exist」
        
          - 「サインアップ」（Sign Up）リンクを押すと、アカウント登録画面に移動する
        
          - 「パスワードをお忘れの方はこちら」（Forgot password?）リンクを押すと、リセットパスワード画面に移動する

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > invenio\_accounts

  - > weko-accounts

<!-- end list -->

  - > 処理概要

> ログイン画面の種類を決定するコンフィグは、instance.cfgまたはweko-accountsのconfig.pyで設定する。両方で設定されている場合、instance.cfgの設定が優先される。

  - > パス（instance.cfg）：  
    > https://github.com/RCOSDP/weko/blob/v0.9.22/scripts/instance.cfg

  - > パス（config.py）：  
    > <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-accounts/weko_accounts/config.py>

  - > 対象となるコンフィグは以下の通り。
    
      - WEKO\_ACCOUNTS\_SHIB\_LOGIN\_ENABLED
    
      - WEKO\_ACCOUNTS\_SHIB\_IDP\_LOGIN\_ENABLED
    
      - WEKO\_ACCOUNTS\_SHIB\_INST\_LOGIN\_DIRECTLY\_ENABLED

> ログインボタンを押すと、invenio-accountsのsessions.pyにあるlogin\_listenerのadd\_user\_sessionメソッドが呼び出される。

  - > ログイン時には、accounts\_user\_session\_activityテーブルとredisにセッション情報を記録して、accounts\_userテーブルの最終ログイン情報を更新する。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### パスワードリセット

  - > 目的・用途

当機能は、パスワードを忘れてログインできないユーザーが再設定できるようにする機能である。

  - > 利用方法

ログイン画面で、「パスワードをお忘れの方はこちら」リンクを押す。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - リセットパスワード画面を以下のように設ける
    
      - 表示言語はヘッダに選択しているシステム言語とする
    
      - 説明内容  
        日本語：「メールアドレスを入力していただき、パスワードリセット用のリンクをお送りいたします。」  
        英語：「Enter your email address below and we will send you a link to reset your password.」
    
      - メールアドレステキストボックス
    
      - ［リセットパスワード（Reset Password）］ボタン、 「ログイン」（Log in）リンク、「サインアップ」（Sign Up）リンク

  - ［リセットパスワード（Reset Password）］ボタンを押すと、入力したメールアドレスをチェックする
    
      - メールアドレスがシステムに登録されたものである場合、リセットパスワードのリンクを含むメールを送信する
        
          - メールを送信した後、リセットパスワード画面に説明内容を表示する  
            内容：「Instructions to reset your password have been sent to {}.」
    
      - この段階で、もともとのパスワードでログインすることはできなくなる
    
      - エラーがあった場合、エラー内容をメールアドレスのテキストボックスの下部に表示させる
        
          - メールアドレスの形式が不正である場合  
            エラーメッセージ：「Invalid email address」
        
          - メールアドレスがシステムに登録されたものではない場合  
            エラーメッセージ：「Specified user does not exist」

  - リセットパスワードリンクにアクセスする
    
      - メール本文から、リンクをクリックすると、リセットパスワード画面に移動される
        
          - リセットパスワード画面に「パスワード入力」、「パスワード再入力」テキストボックスを設ける
        
          - 「パスワード入力」、「パスワード再入力」を入力した後、［リセットパスワード（Reset Password）］ボタンを押すと、入力した情報をチェックする
            
              - それぞれのテキストボックスには、キーボードからは半角英数字のみ入力できるように入力制限がかかっている
        
          - チェック上、問題なければ、パスワードが再設定されて、WEKOに自動ログインされる
            
              - トップページ画面の上部にパスワードが成功にリセットされた旨を通知する  
                通知内容：「You successfully reset your password and you have been logged in automatically.」
        
          - チェックに問題がある場合、エラーメッセージをテキストボックスの下部に表示させる
            
              - パスワード、またはパスワードの再入力を入力しない場合  
                エラーメッセージ：「Password not provided」
            
              - パスワードを6文字未満で入力する場合  
                エラーメッセージ：「Password must be at least 6 characters」
            
              - パスワードがパスワードの再入力と統一しない場合  
                エラーメッセージ：「Passwords do not match」
    
      - アクセスリンクが送信されたリンクと統一しない場合、リセットパスワード画面にエラーメッセージを表示する  
        エラーメッセージ：「Invalid reset password token.」

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > invenio\_accounts

<!-- end list -->

  - > 処理概要

> リセットパスワード画面で［リセットパスワード（Reset Password）］ボタンを押すと、invenio\_accounts.tasks.send\_security\_emailにて、セロリタスクでメールを送信する

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### ユーザープロファイル設定

  - > 目的・用途

本機能は、ユーザーとして、ユーザープロファイルを閲覧・編集できる機能である。

  - > 利用方法

画面ヘッダで、ログインユーザのメールアドレスが表示されている部分またはその右側の［▼］ボタンをクリックすると、【プロフィール（Profile）画面】に遷移する。画面上で操作を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

1\. ユーザープロファイルを閲覧・編集する

  - 【プロフィール（Profile）画面】にユーザーの情報を管理する
    
      - 表示項目は以下の通りである
        
          - ［確認メールを再送（Resend verification email）］ボタン  
            ボタンを押すと、確認メールを再送信し、メッセージを画面上部に表示する  
            メッセージ：  
            　日本語：「確認メールを送信しました」  
            　英語：「Verification email sent.」
        
          - 「ユーザー名」（Username）：必須項目
            
              - 入力必須は「ユーザー名」（Username）テキストボックスの下に表示する  
                日本語：「ユーザー名は3文字以上を指定してください(英数字, ハイフン, アンダーバーのみ使用可能)は入力必須です」  
                英語：「Required. Username must start with a letter, be at least three characters long and only contain alphanumeric characters, dashes and underscores.」
        
          - 「タイムゾーン」（Timezone）  
            デフォルト値：「(GMT+9:00) Tokyo, Seoul, Osaka, Sapporo, Yakutsk」
        
          - 「言語」（Language）  
            選択肢：「自動」（Automatic）、「日本語」（Japanese）、「英語」（English）  
            デフォルト値：日本語
        
          - 「メールアドレス」（Email address）
        
          - 「メールアドレスの再入力」（Re-enter email address）
    
      - ［Update Profile］ボタンを押すと、設定内容をチェックし、エラーがない場合、設定内容を保存する
        
          - 「メールアドレス」を変更する場合、変更されたメールアドレスに確認メールを送信し、メッセージを画面上部に表示する  
            メッセージ：  
            　日本語：「プロフィールを更新しました+「メールアドレス」+に確認メールを送信しましたので、ご確認ください」  
            　英語：「Profile was updated. We have sent a verification email to + 「email address」 +. Please check it.」
        
          - 「メールアドレス」を変更しない場合、以下のメッセージを画面上部に表示する  
            メッセージ：  
            　日本語：「プロフィールを更新しました」  
            　英語：「Profile was updated.」
    
      - エラーメッセージは以下の通りである
        
          - 「ユーザー名」（Username）を指定しない場合、エラーメッセージを「ユーザー名」（Username）エリアの下に表示する  
            メッセージ：  
            　日本語：「ユーザー名を入力してください」  
            　英語：「Please input username」
        
          - フォーマットのチェックによるエラーメッセージが以下のように定義されているが、v0.9.22ではチェックメソッドを呼び出していないため表示されることはない
        
          - > 指定している「ユーザー名」（Username）のフォーマットが不正の場合、エラーメッセージを「ユーザー名」（Username）エリアの下に表示する  
            > メッセージ：  
            > 　日本語：「ユーザー名は3文字以上を指定してください(英数字, ハイフン, アンダーバーのみ使用可能)」  
            > 　英語：「Username must start with a letter, be at least three characters long and only contain alphanumeric characters, dashes and underscores.」
    
      - 「キャンセル」（Cancel）ボタンを押すと、プロフィール画面に再度遷移することで設定内容をリセットする
    
      - この画面では「ユーザー名」（Username）は入力必須だが、データベース上は必須ではない。空にする場合は、管理者機能で設定する。（[ADMIN-13-12: ユーザープロファイル](\\l)を参照）

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko-user-proriles

<!-- end list -->

  - > 処理概要

> プロフィール入力フォームとその入力内容チェックは、以下で定義している。

  - > パス：  
    > <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-user-profiles/weko_user_profiles/forms.py>

  - > ProfileFormクラスの内容を、テンプレートprofile.htmlに設定している。

> ［Update Profile］ボタンを押すと、リクエストペイロードにsubmit: profileを含むaccount/settings/profile/ リクエストがPOSTされる。

  - > これによって、weko\_user\_profiles.views.profileメソッドが呼び出される。この中でhandle\_profile\_formメソッドを呼び出してユーザープロファイルを更新する。

> プロフィールの設定は、userprofiles\_userprofileテーブルに保存される。

  - > ユーザー名（Username）はdisplaynameカラムに保存される。

  - > タイムゾーン（Timezone）はtimezoneカラムに保存される。

  - > 言語（Language）はlanguageカラムに保存される。

> メールアドレスの変更は、flask\_loginのグローバル変数current\_user.emailを更新することで保存される。

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### API設定

  - > 目的・用途

本機能は、API使用のためのOAuthの設定を閲覧・作成・編集できる機能である。

  - > 利用方法

画面ヘッダの右側の［▼］ボタンをクリックし、プルダウンから「Applications」を選択する。  
【Applications】画面に遷移する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

> 「Developer Applications」エリア

  - > エリア右上の「New Applications」ボタンを押下するとOAuthアプリケーション(以下クライアントと表記)作成画面に遷移し、新しいクライアントを作成することができる。
    
      - 入力事項
        
          - 名前(Name)：必須入力
        
          - 記述(Description)：自由記述
        
          - WebSite URL：必須入力
        
          - Redirect URIs:必須入力
        
          - Client type :プルダウンより「Confidencial」、「Public」から選択する。

  - > エリアを表示した際、ログインしているアカウントに登録されているクライアントの名前と説明を表示する。

  - > 表示されているクライアントの名前を押下するとその詳細情報が表示される。
    
      - > 「Application/\[名前\]」エリア
        
          - > 表示情報
            
              - > Client ID
            
              - > Client Secret
            
              - > 名前(Name)
            
              - > 記述(Description)
            
              - > Website URL
            
              - > Redirect URIs
            
              - > Client type
                
                  - > 「Client ID」,「Client Secret」以外の項目は編集可能である。
        
          - > 「Reset client secret」ボタンを押下すると「Client Secret」項目を再生成することができる。
        
          - > 「削除」ボタンを押下すると即時表示されているクライアント情報を削除する。
        
          - > 「保存」ボタンを押下すると編集した内容を保存する。
    
      - > 「OAuth 2.0 Endpoints」エリア
        
          - > 「Authorize URL(GET)」に必要なパラメータが記載されている。  
            > Query parameters:
            
              - > response\_type (required, use code or token)
            
              - > client\_id (required)
            
              - > scope (required, space separate list of scopes)
            
              - > redirect\_uri (required, URL encoded)
            
              - > state (recommended, for CSRF protection)

> 「example request」を押下するとAuthorize requestの例として生成されるURLに遷移する。

  - > 「Access token URL(POST)」に必要なパラメータが記載されている。
    
      - > client\_id (required).
    
      - > client\_secret (required).
    
      - > grant\_type (required, use client\_credentials, authorization\_code, refresh\_token).
    
      - > code (required for grant\_type authorization code).
    
      - > scope (required for grant\_type client\_credentials).
    
      - > refresh\_token (required for grant\_type refresh\_token).

> 「Personal access tokens」エリア

  - > エリア右上の「New token」ボタンを押下するとOAuthトークン(以下トークン)作成画面に遷移し、新しいトークンを作成することができる。
    
      - > 入力項目
        
          - > Name:必須
        
          - > Scopes：以下チェックで入力
            
              - > deposit:actions　アップロードの公開の許可
            
              - > deposit:write　アップロードの許可（公開の権限なし）
            
              - > index:create　インデックス作成の許可
            
              - > user:email　登録されているメールアドレスへの接続許可(読み込みのみ)
            
              - > user:activity　ワークフロー作成の許可

  - > エリアを表示した際、ログインしているアカウントに登録されているまだ承認されていないトークンの名前と説明を表示する。

  - > 表示されているクライアントの名前を押下するとその詳細情報が表示される。
    
      - > 「Personal access token/\[名前\]」エリア
        
          - > 表示情報
            
              - > Access token
            
              - > Name
            
              - > Scopes:以下チェックで入力
                
                  - > deposit:actions
                
                  - > deposit:write
                
                  - > index:create
                
                  - > user:email
                
                  - > user:activity
                    
                      - > Access token以外の項目は編集可能である。
        
          - > 「削除」ボタンを押下すると表示されているトークン情報を即削除する。
        
          - > 「保存」ボタンを押下すると編集した内容を保存する。

> 「Authorized applications」エリア

  - > 承認されたトークンを表示する。

  - > 表示されているトークンを押下するとその詳細情報が表示される画面に遷移する。。
    
      - > 「Authorized application:\[名前\]」エリア
        
          - > 表示情報
            
              - > Description
            
              - > トークンが持つ権限（スコープ）
            
              - > トークンの所属しているOAuthアプリケーション情報
                
                  - > アプリケーションの名前
                
                  - > アプリケーションのWebsiteリンク
                    
                      - > リンクを押下すると遷移する。

  - > アプリケーション名右にある「撤回」ボタンを押下するとそのアプリケーションに属するトークン情報を削除する。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > Invenio-oauth2server

<!-- end list -->

  - > 処理概要

> 【ホーム\>アカウント\>Applications】画面を表示する。この操作によって、invenio\_oauth2server.views.setting.indexメソッドが呼び出され、oauth2server\_clientテーブルからクライアント情報を、oauth2server\_tokenテーブルからトークン情報をそれぞれ取得し表示する。なお、取得するのはログインしているユーザーが作成したもののみである。

  - > 取得したトークン情報を承認されているかで「Personal access tokens」と「Authorized applications」で振り分ける。振り分け条件としては前者にはクライアント情報のis\_internal列がTrueかつトークン情報のis\_personal列がTrueであるものを、後者にはクライアント情報のis\_internal列がfalseかつトークン情報のis\_personal列がfalseであるものを振り分ける。

> 「Developer Applications」エリア

  - > 「New application」ボタンを押下する。この操作によって、invenio\_oauth2server.views.setting. client\_newメソッドがGETで呼び出され、新しいクライアントを登録する画面が表示される。
    
      - > 必須入力事項を入力し、「登録」ボタンを押下する。  
        > この操作によって、invenio\_oauth2server.views.setting. client\_newメソッドがPOSTで呼び出され、oauth2server\_clientテーブルに入力した情報を登録する。

  - > エリアにて表示されているクライアントの名前を押下する。  
    > この操作によって、invenio\_oauth2server.views.setting. client\_viewメソッドがGETで呼び出され、oauth2server\_clientテーブルからそのクライアント情報を取得し、画面に表示する。
    
      - > 「Application/\[名前\]」エリア
        
          - > 「Reset client secret」ボタンを押下する。  
            > この操作によって、invenio\_oauth2server.views.setting.client\_resetメソッドがPOSTで呼び出され、Client Secretを再生成し、oauth2server\_clientテーブルのclien\_secret列に保存する。
        
          - > 「削除」ボタンを押下する。  
            > この操作によって、invenio\_oauth2server.views.setting.client\_viewメソッドがPOST,deleteで呼び出され、表示されていたクライアント情報をoauth2server\_clientテーブルから削除する。
    
      - > 「OAuth 2.0 Endpoints」エリア
        
          - > 「example request」を押下するとinvenio\_oauth2server.templates.invenio\_oauth2server.settings.client\_viewの61行目から記載されているURLのページに遷移する。

  - > 表示されているクライアント情報を編集後、「保存」ボタンを押下する。  
    > この操作によって、invenio\_oauth2server.views.setting.client\_viewメソッドがPOSTで呼び出され、編集した情報をoauth2server\_clientテーブルに保存する。

> 「Personal access tokens」エリア

  - > 「New token」ボタンを押下する。  
    > この操作によって、invenio\_oauth2server.views.setting.token\_newメソッドがGETで呼び出され、新しいトークンを作成する画面が表示される。
    
      - > 必須入力事項を入力し、「作成」ボタンを押下する。  
        > この操作によって、invenio\_oauth2server.views.setting.token\_newメソッドがPOSTで呼び出され、oauth2server\_tokenテーブルに入力した情報を登録する。

  - > エリアにて表示されているトークンの名前を押下する。  
    > この操作によって、invenio\_oauth2server.views.setting. token\_viewメソッドがGETで呼び出され、oauth2server\_tokenテーブルからそのトークン情報を取得し、画面に表示する。
    
      - > 「Personal access token/\[名前\]」エリア
        
          - > 「削除」ボタンを押下する。  
            > この操作によって、invenio\_oauth2server.views.setting.token\_viewメソッドがPOST,deleteで呼び出され、表示されていたトークン情報をoauth2server\_tokenテーブルから削除する。
        
          - > 表示されているトークン情報を編集後、「保存」ボタンを押下する。  
            > この操作によって、invenio\_oauth2server.views.setting.token\_viewメソッドがPOSTで呼び出され、編集した情報をoauth2server\_tokenテーブルに保存する。

> 「Authorize applications」エリア

  - > エリアにて表示されているトークンの名前を押下する。この操作によって、invenio\_oauth2server.views.setting. token\_permission\_viewメソッドがGETで呼び出される。これによってoauth2server\_clientテーブルからクライアント情報をoauth2server\_tokenテーブルからそのトークンのスコープを取得し、画面に表示する。

> 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### Cookie使用確認画面表示

  - > 目的・用途

ユーザに対してCookie利用の確認を行う。

  - > 利用方法

画面フッタの「Change consent settings」をクリックすると、Cookie利用の同意画面が表示される。

ユーザはCookie利用の同意画面にて、同意することで、Cookieを利用したサービスを利用できるようになる。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - コンフィグで機能が有効化されているとき、画面フッタに「Change consent settings」が表示される。これをクリックすると、Cookie利用の同意画面がポップアップで表示される。

  - Addthis および Google Analystics の利用について、Cookie利用の同意をとることで利用可能とする。

  - Googleアナリティクス(システム)については、サービス利用の必須としている。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko-theme

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - Cookie利用の同意画面は、Klaro ( https://github.com/kiprotect/klaro ) ライブラリを利用して作成している。

  - 本機能の有効化を設定するコンフィグは、instance.cfgまたはweko-themeのconfig.pyで設定する。両方で設定されている場合、instance.cfgの設定が優先される。
    
      - パス（instance.cfg）：  
        https://github.com/RCOSDP/weko/blob/v0.9.22/scripts/instance.cfg
    
      - パス（config.py）：  
        https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-theme/weko\_theme /config.py

  - > ENABLE\_COOKIE\_CONSENT = True の場合に機能が有効となる。

  - 「Change consent settings」は、コンフィグで機能が有効化されているときのみ表示されるようにテンプレートで制御されている。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### メタデータ

<!-- end list -->

  - > 目的・用途

本機能は、アイテムタイプの管理を行う機能である。

アイテムタイプの新規登録、コピー、バージョンアップ、削除、エクスポート、インポート、および削除済みアイテムタイプの復元ができる。

  - > 利用方法

【Administration \> アイテムタイプ管理（Item Types） \> メタデータ（Metadata）画面】にて操作する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - > メタデータ画面の上部に、アイテムタイプの種類を選択するラジオボタン、アイテムタイプを選択するプルダウンを設ける。

  - > 上記項目の右側に、［エクスポート］ボタン、［インポート］ボタンを設ける。

  - > メタデータ画面の下部に、アイテムタイプの詳細と操作内容を表示する領域を設ける。

  - > アイテムタイプの選択
    
      - ラジオボタンで、アイテムタイプの種類を以下の3つから選択できる。選択内容によって、プルダウンに表示されるアイテムタイプが変わる。
        
          - > ［標準アイテムタイプ］ラジオボタンにチェックを入れる場合、  
            > セレクトボックスではアイテム登録に利用できるアイテムタイプが表示される。
        
          - > ［ハーベスト用アイテムタイプ］ラジオボタンにチェックを入れる場合、  
            > セレクトボックスではハーベストに利用できるアイテムタイプが表示される。
        
          - > ［削除済みアイテムタイプ］ラジオボタンにチェックを入れる場合、  
            > セレクトボックスでは削除されたアイテムタイプが表示される。
        
          - > 画面表示時は［標準アイテムタイプ］ラジオボタンが選択された状態である。
    
      - プルダウンでは、ラジオボタンの選択に応じたアイテムタイプが表示される。
        
          - > このプルダウンで選択したアイテムタイプに対して各種操作を実施する。
        
          - > 各アイテムタイプ名の末尾には、item\_typeテーブルの「tag」が追加されて表示される。
    
      - 各アイテムタイプに実施できる操作は以下の通りである。

<table>
<thead>
<tr class="header">
<th>（凡例）</th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>〇：できる　×：できない</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>#</td>
<td>操作</td>
<td>標準<br />
アイテムタイプ</td>
<td>ハーベスト用<br />
アイテムタイプ</td>
<td>削除済み<br />
アイテムタイプ</td>
</tr>
<tr class="odd">
<td>1</td>
<td>追加</td>
<td>〇</td>
<td>〇</td>
<td>×</td>
</tr>
<tr class="even">
<td>2</td>
<td>メタデータ編集</td>
<td>〇</td>
<td>〇</td>
<td>×</td>
</tr>
<tr class="odd">
<td>3</td>
<td>マッピング設定</td>
<td>〇</td>
<td>〇</td>
<td>×</td>
</tr>
<tr class="even">
<td>4</td>
<td>名前の変更</td>
<td>〇</td>
<td>〇</td>
<td>×</td>
</tr>
<tr class="odd">
<td>5</td>
<td>コピー</td>
<td>〇</td>
<td>〇</td>
<td>×</td>
</tr>
<tr class="even">
<td>6</td>
<td>削除</td>
<td>〇</td>
<td>×</td>
<td>×</td>
</tr>
<tr class="odd">
<td>7</td>
<td>復元</td>
<td>×</td>
<td>×</td>
<td>〇</td>
</tr>
<tr class="even">
<td>8</td>
<td>エクスポート</td>
<td>○</td>
<td>×</td>
<td>×</td>
</tr>
<tr class="odd">
<td>9</td>
<td>インポート</td>
<td>○</td>
<td>×</td>
<td>×</td>
</tr>
</tbody>
</table>

  - マッピング設定は、マッピング画面で実施する。詳細は[ADMIN-1-2: マッピング](#マッピング)を参照。

<!-- end list -->

  - 対応している標準アイテムタイプは以下の通りである。
    
      - 「デフォルトアイテムタイプ（シンプル）」
    
      - 「デフォルトアイテムタイプ（フル）」
        
          - 「デフォルトアイテムタイプ（シンプル）」「デフォルトアイテムタイプ（フル）」の詳細は別紙「デフォルトアイテムタイプの作成v4.xlsx」を参照。
    
      - 「DDI」
        
          - 「DDI」の詳細は別紙「DDIアイテムタイプ修正の仕様ver6\_訂正案.xlsx」を参照。

  - 対応している制限公開用のアイテムタイプは以下の通りである。
    
      - 「利用申請」
    
      - 「二段階利用申請」
    
      - 「利用報告-Data Usage Report」

  - 対応しているハーベスト用アイテムタイプは以下の通りである。
    
      - 「Thesis」
    
      - 「Sound」
    
      - 「Article」
    
      - 「Report」
    
      - 「Book」
    
      - 「Patent」
    
      - 「Cartographic Material」
    
      - 「Lecture」
    
      - 「Image」
    
      - 「Conference Object」
    
      - 「Dataset」
    
      - 「Multiple」
    
      - 「Harvesting DDI」

  - アイテムタイプの追加
    
      - アイテムタイプを新規作成する場合は、アイテムタイプを選択するプルダウンで、空白を選択する。
    
      - 「公開日」（Publish Date）はデフォルトの項目として常に表示されている。アイテム登録画面で入力必須の項目のため、オプションの「必須」はチェックありで変更できない。
    
      - 「アイテムタイプ」（Item Type）テキストボックスにアイテムタイプの名前を入力する。
        
          - アイテムタイプの名前は、既存のものと重複してはならない。
    
      - 「新規登録」（New Registration）ラジオボタンを選択する。
    
      - 「メタデータ追加」（Add Metadata）を押すことで、新規メタデータを追加する。
        
          - メタデータ項目名
            
              - 「アイテム名」（Item Name）カラムのテキストボックスでメタデータ項目名を設定できる。
            
              - 「アイテム名」（Item Name）カラムに「Localization Settings」リンクを設ける。リンクを押すと、多言語の項目名の名称入力エリアを表示する。  
                ※設定された項目名はアイテム登録・編集画面、アイテム詳細画面に表示される。
                
                  - 対応している言語は日本語と英語とする。  
                    デフォルトは空白とする。
                    
                      - システム言語が日本語の場合、［Japanese］で設定された項目名が表示される。
                    
                      - システム言語が日本語以外の場合、［English］で設定された項目名が表示される。
                    
                      - 設定しない場合は、表示言語設定に関わらず、当該画面で設定している項目名が表示される。
        
          - メタデータ属性
            
              - 「属性」（Attribute）カラムのプルダウンでメタデータ属性を設定できる。※メタデータ属性の設定については、以下の「メタデータ項目の内容」を参照。
            
              - 「属性」（Attribute）カラムに「Localization Settings」リンクを設ける。リンクを押すと、多言語の子項目名の名称入力エリアを表示する。  
                ※設定された項目名はアイテム登録・編集画面、アイテム詳細画面に表示される。
                
                  - 対応している言語は日本語と英語とする。  
                    デフォルトは空白とする。
                    
                      - システム言語が日本語の場合、［Japanese］で設定された子項目名が表示される。
                    
                      - システム言語が日本語以外の場合、［English］で設定された子項目名が表示される。
                    
                      - 設定しない場合は、［Properties］画面に設定された子項目名が表示される。
        
          - メタデータ項目の内容
            
              - 項目に対して
                
                  - メタデータ行での「オプション」（Option）カラムに表示形式を設定する。表示形式を複数設定できる
                
                  - 設定できるオプションは以下の通りである。
                    
                      - 「必須」（Required）：アイテム登録時に\*を表示し、必須入力のメタデータにする。
                        
                          - 「公開日」（Publish Date）は必須項目であるため、初めからチェックが入っており、外すことができない。
                    
                      - 「Multiple」（Allow Multiple）：アイテム登録時に［+New］を表示し、メタデータの複数入力を可能にする。
                        
                          - 選択すると、最低限と最大限の項目を設定できる
                        
                          - デフォルト：  
                            最低限の項目：「1」  
                            最大限の項目：「9999」
                    
                      - 「リスト表示」（Show List）：アイテム一覧画面にメタデータをカンマ区切りで一覧に表示される
                    
                      - 「改行を指定」（Specify Newline）：アイテム一覧画面にメタデータを改行で表示される
                    
                      - 「Hide」：ログインの有無に関わらずインデックス、キーワードサーチ結果、CiteAs、アイテム詳細、OAI-PMHを含む外部出力にメタデータの詳細を表示しない。アイテムエクスポートのみ、ログインユーザにはhide項目を出力する。
                    
                      - 「Display on one line」:
                        
                          - 「トピック」のような繰り返し可の項目は1つのセルにまとめて表示して、個々の値はカンマ等で区切る。
                        
                          - アイテムタイププロパティ「Time Period」「collDate」「H\_Time Period」等、Eventのstart、endにて範囲指定が可能な日付は、横に並べてスラッシュで結ぶ。
                        
                          - 「公開日」（Publish Date）の行には表示されない。
                
                  - メタデータ行での「Notes」カラムにメモを残せる
                
                  - メタデータ行での「置換」（Replacement）カラムに［↑］または［↓］ボタンが表示される。これらを押すことで、メタデータ属性入力エリアの表示位置が入れ替わる。
                
                  - 「公開日」（Publish Date）の行にはこれらのボタンが表示されず、必ず１番上になる。
                
                  - ※「公開日」（Publish Date）の１つ下の項目は、［↑］ボタンが無効になって、1番下の項目は、［↓］ボタンが無効になる。
                
                  - メタデータ行での「削除」（Delete）カラムに［×］ボタンが表示される。これを押すことで、メタデータを削除する。
                    
                      - 「公開日」（Publish Date）は必須項目であるため、［×］ボタンが表示されず、削除できない。
            
              - 子項目に対して
                
                  - 【Properties画面】で「"editAble": true」を設定した子項目は、当該画面で設定内容を編集できる
                    
                      - 子項目について、入力形式が「Select」「Radios」「Checkboxes」の場合は当該画面でいずれかの選択ができる
                    
                      - 子項目ごとに、アイテム詳細画面およびアイテム登録画面（ワークフローのItem Registration）で表示する項目名を編集できる
                    
                      - 子項目ごとに、「Required」「Show List」「Specify Newline」「Hide」「Non Display on Detail」の設定ができる
                    
                      - 「Non Display on Detail」が指定された場合は詳細画面に当該項目を表示しない
                    
                      - システム入力項目タイプ（S\_から始まる入力項目タイプ）をプルダウンに表示しない
                
                  - 「"editAble": true」が設定されていない場合、選択肢の入力エリアは非活性で表示される
            
              - オプションの優先度について  
                親要素と子要素のオプションの優先度は、以下の通りとする。

| \[凡例\]●：チェックあり -：チェックなし |    |    |               |
| ----------------------- | -- | -- | ------------- |
| \#                      | 親  | 子  | オプション         |
| 1                       | ●  | \- | 子要素全体に適用      |
| 2                       | \- | ●  | 指定された子要素のみ適用  |
| 3                       | ●  | ●  | 親のみ選択された状況と同様 |

  - 「保存」（Save）ボタンを押すと、アイテムタイプを保存する。  
    新規作成されたアイテムタイプは「標準アイテムタイプ」のリストの末尾に追加される。

  - アイテムタイプIDは、item\_typeテーブルでシーケンスのnextvalによって払い出される。

  - 新規作成されたアイテムタイプのアイテムタイプIDは、40001以降になる。

<!-- end list -->

  - アイテムタイプのコピー
    
      - アイテムタイプ種類（標準アイテムタイプ、またはハーベスト用アイテムタイプ）を選択する。
    
      - アイテムタイプ選択プルダウンより、コピーするアイテムタイプを選択する。
    
      - アイテムタイプ名を入力して、「新規登録」（New Registration）ラジオボタンを選択した状態で、「保存」（Save）ボタンを押すと、アイテムタイプが保存される。
        
          - アイテムタイプのバージョン情報は引き継がないものとする。
        
          - ハーベスト用アイテムタイプをコピーした場合は、標準アイテムタイプとして保存する。

  - アイテムタイプの編集
    
      - アイテムタイプの名前
        
          - アイテムタイプ選択プルダウンより変更するアイテムタイプを選択された状態で、アイテムタイプ名を入力して、「バージョンアップ」（Version Upgrade）ラジオボタンを選択してから、「保存」（Save）ボタンを押すと、アイテムタイプの名前が保存される。
        
          - 「保存」（Save）ボタンを押すと、編集内容を保存する
            
              - アイテムタイプのバージョンを更新しない操作について以下の通りである
                
                  - オプションを変更する
                
                  - 項目の表示位置を並び替える
                
                  - ［Notes］にメモを変更する
                
                  - 変更しないで、［保存］を押す
    
      - インポート中はアイテムタイプの編集不可とする。

  - アイテムタイプの削除
    
      - アイテムタイプを表示した状態で「削除」（Delete）ボタンを押すと、削除確認用のダイアログが表示される  
        メッセージ：  
        日本語：「このアイテムタイプを削除してよろしいですか？」  
        英語：「Are you sure you want to delete this Item type?」
        
          - 「継続」（Continue）ボタンを押すと、アイテムタイプを選択するプルダウンで選択されているアイテムタイプが論理削除される。その後、メタデータ画面を再読み込みする。
        
          - 「キャンセル」（Cancel）ボタンを押すと、削除確認用のダイアログを閉じる
    
      - ただし、以下の場合は削除不可とする
        
          - ハーベスト用のアイテムタイプは、ハーベスト用アイテムは削除できない旨のメッセージを表示のうえ削除不可とする
        
          - 標準アイテムタイプのうち所属アイテムが存在するアイテムタイプは、所属アイテムが存在するため削除できない旨のメッセージを表示のうえ削除不可とする
    
      - インポート中はアイテムタイプの削除は不可とする。

  - 論理削除したアイテムタイプを復元できる
    
      - アイテムタイプ作成/編集画面に「復元」（Restore）ボタンを設ける
    
      - 「削除済みアイテムタイプ」（Deleted Item Type）ラジオボタンを選択した時のみに、「復元」（Restore）ボタンを活性化とする
    
      - アイテムタイプの復元手順は以下の通りである
        
          - 削除済みアイテムタイプ」（Deleted Item Type）ラジオボタンを選択すると、アイテムタイプ選択プルダウンに削除されたアイテムタイプが一覧表示される。
        
          - プルダウンより復元したいアイテムタイプを選択し、「復元」（Restore）ボタンを押すと、該当アイテムタイプが「標準アイテムタイプ」（Standard Item Type）プルダウンより選択可能となり利用可能となる。（「削除済みアイテムタイプ」（Deleted Item Type）プルダウンからは削除される）

  - テキストプロパティ⇔テキストエリアプロパティ以外のプロパティは変更できないように、アイテムタイプに存在するプロパティのプルダウンリストを非活性にする

  - 新規にプロパティを追加する場合は、従来通りプロパティは選択できるようにする

  - 以下のプロパティの子要素については「Separate options with the | character」と表示する  
    これらの項目はプロパティ画面では情報を管理せず、アイテム登録／編集時に自動的に選択肢を表示する
    
      - 作成者プロパティ「作成者識別子Scheme」
    
      - 寄与者プロパティ「寄与者識別子Scheme」
    
      - 権利者情報プロパティ「権利者識別子Scheme」
        
          - アイテム登録／編集時に表示される「作成者識別子Scheme」,「寄与者識別子Scheme」,「権利者識別子Scheme」の選択肢はAuthor Management画面のID PrefixタブにあるScheme（authors\_prefix\_settingsテーブルに登録されているもの）を参照している
    
      - ファイル情報プロパティ「日付タイプ」「グループ」「ライセンス」
        
          - 「日付タイプ」はコンテンツファイル登録時の公開日として"Available"が自動設定される（Item Registration画面にはプルダウンリストが表示されない）
        
          - 「グループ」は作成したユーザーアカウントの管理画面で作成したグループ（accounts\_groupテーブルに登録されているもの）を参照している
        
          - > 「ライセンス」はCCライセンス情報を参照している
            
              - > modules/weko-records-ui/weko\_records\_ui/config.pyのWEKO\_RECORDS\_UI\_LICENSE\_DICTで定義している。
            
              - > これを、scripts/instance.cfgのWEKO\_RECORDS\_UI\_LICENSE\_DICTで上書きしている。current\_app.config\['WEKO\_RECORDS\_UI\_LICENSE\_DICT'\]はscripts/instance.cfgの方を参照する。

  - エクスポート
    
      - ［標準アイテムタイプ］ラジオボタンを選択して、プルダウンのアイテムタイプを選択した状態で、［エクスポート］ボタンを押すと、そのアイテムタイプの定義を表すJSONファイルを含んだZIPファイルがダウンロードされる。
    
      - 存在しないアイテムタイプ、削除済みアイテムタイプ、ハーベスト用アイテムタイプの場合はエクスポートされない。

  - インポート
    
      - ［インポート］ボタンを押すと、画面に「Import」エリアが表示される。
    
      - ［ファイルを選択］ボタンを押すと表示されるファイル選択ダイアログで、エクスポートされたZIPファイルを選択する。
    
      - 「Item Type」テキストボックスにアイテムタイプ名を入力する。
    
      - ［Execute Import］ボタンを押すと、「Item Type」テキストボックスに入力したアイテムタイプ名でアイテムタイプが取り込まれる。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - weko-itemtypes-ui

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - HTMLテンプレート
    
      - パス：<https://github.com/RCOSDP/weko/blob/hfix/modules/weko-itemtypes-ui/weko_itemtypes_ui/config.py#L29-L31>
        
          - 設定キー: WEKO\_ITEMTYPES\_UI\_ADMIN\_REGISTER\_TEMPLATE = \\  
            'weko\_itemtypes\_ui/admin/create\_itemtype.html'  
            """Register template for the item type page."""

  - デフォルトプロパティの表示・非表示
    
      - パス: <https://github.com/RCOSDP/weko/blob/hfix/modules/weko-itemtypes-ui/weko_itemtypes_ui/config.py#L44-L45>
        
          - 設定キー: WEKO\_ITEMTYPES\_UI\_SHOW\_DEFAULT\_PROPERTIES = True  
            """Set to show or hide default properties on the item type page."""  
            デフォルト：True（表示）。False: 非表示。

  - デフォルトプロパティ一覧
    
      - パス: <https://github.com/RCOSDP/weko/blob/hfix/modules/weko-itemtypes-ui/weko_itemtypes_ui/config.py#L47-L55>
        
          - 設定キー: WEKO\_ITEMTYPES\_UI\_DEFAULT\_PROPERTIES = {  
            '1': {'name': \_('Text Field'), 'value': 'text'},  
            '2': {'name': \_('Text Area'), 'value': 'textarea'},  
            '3': {'name': \_('Check Box'), 'value': 'checkboxes'},  
            '4': {'name': \_('Radio Button'), 'value': 'radios'},  
            '5': {'name': \_('List Box'), 'value': 'select'},  
            '6': {'name': \_('Date'), 'value': 'datetime'}  
            }  
            """Default properties of the item type."""

  - 課金ファイルをプロパティ画面に表示する・しないかの設定
    
      - パス: <https://github.com/RCOSDP/weko/blob/hfix/modules/weko-itemtypes-ui/weko_itemtypes_ui/config.py#L57-L58>
        
          - 設定キー: WEKO\_BILLING\_FILE\_ACCESS = 1  
            """Show billing file property in list."""  
            1: システム管理者のユーザーID。  
            1のみ表示する。1以外、プロパティ画面に表示しない。

  - 課金ファイルのプロパティであるかどうか判断するための設定
    
      - パス: <https://github.com/RCOSDP/weko/blob/b81efc2b8d1b3af838c0910798050c25a19f1f41/modules/weko-itemtypes-ui/weko_itemtypes_ui/config.py#L60-L61>
        
          - 設定キー: WEKO\_BILLING\_FILE\_PROP\_ATT = 'billing\_file\_prop'  
            """Attribute to detect billing file property."""  
            （課金ファイルをプロパティ画面に表示する・しない時に合わせて利用される。）

  - アイテムタイプのバージョンアップ機能を有効にする・しない設定
    
      - パス: <https://github.com/RCOSDP/weko/blob/hfix/modules/weko-itemtypes-ui/weko_itemtypes_ui/config.py#L66-L67>
        
          - 設定キー: = True  
            """Enable Upgrade Version."""  
            True: バージョンアップを有効にする.  
            False: バージョンアップを無効にする

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>

### マッピング

  - > 目的・用途

本機能は、アイテムタイプマッピングを設定する機能である

  - > 利用方法

【Administration \> アイテムタイプ管理（Item Types） \> マッピング（Mapping）画面】にて操作する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

1 アイテムタイプマッピングを設定する

  - 【前提条件】  
    マッピングするOAI-PMHスキーマが【Administration \> アイテムタイプ管理 \> OAI Schema画面】に追加済み  
    OAI-PMHスキーマの追加については、[ADMIN-1-3: OAIスキーマ](\\l)を参照
    
      - デフォルトで設定できるマッピングは、以下の通りである。
        
          - jpcoar\_mapping：JPCOARスキーマに対応
        
          - jpcoar\_v1\_mapping：JPCOAR v1スキーマに対応
        
          - jpcoar\_v2\_mapping：JPCOAR v2スキーマに対応
        
          - oai\_dc\_mapping：Dublin Coreスキーマに対応
        
          - ddi\_mapping：DDIスキーマに対応
        
          - lom\_mapping：lomスキーマに対応

  - 「アイテムタイプリスト」（Item Type List）、「スキーマリスト」（Schema List）プルダウンを設ける
    
      - 「アイテムタイプリスト」（Item Type List）プルダウンに標準アイテムタイプとハーベスト用のアイテムタイプを表示する
        
          - デフォルトの値は1番上にあるアイテムタイプとする
        
          - 選択すると、該当アイテムタイプ項目が反映される
    
      - 「スキーマリスト」（Schema List）プルダウンに【Admin \> Item Types \> OAI Schema画面】に登録されたスキーマを表示する
        
          - デフォルトの値は「jpcoar\_mapping」とする
        
          - 選択すると、該当スキーマの項目と、表示しているアイテムタイプと設定済みマッピング情報が反映される

  - 「システムが付与したアイテムタイプ」（Item type added by system）、「アイテムタイプ」（Item Type）のマッピングエリアを設ける
    
      - 「システムが付与したアイテムタイプ」（Item type added by system）：システムが付与した項目のマッピングエリアである
    
      - 「アイテムタイプ」（Item Type）：アイテムタイプに設定された項目のマッピングエリアである

  - 「アイテムタイプ」（Item Type）のマッピングエリアはアイテムタイプ(親)とアイテムタイプ（子）エリアに分ける
    
      - アイテムタイプ(親)エリア
        
          - アイテムタイプ親要素の項目を表示する。並び順は アイテムタイプ画面の項目並び順と合わせる
        
          - 選択しているスキーマ親要素をプルダウンに表示する
            
              - アイテムタイプ子要素の項目とマッピングするため、スキーマ親要素の前にラジオボタンを設ける
            
              - 1つのアイテムタイプ親要素の項目が複数マッピングするため、各のアイテムタイプ親要素行に「追加」（Add）ボタンを設ける
                
                  - クリックすると、スキーマ親要素の選択プルダウンエリアを追加する
            
              - 各のアイテムタイプ親要素行の「×」ボタンを押すことで、該当スキーマ親要素の選択プルダウンエリアを削除する
    
      - アイテムタイプ(子)エリア
        
          - スキーマ親要素プルダウンより選択して、ラジオボタンをクリックすると、アイテムタイプ子要素の項目とスキーマ子要素の項目が画面の下部に表示される
        
          - スキーマ子要素の選択プルダウンは選択済みのものは非活性表示(選択不可)とし、同一項目を複数個設定できない
        
          - 複数アイテムタイプ子要素を1つのスキーマ子要素にマッピングできるため、「Join」ボタンを設ける
            
              - クリックすると、アイテムタイプ子要素の選択プルダウンエリアを追加する
            
              - また、DBに保存する時、各アイテムタイプ子要素を区切るため、文字を「入力欄」テキストボックスに入力する  
                対応している区切り文字はコンマ（","）である
            
              - joinの項目欄にコンマ（","）を入力することで、OAI-PMH出力で複数のタグとして出力される
        
          - 各アイテムタイプ子要素行にある「削除」（Delete）ボタンを押すことで、該当アイテムタイプ子要素行を削除する
        
          - アイテムタイプ子要素に対して固定値のメタデータをOAI-PMH出力させるために、「Add static value」ボタンを設ける。
            
              - クリックすると、アイテムタイプ子要素として新たに行が追加される。
            
              - この行の、「input static value」と表示されている欄に入力した内容は、OAI-PMH出力時に固定値として出力される。
            
              - この固定値を設定した場合でも、ワークフローのアクティビティ編集画面には空欄が表示される。また、この空欄に別の値を入力した場合は、コンテンツ詳細画面においてはその値が表示されるが、OAI-PMH出力のデータには固定値が出力される。

  - 「保存」（Save）ボタンを押すと、設定内容を保存し、メッセージを画面の上部に表示する  
    メッセージ：  
    日本語：「新しいマッピングを保存しました」  
    英語：「Successfully saved new mapping.」

2 システムが付与したアイテムタイプをマッピングする

  - 【前提条件】  
    マッピングするOAI-PMHスキーマが【Administration \> アイテムタイプ管理 \> OAI Schema画面】に追加済み

  - WEKOでのシステム操作を介して作成されるデータを、スキーマ項目に画面上でマッピング可能とする

  - 対象データは、以下とする
    
      - 永続識別子（DOI）
    
      - 永続識別子（HDL）
    
      - 永続識別子（URI）
    
      - ファイル情報

  - 【注意事項】
    
      - 永続識別子（DOI）に対して、他の永続識別子（HDL及びURI）の場合、OAI-PMH出力できる
    
      - ファイル情報に対して、ファイルURLがOAI-PMH出力できるために、［アイテムタイプ（親）］での［ファイル情報］または［課金ファイル情報］項目のマッピングとあわせて、JPCOARでのスキーマ（親）の［system\_file.URI］とマッピングする必要がある

3 マッピングが重複する場合

titleのマッピングが重複している場合は、プロパティの順序が一番先頭の値をアイテム詳細画面のタイトル、アイテム一覧のタイトル、Cite asのタイトルとして出力する。

  - OAI-PMH出力は重複したプロパティを独立して出力する。

4 公開日のマッピング

WEKO3の必須項目である「公開日」についてもマッピングすることでOAI-PMH出力をすることができる。

対応方針は以下の通り。

  - 【Administration \> アイテムタイプ管理 \> メタデータ画面】でアイテムタイプの"公開日"の「Hide」オプションがON（非表示とする）の場合
    
      - アイテムの「公開日」はOAI-PMH出力しない

  - 【Administration \> アイテムタイプ管理 \> メタデータ画面】でアイテムタイプの"公開日"の「Hide」オプションがOFF（表示する）の場合
    
      - アイテムの「公開日」をOAI-PMHに出力する

  - OAI-PMH出力にあたり、「公開日」のスキーマMappingは自由にできる（デフォルト設定はしない）ものとする  
    ※マッピングに「date」を設定した場合、(JPCOARとしては非推奨だが)DataTypeは未設定でdatacite:dateに公開日のみ出力する

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - weko-itemtypes-ui

<!-- end list -->

  - > 関連テーブル

<!-- end list -->

  - アイテムタイプリスト：item\_typeテーブルから取得したアイテムタイプ
    
      - １つアイテムタイプを選択する場合、item\_type\_mappingからのマッピング情報を読み取る

  - スキーマリスト：oaiserver\_schemaテーブルから取得したスキーマ一覧
    
      - １つスキーマを選択する場合、選択中のアイテムタイプと、選択中のスキーマに該当するマッピング情報を、item\_type\_mappingから読み取る

  - 画面の「保存」ボタンを押下する場合、画面に設定している情報をitem\_type\_mappingと、item\_type\_mapping\_versionテーブルに格納する

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - HTMLテンプレート
    
      - パス: <https://github.com/RCOSDP/weko/blob/hfix/modules/weko-itemtypes-ui/weko_itemtypes_ui/config.py#L37-L37>
        
          - 設定キー: WEKO\_ITEMTYPES\_UI\_ADMIN\_MAPPING\_TEMPLATE = \\  
            'weko\_itemtypes\_ui/admin/create\_mapping.html'  
            """Mapping template for the item type page."""

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>

### OAIスキーマ

  - > 目的・用途

<!-- end list -->

  - > 利用方法

【Administration \> アイテムタイプ管理（Item Types） \> OAIスキーマ（OAI Schema）画面】にて操作する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - ［Add Schema］ボタンを押すと、アップロード画面が表示される。必要情報を入力して［保存］ボタンを押すことで、以下のスキーマとの関連付けを設定できる。
    
      - JPCOAR
    
      - JPCOAR v1
    
      - JPCOAR v2
    
      - Dublin Core
    
      - DDI
    
      - lom

  - 設定内容は以下の通りである
    
      - スキーマファイル：必須項目  
        スキーマを定義したxsdファイル、またはそれを圧縮したzipファイルをアップロードする。  
        複数ファイルをアップロードできるが、新規設定処理に使用するのは「File Name」で指定された名前のファイルのみである。
    
      - File Name：必須項目  
        アップロードしたxsdファイルのファイル名を１つだけ入力する。  
        入力値の末尾に「.xsd」がない場合、末尾に「.xsd」を加えた文字列を使用する。
    
      - Schema Name：画面では必須項目と表示されるが、処理上は必須ではない  
        OAI-PMH出力ができるように、以下のようなスキーマ名を設定する必要がある。  
        画面で入力せずに［保存］ボタンを押すと、かわりに「Root Name」の入力値を使用する。また、使用する値の末尾に「\_mapping」がない場合、末尾に「\_mapping」を加えた文字列を使用する。
        
          - Dublin Coreスキーマ：「oai\_dc」
        
          - JPCOARスキーマ：「jpcoar」
        
          - JPCOAR v1スキーマ：「jpcoar\_v1l
        
          - JPCOAR v1スキーマ：「jpcoar\_v2l
        
          - omスキーマ：「lom」
    
      - Root Name：必須項目  
        OAI-PMH出力ができるように、以下のようなルート名を設定する必要がある。  
        入力値は、「Schema Name」の入力値がない場合に使用するほか、oaiserver\_schemaテーブルのnamespacesカラム、target\_namespaceカラムの内容を作成するために使用する。
        
          - Dublin Coreスキーマ：「dc」
        
          - JPCOARスキーマ：「jpcoar」
        
          - JPCOAR v1スキーマ：「jpcoarlomスキーマ：「lom」
    
      - Zip Name  
        アップロードファイルのフォーマットがzipファイルの場合、必須項目になる。  
        末尾が「.zip」である入力値が存在する場合に限り、ここで入力したzipファイル名を用いて、zipファイルを展開する。
    
      - Schema Location  
        参考情報として、スキーマが定義されているURLを入力する。
    
      - Comment  
        コメント

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - weko-schema-ui

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 全ての設定はconfig.pyに定義される。
    
      - <https://github.com/RCOSDP/weko/blob/hfix/modules/weko-schema-ui/weko_schema_ui/config.py>

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2022/11/11</p>
</blockquote></td>
<td>V0.9.27</td>
<td></td>
</tr>
</tbody>
</table>


### プロパティ

  - > 目的・用途

本機能は、アイテムタイプのメタデータが持つプロパティを管理する機能である。新規登録、および保存済みプロパティの更新ができる。

  - > 利用方法

【Administration \> アイテムタイプ管理（Item Types） \> プロパティ（Properties）画面】にて操作する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【Administration \> Item Types \> Properties画面】：プロパティを新規登録、保存済みプロパティを更新する画面である

  - プロパティを追加する
    
      - 【Administration \> Item Types \> Properties画面】にプロパティを新規登録できる
    
      - 入力項目は以下の通りである
        
          - 「プロパティ名」（Property Name）テキストボックス  
            プロパティ名を入力する
        
          - 「+Add」ボタンを押すことで、プロパティ属性の入力エリアを表示する
            
              - 項目名のテキストエリア
                
                  - デフォルト：空白
            
              - 入力形式プルダウン
                
                  - デフォルト：「Text」
                
                  - 「Text」：1行のテキストで値を入力する
                
                  - 「Textarea」：複数行のテキストで値を入力する
                
                  - 「Checkboxes」：複数選択のチェックボックスで値を入力する
                
                  - 「Radios」：単一選択のラジオボタンで値を入力する
                
                  - 「Select」：単一選択のプルダウンメニューで値を入力する
                
                  - 「Datetime」：以下の形式で値を入力する
                    
                      - yyyy-mm-dd、yyyy-mm、yyyy形式で入力
                    
                      - エリアフォーカス時に表示するカレンダーで日付を選択して入力する
                
                  - 「List」：複数の項目を繰り返し入力できる。入力項目がセットになっている  
                    例：「権利者情報」プロパティの「権利者識別子」が該当する
                
                  - 「Object」：複数の項目を入力する。入力項目がセットになっている  
                    例：「作成者」プロパティの「作成者所属」が該当する
                
                  - 注意事項
                    
                      - 入力形式で、「Checkboxes」、「Radios」、または「Select」を選択した場合、選択肢入力欄が表示される。選択肢入力欄には、各選択肢を「|」（半角パイプ）区切りでする  
                        例：AAA|BBB|CCC
                    
                      - また、選択式(プルダウン)を選択した場合、選択肢を選択した後未選択状態に戻るため、選択肢の先頭に空白が追加される
        
          - 入力が必須な属性を設定できるように、「Required」チェックボックスを設ける
        
          - 「JSONスキーマ」（Json Schema）ボタンを押すと、設定したプロパティ情報が、項目の下のテキストエリア、「フォーム(単数)」（Form(Singular)）及び「フォーム(複数)」（Form(Multiple)）にJSON形式で表示する
            
              - 注意事項
                
                  - システムプロパティとして追加する場合、該当subitemに「"system\_prop" : true 」を追加する
                    
                      - 課金ファイルのプロパティとして追加する場合、該当subitemに「"billing\_file\_prop":true」を追加する
                
                  - 入力形式で、「Checkboxes」、「Radios」、または「Select」を選択した場合、該当subitemに「"editAble": true」を追加することで［Meta］画面に選択肢を編集できるようになる
        
          - 項目の下のテキストエリアに直接設定した後、「リセット」（Reset）を押すと、設定した内容がプロパティ情報に反映される
    
      - 「保存」（Save）ボタンを押すと、プロパティを追加し、メッセージを表示する  
        メッセージ：「Saved property successfully.」
    
      - プロパティIDは、item\_type\_propertyテーブルでシーケンスのnextvalによって払い出される。

  - プロパティを編集する
    
      - 【Administration \> Item Types \> Properties画面】に保存されたプロパティを更新できる
    
      - 保存されたプロパティのプルダウンを画面の上部に設ける
    
      - プロパティのプルダウンからプロパティを選択すると、プロパティの情報を表示する
    
      - プロパティの情報を編集してから、「保存」（Save）ボタンを押すと、プロパティの情報を更新し、メッセージを表示する  
        メッセージ：「Saved property successfully.」
    
      - 注意事項
        
          - 編集不可として、プルダウンに表示されないプロパティがある。
            
              - システムプロパティ（subitemに「"system\_prop" : true 」が含まれるもの）は表示されない。
            
              - 課金ファイルをプロパティ画面に表示しない設定であるとき、課金ファイルのプロパティ（subitemに「"billing\_file\_prop":true」が含まれるもの）は表示されない。

各プロパティの構成

  - ファイル
    
      - アイテム登録画面でファイルをアップロードすると、表示名、フォーマット、サイズを自動設定する
    
      - アップロードしたファイルのフォーマット・ファイルサイズをDBに格納する  
        \*\*Meta画面のAllow Multipleのオプションはオンに設定し非活性

| プロパティ定義     | 備考       |           |          |                                                             |
| ----------- | -------- | --------- | -------- | ----------------------------------------------------------- |
| アクセス        | Radios   | \-        | \-       |                                                             |
| オープンアクセスの日付 | List     | 日付        | Datetime | "アクセス"で"オープンアクセス日を指定する"を選択したときに登録する                         |
|             |          | タイプ       | Select   | 日付タイプは「Available」固定（Item Registration画面では入力エリアは存在しない）       |
| 表示形式        | Select   | \-        | \-       |                                                             |
| 日付          | List     | 日付        | Datetime |                                                             |
|             |          | 日付タイプ     | Select   | JPCOAR v1の日付のdateTypeの統制語彙の内容（Available以外）がJSONスキーマで設定されている |
|             |          |           |          | https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/12            |
| 表示名         | Text     | \-        | \-       | ファイル名を登録する                                                  |
| サイズ         | List     | サイズ       | Text     | コンテンツファイルのサイズを取得して自動で登録される                                  |
| フォーマット      | Text     | \-        | \-       | コンテンツファイルのMIMEタイプを取得して自動で登録される                              |
| グループ        | Select   | \-        | \-       | "アクセス"で"ログインユーザのみ"を選択したときに登録する                              |
| 自由ライセンス     | Textarea | \-        | \-       | "ライセンス"で"write your own license"を選択した場合に登録する                |
| ライセンス       | Select   | \-        | \-       |                                                             |
| 本文URL       | Object   | 本文URL     | Text     | コンテンツファイルの格納先が自動で登録される                                      |
|             |          |           |          | コンテンツファイルが無い場合は手入力でURLを入力可能                                 |
|             |          | ラベル       | Text     |                                                             |
|             |          | オブジェクトタイプ | Select   | 選択肢                                                         |
|             |          |           |          | abstract/summary/fulltext/thumbnail/other                   |
| バージョン情報     | Text     | \-        | \-       |                                                             |

  - 課金ファイル
    
      - コンテンツのアクセスを「ログインユーザのみ」とした場合、グループと金額を入力するエリアを表示する
    
      - グループと金額は複数設定でき、\[New\]ボタン押下で追加できる
    
      - 削除時は\[×\]ボタンで削除する(他の要素と同じ仕様にする)
    
      - アイテム登録画面でファイルをアップロードすると、表示名を自動設定する
    
      - アップロードしたファイルのフォーマット・ファイルサイズをDBに格納する
    
      - Meta画面のAllow Multipleのオプションはオンに設定し非活性

<table>
<thead>
<tr class="header">
<th>プロパティ定義　</th>
<th>備考</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>アクセス</td>
<td>Radios</td>
<td>-</td>
<td>-</td>
<td></td>
</tr>
<tr class="even">
<td>オープンアクセスの日付</td>
<td>List</td>
<td>日付</td>
<td>Datetime</td>
<td><p>"アクセス"で"オープンアクセス日を指定する"を選択したときに登録する</p>
<p>Item Registration画面では「公開日」と表示される</p></td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>タイプ</td>
<td>Select</td>
<td>日付タイプは「Available」固定（Item Registration画面では入力エリアは存在しない）</td>
</tr>
<tr class="even">
<td>表示形式</td>
<td>Select</td>
<td>-</td>
<td>-</td>
<td></td>
</tr>
<tr class="odd">
<td>日付</td>
<td>List</td>
<td>日付</td>
<td>Datetime</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>日付タイプ</td>
<td>Select</td>
<td>JPCOAR v1の日付のdateTypeの統制語彙の内容（Available以外）がJSONスキーマで設定されている</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
<td></td>
<td>https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/12</td>
</tr>
<tr class="even">
<td>表示名</td>
<td>Text</td>
<td>-</td>
<td>-</td>
<td>ファイル名を登録する</td>
</tr>
<tr class="odd">
<td>サイズ</td>
<td>List</td>
<td>サイズ</td>
<td>Text</td>
<td>コンテンツファイルのサイズを取得して自動で登録される（Item Registration画面では入力エリアは存在しない）</td>
</tr>
<tr class="even">
<td>フォーマット</td>
<td>Text</td>
<td>-</td>
<td>-</td>
<td>コンテンツファイルのMIMEタイプを取得して自動で登録される（Item Registration画面では入力エリアは存在しない）</td>
</tr>
<tr class="odd">
<td>グループ・価格</td>
<td>List</td>
<td>グループ</td>
<td>Select</td>
<td>"アクセス"で"ログインユーザのみ"を選択したときに登録する</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>価格</td>
<td>Text</td>
<td></td>
</tr>
<tr class="odd">
<td>自由ライセンス</td>
<td>Textarea</td>
<td>-</td>
<td>-</td>
<td>"ライセンス"で"write your own license"を選択した場合に登録する</td>
</tr>
<tr class="even">
<td>ライセンス</td>
<td>Select</td>
<td>-</td>
<td>-</td>
<td></td>
</tr>
<tr class="odd">
<td>本文URL</td>
<td>Object</td>
<td>本文URL</td>
<td>Text</td>
<td>コンテンツファイルの格納先が自動で登録される（Item Registration画面では入力エリアは存在しない）</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>ラベル</td>
<td>Text</td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>オブジェクトタイプ</td>
<td>Select</td>
<td>JPCOAR v1のファイル情報の本文URLのobjectTypeの統制語彙の内容がJSONスキーマで設定されている</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
<td></td>
<td>https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/35-.1</td>
</tr>
<tr class="odd">
<td>バージョン情報</td>
<td>Text</td>
<td>-</td>
<td>-</td>
<td></td>
</tr>
<tr class="even">
<td>Is Billing</td>
<td>Text</td>
<td></td>
<td></td>
<td>Item Registration画面では入力エリアは存在しない</td>
</tr>
</tbody>
</table>

  - サムネイル
    
      - サムネイルプロパティがアイテムタイプに含まれていると、アイテム登録時にサムネイルアップロードエリアが表示される
    
      - オプションHideのチェックがオフの場合に、アイテム詳細画面でサムネイル画像が表示される

| プロパティ定義 | 備考   |     |      |  |
| ------- | ---- | --- | ---- |  |
| URI     | List | ラベル | Text |  |
|         |      | URI | Text |  |

  - 作成者
    
      - 作成者識別子SchemeをID Prefixから自動で取得する
    
      - 作成者識別子と作成者識別子Schemeから自動設定されるため、作成者識別子URIは非活性項目になっている
    
      - アイテム詳細画面でリンク形式（押下後ポップアップ）として表示される

| プロパティ定義    | 備考   |              |        |               |        |  |
| ---------- | ---- | ------------ | ------ | ------------- | ------ |  |
| 作成者識別子     | List | 作成者識別子       | Text   |               |        |  |
|            |      | 作成者識別子Scheme | Select |               |        |  |
|            |      | 作成者識別子URI    | Text   |               |        |  |
| 作成者姓名      | List | 姓名           | Text   |               |        |  |
|            |      | 言語           | Select |               |        |  |
| 作成者姓       | List | 姓            | Text   |               |        |  |
|            |      | 言語           | Select |               |        |  |
| 作成者名       | List | 名            | Text   |               |        |  |
|            |      | 言語           | Select |               |        |  |
| 作成者別名      | List | 別名           | Text   |               |        |  |
|            |      | 言語           | Select |               |        |  |
| 作成者メールアドレス | Text | \-           | \-     |               |        |  |
| 作成者所属      | List | 所属機関識別子      | List   | 所属機関識別子       | Text   |  |
|            |      |              |        | 所属機関識別子Scheme | Select |  |
|            |      |              |        | 所属機関識別子URI    | Text   |  |
|            |      | 所属機関名        | List   | 所属機関名         | Text   |  |
|            |      |              |        | 言語            | Select |  |

  - 寄与者
    
      - 寄与者識別子SchemeをID Prefixから自動で取得する
    
      - 寄与者識別子と寄与者識別子Schemeから自動設定されるため、寄与者識別子URIは非活性項目になっている

| プロパティ定義    | 備考     |              |        |                                                        |        |  |
| ---------- | ------ | ------------ | ------ | ------------------------------------------------------ | ------ |  |
| 寄与者タイプ     | Select | \-           | \-     | JPCOAR v1の寄与者のcontributorTypeの統制語彙の内容がJSONスキーマで設定されている |        |  |
|            |        |              |        | https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/4        |        |  |
| 寄与者識別子     | List   | 寄与者識別子       | Text   |                                                        |        |  |
|            |        | 寄与者識別子Scheme | Select |                                                        |        |  |
|            |        | 寄与者識別子URI    | Text   |                                                        |        |  |
| 寄与者姓名      | List   | 姓名           | Text   |                                                        |        |  |
|            |        | 言語           | Select |                                                        |        |  |
| 寄与者姓       | List   | 姓            | Text   |                                                        |        |  |
|            |        | 言語           | Select |                                                        |        |  |
| 寄与者名       | List   | 名            | Text   |                                                        |        |  |
|            |        | 言語           | Select |                                                        |        |  |
| 寄与者別名      | List   | 別名           | Text   |                                                        |        |  |
|            |        | 言語           | Select |                                                        |        |  |
| 寄与者メールアドレス | Text   | \-           | \-     |                                                        |        |  |
| 寄与者所属      | List   | 所属機関識別子      | List   | 所属機関識別子                                                | Text   |  |
|            |        |              |        | 所属機関識別子Scheme                                          | Select |  |
|            |        |              |        | 所属機関識別子URI                                             | Text   |  |
|            |        | 所属機関名        | List   | 所属機関名                                                  | Text   |  |
|            |        |              |        | 言語                                                     | Select |  |

  - 権利者情報
    
      - 権利者識別子SchemeをID Prefixから自動で取得する
    
      - 権利者識別子と権利者識別子Schemeから自動設定されるため、権利者識別子URIは非活性項目になっている

| プロパティ定義 | 備考   |              |        |  |
| ------- | ---- | ------------ | ------ |  |
| 権利者識別子  | List | 権利者識別子       | Text   |  |
|         |      | 権利者識別子Scheme | Select |  |
|         |      | 権利者識別子URI    | Text   |  |
| 権利者名    | List | 名            | Text   |  |
|         |      | 言語           | Select |  |

  - 書誌情報
    
      - アイテム詳細画面で巻・号・ページ数などをまとめて表示する

| プロパティ定義 | 備考   |       |          |  |
| ------- | ---- | ----- | -------- |  |
| 雑誌名     | List | タイトル  | Text     |  |
|         |      | 言語    | Select   |  |
| 巻       | Text |       |          |  |
| 号       | Text |       |          |  |
| 開始ページ   | Text |       |          |  |
| 終了ページ   | Text |       |          |  |
| ページ数    | Text |       |          |  |
| 発行日     | List | 日付    | Datetime |  |
|         |      | 日付タイプ | Text     |  |

  - 資源タイプ
    
      - 資源タイプ識別子が非活性項目になっている
    
      - 資源タイプを選択すると、対応する資源タイプ識別子が自動で設定される

<table>
<thead>
<tr class="header">
<th>プロパティ定義</th>
<th>備考</th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>資源タイプ</td>
<td>Select</td>
<td>JPCOAR v1のobjectType統制語彙の内容にJPCOAR v2の資源タイプのdc:typeの統制語彙の一部を加えたものがJSONスキーマで設定されている</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td><p><a href="https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/14">https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/14</a></p>
<p>https://schema.irdb.nii.ac.jp/ja/schema/2.0/15</p></td>
</tr>
<tr class="odd">
<td>資源タイプ識別子</td>
<td>Text</td>
<td></td>
</tr>
</tbody>
</table>

  - ID登録
    
      - 非活性項目になっている
    
      - ワークフローの IdentifierGrant を経てアイテム登録が完了後、編集画面で入力された値を確認できる

| プロパティ定義 | 備考     |  |
| ------- | ------ |  |
| ID登録タイプ | Select |  |
| ID登録    | Text   |  |

  - 出版タイプ
    
      - 出版タイプresourceが非活性項目になっている
    
      - 出版タイプを選択すると、対応する出版タイプresourceが自動で設定される

| プロパティ定義       | 備考     |                                                        |
| ------------- | ------ | ------------------------------------------------------ |
| 出版タイプ         | Select | JPCOAR v1の出版タイプのoaire:versionの統制語彙の内容がJSONスキーマで設定されている |
|               |        | https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/16       |
| 出版タイプResource | Text   |                                                        |

  - アクセス権
    
      - アクセス権URIが非活性項目になっている
    
      - アクセス権を選択すると、対応するアクセス権URIが自動で設定される

| プロパティ定義  | 備考     |                                                               |
| -------- | ------ | ------------------------------------------------------------- |
| アクセス権    | Select | JPCOAR v1のアクセス権のdcterms:accessRightsの統制語彙の内容がJSONスキーマで設定されている |
|          |        | https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/5               |
| アクセス権URI | Text   |                                                               |

  - 識別子
    
      - OAI-PMH出力として用意されているもの
    
      - メタデータのエリアには表示せず、Permalink欄に「DOI \> HDL \> URI」の優先順で表示する（永続識別子）

  - 公開日
    
      - WEKO3のアイテムの表示／非表示として管理しているもの
    
      - アイテム登録時の必須項目であり、アイテム詳細画面に表示される
    
      - 「Hide」オプションの制御に従って、アイテムの「公開日」をOAI-PMH出力する

<!-- end list -->

  - 
  - > 関連モジュール

<!-- end list -->

  - weko-itemtypes-ui

<!-- end list -->

  - > 関連テーブル

<!-- end list -->

  - 画面の一番上のプルダウン：item\_type\_propertyテーブルから取得したプロパティ一覧
    
      - １つプロパティを選択する場合、item\_type\_propertyテーブルから該当のプロパティの情報を読み取る。

  - 画面の「保存」ボタンを押下する場合、画面に設定している情報をitem\_type\_propertyテーブルの該当プロパティに反映する。

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - HTMLテンプレート
    
      - パス: <https://github.com/RCOSDP/weko/blob/hfix/modules/weko-itemtypes-ui/weko_itemtypes_ui/config.py#L33-L35>　
        
          - 設定キー: WEKO\_ITEMTYPES\_UI\_ADMIN\_CREATE\_PROPERTY = \\  
            'weko\_itemtypes\_ui/admin/create\_property.html'  
            """Create property template."""

  - 課金ファイルをプロパティ画面に表示する・しないかの設定
    
      - パス: <https://github.com/RCOSDP/weko/blob/hfix/modules/weko-itemtypes-ui/weko_itemtypes_ui/config.py#L57-L58>
        
          - 設定キー: WEKO\_BILLING\_FILE\_ACCESS = 1  
            """Show billing file property in list."""  
            1: システム管理者のユーザーID。  
            1のみ表示する。1以外、プロパティ画面に表示しない。

  - 課金ファイルのプロパティであるかどうか判断するための設定
    
      - パス: <https://github.com/RCOSDP/weko/blob/b81efc2b8d1b3af838c0910798050c25a19f1f41/modules/weko-itemtypes-ui/weko_itemtypes_ui/config.py#L60-L61>
        
          - 設定キー: WEKO\_BILLING\_FILE\_PROP\_ATT = 'billing\_file\_prop'  
            """Attribute to detect billing file property."""  
            （課金ファイルをプロパティ画面に表示する・しない時に合わせて利用される。）

  - システムプロパティであるかどうか判断するための設定
    
      - パス: <https://github.com/RCOSDP/weko/blob/hfix/modules/weko-itemtypes-ui/weko_itemtypes_ui/config.py#L63-L64>
        
          - 設定キー: WEKO\_ITEMTYPES\_UI\_DEFAULT\_PROPERTIES\_ATT = 'system\_prop'  
            """Attribute to detect property is default property which is not shown at properties screen."""

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### 一括更新

<!-- end list -->

  - > 目的・用途

アイテムに付随しているファイルに対して、ライセンス、公開日、アクセスタイプを一括で更新する機能である。

  - > 利用方法

【Administration \> アイテム管理(Items) \> 一括更新(Bulk Update)画面】を開き、更新したいアイテムを選ぶ。  
その後更新したい情報を選び、更新する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>〇</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【Administration \> アイテム管理(Items) \> 一括更新(Bulk Update)画面】：一括更新を実行する画面である。

  - 事前に更新するアイテムの変更したい項目について設定されている必要がある。  
    ファイルが登録され、それに対して、アクセスタイプ、ライセンスをアイテムに登録しておく必要がある。

  - 【一括更新画面】は、以下の表示エリアで構成する
    
      - 「インデックスツリー」（Index Tree）エリア
        
          - 【Administration \> インデックスツリー管理(Index Tree) \> ツリー編集(Edit Tree)画面】に設定されているインデックスツリーと同じに表示させる。
        
          - 任意のインデックスを選択するとインデックス配下のアイテムが「アイテムリスト」（Item list）エリアに表示される。
    
      - 「Fields For Update」エリア
        
          - 一括更新するメタデータ項目と更新内容を設定できる。
        
          - 一括更新対象のメタデータプルダウンリストは以下の項目とする。
            
              - Access Type
            
              - Licence
        
          - メタデータ項目を選択すると、該当設定オプションを表示する
            
              - Access Typeを選択すると、以下のオプションを表示する
                
                  - 「オープンアクセス」（Open Access）
                
                  - 「オープンアクセス日時」（Open Access Date）  
                    選択すると、日時を設定できる。デフォルトはサーバから取得した日付（/api/admin/get\_server\_date）とする
                
                  - 「ログインユーザのみ」（Login User Only）
            
              - Licenceを選択すると、ライセンスプルダウンリストを表示する。（アイテム登録画面に同じとする）
        
          - エリア右端に「×」ボタンが表示される。押下すると項目を削除できる。
            
              - 項目が一つだけの時、削除をすることはできない。
        
          - 複数項目を設定できるため、「フィールド追加」（Add Field）ボタンを設ける。
            
              - 押すと、更新内容の設定エリアを追加する。
        
          - メタデータプルダウンリストに同一項目を選択すると、選択不可とし、選択している項目が存在する旨のメッセージを表示する。  
            メッセージ：「Field already exists.」
    
      - 一括更新の対象アイテムの設定エリア
        
          - 「検索」（Search）エリア
            
              - 一括更新の対象アイテムを検索できる。
            
              - アイテム検索はWEKO3の詳細検索機能をそのまま利用する。
            
              - 最初に検索した時、「Item list」エリアの表示順設定は【設定\>検索設定】画面のデフォルトソート条件(キーワード検索)に従う。
            
              - 検索するごとにチェックボックスは初期化される。
        
          - 「Index List」エリア
            
              - インデックスツリーからインデックスを選択した時に表示される。
            
              - パンくずリスト、RSSアイコン、サムネイル画像を表示する。
        
          - 「アイテムリスト」（Item list）エリア
            
              - デフォルトはすべてのアイテムを表示する。
            
              - アイテムリストの表示順と表示数はWEKO3のアイテムリストをそのまま利用する。初期表示は「ID asc」の組み合わせが表示されているが、実際にはアイテムリストは「Creator asc」の順番で表示がされる。
            
              - 一括更新の対象選択ができるため、各アイテムの行頭にチェックボックスを設ける。  
                また、アイテムリストの上部に「全選択」（Select All）リンクを設けて、リンクをクリックすると、すべての表示されているアイテムは一括更新の対象とする。
            
              - アイテムの詳細を確認できるため、各アイテムがリンク形式で表示されて、リンクをクリックすると、該当アイテム詳細画面に移動する。

  - 一括更新を実行する
    
      - 一括更新の情報を設定してから、「更新」（Update）ボタンを押すと、事前確認できるため、更新内容を確認モーダルに表示する
    
      - 対象アイテムを選択しない状態で、「更新」（Update）ボタンを押すと  
        「Please select items to update.」
    
      - モーダルには以下を表示する
        
          - 「Item」：アイテムに登録しているファイル名
        
          - 「Before」
            
              - 「Access Type」：更新前のアクセスタイプ値
            
              - 「License」：更新前のライセンス値
        
          - 「After」
            
              - 「Access Type」：更新後のアクセスタイプ値
            
              - 「License」：更新後のライセンス値
        
          - 「Continue」ボタン  
            押すと、一括更新処理が行って、対応アイテムの情報とバージョンが更新される
        
          - 「閉じる」（Close）ボタン  
            押すと、モーダルを閉じる

<!-- end list -->

  - > 関連モジュール

weko\_records\_ui

  - 
  - > weko\_index\_tree

  - > weko\_records\_ui

<!-- end list -->

  - > 処理概要

> 一括更新画面表示について

  - > 【Administration \> アイテム管理(Items) \> 一括更新(Bulk Update)画面】を開いた際、以下の処理を実行する。
    
      - > weko\_index\_tree.rest.IndexTreeActionResource.getメソッドを呼び出し、インデックスツリー情報を取得する。それらを「インデックスツリー」エリアに表示する。
    
      - > weko\_records\_ui.admin. ItemManagementBulkUpdate.indexメソッドを呼び出す。詳細検索情報をget\_search\_detail\_keywordメソッドで、一括更新対象の設定をWEKO\_RECORDS\_UI\_BULK\_UPDATE\_FIELDSから (後述)、ライセンス情報をWEKO\_RECORDS\_UI\_LICENSE\_DICTから取得し、詳細検索情報と一括更新対象設定、ライセンス情報をそれぞれのエリアに表示する。

> 一括更新対象を設定する

  - パス：  
    <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/config.py>

  - 設定キー：「WEKO\_RECORDS\_UI\_BULK\_UPDATE\_FIELDS」

  - 現在の設定値：

> WEKO\_RECORDS\_UI\_BULK\_UPDATE\_FIELDS = {
> 
> 'fields': \[{'id': '1', 'name': 'Access Type'},
> 
> {'id': '2', 'name': 'Licence'}\]
> 
> }
> 
> 一括更新画面にてインデックス検索、詳細検索、簡易検索のいずれかを行う。

  - > weko\_search\_ui.rest.IndexSearchResource.getメソッドを呼び出し、検索条件にのっとったアイテムの情報を取得し、表示する。

  - > weko\_search\_ui.admin.ItemManagementBulkSearch.indexメソッドを呼び出し、様々な情報を取得し、画面に表示する。詳細は以下のgithubを参照すること。ソースコード：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-search-ui/weko_search_ui/admin.py>

> 一括更新の実行

  - > 「Item list」エリアのチェックボックスにチェックを入れないで「更新ボタン」を押した場合、weko\_records\_ui.static.js.weko\_records\_ui.bulk\_updateの135行目にてアラートが表示される処理が実行される。

  - > 更新をするアイテムにチェックを入れて「更新」ボタンを押下する。その場合、weko\_records\_ui.static.js.weko\_records\_ui.bulk\_updateの121行目からが呼び出され、それにてget\_items\_metadataメソッドが呼び出され、アイテムに所属するファイルの情報を取得し、before,afterのポップアップ画面が表示される。
    
      - > ポップアップ画面上の「閉じる」ボタンを押下すると、キャンセルされポップアップ画面は閉じる。
    
      - > 「Continue」ボタンを押下した場合、weko\_deposit.rest.publishメソッドが複数回呼ばれ、item\_metadataテーブル、item\_metadata\_versionテーブル、records\_metadataテーブルにそれぞれ更新内容を登録する。（アクセスタイプならキーaccessroleを、ライセンスならキーlicensetypeを変更して登録する。）

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>

### 一括削除

  - > 目的・用途

本機能は、管理者として、インデックスを対象にしてアイテムを一括削除する機能である。

  - > 利用方法

【Administration \> アイテム管理(Items) \> 一括削除(Bulk Delete)画面】を開き、インデックスツリーからインデックスを選択し、削除することでインデックスに所属するアイテムを一括削除することができる。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>〇</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【Administration \> アイテム管理(Items) \> 一括削除(Bulk Delete)画面】にてアイテムを一括削除する
    
      - 「インデックスツリー」（Index Tree）エリアでアイテムを一括削除するインデックスを選択する。
    
      - 「子インデックスのアイテムも削除する」（Delete items of child recursively）チェックボックスにチェックを入れることで、再帰的に子インデックスに所属するアイテムも削除できる。
    
      - 複数インデックスに所属しているアイテムが存在する場合は、当該アイテムから削除対象インデックスの所属を外す（アイテムは削除されない）。
    
      - 「削除」（Delete）ボタンを押すと、確認ダイヤログが表示されます。  
        確認メッセージ：  
        日本語：「削除してよろしいですか？」  
        英語：「 Are you sure you want to delete it?」
        
          - 「接続」（Continue）ボタンを押すと、アイテムの一括削除が実行される
        
          - 「キャンセル」（Cancel）ボタンを押すと、確認ダイヤログ’を閉じる

  - 過去のバージョンも含めて削除する（論理削除）

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko-search-ui

  - > weko\_records\_ui

<!-- end list -->

  - > 処理概要

> 一括更新画面表示について

  - > 【Administration \> アイテム管理(Items) \> 一括削除(Bulk Delete)画面】を開いた際、以下の処理を実行する。
    
      - > weko\_index\_tree.rest.IndexTreeActionResource.getメソッドを呼び出し、インデックスツリー情報を取得する。それらを「インデックスツリー」エリアに表示する。

> 削除機能について

  - > アイテムを削除したいインデックスを「インデックスツリー」エリアから選び、「削除」ボタンを押下する。この操作によって、weko\_search\_ui.admin.ItemManagementBulkDelete.indexにてdelete\_recordsメソッドが呼び出され、論理削除を行う。なお、その際、チェックボックスにチェックを入れていた場合、削除するインデックスの子インデックス以下のアイテムも論理削除する。

  - > 論理削除はrecords\_metadataテーブルのキーpublsih\_statusを-1に設定することによってweko3上で表示されなくなる。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>

### 一括エクスポート

  - > 目的・用途

本機能は、管理者として、アイテムの全件エクスポートを行う機能である。

  - > 利用方法

管理者は 【Administrationistration \> アイテム管理(Items) \> 一括エクスポート(Bulk Export)画面】を開き、アイテムの全件エクスポートを行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>〇</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - Filter：一括出力するアイテムを制限する。(v0.9.22)
    
      - 一括出力するアイテムをアイテムタイプにより制限することができる。ALLを選択した場合はすべてのアイテムタイプを出力する。
    
      - 一括出力するアイテムをアイテムIDにより制限することができる。
        
          - 全件。 何も入力していない場合。 （デフォルト）
        
          - 単一のアイテムID。 例： 50
        
          - アイテムID範囲。 例： 10‐100
        
          - あるアイテムID以後。 例： 10‐
        
          - あるアイテムID以前。 例： ‐10
    
      - 出力の結果は選択したアイテムタイプと入力したアイテムIDの積集合。 デフォルトは全件出力。
    
      - 違うユーザーが違う条件で一緒に出力可能。ダウンロードURLが同じであるが、各ユーザーが設定した条件のエクスポートが可能。
    
      - 一人のユーザーが当時に出力できる条件は一つのみである。完了しない限り、次の出力はできない。

  - the last item ID: 最も新しく作られたアイテムIDを表示する。(v0.9.2)

  - 「エクスポート」（Export）ボタン  
    Exportボタンを押すと、全件出力を実行してよいかの確認ダイアログを表示する。確認ダイアログで実行/キャンセルを選択する。
    
      - 「Execute」ボタン
        
          - 「実行」ボタンを押すと、確認用ダイアログを閉じてアイテムの全件エクスポートを行う。
        
          - 実行後はダウンロードのURLを画面上に表示する。
        
          - URLをクリックするとzipファイル(export-all.zip)をダウンロードする。  
            なお、このzipファイルにコンテンツファイルは含まれていない。
        
          - 他のユーザーがエクスポート実行中の場合、Exportボタンを非活性化する。
        
          - Celeryが起動していない場合は「実行」ボタンを非活性化する．「Celery is not running.」のエラーメッセージを表示する．(v0.9.22)
    
      - 「キャンセル」ボタン
        
          - 「キャンセル」ボタンを押すと、アイテムの全件エクスポートを行なわずわ、確認用ダイアログを閉じる。

  - 「キャンセル」（Cancel）ボタン  
    初期状態は非活性とし、Exportを実行している時に活性とする。  
    Exportを実行している時に、キャンセルボタンを押すと、Export処理のキャンセルを行う。  
    ボタンを押すと、全件エクスポートの処理をキャンセルしてよいかの確認ダイアログを表示する。
    
      - 「実行」ボタン
        
          - 「実行」ボタンを押すと、アイテムの全件エクスポートを行なわずわ、確認用ダイアログを閉じる。
    
      - 「キャンセル」ボタン
        
          - 「キャンセル」ボタンを押すと、全件エクスポート処理のキャンセルを行わず、確認用ダイアログを閉じる。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_search\_ui

  - > weko\_admin

  - > invenio\_files\_rest:ダウンロードファイル生成のみに使用

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 一括出力（一括エクスポート）画面表示時に以下の処理が行われる。
    
      - weko\_search\_ui.admin.ItemBulkExport.Indexメソッドが呼び出され画面を表示する。
    
      - weko\_search\_ui.static.js.weko\_search\_ui.export.getLastItemIdメソッドによってget\_last\_item\_idが呼び出され、一番大きなキーidを取得する。
    
      - weko\_search\_ui.static.js.weko\_search\_ui.export.getListItemTypeメソッドによってget\_itemtypesが呼び出され、アイテムタイプのリストを取得し、json形式にして取得する。

> これらの取得した情報から一括出力画面を表示する。

  - 一括出力（一括エクスポート）画面
    
      - 一括出力画面を表示している間、３秒ごとにweko\_search\_ui.static.js.weko\_search\_ui.export.checkExportStatusメソッドが呼び出される。このメソッド下でcheck\_export\_statusメソッドが呼び出され、これによってceleryが起動しているか、エクスポートできるかを確認する。
    
      - celeryが起動していない、uri\_statusがfalseの場合は「エクスポート」ボタンを不活性化する。
    
      - アイテムタイプのプルダウンからアイテムタイプを選択すると、そのアイテムタイプに属するアイテムをエクスポート対象になるようweko\_search\_ui.static.js.weko\_search\_ui.export.SelectItemChangeメソッドで設定する。
    
      - アイテムIDの入力欄に数字を入力すると出力するアイテムIDをweko\_search\_ui.static.js.weko\_search\_ui.export.InputItemIdChangeメソッドで制限する。
    
      - 「エクスポート」ボタンを押し、更にポップアップの「Excute」ボタンを押下する。その場合、weko\_search\_ui.static.js.weko\_search\_ui.export.handleExportメソッドによってexport\_allメソッドが呼び出され、更にexport\_all\_taskメソッドを呼び出す。これらによってエクスポートするアイテムのメタデータを集め、ダウンロードURLを生成し、表示させる。
        
          - エクスポートして、URLが表示されるまでの間に、「キャンセル」ボタンを押し、「execute」ボタンを押す。その場合、weko\_search\_ui.admin.ItemBulkExport.cancel\_exportメソッドが呼び出され、ダウンロードURLの生成、表示をキャンセルする。
    
      - 画面上に表示されたダウンロードURLを押下する。その場合、weko\_search\_ui.admin.ItemBulkExport.export\_allメソッドにて、 FileInstance.get\_by\_uriメソッドが呼び出され、ダウンロードファイルを生成し、ダウンロードする。なお、ダウンロードされるファイル形式はzipであり、アイテムのメタデータについてのファイルはtsv形式である。
    
      - 一括エクスポートはHide項目も含めて出力する。(メタデータプロパティがHideのものも表示する。)
    
      - エクスポート中にcheck\_celery\_is\_runメソッド、get\_export\_statusメソッドでエクスポートに必要な情報がとれない場合、ダウンロードURLは表示されない。

  - エクスポート処理実行時、テンポラリディレクトリのファイル名を以下のように設定する
    
      - > /home/invenio/.virtualenvs/invenio/var/instance/data/tmp/weko\_export\_xxxxxxxx

  - 以下の変数はweko\_admin.configで設定されている。
    
      - > 一括エクスポートはアイテムタイプ単位で出力する．1ファイルあたりの出力件数は　WEKO\_SEARCH\_UI\_BULK\_EXPORT\_LIMIT　で設定する．(v0.9.22)
    
      - > 一括エクスポート中にエラーが発生した場合は，WEKO\_SEARCH\_UI\_BULK\_EXPORT\_RETRYに指定された回数リトライする．(v0.9.22)

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>

### インポート

  - > 目的・用途

本機能は、管理者として、アイテムの一括登録を実行する機能である。

  - > 利用方法

管理者は 【Administration \> アイテム管理（Items） \> インポート（Import）画面】を開き、アイテム一括登録用のzipファイルを登録する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○※</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

※コミュニティ管理者は、自身の管理下にあるコミュニティに関連付けられたインデックスへのインポートのみ可能

  - > 機能内容

1\. 概要

  - 複数のアイテムを一括で登録する機能。システム管理者、リポジトリ管理者のみ使用できる。

  - 登録形式はBagitだが、ユーザにそれを意識させないようにしている。詳細はの1を参照。

  - 機能は3つの画面で構成されている。

  - 以下は各画面の関連と役割。

> \+----------+ ≪選択画面≫
> 
> | | ●各アイテムタイプのTSVファイルテンプレートのダウンロード
> 
> | Select | ●インポートファイルの指定
> 
> | | ●「識別子変更モード」の設定と利用規約への同意
> 
> \+----------+
> 
> ↓
> 
> ↓【Next】 button click\!
> 
> ↓
> 
> \+----------+ ≪インポート画面≫
> 
> | | ●TSVファイルで指定した項目のチェック結果の確認
> 
> | Import | ●チェック結果のダウンロード
> 
> | |
> 
> \+----------+
> 
> ↓
> 
> ↓【Import】 button click\!
> 
> ↓
> 
> \+----------+ ≪結果画面≫
> 
> | | ●アイテムごとのインポート実行結果の確認
> 
> | Result | ●インポート実行結果のダウンロード
> 
> | |
> 
> \+----------+

2\. 画面ごとの仕様

2.1 選択画面(Select)

  - 各アイテムタイプのTSVファイルテンプレートのダウンロードとインポートファイルを指定する画面。  
    また「識別子変更モード」の設定と利用規約への同意を実施する

> ────────────────────────────────────────────────
> 
> \#\# Message Area \#\# ★
> 
> ────────────────────────────────────────────────
> 
> ┌───────┐
> 
> │Select │Import Result
> 
> ┘ └─────────────────────────────────────
> 
> Select File 【Select File】①
> 
> Selected file name ②
> 
> □ Change Identifier Mode ③
> 
> 【Next】④
> 
> ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
> 
> Item Type Template
> 
> Item Type:\[ ⑤ \]【Download】⑥

★Message Area（管理画面共通）

  - インポートファイルのチェックでエラーが発生した際にメッセージを表示する。

  - 表示されるエラーメッセージは3.2(4)-1参照。

①［ファイル選択（Select File）］ボタン

  - 押下するとファイル選択ダイアログを表示する。選択可能なファイルはzip形式で1つのみ。

②Selected file name ラベル

  - ①で選択したファイル名を表示する。未選択時は「選択したファイル名（Selected file name）」を表示。

③Change Identifier Mode チェックボックス

  - DOIやCNRIを変更する際に設定する。チェックありで④を押下すると「免責事項ダイアログ」が表示される。  
    免責事項の文面は以下（テキストファイルで保持。ファイルパスはコンフィグ管理→処理概要の2を参照）

  - 免責事項ダイアログには［OK］ボタンと［キャンセル（Cancel）］ボタンがある。［OK］ボタンは、「利用規約に同意します（I agree to the terms of use.）」がチェックされるまでは非活性。［OK］ボタンを押下するとインポートファイルのチェックを行い、通過するとImport画面に遷移する。

  - チェックありの状態でImport画面に遷移してから選択画面に戻ると、選択ファイルを変更するまでは非活性になっており変更できない。

> Japanese:
> 
> 免責事項：
> 
> ・本機能は設定にかかわらずDOIを強制的に変更します。
> 
> ・本機能は内容及び自機関で登録されているDOIについて十分に理解した上で作業を行なってください。
> 
> ・本機能の利用は、自機間の責任で行なってください。
> 
> ・本機能の利用により負った損害などについては、国立情報学研究所は一切の責任を追いません。
> 
> English:
> 
> \- This function forcibly changes the DOI regardless of the setting.
> 
> \- Before starting this operation, you need fully understand the contents and DOI registered at your institution.
> 
> \- Use this function on your own responsibility.
> 
> \- National Institute of Informatics (NII) does not take any responsibility for damages caused by using this function.

④［次へ（Next）］ボタン

  - ①でファイルが選択されるまでは非活性。  
    ただし、拡張子が「zip」でないファイルが選択された場合は活性化しない。  
    押下するとインポートファイルのチェックを行い、通過するとImport画面に遷移する。  
    チェック処理については、3.2(4)を参照。

⑤Item Type セレクタ―

  - TSVファイルテンプレートをダウンロードする際、対象とするアイテムタイプを選択する。  
    【Administration \> アイテムタイプ管理（Item Types） \> メタデータ（Metadata）】画面で確認できる標準アイテムタイプ（Standard Item Type）を表示。  
    表示形式は「Item Type name(Item Type ID)」。

⑥Download ボタン

  - 押下すると⑤で選択したアイテムタイプのTSVファイルテンプレートをダウンロードする。  
    ファイルについては4.1参照。

2.2 インポート画面(Import)

  - TSVファイルで指定した項目のチェック結果の確認とチェック結果のダウンロードができる。

> ┌──────┐
> 
> Select │Import│ Result
> 
> ───────┘ └─────────────────────────────────────
> 
> \# Identifier Mode \#①
> 
> 【Import】②
> 
> Summary
> 
> Total: ③
> 
> New Item: ④
> 
> Update: ⑤
> 
> Check error: ⑥
> 
> 【Download】⑦
> 
> ┏━━━━┳━━━━━━━━━━┳━━━━━━━━┳━━━━━━┳━━━━━━━━━━━━┓
> 
> ┃No. ┃Item Type ┃Item ID ┃Title ┃Check Result┃
> 
> ┣━━━━╋━━━━━━━━━━╋━━━━━━━━╋━━━━━━╋━━━━━━━━━━━━┫
> 
> ┃ ⑧ ┃ ⑨ ┃ ⑩ ┃ ⑪ ┃ ⑫ ┃
> 
> ┗━━━━┻━━━━━━━━━━┻━━━━━━━━┻━━━━━━┻━━━━━━━━━━━━┛

①Message ラベル

  - ※名称は要検討  
    Select画面の「③Change Identifier Mode チェックボックス」にチェックを入れた場合。メッセージ「識別子変更モードで登録します(Register with \[Change Identigier Mode\].)」を表示する。

②Import ボタン

  - 押下するとインポートを実行する。  
    対象データがすべてエラーなど、インポートできない場合は非活性。

③Summary/Total ラベル

  - TSVファイルで設定されたアイテムの総数。TSVファイルが複数存在した場合、各ファイルで設定されたアイテムの合計を表示する。

④Summary/New Item ラベル

  - ③の内、新規登録アイテムとなる件数を表示する。

⑤Summary/Update ラベル

  - ③の内、更新アイテムとなる件数を表示する。

⑥Summary/Check error ラベル

  - ③の内、TSVファイルの設定内容にエラーがある件数を表示する。

⑦Download ボタン

  - インポートファイルのチェック結果をTSV形式で出力する。出力項目が当該画面の⑧～⑫。  
    ダウンロードするファイルは4.2を参照。

⑧表/No.

  - 項番。Not処理順。

⑨表/Item Type

  - アイテムをインポートする際に使用するアイテムタイプ名を表示する

⑩表/Item ID

  - 新規登録の場合
    
      - TSVファイルでID指定あり→「新規登録（Item ID）」
    
      - TSVファイルでID指定無し→ 空白

  - 更新の場合
    
      - TSVファイルで指定したIDを表示する

⑪表/Title

  - アイテムのタイトルを以下のルールで表示する。
    
      - システムの言語属性に合わせたタイトルを表示する
    
      - 一致するものがない場合は英語表記で表示する
    
      - 画面の横幅に応じて表示する文字数をトリミング（末尾を「…」に置換）する

⑫表/Check Result

  - TSVファイルの設定内容について、チェックした結果を以下の形式（()は英語表記）で表示する。
    
      - 新規登録→「登録(Registre)」
    
      - 更新→「更新(Update)」
    
      - エラー→「エラー(ERROR)：\<エラーメッセージ\>」
    
      - ワーニング→「警告(Warning)：\<警告メッセージ\>」

  - チェック仕様については、3.2(4)-2\~3を参照

2.3 結果画面(Result)

  - アイテムごとのインポート実行結果の確認とインポート実行結果のダウンロードができる。

  - 現状、処理中に一度画面を離れた場合、処理はCeleryで管理されて継続するが、画面で進捗状況を再度確認することはできない。

> ┌──────┐
> 
> Select Import │Result│
> 
> ───────────────┘ └─────────────────────────────────────
> 
> 【Download】①
> 
> ┏━━━━┳━━━━━━━━━━━┳━━━━━━━━━┳━━━━━━━┳━━━━━━┳━━━━━━━━━━━━━━━┓
> 
> ┃No. ┃Start Date ┃End Date ┃Item Id┃Action┃WrokFlow Status┃
> 
> ┣━━━━╋━━━━━━━━━━━╋━━━━━━━━━╋━━━━━━━╋━━━━━━╋━━━━━━━━━━━━━━━┫
> 
> ┃ ② ┃ ③ ┃ ④ ┃ ⑤ ┃ ⑥ ┃ ⑦ ┃
> 
> ┗━━━━┻━━━━━━━━━━━┻━━━━━━━━━┻━━━━━━━┻━━━━━━┻━━━━━━━━━━━━━━━┛

①Download ボタン

  - インポート処理の実行結果を出力する。項目は当該画面の②～⑦．

  - ダウンロードファイルについては4.3参照。

②表/No.

  - 項番。Not処理順。

③表/Start Date

  - アイテムの登録処理を開始した日時。YYYY-MM-DD hh:mm:ssで表示する。

④表/End Date

  - アイテムの登録処理が完了した日時。YYYY-MM-DD hh:mm:ssで表示する。

⑤表/Item Id

  - 処理対処のアイテムIDを表示する。新規登録の場合は空欄。

⑥表/Action

  - 以下を表示する。
    
      - 「Start」：アイテム登録の処理が開始されている
    
      - 「End」：アイテム登録の処理が正常に終了している。
    
      - 「Error」：アイテム登録の処理がエラーで終了している。

⑦表/WorkFlow Status

  - 処理中のワークフローのステータスを表示する。

3\. インポートファイル／TSVファイルについて

3.1 インポートファイル

  - エクスポート（一括出力）したファイルを流用できる

  - 対応しているファイル形式：zip（他の圧縮形式は不可）実装の詳細は処理概要の1を参照。

  - フォルダ構成

> import.zip
> 
> │
> 
> ├bag-info.txt ※
> 
> ├bagit.txt ※
> 
> ├manifest-sha256.txt ※
> 
> ├manifest-sha512.txt ※
> 
> ├tagmanifest-sha256.txt ※
> 
> ├tagmanifest-shar512.txt ※
> 
> │
> 
> └/data
> 
> │
> 
> ├/recid\_n
> 
> │ └\<Files\>
> 
> │
> 
> ├ItemTypeName1(ItemType ID).tsv
> 
> └ItemTypeName2(ItemType ID).tsv
> 
> ※はBagit形式のファイル。インポート時は省略可能

  - 「/data」は変更不可

  - 「/recid\_n」は変更可

  - アイテムタイプのTSVファイルは複数指定可能

3.2 アイテムタイプごとのTSVファイル

  - 当該ファイルは以下で共通のレイアウトとしている。
    
      - Select画面でダウンロードできるテンプレートファイル(4.1)
    
      - インポートファイルに含めるアイテムタイプTSVファイル
    
      - エクスポート（一括出力）ファイルに含まれるアイテムタイプTSVファイル

(1) ヘッダ行

ヘッダ行は先頭が「\#」とする。

  - 1行目：インポートするアイテムタイプの情報

| 1列目 | 「\#ItemType」固定                                                            |
| --- | ------------------------------------------------------------------------- |
| 2列目 | アイテムタイプ名                                                                  |
| 3列目 | アイテムタイプのjsonschemaのURI。形式は「https://FQDN/items/jsonschema/\<ItemType ID\>」 |

  - 2行目：各項目のJSONパス。各種処理に使用される項目。

  - 3行目：各項目のラベル。
    
      - アイテムタイプ以外の項目  
        → 項目ごとにラベルの内容を定義。
    
      - アイテムタイプ項目  
        → 【Administration \> アイテムタイプ管理（ItemTypes） \> メタデータ（Metadata）画面】のLocalization Settingで設定している内容を出力。設定がない場合は項目名を出力。

  - 4行目：インポート実行時に値を自動で設定する項目について「System」を出力 。対象はプロパティ定義内で「"readonly":true」を設定している項目。

  - 5行目：各項目について「Allow Multiple」（繰り返し可）「Requierd」（必須）を出力
    
      - アイテムタイプ以外の項目  
        → 項目ごとにラベルの内容を定義。
    
      - アイテムタイプ項目  
        → 【Administration \> アイテムタイプ管理（ItemTypes） \> メタデータ（Metadata）画面】のOptionの設定内容がチェックありの項目について出力

(2) アイテムタイプ項目以外の項目

<table>
<thead>
<tr class="header">
<th><strong>JSONパス</strong></th>
<th><strong>ラベル</strong></th>
<th><strong>説明</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>.id</td>
<td>ID</td>
<td>アイテムID。新規登録時、指定なしの場合は自動採番、未使用の番号を指定することもできる。更新時は登録済みの内容が必須。</td>
</tr>
<tr class="even">
<td>.uri</td>
<td>URI</td>
<td>アイテムのURI。新規登録時は指定なし。更新時は登録済みの内容が必須となる。</td>
</tr>
<tr class="odd">
<td>.metadata.path[0]</td>
<td>.IndexID[0]</td>
<td>アイテムを登録するインデックスをID指定する。複数指定可。<br />
.pos_index[n]とペアで指定する。<br />
.pos_index[n]が指定されていない場合は必須。存在しないインデックスを指定した場合はエラーメッセージを出力する。</td>
</tr>
<tr class="even">
<td>.pos_index[0]</td>
<td>.POS_INDEX[0]</td>
<td>アイテムを登録するインデックスを名称(※1)で指定する。<br />
.metadata.path[n]とペアで指定する。<br />
.metadata.path[n]が指定されてない場合は必須。</td>
</tr>
<tr class="odd">
<td>.publish_status</td>
<td>.PUBLISH_STATUS</td>
<td>アイテムの公開／非公開を指定する。public/privateのいずれかを設定する。必須項目。</td>
</tr>
<tr class="even">
<td>.feedback_mail[0]</td>
<td>.FEEDBACK_MAIL[0]</td>
<td>フィードバックメールの送信先メールアドレスを指定する。複数指定可。</td>
</tr>
<tr class="odd">
<td>.cnri</td>
<td>.CNRI</td>
<td>CNRIハンドルサーバを使用する場合(※2)に設定できる。CNRIは「prefix/suffix」の形式で設定される。通常モードの時は自動採番(※3)される。識別子変更モードの時は手入力で変更可能。</td>
</tr>
<tr class="even">
<td>.doi_ra</td>
<td>.DOI_RA</td>
<td>DOIの種類を指定する。JaLC/Crossref/DataCite(※4)/NDL JaLC (※5)のいずれかを設定する。</td>
</tr>
<tr class="odd">
<td>.doi</td>
<td>.DOI</td>
<td>DOIを「prefix/suffix」の形式で設定する。通常モードの時は自動採番(※3)される。識別子変更モードの時は手入力で変更可能。</td>
</tr>
<tr class="even">
<td>.edit_mode</td>
<td>Keep/Upgrade Version</td>
<td>対象のアイテムのバージョン更新可否を指定する。新規登録の場合は空、更新の場合は必須でKeep/Upgradeのいずれかを指定する。<br />
※インポートファイル（zip）に既存アイテムの元ファイルが同名、ファイルパスも同一で含まれていた場合（元ファイルを変更しない）<br />
　・Keep: 重複登録されない<br />
　・Upgrade: 重複登録する。ファイル名だけでは、同名同ファイルなのか同名異ファイルなのかが判断できない</td>
</tr>
</tbody>
</table>

  - ※1) インデックス名称について  
    POS\_INDEXは階層を指定して記述する。階層の区切り文字はデフォルトで「///」。weko\_items\_ui/config.py の WEKO\_ITEMS\_UI\_INDEX\_PATH\_SPLIT にて区切り文字の変更が可能。  
    同名のインデックスが複数存在した場合は、すべてのインデックスに登録される。  
    日本語名称、英語名称のいずれかを指定できる。日本語名称のインデックスと英語名称のインデックスをまぜて指定することはできない。

<table>
<thead>
<tr class="header">
<th><strong>IndexID</strong></th>
<th><strong>POS_INDEX</strong></th>
<th><strong>説明</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>指定あり</td>
<td>指定なし</td>
<td>IndexID に指定されたインデックスに登録。</td>
</tr>
<tr class="even">
<td>指定なし</td>
<td>指定あり</td>
<td>POS_INDEX に指定されたインデックスに登録。</td>
</tr>
<tr class="odd">
<td>指定あり</td>
<td>指定あり</td>
<td>IndexID と POS_INDEX の組み合わせが正しい場合、該当するインデックスに登録。<br />
不整合の場合、IndexID で指定されたインデックスに登録。<br />
システムに存在しない IndexID と POS_INDEX を指定した場合はエラーとなる。</td>
</tr>
<tr class="even">
<td>指定なし</td>
<td>指定なし</td>
<td>エラーとなる。</td>
</tr>
</tbody>
</table>

  - ※2) CNRIハンドルサーバの使用について  
    CNRIハンドルの使用状態は「WEKO\_HANDLE\_ALLOW\_REGISTER\_CRNI」(modules/weko-handle/weko\_handle/config.py)の設定値で判断している
    
      - 「False」：初期値。CNRIハンドルサーバを使用しない
    
      - 「True」：CNRIハンドルサーバを使用する

  - ※3) CNRIとDOIの自動採番時の指定について  
    現状は以下の通り。
    
      - 識別子変更モード
        
          - DOIの自動採番は行わない。  
            インポートファイルにdoiやprefixが含まれている場合はエラーメッセージを表示する。
            
              - DOIが空欄の場合  
                　「Please specify DOI prefix/suffix.」
            
              - インポートファイルにdoiやprefixが含まれている場合　(「prefix」もしくは「prefix/」を指定した場合）  
                　「DOI suffixを設定してください。」／「Please specify DOI suffix.」
    
      - Not 識別子変更モード
        
          - Admin \> Setting \> Identifier でprefixの設定があること
        
          - DOI：空欄であること
        
          - DOI\_RA：JaLC, Crossref, DataCite のいずれかであること
          - DOI_RA：NDL JaLCの場合、自動採番は行われない。
            インポートファイルにdoiやprefixが含まれている場合はエラーメッセージを表示する。
               - DOIが空欄の場合
　              「Please specify DOI prefix/suffix.」
               - インポートファイルにdoiやprefixが含まれている場合　(「prefix」もしくは「prefix/」を指定した場合）
　              「DOI suffixを設定してください。」／「Please specify DOI suffix.」

  - ※4) DataCiteについて  
    制限等は現状設けていない

  - ※5) NDL JaLCについて  
    DOI RA：NDL JaLCの場合、資源タイプは「doctoral thesis」である必要があります。

  - CNRIハンドルの未設定・設定ユーザーのDOI付与状況は以下の通り。

  - 

<table>
<thead>
<tr class="header">
<th></th>
<th>識別子変更モード</th>
<th>Not 識別子変更モード</th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td></td>
<td>新規</td>
<td>更新</td>
<td>新規</td>
<td>更新</td>
</tr>
<tr class="even">
<td>CNRI<br />
（CNRIハンドル未設定ユーザー）</td>
<td>空欄</td>
<td>空欄</td>
<td>空欄</td>
<td>空欄</td>
</tr>
<tr class="odd">
<td>CNRI<br />
（CNRIハンドル設定ユーザー）</td>
<td>必須（変更不可）</td>
<td>変更可能</td>
<td>空欄</td>
<td>変更不可</td>
</tr>
<tr class="even">
<td>DOI_RA</td>
<td>設定可能</td>
<td>DOI付与前は設定可能<br />
DOI付与後は変更不可</td>
<td>設定可能</td>
<td>DOI付与前は設定可能<br />
DOI付与後は変更不可</td>
</tr>
<tr class="odd">
<td>DOI</td>
<td>設定可能</td>
<td>変更可能</td>
<td>空欄</td>
<td>DOI付与前は空欄<br />
DOI付与後は変更不可</td>
</tr>
</tbody>
</table>

  - 
(3) アイテムタイプ項目

基本はアイテムタイプに定義されている項目（プロパティ）に対して、TSVファイル内で設定されている内容を登録する。  
次の項目は項目の設定以外の処理を行っている。

－1. コンテンツファイル

コンテンツファイルを指定してアップロードする。  
自動設定は本文URLのみ対応済。

プロパティID：  
項目：

<table>
<thead>
<tr class="header">
<th><strong>JSONパス</strong></th>
<th><strong>初期設定ラベル</strong></th>
<th><strong>System(自動設定)</strong></th>
<th><strong>説明</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>.file_path[0]</td>
<td>.ファイルパス[0]</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>.upload_id[0]</td>
<td>. ファイルアップロードID[0]</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>.metadata.item_files[0].accessrole</td>
<td>ファイル情報[0].アクセス</td>
<td>空欄で「オープンアクセス」を自動設定／手入力</td>
<td></td>
</tr>
<tr class="even">
<td>.metadata.item_files[0].date[0].dateType</td>
<td>ファイル情報[0].公開日[0].タイプ</td>
<td>「Available」を自動設定（値があっても無視）</td>
<td></td>
</tr>
<tr class="odd">
<td>.metadata.item_files[0].date[0].dateValue</td>
<td>ファイル情報[0].公開日[0].公開日</td>
<td>「アクセス」＝オープンアクセスの際は自動設定／「アクセス」＝オープンアクセス日を指定 の際に手入力可／それ以外は空白</td>
<td></td>
</tr>
<tr class="even">
<td>.metadata.item_files[0].displaytype</td>
<td>ファイル情報[0].表示形式</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>.metadata.item_files[0].fileDate[0].fileDateType</td>
<td>ファイル情報[0].日付[0].日付タイプ</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>.metadata.item_files[0].fileDate[0].fileDateValue</td>
<td>ファイル情報[0].日付[0].日付</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>.metadata.item_files[0].filename</td>
<td>ファイル情報[0].ファイル名</td>
<td>空欄で自動設定／手入力</td>
<td></td>
</tr>
<tr class="even">
<td>.metadata.item_files[0].filesize[0].value</td>
<td>ファイル情報[0].サイズ[0].サイズ</td>
<td>空欄で自動設定／手入力</td>
<td></td>
</tr>
<tr class="odd">
<td>.metadata.item_files[0].format</td>
<td>ファイル情報[0].フォーマット</td>
<td><p>空欄で自動設定／手入力</p>
<p>ファイルアップロードIDを入力の場合、必須</p></td>
<td></td>
</tr>
<tr class="even">
<td>.metadata.item_files[0].groups</td>
<td>ファイル情報[0].グループ</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>.metadata.item_files[0].licensefree</td>
<td>ファイル情報[0].自由ライセンス</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>.metadata.item_files[0].licensetype</td>
<td>ファイル情報[0].ライセンス</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>.metadata.item_files[0].url.label</td>
<td>ファイル情報[0].本文URL.ラベル</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>.metadata.item_files[0].url.objectType</td>
<td>ファイル情報[0].本文URL.オブジェクトタイプ</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>.metadata.item_files[0].url.url</td>
<td>ファイル情報[0].本文URL.本文URL</td>
<td>空欄で自動設定(※1)／手入力</td>
<td></td>
</tr>
<tr class="even">
<td>.metadata.item_files[0].version</td>
<td>ファイル情報[0].バージョン情報</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

※1: 本文URLは「THEME\_SITEURL」(/home/invenio/.virtualenvs/invenio/var/instance/invenio.cfg") を利用して生成している。ルールは以下の通り。

  - file\_path & 本文URLの両方を指定された場合、本文URLを無視し、システムがURLを生成し上書きする。

  - file\_path のみ指定された場合、URLを生成し登録する。

  - 本文URLのみ指定された場合、URLを使って登録する。

－2. サムネイルファイル

プロパティID：  
項目：

| **JSONパス**                                                                  | **初期設定ラベル**                       | **System(自動設定)** | **説明**                                               |
| --------------------------------------------------------------------------- | --------------------------------- | ---------------- | ---------------------------------------------------- |
| .thumbnail\_path\[0\]                                                       | .サムネイルパス\[0\]                     |                  | 設定値ありで登録、設定値なしで削除する。指定したパスに該当ファイルがあれば常にアップロードして登録する。 |
| .metadata.item\_1568286766453\[0\].subitem\_thumbnail\[0\].thumbnail\_label | Thumbnail\[0\].URI\[0\].URI Label | 〇                | インポート時に設定されても無視する                                    |
| .metadata.item\_1568286766453\[0\].subitem\_thumbnail\[0\].thumbnail\_url   | Thumbnail\[0\].URI\[0\].URI       | 〇                | インポート時に設定されても無視する                                    |

－3. 自動設定の項目

  - **出版タイプ** （JPCOARスキーマ「出版タイプ」：<https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/16> の統制語彙に基づく）  
    プロパティID：  
    項目：

| **JSONパス**                                           | **初期設定ラベル**         | **JPCOAR\[※\]**           | **System(自動設定)** | **説明** |
| ---------------------------------------------------- | ------------------- | ------------------------- | ---------------- | ------ |
| .metadata.item\_1531978917933.subitem\_1522305645492 | 出版タイプ.出版タイプ         | versiontype               |                  |        |
| .metadata.item\_1531978917933.subitem\_1600292170262 | 出版タイプ.出版タイプResource | versiontype.@rdf:resource | 〇                |        |

  - **アクセス権** （JPCOARスキーマ「アクセス権」：<https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/5> の統制語彙に基づく）  
    プロパティID：  
    項目：

| **JSONパス**                                           | **初期設定ラベル**           | **JPCOAR\[※\]**            | **System(自動設定)** | **説明** |
| ---------------------------------------------------- | --------------------- | -------------------------- | ---------------- | ------ |
| .metadata.item\_1531978848664.subitem\_1522299639480 | Access Right.アクセス権    | accessRights               |                  |        |
| .metadata.item\_1531978848664.subitem\_1600958577026 | Access Right.アクセス権URI | accessRights.@rdf:resource | 〇                |        |

  - **資源タイプ** （JPCOARスキーマ「資源タイプ」：https://schema.irdb.nii.ac.jp/ja/schema/1.0.2/14 の統制語彙に基づく）  
    プロパティID：  
    項目：

| **JSONパス**                                 | **初期設定ラベル**            | **JPCOAR\[※\]**    | **System(自動設定)** | **説明** |
| ------------------------------------------ | ---------------------- | ------------------ | ---------------- | ------ |
| .metadata.item\_1569380275317.resourcetype | Resource Type.Type     | type               |                  |        |
| .metadata.item\_1569380275317.resourceuri  | Resource Type.Resource | type.@rdf:resource | 〇                |        |

\[※\]各Resource項目の自動設定機能は、【Administration \> アイテムタイプ管理（ItemTypes） \> マッピング（Mapping）画面】で対象のアイテムタイプについてJPCOARスキーマのマッピングが設定されている必要があります。  
　「出版タイプ」と「アクセス権」については、移行ツール作成のアイテムタイプに含まれていない項目なので、該当環境で項目を追加した際は必ずマッピング設定をしてください。

(4) チェック仕様

\-1. インポートファイル、TSVファイルの形式チェック

最初に実施。  
エラーの場合は、Select（選択）画面の\#Message Area\#にメッセージを出力する。ただし、\#2はImport（インポート）画面の表/Check Resultに出力。

<table>
<thead>
<tr class="header">
<th><strong>#</strong></th>
<th><strong>条件</strong></th>
<th><strong>処理</strong></th>
<th><strong>メッセージ(日本語)</strong></th>
<th><strong>メッセージ(英語)</strong></th>
<th><strong>備考</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>指定された項目が一括登録対象のアイテムタイプと一致しない（項目不足）</td>
<td>エラー</td>
<td>指定されたアイテムタイプと項目が一致しません。</td>
<td>The item does not consistent with the specified item type.</td>
<td></td>
</tr>
<tr class="even">
<td>2</td>
<td>指定された項目が一括登録対象のアイテムタイプと一致しない（項目追加）</td>
<td>警告</td>
<td>次の項目指定されたアイテムタイプに存在しないため登録されません。{}</td>
<td>The following items are not registered because they do not exist in the specified item type. {}</td>
<td></td>
</tr>
<tr class="odd">
<td>3</td>
<td>指定された圧縮ファイルの形式がzip以外</td>
<td>エラー</td>
<td>指定されたファイル{}の形式はインポートに対応していません。zip ,tar,gztar,bztar,xztarいずれかの形式を指定してください。</td>
<td>The format of the specified file {} does not support import. Please specify one of the following formats: zip, tar, gztar, bztar, xztar.</td>
<td><p>対応している圧縮形式がzipのみで、</p>
<p>ファイル選択時のバリデーションチェックでzip以外のファイルでは［次へ（Next）］ボタンが活性化しないためこのチェックに到達しない。</p></td>
</tr>
<tr class="even">
<td>4</td>
<td>指定された圧縮ファイル内でTSVファイルが見つからない（フォルダ構成誤り）</td>
<td>エラー</td>
<td>指定されたファイル{}にtsv/csvファイルが見つかりませんでした。ディレクトリ構成が正しいか確認してください。</td>
<td>The tsv/csv file was not found in the specified file {}. Check if the directory structure is correct.</td>
<td></td>
</tr>
<tr class="odd">
<td>5</td>
<td>UTF-8でエンコードされていない</td>
<td>エラー</td>
<td>{}ファイルを読み込めませんでした。ファイル形式が{}であること、またそのファイルがUTF-8でエンコードされているかを確認してください。</td>
<td>The {} file could not be read. Make sure the file format is {} and that the file is UTF-8 encoded.</td>
<td>{}に拡張子が入る</td>
</tr>
<tr class="even">
<td>6</td>
<td>ファイルの１行目のフォーマットが正しくない（3列名にアイテムタイプIDが指定されていない など）</td>
<td>エラー</td>
<td>{}ファイルのヘッダ１行目の形式に誤りがあります。</td>
<td>There is an error in the format of the first line of the header of the {} file.</td>
<td></td>
</tr>
<tr class="odd">
<td>7</td>
<td>指定したアイテムタイプが存在しない</td>
<td>エラー</td>
<td>{}ファイルで指定されたアイテムタイプIDは存在しません。</td>
<td>The item type ID specified in the {} file does not exist.</td>
<td></td>
</tr>
<tr class="even">
<td>8</td>
<td>TSV ファイルに改行が含まれている場合</td>
<td>エラー</td>
<td>{}ファイルが正しく読み込めません。</td>
<td>Cannot read {} file correctly.</td>
<td></td>
</tr>
<tr class="odd">
<td>9</td>
<td>指定したアイテムタイプが一括登録可能（最新版）でない場合</td>
<td>エラー</td>
<td>指定されたアイテムタイプが最新のバージョンでないため登録できません。</td>
<td>Cannot register because the specified item type is not the latest version.</td>
<td>現在はアイテムタイプのバージョン管理はしていないため使用していない</td>
</tr>
<tr class="even">
<td>10</td>
<td>Runtimeエラー（ElasticSearchがロックされた、サーバ接続不可、ネットワーク接続不可など）</td>
<td>エラー</td>
<td>サーバ内部エラー</td>
<td>Internal server error</td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>エラー</td>
<td></td>
<td>The specified {} does not exist in system.</td>
<td></td>
</tr>
</tbody>
</table>

\-2. メタデータ項目以外のチェック

アイテムタイプのメタデータ以外の項目についてチェック仕様。  
各項目は「JSONパス（ラベル）」で記載。  
エラーメッセージはImport（インポート）画面の表/Check Resultに出力。

  - .id（ID）

| **\#** | **条件**                          | **処理** | **メッセージ(日本語)**                       | **メッセージ(英語)**                                                              | **備考**                 |
| ------ | ------------------------------- | ------ | ------------------------------------ | -------------------------------------------------------------------------- | ---------------------- |
| 1      | 半角数字以外                          | エラー    | アイテムIDは半角数字で指定してください。                | Please specify item ID by half-width number.                               |                        |
| 2      | 指定されたアイテムIDをpidとしてもつアイテムが存在しない  | エラー    |                                      | Item does not exits in the system                                          | 多言語対応ができていない           |
| 3      | 指定されたアイテムIDがシステムでは削除済み          | エラー    |                                      | Item already DELETED in the system                                         | 多言語対応ができていない           |
| 4      | アイテムIDが指定されていて、項目「status」が「new」 | ワーニング  | 新規登録アイテムにIDが指定されています。IDを無視して登録を行います。 | ID is specified for the newly registered item. Ignore the ID and register. | 項目「status」はチェック中に付与される |

  - .id（ID）と.uri（URI）

| **\#** | **条件**                 | **処理** | **メッセージ(日本語)**           | **メッセージ(英語)**                              | **備考** |
| ------ | ---------------------- | ------ | ------------------------ | ------------------------------------------ | ------ |
| 1      | アイテムIDとURIの組み合わせが一致しない | エラー    | 指定されたURIとシステムURIが一致しません。 | Specified URI and system URI do not match. |        |

  - .metadata.path\[0\]（.IndexID\[0\]）

| **\#** | **条件**        | **処理** | **メッセージ(日本語)**       | **メッセージ(英語)**                                  | **備考**          |
| ------ | ------------- | ------ | -------------------- | ---------------------------------------------- | --------------- |
| 1      | 指定された内容が存在しない | エラー    | 指定された{}はシステムに存在しません。 | The specified {} does not exist in the system. | {}に「IndexID」が入る |

  - .pos\_index\[0\]（.POS\_INDEX\[0\]）

| **\#** | **条件**                                 | **処理** | **メッセージ(日本語)**       | **メッセージ(英語)**                                | **備考**             |
| ------ | -------------------------------------- | ------ | -------------------- | -------------------------------------------- | ------------------ |
| 1      | IndexIDが指定されていない際、指定したPOS\_INDEXが存在しない | エラー    | 指定された{}はシステムに存在しません。 | The specified {}does not exist in the system | {}に「POS\_INDEX」が入る |

  - .metadata.path\[0\]（.IndexID\[0\]）と.pos\_index\[0\]（.POS\_INDEX\[0\]）

| **\#** | **条件**                                                | **処理** | **メッセージ(日本語)**                    | **メッセージ(英語)**                                     | **備考**                     |
| ------ | ----------------------------------------------------- | ------ | --------------------------------- | ------------------------------------------------- | -------------------------- |
| 1      | 組合せチェック（IndexID→存在している、POS\_INDEX→指定されたIndexIDと一致しない） | 警告     | 指定された{}はシステムのものと一致していません。         | Specified {} does not match with existing index.  | {}に「POS\_INDEX」が入る         |
| 2      | 組合せチェック（IndexID→存在していない、POS\_INDEX→存在している）            | エラー    | 指定された{}はシステムに存在しません。              | The specified {} does not exist in system.        | {}に「IndexID」が入る            |
| 3      | 組合せチェック（指定されたIndexIDとPOS\_INDEXがどちらも存在しない）            | エラー    | 指定された{}はシステムに存在しません。              | The specified {} does not exist in system.        | {}に「IndexID,POS\_INDEX」が入る |
| 4      | 組合せチェック（IndexIDとPOS\_INDEXIDがどちらも指定されていない）            | エラー    | IndexID,POS\_INDEXがどちらも設定されていません。 | Both of Index ID and POS INDEX are not being set. |                            |

  - .publish\_status（.PUBLISH\_STATUS）

| **\#** | **条件**                     | **処理** | **メッセージ(日本語)**                   | **メッセージ(英語)**                            | **備考**                  |
| ------ | -------------------------- | ------ | -------------------------------- | ---------------------------------------- | ----------------------- |
| 1      | 指定されていない                   | エラー    | {}は必須項目です。                       | {} is required item.                     | {}に「PUBLISH\_STATUS」が入る |
| 2      | 指定された内容が不正（public/private） | エラー    | {}はpublic,privateのいずれかを設定してください。 | Please set "public" or "private" for {}. | {}に「PUBLISH\_STATUS」が入る |

  - .feedback\_mail\[0\]（.FEEDBACK\_MAIL\[0\]）

| **\#** | **条件**               | **処理** | **メッセージ(日本語)** | **メッセージ(英語)**            | **備考**        |
| ------ | -------------------- | ------ | -------------- | ------------------------ | ------------- |
| 1      | 形式チェック（メールアドレスの形式不正） | エラー    | 指定された{}が不正です。  | Specified {} is invalid. | {}にメールアドレスが入る |

  - .cnri（.CNRI）

<table>
<thead>
<tr class="header">
<th><strong>#</strong></th>
<th><strong>条件</strong></th>
<th><strong>処理</strong></th>
<th><strong>メッセージ(日本語)</strong></th>
<th><strong>メッセージ(英語)</strong></th>
<th><strong>備考</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>CNRI使用フラグが「False」の時にCNRIを設定した</td>
<td>エラー</td>
<td>{}は設定できません。</td>
<td>{} cannot be set.</td>
<td>{}に「CNRI」が入る</td>
</tr>
<tr class="even">
<td>2</td>
<td>通常モードで新規登録時に指定</td>
<td>エラー</td>
<td>{}は設定できません。</td>
<td>{} cannot be set.</td>
<td>{}に「CNRI」が入る</td>
</tr>
<tr class="odd">
<td>3</td>
<td>通常モードで更新時に登録内容から変更</td>
<td>エラー</td>
<td>指定されたCNRIは登録しているCNRIと異なっています</td>
<td>Specified {} is different from existing {}.</td>
<td>両方の{}に「CNRI」が入る</td>
</tr>
<tr class="even">
<td>4</td>
<td>識別子変更モードで新規／更新時にCNRIを設定しない</td>
<td>エラー</td>
<td>{}を設定してください。</td>
<td>Please specify {}.</td>
<td>{}に「CNRI」が入る</td>
</tr>
<tr class="odd">
<td>5</td>
<td>形式チェック（管理画面で登録されているPrefixと一致しない)</td>
<td>エラー</td>
<td>指定された{}のPrefixが誤っています。</td>
<td>Specified Prefix of {} is incorrect.</td>
<td>{}に「CNRI」が入る</td>
</tr>
<tr class="even">
<td>6</td>
<td>形式チェック（Suffixに半角英数字、半角記号「_-.;()/」以外を使用）</td>
<td>エラー</td>
<td>CNRIのSuffixは半角英数字、半角記号「_-.;()/」以外使用できません。</td>
<td>Suffix of CNRI can only be used with half-width alphanumeric characters and half-width symbols “_-.; () /”.</td>
<td>エラーチェックが存在しない</td>
</tr>
<tr class="odd">
<td>7</td>
<td>形式チェック（最大長超え）</td>
<td>エラー</td>
<td>指定された{}が最大長を超えています。</td>
<td>The specified {} exceeds the maximum length.</td>
<td><p>{}に「CNRI」が入る</p>
<p>pidstoreの上限が255のため、http://～とprefix/を含めて255が上限となるようにチェックする</p></td>
</tr>
</tbody>
</table>

  - .doi\_ra（.DOI\_RA）と.doi（.DOI）

| **\#** | **条件**                              | **処理** | **メッセージ(日本語)**              | **メッセージ(英語)**                                 | **備考**                     |
| ------ | ----------------------------------- | ------ | --------------------------- | --------------------------------------------- | -------------------------- |
| 1      | 組合せチェック（通常モードで新規登録時にどちらも指定）         | エラー    | {}は設定できません。                 | {} cannot be set.                             | {}に「DOI」が入る                |
| 2      | 組合せチェック（通常モードで更新時に登録内容から変更）         | エラー    | 指定された{ }が登録している{ }と異なっています。 | Specified { } is different from existing { }. | 両方の{}に「DOI\_RA」または「DOI」が入る |
| 3      | 組合せチェック（識別子変更モードで新規登録時にDOIのみ指定）     | エラー    | DOI\_RAを設定してください。           | Please specify DOI\_RA.                       |                            |
| 4      | 組合せチェック（識別子変更モードで新規登録時にDOI\_RAのみ指定） | エラー    | {}を設定してください。                | Please specify {}.                            | {}に「DOI」が入る                |

  - .doi\_ra（.DOI\_RA）

| **\#** | **条件**                                                               | **処理** | **メッセージ(日本語)**                                          | **メッセージ(英語)**                                                                          | **備考**       |
| ------ | -------------------------------------------------------------------- | ------ | ------------------------------------------------------- | -------------------------------------------------------------------------------------- | ------------ |
| 1      | 指定された内容が不正（DOI\_RAが設定されており、JaLC,Crrossref,DataCite,NDL JaLCのいずれでもない） | エラー    | DOI\_RAはJaLC,Crrossref,DataCite,NDL JaLCのいずれかを設定してください。 | DOI\_RA should be set by one of JaLC, Crossref, DataCite, NDL JaLC.                    |              |
| 2      | 通常モードで更新時に登録内容から変更                                                   | ワーニング  |                                                         | The specified DOI RA is wrong and fixed with the correct DOI RA of the registered DOI. | 多言語対応ができていない |

  - .doi（.DOI）

| **\#** | **条件**                                   | **処理** | **メッセージ(日本語)**                            | **メッセージ(英語)**                                                                                              | **備考**                                                    |
| ------ | ---------------------------------------- | ------ | ----------------------------------------- | ---------------------------------------------------------------------------------------------------------- | --------------------------------------------------------- |
| 1      | 形式チェック（管理画面で登録されているPrefixと一致しない)         | エラー    | 指定されたDOIのPrefixが誤っています。                   | Specified Prefix of DOI is incorrect.                                                                      |                                                           |
| 2      | 形式チェック（Suffixに半角英数字、半角記号「\_-.;()/」以外を使用) | エラー    | DOIのSuffixは半角英数字、半角記号「\_-.;()/」以外使用できません。 | Suffix of {} can only be used with half-width alphanumeric characters and half-width symbols "\_-.; () /". | エラーチェックがなく、このメッセージは表示されない                                 |
| 3      | 形式チェック（最大長超え)                            | エラー    | 指定されたDOIが最大長を超えています                       | The specified DOI exceeds the maximum length.                                                              | pidstoreの上限が255のため、http://～とprefix/を含めて255が上限となるようにチェックする |
| 4      | 指定された内容が不正（通常モードで更新時に登録内容から変更）           | ワーニング  |                                           | The specified DOI is wrong and fixed with the registered DOI.                                              | 多言語対応ができていない                                              |
| 5      | 識別子変更モードでDOIが指定されていない                    | エラー    |                                           | Please specify DOI prefix/suffix.                                                                          | 多言語対応ができていない                                              |
| 6      | 識別子変更モードでDOIに「/」が含まれていない                 | エラー    |                                           | Please specify DOI suffix.                                                                                 | 多言語対応ができていない                                              |

  - .edit\_mode（Keep/Upgrade Version）

| **\#** | **条件**                                            | **処理** | **メッセージ(日本語)**              | **メッセージ(英語)**                              | **備考** |
| ------ | ------------------------------------------------- | ------ | --------------------------- | ------------------------------------------ | ------ |
| 1      | 指定されていない、指定された内容が不正（edit\_modeがKeepでもUpgradeでもない） | エラー    | Keep、Upgradeのいずれかを指定してください。 | Please specify either “Keep” or “Upgrade”. |        |

  - .file\_path\[0\]（.ファイルパス\[\#\]）または.thumbnail\_path\[\#\]（.サムネイルパス\[\#\]）

| **\#** | **条件**                      | **処理** | **メッセージ(日本語)**                                                         | **メッセージ(英語)**                                                                                                                           | **備考**                                              |
| ------ | --------------------------- | ------ | ---------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------- |
| 1      | 新規登録時に指定したパスに該当するファイルが存在しない | エラー    | （.file\_path\[\#\]）に指定したファイルが存在しません。                                   | The file specified in (.file\_path \[\#\]) does not exist.                                                                              | 複数ファイルの場合は（.file\_path\[0\],.file\_path\[1\]…）と表示する |
| 2      | 更新時に指定したパスに該当するファイルが存在しない   | ワーニング  | file\_path\[\#\]）に指定したファイルが存在しません。ファイルの更新はしません。csv/tsv内容でメタデータのみ更新します。 | The file specified in (.file\_path \[\#\]) does not exist.The file will not be updated. Update only the metadata with csv/tsv contents. | 複数ファイルの場合は（.file\_path\[0\],.file\_path\[1\]…）と表示する |

  - .file\_path\[0\]（.ファイルパス\[\#\]）とメタデータのファイル名／表示名 ※メタデータ項目の関連チェックだがここに記載

| **\#** | **条件**                                  | **処理** | **メッセージ(日本語)**            | **メッセージ(英語)**                                       | **備考**                                                 |
| ------ | --------------------------------------- | ------ | ------------------------- | --------------------------------------------------- | ------------------------------------------------------ |
| 1      | ファイルパスで指定したファイル名とメタデータに設定されたファイル名が一致しない | エラー    | {}に指定されたファイル名と{ }が一致しません。 | The file name specified in {} and { } do not match. | ひとつ目の{}には.file\_path\[\#\]、ふたつ目の{}にはファイル名のJSON Pathが入る |

  - .thumbnail\_path\[\#\]（.サムネイルパス\[\#\]）

| **\#** | **条件**      | **処理** | **メッセージ(日本語)**                                                   | **メッセージ(英語)**                                                                              | **備考** |
| ------ | ----------- | ------ | ---------------------------------------------------------------- | ------------------------------------------------------------------------------------------ | ------ |
| 1      | 画像ファイル以外を指定 | エラー    | サムネイルは画像ファイル（gif, jpg, jpe, jpeg, png, bmp, tiff, tif）を指定してください。 | Please specify the image file(gif, jpg, jpe, jpeg, png, bmp, tiff, tif) for the thumbnail. |        |

  - .upload\_id\[\#\]（.ファイルアップロードID\[\#\]）

<table>
<thead>
<tr class="header">
<th><strong>#</strong></th>
<th><strong>条件</strong></th>
<th><strong>処理</strong></th>
<th><strong>メッセージ(日本語)</strong></th>
<th><strong>メッセージ(英語)</strong></th>
<th><strong>備考</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>1</strong></td>
<td>アップロードIDがUUID型でない</td>
<td>エラー</td>
<td>アップロードIDを正しく入力してください</td>
<td>Upload_id is invalid format</td>
<td></td>
</tr>
<tr class="even">
<td>2</td>
<td>アップロードIDが見つからない</td>
<td>エラー</td>
<td>指定されたアップロードIDが見つかりません</td>
<td>Specified upload_id is not found</td>
<td></td>
</tr>
<tr class="odd">
<td>3</td>
<td>未完了かすでにアイテムのバケットに紐づいているアップロードIDを指定している</td>
<td>エラー</td>
<td>指定されたアップロードIDは完了していないか、すでにアイテムに紐づけられています</td>
<td>Specified upload_id not completed or already linked to the item</td>
<td></td>
</tr>
<tr class="even">
<td>4</td>
<td>アップロードIDがファイル内で被っている</td>
<td>エラー</td>
<td>アップロードIDが重複しています</td>
<td>Duplicate upload_id</td>
<td></td>
</tr>
<tr class="odd">
<td>5</td>
<td>クォータサイズ超過</td>
<td>エラー</td>
<td>ファイルの合計サイズがバケットのサイズを超えています</td>
<td>Total file size exceeds bucket size</td>
<td></td>
</tr>
<tr class="even">
<td>6</td>
<td><p>ファイルパス[0],</p>
<p>.ファイルアップロードID[0]が同時に入力</p></td>
<td>エラー</td>
<td>ファイルパスかアップロードIDのみ入力してください</td>
<td>Please enter only file_path or upload_id</td>
<td></td>
</tr>
<tr class="odd">
<td>7</td>
<td><p>.ファイルアップロードID[0]が入力されているが、</p>
<p>File[0].フォーマットが未入力または正しくない場合</p></td>
<td>エラー</td>
<td>ファイル形式を正しく設定してください</td>
<td>Please set the file format corrctly</td>
<td></td>
</tr>
<tr class="even">
<td>8</td>
<td>アップロードIDで指定されているファイルと、ロケーションが異なる。</td>
<td>エラー</td>
<td>ファイルとアイテムのロケーションが異なります</td>
<td>Files and Items have different locations</td>
<td></td>
</tr>
</tbody>
</table>

\-3. メタデータ項目のチェック

基本的なチェックはライブラリを使用している。(\#1～3が該当)  
4～8はそれぞれ実装。  
エラーメッセージはImport（インポート）画面の表/Check Resultに出力。

<table>
<thead>
<tr class="header">
<th><strong>#</strong></th>
<th><strong>対象項目</strong></th>
<th><strong>条件</strong></th>
<th><strong>処理</strong></th>
<th><strong>メッセージ(日本語)</strong></th>
<th><strong>メッセージ(英語)</strong></th>
<th><strong>備考</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>入力形式がselect,checkboxes,radiosの項目</td>
<td>プロパティに定義されている選択肢以外を指定した</td>
<td>エラー</td>
<td>{}は次の決められた選択肢に含まれていません。{}</td>
<td>"%r is not one of %r"</td>
<td>英語はライブラリ出力メッセージ。日本語はマッピングして出力。</td>
</tr>
<tr class="even">
<td>2</td>
<td>Optoinで「Required」を指定している項目</td>
<td>指定されていない</td>
<td>エラー</td>
<td>{}は必須項目です。</td>
<td>"%r is a required property"</td>
<td>英語はライブラリ出力メッセージ。日本語はマッピングして出力。</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Multipleで繰り返しの上限数が指定されている</td>
<td>上限数を超えている</td>
<td>エラー</td>
<td>{} の数が上限数を超えています。</td>
<td>{} is too long</td>
<td>英語はライブラリ出力メッセージ。日本語はマッピングして出力。</td>
</tr>
<tr class="even">
<td>4</td>
<td>項目</td>
<td>メタデータキーが重複指定している場合</td>
<td>エラー</td>
<td><p>以下のメタデータキーが重複しています。</p>
<p>｛｝</p></td>
<td><p>The following metadata keys are duplicated.</p>
<p>{}</p></td>
<td>重複するメタデータは改行で区切って出力</td>
</tr>
<tr class="odd">
<td>5</td>
<td>タイトル</td>
<td>指定されていない</td>
<td>エラー</td>
<td>{}は必須項目です。</td>
<td>Title is required item.</td>
<td><p>2のエラーメッセージも同時に出力</p>
<p>日本語ではフォーマットできずに｛｝のまま表示される</p></td>
</tr>
<tr class="even">
<td>6</td>
<td>日付項目</td>
<td>日付形式チェック（YYYY/MM/DDで指定）</td>
<td>ワーニング</td>
<td>日付はYYYY-MM-DD、YYYY-MM、YYYYのいずれかで指定してください。</td>
<td>Please specify the date with any format of YYYY-MM-DD, YYYY-MM, YYYY.</td>
<td>YYYY-MM-DD 形式で解釈できないときのエラーメッセージは設定されているが、YYYY-MM-DD 形式でYYYY/MM/DDを解釈できるため実際には出力されない</td>
</tr>
<tr class="odd">
<td>7</td>
<td>日付項目</td>
<td>日付形式チェック（YYYY-MM-DD、YYYY-MM、YYYY以外で指定）</td>
<td>エラー</td>
<td>日付はYYYY-MM-DD、YYYY-MM、YYYYのいずれかで指定してください。</td>
<td>Please specify the date with any format of YYYY-MM-DD, YYYY-MM, YYYY.</td>
<td></td>
</tr>
<tr class="even">
<td>8</td>
<td>.metadata.pubdate（公開日）</td>
<td>形式チェック（YYYY-MM-DD以外で指定）</td>
<td>エラー</td>
<td>公開日はYYYY-MM-DDで指定してください。</td>
<td>Please specify PubDate with YYYY-MM-DD.</td>
<td></td>
</tr>
<tr class="odd">
<td>9</td>
<td>.metadata.pubdate（公開日）</td>
<td>指定されていない</td>
<td>エラー</td>
<td>%rは必須項目です。</td>
<td>%r is a required property</td>
<td>%rが「’pubdate’」 と置き換わる</td>
</tr>
<tr class="even">
<td>10</td>
<td>コンテンツファイルのオープンアクセスの日付</td>
<td>形式チェック（YYYY-MM-DD以外で指定）</td>
<td>エラー</td>
<td>オープンアクセスの日付はYYYY-MM-DDで指定してください。</td>
<td>Please specify Open Access Date with YYYY-MM-DD.</td>
<td></td>
</tr>
<tr class="odd">
<td>11</td>
<td>マッピングによって必須になっている項目</td>
<td>設定されていない</td>
<td>エラー</td>
<td>{}は必須項目です。</td>
<td><p>The following metadata are required.</p>
<p>{}</p></td>
<td></td>
</tr>
<tr class="even">
<td>12</td>
<td>マッピングによって必須になっている項目（複数のうちいずれか１つを設定するもの）</td>
<td>１つも設定されていない</td>
<td>エラー</td>
<td>{}のいずれかを設定してください。</td>
<td><p>One of the following metadata is required.</p>
<p>{}</p></td>
<td></td>
</tr>
</tbody>
</table>

\-4. DOI付与アイテムの項目チェック

DOIを指定したアイテムについて、指定された項目が各DOI付与の要件を見ているかを確認。  
当該処理は個別登録のチェック処理を呼び出し実施している。

| **\#** | **対象項目** | **条件**                                                        | **処理** | **メッセージ(日本語)**                                                   | **メッセージ(英語)**                                                                                                                          | **備考**      |
| ------ | -------- | ------------------------------------------------------------- | ------ | ---------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| 1      | 各項目      | DOIを指定した際に入力項目が不足している                                         | エラー    | PID付与の条件を満たしていません。                                               | PID does not meet the conditions.                                                                                                      |             |
| 2      | \-       | DOI が付与されているアイテムに対して、アイテムを非公開として更新しようとした場合                    | エラー    | アイテムにDOIが付与されているため、アイテムを非公開にすることはできません。                          | You cannot keep an item private because it has a DOI.                                                                                  |             |
| 3      | \-       | インデックス状態が「公開」かつハーベスト公開が「公開」のインデックスに紐づいていないアイテムにDOIを付与しようとした場合 | エラー    | アイテムにDOIが付与されているため、インデックス状態が「公開」かつハーベスト公開が「公開」のインデックスに関連付けが必要です。 | Since the item has a DOI, it must be associated with an index whose index status is "Public" and whose Harvest Publishing is "Public". |             |
| 4      | \-       | 既存アイテムに付与されているDOIとインポートファイルで指定されたDOIの値が異なる場合                  | エラー    | 指定された{}が登録している{}と異なっています。                                        | Specified {} is different from existing {}.                                                                                            | {}に「DOI」が入る |

\-5. ファイル以外のチェック

操作アカウントの権限チェックを行う。

| **\#** | **対象** | **条件**                                                      | **処理** | **メッセージ(日本語)**                   | **メッセージ(英語)**                                  | **備考** |
| ------ | ------ | ----------------------------------------------------------- | ------ | -------------------------------- | ---------------------------------------------- | ------ |
| 1      | \-     | 操作アカウントが、アイテムの登録先インデックス（またはその親インデックス）へのインポートに必要な権限を持っていない場合 | エラー    | ロールの権限が足りずこのインデックスにアイテム登録ができません。 | Your role cannot register items in this index. |        |

4\. ダウンロードファイルについて

4.1 テンプレートファイル

  - Select（選択）画面でダウンロードできる。アイテムタイプ（Item Type）セレクタ―で選択したアイテムタイプについて、ヘッダ行のみ出力したインポートに使用するTSVファイル。

  - ファイル名は「アイテムタイプ名(アイテムタイプID).tsv」で、詳細は3.2を参照。

  - TSV形式で文字コードはBOMありUTF-8、改行コードはLF

◆出力イメージ

> \#ItemType 紀要論文（出版者版、オープンアクセス、JaLC\_DOI\_登録あり）(16) https://FQDN/items/jsonschema/16
> 
> \#.id .uri .metadata.path\[0\] .pos\_index\[0\] .publish\_status .feedback\_mail\[0\] .cnri .doi\_ra .doi .edit\_mode .metadata.pubdate　 …
> 
> \#ID URI .IndexID\[0\] .POS\_INDEX\[0\] .PUBLISH\_STATUS .FEEDBACK\_MAIL\[0\] .CNRI .DOI\_RA .DOI Keep/Upgrade Version PubDate …
> 
> \# …
> 
> \# Allow Multiple Allow Multiple Required Allow Multiple Required Required …

4.2 インポート前チェック結果ファイル

  - Import（インポート）画面でダウンロードできる。同画面の表に表示されているチェック結果をTSV形式で出力したファイル。

  - ファイル名は「Check\_ダウンロード日付.tsv」で、2.2⑧～⑫の項目を出力。

> ◆出力イメージ
> 
> \#No. Item Type Item ID Title Check Result

4.3 インポート実行結果ファイル

  - Result（結果）画面でダウンロードできる。同画面の表に表示されているインポート実行結果をTSV形式で出力したファイル。

  - ファイル名は「List\_ダウンロード日付.tsv」で、2.3②～⑦の項目を出力。

  - TSV形式で文字コードはBOM無しUTF-8、改行コードはLF

> ◆出力イメージ
> 
> \#No. Start Date End Date Item Id Action WorkFlow Status

4.4. 「インポート」（Import）タブで一括登録のアイテムを確認・登録する

  - インポート」（Import）タブ  
    読み込んだzipファイルの内容を表示し、一括登録して良いかの確認を促す  
    表示項目は以下の通りである
    
      - 「識別子 変更モード」で登録する旨のメッセージを表示する
        
          - ［Import］ボタンの上に赤字で以下のメッセージを表示する  
            メッセージ：  
            日本語：「 識別子で登録します」  
            英語：「Register with \[Change Identifier Mode\].」
        
          - 「Import」タブから「Selectタブ」に遷移した場合、「識別子変更モード」チェックボックスはチェックありで非活性となっている
    
      - 「サマリー」(Summary)  
        読み込んだファイルのアイテム情報について、以下の件数を表示する
        
          - 総計(Total)：読み込んだファイルのアイテム数
        
          - 新規登録アイテム(New Item)：読み込んだファイルのアイテムの内、新規登録となるアイテム数
        
          - 更新アイテム(Update Item)：読み込んだファイルのアイテムの内、更新のアイテム数
        
          - チェックエラー(Result Error)：バリデートチェックでバリデートエラーとなったアイテム数
    
      - 詳細情報
        
          - 「No.」  
            読み込んだファイルのアイテムの通し番号を表示する
        
          - 「アイテムタイプ」（Item Type）  
            読み込んだファイルのアイテムについて、登録されるアイテムタイプ名を表示する
        
          - 「アイテムID」（Item Id）  
            読み込んだファイルのアイテムについて、新規登録／更新によって表示する内容を変更する
            
              - 新規：””表示なし
            
              - 更新：画面上にアイテムIDを表示する
        
          - 「タイトル」（Title）  
            読み込んだファイルのアイテム名を表示する
            
              - タイトル名はシステムの言語属性に合わせたtitleを表示する
            
              - システムの言語属性に合うtitleが無い場合は英語表記で表示する
            
              - タイトルが長い場合は、横スクロールにならないようにタイトルをトリミングする
                
                  - タイトルを表示上限文字数まで表示して、その直後に「...」をつける
        
          - 「チェック結果」（Check Result）  
            読み込んだファイルの各アイテムについて、インポートが可能かバリデートチェックを実施する  
            エリアに表示する内容は以下の通りである
            
              - エラーが無く、新規のアイテムの場合：「登録」（Register）と表示する
            
              - エラーが無く、アイテムの「.edit\_mode」が「Upgrade」の場合：「バージョンの変更」（Upgrade Version）と表示する
            
              - エラーが無く、アイテムの「.edit\_mode」が「Keep」の場合：「バージョンの維持」（Keep Version）と表示する
            
              - バリデーションエラーがある場合：「エラー: XXXXX」（Error: XXXXX）とエラー内容を表示する
            
              - バリデーションワーニングがある場合：「警告: XXXXX」（Warning: XXXXX）とワーニング内容を表示する
    
      - インポートファイルのバリデーションチェックは以下とする
        
          - Bagit形式の仕様に従っていること
        
          - メタデータの必須項目が入力されていること
        
          - メタデータの入力内容が、入力制約に合致していること
            
              - DOI付与：DOI\_RA の設定に従い、資源タイプ、必須、いずれか必須のチェックを行うこと  
                <https://redmine.devops.rcos.nii.ac.jp/attachments/download/6107/JPCOAR_JaLC_Guideline_appendix_v1.pdf>
            
              - dc:titleのxml:langは必須としない。
            
              - 日付項目：ISO-8601で規定する3 形式（YYYY-MM-DD、YYYY-MM、YYYY）のチェックを行うこと
        
          - 存在するインデックスツリーであること
        
          - 新規登録の場合、既に登録されているDOIが割当されないこと
        
          - 更新の場合、アイテムがWEKO上に存在し、論理削除されていないこと
        
          - 更新の場合、更新前のアイテムタイプが変更後のアイテムタイプと一致していること
        
          - WEKOに登録されていないアイテムタイプがインポートファイルに含まれる場合はエラーとすること
        
          - TSVファイルの項目のバリデーションチェックは以下とする
            
              - POS\_INDEX\[n\]：インデックス名
                
                  - インデックス名が指定されていること
                
                  - 指定したインデックス名が存在していること
            
              - FEEDBACK\_MAIL：フィードバックメール送信先メールアドレス
                
                  - 指定されたメールアドレスはメールアドレスの形式チェックをすること
            
              - PUBLISH\_STATUS：アイテムの公開／非公開設定
                
                  - 指定されたPUBLISH\_STATUSがprivate, publicのいずれかであること
            
              - CNRI：CNRIハンドル
                
                  - 「 識別子 変更モード」を指定している場合  
                    ・CNRIの値が空白になること
                
                  - 「 識別子 変更モード」を指定していない場合  
                    ・新規アイテム登録の場合、CNRIが指定されること  
                    ・既存アイテムへの更新の場合、指定されたCNRIが登録内容と同一であること
            
              - DOI\_RA：DOI付与の種類
                
                  - DOIが指定されている場合、DOI\_RAが指定していることは必須である
                
                  - DOI\_RAが空白になること
                
                  - 指定されたDOI\_RAがJaLC, Crossref, DataCite, NDL JaLC のいずれかであること
                
                  - 「 識別子 変更モード」を指定している場合  
                    ・指定した形式に応じてメタデータの項目チェックを行うこと  
                    ・既存アイテムへの更新の場合、指定された内容が登録内容と同一であること
                
                  - 「 識別子 変更モード」を指定していない場合  
                    ・新規アイテム登録の場合、 DOIが指定されていること  
                    ・既存アイテムへの更新の場合、指定された内容が登録内容と同一であること
            
              - DOI ：DOI
                
                  - 「 識別子 変更モード」を指定している場合  
                    ・DOIが空白になること
                
                  - 「 識別子 変更モード」を指定していない場合  
                    ・新規アイテム登録の場合、 DOIが指定されていること  
                    ・既存アイテムへの更新の場合、指定された内容が登録内容と同一であること
        
          - 環境変数で設定した格納先が下記の状況の場合エラーメッセージを出力する。あわせて、エラーログにも出力する
            
              - 格納先のパスが無かった場合
            
              - 格納先の書き込み権限が無かった場合
            
              - 格納先の容量が不足している場合
        
          - 一括登録の実行時に他端末から実行した場合エラーメッセージを出力する。
            
              - 一括登録を実行中に他の端末が【Administration \> アイテム管理（Items） \> （Import）画面を開いた場合
            
              - 一括登録を実行している端末が【Administration \> アイテム管理（Items） \> インポート（Import）画面を開いた場合（他のブラウザで開いたとき，"Result"タブから再度"Import"タブに遷移したとき等）
            
              - 個別のアイテム編集中に、一括登録を実施した場合
            
              - 個別のアイテム削除後に、一括登録を実施した場合
    
      - バリデーションのエラーメッセージ及びワーニングメッセージは以下の通りである

<table>
<thead>
<tr class="header">
<th><strong>No.</strong></th>
<th><strong>タイプ</strong></th>
<th><strong>英語</strong></th>
<th><strong>日本語</strong></th>
<th><strong>利用場合</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>エラー</td>
<td>Specified item type does not exist.</td>
<td>指定されたアイテムタイプが存在していません。</td>
<td>指定されたアイテムタイプがシステムに存在しない場合</td>
</tr>
<tr class="even">
<td>2</td>
<td>エラー</td>
<td>Please specify item ID by half-width number.</td>
<td>アイテムIDは半角数字で指定してください。</td>
<td>アイテムIDが不正な形式で指定した場合</td>
</tr>
<tr class="odd">
<td>3</td>
<td>エラー</td>
<td>Item ID does not match the specified URI information.</td>
<td>アイテムIDが指定されたURIの情報と一致しません</td>
<td>アイテムIDが指定されたURIの情報と一致しない場合</td>
</tr>
<tr class="even">
<td>4</td>
<td>エラー</td>
<td>Specified URI and system URI do not match.</td>
<td>指定されたURIとシステムURIが一致しません。</td>
<td>指定されたURIとシステムURIが一致しない場合</td>
</tr>
<tr class="odd">
<td>5</td>
<td>エラー</td>
<td>Please specify {}.</td>
<td>{}を設定してください。</td>
<td>PUBLISH_STATUS, CNRI, DOI_RA, DOI, POS_INDEX, IndexIDが空白の場合</td>
</tr>
<tr class="even">
<td>6</td>
<td>エラー</td>
<td>{} is required item.</td>
<td>{}は必須項目です。</td>
<td>DOI_RA, DOI, PUBLISH_STATUSが指定されない場合</td>
</tr>
<tr class="odd">
<td>7</td>
<td>エラー</td>
<td>{} cannot be set.</td>
<td>{}は設定できません。</td>
<td>CNRI, DOI_RA, DOIが指定した場合</td>
</tr>
<tr class="even">
<td>8</td>
<td>エラー</td>
<td>{} must be one of JaLC, Crossref, DataCite.</td>
<td>{}は JaLC, Crossref, DataCiteのいずれかである必須があります。</td>
<td>DOI_RAにJaLC, Crossref, DataCite以外のものを指定した場合</td>
</tr>
<tr class="odd">
<td>9</td>
<td>エラー</td>
<td>Specified {} is different from existing {}.</td>
<td>指定された{}は登録している{}と異なっています。</td>
<td>CNRI, DOI_RA, DOIに指定された内容が登録内容と異なる場合</td>
</tr>
<tr class="even">
<td>10</td>
<td>エラー</td>
<td>Specified {} is invalid.</td>
<td>指定された{}は不正です。</td>
<td>FEEDBACK_MAIL, DOI, PUBLISH_STATUSが不正な形式で指定した場合</td>
</tr>
<tr class="odd">
<td>11</td>
<td>エラー</td>
<td>PID does not meet the conditions.</td>
<td>PID付与の条件を満たしていません。</td>
<td>DOIバリデーションチェックの場合</td>
</tr>
<tr class="even">
<td>12</td>
<td>エラー</td>
<td>The storage path is incorrect.{} Please contact the administrator.</td>
<td>格納先のパスが正しくありません。{} 管理者へお問い合わせください。</td>
<td><p>格納先のパスが無かった場合</p>
<p>※v0.9.22ではエラーチェックがないため出力されない</p></td>
</tr>
<tr class="odd">
<td>13</td>
<td>エラー</td>
<td>The storage location cannot be accessed.{} Please contact the administrator.</td>
<td>格納先にアクセスできません。{} 管理者へお問い合わせください。</td>
<td><p>格納先の書き込み権限が無かった場合</p>
<p>※v0.9.22ではエラーチェックがないため出力されない</p></td>
</tr>
<tr class="even">
<td>14</td>
<td>エラー</td>
<td>There is not enough storage space. Please contact the administrator.</td>
<td>格納先の容量が不足しています。管理者へお問い合わせください。</td>
<td><p>格納先の容量が不足している場合</p>
<p>※v0.9.22ではエラーチェックがないため出力されない</p></td>
</tr>
<tr class="odd">
<td>15</td>
<td>エラー</td>
<td>Import is in progress on another device.</td>
<td>他の端末でインポートを実行中です。</td>
<td>一括登録を実行中に他の端末が Admin&gt;Items&gt;Import 画面を開いた場合</td>
</tr>
<tr class="even">
<td>16</td>
<td>エラー</td>
<td>Import is in progress.</td>
<td>インポートを実行中です。</td>
<td>一括登録を実行している端末が Admin&gt;Items&gt;Import 画面を開いた場合（他のブラウザで開いたとき，"Result"タブから再度"Import"タブに遷移したとき等）</td>
</tr>
<tr class="odd">
<td>17</td>
<td>エラー</td>
<td>Cannot update because the corresponding item is being edited.</td>
<td>該当アイテムが編集中のため更新できません。</td>
<td>個別のアイテム編集中に、一括登録を実施した場合</td>
</tr>
<tr class="even">
<td>18</td>
<td>エラー</td>
<td>The corresponding item has been deleted.</td>
<td>該当アイテムは削除済です。</td>
<td>個別のアイテム削除後に、一括登録を実施した場合</td>
</tr>
<tr class="odd">
<td>19</td>
<td>ワーニング</td>
<td>The specified {} does not exist in system.</td>
<td>指定された{}はシステムに存在しません。</td>
<td>指定したPOS_INDEXなどの指定した１つの項目がシステムに存在しない場合</td>
</tr>
<tr class="even">
<td>20</td>
<td>ワーニング</td>
<td>Specified {} and {} do not exist in system.</td>
<td>指定された{}と{}はシステムに存在していません。</td>
<td>指定したPOS_INDEX、INDEX_IDなどの複数項目がシステムに存在しない場合</td>
</tr>
<tr class="odd">
<td>21</td>
<td>ワーニング</td>
<td>Specified {} does not match with existing index.</td>
<td>指定された{}はシステムのものと一致していません。</td>
<td>指定したPOS_INDEXはシステムのものと一致していない場合</td>
</tr>
</tbody>
</table>

  - 「ダウンロード」（Download）ボタン  
    画面に表示されているアイテムのリストをTSV形式でダウンロードできる
    
      - 文字コードはBOM無しUTF-8、改行コードはLFとする
    
      - タイトル等トリミングされている場合は、ファイルにはすべて出力されるようにする
    
      - ファイル名は「Check\_ダウンロード日付.tsv」とする

  - 「インポート」（Import）ボタン  
    読み込んだTSVファイルのアイテムを登録する
    
      - 処理途中に問題があるアイテムがあっても、一括登録処理は中断させず、次のアイテムの処理に進む
    
      - 大量登録時のセッションタイムアウトを防ぐように、処理は非同期処理とする
    
      - インデックスには
        
          - インデックスID及びPOS\_INDEX\[n\]を元に指定する
            
              - POS\_INDEX\#nnが複数指定されている場合はそれぞれに登録する
            
              - インデックスIDとPOS\_INDEX\[n\]が不整合の場合は、ワーニングメッセージを出力して、IndexID\[n\]で指定したインデックスに登録する
    
      - DOI/CNRI付与には（「識別子変更モード」（Change Identifier Mode.）チェックボックスにチェックを入れる場合）
        
          - 新規で一括登録するアイテムに、DOI\_RAの設定に従い、指定したDOI（JaLC, Crossref, DataCite, NDL JaLC）及びCNRIをpidstoreに登録できる
        
          - 既存のアイテムに、DOI\_RAの設定に従い、登録されているDOI（JaLC, Crossref, DataCite, NDL JaLC）及びCNRIを変更できる  
            pidstoreに存在する該当レコードを論理削除して指定したDOIを登録する
        
          - DOI/CNRI付与の処理はワークフローのIdentifier Grantで指定した時と同じ処理である
    
      - ワークフローには
        
          - 該当アイテムタイプのワークフローが存在する場合、このワークフローが対象とする
        
          - 該当アイテムタイプのワークフローが存在しない場合、新しいワークフローを作成、メタデータ登録(Item Registrationアクション)まで完了している
        
          - デフォルトフロー名：「Registration Flow」  
            アクション：Start -\> Item registration -\> End
        
          - デフォルトワークフロー名：該当アイテムタイプ名
    
      - アイテム公開／非公開は、一括登録用ファイルの内容に合わせる
    
      - 既存のアイテムを更新するときに値（必須項目以外）を空欄にしてインポート更新をした場合、空欄となったメタデータは削除として更新される
    
      - 「インポート」（Import）ボタン押下後、結果タブの画面に遷移する

4.5. 「結果」（Result）タブで一括登録の結果を表示する

  - 「結果」（Result）タブ  
    最後に実施したアイテム一括登録の状況をリスト形式で確認する  
    初期値は表のヘッダ部分のみ表示されているものとし、以降は最後に一括登録を実施したときのリストが表示される  
    1000ミリ秒ごとに状況を取得し、画面に表示する  
    すべてのインポートが成功または失敗したら、それ以降は状況を取得しない
    
      - 表示項目は以下の通りである
        
          - 「No.」  
            読み込んだTSVファイルのアイテムの通し番号を表示する
        
          - 「開始日」（Start Date）  
            \[Import\]ボタン押下後、1アイテムに対して登録処理を開始した日時を表示する  
            フォーマット：YYYY-MM-DD hh:mm:ss  
            登録処理開始後でも、ソース上で定義されていないエラーによる異常終了の場合は空白となる
        
          - 「終了日」（End Date）  
            1アイテムに対して登録処理が完了した日時を表示する
        
          - フォーマット：YYYY-MM-DD hh:mm:ss
        
          - 「アイテムID」（Item Id）  
            各アイテムのアイテムIDを表示する
        
          - 「アクション」（Action）  
            各アイテムがワークフローのどのアクションにいるかを表示する  
            初期状態では空欄、開始後に「Start」、正常終了で「終了（End）」、異常終了で「Error:（エラーメッセージ）」  
            ただし、ソース上で定義されていないエラーによる異常終了の場合は「Start」
        
          - 「ワークフローステータス」（Work Flow Status）  
            各アイテムのワークフローのステータスがどの状態かを表示する
    
      - 「ダウンロード」（Download）ボタン  
        画面に表示されているアイテムのリストをTSV形式でダウンロードできる
        
          - 文字コードはBOM無しUTF-8、改行コードはLFとする
        
          - タイトル等トリミングされている場合は、ファイルにはすべて出力されるようにする
        
          - ファイル名は「List\_ダウンロード日付.tsv」とする

その他

  - インポートのtsvファイルでファイル情報が無いにもかかわらず、「ファイル情報 \[1\] 」や「ファイル情報 \[2\] 」のヘッダがインポートファイルの中に存在している（ファイル情報 \[0\] は存在している）場合であっても、エラーとならないように対応

  - DOIの自動採番ルールは以下の通り
    
      - 識別子変更モード
    
      - DOIの自動採番は行わない
        
          - インポートファイルにdoiやprefixが含まれている場合はエラーメッセージを表示する。
            
              - DOIが空欄の場合  
                　「Please specify DOI prefix/suffix.」
            
              - インポートファイルにdoiやprefixが含まれている場合　(「prefix」もしくは「prefix/」を指定した場合）  
                　「DOI suffixを設定してください。」／「Please specify DOI suffix.」
    
      - Not 識別子変更モード
        
          - 以下の条件をすべて満たしたときにDOIを付与する
            
              - Admin \> Setting \> Identifier でprefixの設定があること
            
              - DOI：空欄であること
            
              - DOI\_RA：JaLC, Crossref, DataCite, NDL JalC のいずれかであること

  - 「Not 識別子変更モード」で、既存アイテム(DOI付与無し)に自由記述でDOIをインポートしようとした際にエラーメッセージを出す
    
      - 「指定された{DOI}が登録済みの{DOI}と異なっています」

  - DOIの付与はPID付与の制約条件表 ( JPCOAR\_JaLC\_Guideline\_appendix\_v1.pdf ) に従って、「必須」と「いずれか必須」の条件をもとにDOI付与可否を決定している。  
    なお、必須のマッピング項目がひとつのアイテムタイプ内に複数ある場合、複数あるうちのひとつだけ入力されていれば、DOI付与の条件を満たすものとする。

  - DOI付与済みアイテムを新規登録後、更新時に必須項目の値の削除や必須項目のプロパティの削除はできない。  
    削除をした場合、インポートタブのチェック処理で「PID付与の条件を満たしていません。」とエラーメッセージが表示される。  
    また、更新時に資源タイプ（dc:type）の変更は同じコンテンツ種類内でのみ許可される。それ以外の資源タイプに変更した場合、インポートタブのチェック処理で「DOI付与済みアイテムの資源タイプの変更はできません。」とエラーメッセージが表示される。

  - 制限公開用プロパティもインポートすることができる
    
      - 制限公開用プロパティ: 利用規約情報、アクセス(制限公開)、データタイプ、提供方法（ワークフロー、ロール）

  - インポートしたアイテムは、操作アカウントによって作成されたものとして扱われる。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko-admin

  - > weko-search-ui

<!-- end list -->

  - > 処理概要

1 処理に関するエトセトラ

  - アイテムタイプ項目のチェックに使用しているライブラリ

  - zipファイルの解凍に使用しているライブラリ：zipfile

  - インポート実行時のceleryタスク

  - 識別子変更モードを指定した際のpidstroreの処理について

  - 作成者プロパティの「iscreator」画面表示同様、TSVファイルに出力しないよう制御している

  - depositの「owners」が空欄になっていた場合でも"list index out of range"のエラーが発生しないようにエラーハンドリング処理を追加

  - インポート処理に例外が発生してもESに存在しているアイテム情報が消えないように実装

  - DOIを取り下げたアイテムは、インデックスの状態に関係なくインポートが機能し、ワークフローで編集できる

  - ユーザのセッション有効時間を超過した場合でもインポート処理は完了する

  - ※インポート処理完了後に、celeryタスクの処理で、作業用のテンポラリディレクトリを削除する

2\. tmpディレクトリ

  - 登録されたインポートファイルのチェックをする際に作成するテンポラリファイルは以下のように生成する
    
      - /home/invenio/.virtualenvs/invenio/var/instance/data/tmp/weko\_import\_xxxxxxxx

  - アイテムをインポートする際に作成するテンポラリファイルは以下のように生成する
    
      - /home/invenio/.virtualenvs/invenio/var/instance/data/tmp/weko\_import\_YYYYMMDDhhmmss

3\. 設定

  - 一括登録画面のテンプレートを設定する
    
      - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-search-ui/weko_search_ui/config.py#L87>
    
      - 設定キー：WEKO\_ITEM\_ADMIN\_IMPORT\_TEMPLATE
    
      - 現在の設定値：

> WEKO\_ITEM\_ADMIN\_IMPORT\_TEMPLATE = 'weko\_search\_ui/admin/import.html'

  - 「インポート」（Import）タブ にてダウンロードファイルに表示する項目を設定する
    
      - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-search-ui/weko_search_ui/config.py#L512>
    
      - 設定キー：WEKO\_IMPORT\_CHECK\_LIST\_NAME
    
      - 現在の設定値：

> WEKO\_IMPORT\_CHECK\_LIST\_NAME = \["No", "Item Type", "Item Id", "Title", "Check result"\]

  - 「結果」（Result）タブにてダウンロードファイルに表示する項目を設定する
    
      - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-search-ui/weko_search_ui/config.py#L514>
    
      - 設定キー：WEKO\_IMPORT\_LIST\_NAME
    
      - 現在の設定値：

> WEKO\_IMPORT\_LIST\_NAME = \[
> 
> "No",
> 
> "Start Date",
> 
> "End Date",
> 
> "Item Id",
> 
> "Action",
> 
> "Work Flow ",
> 
> \]

  - メール形式（フィードバックメール）を設定する
    
      - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-search-ui/weko_search_ui/config.py#L524>
    
      - 設定キー：WEKO\_IMPORT\_EMAIL\_PATTERN
    
      - 現在の設定値：

> WEKO\_IMPORT\_EMAIL\_PATTERN = r"(^\[a-zA-Z0-9\_.+-\]+@\[a-zA-Z0-9-\]+\\.\[a-zA-Z0-9-.\]+$)"

  - tsvファイルに正当となる公開ステータスを設定する
    
      - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-search-ui/weko_search_ui/config.py#L525>
    
      - 設定キー：WEKO\_IMPORT\_PUBLISH\_STATUS
    
      - 現在の設定値：

> WEKO\_IMPORT\_PUBLISH\_STATUS = \['public', 'private'\]

  - tsvファイルに正当となるDOI\_RAの値を設定する
    
      - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-search-ui/weko_search_ui/config.py#L526>
    
      - 設定キー：WEKO\_IMPORT\_DOI\_TYPE
    
      - 現在の設定値：

> WEKO\_IMPORT\_DOI\_TYPE = \["JaLC", "Crossref", "DataCite", "NDL JaLC" \]

  - 日付(ISO-8601)プロパティのサブアイテムキーを設定する  
    日付形式のバリデーションチェックに使用する
    
      - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-search-ui/weko_search_ui/config.py#L528>
    
      - 設定キー：WEKO\_IMPORT\_SUBITEM\_DATE\_ISO
    
      - 現在の設定値：

> WEKO\_IMPORT\_SUBITEM\_DATE\_ISO = "subitem\_1582683677698"

  - 免責事項表示の対応言語を設定する
    
      - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-search-ui/weko_search_ui/config.py#L532>
    
      - 設定キー：WEKO\_ADMIN\_IMPORT\_CHANGE\_IDENTIFIER\_MODE\_FILE\_LANGUAGES
    
      - 現在の設定値：

> WEKO\_ADMIN\_IMPORT\_CHANGE\_IDENTIFIER\_MODE\_FILE\_LANGUAGES = \['en', 'ja'\]

  - 免責事項ファイルの配置先を設定する
    
      - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-search-ui/weko_search_ui/config.py#L534>
    
      - 設定キー：WEKO\_ADMIN\_IMPORT\_CHANGE\_IDENTIFIER\_MODE\_FILE\_LOCATION
    
      - 現在の設定値：

> WEKO\_ADMIN\_IMPORT\_CHANGE\_IDENTIFIER\_MODE\_FILE\_LOCATION = (
> 
> "/code/modules/weko-search-ui/weko\_search\_ui/static/change\_identifier\_mode/"
> 
> )

  - 免責事項ファイルのプレフィックスを設定する
    
      - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-search-ui/weko_search_ui/config.py#L538>
    
      - 設定キー：WEKO\_ADMIN\_IMPORT\_CHANGE\_IDENTIFIER\_MODE\_FIRST\_FILE\_NAME
    
      - 現在の設定値：

> WEKO\_ADMIN\_IMPORT\_CHANGE\_IDENTIFIER\_MODE\_FIRST\_FILE\_NAME = "change\_identifier\_mode"

  - 免責事項ファイルの拡張子を設定する
    
      - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-search-ui/weko_search_ui/config.py#L540>
    
      - 設定キー：WEKO\_ADMIN\_IMPORT\_CHANGE\_IDENTIFIER\_MODE\_FILE\_EXTENSION
    
      - 現在の設定値：

> WEKO\_ADMIN\_IMPORT\_CHANGE\_IDENTIFIER\_MODE\_FILE\_EXTENSION = ".txt"

  - POS\_INDEXの区切り文字を設定する
    
      - パス：modules/weko-items-ui/weko\_items\_ui/config.py
    
      - 設定キー：WEKO\_ITEMS\_UI\_INDEX\_PATH\_SPLIT
    
      - 現在の設定値：

> WEKO\_ITEMS\_UI\_INDEX\_PATH\_SPLIT = '///'

  - インポート実行時のセッション
    
      - パス：modules/ weko-admin/weko\_admin/config.py
    
      - 設定キー：WEKO\_ADMIN\_IMPORT\_PAGE\_LIFETIME
    
      - 現在の設定値：

> WEKO\_ADMIN\_IMPORT\_PAGE\_LIFETIME = 43200

4\. 実装方法

  - 対応しているモジュール：weko\_search\_ui

  - depositの「owners」が空欄になっていた場合でも"list index out of range"のエラーが発生しないようにエラーハンドリング処理を追加

  - インポート処理に例外が発生してもESに存在しているアイテム情報が消えないように実装

5\. tmpディレクトリ

  - 登録されたインポートファイルのチェックをする際に作成するテンポラリファイルは以下のように生成する
    
      - /home/invenio/.virtualenvs/invenio/var/instance/data/tmp/weko\_import\_xxxxxxxx

  - アイテムをインポートする際に作成するテンポラリファイルは以下のように生成する
    
      - /home/invenio/.virtualenvs/invenio/var/instance/data/tmp/weko\_import\_YYYYMMDDhhmmss

  - テンポラリファイルの格納先は環境変数(docker-compose.yml) で設定できるようにする  
    <https://docs.python.org/3/library/tempfile.html#tempfile.gettempdir>

6. 排他処理

インポート処理中「cache::import_start_time」キーに現在時間を格納する。キーは/admin/items/import/check_import_is_availableを呼び出すことでインポート処理の有無を確認しキーを削除する。


【補足】Import機能と個別登録(WorkFlow)の違い

  - Import機能はTSVファイルの文法チェックを実施しています。

  - メタデータ項目チェック（※）は共通処理（Draft4Validator）を使っていますが、他のチェック処理（tsvのインデックス名・ID、CNRI/DOIのチェック）は共通化できないので、別々に実装されています。  
    ※必須項目チェック、入力データ型とアイテムタイプに定義されたデータ型と同じになるかのチェック。

  - 個別登録と一括登録のチェック処理を別に実装している理由は、チェックするタイミングでデータの構成が違っているため、共通処理が使えません。
    
      - 個別登録のチェックタイミング：Identifier Grantの時に、メタデータが存在しているので、それを元にチェックする。
    
      - 一括登録のチェックタイミング：メタデータがなくて、tsvファイルに指定されたデータを変換しチェックする。

その他補足

（Wikiより）

  - 「System」としている項目（"資源タイプResource", "出版タイプResource", "アクセス権Resource"）を一括登録時に自動で設定する機能に関して、  
    自動設定の前提として、対象のアイテムタイプについて各項目がAdmin\>ItemTypes\>MappingでJPCOARスキーマのマッピングが設定されている必要があります

  - インポート更新時にに資源タイプ（dc:type）の変更は同じコンテンツ種類内でのみ許可される。それ以外の資源タイプにを変更した場合、インポートタブのチェック処理で以下のようにエラーメッセージが表示される。
    
      - 「DOI 付与済みアイテムの資源タイプの変更はできません。」

  - 同じコンテンツファイル（ファイル名とファイルパスが同一）を含んだインポートファイル（zip）をインポートした場合のファイルの格納方法は以下の通り。
    
      - Keep: ファイルは上書きされる
    
      - Upgrade: ファイルは新しく格納される

  - インポートのtsvファイル内のメタデータにおける"\<br/\>"は、インポートの際に"\\n"に置換する

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>
    
### ツリー編集

<!-- end list -->

  - > <span id="_ツリー編集" class="anchor"></span>目的・用途

本機能は、インデックスツリーの追加、編集、削除を担当している機能である。  
インデックスツリー情報の公開設定、閲覧権限、投稿権限などを編集できる。

  - > 利用方法

1\. システム管理者、リポジトリ管理者でログインする。

2.【Administration\>インデックスツリー管理(Index Tree)\>ツリー編集(Edit Tree)】画面を開く。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

> 1\. インデックスツリーを追加する  
> 【Administration \> インデックスツリー管理 \> ツリー編集（Edit Tree）】画面に移動する。  
> その後新しく作成するインデックスの親となるインデックスをRootIndex以下から選択する。  
> そして、Edit Treeエリア左上にある「追加」（Add）ボタンを押すことで、インデックスが新規登録される。

  - 「追加」（Add）ボタンを押す時に選択しているインデックスの最下行に、インデックス（New Index）を配置する。  
    「Root Index」を選択している場合、インデックス一覧の最下行に配置する。

> 2\. インデックスツリーを編集する  
> 【Administration \> インデックスツリー管理 \> ツリー編集（Edit Tree）】画面にて編集したいインデックスを押下することでそのインデックスの編集画面が右に表示される。  
> なお、Root Indexは選択することができるが、編集することはできない。
> 
> インポート中はインデックスツリーの編集ができない。

  - 入力内容は以下の通りである。
    
      - 「インデックス」（Index）
        
          - 日本語と英語のインデックス名用のテキストボックスを設ける。  
            日本語：サイトの表示言語が日本語の時に表示される。  
            英語：サイトの表示言語が日本語以外の時に表示される。
        
          - 英語のインデックス名は必須項目とする。
        
          - デフォルト値：「New Index」
    
      - 「コメント」（Comment）
        
          - インデックスのコメントを入力する。
        
          - URLを表示する場合、次の形式で入力する。  
            形式：

> \[\[URL|表示名\]\]
> 
> 上記のように入力すると、表示名をリンクで表示する。「|表示名」を省略した場合、URLをリンク形式で表示する。

  - 「公開」（Publish）
    
      - 「公開する」（Open to public）チェックボックスを設ける。
    
      - チェックを入れた場合
        
          - インデックスの公開日の入力欄を表示させる。
        
          - 「子インデックスの公開日にも再帰的に反映させる」（Set the publication date of child indexes recursively）チェックボックスを表示させる。  
            チェックを入れた場合、所属する子インデックスと子孫インデックスすべてに公開日の設定が再帰的に設定される。

  - 「インデックスリンク」（Index Link）
    
      - 「Enable」チェックボックスを設ける  
        チェックを入れた場合、インデックスリンク検索が有効になっている時インデックスリンク検索の際にプルダウンに表示される。
        
          - インデックスリンク検索を有効にするには[ADMIN-14-2 インデックスリンク表示](\\l)を参照すること
    
      - インデックスリンクの表示を決めるテキストボックスを「日本語」と「英語」の二つとして設ける。
    
      - なお、「英語」は必須項目となっていて、初期値は「New Index」とする。インデックスリンクの仕様については[USER-1-3インデックス検索](\\l)を参照すること。
    
      - 「表示範囲」（More Function）  
        「公開する」（Limit the number of child indexes to show.）チェックボックスを設ける。チェックを入れた場合、初回表示個数を設定できる。デフォルト値が「5」とする。
    
      - 選択しているインデックスに子インデックスを登録しない場合、このチェックボックスは非活性とする。

  - 「RSSアイコン」（RSS Icon）  
    「表示する」（Display）チェックボックスを設ける。
    
      - チェックを入れた場合、インデックスリストにRSSアイコンが表示される。
    
      - RSSの機能詳細は[USER-1-6 RSS](\\l)を参照すること。

  - 「PDF Cover Page (JA)」（PDF Cover Page）  
    「Enable」チェックボックスを設ける。  
    このチェックボックスは【Administration\>設定(Setting)\>PDFカバーページ表示】画面にて「PDF Cover Page」エリアで「Enable」を選んでいると編集が可能になる。設定の詳細は[ADMIN-14-4 PDFカバーページ表示](\\l)を参照すること。
    
      - チェックを入れる場合、PDFカバーページが作成される。
    
      - 編集が可能になっている場合、「Also reflect recursively on child index」チェックボックスが表示される。
        
          - チェックを入れて保存した場合、所属する子インデックスと子孫インデックスすべてにこのエリアのPDFカバーページの設定が再帰的に設定される。

  - 「ハーベスト公開」（Harvest Publish）  
    「公開する」（Open to public）チェックボックスを設ける
    
      - チェックを入れた場合、インデックスへのハーベスト要求に対して、所属するデータを提供できる。

  - 「ONLINE ISSN」（Online ISSN）  
    インデックスにオンラインISSNの値を入力する。  
    「このインデックス直下のアイテムの利用統計を集計する」（Aggregate usage statistics of items belonging to this index.)チェックボックスを設ける。
    
      - チェックを入れた場合、子インデックスへの再帰的な設定値反映および利用統計集計する。  
        \[注意！\]  
        ただし、WEKO3側で、ONLINE ISSN ごとに集計する機能は存在しない。  
        利用統計通常は、インデックス単位でとる仕様である。  
        将来的にONLINE ISSN ごとに集計するようになった場合に備えて移行をしておく。

  - 「閲覧権限」（Browsing Privilege）
    
      - ロール権限の設定には、  
        「ロール権限あり」（Role Authorized）と「権限なし」（Unauthorized）エリアを設ける。
        
          - 「ロール権限あり」（Role Authorized）は、デフォルトとして、以下の権限が表示される。
            
              - Contributor
            
              - Authenticated User
            
              - Guest
        
          - 「子インデックスのロール権限にも再帰的に反映させる」（Set the base authorities of child indexes recursively）チェックボックスにチェックを入れることで、所属するすべての子インデックスと子孫インデックスにロール権限の設定が再帰的に設定される。
    
      - グループ権限の設定には、  
        「グループ権限あり」（Group Authorized）と「権限なし」（Unauthorized）エリアを設ける。
        
          - 「グループ権限あり」（Group Authorized）は、デフォルトとして、登録されているグループが表示される。
        
          - 「子インデックスのグループ権限にも再帰的に反映させる」（Set the base authorities of child indexes recursively）チェックボックスにチェックを入れることで、所属する子インデックスと子孫インデックスすべてにグループの設定が再帰的に設定される。

  - 「投稿権限」（Deposit Privilege）
    
      - ロール権限の設定には、  
        「ロール権限あり」（Role Authorized）と「権限なし」（Unauthorized）エリアを設ける。
        
          - 「ロール権限あり」（Role Authorized）は、デフォルトとして、以下の権限が表示される。
            
              - System Administrator
            
              - Repository Administrator
            
              - Contributor
            
              - Community Administrator 
            
              - Authenticated User : -98
            
              - Guest : -99
        
          - 「子インデックスのロール権限にも再帰的に反映させる」（Set the base authorities of child indexes recursively）チェックボックスにチェックを入れることで、所属するすべての子インデックスと子孫インデックスにロール権限の設定が再帰的に設定される。
    
      - グループ権限の設定には、  
        「グループ権限あり」（Group Authorized）と「権限なし」（Unauthorized）エリアを設ける。
        
          - 「グループ権限あり」（Group Authorized）は、デフォルトとして、登録されているグループが表示される。
        
          - 「子インデックスのグループ権限にも再帰的に反映させる」（Set the base authorities of child indexes recursively）チェックボックスにチェックを入れることで、所属する子インデックスと子孫インデックスすべてにグループの設定が再帰的に設定される。

  - 「表示形式(検索結果)」（Display Format(Search Results)）  
    検索結果の表示形式を選択する。
    
      - 「一覧形式」（List）  
        検索結果をアイテムの一覧で表示する。デフォルトはこの形式で設定されている。  
        一覧形式の詳細は[USER-2-1 一覧形式表示](\\l)を参照すること。
    
      - 「目次形式」（Table Of Contents）  
        検索結果を見出しの一覧で表示する。  
        目次形式の詳細は[USER-2-2 目次形式表示](#目次形式表示)を参照すること。

  - インデックスサムネイル画像のアップロードエリア

<!-- end list -->

  - 「送信」（Send）ボタンを押すと、編集したインデックスが保存される。

  - 親インデックスにサムネイルが登録されている場合、子インデックス作成時にサムネイルは引き継がれない。

  - サムネイルの添付可能な形式は「gif, jpg, jpe, jpeg, png, bmp」のみ。  
    その他の形式を選択すると、「画像ファイル（gif, jpg, jpe, jpeg, png, bmp）以外のファイルはアップロードできません。」とエラーメッセージを表示する

  - サムネイルを登録後、「削除」ボタンを配置し、登録したサムネイルを削除できるようにする  
    ※「削除」ボタン押下時に、メッセージ等は表示しない。「送信」ボタンを押下することでサムネイルの削除が反映されるようにする。

  - サムネイル画像は表示時の画面サイズに応じて縮小される。画像を拡大表示することはしない。

<!-- end list -->

  - 必須項目を入力しない場合、インデックスが追加されずに、エラーメッセージがポップアップアラートで表示される。また、必須項目の直下にエラーメッセージも表示される。  
    ポップアップアラートで表示されるエラーメッセージ：「必須入力項目を入力してください」  
    該当項目下に表示されるエラーメッセージ：「英語で入力は必要です。」

  - エラーがない場合は「正常にインデックスを更新しました。(Index is updated successfully.)」というポップアップが表示される。

  - DOI(デジタルオブジェクト識別子)付与済アイテムがインデックスに存在した場合、インデックス状態の「公開」から「非公開」への変更を認めない。  
    日本語：DOIが付与されているアイテムからのリンクがあるため、インデックスを非公開にすることはできません。  
    英語：The index cannot be kept private because there are links from items that have a DOI.

  - DOI付与済アイテムがインデックスに存在した場合、ハーベスト状態の「公開」から「非公開」への変更を認めない。  
    日本語：DOIが付与されているアイテムからのリンクがあるため、インデックスのハーベストを非公開にすることはできません。  
    英語：Index harvests cannot be kept private because there are links from items that have a DOI.

3\. インデックスツリーを削除する

  - 削除したいインデックスを選択した状態で、「削除」（Delete）ボタンを押すと、確認ダイヤログを表示させる。  
    削除処理中はインデックス操作ができなくなる。(\[追加\]ボタン，\[削除\]ボタン，\[送信\]ボタンが非活性となる)  
    確認メッセージ：  
    日本語：「DELETEインデックス以下のインデックスおよびアイテムに対する処理を選択してください」  
    英語：「Please choose processing about index and items\!」
    
      - 「すべて削除」(Delete All)ボタンを押すと、インデックスを削除する。子インデックスおよびアイテムが、すべて削除される。
    
      - 「キャンセル」(Cancel)ボタンを押すと、確認ダイアログを閉じる。
    
      - 当該インデックスのみに所属するDOI付与済アイテムが存在した場合、インデックス自身の削除を認めない。  
        日本語：DOIが付与されているアイテムからのリンクがあるため、インデックスを削除することはできません。  
        英語：The index cannot be deleted because there is a link from an item that has a DOI.
    
      - 当該インデックス以外にもインデックス状態が「公開」かつハーベスト公開が「公開」のインデックスにリンクするDOI付与済アイテムが存在する場合、編集・削除の操作への制限はしない。
    
      - エラーがない場合は「正常にインデックスを削除しました。(Index is deleted successfully.)」というポップアップが表示される。その後、画面がリフレッシュされ、該当のインデックスは削除される。

  - ハーベスト設定で利用されているインデックスは削除できない。

  - アイテムインポート中はインデックスを削除できない。

4\. インデックスツリーを移動する。

  - > インデックスの順序の変更と所属する親インデックスの変更はドラッグ&ドロップにより可能である。  
    > なお、Root Indexを動かすことはできない。アイテムインポート中はインエックスを移動できない。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_index\_tree

  - > weko\_search\_ui

  - > weko\_admin

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - インデックスツリー編集画面表示について
    
      - 【Administration\>インデックスツリー管理\>ツリー編集】画面を開く。そのとき、weko\_index\_tree.admin.indexメソッドを呼び出し、indexテーブルよりインデックスツリー情報を取得し、表示する。

  - インデックス追加について
    
      - 【Administration \> インデックスツリー管理(Index Tree) \> ツリー編集（Edit Tree）】画面にて追加ボタンを押下すると、weko\_index\_tree.rest.postメソッドにてweko\_index\_tree.api.createが呼び出される。  
        それによって初期値が以下の表であるインデックスを生成され、indexテーブルに登録される。

  - インデックスのキャッシュについて
    
      - インデックスのキャッシュはRedisサーバに以下キー名でインデックス保存時に作成される。
        
          - index\_tree\_view\_" + os.environ.get('INVENIO\_WEB\_HOST\_NAME') + "\_" + lang

<table>
<thead>
<tr class="header">
<th>インデックスツリー設定値</th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>#</td>
<td>項目(日本語)</td>
<td>DBキー</td>
<td>デフォルト値</td>
<td>備考</td>
</tr>
<tr class="even">
<td>1</td>
<td>なし</td>
<td>id</td>
<td>(現在の時間を元にしたもの)</td>
<td>time.timeメソッドに1000を掛けた値</td>
</tr>
<tr class="odd">
<td>2</td>
<td>なし</td>
<td>parent</td>
<td>(親インデックスのID)</td>
<td>rootindex下なら初期値0</td>
</tr>
<tr class="even">
<td>3</td>
<td>インデックス</td>
<td>index_name</td>
<td>New Index</td>
<td></td>
</tr>
<tr class="odd">
<td>4</td>
<td></td>
<td>index_name_english</td>
<td>New Index</td>
<td>必須事項</td>
</tr>
<tr class="even">
<td>5</td>
<td>コメント</td>
<td>comment</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>6</td>
<td>公開</td>
<td>public_state</td>
<td>false</td>
<td></td>
</tr>
<tr class="even">
<td>7</td>
<td></td>
<td>public_date</td>
<td>None</td>
<td>yyyy/MM/dd HH:mm:ssの形式</td>
</tr>
<tr class="odd">
<td>8</td>
<td></td>
<td>recursive_public_state</td>
<td>false</td>
<td></td>
</tr>
<tr class="even">
<td>9</td>
<td>インデックスリンク</td>
<td>index_link_enabled</td>
<td>false</td>
<td></td>
</tr>
<tr class="odd">
<td>10</td>
<td></td>
<td>index_link_name</td>
<td>None</td>
<td></td>
</tr>
<tr class="even">
<td>11</td>
<td></td>
<td>index_link_name_english</td>
<td>New Index</td>
<td>必須事項</td>
</tr>
<tr class="odd">
<td>12</td>
<td>表示範囲</td>
<td>more_check</td>
<td>false</td>
<td></td>
</tr>
<tr class="even">
<td>13</td>
<td></td>
<td>display_no</td>
<td>5</td>
<td>表示数</td>
</tr>
<tr class="odd">
<td>14</td>
<td>RSSアイコン</td>
<td>rss_status</td>
<td>false</td>
<td></td>
</tr>
<tr class="even">
<td>15</td>
<td>PDFCoverPage</td>
<td>coverpage_state</td>
<td>false</td>
<td></td>
</tr>
<tr class="odd">
<td>16</td>
<td></td>
<td>recursive_coverpage_state</td>
<td>None</td>
<td></td>
</tr>
<tr class="even">
<td>17</td>
<td>ハーベスト公開</td>
<td>harvest_public_state</td>
<td>true</td>
<td></td>
</tr>
<tr class="odd">
<td>18</td>
<td>ONLINE_ISSN</td>
<td>online_issn</td>
<td>None</td>
<td></td>
</tr>
<tr class="even">
<td>19</td>
<td></td>
<td>biblio_flag</td>
<td>None</td>
<td></td>
</tr>
<tr class="odd">
<td>20</td>
<td>閲覧権限</td>
<td>browsing_role</td>
<td>3,-98,-99</td>
<td>ロールID</td>
</tr>
<tr class="even">
<td>21</td>
<td></td>
<td>recursive_browsing_role</td>
<td>false</td>
<td></td>
</tr>
<tr class="odd">
<td>22</td>
<td></td>
<td>browsing_group</td>
<td>(現在存在するすべてのグループを許可)</td>
<td></td>
</tr>
<tr class="even">
<td>23</td>
<td></td>
<td>recursive_browsing_group</td>
<td>false</td>
<td></td>
</tr>
<tr class="odd">
<td>24</td>
<td>投稿権限</td>
<td>contribute_role</td>
<td>1,2,3,4,-98,-99</td>
<td></td>
</tr>
<tr class="even">
<td>25</td>
<td></td>
<td>recursive_contribute_role</td>
<td>false</td>
<td></td>
</tr>
<tr class="odd">
<td>26</td>
<td></td>
<td>contribute_group</td>
<td>(現在存在するすべてのグループを許可)</td>
<td></td>
</tr>
<tr class="even">
<td>27</td>
<td></td>
<td>recursive_contribute_group</td>
<td>false</td>
<td></td>
</tr>
<tr class="odd">
<td>28</td>
<td>表示形式</td>
<td>display_format</td>
<td>1(一覧形式を表す)</td>
<td><p>1:一覧形式</p>
<p>2:目次形式</p></td>
</tr>
<tr class="even">
<td>29</td>
<td>サムネイル</td>
<td>image_name</td>
<td>None</td>
<td>値に入るのはサムネイル画像のパスを表す文字列</td>
</tr>
</tbody>
</table>

  - インデックス編集について
    
      - 【Administration \> インデックスツリー管理(Index Tree) \> ツリー編集（Edit Tree）】画面にてインデックスを編集後、「送信」ボタンを押下することでweko\_index\_tree.rest.putメソッドを呼び出し、同フォルダのapi.pyのupdateメソッドでテーブルを更新する。それによって編集した箇所が上記の表の対応するテーブルキーでindexテーブルの値を更新する。
    
      - なおweko\_index\_tree.api.updateメソッド実行時、表の\#8,16,21,23,25,27がtrueの場合、それに対応するメソッドが呼び出される。それによって対応する設定が編集されたインデックスの子以下で同じように適用され、indexテーブルを更新する。

  - インデックス削除について
    
      - 【Administration \> インデックスツリー管理(Index Tree) \> ツリー編集（Edit Tree）】画面にてインデックスを選択後、「削除」ボタンを押し、ポップアップの選択肢「すべて削除」を押下する。この操作によってweko\_index\_tree.rest.deleteにて同フォルダのutil.pyのperform\_delete\_indexメソッドが呼び出される。このメソッドによってindexテーブルから該当インデックスとその子インデックスを削除する。

  - インデックス移動について
    
      - 【Administration \> インデックスツリー管理(Index Tree) \> ツリー編集（Edit Tree）】画面にてインデックスをドラッグアンドドロップすることで親インデックスの変更、または表示する順番の変更ができる。その変更をした際に、weko\_index\_tree.rest.putメソッドにて同フォルダのapi.pyのmoveメソッドが呼び出される。このメソッドによってindexテーブルのキー「parent」、「position」の値を変更する。

  - キャッシュについて
    
      - インデックスを作成、編集、削除、移動した際に、weko\_index\_tree.utils.save\_index\_trees\_to\_redisメソッドを用いて、インデックスツリーの日英の親子関係をredisに保存している。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>
### 雑誌情報

  - > 目的・用途

本機能は、インデックスの雑誌情報を管理（追加・編集・削除）、エクスポート時の出力を設定する機能である

  - > 利用方法

1\. システム管理者、リポジトリ管理者でログインする。

2\. 【Administration \> インデックスツリー管理(Index Tree) \> ツリー編集(Edit Tree)】で編集するインデックスツリーを選ぶ。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>〇</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

1 インデックスの雑誌情報を追加する

  - 【Administration \> 設定(Setting) \> 雑誌情報(Index Journal)画面】でのインデックスツリーにインデックスを選択した状態でインデックスの雑誌情報が設定できる。
    
      - 「Root Index」を選択している場合、右の「ジャーナル」エリアが非活性となる。
    
      - エクスポート時の出力の設定エリアを設ける
        
          - 「ジャーナル(Journal)」エリアに、「Output」/「Do not output」ラジオボタンで設定できる。初期値は「Do not output」である
            
              - 「Output」を選択した場合、設定されたインデックスの雑誌情報を表示する。
            
              - 「Do not output」を選択した場合、すでに登録済みの情報があればデータはそのまま保持して画面表示を非表示とする。
    
      - 雑誌情報の項目は以下の通りである

| \# | 項目(英語)                                  | 項目(日本語)                | KBART項目名                          | 入力必須 | 入力インターフェース |
| -- | --------------------------------------- | ---------------------- | --------------------------------- | ---- | ---------- |
| 1  | Title                                   | タイトル                   | publication\_title                | ※    |            |
| 2  | Print-format identifier                 | プリント版ISSN/プリント版ISBN    | print\_identifier                 |      |            |
| 3  | Online-format identifier                | eISSN/eISBN            | online\_identifier                |      |            |
| 4  | Date of first issue available online    | 最古オンライン巻号の出版年月日        | date\_first\_issue\_online        | ※    | カレンダー入力    |
| 5  | Number of first volume available online | 提供最古巻                  | num\_first\_vol\_online           |      |            |
| 6  | Number of first issue available online  | 提供最古号                  | num\_first\_issue\_online         |      |            |
| 7  | Date of last issue available online     | 最新オンライン巻号の出版年月日        | date\_last\_issue\_online         |      | カレンダー入力    |
| 8  | Number of last volume available online  | 提供最新巻                  | num\_last\_vol\_online            |      |            |
| 9  | Number of last issue available online   | 提供最新号                  | num\_last\_issue\_online          |      |            |
| 10 | Embargo information                     | エンバーゴ情報                | embargo\_info                     |      |            |
| 11 | Coverage depth                          | カバー範囲                  | coverage\_depth                   | ※    | プルダウン入力    |
| 12 | Coverage notes                          | カバー範囲に関する注記            | coverage\_notes                   |      |            |
| 13 | Publisher name                          | 出版者                    | publisher\_name                   |      |            |
| 14 | Publication type                        | 資料種別                   | publication\_type                 | ※    | プルダウン入力    |
| 15 | Parent publication identifier           | シリーズのタイトルID            | parent\_publication\_title\_id    |      |            |
| 16 | Preceding publication identifier        | 変遷前誌のタイトルID            | preceding\_publication\_title\_id |      |            |
| 17 | Access type                             | アクセスモデル                | access\_type                      | ※    | プルダウン入力    |
| 18 | Language                                | 言語                     | language                          | ※    | プルダウン入力    |
| 19 | Title alternative                       | その他のタイトル（他の言語でのタイトルなど） | title\_alternative                |      |            |
| 20 | Title transcription                     | タイトルヨミ                 | title\_transcription              |      |            |
| 21 | NCID                                    | NCID                   | ncid                              |      |            |
| 22 | NDL Call No.                            | NDL請求記号                | ndl\_callno                       |      |            |
| 23 | NDL Bibliographic ID                    | NDL書誌ID                | ndl\_bibid                        |      |            |
| 24 | J-STAGE CDJOURNAL                       | J-STAGE資料コード（雑誌名の略称）   | jstage\_code                      |      |            |
| 25 | Ichushi Code                            | 医中誌ジャーナルコード            | ichushi\_code                     |      |            |

  - 入力項目の入力仕様は、  
    バリデーション仕様は、別紙「WEKO\_KBART出力項目一覧\_v1.17.xlsx」の\[ 型/入力制限 \]\[ データ長 \]\[ 備考 \]欄の記載に従う。

  - 入力項目にはバリデーション機能を用意する。  
    バリデーション仕様は、WEKO\_KBART出力項目一覧\_v1.17.xlsx の\[ 型/入力制限 \]欄の記載に従う

  - 入力必須の項目は、入力項目名に ※ を表示する。

  - 入力項目の確定は、「保存」（Save）ボタンを押すことで行う。

  - 「保存」（Save）ボタン押下時に、バリデーションチェックを行い、  
    チェックエラーがあった場合は、エラーメッセージを該当項目の直下に赤文字で表示して登録処理を中断する。

  - 追加されたインデックスの雑誌情報の表示について、 [USER-2-1 一覧形式表示](#一覧形式表示)を参照してください

入力項目のエラーチェックについては以下を参照すること  
<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-indextree-journal/weko_indextree_journal/schemas/jsonschema.json>

  - > 関連モジュール

<!-- end list -->

  - > weko-indextree-journal

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 雑誌情報画面の表示
    
      - 【Administration\>インデックスツリー管理\>雑誌情報】画面を開き、インデックスを選択する。この操作によって、weko\_indextree\_journal.admin.indexメソッドが呼び出される。メソッド内でget\_journal\_by\_index\_idを呼び出し、journalテーブルより雑誌情報を取得した後、indexメソッドによって編集画面を表示する。

  - 雑誌情報を作成する
    
      - 雑誌情報画面にてインデックスに対して「ジャーナル」エリアのoutputを選び、雑誌情報を初めて保存する。この操作によって、weko\_indextree\_journal.rest.postメソッドにて同フォルダのapi.pyのcreateメソッドを呼び出し、設定した雑誌情報をjournalテーブルに保存する。

  - 雑誌情報を更新する
    
      - 雑誌情報画面にて開いたインデックスが既にjournalテーブルで雑誌情報を持っている場合に雑誌情報を保存する。この操作によって、weko\_indextree\_journal.rest.putメソッドにて同フォルダのapi.pyのupdateメソッドを呼び出し、編集した雑誌情報をjournalテーブルに保存する。

  - 雑誌情報を削除する
    
      - 該当する機能のソースコードはweko\_indextree\_journal.rest.deleteメソッドで存在する。しかし、雑誌情報管理画面上ではその機能を実行することはできない。  
        代わりにインデックスを削除したとき、そのインデックスの雑誌情報をjournalテーブルから削除することができる。

  - バリデーションチェックについて
    
      - 雑誌情報画面にてインデックスを開いた際に、weko\_indextree\_journal.admin.get\_json\_schemaが呼び出され、weko\_indextree\_journal.schemas.jsonschemaの情報をページ上に渡す。  
        その情報のパターンにあっているかでバリデーションチェックを行っている。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### カスタムソート

  - > 目的・用途

本機能は、インデックスに属するアイテムの表示順序を設定する機能である。

  - > 利用方法

1\. システム管理者、リポジトリ管理者でログインする。

2\. 【Administration \> インデックスツリー管理(Index Tree) \> カスタムソート(Custom Sort)画面】を開き、編集したいインデックスを選び、編集する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>〇</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【Administration \> インデックスツリー管理(Index Tree) \> カスタムソート(Custom Sort)画面】にインデックスに属するアイテムの表示順序を設定できる。
    
      - 「インデックスツリー」（Index Tree）エリアから設定するインデックスを選択すると、選択しているインデックスに属するアイテムが「ターゲットインデックス」（Target Index）に表示される。
    
      - 「編集」（Edit）ボタンを押すことで、アイテムの表示順序を設定できる。
    
      - 「Display Priority」に各アイテムに表示順序を入力する。
        
          - 数字のみ(全角を許容)を入力可能とする。不正な文字を入力する場合、入力した文字が保存されない。
    
      - 表示順が指定されないアイテムについては、表示順序が指定されたアイテムの後に表示される。
    
      - 検索結果の「アイテムリスト」エリアで、「表示順」プルダウンで「Custom」を選択すると、カスタムソートの設定が適用された並び順になる。
        
          - なお、「custom」の際の優先順位としては以下のルールがある。
            
              - 昇順(asc)、降順(desc)の基準値はカスタムソートの値である。
            
              - カスタムソートの値が存在するアイテムは存在しないアイテムよりも優先される。
            
              - カスタムソートの値が存在しないアイテムは作成日時の並び順になる。

<!-- end list -->

  - > 関連モジュール

> weko\_index\_tree
> 
> weko\_search\_ui
> 
> weko\_theme

  - > 処理概要

> カスタムソート編集画面表示について

  - > 【Administration \> インデックスツリー管理(Index Tree) \> カスタムソート(Custom Sort)画面】を開いた際、weko\_search.ui.admin.ItemManagementCustomSort.indexが呼び出される。それによってインデックスツリーを表示する。次に「インデックスツリー」エリアから編集したいインデックスを選ぶ。この操作によってweko\_search\_ui.admin.ItemManagementBulkSeach.indexが呼び出され、選択されたインデックスに属するアイテム一覧と順番を入力するテキストボックスを非活性状態で「対象インデックス」エリアに表示する。

> カスタムソート編集について

  - > 「対象インデックス」にて編集ボタンを押下すると、「Display Priority」列のテキストボックス全てが活性化し、入力可能になる。並び替えを指定したいテキストボックスに表示順位を入力し、保存ボタンを押下する。そのとき、weko\_search\_ui.static.js.weko\_serach\_ui.app.searchResCtrl.itemManagementSaveが動き、weko\_search\_ui.admin.ItemManagementCustomSort.save\_sortメソッドが呼び出される。これによってset\_item\_sort\_customメソッドが呼び出され、編集したカスタムソートの順番をindexテーブルのキーitem\_custom\_sortの値に保存する。

  - > 数字(半角、全角許容)以外の文字を入力した場合、set\_item\_sort\_customでNoneと変換され、そのアイテムのカスタムソート設定はなくなる。

> 検索結果にてカスタムソートを選んだ際の処理

  - > .query.pyにてget\_custom\_sortメソッドが呼び出され、Elasticsearch用のscriptを作成し、それをElastcsearchインスタンスに渡すことで、カスタムソートの設定どおりに検索結果をソートする。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2024/04/14</p>
</blockquote></td>
<td>cd0183f59a16928be2511e33e4495a3376f143c9</td>
<td>v1.0.6</td>
</tr>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>

### ウィジェット

<!-- end list -->

  - > 目的・用途

本機能は、ページレイアウトで利用するウィジェットを作成・編集・削除する機能である。

  - > 利用方法

【Administration \> ウェブデザイン管理（Web Design） \> ウィジェット（Widget）画面】で各リポジトリにウィジェットを作成・編集・削除する

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

1\. 概要

  - ウィジェットは、WEKO3に表示する内容を多言語で設定できる

  - 画面上の操作によって、コーディングを行わなくてもウィジェットのHTMLおよびScriptの編集ができる機能である

2\. ウィジェット一覧を表示する

  - 【ウィジェット（Widget）画面】には以下のタブが表示される
    
      - 一覧（List）
    
      - 作成（Create）
    
      - フィルターを追加▼（Add Filter▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 選択▼（With selected▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 編集（Edit）
        
          - > 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示
    
      - 詳細（Details）
        
          - > 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示

  - 【ウィジェット（Widget）画面】の一覧タブにウィジェット一覧を表示する
    
      - 表示項目は以下の通りである
        
          - チェックボックス
        
          - アクション（作成・編集・削除を表すアイコン）
        
          - 「ID」：ウィジェットID
        
          - 「Repository」：属するリポジトリ名
        
          - 「Widget Type」：ウィジェットタイプ
        
          - 「Label」：ウィジェット名
        
          - 「Enable」：ウィジェットの状態
    
      - ［フィルターを追加▼（Add Filter▼）］ボタンをクリックすると、以下の追加可能なフィルターリストを表示し、フィルター名をクリックすると当該フィルターの入力エリアを追加する
        
          - フィルター名
            
              - 「ID」
            
              - > フィルター方式の選択肢：等しい、等しくない、より大きい、より小さい、空、一覧にある、一覧にない
            
              - > 入力された数字を使い、選択したフィルター方式で絞り込む
            
              - 「Repository」
            
              - > フィルター方式の選択肢：含む（contains）、含まれていません（not contains）、等しい（equals）、等しくない（not equal）、空（empty）、一覧にある（in list）、一覧にない（not in list）
            
              - > 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Widget Type」
            
              - > フィルター方式の選択肢：「Repository」と同じである
            
              - > 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Enable」
            
              - > フィルター方式の選択肢：等しい（equals）、等しくない（not equal）
            
              - > 入力エリアではなく選択肢「はい」「いいえ」を使い、「はい」なら有効なウィジェット、「いいえ」ならそうでないウィジェットを絞り込む
        
          - 設定したフィルターは［適用（Apply）］ボタンを押下することで一覧に適用される
        
          - ［フィルターをリセット（Reset filter）］ボタンを押下すると、設定したフィルターがリセットされる
    
      - ［選択▼（With selected▼）］ボタンをクリックすると、以下の追加可能な機能（現在削除ボタンのみ）を表示する
        
          - レコードにチェックを入れない場合、「削除」（Delete）ボタンを押すと、エラーメッセージを表示する  
            メッセージ：  
            　日本語：「少なくとも１つのレコードを選択してください。」  
            　英語：「Please select at least one record.」
        
          - レコードにチェックを入れる場合、［削除（Delete）］ボタンを押すと、確認ダイアログを表示する  
            メッセージ：  
            　日本語：「選択したレコードを削除してもよろしいですか。」  
            　英語：「Are you sure you want to delete selected records?」
            
              - ［OK］ボタンを押すと、該当レコードを削除し、メッセージを画面上部に表示する  
                メッセージ：  
                　日本語：「レコード数＋レコードが正常に削除されました。」  
                　英語：「Record was successfully deleted.」
            
              - ［キャンセル（Cancel）］ボタンを押すと、確認ダイアログを閉じる
    
      - 検索テキストボックスでロールを検索する  
        プレースホルダー：「Search」
        
          - 任意テキストを入力し、キーボードでの「Enter」を押すと、Id、リポジトリ名、ウィジェットタイプでの検索を行う
        
          - テキストボックスの右端での［X］ボタンを押すと、検索条件がクリアーされる
    
      - ウィジェット行の目アイコンを押すと、該当ウィジェットの詳細情報を「詳細」（Details）タブに表示する
        
          - 「移動」（Filter）テキストボックスにテキストを入力すると、入力値が項目名またはその値に含まれている項目に絞り込んで表示する
    
      - ウィジェット行の鉛筆アイコンを押すと、該当ウィジェットを「編集」（Edit）タブに表示し、ウィジェットの情報が編集できる
        
          - 編集中はそのウィジェットがロックされる
            
              - 一覧タブで、他のユーザーにロックされたウィジェットの鉛筆アイコンを押した場合、ロック解除の確認ダイアログを表示する  
                メッセージ：  
                日本語：「このウイジェットのロックを解除してよろしいでしょうか。」  
                英語：「Do you wan to unlock this widget?」
                
                  - ［OK］ボタンを押すと、操作中のユーザーによって該当ウィジェットをロックして、「編集」（Edit）タブを表示する
                    
                      - もともとロックしていた方の画面は変化しない
                
                  - ［閉じる］ボタンを押すと、確認ダイアログを閉じる
                    
                      - そうした場合、空白の「編集」（Edit）タブが表示される
            
              - ロックしている側の画面で［Save］［キャンセル（Cancel）］ボタンを押した場合、ロックが解除されて他のユーザーからも保存できるようになる
                
                  - 「編集」（Edit）タブの表示中に、ログアウトや他の画面への遷移を行った場合には、ロックは解除されない
                
                  - 「編集」（Edit）タブの表示中にウェブブラウザのタブを閉じた場合には、ロックが解除されず、同一のユーザーで同じウィジェットの「編集」（Edit）タブを表示した場合でも、他のユーザーにロックされた場合と同様にロック解除の確認ダイアログを表示する
        
          - ［Save］ボタンを押すと、編集内容が保存される
            
              - widget\_items、widget\_multi\_lang\_dataテーブルが更新される
            
              - ウィジェットが他のユーザーにロックされていた場合は、保存されずに以下のエラーメッセージがポップアップで表示される  
                メッセージ：「Widget is locked by another user.」
            
              - ロックして「編集」（Edit）タブで操作しているウィジェットが他のユーザーによって削除された場合に、ロックしているユーザーが削除後に保存すると、削除されなかったかのように保存される
        
          - ［Delete］ボタンを押すと、確認ダイアログを表示する  
            メッセージ：「Are you sure to delete this widget Item?」
            
              - ［OK］ボタンを押すと、ロックを無視して該当ウィジェットを削除し、メッセージをポップアップで表示する  
                メッセージ：「Widget item has deleted successfully.」
                
                  - 他のタブに移動しない。削除した後に［Save］ボタンを押すと削除されなかったかのように保存される
            
              - ［キャンセル（Cancel）］ボタンを押すと、確認ダイアログを閉じる
            
              - 該当ウィジェットがページレイアウトで使用されていた場合は、削除せずにエラーメッセージをポップアップで表示する  
                メッセージ：「Cannot delete this widget because it's setting in Widget Design.」
        
          - ［Cancel］ボタンを押すと、一覧タブに戻る
    
      - 「詳細」（Details）タブと「編集」（Edit）タブとは互いに行き来できる
    
      - ウィジェット行のごみ箱アイコンを押すと、ロックを無視して該当ウィジェットを削除し、メッセージを画面上部に表示する  
        メッセージ：  
        　日本語：「レコード数＋レコードが正常に削除されました。」  
        　英語：「Record was successfully deleted.」
        
          - 該当ウィジェットがページレイアウトで使用されていた場合は、削除せずにエラーメッセージをポップアップで表示する  
            メッセージ：「Cannot delete this widget because it's setting in Widget Design.」

<!-- end list -->

  - 「一覧」（List）から「作成」（Create）タブを押すと、「作成」（Create）タブに移動し、ウィジェットを新規作成できる

  - **共通の入力項目**
    
      - 「Repository」：システムでのリポジトリを選択する
        
          - 必須項目とする
    
      - 「Type」：ウィジェット種別を設定する
        
          - 必須項目とする
        
          - ウィジェット種別は以下の通りである
            
              - Free description
            
              - Access counter
            
              - Notice
            
              - New arrivals
            
              - Main contents
            
              - Menu
            
              - Header
            
              - Footer
    
      - 「Language」：ウィジェットの設定言語を選択する
        
          - 必須項目とする
        
          - 選択肢：【Administration \> 設定（Setting） \> 言語表示（Language）画面】に表示されるものと同じ言語を使用する
        
          - 表示順序について、【言語表示（Language）画面】での「登録言語」の言語を一覧の上部に表示し、「対応言語」の言語一覧を次に表示する
    
      - 「Name」：ウィジェット名を設定する
        
          - 必須項目とする
    
      - 「Theme」：枠や枠線といったWidgetのスタイルテンプレートを指定する
    
      - 「Label Enable」：ラベルの表示制御を設定する
        
          - デフォルトはチェック有りとする
    
      - 「Label Color」ラベルの背景色を設定する
        
          - 「Label Enable」がチェックなしの場合は無効になる
    
      - 「Label Text Color」：ラベルの文字色を設定する
        
          - 「Label Enable」がチェックなしの場合は無効になる
    
      - 「Border Style」：Widgetの枠線のスタイルを選択する
    
      - 3つの種類：実線、点線、二重線
    
      - 「Border Color」：Widgetの枠線の色を指定する
    
      - 「Background Color」：Widgetの背景色を指定する
    
      - 「Enable」：ウィジェット内容の表示/非表示を設定する
        
          - デフォルトはチェック有りとする

  - **テーマ（Theme）について**  
    現在3つのテーマを以下のように対応している
    
      - Default  
        枠は角丸である。枠線あり。影あり
    
      - Simple  
        枠は四角である。左枠線のみ。影なし
    
      - Side Line  
        枠は四角である。枠線なし。影なし
    
      - テーマの表示は以下になる

<table>
<thead>
<tr class="header">
<th><strong>テーマ</strong></th>
<th><strong>イメージ</strong></th>
<th><strong>メモ</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Default</td>
<td><img src="media/media/image3.png" style="width:1.29167in;height:0.46875in" /></td>
<td>現在のデフォルト(メインのデザイン)<br />
角丸。枠線あり。影あり。</td>
</tr>
<tr class="even">
<td>Side Line</td>
<td><img src="media/media/image3.png" style="width:1.27083in;height:0.44792in" /></td>
<td>四角。左枠線のみ。影なし。</td>
</tr>
<tr class="odd">
<td>Simple</td>
<td><img src="media/media/image3.png" style="width:1.22917in;height:0.42708in" /></td>
<td>四角。枠線なし。影なし。</td>
</tr>
</tbody>
</table>

  - 各種ウィジェットでの入力項目
    
      - **Free description**
        
          - 概要  
            自由記述コンテンツを表示するウィジェットである
        
          - 機能  
            WYSIWYGエディタである
            
              - HTMLを直に編集可能
            
              - Scriptが編集可能
            
              - 画像にリンクを貼り付け可能／解除可能
            
              - 文字にリンクを貼り付け可能／解除可能
            
              - ヘッダをフォーマット可能
            
              - フォントを選択可能
            
              - サイズを変更可能
            
              - 文字を装飾可能
            
              - 配置を変更可能
            
              - 箇条書き可能
            
              - リンクのアンダーラインを解除可能
            
              - プレビュー可能
            
              - ファイルのアップロード可能（挿入リンクは相対パス）
    
      - **Access counter**
        
          - 概要  
            アクセスカウンタを表示するウィジェットである
        
          - 機能
            
              - 「Access counter initial value」：アクセスカウンタ値の初期値を指定する  
                デフォルト：0
            
              - 「Preceding message」：アクセスカウンタ値前のメッセージを設定する
            
              - 「Following message」：アクセスカウンタ値後のメッセージを設定する
            
              - 「Other message to display」：他のメッセージを設定する
            
              - 以下のイメージはアクセスカウンタのサンプルである

| **設定**                      | **表示**                      |
| --------------------------- | --------------------------- |
| ![](media/media/image4.png) | ![](media/media/image5.png) |

  - **Notice**
    
      - 概要  
        お知らせを一覧表示するウィジェットである
    
      - 機能  
        WYSIWYGエディタをである
        
          - 「自由記述」にお知らせ内容を設定可能とする  
            （「Free Description」部分のような機能がある）
        
          - お知らせ内容の全表示/部分表示を設定可能とする
            
              - 「Write More」チェックボックスにチェックを入れると、追加でお知らせの自由記述エリアを表示する
            
              - 「Read more」テキストボックス：続きを読むリンク名を指定する
            
              - 「Hide the rest」テキストボックス：続きを隠すリンク名を指定する

  - **New arrivals**
    
      - 概要
        
          - ウィジェット表示は、 公開日から指定された日数(新着日数)までのアイテム を公開日順(降順)に一覧表示する
            
              - 同一公開日の場合はタイトルの文字コードを第2の条件としてソートする
        
          - 一覧表示されたアイテムは、アクセスユーザが閲覧可能なものとする
        
          - 一覧表示されたアイテムは、アイテム詳細ページへのリンク表示とし、画面遷移可能とする
    
      - 機能
        
          - 「New date」テキストボックス：新着日数を設定する
            
              - 設定値は"Today,1,2,3,・・・30"の計31個のプルダウンとする
            
              - デフォルト値：5日
        
          - 「Display Results」テキストボックス：アイテム表示件数を設定する
            
              - 設定値は"5,10,20,50,100"の計5個のプルダウンとする
            
              - デフォルト値：5件
        
          - 「RSS feed」チェックボックス：RSS配信を設定する
            
              - デフォルト：チェックなし

  - **Main contents**
    
      - 概要
        
          - WEKO3のメイン画面は以下で構成されるものとする
            
              - ヘッダ部
            
              - メイン部(メニュータブ、アイテム検索、インデックスツリー、検索結果表示)
        
          - コンテンツ自体を編集できずに、コンテンツのラベル・テーマ・背景などしか編集できない

  - **Menu**
    
      - 概要  
        システムのページを表示するウィジェットである
    
      - 機能
        
          - 「Orientation」ラジオボタン：メニューの表示向きを設定する
            
              - 選択肢：「Horizontal」、「Vertical」
            
              - デフォルト：「Horizontal」
        
          - 「Background Color」：背景色を色の表から設定する
            
              - デフォルト色：白
        
        <!-- end list -->
        
          - 「Active Background Color」：アクティブ背景色を設定する
            
              - デフォルト色：白
        
          - 「Default Color」：テキスト色を設定する
            
              - デフォルト色：黒
        
          - 「Active Color」：アクティブテキスト色を設定する
            
              - デフォルト色：黒
        
          - 「Show/Hide Pages」エリア：メニューに表示するページを指定する
            
              - 設定対象は【ページレイアウト（Page Layout）画面】で作成したページ一覧とする
            
              - デフォルト：すべてページが「Show」エリアに表示する

  - **Header/Footer**
    
      - 概要  
        ヘッダ/フッタを表示するウィジェットである。  
        ヘッダエリアは固定のヘッダ行（言語切替，ログインボタン，サインアップボタンを表示するエリア）と、自由にカスタマイズできるエリアがある。
    
      - 機能
        
          - WYSIWYGエディタである（「Free Description」部分のような機能がある）
        
          - 固定のヘッダは既存のWidgetのHeader Widgetの中に含まれるものとする。位置はHeader Widgetの位置に従う
        
          - ヘッダWidgetで固定ヘッダの背景色・文字色は、「Fixed Header Background Color」と「Fixed Header Text Color」で設定できるものとする
        
          - 自由にカスタマイズできるエリアの背景色は、「Background Color」で設定できるものとする
        
          - 固定ヘッダの背景色・文字色のデフォルトカラーは背景は白、文字は灰色とする

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko-gridlayout

<!-- end list -->

  - > 処理概要

1\. 設定

> 表示言語設定に対応するウィジェットラベルを設定しない場合、ウィジェットラベルのデフォルトを設定する

  - パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-gridlayout/weko_gridlayout/config.py#L28>

  - 設定キー： 「WEKO\_GRIDLAYOUT\_DEFAULT\_WIDGET\_LABEL」

  - 現在の設定値：

> WEKO\_GRIDLAYOUT\_DEFAULT\_WIDGET\_LABEL = "No Title"
> 
> 表示言語設定に対応するウィジェットがない場合、ウィジェット言語のデフォルトを設定する

  - パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-gridlayout/weko_gridlayout/config.py#L31>

  - 設定キー： 「WEKO\_GRIDLAYOUT\_DEFAULT\_LANGUAGE\_CODE」

  - 現在の設定値：

> WEKO\_GRIDLAYOUT\_DEFAULT\_LANGUAGE\_CODE = "en"
> 
> 「New Arrivals」ウィジェット種類での「Display Results」のデフォルト値を設定する

  - パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-gridlayout/weko_gridlayout/config.py#L34>

  - 設定キー： 「WEKO\_GRIDLAYOUT\_DEFAULT\_DISPLAY\_RESULT」

  - 現在の設定値：

> WEKO\_GRIDLAYOUT\_DEFAULT\_DISPLAY\_RESULT = "5"
> 
> 「New Arrivals」ウィジェット種類での「New date」のデフォルト値を設定する

  - パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-gridlayout/weko_gridlayout/config.py#L37>

  - 設定キー： 「WEKO\_GRIDLAYOUT\_DEFAULT\_NEW\_DATE」

  - 現在の設定値：

> WEKO\_GRIDLAYOUT\_DEFAULT\_NEW\_DATE = "5"
> 
> 開発に使用しているウィジェット名を設定する

  - パス：
    
      - <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-gridlayout/weko_gridlayout/config.py#L40-L49>
    
      - <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-gridlayout/weko_gridlayout/config.py#L80>

  - 設定キー：
    
      - 「WEKO\_GRIDLAYOUT\_ACCESS\_COUNTER\_TYPE」
    
      - 「WEKO\_GRIDLAYOUT\_NEW\_ARRIVALS\_TYPE」
    
      - 「WEKO\_GRIDLAYOUT\_NOTICE\_TYPE」
    
      - 「WEKO\_GRIDLAYOUT\_MAIN\_TYPE」
    
      - 「WEKO\_GRIDLAYOUT\_MENU\_WIDGET\_TYPE」

  - 現在の設定値：

> WEKO\_GRIDLAYOUT\_ACCESS\_COUNTER\_TYPE = "Access counter"
> 
> WEKO\_GRIDLAYOUT\_NEW\_ARRIVALS\_TYPE = "New arrivals"
> 
> WEKO\_GRIDLAYOUT\_NOTICE\_TYPE = "Notice"
> 
> WEKO\_GRIDLAYOUT\_MAIN\_TYPE = "Main contents"
> 
> WEKO\_GRIDLAYOUT\_MENU\_WIDGET\_TYPE = 'Menu'

  - ウィジェットの高さの自動計算・不自動計算を設定する
    
      - パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-gridlayout/weko_gridlayout/config.py#L89>
    
      - 設定キー： 「WEKO\_GRIDLAYOUT\_AUTO\_ADJUST\_THE\_HEIGHT」
    
      - 現在の設定値：

> WEKO\_GRIDLAYOUT\_AUTO\_ADJUST\_THE\_HEIGHT = True

  - サーバから返却するウィジェットのデータを圧縮するかどうかを設定する
    
      - パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-gridlayout/weko_gridlayout/config.py#L95>
    
      - 設定キー：「WEKO\_GRIDLAYOUT\_IS\_COMPRESS\_WIDGET」
    
      - 現在の設定値：

> WEKO\_GRIDLAYOUT\_IS\_COMPRESS\_WIDGET = True

  - サーバから返却するウィジェットのデータの圧縮レベルを設定する
    
      - パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-gridlayout/weko_gridlayout/config.py#L92>
    
      - 設定キー：「WEKO\_GRIDLAYOUT\_COMPRESS\_LEVEL」
    
      - 現在の設定値：

> WEKO\_GRIDLAYOUT\_COMPRESS\_LEVEL = 6

  - サーバから返却するウィジェットデータのキャッシュ名を設定する
    
      - パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-gridlayout/weko_gridlayout/config.py#L98-L102>
    
      - 設定キー：
        
          - 「WEKO\_GRIDLAYOUT\_WIDGET\_CACHE\_KEY」
        
          - 「WEKO\_GRIDLAYOUT\_WIDGET\_PAGE\_CACHE\_KEY」
    
      - 現在の設定値：

> WEKO\_GRIDLAYOUT\_WIDGET\_CACHE\_KEY = "widget\_cache"
> 
> WEKO\_GRIDLAYOUT\_WIDGET\_PAGE\_CACHE\_KEY = "widget\_page\_cache"

  - ウィジェットに関するファイルアップロードのBucketIDを設定する
    
      - パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-gridlayout/weko_gridlayout/config.py#L104>
    
      - 設定キー：「WEKO\_GRIDLAYOUT\_BUCKET\_UUID」
    
      - 現在の設定値：

> WEKO\_GRIDLAYOUT\_BUCKET\_UUID = "517f7d98-ab2c-4736-91ea-54ba34e7905d"

  - 静的なウィジェットファイルサイズの上限を設定する
    
      - パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-gridlayout/weko_gridlayout/config.py#L107>
    
      - 設定キー：「WEKO\_GRIDLAYOUT\_FILE\_MAX\_SIZE」
    
      - 現在の設定値：

> WEKO\_GRIDLAYOUT\_FILE\_MAX\_SIZE = 1024 \* 1024 \* 16 \# 16 MB

2\. ウィジェットの実装方法

  - 対応しているライブラリ：
    
      - Trumbowyg（<https://alex-d.github.io/Trumbowyg/>）
        
          - 本ライブラリはウィジェットでのWYSIWYGエディタ機能を対応している
    
      - Gridstack.js（<https://gridstackjs.com/>）
        
          - トップページにてウィジェットデザインのレンダーを対応している

  - トップページにて、表示ページに関する特別なウィジェット設定があるかどうかチェックする
    
      - ウィジェット設定がない場合　=\> デフォルトとし「Main Layout」の設定を読み出し、gridstackJSでレイアウトをレンダーする
    
      - ウィジェット設定がある場合　=\> 該当するページの設定を読み出し、gridstackJSでレイアウトをレンダーする

  - ウィジェットの高さの自動計算
    
      - 概要的にスクロールバー高さの単位をgridstackライブラリでの単位に変換するのを行う方法である
    
      - ウィジェットをレンダーした上で、対象ウィジェットにスクロールバーが表示されるかどうかチェックする
        
          - スクロールバーが表示されない場合　（スクロールバーの高さ = ウィジェットの高さ）  
            　　=\> 変換を行わずに、ウィジェットを表示する
        
          - スクロールバーが表示される場合　（スクロールバーの高さ \> ウィジェットの高さ）  
            　　=\> スクロールバー高さの単位をgridstackライブラリでの単位に変換する（ピクセル→セルの変換）
    
      - その後、gridstackでのリサイズメソッドでウィジェットの高さを計算された値で更新する

  - **導入しているTrumbowygプラグイン**
    
      - Base64（<https://alex-d.github.io/Trumbowyg/demos/#plugins-base64>）
    
      - Colors（<https://alex-d.github.io/Trumbowyg/demos/#plugins-colors>）
    
      - Font family（<https://alex-d.github.io/Trumbowyg/demos/#plugins-fontfamily>）
    
      - Font size（<https://alex-d.github.io/Trumbowyg/demos/#plugins-fontsize>）
    
      - Paste image（<https://alex-d.github.io/Trumbowyg/demos/#plugins-pasteimage>）
    
      - Resizimg（<https://alex-d.github.io/Trumbowyg/demos/#plugins-resizimg>）
    
      - Table（<https://alex-d.github.io/Trumbowyg/documentation/plugins/#plugin-table>）

3\. 各種タブの操作

  - 画面表示、フィルターの操作、ウィジェット削除でウィジェット一覧を表示するときは、weko\_gridlayout.admin.WidgetSettingView.index\_viewメソッドで表示のためのウィジェット一覧を作成する

  - 目アイコンをクリックして「詳細」（Details）タブを表示するときは、WidgetSettingViewのdetails\_viewメソッドでウィジェットの詳細情報を取得する

  - 鉛筆アイコンをクリックして「編集」（Edit）タブを表示するときは、WidgetSettingViewのedit\_viewメソッドでウィジェットの情報を取得する
    
      - WidgetItemServices.get\_locked\_widget\_infoメソッドで、該当ウィジェットがロックされているか確認する
    
      - ロックされていなかった場合、ウィジェットをロックする

> lock\_key = WEKO\_GRIDLAYOUT\_WIDGET\_ITEM\_LOCK\_KEY.format(widget\_id)
> 
> session\[lock\_key\] = locked\_value

  - locked\_valueは、str(datetime.utcnow().timestamp())で作成する

  - widget\_itemsテーブルの該当ウィジェットについてのレコードで、「locked」をtrueにして、「locked\_by\_user」にロックしたユーザのidを記録する

<!-- end list -->

  - 編集（Edit）タブの［Save］ボタンでウィジェットを保存するときは、weko\_gridlayout.views. save\_widget\_itemメソッドの中で、WidgetItemServices.save\_commandメソッドから\_\_edit\_widgetメソッドを呼び出して保存する
    
      - widget\_itemsテーブルの該当ウィジェットについてのレコードを更新する
        
          - 「widget\_id」：該当ウィジェットのもの
        
          - 「repository\_id」：「Repository」プルダウンで選択したリポジトリのid
        
          - 「widget\_type」：「Type」プルダウンで選択したウィジェットタイプ
        
          - 「setings」：「Background Color」、「Fixed Header Background Color」、「Fixed Header Text Color」の設定
        
          - 「is\_enabled」：「Enable」がチェックされていればtrue、そうでなければfalse
    
      - widget\_multi\_lang\_dataテーブルの該当ウィジェットについてのレコードはすべて論理削除して、多言語設定があれば新たに言語ごとのレコードを作成する
        
          - 「id」：自動採番
        
          - 「widget\_id」：該当ウィジェットのもの
        
          - 「lang\_code」：設定した言語の言語コード
        
          - 「label」：該当ウィジェットで、その言語で設定した「Name」の入力値
        
          - 「description\_data」：ウィジェットタイプと設定内容に応じて、以下のようになる
            
              - ウィジェットタイプに固有の設定項目がない場合：null
            
              - ウィジェットタイプに固有の設定項目があり、設定されていない場合：{}
            
              - ウィジェットタイプに固有の設定項目があり、設定されている場合：その内容

  - ウィジェットを削除するときは、どの操作で削除するかによって呼び出されるメソッドが異なる
    
      - 一覧（List）タブのごみ箱アイコンでウィジェットを削除する場合、WidgetSettingViewのdelete\_modelメソッドの中で、WidgetItemServices.delete\_by\_idメソッドによって削除する
    
      - 編集（Edit）タブの［Delete］ボタンでウィジェットを削除する場合、weko\_gridlayout.views.delete\_widget\_itemメソッドの中で、WidgetItemServices.delete\_by\_idメソッドによって削除する
    
      - WidgetItemServices.delete\_by\_idメソッドでは、該当ウィジェットがページレイアウトに使用されているかどうかのチェックをWidgetDesignServices.is\_used\_in\_widget\_designメソッドによって行う
        
          - 使用されていた場合は、削除せずにメッセージを返す
        
          - 使用されていなければ、widget\_itemsテーブルとwidget\_multi\_lang\_dataテーブルから該当ウィジェットのレコードを論理削除する

  - 作成（Create）タブを表示するときは、WidgetSettingViewのcreate\_viewメソッドで作成タブのテンプレートを呼び出す

  - 作成（Create）タブの［Save］ボタンでウィジェットを保存するときは、weko\_gridlayout.views. save\_widget\_itemメソッドの中でWidgetItemServices.save\_commandメソッドからcreateメソッドを呼び出して保存する
    
      - widget\_itemsテーブルに、該当ウィジェットについてのレコードを作成する
    
      - 多言語設定があれば、widget\_multi\_lang\_dataテーブルに該当ウィジェットについてのレコードを作成する
    
      - それぞれの設定内容は、編集時と同様

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/11/11</p>
</blockquote></td>
<td>V0.9.27</td>
<td></td>
</tr>
</tbody>
</table>
### ページレイアウト

  - > 目的・用途

システムにて、各ページに作成されたウィジェットをデザインする機能である

  - > 利用方法

【Administration \> ウェブデザイン管理（Web Design） \> ページレイアウト（Page Layout）画面】：ページを管理（追加・編集・削除）し、 各リポジトリでのページごとにウィジェット位置を設定する

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

1\. リポジトリ毎にページ定義ができる

  - 【ページレイアウト（Page Layout）画面】に以下の表示項目を設ける
    
      - 「Repository」プルダウンリスト
        
          - 選択肢：システムに登録しているリポジトリ一覧である
    
      - 「Page」プルダウンリスト
        
          - 選択肢：選択しているリポジトリに属するページ一覧である
    
      - 「Widget List」エリア
        
          - 選択しているリポジトリに属するウィジェットが表示されるエリアである
    
      - 「Preview」エリア
        
          - 選択しているページにウィジェットを設定するエリアである

  - Pages領域にて、ページの追加・編集・削除ボタンを設ける
    
      - 「Main Layout」はデフォルトページとし、削除不可とする
        
          - デフォルトページは、リポジトリごとに存在する
        
          - 初期状態ではデータベース上に存在しないが、後述のページ編集ダイアログで保存することでwidget\_design\_pageテーブルにレコードが追加される
        
          - デフォルトページのみ、widget\_design\_pageテーブルでis\_main\_layoutフィールドがtrueである
    
      - 「+」ボタンを押すと、ページ追加のダイアログを表示する
        
          - 設定内容：
            
              - 「URL」：ページのURL
                
                  - 必須入力とする
                
                  - 入力欄には、初期値として「/」が入っている
                
                  - リポジトリごとにURLがユニークとなる
            
              - 「Title」  
                デフォルト値：「Page Title」
            
              - 言語プルダウンリスト
                
                  - 選択肢：【Administration \> 設定（Setting） \> 言語表示（Language）画面】に表示する言語を使用する
                
                  - 表示順序について、【言語表示（Language）画面】での「登録言語」の言語を一覧の上部に表示し、「対応言語」の言語一覧を次に表示する
        
          - ［Save］ボタンを押すと、入力内容をチェックする
            
              - チェックに問題がなければ、ページを追加して、メッセージを画面上部に表示する  
                メッセージ：「Successfully saved page.」
            
              - チェックに問題がある場合、エラーメッセージをモーダルダイアログの上部に表示する
                
                  - 「Repository」プルダウンリストで、初期状態の「Please select the Repository」を選択した状態である場合  
                    　エラーメッセージ：「Please select the repository.」
                
                  - 設定済みのURLを指定する場合  
                    　エラーメッセージ：「Unable to save page: URL already exists.」
                
                  - 入力値に「/」が含まれない場合  
                    　エラーメッセージ：「Not a valid URL.」
        
          - 「Close」ボタンを押すと、ページを追加せずにモーダルダイアログを閉じる
    
      - 鉛筆ボタンを押すと、ページ編集のダイアログを表示する
        
          - ページの情報を編集した後、［Save］ボタンを押すことで、ページの情報を更新できる
        
          - ［Close］ボタンを押すと、編集内容を反映せずにダイアログを閉じる
    
      - ゴミ箱ボタンを押すと、削除確認用のダイアログを表示する  
        確認内容：「Are you sure you want to delete the page?」  
        ※「Main Layout」ページは削除不可のため、ゴミ箱のアイコンを非表示とする
        
          - 「Submit」ボタンを押すと、該当ページを削除し、メッセージを表示する  
            メッセージ：「Successfully deleted page.」
        
          - 「Close」ボタンを押すと、モーダルダイアログを閉じる
    
      - 歯車ボタンを押すと、【ウィジェット（Widget）画面】を別ウィンドウで表示する
        
          - 【ウィジェット（Widget）画面】の詳細は[ADMIN-4-1: ウィジェット](\\l)を参照
        
          - 編集中のウィジェットはロックされる
            
              - ［Save］［Cancel］ボタンではなく［×］ボタンによって別ウィンドウを閉じた場合はロックが解除されず、再度表示した場合には、他のユーザーにロックされた場合と同様にロック解除の確認ダイアログを表示する
        
          - 【ウィジェット（Widget）画面】を別ウィンドウで表示している状態で、新たに同画面の別ウィンドウを表示する場合は、表示中の別ウィンドウで新たな【ウィジェット（Widget）画面】に遷移する
            
              - 別ウィンドウでは、ブラウザの操作によって遷移前に戻ることはできない
        
          - 【ウィジェット（Widget）画面】中で［Save］または［Cancel］ボタンを押すと、別ウィンドウは閉じる
        
          - 【ウィジェット（Widget）画面】中で［Delete］ボタンを押した場合は、別ウィンドウは閉じない
        
          - 「Widget List」「Preview」どちらからでも【ウィジェット（Widget）画面】を表示できる

  - ウィジェットデザインに以下の項目を表示する
    
      - 「Widget List」エリア：【Administration \> ウェブデザイン管理（Web Design） \> ウィジェット（Widget）画面】にて有効なウィジェットを表示する
        
          - 各ウィジェットに［Add Widget］ボタンを設ける。
        
          - > ボタンを押すと、該当ウィジェットが「Preview」エリアに追加される
    
      - 「Preview」エリア：ウィジェットの位置を整理する
        
          - ドラッグアンドドロップすることで、ウィジェットの位置を移動できる
        
          - ウィジェットの幅を変更できる
        
          - ウィジェットの高さを画面描画時は自動調整する
        
          - 各ウィジェットに［X］ボタンを設ける
        
          - > ボタンを押すと、「Preview」エリアからウィジェットを削除する
    
      - 注意事項
        
          - 「Main Contents」、「Header」、「Footer」はページ内に複数設定不可とする
        
          - 「Preview」エリアに追加された「Main Contents」、「Header」、「Footer」のウィジェットがある場合に、同じ種類のウィジェットの「Add Widget」ボタンを不活性化する
        
          - 「Main Contents」ウィジェットは、一つリポジトリに１つだけ設定できる
    
      - ［Save］ボタンを押すと、設定した内容をチェックする
        
          - 「Repository」プルダウンリストで、初期状態の「Please select the Repository」が選択されているときは、［Save］［Cancel］ボタンは非活性である
        
          - チェックに問題がなければ、設定内容を保存して、メッセージを画面上部に表示する  
            メッセージ：「Widget design has been saved successfully.」
        
          - チェックに問題がある場合、エラーメッセージを表示する
            
              - ［Main Contents］のウィジェットを複数ページに設定する場合  
                エラーメッセージ：「Failed to save design: Main contents may only be set to one layout.」
            
              - ページにウィジェットをひとつも配置していない場合  
                エラーメッセージ：「Please add Widget to Preview panel.」

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko-gridlayout

  - > 関連ライブラリ：Gridstack.js 0.2.7-dev（https://gridstackjs.com/）

<!-- end list -->

  - > 処理概要

> 画面表示時は、weko\_gridlayout.admin.WidgetDesign.indexメソッドにより、以下のコンフィグで定められたテンプレートを用いる。

  - > パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-gridlayout/weko_gridlayout/config.py#L20>

  - > 設定キー：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-gridlayout/weko_gridlayout/config.py#L20>

> 「Repository」プルダウンの選択を変更したとき、以下のメソッドが呼び出される。

  - > weko\_gridlayout.views. load\_widget\_list\_design\_settingメソッドの中で、widget\_itemsから選択したリポジトリに属するウィジェット群を、widget\_multi\_lang\_dataテーブルからそれらのウィジェットの多言語設定を、widget\_design\_settingテーブルから選択したリポジトリのデフォルトページに配置されたウィジェットの情報を取得する。

  - > weko\_gridlayout.views. load\_widget\_design\_pagesメソッドで、widget\_design\_pageテーブルから選択したリポジトリに属するページ群を取得する。

> 「Pages」プルダウンの選択を変更したとき、変更先によって異なるメソッドが呼び出される。

  - > デフォルトページに変更した場合は、o weko\_gridlayout.views.load\_widget\_design\_settingメソッドの中で、widget\_design\_settingテーブルからデフォルトページに配置されたウィジェットの情報を取得する。

  - > デフォルトページ以外に変更した場合は、weko\_gridlayout.views.load\_widget\_design\_page\_settingメソッドの中で、widget\_design\_pageテーブルからページに配置されたウィジェットの情報を取得する。

> 鉛筆アイコンを押してページ編集のダイアログを出すとき、weko\_gridlayout.views.load\_widget\_design\_pageメソッドが呼び出される。

  - > その中で呼ばれるweko\_gridlayout.services.WidgetDesignPageServices.get\_pageメソッドで、widget\_design\_pageテーブルから情報を取得する。
    
      - > 画面に表示しているのがデフォルトページで、テーブルに情報がなかった場合、デフォルトページの内容を以下の内容で作成して返す。
        
          - > 「title」：「Main Layout」
        
          - > 「url」：「/community=リポジトリ名」
        
          - > 「is\_main\_layout」：true

> ページ追加のダイアログで［Save］ボタンを押すと、widget.design.jsのvalidateInputメソッドによって入力内容のチェックを行う。

  - > URLの入力値は、以下のようにチェックする。

> if (\!/\\/\[a-z0-9?&/=\]\*/.test(this.state.url)) {
> 
> this.setState({'errorMessage': 'Not a valid URL.'});
> 
> return false;
> 
> }

  - > チェックを通過すると、weko\_gridlayout.views.save\_widget\_design\_pageメソッドが呼び出される。

  - > weko\_gridlayout.views.save\_widget\_design\_pageメソッドの中で、widget\_design\_pageテーブルでレコード作成または更新を行う。
    
      - > widget\_design\_pageテーブルの操作はweko\_gridlayout.models.WidgetDesignPage.create\_or\_updateメソッドで行う。
        
          - > 以下の内容で保存する。
            
              - > 「id」：作成時に自動採番
            
              - > 「title」：「Title」の入力値
            
              - > 「repository\_id」選択中のリポジトリのid
            
              - > 「is\_main\_layout」：ページ作成時はfalseを設定、そうでなければもともとの値
        
          - > このメソッド中で、多言語設定をwidget\_design\_page\_multi\_lang\_dataテーブルに保存する。

> ウィジェットデザインエリアは、Gridstack.js 0.2.7-devによって実装している。
> 
> ページ本体で［Save］ボタンを押すと、widget.design.jsのsaveWidgetDesignSettingメソッドでエラーチェックを行う。

  - > 以下のパスの部分でウィジェット配置情報を取得して、空だった場合はエラーメッセージ「Please add Widget to Preview panel.」を表示する。
    
      - > パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-gridlayout/weko_gridlayout/static/js/weko_gridlayout/widget.design.js#L1027-L1054>

  - > エラーがなければ、weko\_gridlayout.views. save\_widget\_layout\_settingメソッドがajaxで呼び出される。
    
      - > このメソッド中でweko\_gridlayout.services.WidgetDesignPageServices. update\_widget\_design\_settingメソッドを呼び出し、その中で以下のテーブルのレコードを作成または更新する。
        
          - > widget\_design\_page（デフォルトページ以外。更新のみ）
            
              - > 「settings」：「Preview」エリアのウィジェット配置情報
        
          - > widget\_design\_setting（デフォルトページ）
            
              - > 「repository\_id」：選択中のリポジトリのid
            
              - > 「settings」：「Preview」エリアのウィジェット配置情報

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### 編集
        
        1.  #### 著者名典拠

<!-- end list -->

  - > 目的・用途

本機能は、ユーザーが著者の追加・編集・削除・統合を行う機能である。

氏名やメールアドレスでの検索を可能とすることで、ユーザーが目的の著者に効率よくたどり着くことができる。

  - > 利用方法

【Administration\>著者DB管理（Author Management）\>編集（Edit）】の順で編集画面に遷移し、Author IDタブを押下する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

1 Author IDを参照する

  - 【Administration\>著者DB管理（Author Management）\>編集（Edit）】での「Author ID」タブに登録されているAuthor IDが表示される。
    
      - 表示項目は以下の通りである。
        
          - \[統合元（Origin」\]チェックボックス  
            マージ機能を使用する。
        
          - \[統合先（Target）\]ラジオボタン  
            マージ機能を使用する。
        
          - 「氏名（Name）」  
            登録されている氏名を表示する。氏名が複数登録されている場合、改行で表示する。
        
          - 「メールアドレス（Mail Address）」  
            登録されているメールアドレスを表示する。メールアドレスが複数登録されている場合、改行で表示する。
        
          - 「アイテム件数（Item Count）」  
            Author IDが作成者として登録されているアイテムの件数を表示する。
        
          - \[編集（Edit）\]ボタン  
            押下することで、編集画面へ遷移する。
    
      - Author ID検索エリアをAuthor ID一覧の上部に設ける
        
          - 検索テキストボックスに検索条件を入力して、\[検索（Search）\]ボタンを押すと、検索結果が表示される。
            
              - 検索方式：AND
            
              - 検索条件：姓、名、メールアドレス

> 検索結果が0件の場合は、以下のメッセージを Author IDの表示エリアに表示する。  
> 日本語：「検索結果は0件です。」  
> 英語：「Sorry，No results.」

  - 検索の仕様

> 　・ 漢字氏名の検索：　１文字から検索可能
> 
> 　・ カナ氏名の検索：　姓または名の完全一致
> 
> 　・ 英語氏名の検索：　姓または名の完全一致
> 
> 　・ メールアドレスの検索：　＠の前後の完全一致（＠は含めても可）、またはメールの完全一致
> 
> 　【データ例】
> 
> 　　　山田　太郎　　　(ja)
> 
> 　　　Yamada　Tarou　(en)
> 
> 　　　ヤマダ　タロウ　(ja-kana)
> 
> 　　　sample@test.co.jp　(Email)
> 
> 　　　　検索条件　：　検索可否
> 
> 　　　　山田　　　：　○
> 
> 　　　　山　　　　：　○
> 
> 　　　　田　　　　：　○
> 
> 　　　　太郎　　　：　○
> 
> 　　　　太　　　　：　○
> 
> 　　　　郎　　　　：　○
> 
> 　　　　山田太郎　：　○
> 
> 　　　　山田太　　：　○
> 
> 　　　　田太郎　　：　○
> 
> 　　　　田太　　　：　○
> 
> 　　　　山太　　　：　×
> 
> 　　　　ヤマダ　　：　○
> 
> 　　　　ヤマ　　　：　×
> 
> 　　　　マダ　　　：　×
> 
> 　　　　ヤ　　　　：　×
> 
> 　　　　タロウ　　：　○
> 
> 　　　　タロ　　　：　×
> 
> 　　　　ロウ　　　：　×
> 
> 　　　　タ　　　　：　×
> 
> 　　　　ヤマダタロウ：　×
> 
> 　　　　ヤマダ　タロウ：　○　　※半角または全角スペース含む場合
> 
> 　　　　ヤマダタロ：　×
> 
> 　　　　マダタロ　：　×
> 
> 　　　　やまだ　　：　×
> 
> 　　　　たろう　　：　×
> 
> 　　　　Yamada　：　○
> 
> 　　　　Tarou　　：　○
> 
> 　　　　Yam　　　：　×
> 
> 　　　　sample　　：　○
> 
> 　　　　sample@　：　○
> 
> 　　　　sam　　　：　×
> 
> 　　　　test.co.jp　：　○
> 
> 　　　　@test.co.jp　：　○
> 
> 　　　　test　　　　：　×
> 
> 　　　　sample@test.co.jp　：　○
> 
> 　　　　sample@test　：　×

  - Author ID一覧にページング機能を設ける。
    
      - ページ当たりの表示件数（Display Number）をプルダウンより選択できる。
        
          - 選択可能な件数は「25, 50, 100」でデフォルトは「25」とする。
    
      - ページングナビゲーションを操作することで、表示内容が切り替わる。

2 Author IDを追加する。

  - 【Administration\>著者DB管理（Author Management）\>編集（Edit）】での「Author ID」タブに\[著者追加（Add Author）\]ボタンを押すと、著者追加画面に移動する。
    
      - 入力項目は以下の通りである。
        
          - 「氏名」（Name）
            
              - 「セイ」「メイ」テキストボックス：著者の姓・名を入力する。
            
              - 言語：選択肢は「ja-Kana, ja, en,fr,it,de,es,zh-tw,ru,la,ms,eo,ar,el,ko」とする。
            
              - 「姓・名」（First and Last Name）：氏名の入力形式を選択する。
            
              - \[表示／非表示（Display/Hide）\]ラジオボタン
                
                  - 「表示」（Display）を選択すると、「著者DBから入力」（From author DB）機能で、氏名が自動入力される。
                
                  - 「非表示」（Hide）を選択すると、［著者DBから入力］（From author DB）機能で、氏名が自動入力されない。
            
              - \[+著作項目を追加（Add author item）\]ボタンを押すことで、氏名の入力欄が追加される。
            
              - \[X\]ボタンを押すことで、氏名の入力欄が削除される。  
                表示されている入力エリアが１つのみの場合、削除不可とする。
        
          - 「著者ID」（Author ID）
            
              - 外部著者プルダウン：著者の外部著者を選択する。  
                「ID Prefix」画面で登録されている外部著者IDから選択できる。
            
              - 外部著者IDテキストボックス：外部著者IDを入力する。  
                クリーンビルド環境の場合、初期に表示される選択肢は「ORCID, CiNii, KAKEN2,ROR」とする。
            
              - 「ID Prefix」画面にはリスト上に "WEKO" が存在する(WEKO3で著者を一意に決定するWEKO著者ID)が、「著者ID」のプルダウンのリストには表示されない。  
                "WEKO"は著者登録時に自動付番(初期値のWEKO著者IDは1, 以降は2, 3, ...と付番されている max(authors.id)＋１)される。
            
              - \[確認（Confirm）\]ボタンを押すと、選択された外部著者IDに応じたランディングページが表示される。
                
                  - 別ウィンドウで表示させる。
                
                  - 著者IDを入力しない場合、「確認」（Confirm）ボタンが非活性とする。
                
                  - ランディングページのURLについて
                    
                      - 「ID Prefix」に設定されたURLに「\#\#」が含まれている場合、「\#\#」を著者IDに置換してURLとする。
                    
                      - 「ID Prefix」に設定されたURLに「\#\#」が含まれていない場合、そのまま設定されたURLとする。
            
              - \[表示／非表示（Display/Hide）\]ラジオボタン
                
                  - 「表示」（Display）を選択すると、「著者DBから入力」（From author DB）機能で、外部著者IDが自動入力される。
                
                  - 「非表示」（Hide）を選択すると、［著者DBから入力］（From author DB）機能で、外部著者IDが自動入力されない。
            
              - \[+著者IDを追加（Add a new ID）\]ボタンを押すことで、著者IDの入力欄が追加される。
            
              - \[X」ボタンを押すことで、著者IDの入力欄が削除される。  
                表示されている入力エリアが１つのみの場合、削除不可とする。
        
          - 「E-Mail」テキストボックス：メールアドレスを入力する。
            
              - \[+e-mailを追加（Add E-mail）\]ボタンを押すことで、メールアドレスの入力欄が追加される。
            
              - \[X」ボタンを押すことで、メールアドレスの入力欄が削除される。  
                表示されている入力エリアが１つのみの場合、削除不可とする。
    
      - \[取消（Clear）\]ボタンを押すと、入力した内容が取消される。
    
      - \[保存（Save）\]ボタンを押すと、Author IDが追加される。
        
          - ボタン押下後、WEKO著者IDを自動付番し、Author IDの一覧画面に遷移する。
        
          - 姓、名から姓名の情報（fullName）が生成される。
    
      - 追加をキャンセルしたい場合は、\[保存(Save)\]ボタンの押下前に他のタブを押下するなどして著者追加画面から遷移させる必要がある。

3 Author IDを編集・削除する。

  - Author ID一覧に\[編集（Edit）\]ボタンを押すと、Author IDの編集画面に移動する。
    
      - 設定された情報を表示する。
    
      - Author IDの情報を編集してから、\[保存（Save）\]ボタンを押すと、Author IDの情報が更新されて、Author ID一覧画面に移動する。
    
      - Author IDの編集画面に「削除」（Delete）ボタンを押すと、該当の著者が削除されて、Author ID一覧画面に移動する。
    
      - 編集時に外部著者IDの"WEKO"（WEKO著者ID）は編集することはできない（グレーアウトとする）。

  - 著者の削除について
    
      - 削除方式は論理削除とする。
    
      - 削除では、著者情報のテーブルに削除フラグのカラムを設けて、削除情報を管理する。
    
      - 紐づいているアイテムが１件以上存在する状態で\[削除（Delete）\]ボタンを押下すると、以下のポップアップメッセージを表示し、削除することができない。
        
          - 日本語：「アイテムがリンクしているため、指定された著者は削除できません。」
        
          - 英語：「The author is linked to items and cannot be deleted.」

4 Author IDをマージする。

  - Author IDのトップ画面に\[著者統合（Merge）\]ボタンを設ける。
    
      - 以下の場合に\[著者統合（Merge）\]ボタンを非活性とする。
        
          - 「Origin」チェックボックスにチェックを入れない。
        
          - 「Target」ラジオボタンにチェックを入れない。
        
          - 「Origin」チェックボックスと「Target」ラジオボタンに全く同じのレコードを選択する。
    
      - Author ID一覧からマージしたい著者を選択して、\[著者統合（Merge）\]ボタンを押すと、マージ確認画面がモーダル表示される。
        
          - マージ確認画面に表示内容を以下の通りである。
            
              - 「Origin」と「Target」エリアは別に分ける。
            
              - 各エリアに著者情報を表示する。
                
                  - 「氏名」（Name）
                
                  - 「メールアドレス」（Mail Address）
                
                  - 「アイテム件数」（Item Count）
        
          - 「Execute」ボタンを押すことで、著者マージを行って、マージ確認画面を閉じる。
            
              - 「Origin」に選択された著者を論理削除する  
                ※ 「Target」が「Origin」にある場合、該当著者を削除しない
            
              - 「Origin」に選択された著者に紐付いていたアイテムのWEKO著者IDと外部著者IDを「Target」に選択された著者の情報で更新する。
        
          - 「Back」ボタンを押すことで、マージ確認画面を閉じる。
        
          - マージ処理が終わるまで次のマージ処理はできない。
          
          - アイテム更新完了するまで、あるいはエラーが発生するまで、著者DBはコミットしない。

          - マージ状況は author_merge_status.tsv に出力される。



#### 関連モジュール

- weko-authors
- weko-angular/app-author-search
- weko-deposit

<!-- end list -->

  - > 処理概要

1\. 設定

  - 表示件数のデフォルト値を設定する
    
      - パス：  
        https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-authors/weko\_authors/config.py\#L204 
    
      - 設定キー：WEKO\_AUTHORS\_NUM\_OF\_PAGE
    
      - 現在の設定値：

> WEKO\_AUTHORS\_NUM\_OF\_PAGE = 25

  - Author ID一覧画面のテンプレートを設定する
    
      - パス：   
        https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-authors/weko\_authors/config.py\#L42
    
      - 設定キー：WEKO\_AUTHORS\_ADMIN\_LIST\_TEMPLATE
    
      - 現在の設定値：

> WEKO\_AUTHORS\_ADMIN\_LIST\_TEMPLATE = 'weko\_authors/admin/author\_list.html'

  - Author ID編集画面のテンプレートを設定する。
    
      - パス：   
        <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-authors/weko_authors/config.py#L45> 
    
      - 設定キー：WEKO\_AUTHORS\_ADMIN\_EDIT\_TEMPLATE
    
      - 現在の設定値：

> WEKO\_AUTHORS\_ADMIN\_EDIT\_TEMPLATE = 'weko\_authors/admin/author\_edit.html'

2\. 実装方法

  - nameIdentifiersでnameIdentifierScheme=WEKOを利用して当該アイテムに属性(author\_link)を追加する。  
    著者情報のアイテム件数（Item Count）は以下のようにクエリを作成し、"author\_link"毎に著者情報をカウントする。

> "size": 0,
> 
> "query": {
> 
> "bool": {
> 
> "must": \[
> 
> {
> 
> "match": {
> 
> "publish\_status": 0
> 
> }
> 
> },
> 
> {
> 
> "match": {
> 
> "relation\_version\_is\_last": "true"
> 
> }
> 
> },
> 
> {
> 
> "bool": {
> 
> "should": \[
> 
> {
> 
> "term": {
> 
> "author\_link.raw":
> 
> "@author\_id"
> 
> }
> 
> }
> 
> \]
> 
> }
> 
> }
> 
> \]
> 
> }
> 
> }

**3.処理内容**

  - > **【Administration\>著者DB管理（Author Management）\>編集（edit）】で開かれる編集画面は、初期状態としてweko\_authors.views.getが呼び出され、db内のauthorsテーブルからgather\_flgが0でかつis\_deleteにチェックがついていないものが取り出されて表示されている。**

  - > **著者追加ボタンを押すと著者追加画面へ遷移し、任意の項目を入力後に\[保存（Save）\]ボタン押下で、weko\_authors.views.createが呼び出され、db内のauthorテーブルに情報が追加される。このとき、同メソッド内でidは自動作番され、gather\_flgは０,is\_deleteはFalseの状態で追加される。**

  - > **著者追加時は、各々の項目に対して入力テキストボックスを追加することができる。  
    > それぞれのテキストボックスには以下のような初期値が、あらかじめ入力されている。**

<!-- end list -->

  - > **氏名→言語入力欄に「ja-Kana」**

  - > **著者ID→ID選択欄に「ORCID」(ただし、2項目目以降の追加時は「WEKO」が入力される。著者IDが「WEKO」のものは編集できないため、追加したテキストボックスは自動的に非活性となる。)**

  - > **所属機関識別子→機関識別子選択欄に「ISNI」。所属機関名の言語選択欄に「ja」**

  - > **\[表示/非表示（Display/Hide）\]チェックボタンは、初期値として\[表示（Display）\]にチェックが付いた状態となっている。**

<!-- end list -->

  - > **編集ボタンを押すと編集画面に遷移し、任意の項目を変更後に\[保存（Save）\]ボタン押下で、weko\_authors.views.update\_authorが呼び出され、エンコードされたのちにdb内のauthorテーブルに保存される。編集画面も追加時の画面と同様に、各々の項目に対してテキストボックスの追加が可能となっており、初期値も追加画面のものと同様になっている。**

  - > **著者の削除の際は、編集画面下部の\[削除（delete）\]ボタンを押下することで、weko\_authors.views.delete\_authorが呼び出され、選択した著者のdb内のis\_deleteカラムをTrueへ変更する。**

  - > **検索テキストボックスに、任意の文字列を入力し検索ボタンを押下すると、weko\_authors.views.getが呼び出され、同メソッド内のsearch\_keyに入力した文字列が代入され、検索が行われたのち、検索対象のみがauthorテーブルから取り出されて出力される。**

  - > **著者の統合時は、weko\_authors.views.gatherByIdが呼び出され、統合元(Origin)にチェックを入れた著者のauthorテーブル内のgather\_flgが1に変更される。また、統合の際にweko\_deposit.tasks.items\_by\_authorInfoが呼び出され、db内のitem\_metadataテーブルのjsonカラム内の、**統合元（Origin）に選択された著者に紐付いていたアイテムのWEKO著者IDと外部著者IDを統合先（Target）に選択された著者の情報で更新し、それに関連するES内のメタデータのマッピングの情報も更新する。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>

##   

#### ADMIN-5-1-3:Affiliation ID

  - > 目的・用途

本機能は、登録済みの所属機関識別子の編集や、新たな所属機関識別子を追加するための機能である。

  - > 利用方法

【Administration\>著者DB管理（Author Management）\>編集（Edit）】の順で編集画面に遷移し、Affiliation　IDタブを押下する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - > 【Administration\>著者DB管理（Author Management）\>編集（Edit）】でのAffiliation IDタブに登録されている所属機関識別子一覧が表示される。
    
      - 表示項目は以下の通りである。
        
          - 「所属機関識別子（Name）」：所属機関の名前が表示される。
        
          - 「IDスキーマ名（Scheme）」：所属機関のSchemeが表示される。
        
          - 「URL」：所属機関のURLが表示される。
        
          - 「コントロール（Control）」：コントロールのボタンが表示される。  
            コントロールのボタンは［編集（Edit）］、［追加（Add）］である。
    
      - クリーンビルド環境での初期設定値は以下の通りである。
        
          - ISNI (URL: <https://www.isni.org/>isni/\#\#)
        
          - GRID(URL: https://www.grid.ac/institutes/\#\#)
        
          - Ringgold
        
          - Kakenhi
    
      - \[追加（Add）\]ボタンを押すと、入力内容をチェックする。
        
          - 問題があれば、外部著者ID Prefixを追加せず、エラーメッセージを表示する。
            
              - 何かの項目を入力しない場合、またはURL形式が不正場合は以下のメッセージを表示する。  
                エラーメッセージ：「Please enter the correct ＋　項目名」
            
              - 設定されたSchemeを選択する場合は以下のメッセージを表示する。  
                エラーメッセージ：「Specified scheme is already exist.」
        
          - 問題なければ、外部著者ID Prefixを追加し、以下のメッセージを表示する。  
            メッセージ：「Successfully added」
    
      - \[編集（Edit）\]ボタンを押すと、該当のAffiliation ID情報を編集可能とし、コントロールのボタンを該当行の直下に表示する。  
        コントロールのボタン：\[保存 （Save）」、\[キャンセル（Cancel）\]、\[削除（Delete）\]
        
          - 該当の外部著者ID Prefix情報を編集してから、\[保存 （Save）\]ボタンを押すと、編集内容を保存し、以下のメッセージを表示する。  
            メッセージ：「Update completed」
        
          - \[削除（Delete）\]ボタンを押すと、該当の外部著者ID Prefixを削除し、以下のメッセージを表示する  
            メッセージ：「Successfully deleted」
        
          - \[キャンセル（Cancel）\]ボタンを押すと、編集前の状態に戻る。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko-authors

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - > IDスキーマ名（Scheme）プルダウンに表示するScheme一覧の設定をする。

<!-- end list -->

  - > パス：  
    > <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-authors/weko_authors/config.py#L32>

  - > 設定キー：WEKO\_AUTHORS\_AFFILIATION

  - > 現在の設定値：  
    > WEKO\_AUTHORS\_LIST\_SCHEME\_AFFILIATION = \['ISNI', 'GRID', 'Ringgold', 'kakenhi', 'Other'\]

<!-- end list -->

  - > 「Other」のインデックスを設定する。

<!-- end list -->

  - > パス：  
    > <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-authors/weko_authors/config.py#L36>

  - > 設定キー：WEKO\_AUTHORS\_IDENTIFIER\_ITEM\_OTHER

  - > 現在の設定値：  
    > WEKO\_AUTHORS\_AFFILIATION\_IDENTIFIER\_ITEM\_OTHER = 4

<!-- end list -->

  - > Affiliation ID画面のテンプレートを設定する。

<!-- end list -->

  - > パス：  
    > [https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-authors/weko\_authors/config.py\#L51](https://github.com/RCOSDP/weko/blob/0.9.22/modules/weko-authors/weko_authors/config.py#L51)

  - > 設定キー：WEKO\_AUTHORS\_ADMIN\_AFFILIATION\_TEMPLATE

  - > 現在の設定値：  
    > WEKO\_AUTHORS\_ADMIN\_AFFILIATION\_TEMPLATE = \\'weko\_authors/admin/affiliation\_list.html'

<!-- end list -->

  - > 【Administration\>著者DB管理(Author Management)\>編集(edit)】からAffiliation IDタブ押下で遷移する初期画面は、Affiliation IDタブ押下時にweko\_authors.views.get\_affiliation\_listが呼び出され、db内のauthors\_affiliation\_settingsテーブルの情報が取り出されて表示される。

  - 編集時は、\[編集（Edit）\]ボタンを押下することで編集が可能となり、内容の変更後に\[保存(Save)\]ボタンを押すことで、weko\_authors.views.update\_affiliationが呼び出されて、db内のauthors\_affiliation\_settingsテーブルの情報が更新される。

  - 削除時は、\[編集（Edit）\]ボタン押下後に出現する\[削除（Delete）\]ボタンを押下することで、weko\_authors.views.delete\_affiliationが呼び出され、db内のauthors\_affiliation\_settingsテーブルから削除対象が削除される。

  - 追加時は、追加したい情報を最下部のテキストボックスに入力後に\[追加（Add）\]ボタンを押すことで、weko\_authors.views.create\_affiliationが呼び出され、db内のauthors\_affiliation\_settingsテーブル内に情報が追加される。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>


### 一括出力

  - > 目的・用途

本機能は、著者DBの情報を一括出力する機能である。

  - > 利用方法

本画面にある \[エクスポート(Export)\] ボタンを押下することで、著者DBに登録されている著者情報をtsvファイルで出力する。

tsvファイルのダウンロードURLにアクセスすることでtsvファイルを取得することができる。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

(1) 一括出力画面の画面構成

  - 【Administration \> 著者DB管理(Author Management) \> 一括出力(Export)】 を選択すると表示される。

  - 画面構成は以下の通り
    
      - 全件エクスポート(Export all creator)
    
      - ダウンロードURL(Download URL)

  - 全件エクスポート(Export all creator)
    
      - 全件エクスポートを実行する。以下の2種類のボタンがある。
        
          - \[エクスポート(Export)\] ボタン
            
              - ボタンを押下すると、以下のポップアップのメッセージとボタンが表示される
                
                  - 「著者DBの全件エクスポートを実行してよいですか？(Are you sure you want to export all creator?)」  
                    　　\[実行(Execute)\] ボタン：著者DBの全件エクスポートを実行し、自画面に戻る  
                    　　\[キャンセル(Cancel)\] ボタン：何も処理はせずに自画面に戻る
            
              - 著者DBの全件エクスポート実行中は、ボタンは非活性となる
        
        <!-- end list -->
        
          - \[キャンセル(Cancel)\] ボタン
            
              - 著者DBの全件エクスポートを中断する。エクスポート実行中以外は非活性である。

  - 著者DBの全件エクスポート実行中にボタンが活性化される。ボタンを押下すると、以下のポップアップのメッセージとボタンが表示される。  
    「メッセージ」  
    　日本語：著者DBの全件エクスポートの処理をキャンセルしてよいです　　か？  
    　英語：Are you sure you want to cancel process of exporting all creator?  
    「ボタン」  
    　\[実行(Execute)\] ボタン：著者DBの全件エクスポートを中断し、自画面に戻る。  
    　\[キャンセル(Cancel)\] ボタン：中断はせずに自画面に戻る(全件エクスポート処理を継続する)。ダウンロードURL(Download URL)
    
      - 全件エクスポートが完了すると、出力ファイル(tsv形式)をダウンロードできるURLが表示される
    
      - 最後に出力されたダウンロードURLが表示される（初期の全件エクスポート実行前は何も表示されない）
    
      - ダウンロードのURLの例(初期値)としては以下の通り（出力ファイル名はConfigで設定できるものとする）
        
          - 
(2) 出力ファイル

  - 全件エクスポートされたファイルはtsv形式で出力される。

  - tsvファイルの構成は以下の通り

> ヘッダ行
> 
> ラベル(英語)
> 
> ラベル(日本語)
> 
> データ行（著者１）
> 
> データ行（著者２）
> 
> …

  - 文字コードはUTF-8(BOM付き)，改行コードはCR+LFとする。

  - １行目はヘッダ行とし、システム管理するものである。先頭に"\#"が付いている。

  - ２行目と３行目はラベルを表示し、TSV入力の補助をする。先頭に"\#"が付いている。

  - ４行目以降に著者の情報を出力する。１著者の情報を1行で出力する。

<!-- end list -->

  - 各ヘッダの情報は以下の通り

<table>
<thead>
<tr class="header">
<th>#</th>
<th>ヘッダ項目</th>
<th>ラベル(日本語)</th>
<th>ラベル(英語)</th>
<th>概要</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>pk_id</td>
<td>WEKO ID</td>
<td>WEKO ID</td>
<td>WEKO3の著者ID(author_link)を出力する</td>
</tr>
<tr class="even">
<td>2</td>
<td>authorNameInfo[0...n].familyName</td>
<td>姓[0...n]</td>
<td>Family Name[0...n]</td>
<td>著者の姓を出力する</td>
</tr>
<tr class="odd">
<td>3</td>
<td>authorNameInfo[0...n].firstName</td>
<td>名[0...n]</td>
<td>Given name[0...n]</td>
<td>著者の名を出力する</td>
</tr>
<tr class="even">
<td>4</td>
<td>authorNameInfo[0...n].language</td>
<td>言語[0...n]</td>
<td>Language[0...n]</td>
<td>著者の言語を出力する</td>
</tr>
<tr class="odd">
<td>5</td>
<td>authorNameInfo[0...n].nameFormat</td>
<td>フォーマット[0...n]</td>
<td>name Format[0...n]</td>
<td>著者の姓名のフォーマットを出力する<br />
※現状(SP67時点)は「familyNmAndNm」固定</td>
</tr>
<tr class="even">
<td>6</td>
<td>authorNameInfo[0...n].nameShowFlg</td>
<td><p>姓名・言語</p>
<p>表示／非表示[0...n]</p></td>
<td>Name Display[0...n]</td>
<td>著者の姓名と言語の表示／非表示を出力する<br />
表示する: "Y"<br />
表示しない: "N"</td>
</tr>
<tr class="odd">
<td>7</td>
<td>authorNameInfo[0...n].idType</td>
<td>外部著者ID 識別子[0...n]</td>
<td>Identifier Scheme[0...n]</td>
<td>外部著者IDの識別子を出力する</td>
</tr>
<tr class="even">
<td>8</td>
<td>authorNameInfo[0...n].authorId</td>
<td>外部著者ID URI[0...n]</td>
<td>Identifier URI[0...n]</td>
<td>外部著者IDの値を出力する</td>
</tr>
<tr class="odd">
<td>9</td>
<td>authorNameInfo[0...n].authorIdShowFlg</td>
<td><p>外部著者ID</p>
<p>表示／非表示[0...n]</p></td>
<td>Identifier Display[0...n]</td>
<td>外部著者IDの表示／非表示を出力する<br />
表示する: "Y"<br />
表示しない: "N"</td>
</tr>
<tr class="even">
<td>10</td>
<td>emailInfo[0...n].email</td>
<td>メールアドレス[0...n]</td>
<td>Mail Address[0...n]</td>
<td>著者のメールアドレスを出力する</td>
</tr>
<tr class="odd">
<td>11</td>
<td>is_deleted</td>
<td>削除フラグ</td>
<td>Delete Flag</td>
<td>著者を削除する場合に "D" と出力する<br />
※論理削除された著者情報は出力しないため、全件エクスポートではすべて空欄となる</td>
</tr>
</tbody>
</table>

　【補足】  
　　・同じ項目名を複数持つ場合は、各項目名の後ろに\[0\],\[1\],…,\[N\]と記載された状態で出力される。  
　　　※1つ目の項目名には \[0\] が記載されている。  
　　・WEKO ID, Delete Flagは繰り返し記載することはできない。

(3) エラーメッセージ

  - 全件エクスポート処理においてエラーが発生した場合はその制御を行う

  - エラーメッセージは画面上部に赤く表示される。

  - 本画面でチェックしているエラー内容は以下の通り。

<table>
<thead>
<tr class="header">
<th>エラー発生条件</th>
<th>表示されるエラーメッセージ</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>エクスポートのキャンセルに失敗した場合<br />
（キャンセル中にエラーが発生した、またはキャンセルが実行される前にエクスポートが完了した場合）</td>
<td>エクスポートのキャンセルに失敗しました。<br />
（Failed to cancel export.）</td>
</tr>
<tr class="even">
<td>他のユーザが全件エクスポート処理を実行中の場合</td>
<td>他の端末でエクスポートを実行中です。<br />
（Export is in progress on another device.）</td>
</tr>
<tr class="odd">
<td>予期せぬエラーが発生した場合<br />
（ネットワークに問題があった場合など）</td>
<td>サーバ内部エラー<br />
（Internal server error）</td>
</tr>
</tbody>
</table>

(4) その他

  - バックグラウンドでエクスポート処理を実行する。

  - 論理削除された著者情報は出力されない。

  - 全件エクスポートで出力されたファイルと、著者の一括登録で登録するファイルの形式は同じものとする。

  - 実行結果をサーバ上（オブジェクトストレージのファイルインスタンス）に配置することで、管理者がダウンロードできるようにする。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko-authors

<!-- end list -->

  - > 処理概要

> modules/weko-authors/weko\_authors/config.py

  - > 全件エクスポートのファイル名の設定値
    
      - > WEKO\_AUTHORS\_EXPORT\_FILE\_NAME = 'Creator\_export\_all.tsv'

> \[（Export）\]ボタンを押下すると、weko\_authors.admin.ExportView.exportが呼び出され、著者情報のファイルのURIのidをdb内のfilies\_filesテーブルのidカラムから取得する。（URIがない場合は、invenio\_files\_rest.models.FileInstance.createが呼び出され作成される。）  
> 次に、weko\_authors.admin.ExportView.check\_statusが呼び出され、Download URLが作成される。
> 
> Download URLを押下することで、weko\_authors.admin.ExportView.downloadが呼び出されてファイルがダウンロードされる。

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### 一括登録

  - > 目的・用途

本機能は、著者DBの情報を一括登録する機能である。

  - > 利用方法

管理者は本画面でインポート用のtsvファイルを取り込むことで、tsvファイル内の著者情報を一括で著者DBに登録することができる。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

(1) 一括登録画面の画面構成

  - 【Admin \> 著者DB管理(Author Management) \> 一括登録(Import)】 を選択すると表示される

  - 画面構成は以下の通り。３つのタブに分かれており、動作を進めることでタブが切り替わる。

| \# | タブ名           | 機能概要                      |
| -- | ------------- | ------------------------- |
| 1  | 選択(Select)    | 著者DBのインポート用ファイル(tsv)を選択する |
| 2  | インポート(Import) | インポートファイル内の著者情報の確認・登録をする  |
| 3  | 結果(Result)    | インポート結果を表示する              |

　【補足】  
　　・タブの遷移の順番は「選択(Select)」→「インポート(Import)」→「結果(Result)」となる

「選択(Select)」タブ

  - 本タブは、ユーザが著者DBのインポート用ファイルを選択することができる。画面構成は以下の通り

<table>
<thead>
<tr class="header">
<th>#</th>
<th>ボタン</th>
<th>概要</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>ファイル選択(Select File)</td>
<td>ボタンを押下すると、ファイルのアップロードウィンドウを表示する。<br />
ユーザは任意の著者DBのインポート用ファイルを選択する。<br />
なお、選択できる形式は「tsv」ファイルのみとする。</td>
</tr>
<tr class="even">
<td>2</td>
<td>次へ(Next)</td>
<td>ボタンを押下すると、選択したファイルの形式(フォーマット)をチェックし、問題無ければ「インポート(Import)」タブへ自動遷移する。<br />
エラーがある場合は、「選択(Select)」タブ上部に赤枠でエラーメッセージを表示し、「インポート(Import)」タブへ遷移はしない。<br />
本ボタンの初期状態は非活性とする。<br />
ユーザがファイルを選択後、活性化する。</td>
</tr>
</tbody>
</table>

  - ファイル未選択の場合は\[ファイル選択(Select File)\]ボタン下に「選択したファイル名(Selected file name)」というラベルをグレーで表示する。  
    ファイル選択後、選択されたファイルのファイル名を表示する

  - 　

「インポート(Import)」タブ

  - 本タブは、読み込んだ著者DBのインポート用ファイルの内容をチェックし、登録して良いかの確認を促すものである。画面構成は以下の通り

<table>
<thead>
<tr class="header">
<th>#</th>
<th>ボタン</th>
<th>概要</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>インポート(Import)</td>
<td>ボタンを押下すると、読み込んだ著者DBのインポート用ファイルの内容を登録する。ボタン押下後は、「インポート(Import)」タブへ自動遷移する。<br />
読み込んだ著者DBのインポート用ファイルの内容にエラーがある場合は、本ボタンは非活性となる。</td>
</tr>
<tr class="even">
<td>2</td>
<td>ダウンロード(Download)</td>
<td>ボタンを押下すると、画面に表示されている著者のリストをTSV形式でダウンロードできる。<br />
・文字コードはBOM無しUTF-8、改行コードはCR+LFとする。<br />
BOM付きのファイルのダウンロードを行うと、先頭についているBOMを文字列として取り込むため、正しく情報のダウンロードが行われない場合がある。<br />
・ファイル名は「Creator_Check_yyyymmdd.tsv」とする。<br />
・画面上トリミングされている情報があっても、ファイルにはすべて出力される</td>
</tr>
</tbody>
</table>

  - 画面に読み込んだ著者DBのインポート用ファイルの「サマリー(Summary)」を以下のように表示する

| \# | 項目名            | 概要                      |
| -- | -------------- | ----------------------- |
| 1  | 総計(Total)      | 読み込んだファイルの著者の数          |
| 2  | New Creator    | 読み込んだファイルの内、新規登録となる著者の数 |
| 3  | Update Creator | 読み込んだファイルの内、更新の著者の数     |
| 4  | Delete Creator | 読み込んだファイルの内、削除となる著者の数   |
| 5  | Result Error   | 内容のチェックでエラーとなった著者の数     |

  - 画面に表示される著者の詳細情報は以下の通り

<table>
<thead>
<tr class="header">
<th>#</th>
<th>項目名</th>
<th>概要</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>No.</td>
<td>読み込んだファイルの著者の通し番号を表示する。</td>
</tr>
<tr class="even">
<td>2</td>
<td>WEKOID</td>
<td>読み込んだ著者のWEKO著者IDを表示する。</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Full_Name</td>
<td>読み込んだ著者の姓と名を表示する。<br />
姓と名の間はカンマ＋スペース「姓, 名」で表示する。</td>
</tr>
<tr class="even">
<td>4</td>
<td>Mail Address</td>
<td>読み込んだ著者のメールアドレスを表示する。</td>
</tr>
<tr class="odd">
<td>5</td>
<td>チェック結果(Check Result)</td>
<td><p>読み込んだファイルの各著者について、インポートが可能かバリデーションチェックを実施する。<br />
・エラーが無く、新規の著者の場合：「登録(Register)」と表示する<br />
・エラーが無く、更新の著者の場合：「更新(Update)」と表示する<br />
・削除する著者の場合：「削除(Delete)」と表示する<br />
・バリデーションエラーがある場合：「エラー: XXXXX (ERROR: XXXXX)」とエラー内容を表示する</p>
<p>・登録は可能であるが、何らかの問題があるときは「警告（Warning）」と表示する。</p></td>
</tr>
</tbody>
</table>

  - 結果タブへ遷移する際は、\[インポート（Import）\]ボタンを押下することで自動的に遷移し、それ以外の方法で遷移することはできない。　

  - \[インポート（Import）\]ボタンは一度押下すると、ファイルを変更するまでは非活性となる。

「結果(Result)」タブ

  - 本タブは、インポートファイルで登録・更新・削除した著者の登録結果を表示する。画面構成は以下の通り　

<table>
<thead>
<tr class="header">
<th>#</th>
<th>ボタン</th>
<th>概要</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>ダウンロード(Download)</td>
<td>ボタンを押下すると、画面に表示されている著者のリストをTSV形式でダウンロードできる。<br />
・文字コードはBOM無しUTF-8、改行コードはCR+LFとする<br />
・ファイル名は「Creator_List_Download_yyyymmdd.tsv」とする</td>
</tr>
</tbody>
</table>

  - 画面に表示される著者のインポート結果は以下の通り

<table>
<thead>
<tr class="header">
<th>#</th>
<th>項目名</th>
<th>概要</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>No.</td>
<td>読み込んだファイルの著者の通し番号を表示する。</td>
</tr>
<tr class="even">
<td>2</td>
<td>開始日(Start Date)</td>
<td>１著者に対して登録処理を開始した日時を表示する。<br />
フォーマット：YYYY-MM-DD hh:mm:ss</td>
</tr>
<tr class="odd">
<td>3</td>
<td>終了日(End Date)</td>
<td>１著者に対して登録処理が完了した日時を表示する。<br />
フォーマット：YYYY-MM-DD hh:mm:ss</td>
</tr>
<tr class="even">
<td>4</td>
<td>WEKOID</td>
<td>読み込んだ著者のWEKO著者IDを表示する。</td>
</tr>
<tr class="odd">
<td>5</td>
<td>Full_name</td>
<td>読み込んだ著者の姓と名を表示する。<br />
姓と名の間はカンマ＋スペース「姓, 名」で表示する。</td>
</tr>
<tr class="even">
<td>6</td>
<td>ステータス(Status)</td>
<td>登録した結果を表示する。<br />
・「Register Success」：新規登録が完了した場合に表示<br />
・「Update Success」：変更・更新登録が完了した場合に表示<br />
・「Delete Success」：削除が完了した場合に表示<br />
・「ERROR: XXXXX」：エラーが発生した場合に表示</td>
</tr>
</tbody>
</table>

  - 登録処理は、バックグラウンドで実行し、１著者毎にコミットしながら処理を進める

  - 登録情報は、著者のテーブルとESに登録する

  - 本タブを開いた状態で画面をリロードすることで、登録状況が更新されるものとする

  - 「選択(Select)」タブ，「インポート(Import)」タブへの遷移は可能とする。ただし、登録処理実行中は、各ボタンは非活性とする

(2) 入力ファイル

  - 入力ファイルはtsv形式で出力される

  - tsvファイルの構成は以下の通り

> ヘッダ行
> 
> ラベル(英語)
> 
> ラベル(日本語)
> 
> データ行（著者１）
> 
> データ行（著者２）
> 
> …

  - 文字コードはUTF-8(BOM無し)，改行コードはCR+LFとする

  - １行目はヘッダ行とし、システム管理するものである。先頭に"\#"が付いている

  - ２行目と３行目はラベルを表示し、TSV入力の補助をする。先頭に"\#"が付いている

  - ４行目以降に著者の情報を入力する。１行１著者となる

<!-- end list -->

  - 各ヘッダの情報は以下の通り

<table>
<thead>
<tr class="header">
<th>#</th>
<th>ヘッダ項目</th>
<th>ラベル(日本語)</th>
<th>ラベル(英語)</th>
<th>概要</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>pk_id</td>
<td>WEKO ID</td>
<td>WEKO ID</td>
<td>WEKO3の著者ID(author_link)を入力する</td>
</tr>
<tr class="even">
<td>2</td>
<td>authorNameInfo[0...n].familyName</td>
<td>姓</td>
<td>Family Name</td>
<td>著者の姓を入力する</td>
</tr>
<tr class="odd">
<td>3</td>
<td>authorNameInfo[0...n].firstName</td>
<td>名</td>
<td>Given name</td>
<td>著者の名を入力する</td>
</tr>
<tr class="even">
<td>4</td>
<td>authorNameInfo[0...n].language</td>
<td>言語</td>
<td>Language</td>
<td>著者の言語を入力する</td>
</tr>
<tr class="odd">
<td>5</td>
<td>authorNameInfo[0...n].nameFormat</td>
<td>フォーマット</td>
<td>name Format</td>
<td>著者の姓名のフォーマットを入力する<br />
※現状(SP67時点)は「familyNmAndNm」固定</td>
</tr>
<tr class="even">
<td>6</td>
<td>authorNameInfo[0...n].nameShowFlg</td>
<td>姓名・言語 表示／非表示</td>
<td>Name Display</td>
<td>著者の姓名と言語の表示／非表示を入力する<br />
表示する: "Y"<br />
表示しない: "N"</td>
</tr>
<tr class="odd">
<td>7</td>
<td>authorNameInfo[0...n].idType</td>
<td>外部著者ID 識別子</td>
<td>Identifier Scheme</td>
<td>外部著者IDの識別子を入力する</td>
</tr>
<tr class="even">
<td>8</td>
<td>authorNameInfo[0...n].authorId</td>
<td>外部著者ID URI</td>
<td>Identifier URI</td>
<td>外部著者IDの値を入力する</td>
</tr>
<tr class="odd">
<td>9</td>
<td>authorNameInfo[0...n].authorIdShowFlg</td>
<td>外部著者ID 表示／非表示</td>
<td>Identifier Display</td>
<td>外部著者IDの表示／非表示を入力する<br />
表示する: "Y"<br />
表示しない: "N"</td>
</tr>
<tr class="even">
<td>10</td>
<td>emailInfo[0...n].email</td>
<td>メールアドレス</td>
<td>Mail Address</td>
<td>著者のメールアドレスを入力する</td>
</tr>
<tr class="odd">
<td>11</td>
<td>is_deleted</td>
<td>削除フラグ</td>
<td>Delete Flag</td>
<td>著者を削除する場合に "D" と入力する</td>
</tr>
</tbody>
</table>

　【補足】  
　　・繰り返し項目とする場合はヘッダ行の各項目名の後ろに \[1\], \[2\], ..., \[N\] と入力する。  
　　　※1つ目の項目名には \[0\] が記載されている。  
　　・WEKO ID, Delete Flagは繰り返し記載することはできない。  
　　・姓名のフォーマットの値が空欄の場合は「familyNmAndNm」の値を固定でシステムが登録する。

　　・コンテンツのファイルサイズが空欄の場合はシステムが登録する。

(3) エラーチェック

  - 本画面でチェックしているエラー内容は以下の通り

<table>
<thead>
<tr class="header">
<th>#</th>
<th>チェックするタブ</th>
<th>チェック内容</th>
<th>処理</th>
<th>エラーメッセージ(日)</th>
<th>エラーメッセージ(英)</th>
<th>備考</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>選択(Select)</td>
<td>tsvファイルの形式のチェック<br />
#1: 選択したファイルがtsvファイルでは無い、またはtsvファイルの文字コードがUTF-8では無い<br />
#3: tsvファイルの形式のエラー(タブ無し, ヘッダ行無し)</td>
<td>ERROR</td>
<td>TSVファイルを読み込めませんでした。ファイル形式がTSVであること、またそのファイルがUTF-8でエンコードされているかを確認してください。</td>
<td>The TSV file could not be read. Make sure the file format is TSV and that the file is UTF-8 encoded.</td>
<td></td>
</tr>
<tr class="even">
<td>2</td>
<td>選択(Select)</td>
<td>ヘッダ行だけの空レコードになっている</td>
<td>ERROR</td>
<td>インポートのデータがありません。</td>
<td>There is no data to import.</td>
<td></td>
</tr>
<tr class="odd">
<td>3</td>
<td>選択(Select)</td>
<td>ヘッダの間違いからメタデータキーが重複している</td>
<td>ERROR</td>
<td>以下のメタデータキーが重複しています。<br />
{1}</td>
<td>The following metadata keys are duplicated.<br />
{1}</td>
<td>{1}: メタデータキー名</td>
</tr>
<tr class="even">
<td>4</td>
<td>選択(Select)</td>
<td>tsvに指定された項目とDBの項目が一致していない</td>
<td>ERROR</td>
<td>指定された項目とDBの項目が一致しません。<br />
{1}</td>
<td>Specified item does not consistency with DB item.<br />
{1}</td>
<td>{1}: 項目名</td>
</tr>
<tr class="odd">
<td>5</td>
<td>選択/インポート<br />
(Select/Import)</td>
<td>Celeryが動いていない状態</td>
<td>ERROR</td>
<td>Celeryは動いていません。</td>
<td>Celery is not running.</td>
<td></td>
</tr>
<tr class="even">
<td>6</td>
<td>選択/インポート<br />
(Select/Import)</td>
<td>自分の端末にインポートを実行しているうちに、インポートを実行する</td>
<td>ERROR</td>
<td>インポートを実行中です。</td>
<td>Import is in progress.</td>
<td></td>
</tr>
<tr class="odd">
<td>7</td>
<td>選択/インポート<br />
(Select/Import)</td>
<td>他の端末でインポートを実行している</td>
<td>ERROR</td>
<td>他の端末でインポートを実行中です。</td>
<td>Import is in progress on another device.</td>
<td></td>
</tr>
<tr class="even">
<td>8</td>
<td>インポート(Import)</td>
<td>他の著者情報を入力されたが、idTypeとauthorIdのいずれかを入力されていない状態</td>
<td>ERROR</td>
<td>{}は必須項目です。</td>
<td>{} is required item.</td>
<td></td>
</tr>
<tr class="odd">
<td>9</td>
<td>インポート(Import)</td>
<td>#4 著者が一意に定まらない(存在しないWEKO ID (author_link)<br />
#5 削除対象の著者がDBに存在しない</td>
<td>ERROR</td>
<td>指定されたWEKO IDが存在していません。</td>
<td>Specified WEKO ID does not exist.</td>
<td></td>
</tr>
<tr class="even">
<td>10</td>
<td>インポート(Import)</td>
<td>#6 言語の指定でDBに存在しない言語を入力する<br />
#8 ヘッダ項目#5の姓名・言語 表示／非表示で"Y","N"以外を入力する<br />
#9 ヘッダ項目#8の外部著者識別子 表示／非表示で"Y","N"以外を入力する</td>
<td>ERROR</td>
<td>{1}は{2}のいずれかを設定してください。</td>
<td>{1} should be set by one of {2}.</td>
<td>{1}: language, nameShowFlg, authorIdShowFlg<br />
{2}: 言語の一覧、"Y","N"</td>
</tr>
<tr class="odd">
<td>11</td>
<td>インポート(Import)</td>
<td>#10 ヘッダ項目#10の削除フラグで"D"以外を入力する<br />
#13 姓名のフォーマットの値が「familyNmAndNm」以外の値</td>
<td>ERROR</td>
<td>{1}は{2}を設定してください。</td>
<td>{1} should be set by one of {2}.</td>
<td>{1}: is_deleted, nameFormat<br />
{2}: "D"、"familyNmAndNm"</td>
</tr>
<tr class="even">
<td>12</td>
<td>インポート(Import)</td>
<td>ID PrefixでDBに存在しない識別子を入力する</td>
<td>ERROR</td>
<td>指定された外部著者ID 識別子'{1}'が存在していません。</td>
<td>Specified Identifier Scheme '{1}' does not exist.</td>
<td>{1}:外部著者ID 識別子</td>
</tr>
<tr class="odd">
<td>13</td>
<td>インポート(Import)</td>
<td>TSVファイルの中に重複するデータがある</td>
<td>ERROR</td>
<td>TSVファイルの中に重複するデータがあります。</td>
<td>There is duplicated data in the TSV file.</td>
<td>各レコードがマルチタスクで実行されているので、後勝ちで2番目のデータを上書きするのが難しい(重複する場合にどのレコードで更新されるか定まらない)。WARNING→ERRORに変更し、2つ目以降は更新されないようにする</td>
</tr>
<tr class="even">
<td>14</td>
<td>インポート(Import)</td>
<td>外部著者識別子がDBに存在している</td>
<td>WARNING</td>
<td>外部著者識別子がDBに存在しています。<br />
{1}</td>
<td>External author identifier exists in DB.<br />
{1}</td>
<td>{1}:外部著者識別子</td>
</tr>
<tr class="odd">
<td>15</td>
<td>選択/インポート/結果<br />
(Select/Import/Result)</td>
<td>サーバ内部エラー（ネットワークの問題、予期しない例外など）が発生した</td>
<td>ERROR</td>
<td>サーバ内部エラー</td>
<td>Internal server error</td>
<td></td>
</tr>
<tr class="even">
<td>16</td>
<td>結果(Result)</td>
<td>登録成功</td>
<td>INFO</td>
<td>登録成功</td>
<td>Register Success</td>
<td></td>
</tr>
<tr class="odd">
<td>17</td>
<td>結果(Result)</td>
<td>更新成功</td>
<td>INFO</td>
<td>更新成功</td>
<td>Update Success</td>
<td></td>
</tr>
<tr class="even">
<td>18</td>
<td>結果(Result)</td>
<td>削除成功</td>
<td>INFO</td>
<td>削除成功</td>
<td>Delete Success</td>
<td></td>
</tr>
<tr class="odd">
<td>19</td>
<td>結果(Result)</td>
<td>エラーが発生したため、インポートに失敗した</td>
<td>ERROR</td>
<td>インポートに失敗しました。</td>
<td>Failed to import.</td>
<td></td>
</tr>
<tr class="even">
<td>20</td>
<td>インポート(Import)</td>
<td>削除済みの著者について、tsvに該当の著者情報を指定して更新した</td>
<td>WARNING</td>
<td>指定された著者は削除済です。tsvの内容で著者情報を更新しますが、著者は削除されたままです。</td>
<td>The specified author has been deleted. Update author information with tsv content, but author remains deleted as it is.</td>
<td></td>
</tr>
<tr class="odd">
<td>21</td>
<td>インポート/結果<br />
(Import/Result)</td>
<td>アイテムに紐づいている著者を削除した</td>
<td>ERROR</td>
<td>アイテムがリンクしているため、指定された著者は削除できません。</td>
<td>The author is linked to items and cannot be deleted.</td>
<td>英語のメッセージが既存<br />
日本語のメッセージを新規追加</td>
</tr>
<tr class="even">
<td>22</td>
<td>インポート(Import)</td>
<td>存在しないインデックスにインポートしようとした</td>
<td>ERROR</td>
<td>指定された{}はシステムに存在しません。</td>
<td>The specified {} does not exist in system.</td>
<td></td>
</tr>
<tr class="odd">
<td>22</td>
<td>インポート(Import)</td>
<td></td>
<td>ERROR</td>
<td>ロールの権限が足りずこのインデックスにアイテム登録ができません。</td>
<td>Your role cannot register items in this index.</td>
<td></td>
</tr>
</tbody>
</table>

  - 処理の「エラー」は登録不可、「ワーニング」は登録可能とする。

(4) その他

  - バックグラウンドでインポート処理を実行する。

  - 著者情報は論理削除とする。

  - 著者DBのインポート機能により、著者DBを更新／削除した際は、紐づくアイテムの著者情報までは更新を行わない。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko-authors

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - > ファイル選択を押下し、任意のtsvファイルを選択したのちに\[次へ（Next）\]ボタンを押下することでweko\_authors.admin.ImportView.check\_import\_fileが呼び出されファイルの内容のバリデーションチェックが行われる。問題がなければファイルの内容をjson形式で返し、インポート画面へと自動で遷移する。

  - > インポート画面で、\[インポート（import）\]ボタンを押下することで、weko\_authors.task.import\_authorが呼び出され、その中でweko\_authors.util.import\_author\_to\_systemが呼ばれ、db内のauthorsテーブルの情報が更新される。問題なく更新されるとweko\_authors.admin.check\_import\_statusが呼び出され結果画面に表示される情報を取得し、自動で結果画面に遷移する。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/11/11</p>
</blockquote></td>
<td>V0.9.27</td>
<td></td>
</tr>
</tbody>
</table>
#### 外部著者ID Prefix

  - > 目的・用途

本機能は、登録済みの作成者識別子の編集や、新たな作成者識別子を追加するための機能である。

  - > 利用方法

【Administration\>著者DB管理（Author Management）\>編集（Edit）】の順で編集画面に遷移し、ID Prefixタブを押下する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【Administration\>著者DB管理（Author Management）\>編集（Edit）】での「ID Prefix」タブに登録されている外部著者ID Prefix一覧が表示される。
    
      - 表示項目は以下の通りである。
        
          - 「作成者識別子（Name）」：ID Prefixの名前が表示される。
        
          - 「IDスキーマ名（Scheme）」：ID PrefixのSchemeが表示される。
        
          - 「URL」：ID PrefixのURLが表示される。
        
          - 「コントロール（Control）」：コントロールのボタンが表示される。  
            コントロールのボタンは［編集（Edit）］、［追加（Add）］である。
    
      - クリーンビルド環境での初期設定値は以下の通りである。
        
          - WEKO
        
          - ORCID (URL: <https://orcid.org/>\#\#)
        
          - CiNii (URL: <https://ci.nii.ac.jp/>author/\#\#)
        
          - KAKEN2 (URL: <https://kaken.nii.ac.jp/>nrid/\#\#)
        
          - ROR（[URL:https//ror.org/\#\#](file:///C:\\Users\\masah\\Documents\\機能仕様書\\https\\ror.org\\)）

  - 外部著者ID Prefixを追加するため、ID Prefix一覧での1番下の行に入力エリアを設ける。
    
      - 入力項目は以下の通りである。
        
          - 「作成者識別子（Name）」テキストボックス：ID Prefixの名前を入力する。
        
          - 「IDスキーマ名（Scheme）」プルダウン：ID PrefixのSchemeを選択する。
            
              - 選択肢はJPCOARスキーマの「nameIdentifierScheme」属性の統制語彙＋「Other」とする。
                
                  - 「Other」を選択した際は「Scheme」の内容を手入力させ、登録完了後は手入力した文字列が表示される。
            
              - 設定値はユニークである。
        
          - 「URL」テキストボックス：選択しているSchemeに応じるURLを入力する。
            
              - 入力しているURL形式をチェックする必要がある。
            
              - URLについて、URLの末尾に「\#\#」を入れることができる。
                
                  - 「\#\#」が含まれている場合、「ID Prefix」のURLを使用している時、「\#\#」を入力されたIDに置換してURLとする。
            
              - 「\#\#」が含まれていない場合、そのまま設定されたURLとする。
    
      - \[追加（Add）」ボタンを押すと、入力内容をチェックする。
        
          - 問題があれば、外部著者ID Prefixを追加せず、エラーメッセージを表示する。
            
              - 何かの項目を入力しない場合、またはURL形式が不正場合は以下のメッセージを表示する。  
                エラーメッセージ：「Please enter the correct ＋　項目名」
            
              - 設定されたSchemeを選択する場合は以下のメッセージを表示する。  
                エラーメッセージ：「Specified scheme is already exist.」
        
          - 問題なければ、外部著者ID Prefixを追加し、以下のメッセージを表示する。  
            メッセージ：「Successfully added」
    
      - ID Prefix行の\[編集（Edit）\]ボタンを押すと、該当の外部著者ID Prefix情報を編集可能とし、コントロールのボタンを該当行の直下に表示する。  
        コントロールのボタン：\[保存 （Save）」、\[キャンセル（Cancel）\]、\[削除（Delete）\]
        
          - 該当の外部著者ID Prefix情報を編集してから、\[保存 （Save）\]ボタンを押すと、編集内容を保存し、以下のメッセージを表示する。  
            メッセージ：「Update completed」
        
          - \[削除（Delete）\]ボタンを押すと、該当の外部著者ID Prefixを削除し、以下のメッセージを表示する  
            メッセージ：「Successfully deleted」
        
          - \[キャンセル（Cancel）\]ボタンを押すと、編集前の状態に戻る。
    
      - 作成者識別子”WEKO” には\[編集（Edit）\]ボタンは表示しない。（WEKO3の著者IDは一意に決められる値であるため編集できないようにする）

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko-authors

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - IDスキーマ名（Scheme）プルダウンに表示するScheme一覧を設定する
    
      - パス：   
        <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-authors/weko_authors/config.py#L25>
    
      - 設定キー：WEKO\_AUTHORS\_LIST\_SCHEME
    
      - 現在の設定値：

> WEKO\_AUTHORS\_LIST\_SCHEME = \[‘e-Rad’, ‘NRID’, ‘ORCID’, ‘ISNI’, ‘VIAF’, ‘AID’, ‘kakenhi’, ‘Ringgold’, ‘GRID’, ‘ROR’, ‘Other’\]

インデックスを設定する

  - パス：   
    https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-authors/weko\_authors/config.py\#L29

  - 設定キー：WEKO\_AUTHORS\_INDEX\_ITEM\_OTHER

  - 現在の設定値：

> WEKO\_AUTHORS\_INDEX\_ITEM\_OTHER = 10

  - ID Prefix画面のテンプレートを設定する
    
      - パス：   
        https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-authors/weko\_authors/config.py\#L48
    
      - 設定キー：WEKO\_AUTHORS\_ADMIN\_PREFIX\_TEMPLATE
    
      - 現在の設定値：  
        WEKO\_AUTHORS\_ADMIN\_PREFIX\_TEMPLATE = ‘weko'weko\_authors/admin/prefix\_list.html’

  - 【Administration\>著者DB管理(Author Management)\>編集(edit)】からID Prefixタブ押下で遷移する初期画面は、ID Prefix押下時にweko\_authors.views.get\_prefix\_listが呼び出され、db内のauthors\_prefix\_settingsテーブルの情報が取り出されて表示される。

  - 編集時は、\[編集（Edit）\]ボタンを押下することで編集が可能となり、内容の変更後に\[保存(Save)\]ボタンを押すことで、weko\_authors.views.update\_prefixが呼び出されて、db内のauthors\_prefix\_settingsテーブルの情報が更新される。

  - 削除時は、\[編集（Edit）\]ボタン押下後に出現する\[削除（Delete）\]ボタンを押下することで、weko\_authors.views.delete\_prefixが呼び出され、db内のauthors\_prefix\_settingsテーブルから削除対象が削除される。

  - 追加時は、追加したい情報を最下部のテキストボックスに入力後に\[追加（Add）\]ボタンを押すことで、weko\_authors.views.create\_prefixが呼び出され、db内のauthors\_prefix\_settingsテーブル内に情報が追加される。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### 運用レポート

<!-- end list -->

  - > 目的・用途

本機能は、統計情報のレポートを確認・ダウンロード・メール送信する機能である

  - > 利用方法

【Administration \> 統計（Statistics） \> 運用レポート（Report）画面】で操作を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

1 アイテム登録件数を確認する

  - 【Administration \> 統計（Statistics） \> 運用レポート（Report）画面】での「登録件数」（Number of items registered）エリアにアイテム登録件数を表示する
    
      - 表示項目は以下の通りである
        
          - 「登録件数」（Total number of items registered）
        
          - 「登録済み公開アイテム件数」（Number of open items registered）  
            　アイテムの所属しているインデックスおよび上位のインデックスが「公開状態」で、かつアイテムの公開状態がpublicで、アイテムの公開日が現在または過去日であるアイテムの件数
        
          - 「登録済みプライベートアイテム件数」（Number of private items registered）  
            　以下の条件に該当するアイテムの件数
            
              - アイテムの所属しているインデックスもしくは上位のインデックスが「非公開状態」を含む場合
            
              - インデックスの状態が公開状態であったとしても、インデックスの公開日が未来日の場合
            
              - インデックスの状態が公開状態であったとしても、アイテムの公開状態がprivateの場合
            
              - インデックスの状態が公開状態であったとしても、アイテムの公開日が未来日の場合
    
      - 集計対象外のアイテム
        
          - 新規アイテム登録時のワークフローが未完了のアイテム
        
          - 削除したアイテム

2 定型レポートをダウンロードする

  - 【運用レポート（Report）画面】での「定型レポート」（Fixed Form Reports）エリアに定型レポートをダウンロードできる
    
      - 「月別集計」（Aggregation month）に、定型レポートタイプ、集計年、集計月プルダウンを設ける
        
          - 集計情報はタイムゾーンをベースに処理できるように、ESDateHistogramQuery、ESTermsQuery、ESWekoTermsQueryの3か所にtimezoneを指摘する
        
          - 定型レポートタイプのプルダウンでの選択肢は以下の通りである
            
              - 「すべて」（All）
            
              - 「ファイルダウンロード」（File Downloads）
            
              - 「Paid File Downloads」
            
              - 「ファイルプレビュー」（File Previews）
            
              - 「Paid File Previews」
            
              - 「インデックスアクセス」（Index Access）
            
              - 「アイテムビュー」（Item View）
            
              - 「ユーザー毎に使用するファイル」（File Using Per User）
            
              - 「検索キーワード」（Search Keyword）
            
              - 「トップページへのアクセス」（Top Page Access）
            
              - 「ユーザー」（Users）
            
              - 「サイトアクセス」（Site Access）
        
          - 集計年と集計月で、デフォルト値は当年月とする
    
      - 「月別集計」（Aggregation month）より集計月を選択してから、「ダウンロード」（Download）ボタンを押すと、集計月期間内のレポートを取得できる。期間の終わりは当日の23：59：59となる。
        
          - レポートの出力形式は集計結果をTSV形式で出力したファイルを圧縮したZIPアーカイブをとする

  - 各定型レポートタイプに対して、レポート仕様は以下の通りである

<table>
<thead>
<tr class="header">
<th>#</th>
<th>タイプ</th>
<th>ファイル名</th>
<th>出力内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>ファイルダウンロード</td>
<td>logReport_FileDownload_YYYY-MM.tsv</td>
<td>ファイルごとのダウンロード回数を、次の分類順に出力します。<br />
• ファイルダウンロード回数<br />
• オープンアクセスのファイルダウンロード回数<br />
各ファイルダウンロード回数の内訳として、各分類の出力項目は以下の通りです。<br />
• ファイル名<br />
• 登録インデックス名<br />
• ファイルダウンロード回数<br />
• 未ログインユーザー<br />
• ログインユーザー<br />
• サイトライセンス認可ユーザー<br />
• 管理者<br />
• アイテム登録者<br />
※アイテム編集時にファイル差し替え機能を実施した場合、ファイルダウンロード回数は、バージョンごとに集計される</td>
</tr>
<tr class="even">
<td>2</td>
<td>Paid File Downloads</td>
<td>logReport_PayFileDownload_YYYY-MM.tsv</td>
<td>課金ファイルのダウンロード数を出力します。<br />
各ファイルダウンロード回数の内訳として、出力項目は以下の通りです。<br />
• ファイル名<br />
• 登録インデックス名<br />
• ファイルダウンロード回数<br />
• ユーザーグループごとのダウンロード回数（1回以上あるときのみ）<br />
• 未ログインユーザー<br />
• ログインユーザー<br />
• サイトライセンス認可ユーザー<br />
• 管理者<br />
• アイテム登録者</td>
</tr>
<tr class="odd">
<td>3</td>
<td>ファイルプレビュー</td>
<td>logReport_FilePreview_YYYY-MM.tsv</td>
<td>ファイルごとの再生回数を下記の分類順に出力します。<br />
• ファイルプレビュー数<br />
• オープンアクセスのファイルプレビュー数<br />
各ファイル再生回数の内訳として、各分類の出力項目は以下の通りです。<br />
• ファイル名<br />
• 登録インデックス名<br />
• ファイルダウンロード回数<br />
• 未ログインユーザー<br />
• ログインユーザー<br />
• サイトライセンス認可ユーザー<br />
• 管理者<br />
• アイテム登録者※アイテム編集時にファイル差し替え機能を実施した場合、ファイルダウンロード回数は、バージョンごとに集計される</td>
</tr>
<tr class="even">
<td>4</td>
<td>Paid File Previews</td>
<td>logReport_PayFilePreview_YYYY-MM.tsv</td>
<td>課金ファイルの再生回数を出力します。<br />
各ファイル再生回数の内訳として、出力項目は以下の通りです。<br />
• ファイル名<br />
• 登録インデックス名<br />
• ファイルダウンロード回数<br />
• ユーザーグループごとのダウンロード回数（1回以上あるときのみ）<br />
• 未ログインユーザー<br />
• ログインユーザー<br />
• サイトライセンス認可ユーザー<br />
• 管理者<br />
• アイテム登録者</td>
</tr>
<tr class="odd">
<td>5</td>
<td>インデックスアクセス</td>
<td>logReport_IndexAccess_YYYY-MM.tsv</td>
<td>各インデックスに所属するアイテムのアイテム詳細画面閲覧回数を出力します。<br />
出力項目は以下の通りです。<br />
• 詳細ビュー合計<br />
• 閲覧回数</td>
</tr>
<tr class="even">
<td>6</td>
<td>アイテムビュー</td>
<td>logReport_DetailView_YYYY-MM.tsv</td>
<td>アイテムごとの再生回数を出力します。<br />
各ファイル再生回数の内訳として、出力項目は以下の通りです。<br />
• タイトル<br />
• 登録インデックス名<br />
• 閲覧回数<br />
• 未ログインユーザー</td>
</tr>
<tr class="odd">
<td>7</td>
<td>ユーザー毎に使用するファイル</td>
<td>logReport_FileUsingPerUser_YYYY-MM.tsv</td>
<td>ユーザー別のファイルのダウンロード回数、再生回数を出力します。<br />
出力項目は以下の通りです。<br />
• メールアドレス<br />
• ユーザ名<br />
• ファイルダウンロード回数<br />
• ファイル再生回数</td>
</tr>
<tr class="even">
<td>8</td>
<td>検索キーワード</td>
<td>logReport_SearchCount_YYYY-MM.tsv</td>
<td>各検索キーワードの検索回数を出力します。<br />
出力項目は以下の通りです。<br />
• キーワード<br />
• 検索回数</td>
</tr>
<tr class="odd">
<td>9</td>
<td>トップページへのアクセス</td>
<td>logReport_TopPageAccess_YYYY-MM.tsv</td>
<td>ホスト別のトップページアクセス回数を出力します。<br />
出力項目は以下の通りです。<br />
• ホスト<br />
• IPアドレス<br />
• WEKOトップページアクセス回数</td>
</tr>
<tr class="even">
<td>10</td>
<td>ユーザー</td>
<td>logReport_UserAffiliate_YYYY-MM.tsv</td>
<td>権限別の登録ユーザー数を出力します。<br />
出力項目は以下の通りです。<br />
• ロール<br />
• ユーザー数</td>
</tr>
<tr class="odd">
<td>11</td>
<td>サイトアクセス</td>
<td>logReport_SiteAccess_YYYY-MM.tsv</td>
<td>サイトライセンスを設定しているホストまたはユーザーと、サイトライセンス以外からのアクセス回数を下記の分類順に出力します。<br />
• サイトライセンス別アクセス数<br />
• サイトライセンス別アクセス数内訳<br />
出力項目は以下の通りです。<br />
• 機関名（サイトライセンス別のアクセス回数に出力します）<br />
• WEKO3トップページアクセス回数<br />
• 検索回数<br />
• 閲覧回数<br />
• ファイルダウンロード回数<br />
• ファイル再生回数<br />
※アイテム編集時にファイル差し替え機能を実施した場合、ファイルダウンロード回数は、バージョンごとに集計される</td>
</tr>
</tbody>
</table>

  - 統計情報が存在しない場合はヘッダ行のみのレポート結果が出力される

  - 集計対象が存在しない場合は０件としてレポート結果が出力される

  - アイテム編集時にファイル差し替え機能を実施した場合、ファイルダウンロード回数は、バージョンごとに集計する

3 定型レポートをメールで送信する

【前提条件】

メールを送信するため、【Administration \> 設定（Setting） \> メール送信（Mail）画面】に送信元の情報を設定したことが必要になる

  - 「メール受信」（Receive Mail）でメールアドレスを設定する
    
      - 入力エリアに定型レポートを受け取るメールアドレスを入力可能とする
    
      - ［メールアドレス（Email Address）］ボタンを押すと、入力エリアを追加で表示する
        
          - 表示している入力エリアにメールアドレスを入力しない場合、入力エリアが追加不可とする。エラーメッセージを画面の上部に表示する

> エラーメッセージ：「Please check email input fields.」

  - 一番上の入力エリアにメールアドレスを入力した状態でボタンを押すと、追加で表示した入力エリアにそのメールアドレスが設定され、一番上の入力エリアは空になる

<!-- end list -->

  - メールアドレスを入力したエリアに［X］ボタンを設ける。押すと、該当エリアを削除する

  - 「保存」（Save）ボタンを押すと、入力データをシステム内で保持して、メッセージを画面の上部に表示する

> メッセージ：「Successfully saved email addresses.」

  - 一番上の入力エリアにメールアドレスを入力した状態でボタンを押すと、追加で表示した入力エリアにそのメールアドレスが設定され、一番上の入力エリアは空になる

<!-- end list -->

  - メールを手動送信する
    
      - 「月別集計」（Aggregation month）より集計月を選択してから、「送信」（Send）ボタンを押すと、メール送信確認ダイヤログを表示する

> 確認メッセージ：  
> 日本語：「メールを送信してもよろしいですか？」  
> 英語：「Are you sure you want to send the mail?」

  - ［Confirm］ボタンを押すと、集計月期間内のレポートを取得して、「メール受信」（Receive Mail）に設定されたメール購読者に定型レポートメールが送信される
    
      - 各定型レポートタイプに対してのメール内容について、「2 定型レポートをダウンロードする」での「各定型レポートタイプ」を参照する
    
      - メールを送信した後、メッセージを画面の上部に表示する

> メッセージ：  
> 日本語：「レポートを送信しました」  
> 英語：「Successfully sent the reports to the recepients.」

  - メール送信時、エラーが出る場合、エラーメッセージを画面の上部に表示する

<!-- end list -->

  - ［閉じる（Close）］ボタンを押すと、メール送信確認ダイヤログを閉じる

<!-- end list -->

  - メールを定期送信する
    
      - 「メールスケジュールの報告」（Report Email Schedule）にメールスケジュールの設定を設ける
        
          - 「送信間隔」（Transmission Interval）プルダウンに送信周期を設定する  
            選択肢：「Daily、Weekly、Monthly」
        
          - 定型レポートのオン・オフ
            
              - 定型レポートをオンと設定する場合、設定された送信周期に基づき定型レポートメールが送信される
            
              - 定型レポートをオフと設定する場合、定型レポートメールは送信されないようにする
        
          - ［保存（Save）］ボタンを押すと、確認ダイヤログを表示する

> 確認メッセージ：  
> 日本語：「変更してもよろしいですか？」  
> 英語：「Are you sure you want to save changes?」

  - ［Confirm］ボタンを押すと、設定した内容を保存し、メッセージを画面の上部に表示する

> メッセージ：  
> 日本語：「スケジュールを変更しました」  
> 英語：「Successfully Changed Schedule.」

  - ［閉じる（Close）］ボタンを押すと、確認ダイヤログを閉じる

4 カスタムレポートを設定する

  - 「Custom Report」エリアにカスタムレポートの取得条件を設定する
    
      - 設定項目は以下のように設ける
        
          - 「Start Date」- 「End Date」
            
              - カレンダーから選択し、または手入力できる
            
              - 範囲は00:00:00-23:59:59
        
          - 「Target Report」プルダウン
            
              - 必須項目とする
            
              - 以下の対象カスタムレポートを選択できる
                
                  - 「Item registration report」
                
                  - 「Item detail view report」
                
                  - 「Contents download report」
        
          - 「Unit」プルダウン
            
              - 必須項目とする
            
              - 初期状態は非活性とし、「Target Report」プルダウンを選択した後、活性化とする
            
              - 以下の単位を選択できる
                
                  - 「Day」
                
                  - 「Week」
                
                  - 「Year」
                
                  - 「Item」（「Item detail view report」、または「Contents download report」を選択する場合、表示する）
                
                  - 「Host」

  - ［Display］ボタンを押すと、各設定項目に応じた集計結果が「Result」に表示される
    
      - 「Target Report」プルダウン、「Unit」プルダウンに取得条件を選択しない場合、エラーメッセージを表示する  
        エラーメッセージ：「項目名 is required\!」
    
      - 「Unit」が「Item」または「Host」で、取得結果がない場合、メッセージを表示する  
        メッセージ：「There is no data.」
    
      - 「Start Date」及び「End Date」を入力する場合、入力値のバリデーションをチェックする
        
          - 入力によって「YYYY/M/D」形式の日付でなくなるとき、そうなった入力欄の枠が赤くなり、メッセージ「Format is incorrect\!」
            
              - この状態でも［Display］ボタンを押すことができる
            
              - 入力値によっては、この状態で［Display］ボタンを押して集計結果を表示させることができる。詳細は実装内容を参照
        
          - ［Display］ボタンを押すとバリデーションチェックを行い、エラーがある場合、エラーメッセージを表示する
            
              - 片方でも不正な日付である：「Date is not valid\!」
                
                  - ISO 8601 形式で解釈できない場合に不正となる
            
              - End Date \< Start Date：「Start date is greater than End date\!」
        
          - バリデーションチェックでエラーにならなかったとしても、入力値が「年・月・日」の順番でない場合は何も表示されない

  - 各単位に応じて、カスタムレポートに表示する項目について
    
      - 「Day」、「Week」、「Year」に対して  
        表示項目：「Period」、「Counts」  
        また、「Week」の期間は以下のようにする
        
          - 「Start Date」と「End Date」が片方でも空欄の場合は、月曜日～日曜日
        
          - 「Start Date」と「End Date」の両方に入力されている場合は、「Start Date」を起点とする一週間

> 「Start Date」と「End Date」の入力状態によって、表示内容は以下のようにする

  - 「Start Date」と「End Date」が片方でも空欄の場合は、範囲内でも０件の年、月、日は表示しない

  - 「Start Date」と「End Date」の両方に入力されている場合は、範囲内で０件の年、月、日を表示する

<!-- end list -->

  - 「Item」  
    表示項目：「Item ID」、「Item Name」、「Counts」  
    「Start Date」「End Date」が入力されている場合、その範囲内の集計結果を表示する

  - 「Host」  
    表示項目：「Host」、「IP Address」、「Counts」  
    「Start Date」「End Date」が入力されている場合、その範囲内の集計結果を表示する

<!-- end list -->

  - 統計情報が存在しない場合はヘッダ行のみのレポート結果が出力される

  - 集計対象が存在しない場合は０件としてレポート結果が出力される

  - Item registration reportの集計対象はワークフローで新規登録したアイテム、インポート機能で新規登録したアイテム、ハーベスト機能で登録したアイテムとする。  
    ※アイテム編集時やResourceSyncで登録したアイテムについては集計対象外とする

  - ファイルを差し替えた場合、カスタムレポートのファイルダウンロード数の統計情報はバージョンごとに集計される

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > 「weko-admin」

  - > 「invenio-stats」：QueryItemRegReportHelper.getメソッドでカスタムレポートの表示情報を作成する

<!-- end list -->

  - > 処理概要

1\. 設定

> 送信間隔の選択肢を設定する

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-admin/weko_admin/config.py#L125>

  - > 設定キー：WEKO\_ADMIN\_REPORT\_FREQUENCIES

  - > 現在の設定値：

> WEKO\_ADMIN\_REPORT\_FREQUENCIES = \['daily', 'weekly', 'monthly'\]
> 
> 「メールスケジュールの報告」でのデフォルトを設定する

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-admin/weko_admin/config.py#L128>

  - > 設定キー：WEKO\_ADMIN\_REPORT\_DELIVERY\_SCHED

  - > 現在の設定値：

> WEKO\_ADMIN\_REPORT\_DELIVERY\_SCHED = {
> 
> 'frequency': 'daily', 'details': '', 'enabled': False
> 
> }
> 
> csvファイルに各定型レポートタイプのヘッダーを設定する

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-admin/weko_admin/config.py#L139>

  - > 設定キー：WEKO\_ADMIN\_REPORT\_HEADERS

  - > 現在の設定値：

> WEKO\_ADMIN\_REPORT\_HEADERS = {
> 
> 'file\_download': \_('No. Of File Downloads'),
> 
> 'file\_preview': \_('No. Of File Previews'),
> 
> 'billing\_file\_download': \_('No. Of Paid File Downloads'),
> 
> 'billing\_file\_preview': \_('No. Of Paid File Previews'),
> 
> 'index\_access': \_('Detail Views Per Index'),
> 
> 'detail\_view': \_('Detail Views Count'),
> 
> 'file\_using\_per\_user': \_('Usage Count By User'),
> 
> 'search\_count': \_('Search Keyword Ranking'),
> 
> 'top\_page\_access': \_('Number Of Access By Host'),
> 
> 'user\_roles': \_('User Affiliation Information'),
> 
> 'site\_access': \_('Access Count By Site License')
> 
> }
> 
> csvファイルに各定型レポートタイプのサブヘッダーを設定する

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-admin/weko_admin/config.py#L154>

  - > 設定キー：WEKO\_ADMIN\_REPORT\_SUB\_HEADERS

  - > 現在の設定値：

> WEKO\_ADMIN\_REPORT\_SUB\_HEADERS = {
> 
> 'file\_download': \_('Open-Access No. Of File Downloads'),
> 
> 'file\_preview': \_('Open-Access No. Of File Previews'),
> 
> 'site\_access': \_('Access Number Breakdown By Site License')
> 
> }
> 
> 各定型レポートの出力カラムを設定する

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-admin/weko_admin/config.py#L161>

  - > 設定キー：WEKO\_ADMIN\_REPORT\_COLS

  - > 現在の設定値：

> WEKO\_ADMIN\_REPORT\_COLS = {
> 
> 'file\_download': \[
> 
> \_('File Name'), \_('Registered Index Name'),
> 
> \_('No. Of Times Downloaded'), \_('Non-Logged In User'),
> 
> \_('Logged In User'), \_('Site License'), \_('Admin'),
> 
> \_('Registrar')\],
> 
> 'file\_preview': \[
> 
> \_('File Name'), \_('Registered Index Name'),
> 
> \_('No. Of Times Viewed'), \_('Non-Logged In User'),
> 
> \_('Logged In User'), \_('Site License'), \_('Admin'),
> 
> \_('Registrar')\],
> 
> 'index\_access': \[\_('Index'), \_('No. Of Views')\],
> 
> 'detail\_view': \[
> 
> \_('Title'), \_('Registered Index Name'), \_('View Count'),
> 
> \_('Non-logged-in User')\],
> 
> 'file\_using\_per\_user': \[\_('Mail address'),
> 
> \_('Username'),
> 
> \_('File download count'),
> 
> \_('File playing count')\],
> 
> 'search\_count': \[\_('Search Keyword'), \_('Number Of Searches')\],
> 
> 'top\_page\_access': \[\_('Host'), \_('IP Address'),
> 
> \_('WEKO Top Page Access Count')\],
> 
> 'user\_roles': \[\_('Role'), \_('Number Of Users')\],
> 
> 'site\_access': \[\_('WEKO Top Page Access Count'),
> 
> \_('Number Of Searches'), \_('Number Of Views'),
> 
> \_('Number Of File download'),
> 
> \_('Number Of File Regeneration')\]
> 
> }
> 
> 定型レポートのファイル名を設定する

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-admin/weko_admin/config.py#L191>

  - > 設定キー：WEKO\_ADMIN\_REPORT\_FILE\_NAMES

  - > 現在の設定値：

> WEKO\_ADMIN\_REPORT\_FILE\_NAMES = {
> 
> 'file\_download': \_('FileDownload\_'),
> 
> 'file\_preview': \_('FilePreview\_'),
> 
> 'billing\_file\_download': \_('PayFileDownload\_'),
> 
> 'billing\_file\_preview': \_('PayFilePreview\_'),
> 
> 'index\_access': \_('IndexAccess\_'),
> 
> 'detail\_view': \_('DetailView\_'),
> 
> 'file\_using\_per\_user': \_('FileUsingPerUser\_'),
> 
> 'search\_count': \_('SearchCount\_'),
> 
> 'user\_roles': \_('UserAffiliate\_'),
> 
> 'site\_access': \_('SiteAccess\_'),
> 
> 'top\_page\_access': \_('TopPageAccess\_'),
> 
> }
> 
> 定型レポートメールのテンプレートを設定する

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-admin/weko_admin/config.py#L206>

  - > 設定キー：WEKO\_ADMIN\_REPORT\_EMAIL\_TEMPLATE

  - > 現在の設定値：

> WEKO\_ADMIN\_REPORT\_EMAIL\_TEMPLATE = 'weko\_admin/email\_templates/report.html'
> 
> aggregateionsデータをDBに格納するかを設定する。

  - > パス： modules/invenio-stats/invenio\_stats/config.py

  - > 設定キー：STATS\_WEKO\_DB\_BACKUP\_EVENTS, STATS\_WEKO\_DB\_BACKUP\_AGGREGATION, STATS\_WEKO\_DB\_BACKUP\_BOOKMARK

  - > 現在の設定値：

> STATS\_WEKO\_DB\_BACKUP\_EVENTS = True
> 
> """Enable DB backup of events."""
> 
> STATS\_WEKO\_DB\_BACKUP\_AGGREGATION = False
> 
> """Enable DB backup of aggregation."""
> 
> STATS\_WEKO\_DB\_BACKUP\_BOOKMARK = False
> 
> """Enable DB backup of bookmark."""
> 
> invenio\_stats.tasks.aggregate\_events 実行時の集計範囲は --start-date, --end-date に指定された日付を元に集計する。

  - > 関連コード： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/invenio_stats/aggregations.py#L385>

> Celeryタスクとしてinvenio\_stats.tasks.aggregate\_eventsが実行された場合の集計範囲は start\_date, end\_date と、update\_bookmark を元に集計する。デフォルト値は以下の通り。

  - > start\_date, end\_date: None

  - > update\_bookmark: True  
    > （メモ：Celeryタスクが１分に１回、自動的に実行している）

> start\_date は以下のデータ値を取得する

1.  > bookmarkから取得された日付。すなわち、前回に集計された時の end\_date。

2.  > 1.のデータがなければ、events-statsから取得された最古の日付。

> 参照コード： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/invenio_stats/aggregations.py#L391-L395>
> 
> end\_date は以下のデータの一番小さい値となる

1.  > 現在の日付

2.  > start\_date + 7 days

> 参照コード: <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/invenio_stats/aggregations.py#L400-L406>
> 
> update\_bookmark はパフォーマンスを改善するために、以前に集計された events-stats を再実行しないように制御するもの。デフォルト値はTrue。
> 
> events-stats があって stats の集計がないものはすべて対象になる

  - > bookmarkに保存されているデータを元に判断し、以前に集計されたevents-statsを再実行しないように制御している

【補足】

> aggregation情報の、ESへの登録、削除を行うコマンド操作についての説明は以下を参考
> 
> **ESから**aggregation**情報を消せるCLI:**  
> Usage: invenio stats aggregations delete-index \[OPTIONS\] \[AGGREGATION\_TYPES\]  
> AGGREGATION\_TYPES: The aggregation types. (Aggregation type value: celery-task|file-download|file-preview|record-view|item-create|search|top-view)
> 
> Options:
> 
> \-b, --bookmark: Delete bookmark index on Elasticsearch.
> 
> \-s, --suffix: Suffix of index, if not entered then default is \*. Ex: 2020
> 
> \-f, --force: Ignore Elasticsearch errors when performing Elasticsearch index deletion
> 
> \-v, --verbose: Displays information about indexes to be deleted
> 
> \--yes-i-know: Confirm deletion of the Elasticsearch index
> 
> Example:

  - > a. Command line to delete all aggregations index and bookmark in Elasticsearch and ignore Elasticsearch error:

> invenio stats aggregations delete-index -b -f --yes-i-know

  - > b. Delete all indexes of an aggregation (Ex: record-view).

> invenio stats aggregations delete-index --yes-i-know record-view

  - > c. Delete all indexes of multiple aggregation (Ex: record-view and item-create)

> invenio stats aggregations delete-index --yes-i-know record-view item-create

  - > d. Exactly delete an index of an aggregation (Ex: tenant1-events-stats-item-create-2020)

> invenio stats aggregations delete-index -s 2020 --yes-i-know item-create
> 
> **aggregation情報をDBからESに登録できるCLI:**  
> Usage: invenio stats aggregations restore \[OPTIONS\] \[AGGREGATION\_TYPES\]  
> AGGREGATION\_TYPES: The aggregation types. (Aggregation type value: celery-task|file-download|file-preview|record-view|item-create|search|top-view)
> 
> Options:
> 
> \-b, --bookmark: Restore bookmark index on Elasticsearch.
> 
> \-s, --suffix: Suffix of index, if not entered then default is \*. Ex:2020
> 
> \-f, --force: Ignore Elasticsearch errors when performing Elasticsearch index restoration.
> 
> \-v, --verbose: Displays information about indexes to be restored.
> 
> Example:

  - > a. Command line to restore all aggregation and bookmark data in DB to ES and ignore Elasticsearch error:

> invenio stats aggregation restore -b -f

  - > b. Restore all data from DB of an aggregation(Ex: record-view).

> invenio stats aggregation restore record-view

  - > c. Restore all data of multiple aggregations from DB (Ex: record-view and item-create)

> invenio stats aggregation restore record-view item-create

  - > d. Exactly restore data of an index of an aggregation (Ex: tenant1-stats-item-create-2020)

> invenio stats aggregation restore -s 2020 item-create

2\. 実装方法

> 対応しているモジュール：「weko-admin, weko-search-ui, invenio\_stats」
> 
> フィードバックメールは、ESから全件を取得後に条件で絞り込む。

  - > 実装箇所:modules/weko-search-ui/weko\_search\_ui/query.py

  - > 実装箇所:modules/weko-search-ui/weko\_search\_ui/utils.py

> 「Custom Report」エリアの「Start Date」「End Date」の入力値のチェックは、以下のようになっている。

  - > https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-admin/weko\_admin/static/js/weko\_admin/custom\_report.js
    
      - > 入力すると、ComponentDatePickerのhandleChangeEventで、以下のどちらかでフォームの外観を変更する。どちらも満たさなくなると元に戻る。
        
          - > JavascriptのDate.parse()メソッドで解釈できない
        
          - > 入力値を「/」で分割した配列の長さが3でない
    
      - > ［Display］ボタンを押すと、ComponentComboboxのhandleClickEvent中でcheckValidDateメソッドによるチェックを行う。以下のどちらかで、エラーメッセージをポップアップで表示する。
        
          - > 「Start Date」「End Date」の入力値の片方でもJavascriptのDate.parse()メソッドで解釈できない
        
          - > 「Start Date」\>「End Date」

  - > <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/invenio_stats/utils.py>
    
      - > QueryItemRegReportHelper.getメソッドで、入力値を受け取ってカスタムレポートを返す。
        
          - > ここでは、pythonのdatetime.strptime(入力値, '%Y-%m-%d')で入力値を日付オブジェクトに変換している。入力値が'%Y-%m-%d'のフォーマットで構文解析できない場合、ValueErrorによって処理が中断され、カスタムレポートが返されない。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/11/11</p>
</blockquote></td>
<td>V0.9.27</td>
<td></td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>


### フィードバックメール

  - > 目的・用途

フィードバックメールの送信有無の設定、送信除外対象者の設定、送信履歴の確認を行う。

  - > 利用方法

【Administration \> 統計（Statistics） \> フィードバックメール（Feedback Mail）画面】で操作を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

1\. フィードバックメールを設定

  - 【Administration \> 統計（Statistics） \> フィードバックメール（Feedback Mail）画面】にフィードバックメールの送信機能に対して以下ように設定できる
    
      - 「フィードバックメール」（Feedback email feature）領域にフィードバックメールを送信する／送信しないを設定する
        
          - 送信（Enable）：フィードバックメールを送信する設定となる
        
          - 無効（Disable）：フィードバックメールを送信しない設定となる
    
      - 「送信除外対象者」（Exclusion from sending）領域にフィードバックメールを送信する対象から除外を設定する
        
          - ［著者DBから入力（Input from author DB）］ボタン  
            ボタンを押下すると、著者DBの検索ウィンドウが表示される  
            「検索」ボタンを押すと、【Administration \> 著者DB管理（Author Management） \> 画面 \> Author IDタブ 】にて登録された著者DB一覧を表示する  
            メールが設定されていない著者がいた場合でも著者を表示するが、Importボタンを非活性にする
            
              - メールアドレスがリストボックスに表示されていない著者を選択すると、リストボックス上にメールアドレスがインポートされる
            
              - メールアドレスがリストボックスに表示された著者を選択すると、以下のエラーメッセージを表示し、リストボックス上にインポートされない  
                エラーメッセージ：「Duplicate Email Addresses.」
        
          - リストボックス
            
              - 除外対象者となる著者のメールアドレスが表示される
            
              - メールアドレスはクリックすると選択できる
            
              - メールアドレスを選択している状態で、「削除」（Delete）ボタンを押下すると、選択した著者のメールアドレスがリストボックスから消える(除外対象者から外れる)
            
              - リストボックスはテキスト入力できる  
                テキスト入力されたデータの"先頭"と"末尾"にスペースがあった場合はトリム処理をした上で設定する
            
              - 次のアクションに進むタイミングで、リストボックス内のメールアドレスのバリデート処理(メールアドレスとして満たしているか)を行う
            
              - バリデート処理で問題があった場合、エラーを表示して次のアクションには進めない
                
                  - 入力されたメールアドレスの形式が不正の場合、以下のエラーメッセージを表示する  
                    エラーメッセージ：「Please input a valid email.」
                
                  - 入力されたメールアドレスが重複している場合、以下のエラーメッセージを表示する  
                    エラーメッセージ：「Duplicate Email Addresses.」
    
      - ［保存（Save）］ボタンを押すと、自画面の設定された情報をDBに格納する
    
      - 「送信履歴」（Send logs）領域に著者へのフィードバックメールの送信日時の履歴を確認する

2\. アイテムのフィードバックメール送信先に指定した送信先に対して、月毎の利用統計をメールで自動送信

  - 【前提条件】
    
      - 【Administration \> 統計（Statistics） \> フィードバックメール（Feedback Mail）画面】でフィードバックメールを「送信する」に設定済み
    
      - 【Administration \> 設定（Setting） \> メール送信（Mail）画面】での「デフォルト送信元（Default sender）」にメールアドレスを設定済み

  - フィードバックメール送信タイミングは、以下の通りとする
    
      - 毎月の決まった時刻にメールが送信される
    
      - 送信する日時をコンフィグファイルに設定できる
        
          - 設定キー：「send-feedback-mail-schedules」
        
          - 設定値：月の日、時間、分
        
          - メールテンプレート：

> EN： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-admin/weko_admin/templates/weko_admin/email_templates/statistic_mail_template_en.tpl>
> 
> JP： <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-admin/weko_admin/templates/weko_admin/email_templates/statistic_mail_template_ja.tpl>

  - メールの件名には、【Administration \> 設定（setting） \> サイト情報（site info）画面】 の「サイト名」を使用する  
    　日本語メールには日本語サイト名を、英語メールには英語サイト名をセットする

<!-- end list -->

  - > アイテム登録時（[USER-4-8: Item Registration：フィードバックメール機能](#_Item_Registration：フィードバックメール機能)を参照）にフィードバックメールを受信する設定にしている方を対象とする

  - ユーザ情報にメールアドレスが登録されていない場合は対象者にならず、メールは送信されない

  - 対象者が複数のアイテムで受信する設定となっている場合、メールは1通のみ(まとめて)送信されるようにする

  - 閲覧回数、ファイル再生回数、ファイルダウンロード回数等がすべてゼロであるアイテムでもメールに記載する

  - 対象期間は１ヶ月分のデータを集計する

  - 送信するメールのフォーマットは別紙「利用統計レポートメールひな形」に合わせる

  - 日本語/英語のメール送信判定は、システムのデフォルト言語(日本語以外の場合は英語メール)とする

  - ダウンロード回数と再生回数は、ファイルの差し替えを行った場合でも統計値は引き継いで集計する

3\. フィードバックメールの送信履歴を確認

  - 【Administration \> 統計（Statistics） \> フィードバックメール（Feedback Mail）画面】での「送信履歴」（Send logs）領域にフィードバックメールの送信履歴を表示する
    
      - 送信履歴がない場合、「検索結果はありません.」（No search result）メッセージを表示する
    
      - 送信履歴がある場合、送信履歴の情報を以下のように表示する
        
          - 送信履歴は、一括処理での単位(1回の送信のトランザクションごと)での履歴とする
        
          - 表示する順序は、最新のものが一番上(送信日の降順)で並ぶように表示する
        
          - 履歴は20件を表示し、残りはページング表示で切り替える
        
          - 表示情報
            
              - 「\#」：番号順
            
              - 「送信開始日時」（Start time）：フィードバックメールの処理が開始したときの日時を出力する
            
              - 「送信終了日時」（End time）：フィードバックメールの処理が終了したときの日時を出力する
            
              - 「送信件数」（Counts）：1回の処理で何人の著者にメール送信を実行したか、その件数を表示する
            
              - 「成功」（Success）：1回の処理で送信したメールのうち、送信できたものの件数を表示する
            
              - 「エラー」（Error）
                
                  - 1回の処理で送信したメールのうち、送信できなかったものの件数を表示する（送信時に送れたかどうかで判断）
                
                  - 送信できなかった件数をアンカーで表示する
                
                  - アンカーを選択すると、画面レイアウトのようにモーダル画面上に失敗した著者のリストを表示する

4\. フィードバックメールを再送信

  - 送信失敗した著者に対してのメールを再送信できる
    
      - 送信履歴のテーブルでの失敗した件数のアンカーを表示し、モーダル画面を開いたときにある\[Resend\]ボタンを押下すると、メールが送信されるようにする
    
      - 送信される対象者は、リスト上にいる失敗したユーザーとする
    
      - 再送信時の集計期間は、送信失敗時と同じ集計期間で再度集計してメール送信を行う
    
      - 送信時のフォーマットはアイテムのフィードバックメール送信と同様のフォーマットを使用する
    
      - 送信する対象者が複数のアイテムで受信する設定となっている場合、メールは1通のみ(まとめて)送信されるようにする
    
      - 閲覧回数、ファイル再生回数、ファイルダウンロード回数等がすべてゼロであるアイテムでもメールに記載する
    
      - 日本語/英語のメール送信判定は、システムのデフォルト言語(日本語以外の場合は英語メール)とする

  - メールの送信中
    
      - 画面上には「メール送信中」であることを表示する

  - メールの送信後
    
      - 送信完了した場合は「メール送信中」の表示は消える
    
      - 送信履歴に再送した送信履歴が新たに追加される

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko-admin

<!-- end list -->

  - > 処理概要

1\. 設定

> フィードバックメール送信タイミングを設定

  - > パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/scripts/instance.cfg#L98>

  - > 設定キー：「send-feedback-mail-schedules」

  - > 設定値: day\_of\_month、hour、minute  
    > 現在の設定値：day\_of\_month='1', hour=0, minute=0

> フィードバックメールの送信履歴の表示件数

  - > パス：modules/weko-admin/weko\_admin/config.py

  - > 設定値：WEKO\_ADMIN\_NUMBER\_OF\_SEND\_MAIL\_HISTORY = 20

> フィードバックメールの送信履歴の送信失敗の表示件数

  - > パス：modules/weko-admin/weko\_admin/config.py

  - > 設定値：WEKO\_ADMIN\_NUMBER\_OF\_FAILED\_MAIL = 10

> フィードバックメールの送信件数を設定

  - > パス：modules/weko-search-ui/weko\_search\_ui/config.py

  - > 設定値：WEKO\_SEARCH\_MAX\_FEEDBACK\_MAIL = 100

> １メールアドレスで送信できるアイテムの数： 最大10,000件を取得(ESの制限値)

2\. 実装方法

> 実装モジュール：weko-admin
> 
> 設定情報を保存する

  - > アイテム登録時、 フィードバックメール送信先を入力する場合、「Approval」ステップに承認した後、  
    > フィードバックメール送信先の情報を以下のように保存される
    
      - > データベースに保存する  
        > テーブル名：feedback\_mail\_list  
        > 保存情報：item\_id、mail\_list
    
      - > Elasticsearchに「feedback\_mail\_list」属性に保存する

  - > 【Administration \> 統計（Statistics） \> フィードバックメール（Feedback Mail）画面】に入力した情報をデータベースに以下のように保存する  
    > テーブル名：feedback\_email\_setting  
    > 保存情報：is\_sending\_feedback、manual\_mail

> フィードバックメール送信のフロー
> 
> celaryタスクでフィードバックメールを送信するかどうか、チェックする  
> 「schedule」に設定された時刻にフィードバックメール送信を「task」でのタスク（weko\_admin.tasks.send\_feedback\_mail）で実施する
> 
> (1) 「feed\_back\_email\_setting」の情報を「feedback\_email\_setting」テーブルから取得する
> 
> 　・「is\_sending\_feedback = false」の場合、何も処理しない
> 
> 　・「is\_sending\_feedback = true」の場合、(2)に進む
> 
> (2)Elasticsearchからフィードバックメールの情報を取得する
> 
> 　・アイテムごとの最新版に"feedback\_mail\_list"のデータがあるかどうか、チェックする
> 
> 　"feedback\_mail\_list"のデータがある場合、フィードバックメールの情報を取得する
> 
> (3)アイテムごとの統計情報を「invenio-stats」から「get\_list\_statistic\_data」メソッドで取得する
> 
> 　・閲覧回数
> 
> 　　アイテムID及び統計期間（年、月）の情報を元に「get\_item\_view」メソッドでアイテムごとの閲覧回数を取得する
> 
> 　・ファイルダウンロード回数
> 
> 　　バケツID（bucket\_id）及びファイル名及び統計期間（年、月）の情報を元に、「get\_item\_downloadメソッドでファイルダウンロード回数を取得する
> 
> (4)フィードバックメール送信先ごとにアイテムをまとめ、以下の情報を合計する
> 
> 　・アイテム総数
> 
> 　・ファイル総数
> 
> 　・閲覧回数合計
> 
> 　・ファイルダウンロード回数合計
> 
> (5)送信除外対象者を「get\_banned\_mail」メソッドで取得し、送信除外対象者一覧に含まれてないメールアドレスへフィードバックメール送信を実施する
> 
> 　・送信が完了した後、送信履歴をデータベースに保存する
> 
> 　　テーブル名：feedback\_mail\_history
> 
> 　　履歴内容：id、start\_time、end\_time、stats\_date、total\_mail、failed\_mail
> 
> 　・送信が失敗になる場合、送信が失敗する情報をデータベースに保存する
> 
> 　　テーブル名：feedback\_mail\_failed
> 
> 　　履歴内容：id、history\_id、author\_id、mail
> 
> (6)送信履歴を【Administration \> 統計（Statistics） \> フィードバックメール（Feedback Mail）画面】に表示させる
> 
> 　送信失敗行にて、送信できなかった件数（「エラー」カラム）をアンカーで表示する
> 
> フィードバックメールを再送信する処理に対して「resend\_failed\_mail」のAPIを実施する  
> 再送信結果をデータベースでの該当レコードに更新する

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### サイトライセンス

  - > 目的・用途

本機能は、サイトライセンスユーザーによる操作ログの集計、解析を行い、その結果をサイトライセンス管理者にメールで送信する機能である。

  - > 利用方法

【Administration \> 統計（Statistics） \> サイトライセンス（Site License）画面】にて操作を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【Administration \> 統計（Statistics） \> サイトライセンス（Site License）画面】にてサイトライセンスの集計メール送信設定を管理する
    
      - 表示項目は以下の通りである
        
          - サイトライセンス機関
            
              - 【Administration \> 設定（Setting） \> サイトライセンス（Site License）画面】に登録された機関名のリストを表示し、チェックボックスを用意する
                
                  - 機関名の表示情報は以下の通りである
                    
                      - 「Organization」：機関名
                    
                      - 「メールアドレス」（Email Address）
            
              - リポジトリ管理者は、送信したい機関にチェックボックスでチェックできる
            
              - 初期値は全てのチェックボックスにチェックがついていない状態とする
            
              - 選択状態を変更すると、［保存（Save）］ボタンを押すまで［メール手動送信（Manual Send）］ボタンが非活性になる
        
          - 「Automatic Send」
            
              - 自動送信を「送信／無効」（Enable／Disable）のラジオボタンを設ける
            
              - ラジオボタンの初期値は「無効」（Disable）とする
            
              - 送信する期間（from-to）はコンフィグで設定し、初期値は１ヶ月分（先月）とする。  
                例：7月にメールを送信する場合は、6月分のデータを集計して送信する
            
              - 選択状態を変更すると、［保存（Save）］ボタンを押すまで［メール手動送信（Manual Send）］ボタンが非活性になる
        
          - 「メール手動送信」（Manual Send）
            
              - 画面上に集計年と月を設定するプルダウンを表示し、年月を選択できる
            
              - 集計月は単月以外も集計できるようにfromとtoをそれぞれ設定する
            
              - from-toの初期値は１ヶ月分（先月）とする。たとえば、2019年7月に本画面を開いた場合は、from-toの初期値は「2019/06 - 2019/06」となる
            
              - ［メール手動送信（Manual Send）］ボタンを押すと、メール送信確認ダイヤログを表示する  
                確認メッセージ：「Are you sure you want to send an email?」
                
                  - ［Confirm］ボタンを押すと、後述の送信時の処理に従って、対象機関にメールを発信する
                
                  - ［閉じる（Close）］ボタンを押すと、ダイヤログを閉じる
        
          - ［保存（Save）］ボタンを押すと、設定内容を保存し、メッセージを表示する  
            メッセージ：「Update successfully」
        
          - 送信時の処理(v0.9.22)
            
              - 宛先：チェックした機関のメールアドレス
            
              - 件名：\[○○機関リポジトリ\]YYYY.MM-yyyy.mm statistics report  
                ※YYYY.MMは集計月(from), yyyy.mmは集計月(to)を表示
            
              - メールのテンプレート： https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-admin/weko\_admin/templates/weko\_admin/email\_templates/site\_license\_report.html
            
              - 本文：サイトライセンス利用統計の内容
                
                  - WEKO Top Page Access Count
                
                  - Number Of Searches
                
                  - Number Of Views
                
                  - Number Of File download
                
                  - Number Of File Regeneration
        
          - 送信時の処理(※)
            
              - ※0.9.22には取り込まれていないが、メールの内容が既存の機能仕様書の通りになるよう修正されているので、以下に既存の機能仕様を残しておく。
            
              - 宛先：チェックした機関のメールアドレス
            
              - 件名：\[○○機関リポジトリ\]YYYY.MM-yyyy.mm 利用統計レポート  
                ※YYYY.MMは集計月(from), yyyy.mmは集計月(to)を表示
            
              - メールのテンプレート： サイトライセンス利用統計メールひな形.docx
            
              - サイトライセンス利用統計の内容

<table>
<thead>
<tr class="header">
<th>#</th>
<th>ファイル名</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>FileDownloadReport_YYYY-MM - YYYY-MM.tsv</td>
<td>サイトライセンス認可ユーザーが実施したファイルダウンロード回数の統計を出力する<br />
オンラインISSNを設定したインデックスごとにファイルダウンロード回数を出力する<br />
ファイルダウンロード回数が0のインデックスであっても出力する</td>
</tr>
<tr class="even">
<td>2</td>
<td>FileViewReport_YYYY-MM - YYYY-MM.tsv</td>
<td>サイトライセンス認可ユーザーが実施したファイル再生回数の統計を出力する<br />
オンラインISSNを設定したインデックスごとにファイル再生回数を出力する<br />
ファイル再生回数が0のインデックスであっても出力する</td>
</tr>
<tr class="odd">
<td>3</td>
<td>SearchReport_YYYY-MM - YYYY-MM.tsv</td>
<td>サイトライセンス認可ユーザーが実施したキーワード検索の統計を出力する</td>
</tr>
<tr class="even">
<td>4</td>
<td>UsagestatisticsReport_YYYY-MM - YYYY-MM.tsv</td>
<td>サイトライセンス認可ユーザーが実施した詳細画面閲覧回数、ファイルダウンロード回数の統計を出力する<br />
オンラインISSNを設定したインデックスごとに詳細画面閲覧回数、ファイルダウンロード回数を出力する<br />
詳細画面閲覧回数、ファイルダウンロード回数共に0のインデックスであっても出力する</td>
</tr>
</tbody>
</table>

  - > 関連モジュール

<!-- end list -->

  - > weko-admin

  - > invenio-stats：サイトアクセスレポートを取得する

  - > invenio-mail：メールを送信する

<!-- end list -->

  - > 処理概要

> 画面表示したとき、［保存（Save）］ボタンを押したときの処理は、以下で行う。

  - > パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-admin/weko_admin/admin.py>

  - > SiteLicenseSendMailSettingsViewクラスのindexメソッド
    
      - > ［保存（Save）］ボタンを押したときは、画面からPOSTで呼び出される。POSTで呼ばれたときに限り、データの更新を行う。
        
          - > 「Automatic Send」ラジオボタンの選択状態によって、admin\_settingsテーブルの、nameが「site\_license\_mail\_settings」であるレコードを更新する。
        
          - > サイトライセンス機関のチェック状態によって、sitelicense\_infoテーブル各行のreceive\_mail\_flagカラムを更新する。
    
      - > POSTで呼ばれたときのデータ更新後、およびGETで呼ばれたとき、以下の情報を取得する。
        
          - > サイトライセンス機関の情報として、sitelicense\_infoテーブルのレコード全件（organization\_id昇順）
        
          - > 自動送信設定として、admin\_settingsテーブルの、nameが「site\_license\_mail\_settings」であるレコード
        
          - > メール手動送信の集計月の初期値として、「現在のUTC日付のdayを1にした日付の前日」のdayを1にした日付
    
      - > 呼び出し元の画面では、POSTの結果にかかわらず、画面を更新する。

> ［メール手動送信（Manual Send）］ボタンを押したときの処理は、以下で行う。

  - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-admin/weko_admin/views.py>

  - manual\_send\_site\_license\_mailメソッド
    
      - sitelicense\_infoテーブルから、receive\_mail\_flagの値が「T」であるレコード全件を取得する。
    
      - レコードが取得できたら、以下の処理を行う。
        
          - 集計月の入力値より、fromの月の1日を「start\_date」、toの月の最終日を「end\_date」とする。
        
          - QueryCommonReportsHelper.getメソッドによって、サイトアクセスレポートを取得する。
        
          - 取得したサイトアクセスレポートを用いて、send\_site\_license\_mailメソッドでサイトライセンス機関のメールアドレスに対してメールを送信する。
            
              - > サイトライセンス機関のアクセスレポートが取得できなかった場合は、各項目を０件とする。
        
          - 送信が失敗した場合は、エラーログを出力する。送信結果にかかわらず、’finish’を返す。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### フロー

<!-- end list -->

  - > 目的・用途

本機能は、ワークフローに設定するフローの作成と編集を行う機能。

  - > 利用方法

【Administration＞ワークフロー管理（WorkFlow）＞フロー（Flow）】の順で画面遷移し利用する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【Administration \> ワークフロー管理（WorkFlow） \> フロー（Flow）】のFlow Listに登録されたフローが一覧に表示される。
    
      - 表示項目は以下の通りである
        
          - 「No.」
        
          - 「フロー」（Flow）  
            登録されたフロー名である。リンクの形式で表示される。
        
          - 「ステータス」（Status）  
            フローのステータスである。
            
              - 「作成中」（Making）  
                フローに「Start」と「End」アクションのみが登録された状態。
            
              - 「利用可」（Available）  
                フローに必要なアクションが登録された状態。
        
          - 「更新日」（Updated）  
            フローの作成日（もしくは更新日）である。  
            フォーマット：YYYY-MM-DD

  - 「Create Flow」ボタンを押すと、フローの作成画面に移動する。
    
      - 「Flow Name」テキストボックスにフロー名を入力する。
    
      - 「保存」（Save）ボタンを押すと、「Start」及び「End」アクションがフローのアクション一覧に自動追加されて、フローのステータスが「作成中」（Making）となる。  
        フロー名が複数設定できない。入力されたフローの名前がシステムに存在する場合、エラーメッセージ「Create failed. Flow name is already in use.」が表示される。
        
          - フローのアクション一覧に表示される、表示項目は以下の通りである。
            
              - 「Order」  
                フローにアクションの流れの順序を示す項目
            
              - 「アクション名」（Name）
            
              - 「Action Role」  
                アクションを実行するロールを限定する項目
            
              - 「Action User」  
                アクションを実行するユーザーを限定する項目
            
              - 「Change Order」  
                アクションの順序を設定するボタン
    
    <!-- end list -->
    
      - 「Action Role」カラムに、アクションを実行するロールを限定できる。
        
          - 「Action Role」プルダウンから選択する。「Action Role」プルダウンの選択肢は現在システムに設定されたロールである。
        
          - 「表示しない（Deny）」チェックボックスにチェックを入れる場合、選択されているロールが実施不可とする。
    
      - 「Action User」カラムに、アクションを実行するユーザーを限定できる。
        
          - 「Action User」プルダウンから選択する。「Action User」プルダウンの選択肢は現在システムに登録されたユーザーである。
            
              - 「Approval」アクションに対して
                
                  - 選択肢はシステムに登録しているユーザーと、「プロパティを指定」(Specify Property)である
                    
                      - 「プロパティを指定」(Specify Property)を選択した場合、「プロパティを指定する」(Specify Property)モーダル画面を表示する。当該画面でプロパティを選択する。
                    
                      - モーダル画面には、プロパティ定義に「"approval":true」キーワードを持つプロパティ名を表示する。
                    
                      - モーダルに表示しているプロパティを選択して「設定」(Setting)ボタンを押すことで、プロパティを指定できる。
                    
                      - 「閉じる」（Close）ボタンを押すと、モーダルを閉じる。
                
                  - 「Approval」アクションごとにメールを自動送信するチェックボックスを追加する。
                    
                      - チェックボックス
                        
                          - 「承認依頼通知メール」（Approval Request Notification Email）  
                            承認者に承認を依頼するメールを送信する。
                        
                          - 「承認却下通知メール」（Approval Rejection Notification Email）  
                            登録者に承認者が却下された旨を通知するメールを送信する。
                        
                          - 「承認通知メール」（Approval Notification Email）  
                            登録者に承認者が承認された旨を通知するメールを送信する。
                    
                      - メール本文については、下記の「メール本文について」を参照。
        
          - 「Deny」チェックボックスにチェックを入れる場合、選択されているユーザーが実施不可とする。
    
    <!-- end list -->
    
      - 「Change Order」カラムにアクションの順序を設定できる。  
        一番上の項目は、［↑］ボタンが無効になる。一番下の項目は、［↓］ボタンを押下することは可能であるが動作しない。
    
      - 画面の下部に表示されている［保存（Save）］を押すと、フローを保存しメッセージを一覧画面の上部に表示する  
        メッセージ：「Updated flow action successfully」
    
      - アクションを追加するため、フローの作成画面に「More Action」ボタンを押すと、【アクション一覧画面】に移動する。
        
          - 表示項目は以下の通りである。
            
              - 「No.」
            
              - 「アクション名」（Name）
            
              - 「概要」（Summary）
            
              - 「最新バージョン」（Version）
            
              - 「更新日」（Updated）
            
              - 「適用バージョン」（Version）
            
              - 「適用日」（Updated）
        
          - 各アクション表示の下に「適用」（Apply）、「無効」（Unusable）、「更新」（Update）ボタンが表示される
            
              - 「適用」（Apply）ボタンを押すと、アクションがフローに追加される。追加されたアクションの「適用」（Apply）ボタンは非活性となる。
                
                  - 「Approval」アクションに対して、複数定義できるため、「Approval」アクションが追加された場合、「適用」（Apply）ボタンがそのまま活性状態となり引き続き追加できる。また、アクション一覧に「Approval」を追加すると、アクション名は『Approval(1)』のように枝番を付与する
            
              - \[無効（Unusable）\]ボタンを押すと、追加されたアクションがフローから削除される。追加されていないアクションの\[無効（Unusable）\]ボタンは非活性となる。
                
                  - 「Approval」アクションに対して、複数定義された場合、「無効」（Unusable）ボタンを押すと、アクション一覧に並ぶ「Approval」のうち枝番が一番大きいものから行われる
            
              - 各アクションの説明については、以下の通りである

| \# | アクション名            | 説明                            | 制限事項              |
| -- | ----------------- | ----------------------------- | ----------------- |
| 1  | Item Registration | アイテムのメタデータとコンテンツを登録するアクションである |                   |
| 2  | Item Link         | アイテムにリンク設定するアクションである          |                   |
| 3  | Identifier Grant  | アイテムにDOIを付与するアクションである         | Approvalの前で実行すること |
| 4  | Approval          | アイテムの査読／承認するアクションである          |                   |

  - フロー名のリンクを押すと、フローの編集画面に移動する
    
      - フローの編集画面で、フローの情報を編集できる
        
          - フローの情報を編集してから、\[保存（Save）ボタン\]を押すと、フローを編集し、メッセージを一覧画面の上部に表示する。  
            メッセージ：「Updated flow action successfully」
    
      - フローの編集画面で、\[削除（Delete）\]ボタンを押すと、フローを削除する。
        
          - 対象のフローがワークフローで使用されている場合、削除できない。\[削除（Delete）\]ボタンを押すと、エラーメッセージを表示する  
            エラーメッセージ：「Cannot be deleted because flow is used.」
    
      - フローの編集画面で、\[戻る（Back）\]ボタンを押すと、フロー一覧画面に移動する。

  - システム管理者でない（リポジトリ管理者）の場合、利用申請に関するフロー（利用申請フラグがONのワークフローと紐づいているフロー）は閲覧・保存・削除ができず、権限エラーとなる。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_workflow

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - > \[Create Flow\]ボタンを押下しフロー作成画面に遷移すると、初期状態ではFlowNameテキストボックスに文字列を入力するか、\[戻る（Back）\]ボタン以外の操作は不可能である。

  - > Flow Nameテキストボックスに登録したいフロー名を入力後、\[保存（Save）\]ボタン押下で、weko\_workflow.admin.FlowSettingView.new\_flowが呼び出され、すでに登録されているフロー名と重複していないかのチェックがされ、重複がなければdb内のworkflow\_flow\_defineテーブルに情報が保存され、画面下部のアクション一覧が操作可能になる。また、Flow Statusの初期値は作成中（Maiking）である。

  - > \[More Action\]ボタンを押下すると、アクション一覧がモーダル表示されアクションの追加・削除・更新が可能となる。任意の項目の変更後、\[閉じる（Close）\]ボタン押下しアクション一覧画面を閉じたのちに、画面最下部の保存ボタン押下で、weko\_workflow.admin.FlowSettingView.upt\_flow\_actionが呼び出され、フローのアクションが変更される。また、その時のアクションの情報はdb内のworkflow\_flow\_actionテーブルに保存される。具体的なカラムとの対応は以下のようになる。
    
      - > created：アクションがフロー内に追加され、保存された時間。
    
      - > updated：もともと存在するフローを更新した際の時間。
    
      - > id：自動作番される数。個々のアクションの主キーとなる。
    
      - > flow\_id：そのアクションが追加されているフローを示すUUID。
    
      - > action\_id：アクション名に対応した数。対応は以下に示す通り。
        
          - > 1：Start
        
          - > 2：End
        
          - > 3：Item Registration
        
          - > 4：Approval
        
          - > 5：Item Link
        
          - > 6：OA Policy Confirmation
        
          - > 7：Identifier Grant
    
      - > Action\_version：アクションのバージョン。
    
      - > action\_order：そのアクションが何番目に動作するかを示した数。
    
      - > action\_condition
    
      - > action\_status：そのアクションが使用可能かを示す。可能であれば「A」、そうでなければ「N」
    
      - > action\_date：そのアクションが追加された時間。
    
      - > send\_mail\_setting：approvalのメールの送信設定が記載されている。

<!-- end list -->

  - > メール本文について

メール名：承認依頼通知メール

> Subject：利用申請の承認のお願い／Request for Approval of Application for Use
> 
> \[restricted\_institution\_name\_ja\]です。
> 
> \[restricted\_site\_name\_ja\]をご利用いただいて、ありがとうございます。
> 
> \[restricted\_university\_institution\]\[restricted\_fullname\]様から、下記の利用申請がありました。
> 
> 申請番号： \[restricted\_activity\_id\]
> 
> 登録者名： \[restricted\_fullname\]
> 
> メールアドレス： \[restricted\_mail\_address\]
> 
> 所属機関：\[restricted\_university\_institution\]
> 
> 研究題目：\[restricted\_research\_title\]
> 
> 申請データ：\[restricted\_data\_name\]
> 
> 申請年月日：\[restricted\_application\_date\]
> 
> \[restricted\_site\_name\_ja\]（\[restricted\_site\_url\]）にアクセスしていただき、画面左上からログインしていただけますと、「ワークフロー」タブが現れます。ここから上記の申請内容をご確認ください。「承認」または「却下」のボタンをクリックしてください。
> 
> このメールに心当たりのない方は、\[restricted\_site\_name\_ja\] までご連絡ください。
> 
> \[restricted\_site\_name\_ja\]：\[restricted\_site\_url\]
> 
> 問い合わせ窓口：\[restricted\_site\_mail\]
> 
> \----------------------------------------------------------------------------------
> 
> This is a message from \[restricted\_site\_name\_en\].
> 
> We received the below application.
> 
> Application No.：\[restricted\_activity\_id\]
> 
> Name：\[restricted\_fullname\]
> 
> E-mail：\[restricted\_mail\_address\]
> 
> Affiliation：\[restricted\_university\_institution\]
> 
> Title of research：\[restricted\_research\_title\]
> 
> Dataset requested ：\[restricted\_data\_name\]
> 
> Application date：\[restricted\_application\_date\]
> 
> Please access \[restricted\_site\_name\_en\]（\[restricted\_site\_url\]） and log in from the upper left corner of the screen, and the \[Workflow\] tab will appear. From here, please confirm the above application by clicking on “approve” or “reject”.
> 
> If you received this message in error, please notify the \[restricted\_site\_name\_en\]
> 
> \[restricted\_site\_name\_en\]：\[restricted\_site\_url\]

E-mail：\[restricted\_site\_mail\]

メール名：承認却下通知メール

> Subject：利用申請の審査結果について／The results of the review of your application
> 
> \[restricted\_university\_institution\]
> 
> \[restricted\_fullname\]　様
> 
> \[restricted\_institution\_name\_ja\]です。
> 
> \[restricted\_site\_name\_ja\]をご利用いただいて、ありがとうございます。
> 
> 下記の利用申請を\[restricted\_institution\_name\_ja\]で審査した結果、申請データの提供を見送らせていただくことになりました。
> 
> 申請番号： \[restricted\_activity\_id\]
> 
> 登録者名： \[restricted\_fullname\]
> 
> メールアドレス： \[restricted\_mail\_address\]
> 
> 所属機関：\[restricted\_university\_institution\]
> 
> 研究題目：\[restricted\_research\_title\]
> 
> 申請データ：\[restricted\_data\_name\]
> 
> 申請年月日：\[restricted\_application\_date\]
> 
> このメールは自動送信されているので返信しないでください。
> 
> お問い合わせは下記までお願いします。また、このメールに心当たりのない方は、\[restricted\_site\_name\_ja\] までご連絡ください。
> 
> \[restricted\_site\_name\_ja\]：\[restricted\_site\_url\]
> 
> 問い合わせ窓口：\[restricted\_site\_mail\]
> 
> \----------------------------------------------------------------------------------
> 
> Dear \[restricted\_fullname\],
> 
> This is a message from \[restricted\_institution\_name\_en\].
> 
> Thank you for using \[restricted\_site\_name\_en\].
> 
> After reviewing the following application, \[restricted\_institution\_name\_en\] is sorry to inform you that your application has been rejected.
> 
> Application No.：\[restricted\_activity\_id\]
> 
> Name：\[restricted\_fullname\]
> 
> E-mail：\[restricted\_mail\_address\]
> 
> Affiliation：\[restricted\_university\_institution\]
> 
> Title of research：\[restricted\_research\_title\]
> 
> Dataset requested ：\[restricted\_data\_name\]
> 
> Application date：\[restricted\_application\_date\]
> 
> Please do not reply to this email as it has been sent automatically.
> 
> Please direct all inquiries to the following address.
> 
> Also, if you received this message in error, please notify \[restricted\_site\_name\_en\].
> 
> \[restricted\_site\_name\_en\]：\[restricted\_site\_url\]

E-mail：\[restricted\_site\_mail\]

メール名：承認通知メール

> Subject：利用申請の承認のお知らせ／Your application was approved
> 
> \[restricted\_university\_institution\]
> 
> \[restricted\_fullname\]　様
> 
> \[restricted\_institution\_name\_ja\]です。
> 
> \[restricted\_site\_name\_ja\]をご利用いただいて、ありがとうございます。
> 
> 下記の利用申請を承認しました。
> 
> 申請番号： \[restricted\_activity\_id\]
> 
> 登録者名： \[restricted\_fullname\]
> 
> メールアドレス： \[restricted\_mail\_address\]
> 
> 所属機関：\[restricted\_university\_institution\]
> 
> 研究題目：\[restricted\_research\_title\]
> 
> 申請データ：\[restricted\_data\_name\]
> 
> 申請年月日：\[restricted\_application\_date\]
> 
> データは、下記アドレスよりダウンロードすることができます。
> 
> \[restricted\_download\_link\]
> 
> データは、\[restricted\_site\_name\_ja\]から、\[restricted\_expiration\_date\]\[restricted\_expiration\_date\_ja\]までダウンロードすることができます。
> 
> ダウンロード期限を過ぎると、再申請が必要です。
> 
> このメールは自動送信されているので返信しないでください。
> 
> このメールに心当たりのない方は、\[restricted\_site\_name\_ja\]までご連絡ください。
> 
> \[restricted\_site\_name\_ja\]：\[restricted\_site\_url\]
> 
> 問い合わせ窓口：\[restricted\_site\_mail\]
> 
> \----------------------------------------------------------------------------------
> 
> Dear \[restricted\_fullname\],
> 
> This is a message from \[restricted\_institution\_name\_en\].
> 
> Thank you for using \[restricted\_site\_name\_en\].
> 
> Your application below has been approved.
> 
> Application No.：\[restricted\_activity\_id\]
> 
> Name：\[restricted\_fullname\]
> 
> E-mail：\[restricted\_mail\_address\]
> 
> Affiliation：\[restricted\_university\_institution\]
> 
> Title of research：\[restricted\_research\_title\]
> 
> Dataset requested ：\[restricted\_data\_name\]
> 
> Application date：\[restricted\_application\_date\]
> 
> The data can be downloaded from the address below.
> 
> \[restricted\_download\_link\]
> 
> Above dataset is available to download from \[restricted\_site\_name\_en\] until \[restricted\_expiration\_date\]\[restricted\_expiration\_date\_en\].
> 
> You will need to resubmit your application once the link becomes unavailable.
> 
> Please do not reply to this email as it has been sent automatically.
> 
> If you received this message in error, please notify the \[restricted\_site\_name\_en\].
> 
> \[restricted\_site\_name\_en\]：\[restricted\_site\_url\]
> 
> E-mail：\[restricted\_site\_mail\]

埋め込み文字の整理

  - \[restricted\_site\_name\_ja\]：【Administration\>設定（Settings）\>Site Info】 に設定されている日本語のSite Name

  - \[restricted\_site\_name\_en\]：【Administration\>設定（Settings）\>Site Info】に設定されている英語のSite Name

  - \[restricted\_site\_url\]：「THEME\_SITEURL」 に設定されているURL

  - \[restricted\_site\_mail\]：【Administration\>設定（Setting）\>メール送信（Mail）】 のデフォルト送信元（Default sender）

  - \[restricted\_activity\_id\]：対象となる利用申請のアクティビティID

  - \[restricted\_fullname\]：利用申請アイテムタイプ項目の申請者・名前の設定値

  - \[restricted\_mail\_address\]：利用申請アイテムタイプ項目の申請者・メールアドレスの設定値

  - \[restricted\_university\_institution\]：利用申請アイテムタイプ項目の申請者・所属機関の設定値

  - \[restricted\_research\_title\]：利用申請アイテムタイプ項目の研究題目の設定値

  - \[restricted\_data\_name\]：利用申請アイテムタイプ項目のデータ名の設定値

  - \[restricted\_application\_date\]：利用申請アイテムタイプ項目の申請日の設定値

  - \[restricted\_download\_link\]：データファイルのURL

  - \[restricted\_expiration\_date\]：利用申請アイテムタイプ項目の承認日から【Administration\>設定（Setting）\>Restricted Access】のExpiration Date経過した日付

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024/01/19</td>
<td>8c312e8cb1db9c6479b86d1443a38720079838b0</td>
<td>制限公開機能追記</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### ワークフロー

  - > 目的・用途

本機能は、ワークフローの作成、編集を行う機能。

  - > 利用方法

【Administration＞ワークフロー管理（WorkFlow）＞ワークフロー（WorkFlow List）】の順で画面遷移することで利用可能。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【Administration \> ワークフロー管理（WorkFlow） \> ワークフロー（WorkFlow List）】に登録されたワークフローが一覧に表示される。
    
      - 表示項目は以下の通りである
        
          - 「No.」
        
          - 「ワークフロー」（WorkFlow）  
            登録されたワークフロー名である。リンクの形式で表示される。
        
          - 「アイテムタイプ」（Item Type）  
            指定されたワークフロー名である。
        
          - 「フロー」（Flow）  
            指定されたフロー名である。
        
          - 「制限公開フラグ」（Restricted Access Flag）  
            指定された制限公開フラグ名である。
        
          - 「GakuNinRDM Flag」  
            GakuNinRDMからWEB API経由で受け取るアイテムの一括登録を行う際のワークフローを作成するためのフラグ。
        
          - 「登録先インデックス」（Registration Destination Index Designation）  
            指定された登録先インデックスの指定名である。
        
          - 「ストレージロケーション」(Storage Location)  
            ファイルを保存するストレージロケーション名である。
        
          - 「表示」(Display)  
            ワークフローを表示するロールを表示する。
        
          - 「Hide」  
            ワークフローを非表示とするロールを表示する。
        
          - 「ステータス」（Status）  
            ワークフローのステータス
        
          - 「更新日」（Updated）  
            ワークフローの更新日である。フォーマット：YYYY-MM-DD

<!-- end list -->

  - 「Create WorkFlow」ボタンを押すと、ワークフローの作成画面に移動する。
    
      - 入力項目は以下の通りである。
        
          - 「ワークフロー」（WorkFlow）：テキストボックスにワークフロー名を入力する。
        
          - 「フロー」（Flow）：プルダウンからフローを選択する。  
            プルダウンの選択肢は【Administration \> ワークフロー管理（WorkFlow） \> フロー（Flow）】で登録されたフロー一覧である。
        
          - 「アイテムタイプ」（Item Type）：プルダウンからアイテムタイプを選択する。  
            アイテムタイププルダウンの選択肢は【Administration＞アイテムタイプ管理（Item Types）＞メタデータ（Metadata）】で登録された標準アイテムタイプ一覧である。
        
          - 「制限公開フラグ」（Restricted Access Flag）：制限公開フラグをチェックする。  
            デフォルトはチェック無し。チェックありの場合、アイテム登録画面でコンテンツファイルの制限公開指定時に「提供方法」の「ワークフロー」の選択肢として表示する。
        
          - GakuNinRDM Flag： チェックを入れるとGakuNinRDMからWEB APIで受け取る「一括登録フォーマット」の利用を可能とするワークフローとなる。
        
          - 「登録先インデックスの指定」（Registration Destination Index Designation）：プルダウンから登録先インデックスの指定を選択する。インデックスプルダウンの選択肢は【Administration＞インデックスツリー管理（Index Tree）＞ツリー編集（Edit Tree）】で登録されたインデックス一覧である。
            
              - \[登録先インデックスの指定（Registration Destination Index Designation）\] を「指定なし（Enable）」とした場合
                
                  - ワークフローで項目入力後にインデックスを指定してアイテムを登録する。
            
              - \[登録先インデックスの指定（Registration Destination Index Designation）\] でインデックスを指定した場合
                
                  - ワークフローで項目入力後に、指定したインデックスを自動で登録する。
        
          - 「ストレージロケーション」(Storage Location)： プルダウンから登録先ストレージロケーションを選択する。
        
          - 「表示／非表示」（Diplay/Hide）ロール毎にワークフローの表示・非表示を設定する。
            
              - invenio\_account.ACCOUNTS\_WORKFLOW\_ROLE\_HIDE\_FILTER = False とすると、新規ロール追加時にデフォルトで表示となる。(v0.9.22)
    
    <!-- end list -->
    
      - \[保存（Save）\]ボタンを押すと、ワークフローを保存し、メッセージを表示する。  
        メッセージ：「Workflow created successfully.」

<!-- end list -->

  - ワークフロー名のリンクを押すと、ワークフローの編集画面に移動する。
    
      - ワークフローの編集画面で、ワークフローの情報を編集できる。
        
          - ワークフローの情報を編集してから、\[保存（Save）\]ボタンを押すと、ワークフローを編集し、下記メッセージを一覧画面の上部に表示し、WorkFlow List画面に遷移する。  
            メッセージ：「Workflow created successfully.」
    
    <!-- end list -->
    
      - ワークフローの編集画面で、\[削除（Delete）\]ボタンを押すと、ワークフローを削除する。削除後、WorkFlow List画面に遷移する。
        
          - 対象のワークフローが使用されていた場合は削除できない。\[削除（Delete）\]ボタンを押すと、エラーメッセージを表示する。  
            エラーメッセージ：「Cannot be deleted because workflow is used.」
        
          - ワークフローの編集画面で、\[戻る（Back）\]ボタンを押すと、ワークフロー一覧画面に移動する。

  - システム管理者でない（リポジトリ管理者）の場合、利用申請に関するワークフローは閲覧・編集ができない。また利用申請に関するワークフローを追加できない。（利用申請フラグが非表示であり、登録時に利用申請フラグがFalseとして登録される）。利用申請フラグの編集はシステム管理者のみ可能。

  - 戻るボタンをクリックすると、一つ前のアクションに戻ることが可能。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_workflow

<!-- end list -->

  - > 処理概要

> 【Administration＞ワークフロー管理（Work flow）＞ワークフロー（Work Flow List）】の順で画面遷移すると、weko\_workflow.admin.WorkFlowSettingView.indexが呼び出され、db内のworkflow\_workflowテーブルからis\_deletedカラムにチェックが入っていないワークフローの情報を取り出し、WorkFlow Listとして表示する。

  - > \[Create Workflow\]ボタン押下時もしくはワークフロー名を押下指定のワークフローの編集時は、weko\_workflow.admin.WorkFlowSettingView.workflow\_detailが呼び出される。ここではメソッド内の変数workflow\_idの値を用いて条件分岐している。新規作成時は、workflow\_id=0であり、それ以外はworkflow\_idに指定したワークフローのidを代入している。新規作成の場合、入力欄の初期値は以下のようになる。
    
      - > ワークフロー（Work Flow）：空欄
    
      - > フロー（Flow）：【Administration＞ワークフロー管理（Work Flow）＞フロー（Flow　List）】のFlow Listの情報をプルダウン形式で表示する。初期状態では、No.が一番小さいものとなっている。
    
      - > アイテムタイプ（ItemType）：db内のitem\_type\_nameテーブルのnameカラムから情報を取り出し、プルダウン形式で表示する。初期状態では、idカラムの数が一番小さいものとなっている。
    
      - > 制限公開フラグ（Restrictedke）：チェックなし
    
      - > GakuNinRDM Flag：チェックなし
    
      - > 登録先インデックスの指定（Registration Destination Index Designation）：db内のindexテーブルのindex\_nameカラムから情報を取り出し、プルダウン形式で表示する。初期状態ではどの情報も選択されておらず、「指定なし（Undesignated）」と表示されている。
    
      - > ストレージロケーション（Storage Location）：：db内のfiles\_locationテーブルのnameカラムから情報を取り出し、プルダウン形式で表示する。初期状態ではどの情報も選択されておらず、「指定なし（Undesignated）」と表示されている。
    
      - > 表示/非表示（Display/Hide）：db内のacounts\_roleのnameカラムから情報を取り出し表示（Display）ボックス内に表示する。初期状態では、すべてのroleが表示側に表示される。

  - > 既存のワークフローの編集の場合、入力欄の値は指定したworkflow\_idを用いてweko\_workflow.api.Workflow.get\_workflow\_detailを使用して情報をdb内のworkflow\_workflowテーブルから取り出して表示する。

> 情報の入力後に\[保存（Save）\]ボタン押下で、weko\_workflow.admin.WorkFlowSettingView.update\_worrkflowが呼び出される。  
> ただし、\[保存（Save）\]ボタンは、ワークフロー名が空欄の時は非活性となる。

  - > 新規作成の場合、UUIDが新たに作成され、その後db内のworkflow\_workflowテーブルに入力したワークフローを保存する。作成されたUUIDはflow\_idとして使用される。

  - > 既存のワークフローの編集の時は、db内のworkflow\_workflowテーブルの情報を更新する。

  - > \[保存（Save）\]ボタン押下前に、\[戻る（Back）\]ボタン押下で入力内容を破棄しWorkFlow List画面へ戻る。

> ワークフロー名押下で編集画面に移行した際は、\[保存（Save）\]ボタンの横に\[削除（Delete）\]ボタンが配置される。\[削除（Delete）\]ボタン押下時は、削除可能なワークフローである場合はdb内のworkflow\_workflowテーブルのis\_deletedカラムにチェックが入る。

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### コミュニティ

<!-- end list -->

  - > 目的・用途

本機能は、コミュニティの作成、編集、詳細情報及び一覧の閲覧の為の機能である。

  - > 利用方法

【Administration\>コミュニティ管理(Communities)\>コミュニティ(Community)】画面にて操作を行う

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【コミュニティ（Community）画面】には以下のタブが表示される
    
      - 一覧（List）
    
      - 作成（Create）
    
      - 編集（Edit）
        
          - > 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示
    
      - 詳細（Details）
        
          - > 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示

  - 一覧（List）タブにて現在登録されているコミュニティを表示する
    
      - コミュニティが登録されていない場合、登録されたアイテムがない旨のメッセージが一覧に表示される  
        メッセージ：  
        日本語：「表にはアイテムがありません。」  
        英語：「There are no items in the table.」
    
      - 表示項目は以下の通りである
        
          - アクション  
            目アイコン及び鉛筆アイコンである
        
          - 「Id」  
            設定されたコミュニティIdである
        
          - 「Title」  
            設定されたコミュニティタイトルである
        
          - 「Owner.Name」  
            指定された所有者のロール名を表示する
        
          - 「Index」  
            選択されたコミュニティを設定しているインデックス名である
        
          - 「Deleted At」
        
          - 「Last Record Accepted」
        
          - 「Ranking」  
            ユーザ画面にてRanking順で表示する際は、ここで設定した値の降順となる
        
          - 「Fixed Points」  
            設定された固定点である
    
      - 検索テキストボックスでコミュニティを検索する
        
          - プレースホルダー：「Search: id, title, description」
        
          - 任意テキストを入力し、キーボードでの「Enter」を押すと、Id、タイトル、説明での検索を行う
        
          - テキストボックスの右端での「X」ボタンを押すと、検索条件がクリアーされる
    
      - コミュニティ行にて目アイコンを押すと、該当コミュニティの詳細情報を「詳細」（Details）タブに表示する
        
          - 表示項目は以下の通りである
            
              - 「Owner」
            
              - 「Index」
            
              - 「Created」
            
              - 「Updated」
            
              - 「Title」
            
              - 「Description」
            
              - 「Page」
            
              - 「Curation Policy」
            
              - 「Community Header」
            
              - 「Community Footer」
            
              - 「Last Record Accepted」
            
              - 「Logo Ext」
            
              - 「Ranking」
            
              - 「Fixed Points」
            
              - 「Deleted At」
            
              - 「Inclusion Requests」
            
              - 「Featuredcommunity」
    
      - コミュニティ行にて鉛筆アイコンを押すと、該当コミュニティを「編集」（Edit）タブに表示し、コミュニティの情報が編集できる
    
      - 「作成」（Create）ボタンを押すと、コミュニティの作成画面に移動する
        
          - 入力項目は以下の通りである
            
              - 「Id」テキストボックス
                
                  - コミュニティIdを入力する。必須項目である
                
                  - 入力可能な形式はアルファベットの小文字、「-」、 「\_」、数字となる
                
                  - 最初の1文字には数字を使うことはできない
                
                  - 最初の1文字に「-」を使うことができるが、その直後に数字を使うことはできない
                
                  - アルファベットの大文字が入力された場合、作成時に小文字に直す。
                
                  - 入力不可な形式を入力する場合、エラーメッセージを「Id」テキストボックスの直下に表示する
                    
                      - 最初の1文字についてのエラーメッセージ：「The first character cannot be a number or special character. It should be an alphabet character, "-" or "\_"」
                    
                      - 2文字目以降についてのエラーメッセージ：「Don't use space or special character except \`-\` and \`\_\`.」
                
                  - > 最初の文字が「-」+数字だった場合のエラーメッセージ：「Cannot set negative number to ID.」
                
                  - Idに入力したものがが既に存在している場合、作成時エラーメッセージ「Id」テキストボックスの直下に表示する。  
                    エラーメッセージ：「既に存在しています。」
            
              - 「Owner」プルダウン
                
                  - 所有者のロールを選択する。必須項目である。デフォルトは1番目の項目とする
                
                  - 「Owner」プルダウンの選択肢はシステムに登録されたロールの一覧である
                
                  - 表示形式は以下の通りである

> ロール - ロール説明(description)

  - 「Index」プルダウン
    
      - コミュニティを設定するインデックスを選択する。必須項目である。デフォルトは1番目の項目とする
    
      - 「Index」プルダウンの選択肢は自身の関連しているコミュニティに限定されたインデックス一覧である
    
      - 各インデックスの表示形式は以下の通りである

> Index\<id=インデックスId, index\_name=インデックス名\>

  - 「Title」テキストボックス  
    コミュニティのタイトルを入力する

  - 「Description」テキストボックス  
    説明を入力する

  - 「Page」テキストボックス  
    ページ数を入力する

  - 「Curation Policy」テキストボックス  
    ポリシーを入力する

  - 「Ranking」テキストボックス  
    ランキングの表示件数を入力する。デフォルトの値は「0」とする  
    数字のみ入力可能である。
    
      - 全角数字を入れた場合、作成時に半角になる。
    
      - 数字以外を入れて、作成した場合、作成時エラーメッセージを「Ranking」テキストボックスの下に表示する。  
        エラーメッセージ：無効な整数です。

  - 「Fixed Points」テキストボックス  
    固定点を入力する。デフォルトの値は「0」とする  
    数字のみ入力可能である。
    
      - 全角数字を入れた場合、作成時に半角になる。
    
      - 数字以外を入れて、作成した場合、作成時エラーメッセージを「Ranking」テキストボックスの下に表示する。  
        エラーメッセージ：無効な整数です。

<!-- end list -->

  - ［保存（Save）］ボタンを押すと、設定されたコミュニティの内容をコミュニティ一覧に追加させ、メッセージをコミュニティ一覧に表示させる  
    メッセージ：  
    　日本語：「レコードが正常に作成されました。」  
    　英語：「Record was successfully created.」

  - ［保存してもう一つ追加（Save and Add Another）］ボタンを押すと、設定されたコミュニティの内容をコミュニティ一覧に追加させ、他のコミュニティを追加設定可能とする。メッセージを画面上部に表示させる  
    メッセージ：  
    　日本語：「レコードが正常に作成されました。」  
    　英語：「Record was successfully created.」

  - ［保存して編集を続ける（Save and Continute Editing）］ボタンを押すと、設定されたコミュニティの内容をコミュニティ一覧に追加させ、該当コミュニティの編集を続けることを可能とする。メッセージを画面上部に表示させる  
    メッセージ：  
    　日本語：「レコードが正常に作成されました。」  
    　英語：「Record was successfully created.」

  - ［キャンセル（Cancel）］ボタンを押すと、設定されたコミュニティ内容をロール一覧に追加せず、「一覧」（List）タブに戻る

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > invenio\_communities

<!-- end list -->

  - > 処理概要

> 本画面は、flaskのModelViewでcommunities\_communityテーブルのメンテナンスを行う機能である
> 
> 本画面を操作すると、ModelView を継承するinvenio\_communities.admin. CommunityModelViewクラスのメソッドが呼び出される
> 
> 一覧（List）タブ表示時、編集（Edit）タブ表示時に、操作するユーザのロールを確認して、それらのidで最小のものが以下のコンフィグで指定する値より大きい場合にはModelViewとは異なる処理を行う

  - > パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-communities/invenio_communities/config.py#L165>

  - > 設定キー：COMMUNITIES\_LIMITED\_ROLE\_ACCESS\_PERMIT

> 一覧（List）タブ表示時に、index\_viewメソッド（WEKOソースでオーバーライドされていない）が呼び出される

  - > この中で呼び出されるget\_queryメソッドとget\_count\_queryメソッドでは、上記の分岐によるModelViewと異なる処理として、取得するコミュニティの絞り込みを行う
    
      - > id\_roleが操作するユーザのロールのidに含まれるものか、id\_userが操作するユーザのユーザidと一致するものだけに絞り込む

> 編集（Edit）タブ表示時に、edit\_viewメソッド（WEKOソースでオーバーライドされていない）が呼び出される

  - > この中で呼び出されるedit\_formメソッドでは、上記の分岐によるModelViewと異なる処理として、CommunityModelViewのインスタンスにindex\_id属性を追加して、入力フォームに「action」「edit」を追加する

> 作成（Create）、編集（Edit）タブで［保存（Save）］ボタンを押すと、\_validate\_input\_idメソッドでidのバリデーションチェックを行い、保存処理中のon\_model\_changeメソッドでレコードのid\_userカラムを操作ユーザのidで更新する

  - > 編集（Edit）タブでの保存時はidを編集できないため、実質的には作成（Create）タブでの保存時のみにバリデーションチェックしている

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### 注目のコミュニティ

  - > 目的・用途

※v0.9.22では使用しない

  - > 利用方法

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【Admin \> Communities \> Featured Community画面】に登録されたお気に入りのコミュニティが一覧に表示される
    
      - お気に入りのコミュニティが登録されない場合、登録されたアイテムがない旨のメッセージが一覧に表示される  
        メッセージ：  
        日本語：「表にはアイテムがありません。」  
        英語：「There are no items in the table.」
    
      - 表示項目は以下の通りである
        
          - アクション  
            目アイコン、鉛筆アイコン及びゴミ箱アイコンである
        
          - 「Community」  
            設定されたコミュニティである
        
          - 「Start Date」  
            設定された開始日である。フォーマット：「YYYY-MM-DD hh:mm:ss」
    
      - お気に入りのコミュニティ行に目アイコンを押すと、該当コミュニティの詳細情報を「詳細」（Details）タブに表示する
        
          - 表示項目は以下の通りである
            
              - 「Community」
            
              - 「Created」
            
              - 「Updated」
            
              - 「Start Date」
    
      - お気に入りのコミュニティ行に鉛筆アイコンを押すと、該当お気に入りのコミュニティを「編集」（Edit）タブに表示し、お気に入りのコミュニティの情報が編集できる
    
      - お気に入りのコミュニティ行にゴミ箱アイコンを押すと、該当お気に入りのコミュニティを削除し、メッセージを画面の上部に表示する  
        メッセージ：  
        日本語：「1 レコードが正常に削除されました。」  
        英語：「Record was successfully deleted.」
    
      - 行頭に表示されているチェックボックスにチェックを入れて、「選択」（Select）ボタンを押して、「削除」（Delete）ボタンを押すことで、複数のコミュニティが削除できる  
        また、全選択のチェックボックスですべてのコミュニティを選択できる
    
      - 「作成」（Create）ボタンを押すと、お気に入りのコミュニティの作成画面に移動する
        
          - 入力項目は以下の通りである
            
              - 「Community」
                
                  - コミュニティを選択する。必須項目である。デフォルトは1番目の項目とする
                
                  - 「Community」プルダウンの選択肢はシステムに作成されたコミュニティ一覧である
                
                  - 各コミュニティの表示形式は以下の通りである

> \<Community, ID:コミュニティID\>

  - 「Created」
    
      - お気に入りのコミュニティの作成日をカレンダーから選択または手入力する
    
      - カレンダーから日時を選択してから、「Apply」ボタンを押すと、入力された値が表示される。フォーマット：「YYYY-MM-DD hh:mm:ss」
    
      - 入力されたフォーマットが不正の場合、メッセージを入力欄に表示する  
        メッセージ：「Invalid date」
    
      - デフォルトは作成時刻とする

  - 「Updated」
    
      - お気に入りのコミュニティの更新日をカレンダーから選択または手入力する
    
      - 入力方法及びエラー処理は「Created」の同じとする

  - 「Start Date」
    
      - お気に入りのコミュニティの開始日をカレンダーから選択または手入力する
    
      - 入力方法及びエラー処理は「Created」の同じとする

<!-- end list -->

  - 「保存」（Save）ボタンを押すと、設定されたお気に入りのコミュニティの内容をお気に入りのコミュニティ一覧に追加させ、メッセージをお気に入りのコミュニティ一覧に表示させる  
    メッセージ：  
    　日本語：「レコードが正常に作成されました。」  
    　英語：「Record was successfully created.」

  - 「保存してもう一つ追加」（Save and Add Another）ボタンを押すと、設定されたお気に入りのコミュニティの内容をお気に入りのコミュニティ一覧に追加させ、他のお気に入りのコミュニティを追加設定可能とする。メッセージを画面上部に表示させる  
    メッセージ：  
    　日本語：「レコードが正常に作成されました。」  
    　英語：「Record was successfully created.」

  - 「保存して編集を続ける」（Save and Continute Editing）ボタンを押すと、設定されたお気に入りのコミュニティの内容をお気に入りのコミュニティ一覧に追加させ、該当お気に入りのコミュニティの編集を続けることを可能とする。メッセージを画面上部に表示させる  
    メッセージ：  
    　日本語：「レコードが正常に作成されました。」  
    　英語：「Record was successfully created.」

  - 「キャンセル」（Cancel）ボタンを押すと、設定されたお気に入りのコミュニティ内容をロール一覧に追加せず、「一覧」（List）タブに戻る

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - 
<!-- end list -->

  - > 処理概要

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>

### 参加リクエスト

  - > 目的・用途

※v0.9.22では使用しない

  - > 利用方法

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【 仕様の確認中 】
    
      - 
<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  -   - 
<!-- end list -->

  - > 処理概要
    
      - 
  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### ハーベスト

<!-- end list -->

  - > 目的・用途

本機能は、外部機関からデータを設定されたスキーマ形式で取得する機能である。

  - > 利用方法

【Administration＞OAI-PMH＞ハーベスト（Harvesting）】の順で画面遷移して利用する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

1\. OAI-PMHスキーマに対してマッピングを実施

  - > 【Administration \> アイテムタイプ管理（Item Types） \> マッピング（Mapping）】：作成されたOAI-PMHスキーマにマッピングを実施する画面である。実施についての詳細は[ADMIN1-2 マッピング](\\l)を参照するものとする。

2\. ハーベスト情報を設定

  - > 【Administration \> OAI-PMH \> ハーベスト（Harvesting）】で以下のハーベスト情報を設定。
    
      - Repository Name：メタデータ取得先のリポジトリ名称。必須項目。繰り返し不可。テキストを入力。
    
      - Base URL：メタデータ取得先のOAI-PMH出力APIのURL。必須項目。テキストを入力。
    
      - From Date：アイテム更新日時（期間‐開始日時）。カレンダーから選択。
    
      - Until Date：アイテム更新日時（期間‐終了日時）。カレンダーから選択。
    
      - Set Spec：アイテムをハーベストする条件を指定。テキストを入力。
    
      - Metadata Prefix：メタデータスキーマを指定。必須項目。  
        jpcoar, oai\_dc, ddi, jpcoar\_v1,jpcoar\_v2,lomのいずれかを入力する必要がある。前述の５つ以外でも登録は可能であるが、実行はできない。
    
      - Target Index：ハーベストされたアイテムに対して登録先インデックスを指定。必須項目。インデックスツリー一覧からプルダウン形式で選択。
    
      - Update Style：更新方法。Bulk/Differenceからプルダウン形式で選択。初期値はBulk。
        
          - Bulkを選択すると、ハーベストで取得したアイテムすべてをハーベスト対象とする。
        
          - Differenceを選択すると、ハーベストで取得したアイテムのうちdatestampが未来日のものだけをハーベスト対象とする。
    
      - Auto Distribution：子インデックスへの自動振り分けを指定。Run/Do not runから選択
        
          - Runを選択すると、登録先インデックス直下にハーベスト対象リポジトリのインデックスツリーを作成し、ハーベストで取得したアイテムがそれぞれのインデックスに配置される
        
          - Do not runを選択すると、登録先インデックス直下にはインデックスツリーが作成されず、ハーベストで取得したアイテムが登録先インデックス直下に全て配置される

<!-- end list -->

  - \[保存（Save）\]ボタンを押すと、設定されたハーベストレコードをHarvesting一覧に追加させ、メッセージをハーベスティング一覧に表示させる  
    メッセージ：「レコードが正常に作成されました。」

  - \[保存してもう一つ追加（Save Add Another）\]ボタンを押すと、設定されたハーベストレコードをHarvesting一覧に追加させ、他のリポジトリを追加設定可能とする。

  - \[保存して編集を続ける（Save and Continue Editing）\]ボタンを押すと、設定されたハーベストレコードをHarvesting一覧に追加させ、該当ハーベストレコードの編集を続けることを可能とする。

  - ハーベスト用アイテムタイプの用意については、[ADMIN1 アイテムタイプ管理](\\l)を参照。

3\. ハーベストを実行

  - 【前提条件】  
    【1.1. OAIスキーマに対してマッピングを実施】及び【1.2. ハーベスト情報を設定】が設定済み。

  - 【Administration \> OAI-PMH \> ハーベスト（Harvesting） 】から実行したいハーベストの左にある\[目\]ボタンを押して詳細画面へと遷移し、そこで\[Run\]ボタンを押すと、当該画面上の設定内容をもとにハーベストを実行する。
    
      - ハーベスト開始直後
        
          - ハーベストはCeleryタスクとして実行される。実行時のtask id をharvest\_settings テーブルの task\_idカラムに格納する。
    
      - ハーベスト処理
        
          - 「identifier」をキーとして以下の判定をおこなう。  
            「identifier」値はoaiserverで出力された値である。  
            フォーマット：「oai:invenio:recid/\<id\>」
            
              - WEKOリポジトリに存在しないものは新規登録をする。
            
              - 「identifier」が同じものはアイテムのメタデータ、アイテムのバージョン及び所属インデックスを更新する。
            
              - アイテムが削除されている(OAI-PMHの削除フラグがセットされている)ものはハーベストし、ハーベストされた場合、削除されてないアイテムとして登録する。
            
              - 非公開アイテムはハーベストし、ハーベストされた場合、公開アイテムとして登録する。
            
              - ハーベストの時に、対象のアイテムが削除された場合（ハーベスト先のリポジトリからdelete情報を受け取った際）最新バージョンが論理削除される。
    
      - ハーベスト後
        
          - ハーベストによりWEKOリポジトリに登録されたアイテムは、通常のアイテムと同様にメタデータの編集、所属インデックスの変更、アイテムの削除を実行する。ハーベストして登録したアイテムの公開日は"ハーベスト先のdatestamp"を設定し、公開ステータスは"公開"とする。
        
          - ハーベスト後にWEKOリポジトリで編集されたアイテムは、次回ハーベスト実行時に対象リポジトリのアイテムで上書き更新される。
        
          - ハーベスト後にWEKOリポジトリで削除されたアイテムでも、次回ハーベスト実行時に対象であった場合は、復活して上書き更新される。
        
          - harvest\_settings テーブルの task\_idカラムにnullを格納する。

  - ハーベストの実行中に\[中断（Suspected）\]ボタンを表示させる。\[中断（Suspected）\]ボタンを押すと、ハーベスト処理を中断する。

  - 中断したハーベスト処理に対して、中断した箇所から再開できる。

  - ハーベストの処理結果をメール通知できる。
    
      - 当該メールの宛先は、リポジトリ管理者 及び コミュニティ管理者 とする。
    
      - 通知タイミングは、ハーベスト処理が完了（中断など正常に終了しなかった場合を含む）した時点とする。
    
      - メール通知に使う言語は【Administration \> 設定（Setting） \> Language】に一番上の設定された言語とする。
    
      - 通知内容は、以下を含む
        
          - 処理ステータス（正常終了、中断、キャンセル、エラー）
        
          - 処理件数
        
          - 処理時間
        
          - 処理開始時刻
        
          - 処理終了時刻

  - ハーベスト処理が完了した時、OAI-PMHの各リクエストごとに対して、ElasticSearchにシステムログを出力する。
    
      - ハーベスト処理が成功になる場合、以下のような内容を出力する。  
        'task\_id': request.id
    
      - ハーベスト処理が失敗になる場合、以下のような内容を出力する。  
        'task\_state': 'FAILURE',  
        'start\_time': start\_time.strftime('%Y-%m-%dT%H:%M:%S%z'),  
        'end\_time': end\_time.strftime('%Y-%m-%dT%H:%M:%S%z'),  
        'total\_records': 0,  
        'execution\_time': str(end\_time - start\_time),  
        'task\_name': 'harvest',  
        'repository\_name': 'weko', \# TODO: Grab from config  
        'task\_id': request.id

4\. ハーベストのインターバル設定でハーベスト処理の定期実行を可能。

  - 【Administration \> OAI-PMH \> ハーベスト（Harvesting） 】から実行したいハーベストの左にある\[鉛筆\]ボタンを押して編集画面へと遷移し、ハーベストのインターバルを以下のように設定する。
    
      - 周期：Daily/Weekly/Monthlyから選択する。
        
          - Weeklyを選択すると、選択可能曜日一覧（Monday～Sunday）を右側に表示する。
        
          - Monthlyを選択すると、選択可能日一覧（01～30）を右側に表示する。
    
      - オン/オフを選択する。
        
          - オンを選択する場合、設定された実行間隔でハーベスト処理を自動実行する。
        
          - オフを選択する場合、ハーベスト処理は実行しない。

5\. OAI-PMHのハーベスト記録を確認可能

  - 【Administration \> OAI-PMH \> ハーベスト（Harvesting） 】から実行したいハーベストの左にある\[目\]ボタンを押して詳細画面へと遷移し、ハーベスト設定エリアの下側に実行履歴を表形式で表示する。  
    リストは新しいものを上から順に表示していく。
    
      - 履歴のリストの項番。
        
          - リンク形式で表示する。
        
          - リンクを押下すると、ハーベスト実行時の以下の情報をポップアップで表示する。
            
              - Repository Name
            
              - Base URL
            
              - From Date
            
              - Until Date
            
              - Set Spec
            
              - Metadata Prefix
            
              - Target Index
            
              - Update Style
            
              - Auto Distribution
    
      - 開始日時（Start Time）。フォーマット：YYYY-MM-DDThh:mm:ss.sTZD  
        例：2020-06-05T14:16:38.807296+09:00
        
          - ハーベスト処理を開始した（「Run」ボタンを押下した）時点の日時を記録する。
    
      - 終了日時（End Time）フォーマット：YYYY-MM-DDThh:mm:ss.sTZD
        
          - ハーベスト処理が完了した時点の日時を記録する。  
            エラーで終了した場合は、その日時を記録する。  
            また、管理者が\[中止（Cancel）\]ボタンを押下した際には、そのときの日時を記録する。
    
      - ステータス（Status）
        
          - ：現在ハーベストの処理を実施している状態。この状態のとき、終了日時は記録されない。
        
          - Successful：ハーベストの処理がエラー無く正常に終了した状態。
        
          - Failed：ハーベストの処理でエラーが発生して終了した状態。
        
          - Suspended：ハーベストの処理を管理者が\[Pause\]ボタンを押下している状態。この状態のときは終了日時は記録されない。  
            なお、中断から再開をした場合、状態は"実行中"となる。
        
          - Cancel：ハーベストの処理を管理者が\[Clear\]ボタンを押下して終了した状態
    
      - エラーメッセージ・URL（Error Message, Url）
        
          - ハーベストの処理が異常終了で終了したときにメッセージとリクエストURLが表示される。
            
              - エラーメッセージは、どのようなエラーが発生したのかを表示する（ログからエラーメッセージを取得して表示する）
            
              - URLはエラーが発生した時点でのリクエストURLを表示する（後々、どこまで登録できたのかをURLから追える）
    
      - 処理件数（Processed Items）
    
      - 登録件数（Created Items）
    
      - 更新件数（Updated Items）
    
      - 削除件数（Deleted Items）
    
      - エラー件数（Error Items）

  - 実行履歴の表示件数をコンフィグファイルに設定できる  
    設定キー：OAIHARVESTER\_NUMBER\_OF\_HISTORIES

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > invenio-oaiharvester

<!-- end list -->

  - > 処理概要

1\. 設定

> OAI-PMHハーベスト実行履歴の表示件数を設定

  - 設定内容：  
    OAIHARVESTER\_NUMBER\_OF\_HISTORIES = 20

  - パス： <https://github.com/RCOSDP/invenio-oaiharvester/blob/feature/weko/invenio_oaiharvester/config.py#L46>

<!-- end list -->

  - それぞれの取得されたアイテムを以下のように処理する
    
      - アイテムの「pid\_type」と「pid\_value」の値を元に、該当アイテムがリポジトリに存在するかどうかをチェックする
        
          - 存在しない場合、新規登録をする
            
              - 該当アイテムがどのハーベスト用アイテムタイプに属するか、確認する
                
                  - 「dc:type」の値を元に、ハーベスト用アイテムタイプを以下のように確定できる  
                    パス：   
                    https://github.com/RCOSDP/weko/blob/13c305a3048309dbda87a614ffedac18423820aa/modules/invenio-oaiharvester/invenio\_oaiharvester/harvester.py\#L1078

> RESOURCE\_TYPE\_MAP = {
> 
> 'conference paper': 'Conference Paper',
> 
> 'data paper': 'Journal Article',
> 
> 'departmental bulletin paper': 'Departmental Bulletin Paper',
> 
> 'editorial': 'Article',
> 
> 'journal article': 'Journal Article',
> 
> 'newspaper': 'Journal Article',
> 
> 'periodical': 'Article',
> 
> 'review article': 'Article',
> 
> 'software paper': 'Article',
> 
> 'article': 'Article',
> 
> 'book': 'Book',
> 
> 'book part': 'Book',
> 
> 'cartographic material': 'Others',
> 
> 'map': 'Others',
> 
> 'conference object': 'Presentation',
> 
> 'conference proceedings': 'Presentation',
> 
> 'conference poster': 'Presentation',
> 
> 'dataset': 'Data or Dataset',
> 
> 'interview': 'Others',
> 
> 'image': 'Others',
> 
> 'still image': 'Others',
> 
> 'moving image': 'Others',
> 
> 'video': 'Others',
> 
> 'lecture': 'Others',
> 
> 'patent': 'Others',
> 
> 'internal report': 'Others',
> 
> 'report': 'Research Paper',
> 
> 'research report': 'Research Paper',
> 
> 'technical report': 'Technical Report',
> 
> 'policy report': 'Others',
> 
> 'report part': 'Others',
> 
> 'working paper': 'Others',
> 
> 'data management plan': 'Others',
> 
> 'sound': 'Others',
> 
> 'thesis': 'Thesis or Dissertation',
> 
> 'bachelor thesis': 'Thesis or Dissertation',
> 
> 'master thesis': 'Thesis or Dissertation',
> 
> 'doctoral thesis': 'Thesis or Dissertation',
> 
> 'interactive resource': 'Others',
> 
> 'learning object': 'Learning Material',
> 
> 'manuscript': 'Others',
> 
> 'musical notation': 'Others',
> 
> 'research proposal': 'Others',
> 
> 'software': 'Software',
> 
> 'technical documentation': 'Others',
> 
> 'workflow': 'Others',
> 
> 'other': 'Others'
> 
> }

  - アイテムのメタデータにJPCOARスキーマの「dc:type」の値がない、または「dc:type」の値が上記の値に含まらない場合、デフォルトのハーベスト用アイテタイプ「Multiple」としてハーベストする。

<!-- end list -->

  - 新規アイテムの「pid\_id」、「pid\_value」の値を設定する。
    
      - 「pid\_id」= hvstid
    
      - 「pid\_value」= identifier値（oai:invenio:recid/\<id\>）

<!-- end list -->

  - 存在している場合、アイテムのメタデータおよび所属インデックスを更新する。

  - 削除されている(OAI-PMHの削除フラグがセットされている)アイテムは、WEKOリポジトリに登録されているアイテムを削除する

  - 非公開アイテムは、「公開アイテム」とする

  - current\_userの条件を追加し、ない場合user\_idを1を設定 

<!-- end list -->

  - ハーベストが完了する時、ハーベスト結果を表に総計する。  
    詳細は「4.1.5. OAI-PMHのハーベスト記録を確認可能」になる。

(2)ハーベスト実行中に、\[Clear\]ボタンを押すと、ハーベスト処理がキャンセルとする。

  - 実行ステータスの状況をメール通知する。  
    メールテンプレート：https://github.com/RCOSDP/weko/blob/13c305a3048309dbda87a614ffedac18423820aa/modules/invenio-oaiharvester/invenio\_oaiharvester/templates/invenio\_oaiharvester/run\_stat\_mail.html\#L27C11-L27C11

(3)ハーベスト実行中に、\[Pause\]ボタンを押すと、ハーベスト処理が中断とする  
中断したハーベスト処理に\[Resume\]ボタンを押すと、ハーベスト処理が再開とする

(4)ハーベストのインターバル設定があれば、設定時間の通りにハーベスト処理を定期実行する。

(5)ハーベスト処理が完了した時、OAI-PMHの各リクエストに対して、ElasticSearchにシステムログをinvenio\_stats.contrib.event\_builders.celery\_task\_event\_builderで出力する。

  - ハーベスト処理が成功になる場合、以下のような内容を出力する。  
    （ここでいう成功とは、処理が最後まで正常に行われたことを示している。）  
    'task\_id': request.id  
    'task\_state': 'SUCCESS',  
    'task\_name': 'harvest',  
    'start\_time': start\_time.strftime('%Y-%m-%dT%H:%M:%S%z'),  
    'end\_time': end\_time.strftime('%Y-%m-%dT%H:%M:%S%z'),  
    'total\_records': 0,  
    'repository\_name': 'weko',  
    'execution\_time': str(end\_time - start\_time),

  - ハーベスト処理が失敗になる場合、以下のような内容を出力する。  
    （ここでいう失敗とは、処理が最後まで行われなかったことを示している。）  
    'task\_id': request.id,  
    'task\_state': 'FAILURE',  
    'task\_name': 'harvest',  
    'start\_time': start\_time.strftime('%Y-%m-%dT%H:%M:%S%z'),  
    'end\_time': end\_time.strftime('%Y-%m-%dT%H:%M:%S%z'),  
    'total\_records': 0,  
    'execution\_time': str(end\_time - start\_time),  
      
    'repository\_name': 'weko',

**2.Harvesting画面について**

  - > **一覧タブ  
    > invenio\_oaiharvester.admin.HarvestSettingViewが継承しているModelViewにより、**flask\_admin.model.base.index\_view **が呼び出され、db内のharvest\_settingsの情報を取得し表示している。  
    > \[run\]ボタン：詳細画面から押下可能。押下時にinvenio\_oaiharvester.admin.runが呼び出され、ハーベストが実行される。  
    > \[Pause\]ボタン：ハーベスト実行中にのみ押下可能。押下時にinvenio\_oaiharvester.admin.pauseが呼び出され、ハーベストを中断する。その後\[Resume\]ボタン押下で処理を再開する。**

  - > **作成タブ・編集タブ  
    > invenio.oaiharvester.admin.HarvestSettingView.edit\_viewが呼び出され、作成画面もしくは編集画面へと遷移する。必須項目を入力後、保存処理をすることでdb内のharvester\_settingsが更新される。**

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### Identify

  - > 目的・用途

本機能は、Identifyの作成・編集を行う機能である。Identifyとは、リポジトリに関する情報を検索する場合に使用されるものである。

  - > 利用方法

【Administration＞OAI-PMH＞Identify】の順で画面遷移して利用する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - Identify出力に対してリポジトリの情報を設定可能
    
      - 設定内容
        
          - Output Set：チェックボックス
            
              - チェックボックスにチェックを入れる場合、OAI-PMHリクエストに対して、正常レスポンスを返す。
            
              - チェックボックスにチェックを入れない場合、OAI-PMHリクエストに対して、エラーレスポンスを返す。  
                [エラーと例外状況](https://www.nii.ac.jp/irp/archive/translation/oai-pmh2.0/OpenArchivesProtocol.htm#ErrorConditions)
        
          - Emails：管理者メールアドレスを入れる。
        
          - Repository Name：リポジトリ名を入れる。
        
          - Earliest Datastamp：Identifyの作成時間を自動で入れる。  
            フォーマット：YYYY-MM-DD HH:MM:SS
    
      - \[保存（Save）\]ボタンを押すと、設定された内容をIdentify一覧に追加させ、メッセージをIdentify一覧に表示させる  
        メッセージ：「レコードが正常に作成されました。（Record was successfully saved）」
    
      - \[保存して編集を続ける（Save and Continue Editing）\]ボタンを押すと、メッセージを編集画面での上端に表示させ、作成されたIdentiftyの編集を続けることを可能とする。  
        メッセージ：「レコードが正常に作成されました。（Record was successfully saved）」
    
      - 1つのリポジトリに対して1つしか登録できない。

  - OAI-PMHのIdentify情報を返戻可能

【Admin \> OAI-PMH \> Identify画面】上の設定値に基づき、OAI-PMHのIdentifyリクエスト(verb=Identify)に対してレスポンス可能とする。詳細は[Web-API API-2:OAI-PMH](#_OAI-PMH)を参照。

  - > 関連モジュール

<!-- end list -->

  - > Invenio-oaiserver

<!-- end list -->

  - > 処理概要

> 画面表示について

  - > 一覧タブ  
    > invenio\_oaiserver.admin.IdentifyModelViewが継承しているModelViewからflask\_admin.model.base.index\_viewが呼び出され、db内のoaiserver\_identifyテーブルより情報を取得し画面に表示する。

  - > 編集タブ  
    > \[鉛筆\]ボタン押下時、invenio\_oaiserver.admin.IdentifyModelViewが継承しているModelViewからflask\_admin.model.base.edit\_viewが呼び出され、db内のoaiserver\_identifyテーブルより情報を取得し編集画面へ遷移する。
    
      - > 編集画面で\[保存（Save）\]ボタンもしくは\[保存して編集を続ける（Save and Continue Editing）\]を押下時、flask\_admin.model.base.edit\_viewが呼び出され、編集内容をdb内のoaiserver\_identifyテーブルに保存し、更新する。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>

### Sets

  - > 目的・用途

本機能は、setの作成・編集・削除を行う機能である。Setとは、選択的ハーベスティングを行う目的でアイテムをグループ化するための任意の構成隊のことを示す。

  - > 利用方法

【Administration＞OAI-PMH＞Sets】の順で画面遷移して利用する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【Administration \> OAI-PMH \> Sets 】：アイテムをグループ化する情報を設定可能。
    
      - 設定内容
        
          - Created、Updated：カレンダーから選択可能。  
            フォーマット：YYYY-MM-DD HH:MM:DD」  
            デフォルト：現在のシステム時刻を自動的に入れる
        
          - Spec：スペックの情報を入れる。ユニークとする。入力必須項目。
        
          - Name：セットの命名を入れる
        
          - Description：セットの説明を入れる
        
          - Search Pattern
    
      - 「保存（Save）」ボタンを押すと、設定されたセット内容をセット一覧に追加させ、メッセージをセット一覧に表示させる  
        メッセージ：「レコードが正常に作成されました。（Record was successfully saved）」
    
      - \[保存してもう一つ追加（Save Add Another）\]ボタンを押すと、設定されたセット内容をセット一覧に追加させ、他のセットを追加設定可能とする。
    
      - \[保存して編集を続ける（Save and Continue Editing）\]ボタンを押すと、設定されたセット内容をセット一覧に追加させ、該当セットの編集を続けることを可能とする。
    
      - Sets一覧は、更新日時降順で表示されている。

  - 使い方
    
      - 【ハーベスト機関元】
        
          - 【Administration \>コミュニティ管理（ Communities） \>コミュニティ（Community）】においてコミュニティを新規作成すると、  
            作成されたコミュニティに対して、【Administration \> OAI-PMH \> Sets】に以下のセットが自動作成される。  
            「Spec」：「user-」+ コミュニティID  
            「Name」：コミュニティID  
            「Updated」、「Created」：セット作成時間
        
          - OAISetにそれぞれのアイテムを登録する際は以下のコマンドを実行する。  
            「community\_id」：該当コミュニティ  
            「record\_id」：アイテムのuuid値

> docker-compose exec web invenio communities request -a community\_id record\_id

  - 【ハーベスト機関先】  
    ハーベスト設定画面での「Set Spec」に該当「Spec」値をいれば、登録アイテムをハーベストできる。

<!-- end list -->

  - 
<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > Invenio\_oaiserver

<!-- end list -->

  - > 処理概要

> 画面表示について

  - > 一覧タブ  
    > invenio\_oaiserver.admin.OAISetModelViewが継承しているModelViewからflask\_admin.model.base.index\_viewが呼び出され、db内のoaiserver\_setテーブルより情報を取得し画面に表示する。

  - > 編集タブ  
    > \[鉛筆\]ボタン押下時、invenio\_oaiserver.admin.OAISetModelViewが継承しているModelViewからflask\_admin.model.base.edit\_viewが呼び出され、db内のoaiserver\_setテーブルより情報を取得し編集画面へ遷移する。
    
      - > 編集画面で\[保存（Save）\]ボタンもしくは\[保存して編集を続ける（Save and Continue Editing）\]を押下時、flask\_admin.model.base.edit\_viewが呼び出され、編集内容をdb内のoaiserver\_setテーブルに保存し、更新する。

  - > 作成タブ  
    > 作成タブに遷移時、invenio\_oaiserver.admin.OAISetModelViewが継承しているModelViewからflask\_admin.model.base.create\_viewが呼び出される。
    
      - > 情報の入力後に\[保存（Save）\]ボタン押下すると、invenio\_oaiserver.admin.OAISetModelViewが継承しているModelViewからflask\_admin.model.base.create\_viewが呼び出され、新しいSetの情報をdb内のoaiserverテーブルに保存する。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### Resource List

<!-- end list -->

  - > 目的・用途

公開インデックスごとに「Resource List」、「Resource Dump」を出力する

  - > 利用方法

【Administration \> Resource Sync \> Resource List画面】にて操作を行う

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - Resource Listの仕様：   
    <http://www.openarchives.org/rs/1.1/resourcesync#ResourceList>

  - Resource List Indexの仕様：   
    <http://www.openarchives.org/rs/1.1/resourcesync#ResourceListIndex>

  - Resource Dumpの仕様：   
    <http://www.openarchives.org/rs/1.1/resourcesync#ResourceDump>

  - 【Resource List画面】には以下のタブが表示される
    
      - List
    
      - Create
    
      - Edit
        
          - > 「List」、「Create」タブ選択中は非表示
        
          - > 「List」タブでの操作によって表示される
        
          - 他のタブに移動すると非表示になる

  - 「List」タブにて存在するResourceを一覧表示する
    
      - 「List」タブを表示するたびに最新の情報を取得する
    
      - 表示項目は以下の通りである
        
          - アクション（編集・削除を表すアイコン）
        
          - Repository
            
              - そのResource Listが対象とするインデックス
            
              - フォーマット：「{インデックスの英語名} \<ID:インデックスID\>」
        
          - Resource List Url
            
              - 「Resource List」のURLを表示する
        
          - Resource Dump Url
            
              - 「Resource Dump」のURLを表示する
        
          - Status
            
              - Private/Publish

  - 「Create」タブにて「Resource List」、「Resource Dump」レコードを作成する
    
      - 入力情報は以下の通りである
        
          - Status
            
              - インデックスのステータスを選択する
            
              - ラジオボタン：Publish、Private
            
              - デフォルト：選択無し
        
          - Repository
        
          - > 対象とするインデックスを指定する
        
          - Resource Dump Manifest
            
              - Resource Dumpごとに「manifest.xml」ファイルを出力するかどうかを設定する
            
              - チェックが入っている場合に出力する
            
              - デフォルト：チェック無し
        
          - Resource List uri
            
              - 「Repository」で選択しているインデックスに応じて、「Resource List」のURIを自動的に表示する
            
              - テンプレートのURL：「https://{weko\_url}/resync/{Index ID}/resourcelist.xml」
            
              - 変更不可、無効の状態とする
        
          - Resource Dump uri
            
              - 「Repository」で選択しているインデックスに応じて、「Resource Dump」のURIを自動的に表示する
            
              - テンプレートのURL：「https://{weko\_url}/resync/{Index ID}/resourcedump.xml」
            
              - 変更不可、無効の状態とする
    
      - ［Create］ボタンを押すと、入力内容をチェックし、問題がなければ、「Resource List」レコードを作成し、「List」タブに移動する
        
          - エラーの場合は以下の通りである
            
              - 既に設定されたインデックスを選択している場合、以下のようなエラーメッセージを表示する  
                エラーメッセージ：「Selected repository has been registered already. Please select another repository.」
        
          - 「Status」がチェックなしのままでレコードを作成する場合は、Publishが設定される
    
      - ［Create and Add Another］ボタンを押すと、［Create］ボタンを押したときと同様の処理によって設定された内容のレコードを作成して、タブを移動せずに他の「Resource List」を作成可能とする
    
      - ［Cancel］ボタンを押すと、設定された「Resource List」を追加せずに、「List」タブに移動する

  - 公開インデックスごとに「Resource List」、「Resource Dump」を出力する
    
      - 「Status：Publish」の場合、「Resource List」及び「Resource Dump」を出力する
    
      - 「Resource List」を出力する
        
          - 「List」タブにて「Resource List Url」列のURLを押すと、該当する「Resource List」を出力して、ブラウザで表示する
            
              - 「Resource List」の表示項目は以下の通りである
                
                  - 表示フォーマット：XML
                
                  - 「capability.xml」のURL
                
                  - Capabilityのタイプ：resourcelist
                
                  - 該当インデックスに属するアイテム一覧
                    
                      - \<loc\>：アイテムのURL
                    
                      - \<lastmod\>：アイテムの更新日付。フォーマット：YYYY-MM-DDThh:mm:ss.ttttttZ
        
          - 「Resource List」のサンプル

> **\<urlset** xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xmlns:rs="http://www.openarchives.org/rs/terms/"**\>**
> 
> **\<rs:ln** href="https://18.182.214.241:8024/resync/capability.xml" rel="up"**/\>**
> 
> **\<rs:md** capability="resourcelist"**/\>**
> 
> **\<url\>**
> 
> **\<loc\>**https://18.182.214.241:8024/resync/1594710457918/records/29**\</loc\>**
> 
> **\<lastmod\>**2020-07-14T10:27:28.329486Z**\</lastmod\>**
> 
> **\</url\>**
> 
> **\<url\>**
> 
> **\<loc\>**https://18.182.214.241:8024/resync/1594710457918/records/30**\</loc\>**
> 
> **\<lastmod\>**2020-07-14T08:06:35.785168Z**\</lastmod\>**
> 
> **\</url\>**
> 
> **\<url\>**
> 
> **\<loc\>**https://18.182.214.241:8024/resync/1594710457918/records/32**\</loc\>**
> 
> **\<lastmod\>**2020-07-14T08:30:04.372277Z**\</lastmod\>**
> 
> **\</url\>**
> 
> **\</urlset\>**

  - 「Resource Dump」を出力する
    
      - 「List」タブにて「Resource Dump Url」列のURLを押すと、該当する「Resource Dump」を出力して、ブラウザで表示する
        
          - 「Resource Dump」の表示項目は以下の通りである
            
              - 表示フォーマット：XML
            
              - 「capability.xml」のURL
            
              - Capabilityのタイプ：resourcedump
            
              - 該当インデックスに属するアイテム一覧
            
              - > \<loc\>：該当インデックスに属されるアイテムに登録されているファイルのZipパッケージのURL
            
              - > \<lastmod\>：アイテムの更新日付。フォーマット：YYYY-MM-DDThh:mm:ss.ttttttZ
            
              - > 該当「resource Dump Manifest」のURL(「Resource Dump」詳細画面での設定に応じて表示する)
    
      - 「Resource Dump」のサンプル

> **\<urlset** xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xmlns:rs="http://www.openarchives.org/rs/terms/"**\>**
> 
> **\<rs:ln** href="https://18.182.214.241:8024/resync/capability.xml" rel="up"**/\>**
> 
> **\<rs:md** capability="resourcedump"**/\>**
> 
> **\<url\>**
> 
> **\<loc\>**https://18.182.214.241:8024/resync/1594710457918/29/file\_content.zip**\</loc\>**
> 
> **\<lastmod\>**2020-07-14T10:27:28.329486Z**\</lastmod\>**
> 
> **\<rs:ln** href="https://18.182.214.241:8024/resync/1594710457918/29/resourcedump\_manifest.xml" rel="contents" type="application/xml"**/\>**
> 
> **\</url\>**
> 
> **\<url\>**
> 
> **\<loc\>**https://18.182.214.241:8024/resync/1594710457918/30/file\_content.zip**\</loc\>**
> 
> **\<lastmod\>**2020-07-14T08:06:35.785168Z**\</lastmod\>**
> 
> **\<rs:ln** href="https://18.182.214.241:8024/resync/1594710457918/30/resourcedump\_manifest.xml" rel="contents" type="application/xml"**/\>**
> 
> **\</url\>**
> 
> **\<url\>**
> 
> **\<loc\>**https://18.182.214.241:8024/resync/1594710457918/32/file\_content.zip**\</loc\>**
> 
> **\<lastmod\>**2020-07-14T08:30:04.372277Z**\</lastmod\>**
> 
> **\<rs:ln** href="https://18.182.214.241:8024/resync/1594710457918/32/resourcedump\_manifest.xml" rel="contents" type="application/xml"**/\>**
> 
> **\</url\>**
> 
> **\</urlset\>**

  - 「Status：Private」の場合、または対象インデックスが「公開しない」と設定する場合、「Resource List」及び「Resource Dump」を出力すると、以下のようなエラーメッセージを表示する  
    エラーメッセージ：  
    　　　　　　　JP：「ページが見つかりません。」  
    　　　　　　　EN：「Page not found」

<!-- end list -->

  - 「List」タブ各行の鉛筆アイコンをクリックすると、「Edit」タブに移動してその行のレコードを表示し、内容を編集できる
    
      - 入力情報は、「Create」タブと同じである
    
      - ［Save］ボタンを押すと、編集内容を保存して「List」タブに移動する
    
      - ［Cancel］ボタンを押すと、編集内容を保存せず「List」タブに移動する

  - 「List」タブ各行のごみ箱アイコンをクリックすると、確認ダイアログを表示する  
    メッセージ：「Are you sure to delete it ?」
    
      - ［OK］ボタンを押すと、該当レコードを削除する
    
      - ［キャンセル］ボタンを押すと、確認ダイアログを閉じる

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > invenio\_resourcesyncserver

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - Resource Sync処理実行時、テンポラリディレクトリのファイル名を以下のように設定する
    
      - /home/invenio/.virtualenvs/invenio/var/instance/data/tmp/weko\_resync\_xxxxxxxx

  - 以下のopenarchivesのサイトにSource Descriptionの仕様を確認できる
    
      - <http://www.openarchives.org/rs/1.1/resourcesync#SourceDesc>

  - WEKOには、以下の機能に対応している
    
      - Resource List:
        
          - 参照リンク: <http://www.openarchives.org/rs/1.1/resourcesync#ResourceList>
    
      - Change List:
        
          - 参照リンク: <http://www.openarchives.org/rs/1.1/resourcesync#ChangeList>
    
      - Resync: Resource ListとChange Listから構成され、ハーベスト機能と同じ。他のサイトからの情報を取得し登録する。

  - 本画面では、resourcelist\_indexesテーブルの情報を閲覧、作成、編集、削除する
    
      - 画面表示時に、invenio\_resourcesyncserver.admin.AdminResourceListView.indexメソッドによってテンプレートを指定する
        
          - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-resourcesyncserver/invenio_resourcesyncserver/config.py#L21>
        
          - 設定キー：INVENIO\_RESOURCESYNCSERVER\_ADMIN\_TEMPLATE
    
      - 「List」タブの表示時に、同クラスのget\_listメソッドによってテーブルの情報を全件取得する
        
          - 画面の「Resource List Url」と「Resource Dump Url」の表示内容は、内容の表示時にresource.js中でそれぞれ「url\_path」フィールドの値に「/resourcelist.xml」「/resourcedump.xml」を結合して作成している
        
          - 「status」フィールドは真偽値であるが、内容の表示時にresource.js中でフィールドの値によって「Publish」か「Private」を表示するようにしている
    
      - 「Create」タブで［Create］ボタンを押したとき、同クラスのcreateメソッドによって、テーブルに対象インデックスについてのレコードがない場合に、新たにレコードを作成する
        
          - 対象インデックスについてのレコードがすでにあった場合には、作成せずに以下のコンフィグで指定されたメッセージを返す
            
              - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-resourcesyncserver/invenio_resourcesyncserver/config.py#L44-L45>
            
              - 設定キー：VALIDATE\_MESSAGE
    
      - 「Edit」タブで［Save］ボタンを押したとき、同クラスのupdateメソッドによってレコードを更新する
    
      - 「List」タブでごみ箱アイコンを押したとき、同クラスのdeleteメソッドによってレコードを物理削除する

  - 公開インデックスごとに「Resource List」、「Resource Dump」を出力する
    
      - 「Resource List」を出力する
        
          - 「List」タブにて「Resource List Url」列のURLを押すと、invenio\_resourcesyncserver.views.resource\_list関数が呼び出される
            
              - この中で、invenio\_resourcesyncserver.api.ResourceListHandler. get\_resource\_list\_xmlメソッドによってresourcelist.xmlを出力する
    
      - 「Resource Dump」を出力する
        
          - 「List」タブにて「Resource Dump Url」列のURLを押すと、invenio\_resourcesyncserver.views.resource\_dump関数が呼び出される
            
              - この中で、invenio\_resourcesyncserver.api.ResourceListHandler. get\_resource\_dump\_xmlメソッドによってresourcedump.xmlを出力する

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### Change List

  - > 目的・用途

公開インデックスごとに「Change List」、「Change Dump」を出力する

  - > 利用方法

【Administration \> Resource Sync \> Change List画面】で操作を行う

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - Change Listの仕様： <http://www.openarchives.org/rs/1.1/resourcesync#ChangeList>

  - Change Dumpの仕様： <http://www.openarchives.org/rs/1.1/resourcesync#ChangeDump>

  - 【Change List画面】で表示されるタブは、【Resource List画面】と同様である。[ADMIN-10-1: Resource List](\\l)を参照すること

  - 「List」タブにて存在するChange Listを一覧表示する
    
      - 「List」タブを表示するたびに最新の情報を取得する
    
      - 表示項目は以下の通りである
        
          - アクション（編集・削除を表すアイコン）
        
          - Repository
            
              - そのChange Listが対象とするインデックス
            
              - フォーマット：「{インデックスの英語名} \<ID:インデックスID\>」
        
          - Change List Url
            
              - 「Change List」のURLを表示する
        
          - Change Dump Url
            
              - 「Change Dump」のURLを表示する
        
          - Status
            
              - Private/Publish

  - 「Create」タブにて「Change List」、「Change Dump」レコードを作成する
    
      - 入力情報は以下の通りである
        
          - Status
            
              - インデックスのステータスを選択する
            
              - ラジオボタン：Publish、Private
            
              - デフォルト：選択無し
        
          - Repository
            
              - 対象とするインデックスを指定する
        
          - Publish date
            
              - フォーマット：MM/DD/YYYY
            
              - デフォルト：当日
        
          - Max change list
            
              - デフォルト：10000
        
          - Interval by date
            
              - 自動実行する日間隔を設定する
            
              - デフォルト：1
        
          - Change tracking state
            
              - チェックボックス：Created、Updated、Deleted
            
              - デフォルト：すべてのチェックボックスにチェックを入れる
        
          - Change dump manifest
            
              - 「Change Dump」ごとに「manifest.xml」ファイルを出力するかどうかを設定する
            
              - デフォルト：チェック無し
        
          - Change List uri
            
              - 「Repository」で選択しているインデックスに応じて、「Change List」のURIを自動的に表示する
            
              - テンプレートのURL：「https://{weko\_url}/resync/{Index ID}/changelist.xml」
            
              - 変更不可、無効の状態とする
        
          - Change Dump uri
            
              - 「Repository」で選択しているインデックスに応じて、「Change Dump」のURIを自動的に表示する
            
              - テンプレートのURL：「https://{weko\_url}/resync/{Index ID}/changedump.xml」
            
              - 変更不可、無効の状態とする
    
      - ［Create］ボタンを押すと、入力内容をチェックし、問題がなければ、「Change List」のレコードを作成し、「List」タブに移動する
        
          - エラーの場合は以下の通りである
            
              - 既に設定されたインデックスを選択している場合、以下のようなエラーメッセージを表示する  
                エラーメッセージ：「Selected repository has been registered already. Please select another repository.」
        
          - 「Status」がチェックなしのままでレコードを作成する場合は、Privateが設定される
    
      - ［Create and Add Another］ボタンを押すと、［Create］ボタンを押したときと同様の処理によって設定された内容のレコードを作成して、タブを移動せずに他の「Change List」を作成可能とする
    
      - ［Cancel］ボタンを押すと、設定された「Change List」を追加せずに、「List」タブに移動する

  - 公開インデックスごとに「Change List」、「Change Dump」を出力する
    
      - 「Status：Publish」の場合、「Change List」及び「Change Dump」を出力する
        
          - 「Change List」を出力する
            
              - 「List」タブより「Change List Url」列でのURLを押すと、ブラウザで該当する「Change List」を表示する
            
              - 「Change List」の表示項目は以下の通りである
                
                  - 表示フォーマット：XML
                
                  - 「capability.xml」のURL
                
                  - Capabilityのタイプ：changelist
                
                  - 該当インデックスに属される更新済みアイテム一覧の「Change List」
                    
                      - 日ごとにアイテムをまとめる
                    
                      - テンプレートのURL：「https://{weko\_url}/resync/{Index ID}/{YYYYMMDD}/changelist.xml」
                
                  - from-until：「Change List」ごとに対象日
                    
                      - フォーマット：YYYY-MM-DDThh:mm:ssZ
            
              - 「Change List一覧」のサンプル

> **\<urlset** xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xmlns:rs="http://www.openarchives.org/rs/terms/"**\>**
> 
> **\<rs:ln** href="https://18.182.214.241:8024/resync/capability.xml" rel="up"**/\>**
> 
> **\<rs:md** capability="changelist"**/\>**
> 
> **\<url\>**
> 
> **\<loc\>**https://18.182.214.241:8024/resync/1594710457918/20200717/changelist.xml**\</loc\>**
> 
> **\<rs:md** capability="changelist" from="2020-07-17T00:00:00Z" until="2020-07-18T00:00:00Z"**/\>**
> 
> **\</url\>**
> 
> **\<url\>**
> 
> **\<loc\>**https://18.182.214.241:8024/resync/1594710457918/20200718/changelist.xml**\</loc\>**
> 
> **\<rs:md** capability="changelist" from="2020-07-18T00:00:00Z" until="2020-07-19T00:00:00Z"**/\>**
> 
> **\</url\>**
> 
> **\<url\>**
> 
> **\<loc\>**https://18.182.214.241:8024/resync/1594710457918/20200719/changelist.xml**\</loc\>**
> 
> **\<rs:md** capability="changelist" from="2020-07-19T00:00:00Z" until="2020-07-20T00:00:00Z"**/\>**
> 
> **\</url\>**
> 
> **\<url\>**
> 
> **\<loc\>**https://18.182.214.241:8024/resync/1594710457918/20200720/changelist.xml**\</loc\>**
> 
> **\<rs:md** capability="changelist" from="2020-07-20T00:00:00Z" until="2020-07-20T08:59:58.606915Z"**/\>**
> 
> **\</url\>**
> 
> **\</urlset\>**

  - 「Change List」を出力する  
    出力された「Change List一覧」より、日ごとの「Change List」を出力する
    
      - 「Change List」に表示項目は以下の通りである
        
          - 表示フォーマット：XML
        
          - 「capability」のURL
        
          - 属される「Change List一覧」のURL
        
          - Capabilityのタイプ：changelist
        
          - アイテムに登録されているファイルのURL
        
          - \<lastmod\>：アイテムの更新日付
        
          - 「change」タイプ：created、updated、deleted
    
      - 「Change List」のサンプル

> **\<urlset** xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xmlns:rs="http://www.openarchives.org/rs/terms/"**\>**
> 
> **\<rs:ln** href="https://18.182.214.241:8024/resync/capability.xml" rel="up"**/\>**
> 
> **\<rs:ln** href="https://18.182.214.241:8024/resync/1594710457918/changelist.xml" rel="index"**/\>**
> 
> **\<rs:md** capability="changelist"**/\>**
> 
> **\<url\>**
> 
> **\<loc\>**https://18.182.214.241:8024/resync/1594710457918/records/55**\</loc\>**
> 
> **\<lastmod\>**2020-07-22T01:17:12.177328Z**\</lastmod\>**
> 
> **\<rs:md** at="2020-07-22T01:17:12.177328Z" change="created"**/\>**
> 
> **\</url\>**
> 
> **\</urlset\>**

  - 「Change Dump一覧」を出力する
    
      - 「Change List」の「List」タブより「Change Dump Url」列でのURLを押すと、該当する「Change Dump一覧」にアクセスする
    
      - 「Change Dump一覧」に表示項目は以下の通りである
        
          - 表示フォーマット：XML
        
          - 「capability」のURL
        
          - Capabilityのタイプ：changedump
        
          - 該当インデックスに属されるアイテムのZipパッケージにアクセスできる「Change Dump」
            
              - 日ごとにアイテムをまとめる
            
              - テンプレートのURL：「https://{weko\_url}/resync/{Index ID}/{YYYYMMDD}/changelist.xml」
        
          - from-until：「Change Dump」ごとに対象日
            
              - フォーマット：YYYY-MM-DDThh:mm:ssZ
    
      - 「Change Dump一覧」のサンプル

> **\<urlset** xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xmlns:rs="http://www.openarchives.org/rs/terms/"**\>**
> 
> **\<rs:ln** href="https://18.182.214.241:8024/resync/capability.xml" rel="up"**/\>**
> 
> **\<rs:md** capability="changedump"**/\>**
> 
> **\<url\>**
> 
> **\<loc\>**https://18.182.214.241:8024/resync/1594710457918/20200717/changedump.xml**\</loc\>**
> 
> **\<rs:md** capability="changedump" from="2020-07-17T00:00:00Z" until="2020-07-18T00:00:00Z"**/\>**
> 
> **\</url\>**
> 
> **\<url\>**
> 
> **\<loc\>**https://18.182.214.241:8024/resync/1594710457918/20200718/changedump.xml**\</loc\>**
> 
> **\<rs:md** capability="changedump" from="2020-07-18T00:00:00Z" until="2020-07-19T00:00:00Z"**/\>**
> 
> **\</url\>**
> 
> **\<url\>**
> 
> **\<loc\>**https://18.182.214.241:8024/resync/1594710457918/20200719/changedump.xml**\</loc\>**
> 
> **\<rs:md** capability="changedump" from="2020-07-19T00:00:00Z" until="2020-07-20T00:00:00Z"**/\>**
> 
> **\</url\>**
> 
> **\<url\>**
> 
> **\<loc\>**https://18.182.214.241:8024/resync/1594710457918/20200720/changedump.xml**\</loc\>**
> 
> **\<rs:md** capability="changedump" from="2020-07-20T00:00:00Z" until="2020-07-20T09:01:55.926748Z"**/\>**
> 
> **\</url\>**
> 
> **\</urlset\>**

  - 「Change Dump」を出力する  
    出力された「Change Dump一覧」より、日ごとの「Change Dump」を出力する
    
      - 「Change Dump」に表示項目は以下の通りである
        
          - 表示フォーマット：XML
        
          - 「capability」のURL
        
          - 属される「Change Dump一覧」のURL
        
          - Capabilityのタイプ：changedump
        
          - アイテムに登録されているファイルのZipパッケージのURL
        
          - \<lastmod\>：アイテムの更新日付
    
      - 「Change Dump」のサンプル

> **\<urlset** xmlns="http://www.sitemaps.org/schemas/sitemap/0.9" xmlns:rs="http://www.openarchives.org/rs/terms/"**\>**
> 
> **\<rs:ln** href="https://18.182.214.241:8024/resync/capability.xml" rel="up"**/\>**
> 
> **\<rs:ln** href="https://18.182.214.241:8024/resync/1594710457918/changedump.xml" rel="index"**/\>**
> 
> **\<rs:md** capability="changedump"**/\>**
> 
> **\<url\>**
> 
> **\<loc\>**https://18.182.214.241:8024/resync/1594710457918/49.1/change\_dump\_content.zip**\</loc\>**
> 
> **\<lastmod\>**2020-07-21T03:47:43.254174Z**\</lastmod\>**
> 
> **\<rs:md** from="2020-07-21T03:47:43.254174Z" type="application/zip" until="2020-07-21T05:44:21.697630Z"**/\>**
> 
> **\</url\>**
> 
> **\<url\>**
> 
> **\<loc\>**https://18.182.214.241:8024/resync/1594710457918/50.1/change\_dump\_content.zip**\</loc\>**
> 
> **\<lastmod\>**2020-07-21T05:43:05.066272Z**\</lastmod\>**
> 
> **\<rs:md** from="2020-07-21T05:43:05.066272Z" type="application/zip" until="2020-07-21T05:44:21.698327Z"**/\>**
> 
> **\</url\>**
> 
> **\</urlset\>**

  - 「Status：Private」の場合、、または対象インデックスが「公開しない」と設定する場合、「Change List」及び「Change Dump」を出力すると、以下のようなエラーメッセージを表示する  
    エラーメッセージ：  
    　　　　　　　JP：「ページが見つかりません。」  
    　　　　　　　EN：「Page not found」

<!-- end list -->

  - 「List」タブ各行の鉛筆アイコンをクリックすると、「Edit」タブに移動してその行のレコードを表示し、内容を編集できる
    
      - 入力情報は、「Create」タブと同じである
    
      - ［Save］ボタンを押すと、編集内容を保存して「List」タブに移動する
    
      - ［Cancel］ボタンを押すと、編集内容を保存せず「List」タブに移動する

  - 「List」タブ各行のごみ箱アイコンをクリックすると、確認ダイアログを表示する  
    メッセージ：「Are you sure to delete it ?」
    
      - ［OK］ボタンを押すと、該当レコードを削除する
    
      - ［キャンセル］ボタンを押すと、確認ダイアログを閉じる

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > invenio\_resourcesyncserver

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 本画面では、changelist\_indexesテーブルの情報を閲覧、作成、編集、削除する
    
      - 画面表示時に、invenio\_resourcesyncserver.admin.AdminChangeListView.indexメソッドによってテンプレートを指定する
        
          - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-resourcesyncserver/invenio_resourcesyncserver/config.py#L25>
        
          - 設定キー：INVENIO\_RESOURCESYNC\_CHANGE\_LIST\_ADMIN
    
      - 「List」タブの表示時に、同クラスのget\_listメソッドによってテーブルの情報を全件取得する
        
          - 画面の「Change List Url」と「Change Dump Url」の表示内容は、内容の表示時にchange\_list.js中でそれぞれ「url\_path」フィールドの値に「/changelist.xml」「/changedump.xml」を結合して作成している
        
          - 「status」フィールドは真偽値であるが、内容の表示時にchange\_list.js中でフィールドの値によって「Publish」か「Private」を表示するようにしている
    
      - 「Create」タブで［Create］ボタンを押したとき、同クラスのcreateメソッドによって、テーブルに対象インデックスについてのレコードがない場合に、新たにレコードを作成する
        
          - 対象インデックスについてのレコードがすでにあった場合には、作成せずに以下のコンフィグで指定されたメッセージを返す
            
              - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-resourcesyncserver/invenio_resourcesyncserver/config.py#L44-L45>
            
              - 設定キー：VALIDATE\_MESSAGE
    
      - 「Edit」タブで［Save］ボタンを押したとき、同クラスのupdateメソッドによってレコードを更新する
    
      - 「List」タブでごみ箱アイコンを押したとき、同クラスのdeleteメソッドによってレコードを物理削除する

  - 公開インデックスごとに「Change List」、「Change Dump」を出力する
    
      - 「Change List」を出力する
        
          - 「List」タブにて「Change List Url」列のURLを押すと、invenio\_resourcesyncserver.views. change\_list\_index関数が呼び出される
            
              - この中で、invenio\_resourcesyncserver.api. ChangeListHandler. get\_change\_list\_indexメソッドによってchangelist.xmlを出力する
    
      - 「Change Dump」を出力する
        
          - 「List」タブにて「Change Dump Url」列のURLを押すと、invenio\_resourcesyncserver.views. change\_dump\_index関数が呼び出される
            
              - この中で、invenio\_resourcesyncserver.api. ChangeListHandler. get\_change\_dump\_indexメソッドによってchangedump.xmlを出力する

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>

##   
### Resync

  - > 目的・用途

resyncを利用して外部機関からデータを収集する

  - > 利用方法

【Administration \> Resource Sync \> Resync画面】にて操作を行う

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - resync: <https://github.com/resync/resync>

  - 【Resync画面】には以下のタブが表示される
    
      - List
    
      - Create
    
      - Edit
        
          - > Listタブ選択中は非表示
        
          - Listタブの操作によって表示される
        
          - EditタブまたはDetailsタブ選択中に表示
    
      - Detail
        
          - > Listタブ選択中は非表示
        
          - Listタブの操作によって表示される
        
          - EditタブまたはDetailタブ選択中に表示

  - 「List」タブにて存在するResync Indexを一覧表示する
    
      - 「List」タブを表示するたびに最新の情報を取得する
    
      - 表示項目は以下の通りである
        
          - アクション（詳細・編集・削除を表すアイコン）
        
          - Repository name
            
              - そのResyncの名前
        
          - Target Index
            
              - そのResyncが対象とするインデックス
            
              - フォーマット：「{インデックスの英語名} \<ID:インデックスID\>」
        
          - Base Url
            
              - データ取得先のURL
        
          - Status
            
              - Manual/ Automatic
        
          - Resync mode
            
              - Baseline/Incremental/Audit
        
          - Saving format
            
              - JPCOAR-XML/BIOSAMPLE-JSON-LD/BIOPROJECT-JSON-LD

  - 「Create」タブにて「Resync」を作成する
    
      - 入力情報は以下の通りである
        
          - Repository name：データ取得先のリポジトリ名称。必須項目。テキストを入力
        
          - Base Url：データ取得先のURL。必須項目。テキストを入力
        
          - Status
            
              - ラジオボタン：Manual、Automatic
            
              - 「Automatic」を選択する場合、「Interval By Day」の入力エリアを表示する
            
              - デフォルト：Automatic
        
          - Interval By Day：自動実行する間隔
        
          - Statusが「Automatic」の場合のみに表示する
            
              - 入力欄は空にできず、1以上の整数のみ設定可能
            
              - デフォルト：1
        
          - From Date：期間‐開始日時。カレンダーから選択
        
          - Until Date：期間‐開始日時。カレンダーから選択
        
          - Target Index：収集されたアイテムに対して登録先インデックスを指定。必須項目。インデックスツリー一覧から選択
        
          - Resync Mode
            
              - 選択肢：Audit、Baseline、Incremental
                
                  - Baselineの時に、resourcelistのURLのみを「Base URL」に指定できる  
                    ResourceListを使ってその中の日付をベースにデータを取得しているので、From date/Until dateの指定は不要になる
                
                  - Incrementialの時に、changelistのURLのみを「Base URL」に指定できる
                
                  - Auditの時に、Sourceサーバーと実行しているかどうか、  
                    ResourceListの変更があるかどうかチェックする機能なのでImportボタンを表示されない
            
              - デフォルト：Baseline
        
          - Saving format
            
              - 選択肢：JPCOAR-XML、BIOSAMPLE-JSON-LD、BIOPROJECT-JSON-LD
    
      - ［Create］ボタンを押すと、入力内容をチェックし、問題がなければ、「Resync」のレコードを作成し、「List」タブに移動する
        
          - エラーの場合は以下の通りである
            
              - 必須項目を入力しない場合、以下のようなエラーメッセージを表示する  
                エラーメッセージ：「{項目名} is required」
    
      - ［Create and Add Another］ボタンを押すと、［Create］ボタンを押したときと同様の処理によって設定された内容のレコードを作成して、他の「Resync」を作成可能とする
    
      - ［Cancel］ボタンを押すと、設定された「Resync」を追加せずに、「List」タブに移動する

  - 外部機関からデータを「Manual」で収集する
    
      - 「Status：Manual」を設定するresyncに対して「Detail」タブにて、「Action」での「Sync」ボタンを押すと、当該画面上の設定内容を元にデータ収集を実行する
        
          - 以下のメッセージがポップアップで表示される
            
              - データ収集が開始された場合のメッセージ：「Sync Success」
            
              - データ収集が開始されなかった場合のメッセージ：「Error in Sync」
        
          - データ収集が完了した後、「Import」ボタンを押すと、収集されたデータをシステムに登録する
        
          - 以下のメッセージがポップアップで表示される
            
              - 登録が開始された場合のメッセージ：「Import Success」
            
              - 登録が開始されなかった場合のメッセージ：「Error in Import」

  - 外部機関からデータを「Automatic」で収集する
    
      - 「Status：Automatic」を設定するresyncに対して  
        【Admin \> Resource Sync \> Resync画面】での「Detail」タブにて、「Running」で収集処理が自動実行するかどうかを設定する
        
          - ONを表示している場合、設定された実行間隔で収集処理を自動実行する  
            ONを押すと、OFFに変更する
        
          - OFFを表示している場合、収集処理は実行しない  
            OFFを押すと、ONに変更する

  - 収集情報の実行履歴を確認する「Detail」タブにて、「Running logs」エリアに実行履歴を表形式で表示する
    
      - 収集処理が完了するまで、3秒ごとに取得して表示エリアを更新し続ける
    
      - 表示項目は以下の通りである
        
          - \#
            
              - ログ番号
        
          - Start Time
        
          - 収集処理を開始した時点の日時
        
          - End Time
        
          - 収集処理を完了した時点の日時
        
          - Status
            
              - コンフィグ「INVENIO\_RESYNC\_LOGS\_STATUS」で設定されたもの
            
              - Successful
                
                  - Running
                
                  - Failed
        
          - Log Type
            
              - sync
            
              - import
        
          - Processed Items
        
          - Created Items
        
          - Updated Items
        
          - Deleted Items
        
          - Error Items
        
          - Error Message, Url
            
              - 収集処理が異常終了で終了したときにメッセージとリクエストURLが表示される

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > invenio\_resourcesyncclient

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 本画面では、resync\_indexesテーブルの情報を閲覧、作成、編集、削除して、その情報をもとにデータ収集を行う
    
      - 画面表示時に、invenio\_resourcesyncclient.admin. AdminResyncClient.indexメソッドによってテンプレートを指定する
        
          - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-resourcesyncclient/invenio_resourcesyncclient/config.py#L22>
        
          - 設定キー：INVENIO\_RESOURCESYNCCLIENT\_ADMIN\_TEMPLATE
    
      - 「List」タブの表示時に、同クラスのget\_listメソッドによってテーブルの情報をid昇順で取得する
    
      - 「Create」タブで［Create］ボタンを押したとき、同クラスのcreateメソッドによって、テーブルに対象インデックスについてのレコードがない場合に、新たにレコードを作成する
        
          - 「resync\_save\_dir」フィールドの値は、以下のコンフィグで指定する文字列にレコードのidを加えた文字列を設定する
            
              - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-resourcesyncclient/invenio_resourcesyncclient/config.py#L51>
            
              - 設定キー：INVENIO\_RESYNC\_SAVE\_PATH
    
      - 「Edit」タブで［Edit］ボタンを押したとき、同クラスのupdate\_resyncメソッドによってレコードを更新する
    
      - 「List」タブでごみ箱アイコンを押したとき、同クラスのdelete\_resyncメソッドによって該当レコードを物理削除する

  - データ収集は、Sync（データ収集）とImport（データ登録）の２段階で行う
    
      - 以下の場合に、invenio\_resourcesyncclient.tasks. resync\_sync関数が非同期で呼び出される
        
          - Detailタブで、「Action」で［Sync］ボタンを押す
        
          - Detailタブで、「Running」でボタンを［ON］にする
        
          - 「Running」のボタンが［ON］の状態で、前回実行時から（interval\_by\_day）日経過したときにrun\_sync\_auto関数が実行される
    
      - resync\_sync関数の中で、invenio\_resourcesyncclient.utils. process\_sync関数によってSyncを行う
        
          - resync\_sync関数が呼び出されると、画面には200のレスポンスが返却される
        
          - ログのLog Typeは「sync」となる
        
          - 処理が終了したとき、ログのStatusは結果にかかわらず「Successful」となる
        
          - resync\_indexesテーブルで、引数のidと等しいidのレコードの情報を用いる
        
          - 以下の場合に、ValueErrorが発生する
            
              - base\_urlフィールドで指定されたxmlファイルのcapabilityを取得できなかった場合
            
              - resync\_modeが「Baseline」で、取得したcapabilityが「resourcelist」でも「resourcedump」でもない場合
            
              - resync\_modeが「Audit」で、取得したcapabilityが「resourcelist」でも「changelist」でもない場合
        
          - 以下の場合に例外クラスを指定しない例外が発生する
            
              - resync\_modeが「Incremental」で、取得したcapabilityが「changelist」でも「changedump」でもない場合
        
          - resync\_modeが「Baseline」または「Audit」のとき、resyncのbaseline\_or\_audit関数によってデータ収集を行う
            
              - baseline\_or\_audit関数については以下を参照
                
                  - <https://github.com/resync/resync/blob/v1.0.9/resync/client.py#L241-L326>
        
          - resync\_modeが「Incremental」のとき、resyncのincremental関数によってSyncを行う
            
              - incremental関数については以下を参照
                
                  - <https://github.com/resync/resync/blob/v1.0.9/resync/client.py#L328-L474>
    
      - 以下の場合に、invenio\_resourcesyncclient.tasks. run\_sync\_import関数が非同期で呼び出される
        
          - Detailタブで、「Action」で［Import］ボタンを押す
        
          - statusが「Automatic」かつresync\_modeが「Audit」でSyncが終了する
            
              - Sync終了時に呼び出されるfinish関数の中で呼び出す
        
          - 「Running」のボタンが［ON］の状態で、前回実行時から（interval\_by\_day）日経過したときにrun\_sync\_auto関数が実行されるようにceleryタスクに登録される
    
      - run\_sync\_import関数の中で、invenio\_resourcesyncclient.utils. process\_item関数によってImportを行う
        
          - run\_sync\_import関数が呼び出されると、画面には200のレスポンスが返却される
        
          - そのResyncでBase Urlに指定したxmlファイルの情報をもとに登録を行う

  - invenio\_resourcesyncclient.tasks. resync\_sync関数、invenio\_resourcesyncclient.tasks. run\_sync\_import関数の中で、invenio\_resourcesyncclient.tasks. prepare\_log関数によってログを作成する
    
      - 作成したログは、resync\_logsテーブルに保存する

  - Detailタブを表示したとき、および［Sync］ボタンまたは［Import］ボタンを押して200のレスポンスを受け取ったときに、resync\_client.jsのhandleGetLogs関数が呼び出される
    
      - handleGetLogs関数の中で、invenio\_resourcesyncclient.admin. AdminResyncClient. get\_logsメソッドによってresync\_logsテーブルからログを取得する
    
      - 取得したテーブルのend\_timeフィールドが空だった場合には、3000ミリ秒後に再度handleGetLogs関数を実行する

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### 永続識別子

<!-- end list -->

  - > 目的・用途

<!-- end list -->

  - システムに登録しているアイテムの永続識別子を閲覧する機能である

  - 一つのオブジェクトに対して複数の永続識別子があることができる

  - 永続識別子の値はユニークとする

<!-- end list -->

  - > 利用方法

【Administration \> レコード管理（Records） \> 永続識別子（Persistent Identifier）画面】にて閲覧する

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【永続識別子（Persistent Identifier）画面】には以下のタブが表示される
    
      - 一覧（List）
        
          - このタブの表示中のみ、タブ名の末尾に件数が表示される
    
      - フィルターを追加▼（Add Filter▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 詳細（Details）
        
          - 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブでの操作によって表示される

  - 「一覧」（List）タブにて永続識別子一覧を表示する
    
      - 表示項目は以下の通りである
        
          - アクション（閲覧を表すアイコン）
        
          - 「PID Type」
            
              - 「oai」：OAIの値  
                PIDのフォーマット：「scheme ":" namespace-identifier ":" local-identifier」  
                scheme = "oai"  
                namespace-identifier = "invenio"
            
              - 「depid」：デポジット識別子の値
            
              - 「recid」：レコード識別子の値
            
              - 「parent」：親レコードの値
            
              - 「actid」：アクティビティID
            
              - 「doi」：付与されたDOIの値
            
              - 「hdl」：付与されたCNRIの値
            
              - 「hvstid」：アイテムがハーベスト機能でインポートした場合の値
        
          - 「PID」
        
          - 「Status」
            
              - 「NEW」：PIDが登録されない状態である
            
              - 「RESERVED」：予約済みで完全登録されない状態である
            
              - 「REGISTERED」：登録された状態である
            
              - 「REDIRECTED」：他の永続識別子にリダイレクトされた状態である
            
              - 「DELETED」：削除された状態である
        
          - 「Object Type」
        
          - 「Object UUID」
        
          - 「Created」：アイテムの登録時間  
            フォーマット：YYYY-MM-DDThh:mm:ss.tttttt
        
          - 「Updated」：アイテムの編集時間  
            フォーマット：YYYY-MM-DDThh:mm:ss.tttttt
        
          - 「Object」リンク  
            「View」リンクを押すと、【Administration \> レコード管理（Records） \> レコードメタデータ（Record Metadata）画面】に移動、該当オブジェクト詳細画面が表示される

  - 「フィルターを追加▼」（Add Filter▼）タブをクリックすると、以下の追加可能なフィルターリストを表示し、フィルター名をクリックすると当該フィルターの入力エリアを追加する
    
      - フィルター名
        
          - 「PID Type」  
            フィルター方式の選択肢：含む（contains）、含まれていません（not contains）、等しい（equals）、等しくない（not equal）、空（empty）、一覧にある（in list）、一覧にない（not in list）
        
          - 「PID」  
            フィルター方式の選択肢：「PID Type」の同じである
        
          - 「Object Type」  
            フィルター方式の選択肢：「PID Type」の同じである
        
          - 「Object UUID」  
            フィルター方式の選択肢：等しい（equals）
        
          - 「Status」  
            フィルター方式の選択肢：等しい（equals）  
            フィルターの選択肢：「新規」（New）、「予約済み」（Reserved）、「登録された」（Registered）、「リダイレクトされた」（Redirected）、「削除日」（Deleted）
    
      - 設定したフィルターは［適用（Apply）］ボタンを押下することで一覧に適用される
    
      - ［フィルターをリセット（Reset filter）］ボタンを押下すると、設定したフィルターがリセットされる

  - 永続識別子行にて目アイコンを押すと、該当永続識別子の詳細情報を「詳細」（Details）タブに表示する
    
      - 表示項目：Created、Updated、PID Type、PID、Provider、Status、Object Type、Object UUID、Redirects、Child Relations、Parent Relations

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - invenio\_pidstore（WEKOソース内にforkされていない）

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 本機能は、flaskのModelViewでpidstore\_pidテーブルの内容を閲覧する際に用いる機能である

  - ソースとしては以下を参照
    
      - パス：<https://github.com/inveniosoftware/invenio-pidstore/blob/v1.0.0/invenio_pidstore/admin.py#L46-L75>

  - pidstore\_pidテーブルのstatusフィールドについては、値のかわりにinvenio\_pidstore.models.PIDStatusクラスで関連付けられた文字列を表示する

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>


### レコードメタデータ

  - > 目的・用途

本機能は、レコードメタデータの閲覧、削除、復元の際に用いる機能である

  - > 利用方法

【Administration \> レコード管理（Records） \> レコードメタデータ（Record Metadata）画面】にて操作を行う

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【レコードメタデータ（Record Metadata）画面】には以下のタブが表示される
    
      - 一覧（List）
        
          - このタブの表示中のみ、タブ名の末尾に件数が表示される
    
      - フィルターを追加▼（Add Filter▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 選択▼（With selected▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 詳細（Details）
        
          - 一覧（List）タブ選択中は非表示一覧（List）タブでの操作によって表示される

  - 「一覧」（List）タブにてレコードメタデータを一覧表示する
    
      - 表示項目は以下のとおりである
        
          - アクション（閲覧・削除を表すアイコン）
        
          - UUID
        
          - Status
        
          - Revision
        
          - Updated
        
          - Created
    
      - 「フィルターを追加▼」（Add Filter▼）タブをクリックすると、以下の追加可能なフィルターリストを表示し、フィルター名をクリックすると当該フィルタの入力エリアを追加する
        
          - フィルター名は以下の通りである
            
              - Created
                
                  - フィルター方式の選択肢：等しい（equals）、等しくない（not equal）、より大きい（greater than）、より小さい（smaller than）、間（between）、間ではなく（not between）、空（empty）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - Updated
                
                  - フィルター方式の選択肢：上記のCreatedと同じである
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
        
          - 設定したフィルターは［適用（Apply）］ボタンを押下することで一覧に適用される
        
          - ［フィルターをリセット（Reset filter）］ボタンを押下すると、設定したフィルターがリセットされる
    
      - 「選択▼」（With selected▼）タブをクリックすると、以下の追加可能な機能（現在削除ボタンのみ）を表示する
        
          - レコードにチェックを入れない場合、［削除（Delete）］ボタンを押すと、エラーメッセージを表示する  
            メッセージ：  
            　日本語：「少なくとも1つのレコードを選択してください。」  
            　英語：「Please select at least one record.」
        
          - レコードにチェックを入れる場合、［削除（Delete）］ボタンを押すと、確認ダイアログを表示する  
            メッセージ：  
            　日本語：「選択したレコードを削除してもよろしいですか。」  
            　英語：「Are you sure you want to delete selected records?」
            
              - ［OK］ボタンを押すと、該当レコードメタデータを削除状態に変更し、メッセージを画面上部に表示する  
                メッセージ：  
                　日本語：「レコード数＋レコードが正常に削除されました。」  
                　英語：「Record was successfully deleted.」
            
              - ［キャンセル（Cancel）］ボタンを押すと、確認ダイアログを閉じる
        
          - この操作を行ったレコードは、詳細（Details）タブを表示するとJSONが「null」に変化している
            
              - 一覧（List）タブでも詳細（Details）タブでもStatusは変化しない
    
      - レコードメタデータ行にて目アイコンを押すと、該当レコードメタデータの詳細情報を詳細（Details）タブに表示する
    
      - レコードメタデータ行にてごみ箱アイコンを押すと、該当レコードメタデータを物理削除し、メッセージを画面上部に表示する  
        メッセージ：  
        　日本語：「レコード数＋レコードが正常に削除されました。」  
        　英語：「Record was successfully deleted.」

  - 詳細（Details）タブでは、該当レコードメタデータの詳細情報を表示する
    
      - 表示項目：UUID、Status、Revision、Updated、Created、JSON
    
      - ［削除（Delete）］ボタンは以下のようにふるまう
        
          - このボタンは、StatusがDELETED以外のときに押すことができる
        
          - このボタンを押すと、以下のメッセージがポップアップで表示される
            
              - 日本語：「サーバ内部エラー」
            
              - 英語：「Internal server error」
    
      - ［復元（Restore）］ボタンは以下のようにふるまう
        
          - このボタンは、StatusがDELETEDのときに押すことができる
        
          - このボタンを押すと、ページ未検出エラーの画面に遷移する

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - invenio\_records：画面を定義

  - weko\_records：soft\_delete処理と復元処理を定義

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 本画面は、flaskのModelViewでrecords\_metadataテーブルの内容を閲覧、編集、削除する際に用いる機能である

  - 画面で表示されるstatusはテーブルに含まれない項目で、情報取得時にpidstore\_pidテーブルから以下の条件を満たすレコードのstatusを取得している
    
      - pid\_typeが「recid」
    
      - object\_uuidがrecords\_metadataテーブルでのidと一致する

  - v0.9.22では、詳細（Details）タブでの操作は必ずエラーが発生するようになっている
    
      - ［削除（Delete）］ボタンを押したときには'/soft\_delete/\<string:id\>'の形で、［復元（Restore）］ボタンを押したときには'/restore/\<string:id\>'の形でリクエストのURLを作成するが、適切に作成できていない
        
          - ModelViewでDetailsを表示すると、URL末尾に「\&url=...」が入るようになっている
        
          - リクエストのURLは、ボタンを押したときの画面のURLから「detail」を置換して「id=」を取り除いて作成しており、末尾の「\&url=...」がそのままになっているため不正なidを指定した状態になる
        
          - これによって、soft\_delete関数やrestore関数に到達しない
            
              - テンプレートにて、［削除（Delete）］ボタンを押してエラーが発生した場合にメッセージを表示するようになっているが、［復元（Restore）］ボタンの場合にはエラー発生時の記述がないためページ未検出エラーの画面に遷移する
    
      - DetailsタブのURLから末尾の「\&url=...」を取り除いたものでも同様の画面を表示できるため、その状態でボタンを押すことで各関数に到達することができる

  - 一覧（List）タブにて、レコードをチェックして「選択▼」（With selected▼）タブの［削除（Delete）］ボタンを押すと、チェックしたレコードごとにinvenio\_records.admin. RecordMetadataModelView.delete\_modelメソッドが呼び出される
    
      - 該当レコードのJSONが「null」だった場合は処理を終了する
    
      - invenio\_records.api Record.deleteメソッドによって、該当レコードのJSONを「null」にする

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
 ### バケット

<!-- end list -->

  - > 目的・用途

本機能は、コンテンツファイルを登録しているアイテムのバケットを閲覧、編集、作成する機能である

  - > 利用方法

【Administration \> ファイル管理(Files) \> バケット(Bucket)画面】を表示する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【バケット(Bucket)画面】には以下のタブが表示される
    
      - 一覧（List）
    
      - 作成（Create）
    
      - フィルターを追加▼（Add Filter▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 選択▼（With selected▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 編集（Edit）
        
          - > 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示
    
      - 詳細（Details）
        
          - > 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示

  - 「一覧」（List）タブにバケット一覧を表示する。
    
      - 表示項目は以下の通りである。
        
          - アクセス（閲覧・編集）
            
              - 目のマークを押すと「詳細」タブに遷移する。
            
              - 鉛筆のマークを押すと「編集」タブに遷移する。
        
          - 「UUID」：バケットのID
        
          - 「Location」：バケットの設定場所
        
          - 「Default Storage Class」：S（Standard）、A（Archive）  
            デフォルト値：「S」
        
          - 「Deleted」
        
          - 「Locked」
        
          - 「Size」：アップロードされたファイルの容量
        
          - 「Quota Size」：アップロード可能容量
        
          - 「Created」：アイテムの登録時間  
            フォーマット：YYYY-MM-DDThh:mm:ss.tttttt
        
          - 「Updated」アイテムの編集時間  
            フォーマット：YYYY-MM-DDThh:mm:ss.tttttt
        
          - 「Objects」リンク  
            「Objects」リンクを押すと、【Administration \> ファイル管理(Files) \> オブジェクトバージョン(Object Version)画面】に移動し、該当オブジェクトがフィルターされる。
    
      - 「フィルターを追加▼」（Add Filter▼）ボタンをクリックすると、以下の追加可能なフィルターリストを表示し、フィルター名をクリックすると当該フィルタの入力エリアを追加する。
        
          - フィルター名
            
              - 「location / Files Location / Name」
                
                  - フィルター方式の選択肢：含む（contains）、含まれていません（not contains）、等しい（equals）、等しくない（not equal）、空（empty）、一覧にある（in list）、一覧にない（not in list）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Default Storage Class」
                
                  - フィルター方式の選択肢：「location / Files Location / Name」の同じである。
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Deleted」
                
                  - フィルター方式の選択肢：等しい（equals）、等しくない（not equal）
                
                  - 選択したフィルター方式に対して「はい」「いいえ」
            
              - 「Locked」
                
                  - フィルター方式の選択肢：「Deleted」の同じである
                
                  - 選択したフィルター方式に対して「はい」「いいえ」
            
              - 「Size」
                
                  - フィルター方式の選択肢：等しい（equals）、等しくない（not equal）、より大きい（greater than）、より小さい（smaller than）、空（empty）、一覧にある（in list）、一覧にない（not in list）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Created」
                
                  - フィルター方式の選択肢：等しい（equals）、等しくない（not equal）、より大きい（greater than）、より小さい（smaller than）、間（between）、間ではなく（not between）、空（empty）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Updated」
                
                  - フィルター方式の選択肢：「Created」の同じである
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
        
          - 設定したフィルターは「適用」（Apply）ボタンを押下することで一覧に適用される。
        
          - 「フィルターをリセット」（Reset filter）ボタンを押下すると、設定したフィルターがリセットされる。
    
      - 左端行の目アイコンを押すと、該当バケットの詳細情報を「詳細」（Details）タブに表示する。
        
          - 表示項目：UUID、Location、Default Storage Class、Deleted、Locked、Size、Quota Size、Max File Size、Created、Updated、Objects、Object Versions
        
          - 「Objects」リンクをクリックすると、【Administration \> ファイル管理(Files) \> オブジェクトバージョン(Object Version)画面】に移動し、該当オブジェクトがフィルターされる。
        
          - 「Object Versions」リンクをクリックすると、【Admin \> Files \> Object Version画面】に移動し、該当オブジェクトバージョンがフィルターされる。
    
      - 左端行の鉛筆アイコンを押すと、「編集」（Edit）タブに表示し、ユーザーの情報が編集できる。
        
          - 編集可能な項目は以下の通りである。
            
              - 「Default Storage Class」  
                選択肢：Standard、Archive
            
              - 「Locked」
            
              - 「Deleted」
            
              - 「Quota Size」：整数のみ入力可
            
              - 「Max File Size」：整数のみ入力可
        
          - 「保存」（Save）ボタンを押すと、編集内容を保存し、メッセージを一覧画面の上部に表示する。  
            メッセージ：  
            　日本語：「レコードが正常に保存されました。」  
            　英語：「Record was successfully saved.」

  - 「作成」タブの機能は存在するが、現在画面上にロケーションを選択する欄がなく、「保存」ボタンを押下すると、エラーが出る。(v0.9.22)

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > invenio-files-rest

  - > flask-admin:  
    > <https://github.com/flask-admin/flask-admin/blob/e764f6f0be3facbefb2b4d30b5c3f2f2c630d530/flask_admin/model/base.py>

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - バケット画面の処理について
    
      - バケット画面を表示する。この操作によって、invenio\_files\_rest.admin.BucketModelViewが継承したModelViewよりflask\_admin.model.base.index\_viewメソッドを呼び出す。このメソッドでfiles\_bucketテーブルよりバケット情報を取得し、BucketModelViewのcolumn\_listにあるキーに対応する情報を画面に表示する。
        
          - バケット詳細画面を表示する。この操作によって、invenio\_files\_rest.admin.BucketModelViewが継承したModelViewよりflask\_admin.model.base.details\_viewメソッドを呼び出す。このメソッド下でfiles\_bucketテーブルよりバケット情報を取得し、BucketModelViewのcolumn\_details\_listにあるキーに対応する情報を画面に表示する。
    
      - バケット編集画面を表示する。この操作によって、invenio\_files\_rest.admin.BucketModelViewが継承したModelViewよりflask\_admin.model.base.edit\_viewメソッドをGETで呼び出す。このメソッド下で開いたid列を用いて、files\_bucketテーブルよりバケット情報を取得し、表示する。
        
          - バケット編集画面で「保存」ボタンを押下する。この操作によって、flask\_admin.model.base.edit\_viewメソッドをPOSTで呼び出す。このメソッド下で、get\_save\_return\_urlメソッドが呼ばれ、編集内容をfiles\_bucketテーブルに保存し、更新する。
    
      - バケット作成画面を開いたとき、invenio\_files\_rest.admin.BucketModelViewが継承したModelViewよりflask\_admin.model.base.create\_viewメソッドをGETで呼び出す。BucketModelViewクラスのform\_columnsの項目の入力欄を表示する。
        
          - 入力欄に入力後「保存」ボタンを押下する。この操作によって、invenio\_files\_rest.admin.BucketModelViewが継承したModelViewよりflask\_admin.model.base.create\_viewメソッドをPOSTで呼び出す。このメソッド下でget\_save\_return\_urlメソッドが呼ばれ、新しいバケットの情報をfiles\_bucketテーブルに保存する。

  - バケット情報は以下のようなデータベースに保存する。
    
      - テーブル名：「files\_bucket」
    
    <!-- end list -->
    
      - > フィールド名：  
        > ・「created」  
        > ・「updated」  
        > ・「id」  
        > ・「default\_location」  
        > ・「default\_storage\_class」  
        > ・「size」  
        > ・「quota\_size」  
        > ・「max\_file\_size」  
        > ・「locked」  
        > ・「deleted」

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### ファイルインスタンス

  - > 目的・用途

本機能は、管理者として、アップロードしているファイルを管理する機能である

  - > 利用方法

【Administration \> ファイル管理（Files） \> ファイルインスタンス（File Instance）画面】からファイルインスタンスを表示する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【ファイルインスタンス(File Instance)画面】には以下のタブが表示される
    
      - 一覧（List）
    
      - フィルターを追加▼（Add Filter▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 選択▼（With selected▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 詳細（Details）
        
          - > 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 詳細（Details）タブ選択中に表示

  - 「一覧」（List）タブにアップロードしているファイルを表示する
    
      - 表示項目は以下の通りである
        
          - チェックボックス
        
          - アクション（閲覧）
        
          - 「ID」：ファイルのID
        
          - 「URI」：ファイルのURI  
            「Location」画面に設定している配置先を元に、ファイルのURIを指定する  
            押下すると一覧のロケーションをソートする。
        
          - 「Storage Class」：S（Standard）、A（Archive）  
            押下すると一覧のロケーションをソートする。
        
          - 「Size」：ファイルの容量値  
            押下すると一覧のロケーションをソートする。
        
          - 「Checksum」  
            押下すると一覧のロケーションをソートする。
        
          - 「Readable」  
            押下すると一覧のロケーションをソートする。
        
          - 「Writable」  
            押下すると一覧のロケーションをソートする。
        
          - 「Fixity」  
            押下すると一覧のロケーションをソートする。
        
          - 「Checked」  
            押下すると一覧のロケーションをソートする。
        
          - 「Created」  
            フォーマット：「YYYY-MM-DD hh:mm:ss.tttttt」  
            押下すると一覧のロケーションをソートする。
        
          - 「Updated」  
            フォーマット：「YYYY-MM-DD hh:mm:ss.tttttt」  
            押下すると一覧のロケーションをソートする。
        
          - 「Objects」リンク  
            リンクをクリックすると、【Administration \> ファイル管理（Files）\>オブジェクトバージョン（Object Version）画面】に移動し、該当オブジェクトバージョンがフィルターされる
    
      - 「フィルターを追加▼」（Add Filter▼）ボタンをクリックすると、以下の追加可能なフィルターリストを表示し、フィルター名をクリックすると当該フィルタの入力エリアを追加する
        
          - フィルター名
            
              - 「ID」
            
              - > フィルター方式の：等しい（equals）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「URI」
            
              - > フィルター方式の選択肢：含む（contains）、含まれていません（not contains）、等しい（equals）、等しくない（not equal）、空（empty）、一覧にある（in list）、一覧にない（not in list）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Storage Class」
            
              - > フィルター方式の選択肢：「URI」と同じである
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Size」
            
              - > フィルター方式の選択肢：等しい（equals）、等しくない（not equal）、より大きい（greater than）、より小さい（smaller than）、空（empty）、一覧にある（in list）、一覧にない（not in list）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Checksum」
            
              - > フィルター方式の選択肢：「URI」と同じである
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Readable」
            
              - > フィルター方式の選択肢：等しい（equals）、等しくない（not equal）
                
                  - 選択したフィルター方式に対して「はい」「いいえ」
            
              - 「Writable」
            
              - > フィルター方式の選択肢：「Readable」と同じである
                
                  - 選択したフィルター方式に対して「はい」「いいえ」
            
              - 「Fixity」
            
              - > フィルター方式の選択肢：「Readable」と同じである
                
                  - 選択したフィルター方式に対して「はい」「いいえ」
            
              - 「Checked」
            
              - > フィルター方式の選択肢：等しい（equals）、等しくない（not equal）、より大きい（greater than）、より小さい（smaller than）、間（between）、間ではなく（not between）、空（empty）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Created」
            
              - > フィルター方式の選択肢：「Checked」と同じである
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Updated」
            
              - > フィルター方式の選択肢：「Checked」と同じである
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Files Object / Created」
            
              - > フィルター方式の選択肢：「Checked」と同じである
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Files Object / Updated」
            
              - > フィルター方式の選択肢：「Checked」と同じである
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Files Object / Key」
            
              - > フィルター方式の選択肢：「URI」と同じである
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Files Object /Root File id」
                
                  - フィルター方式の選択肢：「ID」と同じである
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Files Object / Mimetype」
            
              - > フィルター方式の選択肢：「URI」と同じである
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Files Object / Is Head」
            
              - > フィルター方式の選択肢：「Readable」と同じである
                
                  - 選択したフィルター方式に対して「はい」「いいえ」
            
              - 「Files Object / Created User Id」
            
              - > フィルター方式の選択肢：「Size」と同じである
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Files Object / Updated User Id」
            
              - > フィルター方式の選択肢：「Size」と同じである
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Files Object / Is Show」
            
              - > フィルター方式の選択肢：「Readable」と同じである
                
                  - 選択したフィルター方式に対して「はい」「いいえ」
            
              - 「Files Object / Is Thumbail」
            
              - > フィルター方式の選択肢：「Readable」と同じである
                
                  - 選択したフィルター方式に対して「はい」「いいえ」
        
          - 設定したフィルターは「適用」（Apply）ボタンを押下することで一覧に適用される
        
          - 「フィルターをリセット」（Reset Filters）ボタンを押下すると、設定したフィルターがリセットされる
    
      - 「選択▼」（With selected▼）ボタンをクリックすると、以下の追加可能な機能を表示する  
        機能：「Run fixity check」
        
          - レコードにチェックを入れない場合、「Run fixity check」ボタンを押すと、エラーメッセージを表示する  
            メッセージ：  
            　日本語：「少なくとも一つのレコードを選択してください。」  
            　英語：「Please select at least one record.」
        
          - レコードにチェックを入れる場合、「Run fixity check」ボタンを押すと、「checksum」値の確認を行う
            
              - 表示している「checksum」値が実際の「checksum」値と一致する場合
                
                  - 以下のメッセージを画面上部に表示する  
                    メッセージ：「Fixity check(s) sent to queue.」
                
                  - 実行の時間を「Checked」に更新する
            
              - 表示している「checksum」値が実際の「checksum」値と一致しない場合
                
                  - 表示している「checksum」値が空白になる
                
                  - 実行の時間を「Checked」に更新する
    
      - 検索テキストボックスでユーザーを検索する  
        プレースホルダー：「Search: URI, size, checksum」
        
          - 任意テキストを入力し、キーボードでの「Enter」を押すと、ファイルインスタンス検索を行う
        
          - テキストボックスの右端での「X」ボタンを押すと、検索条件がクリアーされる
    
      - ファイルインスタンス左端の行の目アイコンを押すと、該当ファイルインスタンスの詳細情報を「詳細」（Details）タブに表示する
        
          - 表示項目：ID、URIl、Storage Class、Size、Checksum、Readable、Writable、Fixity、Checked、Created、Updated、Objects
        
          - 「Objects」リンクをクリックすると、【Administration \> Files (ファイル管理)\> Object Version(オブジェクトバージョン)画面】に移動し、該当オブジェクトバージョンがフィルターされる

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > invenio-files-rest

<!-- end list -->

  - > 処理概要

> ファイルインスタンス画面の処理について

  - ファイルインスタンス画面を表示すると、invenio\_files\_rest.admin.FileInstanceModelViewが継承したModelViewのBaseModelViewより、flask\_admin.model.base.BaseModelView.index\_viewを呼び出す。このメソッドでfiles\_filesテーブルからバケット情報を取得し、FileInstanceModelView.column\_listのキーに対応する情報を表示する。
    
      - ファイルインスタンス詳細画面を表示する。invenio\_files\_rest.admin.FileInstanceModelViewが継承したModelViewのBaseModelViewよりflask\_admin.model.base.BaseModelView.details\_viewを呼び出す。このメソッド下でfiles\_filesテーブルよりバケット情報を取得し、FileInstancetModelViewのcolumn\_details\_listのキーに対応する情報をdetailsタブ画面に表示する。

> ファイルインスタンスを選択し、【With Selected (選択)】から【Run fixity check】を押下する。invenio\_files\_rest.admin.FileInstanceModelViewが継承したModelViewのBaseModelViewより、flask\_admin.model.base.BaseModelView.action\_viewを呼び出して使用する。invenio\_files\_rest.admin.FileInstanceModelView.action\_verify\_checksumを呼び出す。このメソッド下でinvenio\_files\_rest.tasks.verify\_checksumを呼び出してfiles\_filesテーブルのchecksumの値を確認し、last\_check\_atカラムを更新し、ファイルインスタンス画面のcheckedの欄に実行時間を表示する。
> 
> バケット情報を以下のようなデータベースに保存する

  - > テーブル名：「files\_files」

  - > フィールド名：  
    > ・「id」  
    > ・「uri」  
    > ・「storage\_class」  
    > ・「size」  
    > ・「checksum」  
    > ・「readable」  
    > ・「writable」  
    > ・「last\_check\_at」  
    > ・「last\_check」  
    > ・「created」  
    > ・「updated」

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### ロケーション

  - > 目的・用途

本機能は、管理者として、アップロードしているファイルの配置先及びロケーションごとの使用量の情報を管理する機能である

  - > 利用方法

【Administration \> ファイル管理（Files）\> ロケーション（Location）】から、ロケーションの情報の閲覧、編集、作成をする。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【ロケーション（Location）画面】には以下のタブが表示される
    
      - 一覧（List）
    
      - 作成（Create）
    
      - フィルターを追加▼（Add Filter▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 選択▼（With selected▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 編集（Edit）
        
          - > 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示
    
      - 詳細（Details）
        
          - > 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示

  - 「一覧」（List）タブにロケーション一覧を表示する
    
      - 表示項目は以下の通りである
        
          - チェックボックス
        
          - アクション（閲覧・編集・削除）
        
          - 「Type」：ロケーションタイプ  
            押下すると一覧のロケーションをソートする。
        
          - 「Name」  
            押下すると一覧のロケーションをソートする。
        
          - 「URI」  
            押下すると一覧のロケーションをソートする。
        
          - 「Default」：デフォルトの状態  
            押下すると一覧のロケーションをソートする。
        
          - 「Size」：使用量の情報  
            押下すると一覧のロケーションをソートする。
        
          - 「Quota Size」：ロケーションの使用上限  
            押下すると一覧のロケーションをソートする。
        
          - 「Created」：ロケーションの作成時間  
            フォーマット：「YYYY-MM-DD hh:mm:ss.tttttt」  
            押下すると一覧のロケーションをソートする。
        
          - 「Updated」：ロケーションの更新時間  
            フォーマット：「YYYY-MM-DD hh:mm:ss.tttttt」  
            押下すると一覧のロケーションをソートする。
        
          - 「Buckets」リンク  
            リンクをクリックすると、【Admin \> Files \> Bucket画面】に移動し、当該ロケーションが属するバケット一覧がフィルターされる
    
      - 「フィルターを追加▼」（Add Filter▼）ボタンをクリックすると、以下の追加可能なフィルターリストを表示し、フィルター名をクリックすると当該フィルタの入力エリアを追加する
        
          - フィルター名
            
              - > 「Default」
            
              - > フィルター方式の選択肢：等しい（equals）、等しくない（not equal）
                
                  - 選択したフィルター方式に対して「はい」「いいえ」
            
              - 「Created」
            
              - > フィルター方式の選択肢：等しい（equals）、等しくない（not equal）、より大きい（greater than）、より小さい（smaller than）、間（between）、間ではなく（not between）、空（empty）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Updated」
            
              - > フィルター方式の選択肢：「Created」と同じである
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
        
          - 設定したフィルターは「適用」（Apply）ボタンを押下することで一覧に適用される
        
          - 「フィルターをリセット」（Reset filter）ボタンを押下すると、設定したフィルターがリセットされる
    
      - 「選択▼」（With selected▼）ボタンをクリックすると、以下の追加可能な機能（現在削除ボタンのみ）を表示する
        
          - レコードにチェックを入れない場合、「削除」（Delete）ボタンを押すと、エラーメッセージを表示する  
            メッセージ：  
            　日本語：「少なくとも一つのレコードを選択してください。」  
            　英語：「Please select at least one record.」
        
          - レコードにチェックを入れる場合、「削除」（Delete）ボタンを押すと、確認ダイヤログを表示する  
            メッセージ：  
            　日本語：「選択したレコードを削除してもよろしいですか。」  
            　英語：「Are you sure you want to delete selected records?」
            
              - 「OK」ボタンを押すと、該当ロールを削除し、メッセージを画面上部に表示する  
                メッセージ：  
                　日本語：「レコード数＋レコードが正常に削除されました。」  
                　英語：「Record was successfully deleted.」
            
              - 「キャンセル」（Cancel）ボタンを押すと、確認ダイヤログを閉じる
    
      - 検索テキストボックスでロケーションを検索する
        
          - プレースホルダー：「Search: URI, name」
        
          - 任意テキストを入力し、キーボードでの「Enter」を押すと、ロケーション検索を行う
        
          - テキストボックスの右端での「X」ボタンを押すと、検索条件がクリアーされる
    
      - ロケーション行に目アイコンを押すと、該当ロケーションの詳細情報を「詳細」（Details）タブに表示する
        
          - 表示項目：Type、Name、URI、Default、Size、Quota Size、Created、Updated、Buckets
        
          - 「Buckets」リンクをクリックすると、【Administration \> Files (ファイル管理) \> Bucket (バケット) 画面】に移動し、当該ロケーションが属するバケット一覧がフィルターされる
    
      - ロケーション行に鉛筆アイコンを押すと、該当ロケーションを「編集」（Edit）タブに表示し、ロケーションの情報が編集できる
    
      - ロケーション行に削除アイコンを押すと、該当ロケーションを削除し、メッセージを画面上部に表示する  
        メッセージ：  
        　日本語：「レコード数＋レコードが正常に削除されました。」  
        　英語：「Record was successfully deleted.」
    
      - 「一覧」（List）から「作成」（Create）タブを押すと、「編集」(edit)タブに移動しロケーションを新規作成できる
        
          - 入力情報：
            
              - 「Name」：必須項目  
                入力パターン：「^\[a-z\]\[a-z0-9-\]+$」
            
              - 「URI」：必須項目
            
              - 「Type」  
                選択肢：Amazon S3
            
              - 「access\_key」  
                「Type」に「Amazon S3」を選択する時表示する
            
              - 「secret\_key」  
                「Type」に「Amazon S3」を選択する時表示する
            
              - 「endpoint\_url」  
                「Type」に「Amazon S3」を選択する時表示する
            
              - > 「send\_file\_directrly」  
                > 「Type」に「Amazon S3」を選択する時表示するチェックボックス  
                > デフォルト：チェックあり
            
              - 「Quote Size」：使用上限
            
              - 「Default」  
                デフォルト：チェックなし
        
          - 「保存」（Save）ボタンを押すと、設定内容をバリデーションチェックし、エラーがない場合、設定されたロケーション内容をロケーション一覧に追加させ、メッセージをロケーション一覧に表示させる  
            メッセージ：  
            　日本語：「レコードが正常に作成されました。」  
            　英語：「Record was successfully created.」
            
              - アクセスコントロールをデータベースに保存する
                
                  - テーブル名：「files\_location」
                
                  - フィールド名：  
                    ・「id」  
                    ・「name」  
                    ・「uri」  
                    ・「default」  
                    ・「type」  
                    ・「access\_key」  
                    ・「secret\_key」  
                    ・「size」  
                    ・「quota\_size」  
                    ・「max\_file\_size」
        
          - エラーメッセージは以下の通りである
            
              - 必須項目を指定しない場合、エラーメッセージを該当テキストボックスの下に表示する  
                メッセージ：  
                　日本語：「このフィールドは必須です。」  
                　英語：「This field is required.」
            
              - 「Name」のフォーマットが不正の場合、エラーメッセージを「Name」テキストボックスの下に表示する  
                メッセージ：「Invalid location name.」
        
          - 「保存してもう一つ追加」（Save and Add Another）ボタンを押すと、設定されたロケーション内容をロケーション一覧に追加させ、他のロケーションを追加設定可能とする  
            メッセージを画面上部に表示させる  
            メッセージ：  
            　日本語：「レコードが正常に作成されました。」  
            　英語：「Record was successfully created.」
        
          - 「保存して編集を続ける」（Save and Continute Editing）ボタンを押すと、設定されたロケーション内容をロケーション一覧に追加させ、該当ロケーションの編集を続けることを可能とする  
            メッセージを画面上部に表示させる  
            メッセージ：  
            　日本語：「レコードが正常に作成されました。」  
            　英語：「Record was successfully created.」
        
          - 「キャンセル」（Cancel）ボタンを押すと、設定されたロケーション内容をロール一覧に追加せず、「一覧」（List）タブに戻る

  - ロケーションごとの使用量（Size）を確認できる
    
      - 「一覧」（List）タブ及び「詳細」（Detail）タブに確認できる
    
      - 「Size」の値について
        
          - 当該ロケーション配下に登録されているコンテンツファイルのサイズ合計
        
          - 使用量の合計はコンテンツアップロード時に集計する
        
          - 以下のファイルはシステムで自動削除し、使用量に集計されないようにする
            
              - ワークフローで強制終了したアクティビティに登録していたファイル
            
              - アイテム登録後に削除したファイル
        
          - ファイルアップロード時に Quota Size を越えるときの判定条件として利用する  
            Location で表⽰される Size ＋ アップロードした Size ＞ Quota Size で判定する

  - 設定キー：「update\_location\_size」

  - 合計された「Size」の値はデータベースに保存し、表示の際はデータベースに保存した値をつかう

  - リポジトリ管理者として、ストレージ使用状況をメール通知で確認できる  
    ロケーションの「Size」が指定された閾値を超えていた場合、当該ロケーションが属する機関のリポジトリ管理者にメール通知を行う
    
      - メール通知は定期実行とし、実行頻度はコンフィグファイルに変更可能とする
        
          - 設定キー：「storage\_check\_settings」
        
          - デフォルトは週次とする
    
      - ロケーションの「Size」が指定する閾値を超えた場合メール通知の対象する
    
      - ロケーションの「Quota Size」が設定されていない場合は処理の対象としない
    
      - 閾値はコンフィグファイルに指定する
        
          - 設定キー：「storage\_check\_settings」
        
          - デフォルトは、Quota Sizeに対して「80％」とする
    
      - 通知先は「リポジトリ管理者」ロールを持つユーザーとする
    
      - メール本文は以下の資料を参照する  
        別紙「ディスク容量メールひな形.docx」を参照。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > invenio-files-rest

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - ロケーション画面の処理
    
      - ロケーション画面を表示した際に、invenio\_files\_rest.admin.LocationModelViewが継承したModelViewよりflask\_admin.model.base.index\_viewメソッドが呼び出される。このメソッドでfiles\_locationテーブルより情報を取得し、LocationModelViewのcolumn\_listにあるキーに対応する情報を画面に表示する。
        
          - 目アイコンを押下してロケーション詳細情報を表示する際に、invenio\_files\_rest.admin.LocationModelViewが継承したModelViewよりflask\_admin.model.base.details\_viewメソッドを呼び出す。このメソッド下でfiles\_locationテーブルより情報を取得し、LocationModelViewのcolumn\_details\_listにあるキーに対応する情報を画面に表示する。
        
          - 鉛筆アイコンを押下して編集画面を表示する際に、invenio\_files\_rest.admin.LocationModelViewが継承したModelViewよりflask\_admin.model.base.edit\_viewメソッドをGETで呼び出す。このメソッドでidを用いて、files\_locationテーブルより情報を取得し、表示する。
            
              - 編集画面で「保存」ボタンを押下する。そうすると、flask\_admin.model.base.edit\_viewメソッドをPOSTで呼び出す。このメソッド下で、get\_save\_return\_urlメソッドが呼ばれ、編集内容をfiles\_locationテーブルに保存し、更新する。
        
          - 削除アイコンを押下した際に、invenio\_files\_rest.admin.LocationModelViewが継承したModelViewよりflask\_admin.model.base.delete\_viewメソッドをGETで呼び出してfiles\_locationテーブルから削除する。
    
      - 作成タブを押下した際に、invenio\_files\_rest.admin.LocationModelViewが継承したModelViewよりflask\_admin.model.base.create\_viewメソッドをGETで呼び出す。LocationModelViewのform\_columnsの項目の入力欄を表示する。
        
          - 入力欄に入力後「保存」ボタンを押下する。そうすると、invenio\_files\_rest.admin.LocationModelViewが継承したModelViewよりflask\_admin.model.base.create\_viewメソッドをPOSTで呼び出す。このメソッド下でget\_save\_return\_urlメソッドが呼ばれ、新しいバケットの情報をfiles\_bucketテーブルに保存する。

  - ロケーションの使用量合計はコンテンツアップロード時に集計する
    
      - パス：  
        <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-files-rest/invenio_files_rest/utils.py#L123-L131>

  - メール通知の定期実行を設定する
    
      - パス:   
        <https://github.com/RCOSDP/weko/blob/v0.9.22/scripts/populate-instance.sh#L460-L462>
    
      - 設定キー：「storage\_check\_settings」
    
      - 現在の設定値：

> ${INVENIO\_WEB\_INSTANCE} admin\_settings create\_settings \\
> 
> 2 "storage\_check\_settings" \\
> 
> "{'threshold\_rate': 80, 'cycle': 'weekly', 'day': 0}"

  - バケットごとでの使用上限（QUOTA\_SIZE）を設定する
    
      - パス：   
        [o https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-deposit/weko\_deposit/config.py\#L27](file:///C:\\Users\\masah\\Documents\\機能仕様書\\o%09https:\\github.com\\RCOSDP\\weko\\blob\\v0.9.22\\modules\\weko-deposit\\weko_deposit\\config.py#L27)
    
      - 設定キー：「WEKO\_BUCKET\_QUOTA\_SIZE」
    
      - 現在の設定値：

> WEKO\_BUCKET\_QUOTA\_SIZE = 50 \* 1024 \* 1024 \* 1024 \# 50 GB

  - 一つのファイルの最大容量を設定する
    
      - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-deposit/weko_deposit/config.py#L30>
    
      - 設定キー：「WEKO\_MAX\_FILE\_SIZE」
    
      - 現在の設定値：

> WEKO\_MAX\_FILE\_SIZE = WEKO\_BUCKET\_QUOTA\_SIZE

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### マルチパートオブジェクト

  - > 目的・用途

本機能は、マルチパートアップロードが使用されているオブジェクトを閲覧する機能である。

※invenioデフォルト機能を使用

  - > 利用方法

【Administration \> ファイル管理(Files) \> マルチパートオブジェクト(Multipart Object)画面】を表示する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【ファイルインスタンス(File Instance)画面】には以下のタブが表示される
    
      - 一覧（List）
    
      - フィルターを追加▼（Add Filter▼）
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 選択（With selected）
    
      - 詳細（Details）
        
          - > 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 詳細（Details）タブ選択中に表示

  - 「一覧」（List）タブにマルチパートオブジェクト一覧を表示する。
    
      - 表示項目は以下の通りである。
        
          - アクセス（閲覧）
            
              - 目のマークを押すと「詳細」タブに遷移する。
        
          - 「Upload Id」
        
          - 「Complete」
        
          - 「Created」：アイテムの登録時間  
            フォーマット：YYYY-MM-DDThh:mm:ss.tttttt
        
          - 「Updated」アイテムの編集時間  
            フォーマット：YYYY-MM-DDThh:mm:ss.tttttt
        
          - 「Key」：ファイル名
        
          - 「Size」：ファイルサイズ
        
          - 「Created By」：ファイルアップロードしたユーザのメールアドレス
        
          - 「File」リンク
            
              - リンクをクリックすると、【Administration \> ファイル管理(Files) \> ファイルインスタンス(File Instance画面)】に移動し、該当ファイルがフィルターされる。RepositoryAdminはリンクではなくラベル。
            
              - フィルター条件：  
                「ID」：該当ファイルID
        
          - Item Bucket
            
              - 「Item Bucket（紐付済）」リンクをクリックすると【Administration \> ファイル管理(Files) \> バケット（Bucket）】に移動し、該当バケットがフィルタされる。RepositoryAdminの場合は、リンクではなくラベル。バケット未設定の場合は、「Unbind（未紐付）」ラベル表記される。
    
      - 「フィルターを追加▼」（Add Filter▼）ボタンをクリックすると、以下の追加可能なフィルターリストを表示し、フィルター名をクリックすると当該フィルタの入力エリアを追加する。
        
          - フィルター名
            
              - 「Upload Id」
                
                  - フィルター方式の選択肢：等しい(equals)
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「completed」
                
                  - フィルター方式の選択肢：等しい(equals)、等しくない(not equal)
                
                  - 選択したフィルター方式に対して「はい」「いいえ」
            
              - 「Created」
                
                  - フィルター方式の選択肢：等しい（equals）、等しくない（not equal）、より大きい（greater than）、より小さい（smaller than）、間（between）、間ではなく（not between）、空（empty）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Updated」
                
                  - フィルター方式の選択肢：「Created」と同じである。
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Item Bucket」
                
                  - フィルター方式の選択肢：「is Unbind」
                
                  - 入力された文字列は使わず、Unbind（未紐付）のレコードだけ
        
          - 設定したフィルターは「適用」（Apply）ボタンを押下することで一覧に適用される。
        
          - 「フィルターをリセット」（Reset filter）ボタンを押下すると、設定したフィルターがリセットされる。
    
      - 選択（With selected）ボタンをクリックすると、以下の一括処理可能な処理リストを表示し、処理をクリックすると選択したレコードに対して一括で処理を行う
        
          - 処理名
            
              - 削除（Delete）
    
      - 左端の目アイコンを押すと、該当オブジェクトバージョンの詳細情報を「詳細」（Details）タブに表示する
        
          - 表示項目は一覧タブで表示されたものと同じである。
    
      - 左端のゴミ箱アイコンを押すと、該当オブジェクトバージョンを削除する
    
      - 「完了済みかつ紐付先あり」または、レコードが排他中の場合は削除エラーとなる。「File」リンクをクリックすると、【Administration \> ファイル管理(Files) \> ファイルインスタンス(File Instance)画面】に移動し、該当ファイルがフィルターされる。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > Invenio\_files\_rest

  - > flask-admin:  
    > <https://github.com/flask-admin/flask-admin/blob/e764f6f0be3facbefb2b4d30b5c3f2f2c630d530/flask_admin/model/base.py>

<!-- end list -->

  - > 処理概要

> マルチパートオブジェクト画面の処理について

  - マルチパートオブジェクト画面を表示する。この操作によって、invenio\_files\_rest.admin. MultipartObjectModelViewが継承したModelViewよりflask\_admin.model.base.index\_viewメソッドを呼び出す。このメソッドでfiles\_multipartobjectテーブルよりバケット情報を取得し、MultipartObjectModelViewのcolumn\_listにあるキーに対応する情報を画面に表示する。
    
      - マルチパートオブジェクト詳細画面を表示する。この操作によって、invenio\_files\_rest.admin. MultipartObjectModelViewが継承したModelViewよりflask\_admin.model.base.details\_viewメソッドを呼び出す。このメソッド下でfiles\_multipartobjectテーブルよりマルチパートオブジェクト情報を取得し、MultipartObjectModelViewのcolumn\_details\_listにあるキーに対応する情報を画面に表示する。

> オブジェクトバージョンの情報は以下のようなデータベースに保存する

  - テーブル名：「files\_multipartobject」

> フィールド名：  
> ・「created」  
> ・「updated」  
> ・「upload\_id」  
> ・「bucket\_id」  
> ・「key」  
> ・「file\_id」  
> ・「chunk\_size」  
> ・「size」  
> ・「comleted」

  - > ・「created\_by\_id」更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td>2023/12/22</td>
<td>4ec162bf3bdcf843df23863fbf7d5bb36ba875e4</td>
<td>W2023-42</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>### オブジェクトバージョン

  - > 目的・用途

本機能は、管理者として、アップロードしているアイテムのファイルバージョンを管理する機能である。

  - > 利用方法

【Administration \> ファイル管理(Files) \>オブジェクトバージョン(Object Version)画面】を表示する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【オブジェクトバージョン(Object Version)画面】には以下のタブが表示される
    
      - 一覧（List）
    
      - フィルターを追加▼（Add Filter▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 詳細（Details）
        
          - > 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 詳細（Details）タブ選択中に表示

  - 「一覧」（List）タブにアイテムにアップロードしているファイルバージョンを表示する。
    
      - 表示項目は以下の通りである
        
          - アクセス（閲覧）
            
              - 目のマークを押すと「詳細」タブに遷移する。
        
          - 「Bucket」：該当バケットのID値
        
          - 「Key」：ファイル名
        
          - 「Version」：ファイルのバージョン
        
          - 「URI」：ファイルのURI
        
          - 「Is Head」：True、False  
            True：最終版の場合
        
          - 「Deleted」：削除状態
        
          - 「Size」：ファイルの容量値
        
          - 「Created」：ファイルの作成時間  
            フォーマット：「YYYY-MM-DD hh:mm:ss.tttttt」
        
          - 「Updated」：ファイルの更新時間  
            フォーマット：「YYYY-MM-DD hh:mm:ss.tttttt」
        
          - 「Versions」リンク
            
              - リンクをクリックすると、該当オブジェクトバージョンがフィルターされる。
            
              - フィルター条件：
                
                  - 「bucket / Files Bucket / Id」：該当のバケット値
                
                  - 「key」：該当のファイル名
        
          - 「Objects」リンク
            
              - リンクをクリックすると、該当オブジェクトバージョンがフィルターされる。
            
              - フィルター条件：
                
                  - 「bucket / Files Bucket / Id」：該当のバケット値
                
                  - 「Is Head」：Yes
        
          - 「File」リンク
            
              - リンクをクリックすると、【Administration \> ファイル管理(Files) \> ファイルインスタンス(File Instance)画面】に移動し、該当ファイルがフィルターされる。
            
              - フィルター条件：  
                「ID」：該当ファイルID
    
      - 「フィルターを追加▼」（Add Filter▼）ボタンをクリックすると、以下の追加可能なフィルターリストを表示し、フィルター名をクリックすると当該フィルタの入力エリアを追加する。
        
          - フィルター名
            
              - 「bucket / Files Bucket / Id」
                
                  - フィルター方式の選択肢：等しい（equals）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「bucket / Files Bucket / Locked」
                
                  - フィルター方式の選択肢：等しい（equals）、等しくない（not equal）
                
                  - 選択したフィルター方式に対して「はい」「いいえ」
            
              - 「bucket / Files Bucket / Deleted」
                
                  - フィルター方式の選択肢：「bucket / Files Bucket / Locked」と同じである。
                
                  - 選択したフィルター方式に対して「はい」「いいえ」
            
              - 「bucket / Files Bucket / Name」
                
                  - フィルター方式の選択肢：含む（contains）、含まれていません（not contains）、等しい（equals）、等しくない（not equal）、空（empty）、一覧にある（in list）、一覧にない（not in list）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「File UUID」
                
                  - フィルター方式の選択肢：「bucket / Files Bucket / Locked」と同じである。
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Checksum」
                
                  - フィルター方式の選択肢：「bucket / Files Bucket / Name」と同じである。
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Storage Class」
                
                  - フィルター方式の選択肢：「bucket / Files Bucket / Name」と同じである。
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Readable」
                
                  - フィルター方式の選択肢：「bucket / Files Bucket / Locked」と同じである。
                
                  - 選択したフィルター方式に対して「はい」「いいえ」
            
              - 「Key」
                
                  - フィルター方式の選択肢：「bucket / Files Bucket / Name」と同じである。
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Version」
                
                  - フィルター方式の選択肢：「bucket / Files Bucket / Id」と同じである。
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Is Head」
                
                  - フィルター方式の選択肢：「bucket / Files Bucket / Locked」と同じである。
                
                  - 選択したフィルター方式に対して「はい」「いいえ」
            
              - 「Size」
                
                  - フィルター方式の選択肢：等しい（equals）、等しくない（not equal）、より大きい（greater than）、より小さい（smaller than）、間（between）、間ではなく（not between）、空（empty）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - > 「Created」
                
                  - フィルター方式の選択肢：「Size」と同じである。
                
                  - > 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Updated」
                
                  - フィルター方式の選択肢：「Size」と同じである。
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
        
          - 設定したフィルターは「適用」（Apply）ボタンを押下することで一覧に適用される。
        
          - 「フィルターをリセット」（Reset filter）ボタンを押下すると、設定したフィルターがリセットされる。
    
      - 検索テキストボックス検索する  
        プレースホルダー：「Search: key」
        
          - 任意テキストを入力し、キーボードでの「Enter」を押すと、部分一致検索を行う。
        
          - テキストボックスの右端での「X」ボタンを押すと、検索条件がクリアーされる。
    
      - 左端行の目アイコンを押すと、該当オブジェクトバージョンの詳細情報を「詳細」（Details）タブに表示する。
        
          - 表示項目：Bucket、Key、Version、File UUID、URI、Checksum、Size、Storage class、Is Head、Deleted、Created、Updated、File、Versions
        
          - 「File」リンクをクリックすると、【Administration \> ファイル管理(Files) \> ファイルインスタンス(File Instance)画面】に移動し、該当ファイルがフィルターされる。
        
          - 「Versions」リンクをクリックすると、該当オブジェクトバージョンがフィルターされる。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > invenio-files-rest

  - > flask-admin:  
    > <https://github.com/flask-admin/flask-admin/blob/e764f6f0be3facbefb2b4d30b5c3f2f2c630d530/flask_admin/model/base.py>

<!-- end list -->

  - > 処理概要

> オブジェクトバージョン画面の処理について

  - オブジェクトバージョン画面を表示する。この操作によって、invenio\_files\_rest.admin. ObjectModelViewが継承したModelViewよりflask\_admin.model.base.index\_viewメソッドを呼び出す。このメソッドでfiles\_objectテーブルよりバケット情報を取得し、ObjectModelViewのcolumn\_listにあるキーに対応する情報を画面に表示する。
    
      - オブジェクトバージョン詳細画面を表示する。この操作によって、invenio\_files\_rest.admin.ObjectModelViewが継承したModelViewよりflask\_admin.model.base.details\_viewメソッドを呼び出す。このメソッド下でfiles\_objectテーブルよりオブジェクトバージョン情報を取得し、ObjectModelViewのcolumn\_details\_listにあるキーに対応する情報を画面に表示する。

> オブジェクトバージョンの情報は以下のようなデータベースに保存する

  - テーブル名：「files\_object」

<!-- end list -->

  - > フィールド名：  
    > ・「version\_id」  
    > ・「key」  
    > ・「bucket\_id」  
    > ・「file\_id」  
    > ・「root\_file\_id」  
    > ・「\_mimetype」  
    > ・「is\_head」  
    > ・「created\_user\_id」  
    > ・「updated\_user\_id」  
    > ・「bucket」  
    > ・「is\_show」  
    > ・「is\_thumbnail」  
    > ・「created」  
    > ・「updated」

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### アクセス\_ロール

<!-- end list -->

  - > 目的・用途

本機能は、各ロールのシステムでのアクセスコントロールを管理する際に使用する機能である。

  - > 利用方法

【Administration \> ユーザー管理（User Management） \> アクセス：ロール（Access: Roles）画面】にて操作を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【アクセス：ロール（Access: Roles）画面】には以下のタブが表示される
    
      - 一覧（List）
    
      - 作成（Create）
    
      - フィルターを追加▼（Add Filter▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 選択▼（With selected▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 編集（Edit）
        
          - 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示
    
      - 詳細（Details）
        
          - 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示

  - 「一覧」（List）タブにて現在のシステムでのアクセスコントロールを表示する
    
      - 表示項目は以下の通りである
        
          - チェックボックス
        
          - アクション（閲覧・編集・削除を表すアイコン）
        
          - 「Role Name」
        
          - 「Action」
        
          - 「Argument」
        
          - 「Deny」
    
      - 「フィルターを追加▼」（Add Filter▼）ボタンをクリックすると、以下の追加可能なフィルターリストを表示し、フィルター名をクリックすると当該フィルタの入力エリアを追加する
        
          - フィルター名は以下の通りである
            
              - 「Role Name」
                
                  - フィルター方式の選択肢：含む（contains）、含まれていません（not contains）、等しい（equals）、等しくない（not equal）、空（empty）、一覧にある（in list）、一覧にない（not in list）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Action」
            
              - フィルター方式の選択肢：上記の「Role Name」と同じである
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Argument」
                
                  - フィルター方式の選択肢：上記の「Role Name」と同じである
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Deny」
                
                  - フィルター方式の選択肢：等しい（equals）、等しくない（not equal）
                
                  - 入力エリアではなく選択肢「はい」「いいえ」を使い、「はい」ならアクセス許可のコントロール、「いいえ」ならアクセス拒否のコントロールを絞り込む
        
          - 設定したフィルターは「適用」（Apply）ボタンを押下することで一覧に適用される
        
          - 「フィルターをリセット」（Reset filter）ボタンを押下すると、設定したフィルターがリセットされる
    
      - 「選択▼」（With selected▼）ボタンをクリックすると、以下の追加可能な機能（現在削除ボタンのみ）を表示する
        
          - レコードにチェックを入れない場合、「削除」（Delete）ボタンを押すと、エラーメッセージを表示する  
            メッセージ：  
            　日本語：「少なくとも一つのレコードを選択してください。」  
            　英語：「Please select at least one record.」
        
          - レコードにチェックを入れる場合、「削除」（Delete）ボタンを押すと、確認ダイアログを表示する  
            メッセージ：  
            　日本語：「選択したレコードを削除してもよろしいですか。」  
            　英語：「Are you sure you want to delete selected records?」
            
              - 「OK」ボタンを押すと、該当ロールを削除し、メッセージを画面上部に表示する  
                メッセージ：  
                　日本語：「レコード数＋レコードが正常に削除されました。」  
                　英語：「Record was successfully deleted.」
            
              - 「キャンセル」（Cancel）ボタンを押すと、確認ダイアログを閉じる
    
      - アクセスコントロール行にて目アイコンを押すと、該当アクセスコントロールの詳細情報を「詳細」（Details）タブに表示する
        
          - 表示項目：Role、Action、Deny、Argument
        
          - 「移動」（Filter）テキストボックスにテキストを入力すると、入力値が項目名またはその値に含まれている項目に絞り込んで表示する
    
      - アクセスコントロール行にて鉛筆アイコンを押すと、該当アクセスコントロールを「編集」（Edit）タブに表示し、アクセスコントロールの情報が編集できる
        
          - 入力情報とボタン操作は、後述の「作成」（Create）タブと同じである
    
      - アクセスコントロール行にて削除アイコンを押すと、該当アクセスコントロールを削除し、メッセージを画面上部に表示する  
        メッセージ：  
        　日本語：「レコード数＋レコードが正常に削除されました。」  
        　英語：「Record was successfully deleted.」

  - 「一覧」（List）から「作成」（Create）タブを押すと、「作成」（Create）タブに移動し、アクセスコントロールを新規作成できる
    
      - 入力情報は以下の通りである
        
          - 「Role」：必須項目  
            選択肢：システムに作成されたロール一覧
        
          - 「Action」：必須項目ではないがプルダウンメニューによって必ず１つ選択される  
            選択肢：「access\_actionsroles.action」から取得されている一覧
        
          - 「Argument」  
            255文字までの自由入力  
            255文字を超えると以下のエラーメッセージが表示される  
            メッセージ：  
            日本語：「フィールドは 255 文字を超えることはできません。」  
            英語：「Field cannot be longer than 255 characters.」
        
          - 「Deny」
    
      - 「保存」（Save）ボタンを押すと、設定されたアクセスコントロール内容をアクセスコントロール一覧に追加させ、メッセージをアクセスコントロール一覧に表示させる  
        メッセージ：  
        　日本語：「レコードが正常に作成されました。」  
        　英語：「Record was successfully created.」
        
          - アクセスコントロールをデータベースに保存する
            
              - テーブル名：「access\_actionsroles」
            
              - フィールド名：  
                ・「id」  
                ・「action」  
                ・「exclude」  
                ・「argument」  
                ・「role\_id」
    
      - ［保存してもう一つ追加（Save and Add Another）］ボタンを押すと、設定されたアクセスコントロール内容をロール一覧に追加させ、他のアクセスコントロールを追加設定可能とする  
        メッセージを画面上部に表示させる  
        メッセージ：  
        　日本語：「レコードが正常に作成されました。」  
        　英語：「Record was successfully created.」
    
      - ［保存して編集を続ける（Save and Continue Editing）］ボタンを押すと、設定されたアクセスコントロール内容をアクセスコントロール一覧に追加させ、該当アクセスコントロールの編集を続けることを可能とする  
        メッセージを画面上部に表示させる  
        メッセージ：  
        　日本語：「レコードが正常に作成されました。」  
        　英語：「Record was successfully created.」
    
      - ［キャンセル（Cancel）］ボタンを押すと、設定されたアクセスコントロール内容をアクセスコントロール一覧に追加せず、「一覧」（List）タブに戻る

  - v0.9.22でのデフォルトアクセスコントロールは以下の通りである
    
      - パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/scripts/populate-instance.sh#L241-L338>

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - invenio\_access（WEKOソース内にforkされていない）

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 本画面は、flask\_adminのModelViewを使っている。

  - 画面の設定をもとに、以下のようにaccess\_actionsrolesテーブルに保存する。
    
      - 「id」フィールド：画面上の入力によらない
    
      - 「action」フィールド：画面上の「Action」で選択されたもの
    
      - 「exclude」フィールド：画面上の「Deny」にチェックが入っていたらTrue、そうでなければFalse
    
      - 「argument」フィールド：画面上の「Argument」の入力値
    
      - 「role\_id」フィールド：accounts\_roleテーブルで、画面上の「Role」で選択されたものと「name」が一致するレコードの「id」フィールド

  - 各actionは、関数へのアノテーションでアクセス制御に利用する。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>

### アクセス\_システムロール

  - > 目的・用途

本機能は、全ユーザーに一括付与する権限を管理する機能である。

  - > 利用方法

【Administration \> ユーザー管理（User Management） \> アクセス：システムロール（Access: System Roles）画面】にて操作を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 画面の主な構成と操作方法は、【アクセス：ロール（Access: Roles）画面】と同様である。[ADMIN-13-1: アクセス\_ロール](\\l)を参照すること。
    
      - 一覧（List）タブでは、【アクセス：ロール（Access: Roles）画面】の「Role」と異なり「System Role」が表示される。
    
      - 「作成」（Create）タブでは、【アクセス：ロール（Access: Roles）画面】の「Role」と異なり「System Role」を選択する。
        
          - 「System Role」の選択肢は以下の通りである。
            
              - 「any\_user」：ゲストを含むすべての操作者を対象とする。
            
              - 「authenticated\_user」：ログインしているすべての操作者を対象とする。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - invenio\_access（WEKOソース内にforkされていない）

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 画面の設定をもとに、以下のようにaccess\_actionssystemrolesテーブルに保存する。
    
      - 「id」フィールド：画面上の入力によらない
    
      - 「action」フィールド：画面上の「Action」で選択されたもの
    
      - 「exclude」フィールド：画面上の「Deny」にチェックが入っていたらTrue、そうでなければFalse
    
      - 「argument」フィールド：画面上の「Argument」の入力値
    
      - 「role」フィールド：画面上の「System Role」で選択されたもの

  - 各actionは、関数へのアノテーションでアクセス制御に利用する。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### アクセス\_ユーザー

  - > 目的・用途

本機能は、個別のユーザーに付与する権限を管理する機能である。

  - > 利用方法

【Administration \> ユーザー管理（User Management） \> アクセス：ユーザー（Access: Users）画面】にて操作を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 画面の主な構成と操作方法は、【アクセス：ロール（Access: Roles）画面】と同様である。[ADMIN-13-1: アクセス\_ロール](\\l)を参照すること。
    
      - 一覧（List）タブでは、【アクセス：ロール（Access: Roles）画面】の「Role」と異なり「User ID」と「Email」が表示される。
        
          - 「User ID」と「Email」には、accounts\_userテーブルの「id」「email」フィールドの値が表示される。
    
      - 「作成」（Create）タブでは、【アクセス：ロール（Access: Roles）画面】の「Role」と異なり「User」を選択する。
        
          - 「User」の選択肢として、accounts\_userテーブルに登録されたユーザーが表示される。
        
          - 各選択肢は、「User\<id=(レコードのid), email=(レコードのemail)\>」の形で表示される。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - invenio\_access（WEKOソース内にforkされていない）

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 画面の設定をもとに、以下のようにaccess\_actionsusersテーブルに保存する。
    
      - 「id」フィールド：画面上の入力によらない
    
      - 「action」フィールド：画面上の「Action」で選択されたもの
    
      - 「exclude」フィールド：画面上の「Deny」にチェックが入っていたらTrue、そうでなければFalse
    
      - 「argument」フィールド：画面上の「Argument」の入力値
    
      - 「user\_id」フィールド：画面上の「User」で選択されたユーザーのid

  - 各actionは、関数へのアノテーションでアクセス制御に利用する。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>

### 連結アカウント識別子

  - > 目的・用途

本機能は、invenioデフォルト機能を使用してaccounts\_useridentityテーブルをメンテナンスする際に使用する機能であるが、WEKO v0.9.22ではこのテーブルを使用していない。

  - > 利用方法

【Administration \> ユーザー管理（User Management） \> 連結アカウント識別子（Linked account identities）画面】にて操作を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 
<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - invenio\_accounts（関連するソースはWEKOにフォークされてない）

<!-- end list -->

  - > 処理概要

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2022/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### 連結アカウントトークン

  - > 目的・用途

本機能は、invenioデフォルト機能を使用してoauthclient\_remotetokenテーブルをメンテナンスする際に使用する機能であるが、WEKO v0.9.22ではこのテーブルを使用していない。

  - > 利用方法

【Administration \> ユーザー管理（User Management） \> 連結アカウントトークン（Linked account tokens）画面】にて操作を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 
<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - invenio\_oauthclient（WEKOソース内にforkされていない）

<!-- end list -->

  - > 処理概要

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### 連結アカウント

  - > 目的・用途

本機能は、invenioデフォルト機能を使用してoauthclient\_remotetokenテーブルをメンテナンスする際に使用する機能であるが、WEKO v0.9.22ではこのテーブルを使用していない。

  - > 利用方法

【Administration \> ユーザー管理（User Management） \> 連結アカウント（Linked accounts）画面】にて操作を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 
<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - invenio\_oauthclient（WEKOソース内にforkされていない）

<!-- end list -->

  - > 処理概要

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### OAuthアプリケーショントークン

  - > 目的・用途

本機能は、管理者として登録されているOAuthアプリケーショントークンを閲覧、編集、削除する機能である。

※invenioデフォルト機能を使用

  - > 利用方法

【Administration \> ユーザー管理(User Management) \> OAuthアプリケーショントークン(OAuth Application Tokens)】を表示する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【OAuthアプリケーショントークン(OAuth Application Tokens)画面】には以下のタブが表示される
    
      - 一覧（List）
    
      - 作成（Create）
    
      - 選択▼（With selected▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 編集（Edit）
        
          - > 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示
    
      - 詳細（Details）
        
          - > 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示

  - 「一覧」（List）タブにトークン一覧を表示する。
    
      - 表示項目は以下の通りである。
        
          - チェックボックス
        
          - アクセス（閲覧・編集・削除）
            
              - 目のマークを押すと「詳細」タブに遷移する。
            
              - 鉛筆のマークを押すと「編集」タブに遷移する。
            
              - ゴミ箱のマークを押すとその行のトークンは削除される。  
                なお、oauth2server\_tokenテーブルからは削除されるがoauth2server\_clientテーブルの対応したものは削除されない。
        
          - 「Id」：トークンのID
        
          - 「Client Id」：OAuthアプリケーション側のID
        
          - 「User Id」：接続するユーザーID
        
          - 「Token Type」：bearerのみ
        
          - 「Expires」：有効期限
    
      - 左から2列目にある目アイコンを押すと、該当トークンの詳細情報を「詳細」（Details）タブに表示する
        
          - 表示項目：Id, Client id, User Id', Token Type, Expires
    
      - 左から２列目にある鉛筆アイコンを押すと、「編集」（Edit）タブに表示し、ユーザーの情報が編集できる
        
          - 編集可能な項目は以下の通りである
            
              - 「Client」
                
                  - 選択肢：OAuthアプリケーションにて登録されているものからプルダウンで選択する。
                
                  - 部分一致検索ができる。
                
                  - 必須項目である。
            
              - 「User」
                
                  - 選択肢：登録されているユーザーから選択する。
                
                  - 部分一致検索ができる。
            
              - 「Token Type」:対応しているものはbearerのみである。  
                ただし、編集、保存する際は自由記述
            
              - 「Expires」:カレンダーから指定できる。
            
              - 「Is Personal」：個人用
            
              - 「Is Internal」：内部用
        
          - 「保存」（Save）ボタンを押すと、編集内容を保存し、メッセージを一覧画面の上部に表示する  
            メッセージ：  
            　日本語：「レコードが正常に保存されました。」  
            　英語：「Record was successfully saved.」
    
      - 複数のトークンを一度に削除する。
        
          - 左端のチェックボックスにチェックを入れ、選択タブから「削除」を選ぶと、削除するかの確認アラートが表示される、
            
              - OKを押すとチェックボックスにチェックを入れた行のトークンは削除される。
            
              - キャンセルを押すとキャンセルできる。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > invenio\_oauth2server

  - > flask\_admin:  
    > <https://github.com/flask-admin/flask-admin/blob/e764f6f0be3facbefb2b4d30b5c3f2f2c630d530/flask_admin/model/base.py>

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - OAuthアプリケーショントークン画面の処理について（以下トークン画面とする）
    
      - トークン画面を表示する。この操作によって、invenio\_oauth2server.admin.TokenViewが継承したModelViewよりflask\_admin.model.base.index\_viewメソッドを呼び出す。このメソッドでoauth2server\_tokenテーブルよりトークン情報を取得し、TokenViewcolumn\_listにあるキーに対応する情報を画面に表示する。
        
          - トークン詳細画面を表示する。この操作によって、invenio\_files\_rest.admin.TokenViewが継承したModelViewよりflask\_admin.model.base.details\_viewメソッドを呼び出す。このメソッド下でoauth2server\_tokenテーブルよりトークン情報を取得し、TokenViewのcolumn\_details\_listにあるキーに対応する情報を画面に表示する。
    
      - トークン編集画面を表示する。この操作によって、invenio\_files\_rest.admin.TokenViewが継承したModelViewよりflask\_admin.model.base.edit\_viewメソッドをGETで呼び出す。このメソッド下で開いたid列を用いて、oauth2server\_tokenテーブルよりトークン情報を取得し、表示する。
        
          - トークン編集画面で「保存」ボタンを押下する。この操作によって、flask\_admin.model.base.edit\_viewメソッドをPOSTで呼び出す。このメソッド下で、get\_save\_return\_urlメソッドが呼ばれ、編集内容をoauth2server\_tokenテーブルに保存し、更新する。
    
      - トークン画面に表示される表の左から２列目のゴミ箱マークを押下する。この操作によって、invenio\_files\_rest.admin.TokenViewが継承したModelViewよりflask\_admin.model.base.delete\_viewメソッドを呼び出す。このメソッド下でdelete\_modelメソッドが呼ばれ、押下したゴミ箱の行のトークンをoauth2server\_tokenテーブルから削除する。
    
      - トークン画面に表示される表の左端のチェックボックスにチェックを入れ、選択タブから「削除」を押下する。この操作によってinvenio\_files\_rest.admin.TokenViewが継承したModelViewよりflask\_admin.model.base.action\_viewメソッドを呼び出す。ここでDeleteRowActionが呼ばれ、チェックを入れた行のトークンをoauth2server\_tokenテーブルから削除する。

> トークン情報は以下のようなデータベースに保存する。

  - テーブル名：「oauth2server\_token」

  - > フィールド名：  
    > ・「id」  
    > ・「client\_id」  
    > ・「user\_id」  
    > ・「token\_type」  
    > ・「access\_token」  
    > ・「refresh\_token」  
    > ・「expires」  
    > ・「\_scopes」  
    > ・「is\_personal」  
    > ・「is\_internal」

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### OAuthアプリケーション

  - > 目的・用途

本機能は、管理者として登録されているOAuthアプリケーション情報を閲覧、編集、削除する機能である。  
※invenioデフォルト機能を使用

  - > 利用方法

【Administration \> ユーザー管理(User Management) \> OAuthアプリケーション(OAuth Applications)】を表示する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【OAuthアプリケーション (OAuth Applications)画面】には以下のタブが表示される
    
      - 一覧（List）
    
      - 作成（Create）
    
      - 選択▼（With selected▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 編集（Edit）
        
          - > 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示
    
      - 詳細（Details）
        
          - > 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示

  - 「一覧」（List）タブにOAuthアプリケーション一覧を表示する。
    
      - 表示項目は以下の通りである。
        
          - チェックボックス
        
          - アクセス（閲覧・編集・削除）
            
              - 目のマークを押すと「詳細」タブに遷移する。
            
              - 鉛筆のマークを押すと「編集」タブに遷移する。
            
              - ゴミ箱のマークを押すとその行のレコードは削除される。  
                なお、そのレコードのClient Idを使用しているトークンはoauth2server\_ tokenテーブルから削除される。
        
          - 「Name」：OAuth表示名
        
          - 「Description」：説明、備考
        
          - 「Website」：URL
        
          - 「User Id」：ユーザー側のＩＤ
        
          - 「Client Id」：クライアント側のＩＤ
    
      - 左から2列目にある目アイコンを押すと、該当OAuthの詳細情報を「詳細」（Details）タブに表示する
        
          - 表示項目：Name, Description, Website, User Id, Client id
    
      - 左から２列目にある鉛筆アイコンを押すと、「編集」（Edit）タブに表示し、ユーザーの情報が編集できる
        
          - 編集可能な項目は以下の通りである。
            
              - 「User」
                
                  - 選択肢：登録されているユーザーから選択する。
                
                  - 部分一致検索ができる。
            
              - 「Name」：自由記述
            
              - 「Description」：自由記述
            
              - 「Client Secret」:必須項目である。Client Idとは別のものである。自由記述
            
              - 「Is Confidential」：機密であるかどうか
            
              - 「Is Internal」：内部用
            
              - 「Oauth2Tokens」
                
                  - 選択肢：登録されているトークンから複数選択する。
                
                  - 部分一致検索ができる。ただし、トークンのIDでの検索となる。
        
          - 「保存」（Save）ボタンを押すと、編集内容を保存し、メッセージを一覧画面の上部に表示する  
            メッセージ：  
            　日本語：「レコードが正常に保存されました。」  
            　英語：「Record was successfully saved.」
    
      - 複数のOAuth情報を一度に削除する。
        
          - 左端のチェックボックスにチェックを入れ、選択タブから「削除」を選ぶと、削除するかの確認アラートが表示される、
            
              - OKを押すとチェックボックスにチェックを入れた行のトークンは削除される。
            
              - キャンセルを押すとキャンセルできる。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > invenio\_oauth2server

  - > flask\_admin:  
    > <https://github.com/flask-admin/flask-admin/blob/e764f6f0be3facbefb2b4d30b5c3f2f2c630d530/flask_admin/model/base.py>

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - OAuthアプリケーション画面の処理について
    
      - OAuthアプリケーション画面を表示する。その場合、invenio\_oauth2server.admin.ClientViewが継承したModelViewよりflask\_admin.model.base.index\_viewメソッドを呼び出す。このメソッドでoauth2server\_clientテーブルよりOAuth情報を取得し、ClientViewのcolumn\_listにあるキーに対応する情報を画面に表示する。
        
          - OAuthアプリケーション詳細画面を表示する。この操作によって、invenio\_files\_rest.admin.ClientViewが継承したModelViewよりflask\_admin.model.base.details\_viewメソッドを呼び出す。このメソッド下でoauth2server\_clientテーブルよりOAuth情報を取得し、ClientViewのcolumn\_details\_listにあるキーに対応する情報を画面に表示する。
    
      - OAuthアプリケーション編集画面を表示する。この操作によって、invenio\_files\_rest.admin.ClientViewが継承したModelViewよりflask\_admin.model.base.edit\_viewメソッドをGETで呼び出す。このメソッド下で開いたoauth2server\_clientテーブルよりOAuth情報を取得し、表示する。
        
          - OAuthアプリケーション編集画面で「保存」ボタンを押下する。この操作によって、flask\_admin.model.base.edit\_viewメソッドをPOSTで呼び出す。このメソッド下で、get\_save\_return\_urlメソッドが呼ばれ、編集内容をoauth2server\_clientテーブルに保存し、更新する。
    
      - > OAuthアプリケーション画面に表示される表の左から２列目のゴミ箱マークを押下する。この操作によって、invenio\_files\_rest.admin.ClientViewが継承したModelViewよりflask\_admin.model.base.delete\_viewメソッドを呼び出す。このメソッド下でdelete\_modelメソッドが呼ばれ、押下したゴミ箱の行のトークンをoauth2server\_clientテーブルから削除する。
    
      - OAuthアプリケーション画面に表示される表の左端のチェックボックスにチェックを入れ、選択タブから「削除」を押下し、OKを押下する。この操作によって、invenio\_files\_rest.admin.ClientViewが継承したModelViewよりflask\_admin.model.base.action\_viewメソッドを呼び出す。ここでDeleteRowActionが呼ばれ、チェックを入れた行のトークンをoauth2server\_clientテーブルから削除する。

> OAuth情報は以下のようなデータベースに保存する。

  - テーブル名：「oauth2server\_client」

  - > フィールド名：  
    > ・「name」  
    > ・「description」  
    > ・「website」  
    > ・「user\_id」  
    > ・「client\_id」  
    > ・「client\_secret」  
    > ・「is\_confidential」  
    > ・「is\_internal」  
    > ・「\_redirect\_uris」  
    > ・「\_default\_scopes」

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### ロール

  - > 目的・用途

本機能は、システムのロールを管理（追加・編集・削除）する際に使用する機能である。

  - > 利用方法

【Administration \> ユーザー管理（User Management） \> ロール（Role）画面】にて操作を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【ロール（Role）画面】には以下のタブが表示される
    
      - 一覧（List）
    
      - 作成（Create）
    
      - フィルターを追加▼（Add Filter▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 選択▼（With selected▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 編集（Edit）
        
          - 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示
    
      - 詳細（Details）
        
          - 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示

  - 「一覧」（List）タブに現在のシステムのロールを表示する
    
      - 表示項目は以下の通りである
        
          - チェックボックス
        
          - アクション（閲覧・編集・削除を表すアイコン）
        
          - 「Id」
        
          - 「Name」
        
          - 「Description」
    
      - 「フィルターを追加▼」（Add Filter▼）ボタンをクリックすると、以下の追加可能なフィルターリストを表示し、フィルター名をクリックすると当該フィルタの入力エリアを追加する
        
          - フィルター名
            
              - 「Id」
                
                  - フィルター方式の選択肢：等しい（equals）、等しくない（not equal）、より大きい（greater than）、より小さい（smaller than）、空（empty）、一覧にある（in list）、一覧にない（not in list）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Name」
                
                  - フィルター方式の選択肢：含む（contains）、含まれていません（not contains）、等しい（equals）、等しくない（not equal）、空（empty）、一覧にある（in list）、一覧にない（not in list）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Description」
                
                  - フィルター方式の選択肢：上記の「Name」と同じである
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
        
          - 設定したフィルターは「適用」（Apply）ボタンを押下することで一覧に適用される
        
          - 「フィルターをリセット」（Reset filter）ボタンを押下すると、設定したフィルターがリセットされる
    
      - 「選択▼」（With selected▼）ボタンをクリックすると、以下の追加可能な機能（現在削除ボタンのみ）を表示する
        
          - レコードにチェックを入れない場合、「削除」（Delete）ボタンを押すと、エラーメッセージを表示する  
            メッセージ：  
            　日本語：「少なくとも一つのレコードを選択してください。」  
            　英語：「Please select at least one record.」
        
          - レコードにチェックを入れる場合、「削除」（Delete）ボタンを押すと、確認ダイアログを表示する  
            メッセージ：  
            　日本語：「選択したレコードを削除してもよろしいですか。」  
            　英語：「Are you sure you want to delete selected records?」
            
              - 「OK」ボタンを押すと、該当ロールを削除し、メッセージを画面上部に表示する  
                メッセージ：  
                　日本語：「レコード数＋レコードが正常に削除されました。」  
                　英語：「Record was successfully deleted.」
            
              - 「キャンセル」（Cancel）ボタンを押すと、確認ダイアログを閉じる
    
      - 検索テキストボックスでロールを検索する
        
          - プレースホルダー：「Search: id, name, description」
        
          - 任意テキストを入力し、キーボードでの「Enter」を押すと、Id、ロール名、説明での検索を行う
        
          - テキストボックスの右端での「X」ボタンを押すと、検索条件がクリアーされる
    
      - ロール行にて目アイコンを押すと、該当ロールの詳細情報を「詳細」（Details）タブに表示する
        
          - 表示項目：ID、ロール名、説明
    
      - ロール行にて鉛筆アイコンを押すと、該当ロールを「編集」（Edit）タブに表示し、ロールの情報が編集できる
    
      - ロール行にて削除アイコンを押すと、該当ロールを削除し、メッセージを画面上部に表示する  
        メッセージ：  
        　日本語：「レコード数＋レコードが正常に削除されました。」  
        　英語：「Record was successfully deleted.」

  - 「一覧」（List）から「作成」（Create）タブを押すと、「作成」（Create）タブに移動し、ロールを新規作成できる
    
      - 入力情報：「Name」（ロール名）、「Description」（ロールの説明）、「Users」
        
          - NameとDescriptionは自由入力
        
          - Usersは、Emailを選択する
    
      - ［保存（Save）］ボタンを押すと、設定されたロール内容をロール一覧に追加させ、メッセージをロール一覧に表示させる  
        メッセージ：  
        　日本語：「レコードが正常に作成されました。」  
        　英語：「Record was successfully created.」
        
          - ロールをデータベースに保存する
            
              - テーブル名：「accounts\_role」
            
              - フィールド名：  
                ・「id」  
                ・「name」  
                ・「description」
    
      - ［保存してもう一つ追加（Save and Add Another）］ボタンを押すと、設定されたロール内容をロール一覧に追加させ、他のロールを追加設定可能とする  
        メッセージを画面上部に表示させる  
        メッセージ：  
        　日本語：「レコードが正常に作成されました。」  
        　英語：「Record was successfully created.」
    
      - ［保存して編集を続ける（Save and Continue Editing）］ボタンを押すと、設定されたロール内容をロール一覧に追加させ、該当ロールの編集を続けることを可能とする  
        メッセージを画面上部に表示させる  
        メッセージ：  
        　日本語：「レコードが正常に作成されました。」  
        　英語：「Record was successfully created.」
    
      - ［キャンセル（Cancel）］ボタンを押すと、設定されたロール内容をロール一覧に追加せず、「一覧」（List）タブに戻る
    
      - 新規作成時、コンフィグでACCOUNTS\_WORKFLOW\_ROLE\_HIDE\_FILTER=Trueだった場合には、そのロールのユーザーでは各ワークフローが表示されないように設定される
        
          - そのロールで操作するときは、ワークフロー一覧に表示されず、アクティビティ作成時にそのワークフローを選択できない
        
          - 詳細は[ADMIN-7-2: ワークフロー](\\l)を参照

  - v0.9.22でのデフォルトロールは以下の通りである
    
      - パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/scripts/populate-instance.sh#L228-L231>
    
      - ロール：
        
          - 「System Administrator」
        
          - 「Repository Administrator」
        
          - 「Community Administrator」
        
          - 「Contributor」

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - invenio\_accounts

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 環境構築時にpopulate-instance.shで初期データを登録することで、デフォルトロールの作成と、各ロールへの権限付与が行われる。
    
      - 各デフォルトロールの名前は、作成時に環境変数で設定される
        
          - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/docker-compose.yml#L57-L60>

  - 本画面では、accounts\_roleテーブルのデータを作成、編集、削除する。
    
      - 作成、編集時は、画面の設定をもとに、以下のようにaccess\_actionssystemrolesテーブルに保存する。
        
          - 「id」フィールド：画面上の入力によらない
        
          - 「name」フィールド：画面上の「Name」で入力されたもの
        
          - 「description」フィールド：画面上の「Description」で入力されたもの

  - ロールを作成、編集したとき、invenio\_accounts.admin.RoleView.after\_model\_changeメソッドが呼び出される。分岐によって、以下の場合のみ処理を行う。
    
      - ロールを新規作成したとき、コンフィグのACCOUNTS\_WORKFLOW\_ROLE\_HIDE\_FILTERがTrueである場合にのみ、workflow\_userroleテーブルにレコードが作成される。
        
          - コンフィグは以下を参照する。
            
              - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-accounts/invenio_accounts/config.py#L227>
            
              - キー：ACCOUNTS\_WORKFLOW\_ROLE\_HIDE\_FILTER
        
          - 作成前にworkflow\_workflowテーブルを参照して、is\_deletedがfalseであるレコードを取得する。その数だけworkflow\_userroleテーブルにレコードを作成する。
        
          - 作成するレコードでは、フィールドを以下のように設定する。
            
              - 「workflow\_id」：workflow\_workflowテーブルから取得した各レコードの「id」フィールドの値。１レコードにつき１idを設定する。
            
              - 「role\_id」：それぞれのレコードに、accounts\_roleテーブルに新規作成したレコードの「id」フィールドの値を設定する。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### セッションアクティビティ

  - > 目的・用途

本機能は、活動セッションを確認する際に使用する機能である。

  - > 利用方法

【Administration \> ユーザー管理（User Management） \> セッションアクティビティ（Session Activity）画面】にて操作を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【セッションアクティビティ（Session Activity）画面】には以下のタブが表示される
    
      - 一覧（List）
    
      - フィルターを追加▼（Add Filter▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 選択▼（With selected▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー

  - 「一覧」（List）タブでの表示項目は以下の通りである
    
      - チェックボックス
    
      - アクション（削除を表すアイコン）
    
      - 「User ID」
    
      - 「Email」
    
      - 「Session ID」
    
      - 「Created」  
        フォーマット：「YYYY-MM-DDThh:mm:ss.tttttt」

  - 「フィルターを追加▼」（Add Filter▼）ボタンをクリックすると、以下の追加可能なフィルターリストを表示し、フィルター名をクリックすると当該フィルタの入力エリアを追加する
    
      - フィルター名
        
          - 「User ID」
            
              - フィルター方式の選択肢：等しい（equals）、等しくない（not equal）、より大きい（greater than）、より小さい（smaller than）、空（empty）、一覧にある（in list）、一覧にない（not in list）
        
          - 「Email」
            
              - フィルター方式の選択肢：含む（contains）、含まれていません（not contains）、等しい（equals）、等しくない（not equal）、空（empty）、一覧にある（in list）、一覧にない（not in list）
        
          - 「Session ID」
            
              - フィルター方式の選択肢：上記の「Email」と同じである
        
          - 「Created」
            
              - フィルター方式の選択肢：等しい（equals）、等しくない（not equal）、より大きい（greater than）、より小さい（smaller than）、間（between）、間ではなく（not between）、空（empty）
            
              - フォーマット：「YYYY-MM-DD hh:mm:ss」
    
      - 設定したフィルターは「適用」（Apply）ボタンを押下することで一覧に適用される
    
      - 「フィルターをリセット」（Reset filter）ボタンを押下すると、設定したフィルターがリセットされる

  - 「選択▼」（With selected▼）ボタンをクリックすると、以下の追加可能な機能（「Delete selected sessions」ボタン）を表示する
    
      - レコードにチェックを入れない場合、「Delete selected sessions」ボタンを押すと、エラーメッセージを表示する  
        メッセージ：  
        　日本語：「少なくとも一つのレコードを選択してください。」  
        　英語：「Please select at least one record.」
    
      - レコードにチェックを入れる場合、「Delete selected sessions」ボタンを押すと、確認ダイアログを表示する  
        メッセージ：「Are you sure you want to delete selected sessions?」
        
          - 「OK」ボタンを押すと、該当活動セッションを削除する
            
              - チェックを入れていたレコードに現在のセッションを指すレコードが含まれていた場合、削除されずに以下のエラーメッセージが表示される  
                エラーメッセージ：「You could not remove your current session」
        
          - 「キャンセル」（Cancel）ボタンを押すと、確認ダイアログを閉じる

  - 活動セッション行にて削除アイコンを押すと、該当活動セッションを削除する
    
      - 現在のセッションを指す行では、削除されずに以下のエラーメッセージが表示される  
        エラーメッセージ：「You could not remove your current session」

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - invenio\_accounts

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - ごみ箱ボタンによってレコードを削除する場合は、invenio\_accounts.admin.SessionActivityView. delete\_modelメソッドが呼び出される
    
      - 現在のログインのセッションのID（session.sid\_s）と対象レコードのSession IDとを比較して、同じだった場合には削除せずエラーメッセージを表示する

  - 「Delete selected sessions」によってレコードを削除する場合は、invenio\_accounts.admin.SessionActivityView.action\_deleteメソッドが呼び出される
    
      - 現在のセッションのID（session.sid\_s）と選択した各レコードのSession IDとを比較して、同じであるレコードがあった場合には削除せずエラーメッセージを表示する

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### ユーザー

  - > 目的・用途

本機能は、ユーザーの新規作成、編集、削除を行う際に使用する機能である。

  - > 利用方法

【Administration \> ユーザー管理（User Management） \> ユーザー（User）画面】にて操作を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【ユーザー（User）画面】には以下のタブが表示される
    
      - 一覧（List）
    
      - 作成（Create）
    
      - フィルターを追加▼（Add Filter▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 選択▼（With selected▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 編集（Edit）
        
          - 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示
    
      - 詳細（Details）
        
          - 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示

  - 「一覧」（List）タブに登録されているユーザーを表示する
    
      - 表示項目は以下の通りである
        
          - チェックボックス
        
          - アクション（閲覧・編集・削除を表すアイコン）
        
          - 「Id」
        
          - 「Email」
        
          - 「Active」
        
          - 「Confirmed At」
        
          - 「Last Login At」  
            フォーマット：「YYYY-MM-DDThh:mm:ss.tttttt」
        
          - 「Current Login At」  
            フォーマット：「YYYY-MM-DDThh:mm:ss.tttttt」
        
          - 「Last Login IP」
        
          - 「Current Login IP」
        
          - 「Login Count」
    
      - 表示内容は、accounts\_userテーブル、accounts\_userroleテーブルから取得した情報である
    
      - 「フィルターを追加▼」（Add Filter▼）ボタンをクリックすると、以下の追加可能なフィルターリストを表示し、フィルター名をクリックすると当該フィルターの入力エリアを追加する
        
          - フィルター名
            
              - 「Id」
                
                  - フィルター方式の選択肢：フィルター方式の選択肢：等しい（equals）、等しくない（not equal）、より大きい（greater than）、より小さい（smaller than）、空（empty）、一覧にある（in list）、一覧にない（not in list）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Email」
                
                  - フィルター方式の選択肢：含む（contains）、含まれていません（not contains）、等しい（equals）、等しくない（not equal）、空（empty）、一覧にある（in list）、一覧にない（not in list）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「Active」
                
                  - フィルター方式の選択肢：等しい（equals）、等しくない（not equal）
                
                  - 入力エリアではなく選択肢「はい」「いいえ」を使い、「はい」ならアクティブなユーザー、「いいえ」ならそうでないユーザーを絞り込む
            
              - 「Confirmed At」
                
                  - フィルター方式の選択肢：等しい（equals）、等しくない（not equal）、より大きい（greater than）、より小さい（smaller than）、間（between）、間ではなく（not between）、空（empty）
                
                  - 入力エリアをクリックするとカレンダーが表示されるので、日時を選択して［Apply］押下することで絞り込む日時を設定する（入力することもできる）
                
                  - 日時を設定しなかった場合は現在日時を設定する
            
              - 「Last Login At」
                
                  - フィルター方式の選択肢：上記の「Confirmed At」と同じである
            
              - 「Current Login At」
                
                  - フィルター方式の選択肢：上記の「Confirmed At」と同じである
            
              - 「Login Count」
                
                  - フィルター方式の選択肢：上記の「Id」と同じである
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
        
          - 設定したフィルターは［適用（Apply）］ボタンを押下することで一覧に適用される
        
          - ［フィルターをリセット（Reset filter）］ボタンを押下すると、設定したフィルターがリセットされる
    
      - 「選択▼」（With selected▼）ボタンをクリックすると、以下の追加可能な機能（削除、Activate、Inactivateボタン）を表示する
        
          - 機能：Activate、Inactivate
            
              - レコードにチェックを入れない場合、「Activate」「Inactivate」または「削除」ボタンを押すと、エラーメッセージを表示する  
                メッセージ：  
                　日本語：「少なくとも一つのレコードを選択してください。」  
                　英語：「Please select at least one record.」
            
              - レコードにチェックを入れて「Activate」ボタンを押すと、確認ダイアログを表示する  
                メッセージ：「Are you sure you want to activate selected users?」
                
                  - ［OK］ボタンを押すと、該当ユーザーを活動化する  
                    メッセージ：  
                    　日本語：「ユーザーを無効化しました」  
                    　英語：「User(s) were successfully inactivated.」
                
                  - ［キャンセル（Cancel）］ボタンを押すと、確認ダイアログを閉じる
            
              - レコードにチェックを入れて「Inactivate」ボタンを押すと、確認ダイアログを表示する  
                メッセージ：「Are you sure you want to inactivate selected users?」
                
                  - ［OK］ボタンを押すと、該当ユーザーを無効化し、メッセージを画面上部に表示する  
                    メッセージ：  
                    　日本語：「ユーザーを無効化しました」  
                    　英語：「User(s) were successfully inactivated.」
                
                  - ［キャンセル（Cancel）］ボタンを押すと、確認ダイアログを閉じる
        
          - 機能：削除
            
              - レコードにチェックを入れない場合、「削除」（Delete）ボタンを押すと、エラーメッセージを表示する  
                メッセージ：  
                　日本語：「少なくとも一つのレコードを選択してください。」  
                　英語：「Please select at least one record.」
            
              - レコードにチェックを入れる場合、「削除」（Delete）ボタンを押すと、確認ダイアログを表示する  
                メッセージ：  
                　日本語：「選択したレコードを削除してもよろしいですか。」  
                　英語：「Are you sure you want to delete selected records?」
                
                  - ［OK］ボタンを押すと、該当ロールを削除し、メッセージを画面上部に表示する  
                    メッセージ：  
                    　日本語：「レコード数＋レコードが正常に削除されました。」  
                    　英語：「Record was successfully deleted.」
                
                  - ［キャンセル（Cancel）］ボタンを押すと、確認ダイアログを閉じる
    
      - 検索テキストボックスでユーザーを検索する
        
          - プレースホルダー：「Search: id, email, active, confirmed\_at, last\_login\_at, current\_login\_at, Last Login IP, Current Login IP, login\_count」
        
          - 任意のテキストを入力し、キーボードでの「Enter」を押すと、ユーザー検索を行う
        
          - テキストボックスの右端での［X］ボタンを押すと、検索条件がクリアーされる
    
      - ユーザー行にて目アイコンを押すと、該当ユーザーの詳細情報を「詳細」（Details）タブに表示する
        
          - 表示項目：Id、Email、Active、Confirmed At、Last Login At、Current Login At、Last Login IP、Current Login IP、Login Count
    
      - ユーザー行にて鉛筆アイコンを押すと、該当ユーザーを「編集」（Edit）タブに表示し、ユーザーの情報が編集できる
        
          - 入力情報は以下の通りである
            
              - 「Email」：必須項目
            
              - 「Password」  
                デフォルト値：その都度ランダムなパスワードが生成される
            
              - 「Active」  
                デフォルト：チェックなし
            
              - 「Roles」  
                デフォルト：空白  
                選択肢：【Administration \> ユーザー管理（User Management） \> ロール（Role）画面】に登録されているロール一覧  
                ※選択肢にあるもの以外は設定できない
            
              - 「Send User Notification」：登録されているアカウント情報をメールに送信する  
                デフォルト：チェックなし
        
          - ［保存（Save）］ボタンを押すと、設定された内容をユーザー一覧に追加して、メッセージをユーザー一覧に表示させる  
            メッセージ：  
            　日本語：「レコードが正常に作成されました。」  
            　英語：「Record was successfully created.」
        
          - ［保存してもう一つ追加（Save and Add Another）］ボタンを押すと、設定された内容をユーザー一覧に追加して、他のユーザーを追加設定可能とする  
            メッセージを画面上部に表示させる  
            メッセージ：  
            　日本語：「レコードが正常に作成されました。」  
            　英語：「Record was successfully created.」
        
          - ［保存して編集を続ける（Save and Continute Editing）］ボタンを押すと、設定された内容をユーザー一覧に追加して、該当ユーザーの編集を続けることを可能とする  
            メッセージを画面上部に表示させる  
            メッセージ：  
            　日本語：「レコードが正常に作成されました。」  
            　英語：「Record was successfully created.」
        
          - ［キャンセル（Cancel）］ボタンを押すと、設定された内容をユーザー一覧に追加せず、「一覧」（List）タブに戻る
        
          - 表示内容は、accounts\_userテーブル、accounts\_userroleテーブルから取得した情報である
        
          - 「Password」については、暗号化された状態で表示される

  - 「一覧」（List）から「作成」（Create）タブを押すと、「作成」（Create）タブに移動し、ユーザーを新規作成できる
    
      - 入力情報とボタン操作は、編集タブと同じである

  - 「編集」（Edit）、「作成」（Create）ともに、［保存（Save）］ボタンや［保存してもう一つ追加（Save and Add Another）］すると、パスワードが入力されていた場合はハッシュ化される
    
      - 「Password」に全角文字を入力していると、以下のエラーメッセージが表示されて保存されない
        
          - エラーメッセージ：  
            日本語：「レコードの更新に失敗しました。'ascii' codec can't decode byte 0xe3 in position 0: ordinal not in range(128)」  
            英語：「 to update record. 'ascii' codec can't decode byte 0xe3 in position 0: ordinal not in range(128)」
    
      - ハッシュ化されたパスワードがさらにハッシュ化されることはない

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - invenio\_accounts（WEKOソース内にforkされていない箇所がある）

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 編集タブで［保存（Save）］ボタンを押すと、以下の内容でフォームデータが送信される
    
      - 「email」：画面上の「Email」で入力されたもの
    
      - 「password」：画面上の「Password」で入力されたもの
    
      - 「active」：画面上の「Active」がチェックされていた場合のみ、「y」が設定される  
        チェックされていなかった場合はフォームデータに含まれない
    
      - 「roles」：画面上の「Roles」でロールが選択されていた場合のみ、  
        チェックされていなかった場合はフォームデータに含まれない
    
      - 「notification」：画面上の「Send User Notification」がチェックされていた場合のみ、「y」が設定される  
        チェックされていなかった場合はフォームデータに含まれない

  - パスワードはflask\_security.utils. hash\_passwordメソッドでハッシュ化している
    
      - 全角文字を設定していると、この中のasciiでデコードする段階で失敗する

  - 送信されたフォームデータによって、accounts\_userテーブルとaccounts\_userroleテーブルの内容が更新される

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### ユーザープロファイル

  - > 目的・用途

本機能は、ユーザーのユーザー名、タイムゾーン、言語を個別に設定する際に用いる機能である。

  - > 利用方法

【Administration \> ユーザー管理（User Management） \> ユーザープロファイル（User Profile）画面】にて操作を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【ユーザープロファイル（User Profile）画面】には以下のタブが表示される
    
      - 一覧（List）
    
      - フィルターを追加▼（Add Filter▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 選択▼（With selected▼）
        
          - 一覧（List）タブ選択中のみ表示
        
          - 外観はタブだが機能としてはプルダウンメニュー
    
      - 編集（Edit）
        
          - 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示
    
      - 詳細（Details）
        
          - 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示

  - 「一覧」（List）タブに登録されているユーザーを表示する
    
      - 表示項目は以下の通りである
        
          - チェックボックス
        
          - アクション（閲覧・編集・削除を表すアイコン）
        
          - 「User Id」
        
          - 「ユーザー名（Username）」
        
          - 「タイムゾーン（Timezone）」
        
          - 「言語（Language）」
    
      - 表示内容は、userprofiles\_userprofileテーブルから取得した情報である
    
      - 「フィルターを追加▼」（Add Filter▼）ボタンをクリックすると、以下の追加可能なフィルターリストを表示し、フィルター名をクリックすると当該フィルターの入力エリアを追加する
        
          - フィルター名
            
              - 「User Id」
                
                  - フィルター方式の選択肢：フィルター方式の選択肢：等しい（equals）、等しくない（not equal）、より大きい（greater than）、より小さい（smaller than）、空（empty）、一覧にある（in list）、一覧にない（not in list）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「ユーザー名（Username）」
                
                  - フィルター方式の選択肢：含む（contains）、含まれていません（not contains）、等しい（equals）、等しくない（not equal）、空（empty）、一覧にある（in list）、一覧にない（not in list）
                
                  - 入力された文字列を使い、選択したフィルター方式で絞り込む
            
              - 「タイムゾーン（Timezone）」
                
                  - フィルター方式の選択肢：上記の「ユーザー名」と同じである
                
                  - プルダウンメニューからタイムゾーンを選択して、選択したフィルター方式で絞り込む
            
              - 「言語（Language）」
                
                  - フィルター方式の選択肢：上記の「ユーザー名」と同じである
                
                  - プルダウンメニューから言語を選択して、選択したフィルター方式で絞り込む
                
                  - 選択肢は、「自動（Automatic）」「日本語（Japanese）」「英語（English）」
        
          - 設定したフィルターは［適用（Apply）］ボタンを押下することで一覧に適用される
        
          - ［フィルターをリセット（Reset filter）］ボタンを押下すると、設定したフィルターがリセットされる
    
      - 「選択▼」（With selected▼）ボタンをクリックすると、以下の追加可能な機能（現在削除ボタンのみ）を表示する
        
          - レコードにチェックを入れない場合、「削除」（Delete）ボタンを押すと、エラーメッセージを表示する  
            メッセージ：  
            　日本語：「少なくとも一つのレコードを選択してください。」  
            　英語：「Please select at least one record.」
        
          - レコードにチェックを入れる場合、「削除」（Delete）ボタンを押すと、確認ダイアログを表示する  
            メッセージ：  
            　日本語：「選択したレコードを削除してもよろしいですか。」  
            　英語：「Are you sure you want to delete selected records?」
            
              - ［OK］ボタンを押すと、該当ロールを削除し、メッセージを画面上部に表示する  
                メッセージ：  
                　日本語：「レコード数＋レコードが正常に削除されました。」  
                　英語：「Record was successfully deleted.」
            
              - ［キャンセル（Cancel）］ボタンを押すと、確認ダイアログを閉じる
    
      - 検索テキストボックスでユーザーを検索する
        
          - プレースホルダー：「Search」
        
          - 任意のテキストを入力し、キーボードでの「Enter」を押すと、ユーザープロファイル検索を行う
        
          - テキストボックスの右端での［X］ボタンを押すと、検索条件がクリアーされる
    
      - ユーザープロファイル行にて目アイコンを押すと、該当ユーザーの詳細情報を「詳細」（Details）タブに表示する
        
          - 表示項目：User Id、Username、Fullname、Timezone、Language
            
              - それぞれ、userprofiles\_userprofileテーブルのuser\_id、username、fullname、timezone、languageフィールドに対応している
        
          - UsernameとFullnameは、設定できる画面がWEKOにないため、userprofiles\_userprofileテーブルを直接編集しない限り空欄となる
            
              - WEKO内では使用する箇所もない
        
          - 一覧タブや編集タブ、各ユーザーが個別に表示するユーザープロフィール画面で表示や編集を行う「ユーザー名（username）」は、userprofiles\_userprofileテーブルではdisplaynameである
    
      - ユーザー行にて鉛筆アイコンを押すと、該当ユーザーを「編集」（Edit）タブに表示し、ユーザーの情報が編集できる
        
          - 編集項目： Username、Timezone、Language
            
              - それぞれ、userprofiles\_userprofileテーブルのdisplayname、timezone、languageフィールドに対応している

  - 関連コンフィグ
    
      - WEKO\_USERPROFILES\_ROLES:
        
          - JGSS専用のコンフィグです。  
            JGSSの4つロール（管理者、一般、院生、学部生）を指定するものです。
    
      - WEKO\_USERPROFILES\_POSITION\_LIST\_GRADUATED\_STUDENT:
        
          - JGSS専用のコンフィグです。  
            JGSSでは、ユーザーの役割を選択した場合、その役割に該当するロールを自動設定するものです。  
            例：役割一覧は以下のコンフィグに定義されています。  
            <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-user-profiles/weko_user_profiles/config.py#L113-L121>  
            この役割一覧の１つを選択した場合、該当するロールに「学院性」ロールが自動設定されます。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - weko\_user\_profiles

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 一覧タブ表示時は、weko\_user\_profiles.admin.UserProfileView.index\_viewメソッドで情報を取得している

  - 一覧タブの表示内容は、以下のコンフィグで決定している
    
      - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-user-profiles/weko_user_profiles/config.py#L168-L169>
    
      - 設定キー：WEKO\_USERPROFILES\_FORM\_COLUMN
    
      - 以下の表示候補の中から、このコンフィグにあるものを表示している
        
          - User Id
        
          - ユーザー名（Username）
        
          - 氏名（Fullname）
        
          - タイムゾーン（Timezone）
        
          - 言語（Language）
        
          - 大学・機関（University/Institution）
        
          - 所属部局・部署（Affiliated Division/Department）
        
          - 役職（Position）
        
          - 役職（その他）（Position (Others)）
        
          - 電話番号（Phone number）
        
          - 所属学会名（Affiliated Academic Society）
        
          - 所属学会役職（Affiliated Academic Society Position）
            
              - 所属学会名と所属学会役職は最大５つまで設定可能

  - 編集タブ表示時は、UserProfileView\_edit\_viewメソッドで情報の取得、更新を行う
    
      - 「Timezone」の選択肢は、以下のコンフィグで設定している
        
          - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-user-profiles/weko_user_profiles/config.py#L46-L83>
        
          - キー：USERPROFILES\_TIMEZONE\_LIST
    
      - ［保存（Save）］ボタンを押すと、以下の内容でフォームデータが送信される
        
          - 「displayname」：画面上の「ユーザー名（Username）」で入力されたもの
        
          - 「timezone」：画面上の「Timezone」で選択されたもの
        
          - 「language」：画面上の「Language」で選択されたもの
    
      - 送信されたフォームデータによって、userprofiles\_userprofileテーブルの内容が更新される

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### アイテム表示

<!-- end list -->

  - > 目的・用途

本機能は、アイテム表示・検索に関する設定機能である

  - > 利用方法

【Administration \> Setting (設定) \> Item (アイテム表示)】からアイテム表示における条件の設定を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

使用している画面

  - > 【Administration \> Setting (設定) \> Items（アイテム表示）画面】アイテム表示・検索に関する機能を設定する画面である

E-mailの表示/非表示を設定する

  - > 【Administration \> Setting (設定) \> Items (アイテム表示) 画面】の「Display Email」エリアにてE-Mailの表示（Display Email ）/非表示（Hide Email）を設定することができる。本設定によりアイテム詳細画面、ADMIN14-4 PDFカバーページ および <https://redmine.devops.rcos.nii.ac.jp/projects/weko-dev-doc/wiki/JSON>USER3-7 Export(JSON) 機能 におけるE-Mail出力を制御する。
    
      - Display Email が設定されている場合、アイテム詳細画面、PDFカバーページおよびJSON Export機能にてメールアドレスを表示する。
    
      - Hide Email が設定されている場合、アイテム詳細画面、PDFカバーページおよびJSON Export機能にてメールアドレスを表示しない。
    
      - 「保存」（Save）ボタンを押すと、設定内容を保存する

<!-- end list -->

  - 【Administration \> Setting (設定)\> Items(アイテム表示) 画面】でのOpen Dateエリアにファイルの公開日の表示/非表示を設定する
    
      - 「表示」（Display）を設定する場合、すべてのユーザにはアイテムリスト、アイテム詳細画面に公開日を表示とする
    
      - 「非表示」（Hide Open Date）を設定する場合、ゲストユーザにはアイテムリスト、アイテム詳細画面に公開日を非表示とする
    
      - デフォルト：「表示」（Display）
    
      - 「保存」（Save）ボタンを押すと、設定内容を保存する

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko-records-ui

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - > 【Save (保存)】を押下した際に、weko\_records\_ui.admin.ItemSettingView.indexを呼び出して使用する。
    
      - > weko\_admin.models.AdminSettingを呼び出し、admin\_settingsテーブルを更新する。

  - > weko-records-ui.utils.is\_show\_email\_of\_creator
    
      - <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/utils.py#L578-L624>
    
      - 当該アイテムタイプについて、E-Mail表示する場合はTrueを返す。

<!-- end list -->

  - ファイルの公開日の表示/非表示を設定する
    
      - デフォルト状態の設定：
        
          - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/config.py#L68>
        
          - 設定キー： OPEN\_DATE\_DISPLAY\_FLG
        
          - 現在の設定値：

> OPEN\_DATE\_DISPLAY\_FLG = True

  - > 表示/非表示状態の値を設定する
    
      - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/config.py#L69-L70>
    
      - 設定キー：OPEN\_DATE\_DISPLAY\_VALUE、OPEN\_DATE\_HIDE\_VALUE
    
      - 現在の設定値：

> OPEN\_DATE\_DISPLAY\_VALUE = '1'
> 
> OPEN\_DATE\_HIDE\_VALUE = '0'

  - > E-mailの表示/非表示を設定する
    
      - デフォルト状態の設定：
        
          - パス：   
            <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/config.py#L65>
        
          - 設定キー： EMAIL\_DISPLAY\_FLG
        
          - 現在の設定値：

<!-- end list -->

  - > EMAIL\_DISPLAY\_FLG = True更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### インデックスリンク表示

  - > 目的・用途

この機能はweko上でインデックスリンクを表示するか否かを設定するためのものである。

  - > 利用方法

【Administration \> 設定【Setting】 \> インデックスリンク表示(Index Link)画面】を開き、設定した後、「更新」ボタンを押下する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>〇</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

1\. インデックスリンクエリアの表示/非表示を設定する

  - > 【Administration \> 設定(Setting) \> インデックスリンク表示(Index Link)画面】にインデックスリンクエリアの表示/非表示を設定する
    
      - 「Enable」を選択する場合、インデックスリンクエリアを表示する。
    
      - 「Disable」を選択する場合、 インデックスリンクエリアを表示しない。
    
      - デフォルト：「Disable」

2\. インデックスごとにインデックスリンクの表示/非表示を設定する

  - > 【Administration \> インデックスツリー管理(index tree) \> ツリー編集(Edit Tree)画面】にインデックスごとにインデックスリンクの表示/非表示を設定できる。  
    > また、インデックスごとにインデックスリンクの”表示名”を設定できる。

  - > 設定方法の詳細は[ADMIN-3-1 ツリー編集](\\l)を参照すること。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_index\_tree

<!-- end list -->

  - > 処理概要

> インデックスリンク表示設定画面の表示

  - > 【administration \> 設定 \> インデックスリンク表示】画面を開く。この操作によって、weko\_index\_tree.admin.IndexLinkSettingView.indexメソッドがGETで呼び出され、現在のインデックスリンク表示設定をindex\_styleテーブルの列「index\_link\_enabled」から取得し、画面に表示する。  
    > デフォルトでは無効に設定されている。

> インデックスリンク表示設定について

  - > 「更新」ボタンを押下すると、weko\_index\_tree.admin.IndexLinkSettingView.indexメソッドがPOSTで呼び出され、ウェブ上で選択した「有効」または「無効」に応じて、  
    > index\_styleテーブルの列「index\_link\_enabled」を設定する。成功したらweb上側に「IndexLink flag was updated」と表示する。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### 言語表示

  - > 目的・用途

本機能は、リポジトリ管理者として、ユーザーが選択可能な表示言語を設定できる機能である

  - > 利用方法

【Administration \> 設定（Setting） \> 言語設定（Language）画面】にて操作を行う

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

使用している画面

  - 【Administration \> 設定（Setting） \> 言語設定（Language）画面】にて表示言語を設定する
    
      - 「対象言語」(Target language）に設定可能な表示言語をリスト表示する  
        デフォルトリストは以下とする（ ただし、言語実装は日本語、英語のみとする ）
        
          - 日本語\[Japanese ja\]
        
          - 英語(米)\[English en\]
        
          - 中国簡体\[Chinese zh\]
        
          - インドネシア語\[Indonesian id\]
        
          - ベトナム語\[Vietnamese vi\]
        
          - マレー語\[Malay ms\]
        
          - タガログ語\[Filipino (Pilipinas) fil\]
        
          - タイ語\[Thai th\]
        
          - ヒンディー語\[Hindi hi\]
    
      - 言語リストから表示言語とする言語を選択して、\[\>\]ボタンを押すと、「登録言語」（Registered language）に選択言語の表示が移る  
        選択肢は同時に複数選択可能とする
    
      - 選択言語リストから任意言語を選択して、\[\<\]ボタンを押すと、「登録言語」（Registered language）から「対象言語」(Target language）に表示が移る
    
      - 登録言語リストから任意言語を選択しない場合、\[↟\]、\[ʌ\]、\[ⅴ\]、\[↡\]ボタンを無効とする
    
      - 登録言語リストから任意言語を選択している場合
        
          - \[↟\]ボタンを押すと、登録言語リストの上頭に表示が移る
        
          - \[ʌ\]ボタンを押すと、登録言語リストの１つ上言語に表示が移る
        
          - \[ⅴ\]ボタンを押すと、登録言語リストの１つ下言語に表示が移る
        
          - \[↡\]ボタンを押すと、登録言語リストの下頭に表示が移る
    
      - 登録言語リストが空である間は、［保存（Save）］ボタンは非活性になる
    
      - ［保存（Save）］ボタンを押すと、「登録言語」（Registered language）の対象が表示言語として設定され、メッセージを画面上部に表示される
        
          - メッセージ：「Update languages action successfully」
        
          - 変更された内容をデータベースに保存する
            
              - テーブル名：admin\_lang\_settings
            
              - カラム名：  
                ・lang\_code  
                ・lang\_name  
                ・is\_registered  
                ・sequence  
                ・is\_active

  - 【言語設定（Language）画面】で設定した表示言語は、ユーザ側の表示言語選択プルダウンから使用可能となる
    
      - 【言語設定（Language）画面】で設定した順番でプルダウン表示する
    
      - 【言語設定（Language）画面】で設定した順番の一番上の言語をデフォルト表示とする

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - weko\_admin

<!-- end list -->

  - > 処理概要

1\. 設定

  - 言語一覧のデフォルトを設定する
    
      - パス： <https://github.com/RCOSDP/weko/blob/v0.9.22/scripts/populate-instance.sh#L343-L368>  
        ※「登録言語」に対して、以下の設定を追加する  
        ・「--registered」をステータス後に追加する  
        ・表示位置を最後の属性で設定する
    
      - 現在の設定：

> ${INVENIO\_WEB\_INSTANCE} language create \\
> 
> \--active --registered "en" "English" 001
> 
> ${INVENIO\_WEB\_INSTANCE} language create \\
> 
> \--active "zh" "中文" 000
> 
> ${INVENIO\_WEB\_INSTANCE} language create \\
> 
> \--active "id" "Indonesia" 000
> 
> ${INVENIO\_WEB\_INSTANCE} language create \\
> 
> \--active "vi" "Tiếng Việt" 000
> 
> ${INVENIO\_WEB\_INSTANCE} language create \\
> 
> \--active "ms" "Bahasa Melayu" 000
> 
> ${INVENIO\_WEB\_INSTANCE} language create \\
> 
> \--active "fil" "Filipino (Pilipinas)" 000
> 
> ${INVENIO\_WEB\_INSTANCE} language create \\
> 
> \--active "th" "ไทย" 000
> 
> ${INVENIO\_WEB\_INSTANCE} language create \\
> 
> \--active "hi" "हिन्दी" 000
> 
> ${INVENIO\_WEB\_INSTANCE} language create \\
> 
> \--active --registered "ja" "日本語" 002
> 
> 対象言語一覧に言語を追加する場合、以下のコマンドを実施する
> 
> docker-compose exec web invenio language create --active "言語コード" "言語名" 000

2\. 画面操作にともなう処理

  - 画面表示時に、weko\_admin.views. get\_lang\_list関数が呼び出される
    
      - レスポンスとして、admin\_lang\_settingsテーブルから「is\_active」フィールドがtrueであるレコードを「sequence」昇順で受け取る
    
      - 各レコードの言語は、「is\_registered」フィールドがtrueなら登録言語リストに、falseなら対象言語リストに配置する

  - ［保存（Save）］ボタンを押すと、.views.save\_lang\_list関数が呼び出される
    
      - リクエストのペイロードとして、要素が以下の内容であるJSON配列を送り、配列要素ごとにadmin\_lang\_settingsテーブルの「lang\_code」フィールドが配列要素の「lang\_code」に一致するレコードをその配列要素の内容で更新する。
        
          - is\_registered：登録言語にある場合はtrue、そうでなければfalse
        
          - lang\_code：言語コード
        
          - lang\_name：言語名
        
          - sequence：表示順（対象言語リストにある場合は0固定）

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### PDFカバーページ表示

  - > 目的・用途

本機能は、PDFカバーページについて設定する際に使用する機能である。

  - > 利用方法

【Administration \> 設定（Setting） \> PDFカバーページ表示（PDF Cover Page）画面】にて操作を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - インデックス全体のPDFカバーページについて設定する
    
      - 「PDF Cover Page」エリアにてPDFカバーページの有効/無効を設定する
        
          - 「ON/OFF」：利用可否設定
            
              - 「Enable」を選択する場合、PDFカバーページ機能を有効とする
            
              - 「Disable」を選択する場合、PDFカバーページ機能を無効とする（デフォルト）
    
      - 「Header Settings」エリアにてヘッダのカバーページを設定する
        
          - 「Header Display Setting」：ヘッダ表示設定
            
              - 「String」：文字列表示（デフォルト）
            
              - 「Image」：画像表示
        
          - 「Header Output String Setting」：ヘッダ出力文字列設定  
            ※文字列表示の場合に使用する。操作自体はヘッダ表示設定にかかわらず可能
            
              - 半角100文字/全角50文字以内の文字列を入力する
        
          - 「Header Output Image Setting」：ヘッダ出力画像設定  
            ※画像表示の場合に使用する。操作自体はヘッダ表示設定にかかわらず可能
            
              - jpg,png,gifが設定可能
                
                  - すべての種類のファイルが設定できるが、上記以外のファイルを選択するとPDFファイルのダウンロード時にサーバ内部エラーが発生する
            
              - ［ファイルを選択（Choose File）］ボタンを押してファイルを選択する
                
                  - 設定済みかどうかにかかわらず、画面表示後に選択されていない場合はボタンの右側に以下のメッセージが表示される  
                    メッセージ：  
                    日本語：「選択されていません」  
                    英語：「No file chosen」
            
              - ファイルが設定されていない状態では、［ファイルを選択（Choose File）］ボタン上部にメッセージが表示される  
                メッセージ：「No header image set」
            
              - 画像ファイルが設定済みの状態では、［ファイルを選択（Choose File）］ボタン上部にその画像が表示される
            
              - 画像ファイルが選択された状態では、［ファイルを選択（Choose File）］ボタン下部にその画像が表示される
        
          - 「Header Display Position Setting」：ヘッダ表示位置設定
            
              - 「Left justified」：右寄り
            
              - 「Center justified」：中央寄せ（デフォルト）
            
              - 「Right justified」：左寄せ

  - ［保存（Save）］ボタンを押すと、各エリアの設定値が保存される
    
      - 「Header Output Image Setting」でファイルを選択していた場合、ヘッダ出力画像は選択したものに置き換えられる

  - インデックスごとにカバーページの有効/無効を設定する
    
      - 詳細は[ADMIN-3-1: ツリー編集](#ツリー編集)参照

  - ここで設定したPDFカバーページ設定は、PDFファイルのダウンロード時に参照する
    
      - 画像表示の場合、カバーページでは高さが30mmかつ縦横比は元画像と同じになるように拡大、縮小して表示される
    
      - 目的のPDFファイルがパスワードによって暗号化されていた場合は、カバーページをつけずにダウンロードする
    
      - カバーページをつけたPDFファイルは、ファイル名を「CV\_yyyymmdd\_もともとのファイル名.pdf」となる

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - weko\_records\_ui

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 画面表示時に、pdfcoverpage\_setテーブルから「id」フィールドが「1」であるレコードを取得する
    
      - 取得できなかった場合は、以下の処理を行う
        
          - 各フィールドを以下のように設定してレコードを作成する
            
              - 「id」：自動採番
            
              - 「avail」：disable
            
              - 「header\_display\_type」：なし（テーブルのデフォルト値のstringが入る）
            
              - 「header\_output\_string」：なし
            
              - 「header\_output\_image」：なし
            
              - 「header\_display\_position」：なし（テーブルのデフォルト値のcenterが入る）
        
          - 作成後に再度「id」フィールドが「1」であるレコードを取得する
            
              - そこで取得できなかった場合は、サーバ内部エラーが発生する
    
      - 取得した情報を表示情報とする
        
          - 「header\_output\_image」フィールドの情報は、テンプレートのimg要素のソースとなる

  - ［保存（Save）］ボタンを押すと、pdfcoverpage\_setテーブルの「id」が「1」であるレコードを以下のように更新する
    
      - 「avail」：「ON/OFF」で選択したもの
    
      - 「header\_display\_type」：「Header Display Setting」で選択したもの
    
      - 「header\_output\_string」：「Header Output String Setting」の入力値
    
      - 「header\_output\_image」：以下の２通り
        
          - ファイルが選択されていなかった場合、そのまま
        
          - ファイルが選択されていた場合、システムにそのファイルを保存して、ファイルのパスを設定する
    
      - 「header\_display\_position」：「Header Display Position Setting」で選択したもの

  - 「Header Output Image Setting」でファイルを選択したとき、そのファイルをFileReader.readAsDataURLメソッドによってBase64でエンコードする
    
      - このメソッドは、テンプレートに記述されている
    
      - エンコードした文字列を、ボタン下部のimage要素のsrc属性に設定する
    
      - 大きなファイルをエンコードする場合は、エンコード後の文字列がjavascriptの変数に入りきらずにエラーとなることがある

  - ここで設定したPDFカバーページ設定は、PDFファイルのダウンロード時に参照する
    
      - weko\_records\_ui.fd.\_download\_file関数で条件を確認して、以下のいずれかの場合には、カバーページをつけずにダウンロードする
        
          - ファイルのmimetypeがPDFでない
        
          - pdfcoverpage\_setテーブルに「id」が「1」であるレコードが存在しない
        
          - レコードで「avail」がdisableである
        
          - 対象アイテムが属するインデックスで、PDFカバーページ設定が無効である
        
          - オリジナルのPDFファイルをダウンロードできる権限がある状態で、そうする操作である
    
      - そうでない場合は、 weko\_records\_ui.pdf.make\_combined\_pdf関数を呼び出してカバーページ付きのPDFファイルを作成して、そのファイルをダウンロードする
        
          - カバーページ付きのPDFファイルは、以下の場所に作成される
            
              - tempfile.gettempdir関数の返り値+「/comb\_pdfs/」

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### ランキング表示

  - > 目的・用途

本機能は、アイテムの閲覧回数やファイルのダウンロード回数やアイテムの作成ユーザーなどのランキングを閲覧を設定する機能である。

  - > 利用方法

【Administration \> Setting (設定) \> Ranking (ランキング表示)からランキングの機能を設定する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - リポジトリ管理者として、【Administration \> Setting (設定) \> Ranking(ランキング表示) 画面】にランキングの機能に対して設定を実行する
    
      - 設定項目は以下の通りである

<table>
<thead>
<tr class="header">
<th>#</th>
<th>設定項目</th>
<th>設定方法</th>
<th>デフォルト</th>
<th>概要</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>1</td>
<td>「ランキングの表示/非表示」（Show/Hide Ranking）</td>
<td>・「オン」（On）</td>
<td>「オフ」（Off）</td>
<td>Web画面でランキングタブの表示可否を設定する</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>・「オフ」（Off）</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td>2</td>
<td>「新着アイテムとして判断する期間」（Period To Judge As New Item）</td>
<td>N日（Day）</td>
<td>14日</td>
<td>新規に登録されたアイテムとして判断する期間。アイテム登録日からの経過日数を指定する。ただし、設定できる範囲は1日～30日とする</td>
</tr>
<tr class="even">
<td>3</td>
<td>「統計期間」（Statistical Period）</td>
<td>N日（Day）</td>
<td>365日</td>
<td>ランキングとして表示する期間。本日から何日前までを集計期間とするかを指定する。ただし、設定できる範囲は1~3650日とする</td>
</tr>
<tr class="odd">
<td>4</td>
<td>「表示する順位」（Display Rank）</td>
<td>N位</td>
<td>10位</td>
<td>ランキングとして表示する順位を指定する.最大値を100位までとする</td>
</tr>
<tr class="even">
<td>5</td>
<td>「ランキング」（Rankings）</td>
<td>・「最も閲覧されたアイテム」（The Most Viewed Items）</td>
<td>チェックボックスの<br />
チェックなし</td>
<td>Web画面で表示するランキングの種類を設定する。チェックボックス方式で、複数選択可能とする。<br />
チェックの付いた項目をWeb画面のランキングタブに表示する。</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>・「最もダウンロードされたアイテム」（Most Downloaded Items）</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>・「最もアイテムを作成したユーザー」（User Who Created The Most Items）</td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>・「最も検索されたキーワード」（Most Searched Keywords）</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>・「新着アイテム」（New Items）</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - 「保存」（Save）ボタンを押すと、画面上の設定情報を保存し、メッセージを画面上部に表示する  
    メッセージ：  
    日本語：「設定を変更しました」  
    英語：「Successfully Changed Settings.」

  - 以下のエラー条件に１つでも当てはまる場合、「保存」（Save）ボタンを押すと、エラーメッセージを画面上部に表示する  
    エラー条件：  
    ・「新着アイテムとして判断する期間」で1～30以外の自然数を設定した場合  
    ・「統計期間」で1\~3650以外の自然数を設定した場合  
    ・「表示する順位」で1\~100以外の自然数を設定した場合  
    エラーメッセージ：  
    日本語：「設定変更に失敗しました」  
    英語：「Failurely Changed Settings.」

  - 「新着アイテムとして判断する期間」「統計期間」「表示する順位」で文字列や小数、負の値、０など、上記のエラー条件以外の値を入れた場合、「指定されている形式で入力してください」というポップアップを表示する

  - 「削除」（Delete）ボタンを押すと、入力中の値が破棄され、入力前の保存された設定情報を表示する

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_items\_ui

  - > invenio\_stats

  - > weko\_admin

<!-- end list -->

  - > 処理概要

> 【Administration \>Setting (設定) \>Ranking (ランキング表示)】 からランキングの条件を入力し、【保存(Save)】を押下すると、weko\_admin.models.RankingSettings.updateが呼び出される。ranking\_settingテーブルを入力された情報をもとに更新する。
> 
> \[Administration \>Setting (設定) \>Ranking (ランキング表示)\] からランキングの条件を入力したあと【削除(Delete)】を押下すると、weko\_admin.models.RankingSettings.deleteが呼び出され、ranking\_settingテーブルから入力中の値を削除し、入力前の保存された設定情報を取得する。

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### 統計情報表示

  - > 目的・用途

本機能は、アイテムの利用統計情報を閲覧を設定する機能である

  - > 利用方法

【Administration \> Setting (設定) \> Stats (統計情報表示) 画面】から、アイテムの統計情報の表示/非表示を設定する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

使用している画面

  - 【Administration \> Setting (設定) \> Stats (統計情報表示) 画面】：アイテムの利用統計情報の表示/非表示を設定する画面である

  - 【アイテム詳細画面】：利用統計情報を表示する画面である

  - 【ファイル詳細画面 (information)】：コンテンツファイル単位の統計情報を表示する画面である

1\. アイテムの利用統計情報を表示する

  - アイテムの利用統計情報の表示/非表示を設定する
    
      - 【Administration \> Setting (設定) \> Stats (統計情報表示) 画面】での「統計設定」における「レコード統計の表示/非表示」（Show/Hide Record Stats）エリアにアイテムの利用統計情報の表示/非表示を設定する
        
          - 「オン」（On）にすると、アイテム詳細表示画面に利用統計エリア\[Stats\]を表示する
        
          - 「オフ」（Off）にすると、アイテム詳細表示画面に利用統計エリア\[Stats\]を非表示とする
        
          - デフォルト：「オン」（On）
        
          - 「保存」（Save）ボタンを押すと、設定内容を保存し、メッセージを画面上部に表示する  
            メッセージ：  
            　日本語：「設定を変更しました」  
            　英語：「Successfully Changed Settings.」

  - アイテムの利用統計情報を表示する
    
      - アイテム単位の閲覧回数は、【アイテム詳細画面】での「Views」エリアに表示する
    
      - 閲覧回数は、 invenio-statsにてログ集計した値とする
    
      - 閲覧回数は、全ドメインと各ドメイン毎（トップレベルドメイン毎）で集計値を表示する
        
          - 各ドメイン毎（トップレベルドメイン毎）はデフォルト表示は"非表示"とし、「詳細を確認」（See details）リンクを押すことで表示する
            
              - 確定できないドメインに対して、「UNKNOWN」として表示する
    
      - 閲覧回数は、集計機関プルダウン「Period」より年月を選択することで指定期間の数値を表示する
        
          - デフォルトは全期間の数値（total）とする

2\. コンテンツファイル単位の統計情報を表示する

  - 【ファイル詳細画面 (Information)】での「統計」（Stats）タブにコンテンツファイル単位の統計情報を表示する
    
      - 表示項目は以下の通りである
        
          - ダウンロード回数は、「ダウンロード数」（Downloads）エリアに表示する
        
          - 再生回数は、「再生回数」（Plays）エリアに表示する
    
      - ダウンロード回数と再生回数は、invenio-statsにてログ集計した値とする
        
          - 統計情報は、全ドメインと各ドメイン毎（トップレベルドメイン毎）で集計値を表示する
        
          - 各ドメイン毎（トップレベルドメイン毎）はデフォルト表示は"非表示"とし、「詳細を確認」（See details）リンクを押すことで表示する
            
              - 確定できないドメインに対して、「UNKNOWN」として表示する
        
          - 統計情報は、集計機関プルダウン「Period」より年月を選択することで指定期間の数値を表示する
            
              - デフォルトは全期間の数値 (total) とする

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_admin

  - > weko\_records\_ui

  - > invenio\_stats

<!-- end list -->

  - > 処理概要

> 【Administration \> Setting (設定) \> Stats (統計情報表示)】において、統計情報の表示/非表示を選択して【Save (保存)】を押下すると、weko\_admin.StatsSettingsView.indexを呼び出して使用する。

  - > weko\_admin.models.AdminSettings.updateを呼び出して、admin\_settingsテーブルから、「display\_stats\_settings」カラムを更新する。

> weko\_admin.models.AdminSettings.getで「display\_stats\_settings」を取得して、  
> 「WEKO\_ADMIN\_STATS\_SETTINGS\_TEMPLATE」に沿って、  
> flask\_admin.base.BaseView.renderで更新した状態の統計情報表示設定画面を表示する。「WEKO\_ADMIN\_STATS\_SETTINGS\_TEMPLATE」：weko\_admin.config

  - > 'weko\_admin/admin/stats\_settings.html'

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### 画面背景色

  - > 目的・用途

本機能は、画面背景色表示を設定する機能である

  - > 利用方法

【Administration \> 設定(Setting) \> 画面背景色(Style)画面】を開き、色を選択後「保存」ボタンを押下する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>〇</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

画面背景色表示を設定する

  - > 【Administration \> 設定(Setting) \> 画面背景色(Style)画面】に画面背景色表示を設定する。
    
      - 現在選択している色を表示する。
    
      - 背景１の下にある四角をクリックすると、背景色を設定できる。
    
      - 画面背景色表示の設定は、背景色をカラーピッカーから選択できる。
        
          - また、背景色をカラーモデルで指定できる。  
            対応しているカラーモデル：RGB、HSL、HEX
    
      - 「保存」（Save）ボタンを押すと、設定内容を保存し、メッセージを画面上部に表示する。  
        メッセージ：「Successfully update color.」

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - 
  - > weko\_theme

<!-- end list -->

  - > 処理概要

> 画面背景色表示について

  - > 【Administration \> 設定 \> 画面背景色】画面を開く。この操作によって、weko\_admin.templates.weko\_admin.admin.block\_styleにてweko\_admin.admin.StyleSettingView.indexがGETで呼び出され、変数WEKO\_THEME\_INSTANCE\_DATA\_DIRに保存されているディレクトリの\_variables.scssより現在の色設定を取得し、画面に表示する。

> 画面背景色設定

  - > 背景１下の四角を押下した時、weko\_admin.templates.weko\_admin.admin.block\_style.htmlよりカラーピッカーが表示される。このとき表示される色は現在設定されている色で表示される。

  - > 色を選択し、「保存」ボタンを押下する。この操作によって、weko\_admin.admin.StyleSettingView.indexがPUTで呼び出され、背景１で選択されている色の数値を変数WEKO\_THEME\_INSTANCE\_DATA\_DIRに保存されているディレクトリの\_variables.scssに保存する。

  - > なお、変数WEKO\_THEME\_INSTANCE\_DATA\_DIRはweko\_theme.config.pyに保存されている変数である。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### 識別子

  - > 目的・用途

本機能は、ワークフロー中でアイテムに付与するための識別子を作成、編集する際に使用する機能である。

  - > 利用方法

【Administration \> 設定（Setting） \> 識別子（Identifier）画面】にて操作を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【識別子（Identifier）画面】には以下のタブが表示される
    
      - 一覧（List）
    
      - 作成（Create）
    
      - 編集（Edit）
        
          - 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示
    
      - 詳細（Details）
        
          - 一覧（List）タブ選択中は非表示
        
          - 一覧（List）タブの操作によって表示される
        
          - 編集（Edit）タブまたは詳細（Details）タブ選択中に表示

  - 「一覧」（List）タブにて識別子情報を表示する
    
      - 表示項目は以下の通りである
        
          - アクション（閲覧・編集を表すアイコン）
        
          - 「Repository」
        
          - 「JaLC DOI」
        
          - 「JaLC CrossRef DOI」
        
          - 「JaLC DataCite DOI」
        
          - 「NDL JaLC DOI」
        
          - 「Semi-automatic Suffix」
        
          - 「Jalc Flag」
        
          - 「Jalc Crossref Flag」
        
          - 「Jalc Datacite Flag」
        
          - 「Ndl Jalc Flag」
    
      - 識別子行にて目アイコンを押すと、該当識別子の詳細情報を「詳細」（Details）タブに表示する
        
          - 表示項目：Repository、JaLC DOI、JaLC CrossRef DOI、JaLC DataCite DOI、NDL JaLC DOI、Semi-automatic Suffix、Created Userid、Created Date、Updated Userid、Updated Date
        
          - 「移動」（Filter）テキストボックスにテキストを入力すると、入力値が項目名またはその値に含まれている項目に絞り込んで表示する
    
      - 識別子行にて鉛筆アイコンを押すと、該当識別子を「編集」（Edit）タブに表示し、編集できる

  - 「作成」（Create）タブにて新規作成、または「編集」（Edit）タブにて既存の情報を編集する
    
      - 「Prefix」領域の入力値により、テナント別に各DOI発行機関のプレフィックス情報を設定
        
          - プレフィックス設定項目は以下の通り
            
              - Reposiitory(必須)：プルダウン
                
                  - 「Root Index」または「communities\_community」テーブルの各レコードのidを選択肢とする
            
              - JaLC DOI：自由入力。100字まで入力可能
            
              - JaLC CrossRef DOI：自由入力。100字まで入力可能
            
              - JaLC DataCite DOI：自由入力。100字まで入力可能
            
              - NDL JaLC DOI：自由入力。100字まで入力可能
    
      - 「Suffix」領域の設定値の入力値により、テナント別にサフィックスの前半部分を設定
        
          - サフィックス設定項目は以下の通り
            
              - Semi-automatic suffix：自由入力
    
      - 「Enable/Disable」領域の設定により、テナント別に各DOI発行機関の利用可否を設定
        
          - Disableに設定されているDOIは、入力欄が非活性化する
    
      - ［保存（Save）］ボタンを押すと、入力値のエラーチェックを行う
        
          - 「Repository」の選択値について、作成時に登録済みのリポジトリを選択したか、編集時に登録済みの他のリポジトリに変更した場合、画面上部に以下のエラーメッセージが表示される
            
              - エラーメッセージ：  
                日本語：「指定したリポジトリが既に登録されています。」  
                英語：「Specified repository is already registered.」
        
          - 各プレフィックスの入力欄と、サフィックスの入力欄では、全角文字が入力されていると、該当する入力欄の下にエラーメッセージが表示される
            
              - エラーメッセージ：「Only allow half with 1-bytes character in input」
        
          - エラーが発生した場合、保存されず、画面の「Repository」の選択値が「Root Index」に変わる
        
          - エラーチェックを通過すると、「doi\_identifier」テーブルを更新する。その後、設定された内容を反映した「一覧」（List）タブに移動して、メッセージを画面上部に表示する
            
              - メッセージ：  
                　日本語：「レコードが正常に作成されました。」  
                　英語：「Record was successfully created.」
    
      - ［保存してもう一つ追加（Save and Add Another）］ボタンを押すと、［保存（Save）］ボタンによるものと同様の処理を行い、チェック通過時には「一覧」（List）タブのかわりに「作成」（Create）タブに移動して、同様のメッセージを画面上部に表示する
    
      - ［保存して編集を続ける（Save and Continute Editing）］ボタンを押すと、［保存（Save）］ボタンによるものと同様の処理を行い、チェック通過時には他のタブに移動せずに、同様のメッセージを画面上部に表示する
    
      - ［キャンセル（Cancel）］ボタンを押すと、設定された内容を反映せず、「一覧」（List）タブに戻る

  - 作成した情報は、以下の画面で利用する
    
      - 【Administration \> ワークフロー管理（WorkFlow） \> フロー（Flow List） \> Create Flow画面】
        
          - フローにて「Item Registration」のアクション後に「Identifier Grant」のアクションを定義
        
          - 詳細は[ADMIN-7-1: フロー](#フロー)参照
    
      - 【Administration \> ワークフロー管理（WorkFlow） \> ワークフロー（WorkFlow List） \> Create WorkFlow画面】
        
          - 「Identifier Grant」がフローに含まれるワークフローを定義
        
          - 詳細は[ADMIN-7-2: ワークフロー](#ワークフロー-2)参照

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - weko\_admin

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 「作成」（Create）タブの表示時には、weko\_admin.admin.IdentifierSettingView.create\_formメソッドから同クラスの\_use\_append\_repositoryメソッド、そこから同クラスの\_get\_community\_listメソッドを呼び出して、communities\_communityテーブルの情報を取得する

  - 「編集」（Edit）タブの表示時には、weko\_admin.admin.IdentifierSettingView.edit\_formメソッドから同クラスの\_use\_append\_repository\_editメソッド、そこから同クラスの\_get\_community\_listメソッドを呼び出して、communities\_communityテーブルの情報を取得する

  - 入力値のバリデーションチェックは、weko\_admin.admin.IdentifierSettingView.validate\_formメソッドの中で、同クラスの\_validator\_halfwidth\_inputメソッドで行う

  - 「doi\_identifier」テーブルの更新時にweko\_admin.admin.IdentifierSettingView. on\_model\_changeメソッドが呼び出されて、以下の設定値を作成する
    
      - 「created\_userId」（作成時のみ）：操作しているユーザのid
    
      - 「created\_date」（作成時のみ）：現在の日時を取得して、マイクロ秒部分を0に置き換える
    
      - 「updated\_userId」：操作しているユーザのid
    
      - 「updated\_date」：現在の日時を取得して、マイクロ秒部分を0に置き換える
    
      - 「repository」：「Repository」プルダウンで選択したもののid

  - 「doi\_identifier」テーブルのレコードは、以下のように更新する
    
      - 「id」：作成時に自動採番
    
      - 「repository」：上述のon\_model\_changeメソッドで作成したもの
    
      - 「jalc\_flag」：「Enable/Disable」領域での設定
    
      - 「jalc\_crossref\_flag」：「Enable/Disable」領域での設定
    
      - 「jalc\_datacite\_flag」：「Enable/Disable」領域での設定
    
      - 「ndl\_jalc\_flag」：「Enable/Disable」領域での設定
    
      - 「jalc\_doi」：「JaLC DOI」入力欄の入力値
    
      - 「jalc\_crossref\_doi」：「JaLC CrossRef DOI」入力欄の入力値
    
      - 「jalc\_datacite\_doi」：「JaLC DataCite DOI」入力欄の入力値
    
      - 「ndl\_jalc\_doi」：「NDL JaLC DOI」入力欄の入力値
    
      - 「suffix」：「Semi-automatic Suffix」入力欄の入力値
    
      - 「created\_userId」：上述のon\_model\_changeメソッドで作成したもの
    
      - 「created\_date」：上述のon\_model\_changeメソッドで作成したもの
    
      - 「updated\_userId」：上述のon\_model\_changeメソッドで作成したもの
    
      - 「updated\_date」：上述のon\_model\_changeメソッドで作成したもの

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### アイテム一括出力

  - > 目的・用途

この機能は、USER-2-4の機能であるアイテム一括出力の可否を設定するものである。

  - > 利用方法

【Administration \> 設定(Setting) \> アイテム一括出力(Item Export)画面】を開き、設定後「保存」ボタンを押下する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【Administration \> 設定(Setting) \> アイテム一括出力(Item Export)画面】にアイテムの一括出力を設定する。
    
      - アイテムの一括出力可否（Allow/Disallow Item Exporting）  
        　アイテムの一括出力の機能を「設定する／設定しない」を設定する。
        
          - オン(On)：アイテム一括出力の機能を有効にする。
        
          - オフ(Off)：アイテム一括出力の機能を無効にする。
    
      - コンテンツファイルの出力可否（Export File Contents）  
        　アイテムの一括出力をする際に、コンテンツファイルを含めて「出力する／出力しない」を設定する。
        
          - オン(On)：コンテンツファイルを含めて出力するように設定する。
        
          - オフ(Off)：コンテンツファイルは含めずに出力するように設定する。
    
      - 一括出力できる最大アイテム数はconfigで設定する。デフォルトは最大100件とする。
    
      - 「保存」（Save）ボタンを押すと、設定情報をデータベースに格納する。

  - アイテム一括出力の仕方の詳細は[USER-2-4アイテム一括出力](\\l)を参照すること。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_admin

<!-- end list -->

  - > 処理概要

> アイテム一括出力画面の表示

  - > 【Administration \> 設定 \> アイテム一括出力】画面を開く。この操作によって、weko\_admin.admin.ItemExportSettingView.indexメソッドがGETで呼び出され、\_get\_current\_settingsメソッドでadmin\_settingテーブルのキーitem\_export\_settingsより現在の設定を取得後画面に表示する。

> アイテム一括出力の設定

  - > 任意の設定をした後、「保存」ボタンを押下する。この操作によって、weko\_admin.admin.ItemExportSettingView.indexメソッドがPUTで呼び出され、AdminSettings.updateでadmin\_settingテーブルのキーitem\_export\_settingsに設定が保存される。そして、更新された設定と"Successfully Changed Settings"を画面に表示する。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### ログ解析

  - > 目的・用途

本機能は、リポジトリ管理者として、利用統計の集計除外とするIPアドレスとユーザエージェントを設定できる機能である

  - > 利用方法

【Administration \> 設定（Setting） \> ログ解析（Log Analysis）画面】にて操作を行う

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 利用統計の集計除外とするIPアドレスとユーザエージェントを設定する
    
      - 「フィルタリングするIPアドレスの入力」（Enter the IP Addresses to Filter）
        
          - ログ解析から除外するIPアドレスを指定する
        
          - 各入力欄は、半角数字以外の入力は自動的に削除するようになっている
        
          - IPアドレスは複数入力可能とし、［+］ボタンを押すと、IPアドレスを入力するエリアを追加する
        
          - ［x］ボタンを押すと、該当入力エリアを削除する
        
          - ［+］、［x］ボタンは、一番下の行にのみ表示される
    
      - 「共有クローラーリスト」（Shared Crawler Lists）
        
          - ログ解析から除外するIPアドレス、ユーザエージェントの部分一致キーワードリストを定義し、ネットワークを介して取得、設定する
        
          - デフォルトは以下の通りである
            
              - IPアドレスリスト  
                <https://bitbucket.org/niijp/jairo-crawler-list/raw/master/JAIRO_Crawler-List_ip_blacklist.txt>
            
              - ユーザエージェントリスト  
                <https://bitbucket.org/niijp/jairo-crawler-list/raw/master/JAIRO_Crawler-List_useragent.txt>
            
              - 共用クローラーリストの使用可否は、チェックボックスで設定できる
    
      - ［保存（Save）］ボタンを押下すると、削除してよいかの確認用のモーダルを表示する  
        メッセージ：  
        　日本語：「与えられたアドレスをブロックしてもよろしいですか？」  
        　英語：「Are you sure you want to block the given addresses?」
        
          - ［保存（Save）］：
            
              - 除外対象アドレスおよび共用クローラーリストが、画面の設定内容で更新される
            
              - 画面上部に以下のメッセージが表示される  
                メッセージ：  
                　日本語：「設定を変更しました」  
                　英語：「Successfully Changed Settings.」
        
          - ［閉じる（Close）］：
            
              - モーダルを閉じて、設定画面に戻る

  - ブロックの処理
    
      - 利用統計等の集計時に参照するアクセスログに対し、除外対象アドレスおよび共用クローラーリストから、指定されたIPアドレス、ユーザエージェントを持つアクセスログが集計されないようになる
    
      - 除外されるアクセスログは、画面上で設定したIPアドレスおよび共用クローラーリストに記載されているIPアドレスを持つアクセスログと、共用クローラーリストに記載されている文字列に部分一致するユーザエージェントを持つアクセスログとする
        
          - weko\_admin.config.WEKO\_ADMIN\_USE\_REGEX\_IN\_CRAWLER\_LIST = True とすると正規表現を利用することができる
    
      - 除外されるアクセスログは、ESへ「is\_restricted」がtrueとして登録される
        
          - 通常はfalseとして登録される
        
          - 登録済みのアクセスログには影響しない

  - 設定による影響
    
      - 影響を受ける集計結果は以下のものとする
        
          - ランキング
        
          - 利用統計
        
          - サイトライセンスフィードバックメール送信
        
          - 利用統計フィードバックメール送信
        
          - 定型レポート
        
          - カスタムレポート
    
      - 設定した情報は、IPアドレスについてはloganalysis\_restricted\_ip\_addressテーブルに、共有クローラーリストについてはloganalysis\_restricted\_crawler\_listテーブルに保存される
        
          - 共有クローラーリストのURLの参照先の情報はRedisに保存される
    
      - 画面にてIPアドレスを削除、または共用クローラーリストを有効から無効に変更しても、一度除外されたアクセスログは集計されない

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > invenio-stats：register\_events 関数にて、各インデックスに対する処理クラス、前処理を設定している

  - > weko-admin：画面表示と集計除外処理を定義する

  - > weko-redis：集計除外処理中で、Redisとの接続を管理する

<!-- end list -->

  - > 処理概要

1\. 画面表示

  - 画面表示時には、weko\_admin.admin.LogAnalysisSettings.indexメソッドをGETで呼び出して以下の情報を取得する
    
      - loganalysis\_restricted\_ip\_addressテーブルの全件
    
      - loganalysis\_restricted\_crawler\_listテーブルの全件
        
          - loganalysis\_restricted\_crawler\_listテーブルが空だった場合は、以下のコンフィグからデフォルトの共有クローラーリストのURLを取得してテーブルに追加して、再度全件取得する
            
              - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-admin/weko_admin/config.py#L120-L122>
            
              - 設定キー：WEKO\_ADMIN\_DEFAULT\_CRAWLER\_LISTS

  - 画面側では、IPアドレスと共有クローラーリストそれぞれについて、レコードの数だけ入力欄を表示する
    
      - loganalysis\_restricted\_ip\_addressテーブルから取得した情報は、IPアドレスの入力欄に設定する
        
          - IPアドレスの行ごとに、0始まりの行番号を設定する
        
          - 行ごとに、hiddenのinput要素を配置して、以下のnameとvalueを設定する
            
              - name：ip\_address\_行番号\_id
            
              - value：レコードのid
        
          - 行ごとに、入力欄の各input要素に「address\_list\_行番号」の形のname属性が設定される
        
          - 情報が0件だった場合は、入力欄を1行だけ表示する
    
      - loganalysis\_restricted\_ crawler\_listテーブルから取得した情報は、共有クローラーリストの入力欄に設定する
        
          - 共有クローラーリストの行ごとに、0始まりの行番号を設定する
        
          - 行ごとに、hiddenのinput要素を配置して、以下のnameとvalueを設定する
            
              - name：shared\_crawler\_行番号\_id
            
              - value：レコードのid
        
          - 行ごとに、入力欄の各input要素に「shared\_crawler\_行番号」の形のname属性が設定される
        
          - 情報が0件だった場合は、入力欄を2行だけ表示する

2\. 設定の保存

  - 保存時には、weko\_admin.admin.LogAnalysisSettings.indexメソッドをPOSTで呼び出す
    
      - loganalysis\_restricted\_ip\_addressテーブルへの保存時には、すべてのレコードを物理削除して、画面の各IPアドレスの行の入力内容からレコードを作成する
        
          - 「id」：自動採番
        
          - 「ip\_address」：nameが「shared\_crawler\_行番号」であるinputの各入力値を「.」で連結したもの
    
      - loganalysis\_restricted\_crawler\_listテーブルへの保存時には、以下の処理を行う
        
          - 共有クローラーリストの入力ごとに、レコードから、idが「shared\_crawler\_行番号\_id」の値と等しいものを取得する
            
              - 該当するレコードがあったら、それを入力内容で更新する
            
              - 該当するレコードがなかったら、入力内容で新たにレコードを作成する
    
      - その後、GETで呼び出されたときと同様の処理を行う

3\. イベントログ処理

  - modules/invenio-stats/invenio\_stats/contrib/registrations.py の register\_events 関数で初期化

  - 下記、register\_events 関数にて、各インデックスに対する処理クラス、前処理を設定している。  
    ログ解析機能を利用して設定された情報は flag\_restricted 関数内で利用されている。

> 〜省略〜
> 
> def register\_events():
> 
> """Register sample events."""
> 
> return \[
> 
> dict(
> 
> event\_type='celery-task',
> 
> templates='invenio\_stats.contrib.celery\_task',
> 
> processor\_class=EventsIndexer,
> 
> processor\_config=dict(
> 
> preprocessors=\[
> 
> flag\_restricted,
> 
> flag\_robots,
> 
> anonymize\_user,
> 
> build\_celery\_task\_unique\_id
> 
> \],
> 
> suffix="%Y",
> 
> )),
> 
> 〜省略〜

  - 上記のflag\_restricted関数内でweko\_admin.api.is\_restricted\_user関数を呼び出して対象のログが除外対象かどうかのチェックを行う
    
      - 除外対象となるログは、「is\_restricted」がtrueとなる
    
      - ログの「ip\_address」と「user\_agent」についてチェックを行い、どちらかで除外対象に含まれていればそのログは集計除外となる
        
          - 「ip\_address」について、loganalysis\_restricted\_ip\_addressテーブルにip\_addressフィールドと「ip\_address」とが一致するものがあった場合は除外対象となる
        
          - 「ip\_address」と「user\_agent」について、weko\_admin.api.\_is\_crawler関数を呼び出してチェックを行う
            
              - 以下のコンフィグで、共有クローラーリストによるチェックで正規表現を使用するかどうかを制御する
                
                  - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-admin/weko_admin/config.py#L1278>
                
                  - 設定キー：WEKO\_ADMIN\_USE\_REGEX\_IN\_CRAWLER\_LIST
            
              - 以下のコンフィグで定めたRedisデータベースに接続する
                
                  - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/scripts/instance.cfg#L43>
                
                  - 設定キー：CRAWLER\_REDIS\_DB
            
              - loganalysis\_restricted\_crawler\_listテーブルのアクティブな各レコードから取得した「list\_url」をキーとして、接続したRedisデータベースから共有クローラーリストを取得する
                
                  - 正規表現を使用する場合は文字列、そうでなければset型で取得する
                
                  - 取得できなかった場合は、「list\_url」を使ってインターネット上から共有クローラーリストを取得して、内容を加工したものをRedisデータベースに保存する
                    
                      - キーは「list\_url」の値とする
                    
                      - 内容は以下のように加工する
                        
                          - 正規表現を使用する場合は、「\#」で始まる行を除いた各行の内容を「|」で結合した文字列
                        
                          - 正規表現を使用しない場合は「\#」で始まる行を除いた各行の内容
                    
                      - 保存するデータには、以下のコンフィグで定めたTTLを設定する
                        
                          - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/scripts/instance.cfg#L44>
                        
                          - 設定キー：CRAWLER\_REDIS\_TTL
                    
                      - インターネット接続に失敗した場合、例外となって処理が終了する
                
                  - 「ip\_address」と「user\_agent」を、Redisデータベースに保存されていた、または保存した情報の中から探して、どちらか片方でも存在していたら除外対象に含める
                    
                      - 「is\_restricted」に、is\_restricted\_user関数が返却する真偽値を設定する

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
# 検索設定

## 目的・用途

本機能は、管理者として、デフォルトで表示する検索結果表示及び使用可能な詳細検索条件について設定できる機能である。

## 利用方法

【Administration\>設定（Setting）\>検索設定（Search）】の順でSearch画面に遷移し、検索条件を設定し画面最下部右下にある\[保存(Save)\]ボタンを押下することで設定を反映させる。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

使用している画面

  - 【Administration\>設定（Setting）\>検索設定（Search）】：使用可能な詳細検索条件およびデフォルトで表示する検索結果表示を設定する画面である。

(1)Search Author Setting

  - アイテム詳細画面より、著者のリンクを押下後に表示されるポップアップ内にある"Search repository"リンクを押下した時の検索方法を設定する機能。

  - 以下のいずれかを設定する。初期値は「Search by Author Name」である。
    
      - 著者名で検索（Search by Author Name）:　著者の名前で検索をする。
    
      - 著者名IDで検索（Search by Author ID）:　著者のWEKO IDで検索をする。

  - > (2) 検索結果表示設定デフォルトで表示する検索結果表示及び使用可能な詳細検索条件について設定する。

  - デフォルトで表示する検索結果表示の設定について
    
      - ソート条件利⽤可否で設定できるソート項⽬は、以下とする。
        
          - Title(asc/desc)：タイトル（昇順／降順）
        
          - Creator(asc/desc)：登録者（昇順／降順）
        
          - Item Type(asc/desc)：アイテムタイプ名（昇順／降順）
        
          - ID (asc/desc)：ID（昇順／降順）
        
          - Update(asc/desc)：更新⽇時（昇順／降順）
        
          - Create(asc/desc)：作成⽇時（昇順／降順）
        
          - Date Of Issued(asc/desc)：出版年（昇順／降順）
        
          - Custom(asc/desc)：カスタム（昇順／降順）
        
          - Relevance(asc/desc)
        
          - Temporal(asc/desc)
    
      - 設定内容は以下とする。
        
          - 「検索結果表示設定」（Search Results Setting）
            
              - 「デフォルト表示件数」（Default Display Number）
                
                  - 選択肢：20、50、75、100
                
                  - デフォルト：20
            
              - 「デフォルトソート条件（インデックス検索）」（Default Display Sort (Index Search)）
                
                  - 選択肢：すべてのソート項⽬
                
                  - デフォルト：ID (asc)
            
              - 「デフォルトソート条件（キーワード検索）」（Default Display Sort (Keywords Search)）
                
                  - 選択肢：すべてのソート項⽬
                
                  - デフォルト：Create(desc)
            
              - 「一覧に表示するソート条件を設定してください」（Please set the sort of search results .）
                
                  - デフォルト：すべてのソート項⽬が利用可能として「表示する」（Allow）エリアに表示する。
                
                  - 「表示する」（Allow）エリアに表示している任意項目を選択し、\[→\]ボタンを押すと、選択項目を利用不可の項目とし、「表示しない」(Deny)エリアに移動する。
                
                  - 「表示しない」（Deny）エリアに表示している任意項目を選択肢、\[←\]ボタンを押すと、選択項目を利用可能の項目とし、「表示する」エリアに移動する。

(3) 使用可能な詳細検索条件の設定について

  - 詳細検索条件設定（Detail Search Conditions Setting）  
    検索条件に使⽤するメタデータ項⽬を選択する。
    
      - 表示内容及び設定内容は以下の通りである。
        
          - 項目（Search Item）
        
          - 使用項目（Useable Item）  
            詳細検索で利用可能な条件を設定する。
            
              - チェックボックスにチェックを入れる場合、利用可能な条件とする。
            
              - チェックボックスにチェックを入れない場合、利用不可な条件とする。
        
          - 検索条件（Condition Name）  
            項目のラベルを表示する。
        
          - JPCOARマッピング（JPCOAR Mapping）  
            該当するJPCOARマッピングの項目を表示する。
        
          - 初期選択（Initial Condition）  
            詳細検索の初期画面で表示する項目を設定する。
            
              - チェックボックスにチェックを入れる場合、該当項目を詳細検索の初期画面で表示する。
            
              - チェックボックスにチェックを入れない場合、該当項目を詳細検索の初期画面で表示しない。
        
          - 検索項目設定（Search item setting）  
            検索項目設定押下時に、検索項目設定画面をモーダル表示する。  
            詳細検索条件に指定できないメタデータの検索を行う際に使用する。ESにマッピングされているメタデータに関連づいたアイテムの検索を可能としている。  
            検索項目設定画面では、アイテムタイプをプルダウン形式で選択できる。検索したいメタデータ名をテキスト（text）1\~10、integer\_JA\_1\~5、float\_JA\_1\~5、date\_JA\_1\~5、geopoint\_JA\_1、geoshape\_JA\_1のいずれかにあらかじめ設定しておき、検索項目設定画面にて選択する。その後、検索したいマッピングの指定についての条件を画面中央下部に設定し\[保存（Save）\]ボタン押下で設定する。
            
              - メタデータ名の設定は検索したいメタデータの検索方式に応じて使い分ける。  
                テキスト（text）1\~10：文字列での検索が可能。形式はjsonもしくはxml。  
                integer\_JA\_1\~5：整数値での範囲検索が可能。形式はjsonもしくはxml。  
                float\_JA\_1\~5：小数値での範囲検索が可能。形式はjsonもしくはxml。  
                date\_JA\_1\~5：日付での範囲検索が可能。形式はjsonもしくはxml。  
                geopoint\_JA\_1：緯度，経度を指定して検索が可能。形式はjsonもしくはxml。  
                geoshape\_JA\_1：タイプと座標を指定して検索が可能。形式はjsonもしくはxml。
            
              - 上記の項目を設定し\[保存（Save）\]ボタン押下で、入力内容がdb内のsearch\_managementテーブルのsearch\_conditionsの内容が変更され、検索に反映される。
            
              - 要求された入力形式以外の文字列も入力し\[保存（Save）\]ボタンを押すことは可能であるが、入力形式に誤りがある場合は、db内のsearch\_managementテーブルのsearch\_conditionsは変更されず、検索結果にも影響を及ぼさない。

(4) インデックスツリー／ファセット検索設定

  - インデックスツリーの表示有無と、表示時の横幅と縦幅を設定する。
    
      - 「Display」：チェックボックスにチェックを入れた場合に、Web側のTop画面（メインウィジェット）の左側にインデックスツリーを表示する。  
        チェックを入れない場合はインデックスツリーは表示されない。初期値はチェックボックスにチェックを入れている（インデックスツリーを表示する）状態である。  
        インデックスツリーを表示する設定の場合、以下の設定を変更することができる。  
        ※インデックスツリーを表示しない設定の場合も変更はできるが、Top画面にインデックスツリーは表示されないため、画面上では確認できない。
        
          - 「Width」：プルダウンより横幅の値を選択する。
            
              - 選択肢：1～11　（初期値は「3」）
            
              - 単位：Grid
        
          - 「Height」：縦幅の値をテキストボックスに入力する。　（初期値は「空欄」）
            
              - 単位：pixel  
                ※縦幅の値を入力しない場合や数値以外を入力した場合、インデックスツリーの縦幅はインデックスツリーの中身に応じて自動調整とする

  - ファセット検索の表示有無を設定する。
    
      - 「Display」：チェックボックスにチェックを入れた場合、Web側のTop画面（メインウィジェット）の左側にファセット検索を表示する。  
        チェックを入れない場合、ファセット検索は表示されない。  
        初期値はチェックボックスにチェックを入れていない（ファセット検索を表示しない）状態である。  
        インデックスツリーを表示する設定の場合、ファセット検索はインデックスツリーの下側に表示される。

  - ファセット検索の詳細設定は【Administration\>設定（Setting）\>ファセット検索】で行うことができる。詳しくは[ADMIN14-12:ファセット検索](\\l)を参考。

  - コミュニティの表示有無を決定する。
    
      - 「Display」 :チェックボックスにチェックを入れた場合に、ワークフロー(Workflow)タブの横にコミュニティ(Communities)タブを表示する。タブ選択後の設定については[8 コミュニティ管理](\\l)を参照。

(5)初期表示設定(Main Screen Initial Display Setting )

  - > 初期表示画面設定：「インデックスの検索結果を表示する(Index search result)」「ランキングを表示する(Ranking)」「コミュニティを表示する(Communities)」の中から選択し設定する。設定内容は以下のようになる。
    
      - > 「インデックスの検索結果を表示する(Index search result)」：初期画面中央部にインデックスリストを一つ表示し、その下に表示しているインデックスリスト内のアイテムリストを表示する。  
        > （表示されるインデックスリストは「初期表示インデックス表示方法(Default Index to Display)」を設定することで変更可能。詳しくは後述。）
    
      - > 「ランキングを表示する(Ranking)」：初期画面中央部にランキングを表示する。詳細な表示設定については[ADMIN14-5:ランキング表示](#ランキング表示)を参照。
    
      - > 「コミュニティ一覧を表示する(Communities)」：初期画面中央部にコミュニティをリスト表示する。リスト最上部に検索用テキストボックスがあり、コミュニティ名の部分一致検索を可能としている。テキストボックスに入力後にエンターキー押下で検索をする。

<!-- end list -->

  - > 初期表示インデックス表示方法(Default Index to Display)：「最も新しい公開アイテムの属するインデックス(Index of the newest item registered)」「インデックス指定(Specific index)」のどちらかを選択し設定する。  
    > このテキストボックスは初期表示画面設定を「インデックス検索結果を表示する(Index search result)」を選択しているときのみ操作可能であり、それ以外では非活性となる。

  - > 「最も新しい公開アイテムの属するインデックス(Index of the newest item registered)」：publicなインデックスツリーの中で、最も公開日の新しいアイテムを持つインデックスが初期画面で表示される。（公開日が未来に設定されているものは除く。）

  - > 「インデックス指定(Specific index)」：選択すると、新たに「初期表示インデックス(Initial Display Index)」という項目が表示され、そこで選択したインデックスが初期表示画面に表示される。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_admin

<!-- end list -->

  - > 処理概要

> 検索設定を一度も行っていない状態では、weko\_admin.config内のWEKO\_ADMINMANAGEMENT\_OPTIONSで設定された値がデフォルト表示されている。
> 
> Search Author Settingのラジオボタンを変更すると、weko\_admin.admin.SearchSettingsView.indexが呼び出され、設定の変更が反映される。
> 
> 検索設定の変更はweko\_admin.models.SearchManagement.updateを呼び出してDB上に反映され、それ以降の画面表示はDBの値を参照するものとする。  
> (weko\_admin.config内の設定値はDB内に設定されていない時のみ参照されている。)
> 
> 検索結果表示設定の変更は「search\_management」テーブルの以下のレコードが更新される。

  - > 「default\_dis\_num」：デフォルト表示件数変更時に更新

  - > 「default\_dis\_sort\_index」：デフォルトソート条件（インデックス検索）変更時に更新

  - > 「default\_dis\_sort\_keyword」：デフォルトソート条件（キーワード検索）変更時に更新

  - > 「sort\_setting」：表示するソート条件の変更時に更新

> 詳細検索条件設定の変更は「search\_management」テーブル内の以下のレコードが更新される。

  - > 「search\_conditions」：詳細検索条件変更時に更新

> インデックスツリー/ファセット表示設定の変更は「search\_management」テーブル内の以下のレコードが更新される。

  - > 「display\_control」：\[display\]ラジオボタン変更時に更新

> インデックスツリーの「Width」と「Height」の設定の変更は「index\_style」テーブル内のそれぞれ同名のレコードが更新される。
> 
> 初期表示設定の変更はsearch\_managementテーブル内のinit\_disp\_settingレコードが更新される。
> 
> 検索項目設定から新規の検索項目を作成した場合は、search\_managementテーブルのsearch\_conditionsが変更される。

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>
### ファセット検索

  - > 目的・用途

本機能は、ファセット検索機能を詳細に設定できる機能である。

  - > 利用方法

管理者は本画面でファセット検索として表示する項目を設定できる。

設定された項目をもとに、システムが集計を行い、Web側で各ファセット項目と該当するアイテムをグルーピングし、そのカウントした値を表示する。

利用者は各ファセット項目の中にあるグルーピングされた値を選択することで、絞り込まれたアイテムがアイテムリストに表示される。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

(1) ファセット検索の一覧画面

  - 【Administration \> 設定（Setting） \> ファセット検索（Faceted Search）】を選択すると表示される。

  - 画面構成は以下の通り
    
      - 一覧（List）タブ
        
          - 設定されているファセット検索の項目のリストを表示する。メニューからファセット検索（Faceted Search）を選択すると本タブが表示される。一覧（List）の横にファセット項目数を（）表記する。
    
      - 作成（Create）タブ
        
          - ファセット検索する項目を作成する。　　…詳細は(3)に記載
    
      - フィルターを追加（Add Filter）
        
          - 一覧（List）タブにあるファセット検索の項目のリストを絞り込んで表示する。
    
      - 選択（With selected）
        
          - 一覧（List）タブにあるファセット検索の項目のリストについて、選択したファセット検索の項目を削除する。
    
      - Searchテキストボックス
        
          - キーワードを入力すると、一覧（List）タブにあるファセット検索の項目のリストから検索して表示する。

  - 一覧（List）タブ
    
      - 設定されているファセット検索の項目のリストを表示する。表の構成は以下の通り
        
          - チェックボックス
            
              - ファセット項目を選択できる。選択した項目に対して削除が可能（※選択（With selected）を参照）
        
          - \[目\]マーク
            
              - 選択することで該当のファセット項目の詳細画面に遷移する。　　  
                …詳細は(2)に記載
        
          - \[鉛筆\]マーク
            
              - 選択することで該当のファセット項目の編集画面に遷移する。　　  
                …詳細は(3)に記載
        
          - \[ゴミ箱\]マーク
            
              - 選択することで該当のファセット項目の削除画面に遷移する。　　  
                …詳細は(4)に記載
        
          - ID
            
              - ファセット項目を一意に決定するID。1から順に付与され、初期値としてID 1～7のファセット項目を用意している。
        
          - Item Name(EN)
            
              - ファセット項目の英語の名称
        
          - Item Name(JP)
            
              - ファセット項目の日本語の名称
        
          - UI
        
          - ファセット検索時のUI。
        
          - Mapping
            
              - ファセット項目で集計対象としているマッピングの設定
        
          - Active
            
              - Web画面上にファセット項目を表示しているかどうかを表す。\[レ\]マークが表示、\[－\]マークが非表示を表す。
    
      - 初期値としてファセット項目を用意している。詳細は以下の通り

| ID | Item Name(EN) | Item Name(JP) | Mapping                      | UI        | Active |
| -- | ------------- | ------------- | ---------------------------- | --------- | ------ |
| 1  | Data Language | デ一タの言語        | language                     | SelectBox | \[レ\]  |
| 2  | Access        | アクセス制限        | accessRights                 | SelectBox | \[レ\]  |
| 3  | Location      | 地域            | geoLocation.geoLocationPlace | SelectBox | \[レ\]  |
| 4  | Temporal      | 時間的範囲         | temporal                     | SelectBox | \[レ\]  |
| 5  | Topic         | トピック          | subject.value                | SelectBox | \[レ\]  |
| 6  | Distributor   | 配布者           | contributor.contributorName  | SelectBox | \[レ\]  |
| 7  | Data Type     | デ一タタイプ        | description.value            | SelectBox | \[レ\]  |

　　　　　　　※\[レ\]マークは、Web画面上にファセット項目を表示する設定になっていることを表す。

  - フィルターを追加（Add Filter）
    
      - クリックすると、以下のフィルターリストを表示する。フィルターリストからフィルターをクリックすると、当該フィルターの入力エリアが画面上に追加される。
        
          - ID
            
              - ファセット項目のIDでフィルターを行う。
            
              - 選択できる条件は以下の通り
                
                  - 等しい（equals）　　※初期値
                
                  - 等しくない（not equal）
                
                  - より大きい（greater than）
                
                  - より小さい（smaller than）
                
                  - 空（empty）
                
                  - 一覧にある（in list）
                
                  - 一覧にない（not in list）
        
          - Item Name(EN)
            
              - ファセット項目の英語の名称でフィルターを行う
            
              - 選択できる条件は以下の通り
                
                  - 含む（contains）　　※初期値
                
                  - 含まれていません（not contains）
                
                  - 等しい（equals）
                
                  - 等しくない（not equal）
                
                  - 空（empty）
                
                  - 一覧にある（in list）
                
                  - 一覧にない（not in list）
        
          - Item Name(JP)
            
              - ファセット項目の日本語の名称でフィルターを行う
            
              - 選択できる条件は以下の通り
                
                  - 含む（contains）　　※初期値
                
                  - 含まれていません（not contains）
                
                  - 等しい（equals）
                
                  - 等しくない（not equal）
                
                  - 空（empty）
                
                  - 一覧にある（in list）
                
                  - 一覧にない（not in list）
        
          - Mapping
            
              - ファセット項目のマッピングの設定でフィルターを行う
            
              - 選択できる条件は以下の通り
                
                  - 含む（contains）　　※初期値
                
                  - 含まれていません（not contains）
                
                  - 等しい（equals）
                
                  - 等しくない（not equal）
                
                  - 空（empty）
                
                  - 一覧にある（in list）
                
                  - 一覧にない（not in list）
        
          - UI
            
              - UIの設定でフィルターを行う。
            
              - 選択できる項目は以下の通り。
                
                  - 含む（contains）　　※初期値
                
                  - 含まれていません（not contains）
                
                  - 等しい（equals）
                
                  - 等しくない（not equal）
                
                  - 空（empty）
                
                  - 一覧にある（in list）
                
                  - 一覧にない（not in list）
        
          - Active
            
              - ファセット項目の表示／非表示でフィルターを行う
            
              - 選択できる条件は以下の通り
                
                  - 等しい（equals）　　※初期値
                
                  - 等しくない（not equal）
            
              - 設定できる値は以下の通り
                
                  - はい（Yes）
                
                  - いいえ（No）
    
      - 各フィルターでキーワードを入力後、"Enter"キーもしくは\[適用（Apply）\]ボタンを押下すると、各フィルターの条件で絞り込み検索が行われ、検索結果が画面上に表示される。  
        ※検索結果が無い場合は「表にはアイテムがありません。（There are no items in the table.）」と画面上に表示される
    
      - フィルターによる絞り込み後、\[フィルターをリセット（Reset Filters）\]ボタンを表示すると全ての絞り込みが解除され、最初の一覧（List）タブの状態となる。
    
      - 各フィルターは\[×\]ボタンで入力エリアから削除される。

  - 選択（With selected）
    
      - クリックすると、以下のリストを表示する。リストから削除（Delete）をクリックすると、削除処理を実行確認画面がポップアップする。
        
          - 削除（Delete）
            
              - 選択したファセット項目について削除処理を実行してよいかのメッセージをポップアップで表示する。
                
                  - ポップアップのメッセージ：　「選択したレコードを削除してもよろしいですか。（Are you sure you want to delete selected records?）」  
                    　\[OK\]:　選択したファセット項目を削除する。  
                    　\[キャンセル\]:　削除せずに一覧画面へ戻る。
            
              - ファセット項目を選択していない場合は、ファセット項目のリストから選択をする旨のメッセージをポップアップで表示する。
                
                  - ポップアップのメッセージ：　「少なくとも1つのレコードを選択してください。（Please select at least one record.）」  
                    　\[OK\]:　一覧画面へ戻る。

  - Searchテキストボックス
    
      - キーワードを入力して"Enter"キーを押下すると、入力したキーワードで絞り込み検索が行われ、検索結果が画面上に表示される。  
        ※検索結果が無い場合は「表にはアイテムがありません。（There are no items in the table.）」と画面上に表示される
    
      - キーワードに対し、すべての表の項目に対して部分一致検索を行う。
    
      - キーワードを入力して検索をした後、Searchエリア欄の\[×\]ボタンを表示すると全ての絞り込みが解除され、最初の一覧（List）タブの状態となる。

  - 一覧（List）タブを表示している場合は、登録されている（表示／非表示に関わらず）ファセット項目の数を、タブ上のカッコ内の数値で表示する  
    例えば、ファセット項目が９つ登録されている場合、タブには「一覧(9)」, 「List(9)」のように表示する。

  - 一覧（List）タブの順序は更新順(降順)となる。最後に更新をしたファセット項目はリストの一番下に表示される。

(2) ファセット検索の詳細画面

  - 一覧（List）タブにある各ファセット項目の\[目\]マークを選択することで、選択したファセット項目の詳細画面に遷移する。

  - 選択したファセット項目の詳細画面は 詳細（Details）タブ に表示される。

  - 詳細画面では以下の情報を表示する。
    
      - 項目名(英)（Item Name(EN)）
        
          - 選択したファセット項目の英語名称を表示する。
    
      - 項目名(日)（Item Name(JP)）
        
          - 選択したファセット項目の日本語名称を表示する。
    
      - マッピング（Mapping）
        
          - 選択したファセット項目で集計対象として設定されているマッピング情報を表示する。
    
      - カスタム集計（Custom Aggregations）
        
          - 選択したファセット項目で独自に集計対象として設定したマッピング情報を表示する。  
            表示方法は編集画面にある「Aggregations List」の形とする。
    
      - 表示/非表示（Display/Hide）
        
          - 選択したファセット項目がWeb画面上に表示されているかどうかの設定を表示する。  
            表示の場合は「表示（Display）」, 非表示の場合は「非表示（Hide）」と表示する。
    
      - 開閉状態
        
          - 選択したファセット項目のUIが開かれているかの設定を表示する。

(3) ファセット検索の新規作成・編集画面このセクションを編集

新規作成

  - 一覧（List）タブと並んでいる 作成（Create）タブ を選択することで、新規にファセット項目を作成する。

  - 入力できる内容は以下の通り
    
      - 項目名(英)（Item Name(EN)）
        
          - ファセット項目の英語名称を入力する。テキスト形式で必須項目である。  
            Web画面で日本語以外のページを表示した際に本項目の名称が表示される。
    
      - 項目名(日)（Item Name(JP)）
        
          - ファセット項目の日本語名称を表示する。テキスト形式で必須項目である。  
            Web画面で日本語ページを表示した際に本項目の名称が表示される。
    
      - マッピング（Mapping）
        
          - ファセット項目で集計対象とするマッピング情報を選択する。プルダウン形式(いずれか１つを選択)で必須項目である。  
            プルダウンで選択できるリストは、JPCOARの索引定義（/weko-schema-ui/weko\_schema\_ui/mappings/v6/weko/item-v1.0.0.json）に従う。
    
      - UI
        
          - ファセット検索時のUIを選択する。CheckboxList、SelectBox、RangeSliderの３種から選択する。ただし、RangeSliderについてはマッピングでtemporalを選択した時のみ選択可能となる。
    
      - 表示件数（Display Number）
        
          - UIがCheckboxList時のファセット内の選択肢を設定する数値。1\~99内の整数を入力する。範囲外の整数や整数ではない数、数字以外を入力した場合、「表示件数は1以上99以下の整数値で入力する必要があります。（Display Number must be an integer value from 1 to 99.）」というメッセージがポップアップ表示される。
    
      - カスタム集計（Custom Aggregations）
        
          - ファセット項目で独自に集計対象としてマッピング情報を設定する。設定内容は以下の通り
            
              - 集計一覧（Aggregations List）
                
                  - 独自に集計対象として設定したマッピング情報を「集計マッピング（Aggregation Mapping） - 集計値（Aggregation Value）」の形でリスト形式で表示する。リストの中の行を選択すると、集計マッピング（Aggregation Mapping）と集計値（Aggregation Value）が連動して、選択した行のマッピング情報を表示する。  
                    カスタム集計を設定する際は、集計マッピング（Aggregation Mapping）と集計値（Aggregation Value）は両方とも設定しなければならない。
            
              - 集計マッピング（Aggregation Mapping）
                
                  - 独自に集計対象とするマッピング情報を選択する。プルダウン形式(いずれか１つを選択)であり、プルダウンで選択できるリストは、"item-v1.0.0.json"に従う。
            
              - 集計値（Aggregation Value）
                
                  - 独自に集計対象とするマッピング情報の集計値を設定する。テキスト形式である。

> 【使い方】
> 
> 例１
> 
> 　集計マッピング（Aggregation Mapping）に"publish\_status"を、集計値（Aggregation Value）に"0"を設定した場合、
> 
> 　該当のファセット項目は、マッピングで選択した値　かつ　"publish\_status"が"0"　となっているアイテムを集計します。
> 
> 例２
> 
> 　集計マッピング（Aggregation Mapping）に"title"を、集計値（Aggregation Value）に"テスト"を設定した場合、
> 
> 　該当のファセット項目は、マッピングで選択した値　かつ　"title"が"テスト"(完全一致)　となっているアイテムを集計します。

  - 独自の集計対象として設定したマッピング情報は、以下のボタンで追加／削除ができる。
    
      - \[追加（Add）\]ボタン
        
          - 設定した集計マッピング（Aggregation Mapping）と集計値（Aggregation Value）を集計一覧（Aggregations List）に登録する。
    
    <!-- end list -->
    
      - \[削除（Delete）\]ボタン
        
          - 集計一覧（Aggregations List）のリストの行を選択後、ボタン押下で該当のマッピング情報を削除する。

<!-- end list -->

  - 表示/非表示（Display/Hide）
    
      - 対象のファセット項目をWeb画面上に表示するかどうかを設定する。  
        表示の場合は「表示（Display）」, 非表示の場合は「非表示（Hide）」のラジオボタンを選択する。初期値は「表示（Display）」である。

<!-- end list -->

  - 入力した内容で登録・更新する際は以下のボタンを押下する。
    
      - \[保存（Save）\]ボタン
        
          - 入力した内容を保存し、一覧（List）タブに遷移する。  
            新規に登録した場合は、一覧（List）タブのリストの一番下に表示される。既存のファセット項目を更新した場合は、更新した内容が一覧（List）タブのリストに表示される。
    
      - \[キャンセル（Cancel）\]ボタン
        
          - 入力中の内容を破棄し、一覧（List）タブに遷移する。

編集

  - 一覧（List）タブにある各ファセット項目の\[鉛筆\]マークを選択することで、選択したファセット項目の編集画面に遷移する

  - 編集画面は 編集（Edit）タブ に表示される

  - 画面構成は 作成（Create）タブ と同様。  
    画面遷移すると、選択したファセット項目に登録されている内容が各エリアに表示される

  - 入力できる内容やボタン押下時の動作は 新規作成 の記載内容を参照

エラーメッセージ

  - ファセット登録・編集時において、\[保存（Save）\]ボタン押下時にエラーチェックを行い、不適切なデータ登録をしないように制御を行う。

  - エラーメッセージはポップアップで画面上に表示される。  
    ポップアップ上の\[キャンセル（Cancel）\]ボタンを押下すると、ポップアップは消えて自画面を表示する（修正箇所は赤枠等で表示はされない）

  - 本画面でチェックしているエラー内容は以下の通り。

| エラー発生条件                                           | 表示されるエラーメッセージ                                                                                                                   |
| ------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------- |
| 必須項目が入力されていない状態で保存しようとした場合                        | 必須項目は全て入力して下さい。（Please input all required item.）                                                                                |
| アイテム編集時、必須項目の中で既に存在している名称やマッピング情報がある状態で保存しようとした場合 | 既に存在する項目名・マッピングです。別のファセット項目名・マッピングを入力してください。（The item name/mapping is already exists. Please input other faceted item/mapping.） |
| 予期せぬエラーが発生した場合                                    | サーバエラーのため、作成に失敗しました（Failed to create due to server error.）                                                                      |

(4) ファセット検索の削除画面

  - 一覧（List）タブにある各ファセット項目の\[ゴミ箱\]マークを選択することで、選択したファセット項目の削除画面に遷移する

  - 削除画面は 削除（Delete）タブ に表示される

  - 画面遷移すると、選択したファセット項目に登録されている内容が表示される

  - 削除画面では以下の内容を表示する
    
      - 項目名(英)（Item Name(EN)）
        
          - 選択したファセット項目の英語名称を表示する
    
      - 項目名(日)（Item Name(JP)）
        
          - 選択したファセット項目の日本語名称を表示する
    
      - マッピング（Mapping）
        
          - 選択したファセット項目で集計対象として設定されているマッピング情報を表示する
    
      - カスタム集計（Custom Aggregations）
        
          - 選択したファセット項目で独自に集計対象として設定したマッピング情報を表示する  
            表示方法は編集画面にある「Aggregations List」の形とする
    
      - 表示/非表示（Display/Hide）
        
          - 選択したファセット項目がWeb画面上に表示されているかどうかを表示する  
            表示の場合は「表示（Display）」, 非表示の場合は「非表示（Hide）」と表示する

  - 削除画面では削除をする際は以下のボタンを押下する
    
      - \[削除（Delete）\]ボタン
        
          - ボタンを押下すると、選択したファセット項目について削除処理を実行してよいかのメッセージをポップアップで表示する。
            
              - ポップアップのメッセージ：　「選択したレコードを削除してもよろしいですか。（Are you sure you want to delete selected records?）」  
                　\[OK\]:　選択したファセット項目を削除する  
                　\[キャンセル\]:　削除せずに削除画面へ戻る
    
      - \[キャンセル（Cancel）\]ボタン
        
          - ボタンを押下すると、一覧（List）タブへ戻る

  - 予期せぬエラーが発生した場合、「サーバエラーのため、削除に失敗しました（Failed to delete due to server error.）」のポップアップを表示する  
    \[キャンセル（Cancel）\]ボタンを押下すると、自画面へ戻る

(5) その他

  - 表示している画面のタブから他のタブへ遷移できるもののリストは以下の通り

<table>
<thead>
<tr class="header">
<th>現在のタブ</th>
<th>→</th>
<th>遷移できるタブ</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>一覧（List）</td>
<td>→</td>
<td>作成（Create）</td>
</tr>
<tr class="even">
<td>作成（Create）</td>
<td></td>
<td>一覧（List）</td>
</tr>
<tr class="odd">
<td>編集（Edit）</td>
<td></td>
<td>一覧（List）<br />
作成（Create）<br />
詳細（Details）　※編集（Edit）タブで表示しているファセット項目の詳細画面を表示する<br />
削除（Delete）　※編集（Edit）タブで表示しているファセット項目の削除画面を表示する</td>
</tr>
<tr class="even">
<td>詳細（Details）</td>
<td></td>
<td>一覧（List）<br />
作成（Create）<br />
編集（Edit）　　※詳細（Details）タブで表示しているファセット項目の編集画面を表示する<br />
削除（Delete）　※詳細（Details）タブで表示しているファセット項目の削除画面を表示する</td>
</tr>
<tr class="odd">
<td>削除（Delete）</td>
<td></td>
<td>一覧（List）<br />
作成（Create）<br />
編集（Edit）　　※削除（Delete）タブで表示しているファセット項目の編集画面を表示する<br />
詳細（Details）　※削除（Delete）タブで表示しているファセット項目の詳細画面を表示する</td>
</tr>
</tbody>
</table>

  - ファセット項目を表示する設定としているが、カスタム集計の集計マッピングが未入力のときに、Web画面でインデックスリストの選択と検索ができないため注意  
    (ファセットの表示設定ON/OFFに限らず発生)

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_admin

<!-- end list -->

  - > 処理概要

> 一覧表示

  - > weko\_admin.model.FacetSearchSetting.get\_allが呼び出され、db内のfacet\_search\_settingテーブルの全情報が取り出され表示されている。

  - > 任意のファセット項目の目のマークを押下すると、weko\_admin.admin.FacatSearchView.details\_viewが呼び出され、クリックしたファセット項目の詳細情報が、db内のfacet\_search\_settingテーブルから取り出され表示される。

  - > 任意のファセット項目の鉛筆マークを押下すると、weko\_admin.admin.FacatSearchView.edit\_viewが呼び出され編集画面へ移行し、\[保存(Save)\]ボタンを押下すると、 weko\_admin.views.save\_facet\_searchが呼び出され、編集内容に問題がなければ、db内のfacet\_search\_settingテーブルの情報が変更される。

  - > 任意のファセット項目のゴミ箱マークを押下すると、weko\_admin.admin.FacetSearchSettingView.deleteが呼び出され削除画面へ移行し、「削除（delete）」ボタンが押下されるとweko\_admin.views.remove\_facet\_searchが呼び出され、db内のfacet\_search\_settingテーブルから選択したファセット項目が削除される。

> 作成

  - > 作成タブを押下すると、weko\_admin.admin.FacetSearchSettingView.create\_viewが呼び出され、作成画面へ移行する。各種項目に作成するファセット項目の情報を入力し\[保存（Save）\]ボタンを押下すると、weko\_admin.views.save\_facet\_searchが呼び出され、入力項目に問題がなければ、db内のfacet\_search\_settingテーブルに入力情報が追加される。入力項目の規制については、上記の「(3) ファセット検索の新規作成・編集画面このセクションを編集」に示した通りである。

> 選択

  - > 一つ以上のファセット項目を選択した状態で、選択タブから削除を選択することで、weko\_gridlayout.admin.WidgetSettingView.action\_deleteが呼び出され、db内のfacet\_search\_settingテーブルから選択した情報が削除される。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### サイト情報

  - > 目的・用途

リポジトリ管理者として、サイトの情報を登録する機能である。また、サイト名は多言語対応できる

  - > 利用方法

【Administration＞設定（Setting）＞サイト情報（Site Info）】の順でSite Info画面へ遷移して利用する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【Admin \> Setting \> Site Info】：サイトの情報を登録する。
    
      - 登録項目は以下通りである。
        
          - 「サイト名」（Site Name）
            
              - サイト名称を入力するテキストエリア
            
              - デフォルト値は、「サイト名未設定」（Site name is not set）とする。
            
              - 「サイト名の追加」（Add site name）ボタン及び言語プルダウンを設ける。
                
                  - 「サイト名の追加」（Add site name）ボタンを押すと、「サイト名」および「言語」の入力欄を最下段に1行追加表示する。
                
                  - 言語プルダウンの選択肢は【Administration \>設定（ Setting）\> 言語表示（Language）】での「登録言語」に登録されている言語一覧とする。デフォルト値は「登録言語」の1番目の言語とする。
                
                  - 入力欄がシステム言語の数と同数になったら、このボタンは不活性とする。
                
                  - 同一言語に一つサイト名のみを設定できる。
        
          - 「ファビコン」（Favicon）
            
              - 「アイコンファイルの選択」（Select icon file）ボタンを設ける。
            
              - デフォルトは、JAIRO Cloudのアイコンを設定しておく。
            
              - 押下するとファイル選択ダイアログが表示される。
            
              - 選択ダイアログはアイコンファイルのみ選択可能とする。
            
              - ファイル選択が完了すると、ファイル名表示欄に選択ファイル名を、アイコンプレビュー表示欄にプレビューを表示する。
        
          - 「著作権」（CopyRight）
            
              - このサイトの著作権を設定する。ここで入力された項目は、htmlの\<head\>\<meta\>のname="copyright\>属性に出力する。
            
              - デフォルト：空白
        
          - 「記述」（Description）
            
              - このサイトの概要を設定する。ここで入力された項目は、htmlの\<head\>\<meta\>のname="Description"属性に出力する。
            
              - デフォルト：空白
        
          - 「キーワード」（Keyword）
            
              - このサイトの概要を設定する。ここで入力された項目は、htmlの\<head\>\<meta\>のname="keyword"属性に出力する
            
              - デフォルト：空白
        
          - 「トラッキングID」（Tracking ID）
            
              - Google AnalyticsのトラッキングIDを設定する。Admin画面で設定した値は GOOGLE\_TRACKING\_ID\_USER として admin\_setting テーブルに保存する。
            
              - デフォルト：空白
        
          - 「AddThis ID」（AddThis ID）
            
              - AddThisのトラッキングIDを設定する。Admin画面で設定した値は ADDTHIS\_USER\_ID として site\_infoテーブルに保存する。
            
              - デフォルト：ra-5d8af23e9a3a2633
        
          - 「OGPイメージ」（OGP Image）
            
              - og:imageへ設定するための画像アップロード機能を追加する。ファイル形式は JPG, PNG, WEBP, GIF フォーマット、ファイルサイズは 5MB 未満とする。  
                アップロードしたファイルの保存ディレクトリは Files \> Location で設定しているディレクトリに統一する。  
                本画面で設定した画像ファイルは、WEKO3のWeb画面のheadタブ内にあるmetaタグのcontentにファイルのフルパスで表示する。  
                ※OGP Imageに画像をアップロードしていない場合: content="" となる。
            
              - デフォルト：空白
    
      - 「保存」（Save）ボタンを押すと、
        
          - バリデーションを実施し、問題がなければデータベースに設定値を保存し、メッセージを画面の上部に表示する  
            メッセージ：  
            日本語：「サイト情報が正常に保存されました。」  
            英語：「Site info is saved successfully.」
        
          - データベースには、設定された値を記録する。
        
          - バリデーションエラーが発生したら、エラーダイアログを表示後、入力画面に戻る。
        
          - エラーダイアログにはバリデーションエラー内容を表示する。
    
      - バリデーション及びエラーメッセージ
        
          - サイト名が一つも設定されていないとき  
            エラーメッセージ：  
            日本語：「サイト名は少くとも１つ設定する必要があります。」  
            英語：「Must set at least 1 site name.」
        
          - サイト名を複数設定する際に、同一言語を選択したとき  
            エラーメッセージ：  
            日本語：「同一言語を複数のサイト名に設定されています。」  
            英語：「The same language is set for many site names.」
        
          - トリミングしたサイト名が空文字であるとき  
            エラーメッセージ：  
            日本語：「×サイト情報を空のフィールドに入力してください。」  
            英語：「Please input site information for empty field.」
        
          - 選択していた言語が登録言語から削除されたとき  
            エラーメッセージ：  
            日本語：「削除された言語は利用できません」  
            英語：「Language is deleted from Registered Language of system」
        
          - サイト名はトリミングした入力値を保存すること  
            ※サイト名をHTMLとして埋め込む際はエンコード処理を実施するなど配慮すること

  - 設定されたサイト名及びファビコン表示について
    
      - サイト名表示
        
          - 設定されたサイト名は、全ての画面で\<title\>タグの値に設定する。
        
          - \<title\>に設定する値は、システムの言語設定に合わせた言語のサイト名を表示する  
            なお、システム言語にマッチするサイト名が設定されていない場合は、英語、もしくは最上位の言語のサイト名を表示する。
    
      - ファビコン表示
        
          - 設定されたアイコンをシステムのfaviconとして設定する。

  - OGP対応
    
      - サイト情報をOGP(Open Graph protocol)で出力する。
    
      - meta要素としてog:titleを出力する。
    
      - meta要素としてog:urlを出力する。
    
      - meta要素としてog:imageを出力する。
    
      - meta要素としてog:descriptionを出力する。
    
      - meta要素としてog:localeを出力する。。値としてリポジトリサイトのデフォルトロケールを出力すること
    
      - meta要素としてog:locale:alternateを出力する。値としてリポジトリサイトが対応するデフォルト以外のロケールを出力すること

  - Admin/setting/site info の「サイト名」に入力された値をフィードバックメールの件名、本文内に反映する。
    
      - 日本語メールには日本語サイト名を、英語メールには英語サイト名をセットする。
    
      - 空欄のサイト名の場合は「No Site Name」と表示する。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko-admin

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - > 登録するサイト情報を入力後に\[保存（Save）\]ボタン押下すると、weko\_admin.views.update\_site\_infoが呼び出され、その中でweko\_admin.utils.validation\_site\_infoを使用し、入力値のエラーチェックを行う。  
    > 入力値に問題がなければ、db内のsite\_infoテーブルに情報が保存される。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>



### サイトライセンス

  - > 目的・用途

<!-- end list -->

  - > 本機能は、サイトライセンスの設定を行う機能である。利用方法

【Administration＞設定（Setting）＞サイトライセンス（Site License）】の順でSite License画面へ遷移して利用する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容
    
      - > 【Administration\>設定（Setting）\>サイトライセンス（Site Licsnse）】の順で、Site License画面へ遷移しサイトライセンスの設定を行う。設定できる項目を以下に示す。  
        > 以下の項目の設定後、画面最下部の\[保存（Save）\]ボタン押下で、変更が適応される。「ログインせずにコンテンツをダウンロードできるIPアドレスの範囲を指定してください(Please specify range of IP address which allow users can download contents without login.)」：初期状態では、\[その他の入力行（More Inpit Row）\]ボタンのみがあり、押下することで以下のテキストボックスが現れ、設定を可能とする。
        
          - > 機関名（Organization Name）：機関名を設定するテキストボックス。初期値はなし。
        
          - > メールアドレス（E-Mail Address）：メールアドレスを設定するテキストボックス。初期値はなし。
        
          - > ドメイン名（Domain Name）：ドメイン名を設定するテキストボックス。初期値はなし。
        
          - > IPアドレスの範囲（IP Address Range）（from-to）：半角数字のみ受け付けるテキストボックス。初期値はなし。入力必須項目であり、半角数字以外を入力すると「正しい数値を入力してください（Please input a correct number）」と表示される。また、\[その他の入力行（More Input Row）\]ボタンが直下に追加され、押下することで、複数のＩＰアドレスの範囲を指定することができる。
        
          - > \[削除（delete）\]ボタンを押下することで、テキストボックスを削除することができる。
    
      - > 「サイトライセンスから除外できるアイテムタイプを指定してください（Please specify item type to be excluded from the site license）」:サイトライセンスから除外するアイテムタイプの設定を行う。初期状態では、登録されているアイテムタイプのすべてが「表示する（Allow）」リストに格納されており、除外したいアイテムタイプを選択し、\[→\]ボタンを押下することで「表示しない（Deny）」リストへ移動させる。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko-admin

<!-- end list -->

  - > 処理概要

> 任意の設定値入力後、\[保存（Save）\]ボタンを押下することで、weko\_admin.admin.SiteLicenseView.indexが呼び出され、そこで入力項目に問題がなければdb内のsitelicense\_infoに入力した情報と更新時間（最初の一回は作成時間）が保存され、「Site license was successfully updated」というメッセージが上部に表示され、入力内容を保持した画面に遷移する。

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>


### サイトマップ

  - > 目的・用途

本機能は、サイトマップを作成しキャッシュに保存する機能である。サイトマップを作成することで、クローラビリティが向上するメリットがある。

  - > 利用方法

【Administration\>設定（Setting）\>サイトマップ（Site Map）】の順で画面遷移し、\[実行（Run）\]ボタンを押下することでサイトマップの作成が可能。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

1\. システムのフォーマットでサイトマップを生成できる

  - 【Administration \> 設定（Setting） \> サイトマップ（Sitemap）】にサイトマップの生成を実行する。
    
      - \[実行（Run）\]ボタンを押すと、サイトマップの生成が実行される。
    
      - 実行された後、以下のような生成情報をSitemap画面に表示する。
        
          - 開始時間（Start Time）  
            フォーマット：YYYY-MM-DDThh:mm:ss
        
          - 終了時間（End Time）  
            フォーマット：YYYY-MM-DDThh:mm:ss
        
          - Records Processed
        
          - ステータス（status）：SUCCESS、ERROR
    
      - 出力ファイルは以下の通りである
        
          - sitemap\_\*\*\*\*.xml.gz  
            「\*\*\*\*」は対象アイテム数により10000件ごとに1ずつインクリメンタルされる（0001,0002・・・）
            
              - 1つのqzファイルの中に10000件ごとのXML（sitemap\_\*\*\*\*.xml）が一つのファイルに格納される
            
              - XMLには一つのアイテムに対して以下のような情報を出力する
                
                  - アイテム詳細URL
                
                  - lastmod  
                    フォーマット：YYYY-MM-DDThh:mm:ss.sTZD  
                    例：2019-03-07T16:36:27+09:00
            
              - アイテム詳細URLがアイテムID順に出力される
            
              - ダウンロードアドレス：「ホスト」/weko/sitemaps/sitemap\_\*\*\*\*.xml.gz
        
          - sitemapindex.xml  
            上記のsitemap\_\*\*\*\*.xml.gzを全て出力する
            
              - ダウンロードアドレス：「ホスト」/weko/sitemaps/sitemapindex.xml

2\. サイトマップ生成の定期実行を可能

  - 設定した時刻にサイトマップ更新を定期実行する。  
    （更新するタイミングの設定については、以下の処理概要に記載）

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko-sitemap

<!-- end list -->

  - > 処理概要

1\. 設定

  - Sitemap画面のテンプレートURLを設定する
    
      - パス：https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-sitemap/weko\_sitemap/config.py\#L13
    
      - 設定キー：WEKO\_SITEMAP\_ADMIN\_TEMPLATE  
        現在の設定値:

> WEKO\_SITEMAP\_ADMIN\_TEMPLATE = 'weko\_sitemap/sitemap.html'

  - データベースから取得するアイテムの上限レコード数を設定する
    
      - パス：https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-sitemap/weko\_sitemap/config.py\#L16 
    
    <!-- end list -->
    
      - 設定キー：WEKO\_SITEMAP\_TOTAL\_MAX\_URL\_COUNT  
        現在の設定値:

> WEKO\_SITEMAP\_TOTAL\_MAX\_URL\_COUNT = 10000000

  - キャッシュのタイムアウト時間を設定する
    
      - パス：https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-sitemap/weko\_sitemap/config.py\#L24 
    
      - 設定キー：WEKO\_SITEMAP\_CACHE\_TIMEOUT  
        現在の設定値:

> WEKO\_SITEMAP\_CACHE\_TIMEOUT = 60 \* 60 \* 24 \* 3
> 
> URLのプレフィックスを設定する

  - パス：https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-sitemap/weko\_sitemap/config.py\#L30

  - 設定キー：SITEMAP\_BLUEPRINT\_URL\_PREFIX  
    現在の設定値:

<!-- end list -->

  - SITEMAP\_BLUEPRINT\_URL\_PREFIX = '/weko/sitemaps'

> 「sitemapindex」URLのエンドポイントを設定する

  - パス：https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-sitemap/weko\_sitemap/config.py\#L32 

  - 設定キー：SITEMAP\_ENDPOINT\_URL  
    現在の設定値:

> SITEMAP\_ENDPOINT\_URL = '/sitemapindex.xml'
> 
> 各ページURLのエンドポイントを設定する

  - パス：https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-sitemap/weko\_sitemap/config.py\#L34 

  - 設定キー：SITEMAP\_ENDPOINT\_PAGE\_URL  
    現在の設定値:

> SITEMAP\_ENDPOINT\_PAGE\_URL = '/sitemap\_\<int:page\>.xml.gz'
> 
> Sitemapの上限URL数を設定する

  - パス：https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-sitemap/weko\_sitemap/config.py\#L36

  - 設定キー：SITEMAP\_MAX\_URL\_COUNT  
    現在の設定値:

> SITEMAP\_MAX\_URL\_COUNT = 10000
> 
> 自動更新タイミングを設定する

  - パス：https://github.com/RCOSDP/weko/blob/v0.9.22/scripts/instance.cfg\#L119

  - 設定キー：update\_sitemap

  - 設定値：days、minutes、hours  
    現在の設定値：

> 'update\_sitemap': {
> 
> 'task': 'weko\_sitemap.tasks.update\_sitemap',
> 
> 'schedule': timedelta(days=3, minutes=0, hours=0),
> 
> 'args': \[\],
> 
> },

2\. 実装方法

  - 【Administration \> Setting（設定） \> Sitemap】を以下のテンプレートで表示する
    
      - 設定キー：WEKO\_SITEMAP\_ADMIN\_TEMPLATE
    
      - パス：https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-sitemap/weko\_sitemap/templates/weko\_sitemap/sitemap.html

  - Sitemapを更新する処理
    
      - 【Administration \> （設定）Setting \> Sitemap】の順でサイトマップ画面へ遷移し\[実行（Run）」ボタンを押すと、weko\_sitemap.admin.update\_sitemapが呼び出され、sitemapの情報を以下のように取得する。
        
          - データベースからの値：pidstore\_pid.pid\_value、records\_metadata.updated
        
        <!-- end list -->
        
          - 条件：「pidstore\_pid.status = 'R' (registered)」AND「pidstore\_pid.pid\_type = 'recid'」
        
          - 上限レコード数：「WEKO\_SITEMAP\_TOTAL\_MAX\_URL\_COUNT」の値
        
          - 取得されたデータをファイルに分ける  
            1つのファイルに格納される上限URL数：「SITEMAP\_MAX\_URL\_COUNT」の値
    
      - 取得されたデータから、Sitemapの情報を以下のように作成する
        
          - アイテム詳細のURLは以下のように構築される

> {
> 
> loc: \<invenio\_records\_ui.recidのURL\> + pidstore\_pid.pid\_value,
> 
> lastmod: records\_metadata.updated
> 
> }

  - Sitemapの情報をキャッシュに保存する
    
      - sitemap\_\<page\>.xml.gz

> 'sitemap\_' + page\_number: {
> 
> lastmod: \<現在のシステム日時\>,
> 
> page: \<アイテム詳細のURL\>
> 
> }

  - sitemapindex.xml

> sitemap\_page\_keys: \[
> 
> 'sitemap\_' + page\_number,
> 
> ...
> 
> \]

  - Sitemap情報をキャッシュから自動的に削除される処理
    
      - キャッシュのタイムアウト時間を以下のコンフィグで設定する  
        設定キー：WEKO\_SITEMAP\_CACHE\_TIMEOUT
    
      - 「page\_number」及び「sitemap\_page\_keys」キャッシュに対してweko\_sitemap.ext.set\_cache\_pageでタイムアウト時間を指定している

<!-- end list -->

  - 「sitemapindex」URL及び各ページURLを構築する
    
      - 「sitemapindex」URL

> WEKO\_SITEMAP\_URL\_SCHEME + \<ホスト\> + SITEMAP\_BLUEPRINT\_URL\_PREFIX + SITEMAP\_ENDPOINT\_URL

  - 各ページURL

> WEKO\_SITEMAP\_URL\_SCHEME + \<ホスト\> + SITEMAP\_BLUEPRINT\_URL\_PREFIX + SITEMAP\_ENDPOINT\_PAGE\_URL

  - Sitemap情報をダウンロードする処理
    
      - sitemapindex.xmlweko\_sitemap.ext.get\_cache\_pageで 上記の「sitemap\_page\_keys」からのデータを取得し、weko\_sitemap.ext.sitemapで以下のように出力する。

> \[
> 
> {
> 
> loc: \<ファイルのURL\>,
> 
> lastmod: 'sitemap\_ + page\_number'.lastmod
> 
> },
> 
> ...
> 
> \]

  - sitemap\_\<page\>.xml.gz  
    weko\_sitemap.ext.pageでURLに入力しているページ番号に応じて、該当「page\_number」から取得するデータを出力、weko\_sitemap.ext.gzip\_responseでデータを「gz」ファイルに圧力する。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### メール送信

  - > 目的・用途

本機能は、送信元の情報を設定する機能である

  - > 利用方法

【Administration \> 設定（Setting） \> メール送信（Mail）画面】に送信元の情報を設定する

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 「Mail Setting」にてメールサーバの設定をする
    
      - 設定項目は以下の通りである
        
          - 「SMTPサーバ（Server）」：メールサーバ
            
              - デフォルト：「localhost」
        
          - 「ポート（Port）」：メールポート
            
              - デフォルト：「25」
        
          - 「TLSを使用する（Use TLS）」
            
              - デフォルト：チェックなし
        
          - 「SSLを使用する（Use SSL）」
            
              - デフォルト：チェックなし
        
          - 「ユーザー名（Username）」
            
              - デフォルト：空白
        
          - 「パスワード（Password）」
            
              - デフォルト：空白
        
          - 「ドメイン（Domain）」
            
              - デフォルト：空白
        
          - 「デフォルト送信元（Default sender）」
            
              - デフォルト：空白
    
      - ［更新（Update）］ボタンを押すと、入力内容を確認し、エラーなしの場合、設定内容を保存し、メッセージを画面上部に表示する  
        　メッセージ：  
        　日本語：「メールの設定を更新しました」  
        　英語：「Mail settings have been updated.」
    
      - エラーの場合は以下の通りである
        
          - 「Server」に入力しない場合  
            エラーメッセージ：「Mail server can't be empty.」
        
          - 「Port」に入力しない場合  
            エラーメッセージ：「Mail port can't be empty.」
        
          - 「Default sender」に入力しない場合  
            エラーメッセージ：「Mail default sender can't be empty.」

  - 「Send Test Mail」にてテストメール送信を行う
    
      - 設定項目は以下の通りである
        
          - 「送信先（Recipient）」
        
          - 「主題（Subject）」
        
          - 「本文（Body）」
    
      - ［送信（Enable）］ボタンを押すと、設定内容でメールの送信を行う
        
          - 送信が成功の場合、以下のメッセージを画面上部に表示する  
            　メッセージ：  
            　日本語：「テストメールを送信しました。」  
            　英語：「Test mail sent.」
        
          - 送信が失敗の場合、以下のメッセージ及びエラーコードを画面上部に表示する  
            メッセージ：「Failed to send mail.」

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - invenio-mail

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 画面表示時は、invenio\_mail.admin.MailSettingVIew.indexメソッドがGETで呼び出される
    
      - このとき、mail\_configテーブルからメールサーバの設定を取得する
        
          - invenio\_mail.models.MailConfig.get\_configメソッドの中で、設定が取得できなかった場合は、デフォルトの内容のレコードを作成してからそれを取得する
    
      - 「Mail Setting」の内容を取得したもの、「Send Test Mail」の内容を空欄として表示する

  - ［更新（Update）］ボタンを押すと、invenio\_mail.admin.MailSettingVIew.indexメソッドがPOSTで呼び出される
    
      - エラーチェックを通過した場合、mail\_configテーブルのレコードを更新する
        
          - invenio\_mail.models.MailConfig.set\_configメソッドによって、１つのレコードを更新する
    
      - その後、「Mail Setting」の内容を画面で入力したもの、「Send Test Mail」の内容を空欄として画面に表示する

  - ［送信（Enable）］ボタンを押すと、invenio\_mail.admin.MailSettingVIew.send\_test\_mailメソッドが呼び出される
    
      - mail\_configテーブルから取得した情報をメールサーバの各種設定として、「Send Test Mail」の各入力欄に入力したものをメッセージとしてcurrent\_app.extensions\['mail'\]に設定して、送信する
    
      - その後、「Mail Setting」の内容をテーブルから取得したもの、「Send Test Mail」の内容を空欄として画面に表示する

  - 「ドメイン（Domain）」の値を持ちいて送信元ドメインを設定する。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/11/11</p>
</blockquote></td>
<td>V0.9.23</td>
<td></td>
</tr>
</tbody>
</table>### WebAPIアカウント

  - > 目的・用途

本機能は、アイテムメタデータ自動入力機能におけるAPIアカウント認証で使用する情報を設定する機能である

  - > 利用方法

【Administration \> 設定（Setting） \> WebAPIアカウント（WebAPI Account）画面】にてアイテムメタデータ自動入力機能で連携するWeb APIのアカウント情報を設定する

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - v0.9.22では、CrossRefのみ対応している

  - 設定項目は以下とする
    
      - 「入力タイプ」（Input Type） ：タイプを選択する
        
          - 画面表示時の選択値は、「入力タイプを選択してください」（Please selected the input type）
    
      - 各種APIに必要なアカウント設定フィールド
        
          - 入力タイプで "CrossRef" を選択した場合は、以下の入力フィールドを表示する  
            「CrossRefクエリサービスアカウント」（CrossRef Query Services Account）

  - ［保存（Save）］ボタンを押すと入力内容のチェックを行い、エラーがなければ設定情報が保存される
    
      - 「入力タイプ」（Input Type）の選択値が「入力タイプを選択してください」（Please selected the input type）である間、［保存（Save）］ボタンは非活性である
    
      - 「CrossRefクエリサービスアカウント」（CrossRef Query Services Account）が空の状態でボタンを押すと、保存されずに以下のエラーメッセージがポップアップで表示される  
        エラーメッセージ：「Account information is invalid. Please check again.」
    
      - 「CrossRefクエリサービスアカウント」（CrossRef Query Services Account）に入力値がある場合は、その内容を使って接続の確認を行い、正常に接続できなかった場合は、保存されずに保存されずに以下のエラーメッセージがポップアップで表示される  
        エラーメッセージ：  
        　日本語：「アカウント情報が無効です。再度確認してください」  
        　英語：「Account information is invalid. Please check again.」
    
      - エラーが発生しなかった場合は、以下のメッセージが表示される  
        メッセージ：「Account info has been saved successfully.」

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - weko\_admin

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 画面表示時は、weko\_admin.admin.WebApiAccount.indexメソッドがGETで呼び出される
    
      - テーブルから情報を取得するなどの処理は行わない

  - 「入力タイプ」（Input Type）でタイプを選択すると、weko\_admin.views. get\_curr\_api\_cert関数が呼び出される
    
      - この中では、weko\_admin.utils.get\_current\_api\_certification関数で、api\_certificateテーブルから「入力タイプ」（Input Type）の選択値のvalueと「api\_code」フィールドが一致するレコードを取得する
    
      - 取得した値を、「CrossRefクエリサービスアカウント」（CrossRef Query Services Account）入力フィールドに設定する

  - ［保存（Save）］ボタンを押すと、web\_api\_account.jsで入力値のチェックを行い、エラーがなければweko\_admin.views. save\_api\_cert\_data関数がajaxで呼び出される
    
      - 「CrossRefクエリサービスアカウント」（CrossRef Query Services Account）が空だった場合のチェックはweb\_api\_account.jsで行う
    
      - save\_api\_cert\_data関数の中で、weko\_admin.utils.calidate\_certification関数によって接続確認を行う
    
      - 接続確認に成功した場合に、api\_certificateテーブルに「入力タイプ」（Input Type）の選択値のvalueと「api\_code」フィールドが一致するレコードがあるかどうか確認して、あった場合にそのレコードを更新する

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### ファイルプレビュー

  - > 目的・用途

本機能は、Microsoft Officeファイルをプレビュー表示する際に、PDFファイルへ指定されたファイルの変換に設定する機能である

  - > 利用方法

【Administration \> 設定（Setting） \> ファイルプレビュー（File Preview）画面】にてPDFファイルの保存先パス及び保存期間を設定する

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 画面表示時に、各設定値を取得して入力エリアに表示する
    
      - 「PDF Save Path」：サーバー側で変換したPDFファイルの保存先パスを設定する
        
          - デフォルトの値：「/tmp」
    
      - 「PDF TTL」：PDFファイルの保存期間を設定する
        
          - デフォルトの値：「3600」
        
          - 単位：秒
    
      - ［保存（Save）］ボタンを押すと、設定内容を保存し、メッセージを画面上部に表示する  
        メッセージ：  
        　日本語：「設定を変更しました」  
        　英語：「Successfully Changed Settings.」
        
          - 「PDF Save Path」の入力値が「/」であるか、どちらかの入力欄が空である場合、設定内容を保存せずに、エラーメッセージを画面上部に表示して、画面を再表示する  
            エラーメッセージ：  
            　日本語：「設定変更に失敗しました」  
            　英語：「Failurely Changed Settings.」
        
          - 「PDF Save Path」の入力値の末尾が「/」である場合、末尾の「/」を除いた内容が保存される
        
          - 「PDF Save Path」が変更される場合、もともとのパスにあったファイルは削除される

  - ここで設定した値を使用して、保存時間を過ぎたPDFファイルを削除する処理を定期的に実行する

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - invenio\_files\_rest：各デフォルト値をコンフィグで定義している

  - weko\_admin：画面表示のクラスと、設定を保存するDBを定義している

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 画面表示時は、weko\_admin.admin. FilePreviewSettingsView.indexメソッドがGETで呼び出される
    
      - このとき、admin\_settingsテーブルからnameが「convert\_pdf\_settings」であるレコードを取得する
        
          - 取得できなかった場合は、以下のコンフィグからデフォルトの内容を取得する
            
              - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-files-rest/invenio_files_rest/config.py#L128-L131>
            
              - 設定キー：
                
                  - FILES\_REST\_DEFAULT\_PDF\_SAVE\_PATH
                
                  - FILES\_REST\_DEFAULT\_PDF\_TTL
    
      - 取得した情報を各入力欄に設定して画面表示する

  - ［保存（Save）］ボタンを押すと、weko\_admin.admin. FilePreviewSettingsView.indexメソッドがPOSTで呼び出される
    
      - admin\_settingsテーブルに、以下の内容で保存する  
        ※nameが同じレコードがなかった場合は新規作成、あった場合は更新する
        
          - name：「convert\_pdf\_settings」
        
          - settings：「{"path":「PDF Save Path」の入力値, "pdf\_ttl":「PDF TTL」の入力値}」
    
      - その後、GETで呼び出されたときと同様の処理を行い、画面表示する

  - ここで設定した値は、invenio\_files\_rest.tasks.check\_file\_storage\_time関数で使用する
    
      - この関数は、celeryタスクで定期的に実行する
    
    <!-- end list -->
    
      - > admi）："の場所にある各ファイルについて、最終更新日時から（"pdf\_ttl"の値）秒以上経過していた場合に、invenio\_files\_rest.storage.pyfs. remove\_dir\_with\_file関数によって削除する

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### Shibboleth

  - > 目的・用途

本機能は、システム利用者がログインする際のシボレスユーザーの許可/拒否を設定する機能である。

  - > 利用方法

【Administration \> 設定（Setting） \> Shibboleth画面】にて操作を行う。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 画面には以下の選択肢を持つラジオボタンがあり、現在の許可/拒否設定を反映して表示される
    
      - 「Shibbolethを有効にする」(Enable Shibboleth Authentication)
        
          - シボレスユーザーを許可とし、「Shibboleth User」ボタンをログイン画面に表示させる設定
    
      - 「Shibbolethを無効にする」（Disable Shibboleth Authentication）
        
          - シボレスユーザーを拒否とし、「Shibboleth User」ボタンをログイン画面に表示させない設定

  - ［保存（Save）］ボタンを押すと、設定内容を保存し、以下のメッセージを画面上部に表示する  
    JP：「Shibboleth設定を更新しました」  
    EN：「Updated Shibboleth settings」

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - weko\_accounts

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 画面表示時に、weko\_accounts.admin.ShibSettingView.indexメソッドをGETで呼び出して、instance.cfgまたはweko-accountsで以下のコンフィグからShibbolethの許可設定を読み込む。両方で設定されている場合、instance.cfgの設定が優先される。また、画面で設定を変更した場合は、その変更が最優先される。
    
      - パス（instance.cfg）：  
        <https://github.com/RCOSDP/weko/blob/v0.9.22/scripts/instance.cfg#L436>
    
      - パス（config.py）：  
        <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-accounts/weko_accounts/config.py#L29>
    
      - 設定キー：WEKO\_ACCOUNTS\_SHIB\_LOGIN\_ENABLED

  - ［保存（Save）］ボタンを押すと、weko\_accounts.admin.ShibSettingView.indexメソッドをPOSTで呼び出して、以下のようにしてコンテキストに設定を保存する。

> \_app = LocalProxy(lambda: current\_app.extensions\['weko-admin'\].app)
> 
> ※上記はShibSettingViewクラスの外で定義
> 
> shib\_flg = request.form.get('shibbolethRadios', '0')
> 
> if shib\_flg == '1':
> 
> \_app.config\['WEKO\_ACCOUNTS\_SHIB\_LOGIN\_ENABLED'\] = True
> 
> else:
> 
> \_app.config\['WEKO\_ACCOUNTS\_SHIB\_LOGIN\_ENABLED'\] = False

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### 制限公開

  - > 目的・用途

本機能は、制限公開に関する機能を設定し、利用報告督促メールを送付する機能である

  - > 利用方法

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 使用している画面：【Admin \> Setting \> Restricted Access画面】：制限公開に関する機能を設定し、利用報告督促メールを送付する画面である

１．シークレットURLのダウンロードについて設定する

  - 「シークレットURLダウンロード」(Secret URL Download)エリアに、機能有効化、有効期限日数とダウンロード回数を設定する
    
      - 設定内容は以下とする
        
          - 「機能有効化」（Enable）
            
              - 初期値はチェック無しとする
            
              - チェックありで保存されている場合、シークレットURLボタンの表示機能が有効となる。
            
              - チェックなしの場合、「有効期限日数」（Expiration Date）「ダウンロード回数」（Download Limit）の各項目はすべて非活性となる。（他の活性条件に優先する）
        
        <!-- end list -->
        
          - 「有効期限日数」（Expiration Date）
            
              - 「有効期限日数」（Expiration Date）テキストボックス
                
                  - 初期値は30日とする
                
                  - 1以上の整数を入力する制御とする。不正な値を入力する場合、「保存」（Save）ボタンを押すと、エラーメッセージが表示される  
                    エラーメッセージ：  
                    日本語：「{}は1以上の整数を設定する必要があります。」  
                    英語：「Must set a positive integer for {}. 」
            
              - 「無期限にする」(Unlimited)チェックボックス
                
                  - チェックを入れる場合、パラメータ値を9999999日に設定することとする
                
                  - チェックを入れると、「有効期限日数」（Expiration Date）テキストボックスが非活性とする
            
              - 各シークレットURLの有効期限はURL発行時点で設定される
            
              - 未設定かつ「無期限にする」チェックボックスをチェックしていない場合、「保存」（Save）ボタンを押すと、エラーメッセージが表示される  
                エラーメッセージ：  
                日本語：「{}を設定してください。」  
                英語：「Please set {}.」
        
          - 「ダウンロード回数」（Download Limit）
            
              - 「ダウンロード回数」（Download Limit）テキストボックス
                
                  - 初期値は10回とする
                
                  - 1以上の整数を入力する制御とする。不正な値を入力する場合、「保存」（Save）ボタンを押すと、エラーメッセージが表示される  
                    エラーメッセージ：  
                    日本語：「{}は1以上の整数を設定する必要があります。」  
                    英語：「Must set a positive integer for {}. 」
            
              - 「無期限にする」(Unlimited)チェックボックス
                
                  - チェックを入れる場合、パラメータ値を9999999日に設定することとする
                
                  - チェックを入れると、「ダウンロード回数」（Download Limit）テキストボックスが非活性とする
            
              - ダウンロードが途中で失敗した場合でも、1回のダウンロードとしてカウントする（サーバー側でダウンロードの成功有無は確認できないため）
            
              - 各シークレットURLのダウンロード回数はURL発行時点で設定される
            
              - 「保存」（Save）ボタンを押すと、設定内容を保存し、メッセージを表示する  
                メッセージ：  
                日本語：「制限公開の設定を変更しました。」  
                英語：「Restricted Access was successfully updated.」
            
              - 未設定かつ「無期限にする」チェックボックスをチェックしていない場合、「保存」（Save）ボタンを押すと、エラーメッセージが表示される  
                エラーメッセージ：  
                日本語：「{}を設定してください。」  
                英語：「Please set {}.」

２. コンテンツファイルのダウンロードについて設定する

  - 「コンテンツファイルのダウンロード」(Content File Download)エリアに、有効期限日数とダウンロード回数を設定する
    
      - 設定内容は以下とする
        
          - 「有効期限日数」（Expiration Date）
            
              - 「有効期限日数」（Expiration Date）テキストボックス
                
                  - 初期値は30日とする
                
                  - 1以上の整数を入力する制御とする。不正な値を入力する場合、「保存」（Save）ボタンを押すと、エラーメッセージが表示される  
                    エラーメッセージ：  
                    日本語：「{}は1以上の整数を設定する必要があります。」  
                    英語：「Must set a positive integer for {}. 」
            
              - 「無期限にする」(Unlimited)チェックボックス
                
                  - チェックを入れる場合、パラメータ値を9999999日に設定することとする
                
                  - チェックを入れると、「有効期限日数」（Expiration Date）テキストボックスが非活性とする
            
              - ダウンロードリンクの有効期限は承認者が承認した時点で設定されること
            
              - 未設定かつ「無期限にする」チェックボックスをチェックしていない場合、「保存」（Save）ボタンを押すと、エラーメッセージが表示される  
                エラーメッセージ：  
                日本語：「{}を設定してください。」  
                英語：「Please set {}.」
        
          - 「ダウンロード回数」（Download Limit）
            
              - 「ダウンロード回数」（Download Limit）テキストボックス
                
                  - 初期値は10回とする
                
                  - 1以上の整数を入力する制御とする。不正な値を入力する場合、「保存」（Save）ボタンを押すと、エラーメッセージが表示される  
                    エラーメッセージ：  
                    日本語：「{}は1以上の整数を設定する必要があります。」  
                    英語：「Must set a positive integer for {}. 」
            
              - 「無期限にする」(Unlimited)チェックボックス
                
                  - チェックを入れる場合、パラメータ値を9999999日に設定することとする
                
                  - チェックを入れると、「ダウンロード回数」（Download Limit）テキストボックスが非活性とする
            
              - ダウンロードが途中で失敗した場合でも、1回のダウンロードとしてカウントする（サーバー側でダウンロードの成功有無は確認できないため）
            
              - 「保存」（Save）ボタンを押すと、設定内容を保存し、メッセージを表示する  
                メッセージ：  
                日本語：「制限公開の設定を変更しました。」  
                英語：「Restricted Access was successfully updated.」
            
              - 未設定かつ「無期限にする」チェックボックスをチェックしていない場合、「保存」（Save）ボタンを押すと、エラーメッセージが表示される  
                エラーメッセージ：  
                日本語：「{}を設定してください。」  
                英語：「Please set {}.」

３. 利用報告ワークフローへのアクセスについて設定する

  - 「利用報告ワークフローへのアクセス」(Usage Report Workflow Access)エリアに、有効期限日数を設定する
    
      - 設定内容は以下とする
        
          - 「有効期限日数」（Expiration Date）テキストボックス
            
              - 初期値は500日とする
            
              - 1以上の整数を入力する制御とする。不正な値を入力する場合、「保存」（Save）ボタンを押すと、エラーメッセージが表示される  
                エラーメッセージ：  
                日本語：「{}は1以上の整数を設定する必要があります。」  
                英語：「Must set a positive integer for {}. 」
        
          - 「無期限にする」(Unlimited)チェックボックス
            
              - チェックを入れる場合、パラメータ値を9999999日に設定することとする
            
              - チェックを入れると、「有効期限日数」（Expiration Date）テキストボックスが非活性とする
        
          - 
          - 「保存」（Save）ボタンを押すと、設定内容を保存し、メッセージを表示する  
            メッセージ：  
            日本語：「制限公開の設定を変更しました。」  
            英語：「Restricted Access was successfully updated.」
        
          - 未設定かつ「無期限にする」チェックボックスをチェックしていない場合、「保存」（Save）ボタンを押すと、エラーメッセージが表示される  
            エラーメッセージ：  
            日本語：「{}を設定してください。」  
            英語：「Please set {}.」

４. 利用規約について設定する

  - 設定内容は以下の通りです。
    
      - 利用規約名一覧
        
          - 英語の利用規約名を表示する
        
          - 利用規約名の右端に「×」を設け、押下すると削除対象とする。削除は「保存」ボタン押下時に確定する
        
          - 末尾には「追加」（Add）を表示し、選択時は利用規約を新規登録する
    
      - 日本語利用規約名入力エリア
        
          - 日本語の利用規約名を設定するテキストボックス
        
          - アイテム登録時にWEKO3の表示言語設定が日本語の場合、選択肢として表示する項目
    
      - 日本語利用規約文言入力エリア
        
          - 登録する利用規約（日本語）の文言を入力するテキストエリア
        
          - 文字数上限は設けない
    
      - 英語利用規約名入力エリア
        
          - 英語の利用規約名を設定するテキストボックス。必須項目とする
        
          - アイテム登録時にWEKO3の表示言語設定が日本語以外の場合、選択肢として表示する項目
    
      - 英語利用規約文言入力エリア
        
          - 登録する利用規約（英語）の文言を入力するテキストエリア。必須項目とする
        
          - 文字数上限は設けない

  - 設定した後、「保存」（Save）ボタンを押すことで、設定している利用規約を利用規約名一覧に追加し、メッセージを表示する  
    メッセージ：  
    日本語：「制限公開の設定を変更しました。」  
    英語：「Restricted Access was successfully updated.」

  - 英語利用規約名、または英語利用規約文言を入力しない状態で、「保存」（Save）ボタンを押すと、エラーメッセージが表示される  
    エラーメッセージ：  
    日本語：「英語の利用規約を入力してください。」  
    英語：「Please input the Terms and Conditions in English.」

５. 利用報告督促メールを送付する

  - 「利用報告督促メール」（Usage Report Reminder Email）エリアには、利用報告督促メールの送信対象となるアクティビティの情報を一覧で表示する

  - 表示項目は以下の通りである
    
      - 一覧にはActivityの「No」「Activity」「Item」「Workflow」「Status」「User」を表示し、メール通知対象を選択するためのチェックボックスを設ける
    
      - 一覧の下に通知対象を確認させるため「確認」ボタンを設ける
    
      - 当該ボタンを押下するとモーダル画面開き、一覧でチェックボタンを選択した対象のみを表示す
    
      - 　 モーダル画面の「送信」ボタンを押下すると、メールが送信される。メールの送信が完了したらメッセージを表示する

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_admin

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - 設定内容をデータベースに保存する
    
      - テーブル：「admin\_settings」
    
      - フィールド：'name'="restricted\_access"  
        例：

> {"terms\_and\_conditions": \[{"key": "161699201191", "content": {"en": {"title": "Terms 1", "content": "Terms and Conditions Description"}, "ja": {"title": "利用規約1", "content": ""}}, "existed": true}\], "content\_file\_download": {"download\_limit": 10, "expiration\_date": 9999999, "download\_limit\_unlimited\_chk": false, "expiration\_date\_unlimited\_chk": true}, "usage\_report\_workflow\_access": {"expiration\_date\_access": 500, "expiration\_date\_access\_unlimited\_chk": false}}

  - > ゲストユーザーに対して、アクティビティ画面を表示する関数（"display\_guest\_activity"）には"record\_after\_update"変数を設定する

<!-- end list -->

  - > メール本文について

<!-- end list -->

  - メール名：利用申請WFの通知メール

> Subject: 利用申請登録のご案内／Register Application for Use
> 
> 【リポジトリ名（日本語）】です。
> 
> 下記のリンクにアクセスしていただき、利用申請の登録を行ってください。
> 
> 【ゲストユーザ向けの利用申請WFへのアクセスリンク】
> 
> このメールは自動送信されているので返信しないでください。
> 
> お問い合わせは下記までお願いします。また、このメールに心当たりのない方は、【リポジトリ名（日本語）】までご連絡ください。
> 
> 【リポジトリ名（日本語）】：【リポジトリURL】
> 
> 問い合わせ窓口：【リポジトリメールアドレス】
> 
> \----------------------------------------------------------------------------------
> 
> This is a message from 【リポジトリ名（英語）】.
> 
> Please access the link below and register your Application.
> 
> 【ゲストユーザ向けの利用申請WFへのアクセスリンク】
> 
> Please do not reply to this email as it has been sent automatically.
> 
> Please direct all inquiries to the following address.
> 
> Also, if you received this message in error, please notify 【リポジトリ名（英語）】.
> 
> 【リポジトリ名（英語）】：【URL】
> 
> E-mail：【リポジトリメールアドレス】

  - メール名：利用報告WFの通知メール

> Subject: 利用報告の登録のお願い／Request for register Data Usage Report
> 
> 【リポジトリ名（日本語）】です。
> 
> 下記で申請いただいデータについてダウンロードされたことを確認しました。
> 
> 申請番号：【申請番号】
> 
> 登録者名：【申請者名前】
> 
> メールアドレス：【申請者メールアドレス】
> 
> 所属機関：【申請者所属機関】
> 
> 研究題目：【研究題目】
> 
> 申請データ：【データ名】
> 
> 申請年月日：【申請年月日】
> 
> ダウンロードしたデータについて、下記のリンクから利用報告の登録をお願いします。
> 
> 【利用報告WFへのアクセスリンク】
> 
> このメールは自動送信されているので返信しないでください。
> 
> お問い合わせは下記までお願いします。また、このメールに心当たりのない方は、【リポジトリ名（日本語）】までご連絡ください。
> 
> 【リポジトリ名（日本語）】：【リポジトリURL】
> 
> 問い合わせ窓口：【リポジトリメールアドレス】
> 
> \----------------------------------------------------------------------------------
> 
> This is a message from 【リポジトリ名（英語）】.
> 
> We have confirmed that the dataset which you registered at below has been downloaded.
> 
> Application No.：【申請番号】
> 
> Name：【申請者名前】
> 
> E-mail：【メールアドレス】
> 
> Affiliation：【申請者所属機関】
> 
> Title of research：【研究題目】
> 
> Dataset requested ：【データ名】
> 
> Application date：【申請年月日】
> 
> For the downloaded data, please register the Data Usage Report by the link below.
> 
> 【利用報告WFへのアクセスリンク】
> 
> Please do not reply to this email as it has been sent automatically.
> 
> Please direct all inquiries to the following address.
> 
> Also, if you received this message in error, please notify 【リポジトリ名（英語）】.
> 
> 【リポジトリ名（英語）】：【URL】
> 
> E-mail：【リポジトリメールアドレス】

  - メール名：利用報告督促メール

> Subject: 利用報告の登録のお願い／Request for register Data Usage Report
> 
> 【リポジトリ名（日本語）】です。
> 
> 現時点で、下記の利用報告が登録されていません
> 
> 報告番号：【報告番号】
> 
> 登録者名：【報告-申請者名前】
> 
> メールアドレス：【報告-申請者メールアドレス】
> 
> 所属機関：【報告-申請者所属機関】
> 
> 利用データ：【報告-データ名】
> 
> データダウンロード日：【報告-WF起票日】
> 
> 下記のリンクから利用報告の登録をお願いします。
> 
> 【利用報告WFへのアクセスリンク】
> 
> このメールは自動送信されているので返信しないでください。
> 
> お問い合わせは下記までお願いします。また、このメールに心当たりのない方は、【リポジトリ名（日本語）】までご連絡ください。
> 
> 【リポジトリ名（日本語）】：【リポジトリURL】
> 
> 問い合わせ窓口：【リポジトリメールアドレス】
> 
> \----------------------------------------------------------------------------------
> 
> This is a message from 【リポジトリ名（英語）】.
> 
> At this time, the Data Usage Report below has not been registered.
> 
> Usage Report No.：【報告番号】
> 
> Name：【報告-申請者名前】
> 
> E-mail：【報告-申請者メールアドレス】
> 
> Affiliation：【報告-申請者所属機関】
> 
> Usage Dataset：【報告-データ名】
> 
> Download date：【報告-WF起票日】
> 
> Please register the Data Usage Report from the link below.
> 
> 【利用報告WFへのアクセスリンク】
> 
> Please do not reply to this email as it has been sent automatically.
> 
> Please direct all inquiries to the following address.
> 
> Also, if you received this message in error, please notify 【リポジトリ名（英語）】.
> 
> 【リポジトリ名（英語）】：【URL】
> 
> E-mail：【リポジトリメールアドレス】

埋め込み文字の整理

  - 【リポジトリ名（日本語）】：Admin\>Settings\>Site Info に設定されている日本語のSite Name

  - 【リポジトリ名（英語）】：Admin\>Setting\>Site Info に設定されている英語のSite Name

  - 【ゲストユーザ向けの利用申請WFへのアクセスリンク】： \#24088 で対応したテンポラリリンク

  - 【リポジトリURL】：「THEME\_SITEURL」 に設定されているURL

  - 【リポジトリメールアドレス】：Admin\>Setting\>Mail のDefault sender

  - 【申請番号】：対象となる利用申請のアクティビティID

  - 【申請者名前】：利用申請アイテムタイプ項目の申請者・名前の設定値

  - 【申請者メールアドレス】：利用申請アイテムタイプ項目の申請者・メールアドレスの設定値

  - 【申請者所属機関】：利用申請アイテムタイプ項目の申請者・所属機関の設定値

  - 【研究題目】：利用申請アイテムタイプ項目の研究題目の設定値

  - 【データ名】利用申請アイテムタイプ項目のデータ名の設定値

  - 【申請年月日】利用申請アイテムタイプ項目の申請日の設定値

  - 【ダウンロードリンク】： \#24088 で対応したテンポラリリンク

  - 【データのダウンロード期限日】：利用申請アイテムタイプ項目の承認日からAdmin\>Setting\>Restricted AccessのExpiration Date経過した日付

  - 【利用報告WFへのアクセスリンク】： \#24327 で対応したアクセスリンク

  - 【報告番号】：対象となる利用報告のアクティビティID

  - 【報告-申請者名前】：利用報告アイテムタイプ項目の申請者・名前の設定値

  - 【報告-申請者メールアドレス】：利用報告アイテムタイプ項目の申請者・メールアドレスの設定値

  - 【報告-申請者所属機関】：利用報告アイテムタイプ項目の申請者・所属機関の設定値

  - 【報告-データ名】：利用報告アイテムタイプ項目のデータ名の設定値

  - 【報告-WF起票日】：利用報告アイテムタイプ項目のWF起票日の設定値

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024/01/19</td>
<td><strong>8c312e8cb1db9c6479b86d1443a38720079838b0</strong></td>
<td>シークレットURL機能追加</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### その他

  - > 目的・用途

本機能は、その他の運用設定を設定する機能である

  - > 利用方法

【Administration \> Setting (設定) \> Others (その他)】において、機関名を入力し、【Save (保存)】を押下することで、GoogleScholar向けメタデータのひとつの「学位授与機関名」として入力した機関名を付与する。

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 【Administration \> Setting (設定)\> Others (その他) 画面】での「Institution Name」エリアに機関名を設定する  
    ※設定された機関名がGoogleScholar向けにアイテムメタデータとあわせて、「学位授与機関名」として出力される
    
      - デフォルト：空白
    
      - 「機関名」（Institution Name）テキストボックスに機関名を入力してから、「保存」（Save）ボタンを押すと、設定内容を保存し、メッセージを画面上部に表示する  
        メッセージ：「Institution Name was updated.」

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_records\_ui

<!-- end list -->

  - > 処理概要

> 機関名を入力し、【Save (保存)】を押下した際に、weko\_records\_ui.admin.InstitutionNameSettingが呼び出される。

  - > weko\_records\_ui.models.InstitutionName.set\_institution\_nameが呼び出され、  
    > 入力した機関名をinstitution\_nameテーブルに設定する。

> 「INSTITUTION\_NAME\_SETTING\_TEMPLATE」：weko\_records\_ui.config

  - > 'weko\_records\_ui/admin/institution\_name\_setting.html'

> Google Scholar向けメタデータの出力の際は、weko\_records\_ui.utils.get\_google\_scholar\_metaからweko\_records\_ui.models.InstitutionName.get\_institution\_nameを呼び出して  
> intitution\_nameテーブルから機関名を取得する。

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### Elasticsearchインデックス

<!-- end list -->

  - > 目的・用途

Elasticsearchのマッピング変更や検索設定の変更を反映するために、

管理画面からWEKOに登録されたアイテムの再インデックスを可能にする機能を提供する画面。

  - > 利用方法

管理画面の「メンテナンス機能」にある「Elasticsearchインデックス」メニューから、「アイテムインデックスの再作成」「アイテムの再インデックス」を実行できる。  
本機能の利用は、メンテナンス期間中に限られる。また、本機能にて万が一障害が発生した場合は、下記の方法での対応を想定している。

  - 障害原因の調査
    
      - 原因特定のためにまず確認すべきと想定される情報ソースを下記に記載します。
        
          - 画面上部の赤帯に記載のエラーメッセージ
        
          - ※同様のERRORがログに記載されているはずなので必須ではありませんが、原因特定にかかる時間を短縮できます
        
          - アプリケーションログ
        
          - Celery taskの実行ログ
        
          - ElasticSearchの起動状況
        
          - RabbitMQの起動状況
        
          - ElasticSearchのアイテムインデックス（\*-weko-item-\*）と本処理の一時保管用のインデックスElasticSearchのアイテムインデックス（\*-weko-item-\*-tmp）の、ドキュメント・Mappings・Settings・Aliasの情報

  - 障害原因の解消およびデータの修正
    
      - ケースバイケースとなるため、省略します。

  - 実行制御の解除
    
      - エラーが発生した際に、画面からの処理実行ができないように制御がされているので、これを下記の方法で解除します。
        
          - データベースのadmin\_settingsテーブルのelastic\_reindex\_settingsという名のレコードのsettingsが{"has\_errored": true}となっているため、これを{"has\_errored": false}に変更します。

<!-- end list -->

  - > 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - > 機能内容

<!-- end list -->

  - 「アイテムインデックスの再作成」の実行機能
    
      - マッピング・セッティング定義を初期状態にリセットして、現在のElasticSearchのアイテムインデックスをもとに再度ElasticSearchのアイテム・インデックスツリーの情報を作成しなおす機能。

  - 「アイテムの再インデックス」の実行機能
    
      - マッピング・セッティング定義を初期状態にリセットした後、DataBaseにある情報をもとにElasticSearchのアイテム・インデックスツリーの情報を作成しなおす機能。

  - 同時実行を制限する機能
    
      - 二重実行や、「アイテムインデックスの再作成」と「アイテムの再インデックス」の同時実行を防ぐ機能。

  - エラー発生時、再実行を禁止する機能
    
      - 障害原因の解消とデータメンテナンスが完了するまでは再実行禁止する運用前提。

  - 実行前に、処理に時間がかかる旨を確認する機能
    
      - 「アイテムインデックスの再作成」「アイテムの再インデックス」どちらの場合も確認を行う。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > weko\_admin

<!-- end list -->

  - > 処理概要

> 対応しているViewクラス：admin.py:: ReindexElasticSearchView
> 
> 「アイテムの再インデックス」でのDBからElasticSearchへ登録する機能は、既存実装を呼び出す形で行っている。レコードメタデータにある値をElasticSearchの検索フィールドにマッピングは、Signalから呼び出される処理を利用して達成している。
> 
> エラー発生の情報はDBで管理する

  - テーブル：「admin\_settings」

  - フィールド：'name'="elastic\_reindex\_settings"

例：

> {"has\_errored": false}

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### OAuth2

  - > 目的・用途

他のウェブアプリがweko3のリソースにアクセスできるようAPI利用を承認することを目的としている。

  - > 利用方法

API-8-5の機能を用いて、OAuthアプリケーション、またはトークンを登録する。その後、設定された値を利用してAPI接続の設定を行う。

  - > 機能内容

**OAuthアプリの登録**

  - 【アカウント(Account)\>Applications】画面にてOAuthアプリケーション、OAuthトークンを登録することができる。

  - 詳細は[USER-8-5 API設定](https://ivis.sharepoint.com/sites/NIIDMR646/Shared%20Documents/%5bWEKO3%5d10_開発/01.開発/2023/JAIRO%20Cloud（WEKO3）のドキュメント整備/機能設計書/マージ前/機能設計書_WebAPI_API-1-6.docx#_API設定)を参照すること

**Authorize URL (GET) /oauth/authorize**

Query parameters ( example request ):

  - response\_type (required, use code or token)

  - client\_id (required)

  - scope (required, space separate list of scopes)

  - redirect\_uri (required, URL encoded)

  - state (recommended, for CSRF protection)

URLの例：

Query parametersの値を以下とする。

  - response\_type : code

  - client\_id : CLIENTID

  - scope : deposit:write deposit:actions

  - redirect\_uri : http://localhost:5000/callback

  - state : CHANGEME

> そうしたときURLは以下のものとなる。
> 
> <https://「weko3>の接続先」/oauth/authorize? response\_type=code&
> 
> client\_id= CLIENTID\&scope=deposit%3Awrite+deposit%3Aactions&
> 
> state=CHANGEME\&redirect\_uri=http%3A%2F%2Flocalhost%3A5000%2Fcallback
> 
> /oauth/authorize…に接続した際、許可される内容について表示される。
> 
> 「Authorize application」ボタンを押下すると、codeとstateの値がサーバー側からクライアント側に渡される。

**Access token URL (POST) /oauth/token**

Request body parameters:

  - client\_id (required).

  - client\_secret (required).

  - grant\_type (required, use authorization\_code, refresh\_token, client\_credentials).

  - code (required for grant\_type authorization code).

  - state(recommended, for CSRF protection)

  - redirect\_uri(required for grant\_type authorization code)

  - scope (required for grant\_type client\_credentials).

  - refresh\_token (required for grant\_type refresh\_token).

Request（BaseHTTPRequestHandler）の例：

Authorize URL (GET)からcodeとstateを取得しているものとする。

Request body parametersを以下のものだとする。

  - client\_id : CLIENTID

  - client\_secret : SECRET

  - grant\_type : authorization\_code

  - code : CODECODE

  - state : CHANGEME

  - redirect\_uri: http://localhost:5000/callback

> この場合、以下のコードでアクセストークンを取得できる。
> 
> params = {'client\_id': 'CLIENTID', 'client\_secret': 'SECRET',
> 
> 'grant\_type': 'authorization\_code',
> 
> 'code': 'CODECODE', 'state':CHANGEME,
> 
> 'redirect\_uri':'http://localhost:5000/callback'}
> 
> accessurl = 'https://「weko3の接続先」/oauth/token'
> 
> request = requests.post(url=accessurl, data=params)

**アクセストークンの発行**

Personal access tokens の新規発行(/account/settings/applications/tokens/new/)からアクセストークンを発行することができる。

curlコマンドによるアクセストークン利用例

> curl -H 'Content-type: application/json' -XPOST -H 'Authorization: Bearer unGyWc31FNoAUOLm2AtMqJaDiqdJev6V6trTKEmRPBNAuMZ2lAKy4hcj7aLu' -k https://weko3.example.org:8443/api/indextree/create -d '{"parent\_id":"0","index\_info":{"index\_name":"index index","index\_name\_english":"index index english","public\_state":true}}'

**新しい Scope を追加する手順**

  - modules/weko-index-tree下にScopeを追加する手順を例とする。  
    （v0.9.22現在 以下のScopeは実装済みである。）

  - ソースコードを編集する操作なため、機能設計書の範疇ではないが、参考手順として残す。

  - モジュールにある scopes.py （ない場合は自分で作成する）に以下のように新規の scopes を追加する。

> **class** **IndexScope**(Scope):
> 
> """Basic index scope."""
> 
> **def** **\_\_init\_\_**(self, id\_, \*args, \*\*kwargs):
> 
> """Define the scope."""
> 
> **super**(IndexScope, self).\_\_init\_\_(
> 
> id\_='index:{0}'.format(id\_),
> 
> group='index', \*args, \*\*kwargs
> 
> )
> 
> create\_index\_scope = IndexScope('create',
> 
> help\_text=\_('Allow create.'))
> 
> """Allow create."""

  - モジュールの setup.py に以下のようにエントリポイントを追加する

> entry\_points={
> 
> ...
> 
> 'invenio\_oauth2server.scopes': \[
> 
> 'weko\_index\_tree\_create = weko\_index\_tree.scopes:create\_index\_scope',
> 
> \],
> 
> },

  - コードでは以下のように使う

> @blueprint\_api.route('/indextree/create', methods=\['POST'\])
> 
> @require\_api\_auth()
> 
> @require\_oauth\_scopes(create\_index\_scope.id)
> 
> **def** **create\_index**():
> 
> ...



```
csrf_token=`curl -X GET -k -L -s -c cookie.txt "https://dev.ir.rcos.nii.ac.jp/login"|xmllint -html --xpath "//input[@name='csrf_token']/@value" -|sed 's/"//g'|awk -F'=' '{print $2}'`
```

```
curl -X POST -k -s -c cookie.txt -b cookie.txt -F "csrf_token=${csrf_token}" -F "email=wekosoftware@nii.ac.jp" -F "password=uspass123" -F "next=/" "https://dev.ir.rcos.nii.ac.jp/login/" > /dev/null
```

```
$ curl -k -s -b cookie.txt -c cookie.txt -d -X POST -d "response_type=code" -d "client_id=QE77MZSrnljwDqp4lRxgfHal4M5II6K1JgtmIblA" -d "scope=deposit:write" -d "redirect_uri=http://127.0.0.1:8080/"  -d "confirm=yes" -d "state=teststate" "https://dev.ir.rcos.nii.ac.jp/oauth/authorize" -i | grep "Location:"
Location: http://127.0.0.1:8080/?code=B3SD4JqPNE6yjFnHWHe92NPW8VkPWD&state=teststate
```

```
$ curl -k -s -X POST -d "response_type=token" -d "client_id=QE77MZSrnljwDqp4lRxgfHal4M5II6K1JgtmIblA" -d "scope=deposit:write" -d "redirect_uri=http://127.0.0.1:8080/" "https://dev.ir.rcos.nii.ac.jp/oauth/authorize" -b cookie.txt -c cookie.txt -d "code=6LGWFTvaj1DJ4W5xjRHiRViiS2Qn4h" -d 'state=teststate' -i -d "confirm=yes" | grep "Location:"
Location: http://127.0.0.1:8080/#access_token=prhKYk6SEcRDiBfdRxp3G9Ocbk9UUM&expires_in=3600&token_type=Bearer&scope=deposit%3Awrite&state=teststate&user=%7B%27id%27%3A+%271%27%7D
```



```
$ curl -X GET -H "Authorization: Bearer prhKYk6SEcRDiBfdRxp3G9Ocbk9UUM" -k "https://dev.ir.rcos.nii.ac.jp/oauth/ping"
{
  "ping": "pong"
}
```


```
$ curl -k -s -X POST -d "grant_type=client_credentials" -d "client_id=QE77MZSrnljwDqp4lRxgfHal4M5II6K1JgtmIblA" -d "client_secret=TIHRA8RaBgxiBZ1s9gxj40watdjEcJDQFiINMIAQ15UqaoQGEMm0r1Cc0sMq" -d "scope=deposit:write" "https://dev.ir.rcos.nii.ac.jp/oauth/token" -b cookie.txt -c cookie.txt -d 'state=teststate' |jq .
{
  "access_token": "N1NHiEEDhC93Ysx7vuNJdmBdV34Wnm",
  "expires_in": 3600,
  "token_type": "Bearer",
  "scope": "deposit:write",
  "state": "teststate",
  "user": {
    "id": "1"
  }
}
```

curl -k -s -X POST -d "grant_type=authorization_code" -d "client_id=QE77MZSrnljwDqp4lRxgfHal4M5II6K1JgtmIblA" -d "client_secret=TIHRA8RaBgxiBZ1s9gxj40watdjEcJDQFiINMIAQ15UqaoQGEMm0r1Cc0sMq" -b cookie.txt -c cookie.txt -d 'state=teststate' -d "code=6LGWFTvaj1DJ4W5xjRHiRViiS2Qn4h" "https://dev.ir.rcos.nii.ac.jp/oauth/token"|jq .


authorization_response = 'https://localhost/callback?state=xxxxxxxx&code=xxxxxxxx'
url, headers, body = oauth.prepare_token_request('https://dev.ir.rcos.nii.ac.jp/oauth/token', authorization_response=authorization_response, client_secret=TIHRA8RaBgxiBZ1s9gxj40watdjEcJDQFiINMIAQ15UqaoQGEMm0r1Cc0sMq)

  - > 関連モジュール

> invenio\_oauth2server

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>
### OAI-PMH 

  - > 目的・用途

<!-- end list -->

  - > OAI-PMHとは、データベース内のメタデータを様々な指定をして受け渡すことを可能とするプロトコルである。OAI-PMHを用いることによって様々なスキーマでメタデータの提供を可能としている。利用方法

OAI-PMHのリクエストURLは以下のようになる。以下の「値」と「verbのパラメータ」に任意の値を指定することで、メタデータを取得することができる。指定できる値については後述。

https://\[host\]/oai?verb=「値」&「verbのパラメータ」=「値」&「 verbのパラメータ」=「値」&...

  - > 機能内容

<!-- end list -->

  - Verbに指定できる値は、以下の6種類となる。
    
      - GetRecord  
        リポジトリから個別のメタデータレコードを検索するためのverb。  
        追加で指定するパラメータは次の2つになる。  
        １．identifier：レコードの抽出元となるリポジトリのアイテムの固有識別子を指定する引数。必須項目。  
        ２．metadataPrefix：返却レコードのメタデータ部に含まれるフォーマットを指定する引数。必須項目。
        
          - 以下に応答例を示す。

\<OAI-PMH xmlns="http://www.openarchives.org/OAI/2.0/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.openarchives.org/OAI/2.0/ http://www.openarchives.org/OAI/2.0/OAI-PMH.xsd"\>

\<responseDate\>yyyy-mm-ddThh:mm:ssZ\</responseDate\>

\<request metadataPrefix="○○○○" verb="GetRecord" identifier="○○○○"\>https://\[host\]/oai\</request\>

\<GetRecord\>

\<record\>

\<header\>

\<identifier\>○○○○\</identifier\>

\<datestamp\>yyyy-mm-ddThh:mm:ssZ\</datestamp\>

\<setSpec\>○○○○\</setSpec\>

\</header\>

\<metadata\>

\<指定したアイテムのメタデータがここに記載される\>

\</metadata\>

\</record\>

\</GetRecord\>

\</OAI-PMH\>

  - Identify  
    リポジトリについての情報を検索する際に使用するverb。  
    追加で指定する引数はなし。
    
      - 以下に応答例を示す。

\<OAI-PMH xmlns="http://www.openarchives.org/OAI/2.0/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.openarchives.org/OAI/2.0/ http://www.openarchives.org/OAI/2.0/OAI-PMH.xsd"\>

\<responseDate\>yyyy-mm-ddThh:mm:ssZ\</responseDate\>

\<request verb="Identify"\>https://\[host\] /oai\</request\>

\<Identify\>

\<repositoryName\>○○○○\</repositoryName\>

\<adminEmail\>○○○○\</adminEmail\>

\<baseURL\>https://\[host\] /oai\</baseURL\>

\<protocolVersion\>2.0\</protocolVersion\>

\<earliestDatestamp\> yyyy-mm-ddThh:mm:ssZ \</earliestDatestamp\>

\<deletedRecord\>transient\</deletedRecord\>

\<granularity\>YYYY-MM-DDThh:mm:ssZ\</granularity\>

\</Identify\>

\</OAI-PMH\>

  - ListIdentifiers  
    任意の引数を指定し、ヘッダの検索する際に使用するverb。  
    追加で指定可能な引数は次の5つとなる。  
    １．from：UTCdatetimeの任意の引数。日付による選択的ハーベスティングの下限を設定する。  
    ２．until：UTCdatetimeの任意の引数。日付による選択的ハーベスティングの上限を設定する。  
    ３．metadataPrefix：返却レコードのメタデータ部に含まれるフォーマットを指定する引数。必須項目。  
    ４．set：Spec値を持つ任意の引数。選択的ハーベスティングを行う際のセットの基準を指定する。  
    ５. resumptionToken：リポジトリが応答する際に不完全リストとセットになっている要素。この要素を指定して検索を行うことで完全リストの検索を可能とする任意の引数。
    
      - 以下に応答例を示す。

\<OAI-PMH xmlns="http://www.openarchives.org/OAI/2.0/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.openarchives.org/OAI/2.0/ http://www.openarchives.org/OAI/2.0/OAI-PMH.xsd"\>

\<responseDate\>YYYY-MM-DDThh:mm:ssZ\</responseDate\>

\<request verb="ListIdentifiers" metadataPrefix="○○○○"\>https://\[host\]/oai\</request\>

\<ListIdentifiers\>

\<header\>

\<指定したヘッダの情報\>

\</header\>

\</ListIdentifiers\>

\</OAI-PMH\>

  - ListMetadataFormats  
    リポジトリから入手可能なメタデータフォーマットを検索する際に使用するverb。  
    指定可能な引数を以下に示す。  
    identifier：アイテムに利用可能なメタデータフォーマットが要求されている場合に、そのアイテムの固有識別子を指定する任意の引数。
    
      - 以下に応答例を示す。

\<OAI-PMH xmlns="http://www.openarchives.org/OAI/2.0/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.openarchives.org/OAI/2.0/ http://www.openarchives.org/OAI/2.0/OAI-PMH.xsd"\>

\<responseDate\>YYYY-MM-DDThh:mm:ssZ\</responseDate\>

\<ListMetadataFormats\>

\<metadataFormat\>

\<metadataPrefix\>jpcoar\</metadataPrefix\>

\<schema\>https://github.com/JPCOAR/schema/blob/master/2.0/jpcoar\_scm.xsd\</schema\>

\<metadataNamespace\>https://github.com/JPCOAR/schema/blob/master/2.0/\</metadataNamespace\>

\</metadataFormat\>

\<metadataFormat\>

\<metadataPrefix\>jpcoar\_1.0\</metadataPrefix\>

\<schema\>https://irdb.nii.ac.jp/schema/jpcoar/1.0/jpcoar\_scm.xsd\</schema\>

\<metadataNamespace\>https://irdb.nii.ac.jp/schema/jpcoar/1.0/\</metadataNamespace\>

\</metadataFormat\>

\<metadataFormat\>

\<metadataPrefix\>jpcoar\_2.0\</metadataPrefix\>

\<schema\>https://irdb.nii.ac.jp/schema/jpcoar/2.0/jpcoar\_scm.xsd\</schema\>

\<metadataNamespace\>https://irdb.nii.ac.jp/schema/jpcoar/2.0/\</metadataNamespace\>

\</metadataFormat\>

\<metadataFormat\>

\<metadataPrefix\>oai\_dc\</metadataPrefix\>

\<schema\>http://www.openarchives.org/OAI/2.0/oai\_dc/ http://www.openarchives.org/OAI/2.0/oai\_dc.xsd\</schema\>

\<metadataNamespace\>http://www.w3.org/2001/XMLSchema\</metadataNamespace\>

\</metadataFormat\>

\<metadataFormat\>

\<metadataPrefix\>ddi\</metadataPrefix\>

\<schema\>https://ddialliance.org/Specification/DDI-Codebook/2.5/XMLSchema/codebook.xsd\</schema\>

\<metadataNamespace\>ddi:codebook:2\_5\</metadataNamespace\>

\</metadataFormat\>

\<metadataFormat\>

\<metadataPrefix\>jpcoar\_v1\</metadataPrefix\>

\<schema\>https://github.com/JPCOAR/schema/blob/master/1.0/jpcoar\_scm.xsd\</schema\>

\<metadataNamespace\>https://github.com//schema/blob/master/1.0/\</metadataNamespace\>

\</metadataFormat\>

\<metadataFormat\>

\<metadataPrefix\>lom\</metadataPrefix\>

\<schema\>http://www.lido-schema.org http://www.lido-schema.org/schema/v1.0/lido-v1.0.xsd\</schema\>

\<metadataNamespace\>http://ltsc.ieee.org/xsd/LOM\</metadataNamespace\>

\</metadataFormat\>

\</ListMetadataFormats\>

\</OAI-PMH\>

  - ListRecord  
    リポジトリからレコードを収集する際に使用するverb。  
    追加で指定可能な引数は次の5つとなる。  
    １．from：UTCdatetimeの任意の引数。日付による選択的ハーベスティングの下限を設定する。  
    ２．until：UTCdatetimeの任意の引数。日付による選択的ハーベスティングの上限を設定する。  
    ３．metadataPrefix：返却レコードのメタデータ部に含まれるフォーマットを指定する引数。必須項目。  
    ４．set：Spec値を持つ任意の引数。選択的ハーベスティングを行う際のセットの基準を指定する。  
    ５. resumptionToken：リポジトリが応答する際に不完全リストとセットになっている要素。この要素を指定して検索を行うことで完全リストの検索を可能とする任意の引数。
    
      - 以下に応答例を示す。

> \<OAI-PMH xmlns="http://www.openarchives.org/OAI/2.0/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.openarchives.org/OAI/2.0/ http://www.openarchives.org/OAI/2.0/OAI-PMH.xsd"\>
> 
> \<responseDate\>YYYY-MM-DDThh:mm:ssZ\</responseDate\>
> 
> \<request verb="ListRecords" metadataPrefix="○○○○"\>https://\[host\]/oai\</request\>
> 
> \<ListRecords\>
> 
> \<record\>
> 
> \<header\>
> 
> \<指定したレコードの情報\>
> 
> \</header\>
> 
> \</record\>
> 
> \</ListRecords\>
> 
> \</OAI-PMH\>

  - ListSets  
    リポジトリのセット構成を検索する際に使用するverb。  
    使用可能となる引数は次のものである。  
    resumptionToken：リポジトリが応答する際に不完全リストとセットになっている要素。この要素を指定して検索を行うことで完全リストの検索を可能とする任意の引数。
    
      - 以下に応答例を示す。

> \<OAI-PMH xmlns="http://www.openarchives.org/OAI/2.0/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.openarchives.org/OAI/2.0/ http://www.openarchives.org/OAI/2.0/OAI-PMH.xsd"\>
> 
> \<responseDate\>YYYY-MM-DDThh:mm:ssZ\</responseDate\>
> 
> \<request verb="ListSets"\>https://\[host\]/oai\</request\>
> 
> \<ListSets\>
> 
> \<set\>
> 
> \<セット構成の情報\>
> 
> \</ListSets\>
> 
> \</OAI-PMH\>
> 
> \</OAI-PMH\>\</OAI-PMH\>

  - > リクエストに不備がある場合は以下のエラーのいずれかがOAI-PMH出力の本文内に記載される。
    
      - > badArgument：不正な引数があるか、必須となる引数がない場合。
    
      - > cannotDisseminateFormat：metadataPrefixの値がidentifierにより指定されたアイテムでサポートされていない場合。
    
      - > idDoesNotExist：リポジトリでidentiferの値が不明であるか、不正なものである場合。
    
      - > badResumptionToken：resumptionTokenの値が無効であるか期限切れである場合。
    
      - > noRecordsMatch：from、until、setの値を組み合わせると空のリストになる場合。
    
      - > noSetHierarchy：リポジトリがセットをサポートしていない場合。
    
      - > noMetadataFormats：指定したアイテムで利用可能なメタデータフォーマットではない場合。

<!-- end list -->

  - > 関連モジュール

<!-- end list -->

  - > Invenio\_oaiserver

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### OpenSearch

  - 目的・用途

アイテムの検索に利用できる。

  - 利用方法

以下の形のURLを使用して検索ができる

https://\[host\]/ api/opensearch/search?クエリパラメータ=値&クエリパラメータ値&...

<table>
<thead>
<tr class="header">
<th><strong>Method</strong></th>
<th><strong>HTTP request</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>weko_search_ui.<br />
views.opensearch_description</td>
<td><strong>GET /api/opensearch/description.xml</strong></td>
<td></td>
</tr>
<tr class="even">
<td>weko_search_ui.<br />
query.opensearch_factory※</td>
<td><strong>GET /api/opensearch/search</strong></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

※ modules/weko-search-ui/weko\_search\_ui/config.py のRECORDS\_REST\_ENDPOINTS\["opensearch"\]にて設定

クエリパラメータ

<table>
<thead>
<tr class="header">
<th><strong>GET /api/opensearch/search</strong></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>パラメータ</td>
<td>必須</td>
<td>値</td>
<td>説明</td>
</tr>
<tr class="even">
<td>format</td>
<td></td>
<td><ul>
<li><p>atom</p></li>
<li><p>rss</p></li>
<li><p>jpcoar</p></li>
</ul></td>
<td><p>レスポンス結果のフォーマット</p>
<p>デフォルトはjson形式。</p></td>
</tr>
<tr class="odd">
<td>size</td>
<td></td>
<td>int</td>
<td>レスポンスに含めるフィード件数</td>
</tr>
<tr class="even">
<td>page</td>
<td></td>
<td>Int</td>
<td>表示するページ番号</td>
</tr>
<tr class="odd">
<td>以下は設定ファイルやアイテムタイプマッピングにより定義が変化する</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>title</td>
<td></td>
<td>string</td>
<td>dc:titleにマッピングされた項目の検索</td>
</tr>
<tr class="odd">
<td>des</td>
<td></td>
<td>strin</td>
<td>datacite:descriptionにマッピングされた項目の検索</td>
</tr>
<tr class="even">
<td>type</td>
<td></td>
<td>string</td>
<td>dc:typeにマッピングされた項目の検索</td>
</tr>
<tr class="odd">
<td>wid</td>
<td></td>
<td>Int</td>
<td>アイテムIDを指定して検索</td>
</tr>
<tr class="even">
<td>Iid</td>
<td></td>
<td>Int</td>
<td>インデックスIDを指定して検索</td>
</tr>
</tbody>
</table>

レスポンス例：

<table>
<thead>
<tr class="header">
<th><strong>レスポンス例：format: atom</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>/api/opensearch/search?title=nooai&amp;format=atom&amp;size=1</strong></td>
</tr>
<tr class="even">
<td><p>&lt;feed xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opensearch="http://a9.com/-/spec/opensearch/1.1/" xmlns:prism="http://prismstandard.org/namespaces/basic/2.0/" xmlns="http://www.w3.org/2005/Atom" xml:lang="en"&gt;</p>
<p>&lt;id&gt;https://dev.ir.rcos.nii.ac.jp/api/opensearch/search?title=nooai&amp;amp;format=atom&amp;amp;size=1&lt;/id&gt;</p>
<p>&lt;title&gt;WEKO OpenSearch: &lt;/title&gt;</p>
<p>&lt;updated&gt;2023-11-14T23:47:46.452823+00:00&lt;/updated&gt;</p>
<p>&lt;link href="https://dev.ir.rcos.nii.ac.jp/api/opensearch/search?title=nooai&amp;amp;format=atom&amp;amp;size=1"/&gt;</p>
<p>&lt;generator uri="http://lkiesow.github.io/python-feedgen" version="0.7.0"&gt;python-feedgen&lt;/generator&gt;</p>
<p>&lt;opensearch:totalResults&gt;9&lt;/opensearch:totalResults&gt;</p>
<p>&lt;opensearch:startIndex&gt;1&lt;/opensearch:startIndex&gt;</p>
<p>&lt;opensearch:itemsPerPage&gt;1&lt;/opensearch:itemsPerPage&gt;</p>
<p>&lt;entry&gt;</p>
<p>&lt;id&gt;https://dev.ir.rcos.nii.ac.jp/oai?verb=GetRecord&amp;amp;metadataPrefix=jpcoar&amp;amp;identifier=oai:weko3.example.org:00000035&lt;/id&gt;</p>
<p>&lt;title&gt;public-item-2-public-nooai-guest-35-ja&lt;/title&gt;</p>
<p>&lt;updated&gt;2023-11-06T05:45:01.746520+00:00&lt;/updated&gt;</p>
<p>&lt;content xml:lang="ja"&gt;概要</p>
<p>概要</p>
<p>概要</p>
<p>概要&lt;/content&gt;</p>
<p>&lt;link href="https://dev.ir.rcos.nii.ac.jp/records/35"/&gt;</p>
<p>&lt;link href="https://dev.ir.rcos.nii.ac.jp/oai?verb=GetRecord&amp;amp;metadataPrefix=jpcoar&amp;amp;identifier=oai:weko3.example.org:00000035"/&gt;</p>
<p>&lt;dc:publisher xml:lang="en"&gt;Publisher&lt;/dc:publisher&gt;</p>
<p>&lt;dc:subject&gt;2-public-nooai-guest-35-ja&lt;/dc:subject&gt;</p>
<p>&lt;dc:type&gt;デフォルトアイテムタイプ（フル）&lt;/dc:type&gt;</p>
<p>&lt;dc:format&gt;text/plain&lt;/dc:format&gt;</p>
<p>&lt;dc:identifier&gt;35&lt;/dc:identifier&gt;</p>
<p>&lt;dc:identifier&gt;https://weko3.example.org/record/35/files/1KB.pdf&lt;/dc:identifier&gt;</p>
<p>&lt;prism:aggregationType&gt;conference paper&lt;/prism:aggregationType&gt;</p>
<p>&lt;prism:issn&gt;xxxx-xxxx-xxxx&lt;/prism:issn&gt;</p>
<p>&lt;prism:creationDate&gt;2023-11-06T05:44:59.220388+00:00&lt;/prism:creationDate&gt;</p>
<p>&lt;prism:modificationDate&gt;2023-11-06T05:45:01.746520+00:00&lt;/prism:modificationDate&gt;</p>
<p>&lt;/entry&gt;</p>
<p>&lt;/feed&gt;</p></td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th><strong>レスポンス例：format: rss</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>/api/opensearch/search?title=nooai&amp;format=rss&amp;size=1</strong></td>
</tr>
<tr class="even">
<td><p>&lt;?xml version='1.0' encoding='UTF-8'?&gt;</p>
<p>&lt;rdf:RDF xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opensearch="http://a9.com/-/spec/opensearch/1.1/" xmlns:prism="http://prismstandard.org/namespaces/basic/2.0/" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#" xmlns="http://purl.org/rss/1.0/" xml:lang="en"&gt;</p>
<p>&lt;channel rdf:about="https://dev.ir.rcos.nii.ac.jp/api/opensearch/search?title=nooai&amp;amp;format=rss&amp;amp;size=1"&gt;</p>
<p>&lt;title&gt;WEKO OpenSearch: &lt;/title&gt;</p>
<p>&lt;link&gt;https://dev.ir.rcos.nii.ac.jp/api/opensearch/search?title=nooai&amp;amp;format=rss&amp;amp;size=1&lt;/link&gt;</p>
<p>&lt;docs&gt;http://www.rssboard.org/rss-specification&lt;/docs&gt;</p>
<p>&lt;generator&gt;python-feedgen&lt;/generator&gt;</p>
<p>&lt;language&gt;en&lt;/language&gt;</p>
<p>&lt;items&gt;</p>
<p>&lt;rdf:Seq&gt;</p>
<p>&lt;rdf:li rdf:resource="https://dev.ir.rcos.nii.ac.jp/records/35"/&gt;</p>
<p>&lt;/rdf:Seq&gt;</p>
<p>&lt;/items&gt;</p>
<p>&lt;lastBuildDate&gt;Tue, 14 Nov 2023 23:48:47 +0000&lt;/lastBuildDate&gt;</p>
<p>&lt;dc:date&gt;2023-11-14 23:48:47.221230+00:00&lt;/dc:date&gt;</p>
<p>&lt;opensearch:totalResults&gt;9&lt;/opensearch:totalResults&gt;</p>
<p>&lt;opensearch:startIndex&gt;1&lt;/opensearch:startIndex&gt;</p>
<p>&lt;opensearch:itemsPerPage&gt;1&lt;/opensearch:itemsPerPage&gt;</p>
<p>&lt;/channel&gt;</p>
<p>&lt;item rdf:about="https://dev.ir.rcos.nii.ac.jp/records/35"&gt;</p>
<p>&lt;title&gt;public-item-2-public-nooai-guest-35-ja&lt;/title&gt;</p>
<p>&lt;link&gt;https://dev.ir.rcos.nii.ac.jp/records/35&lt;/link&gt;</p>
<p>&lt;rdfs:seeAlso rdf:resource="https://dev.ir.rcos.nii.ac.jp/oai?verb=GetRecord&amp;amp;metadataPrefix=jpcoar&amp;amp;identifier=oai:weko3.example.org:00000035"/&gt;</p>
<p>&lt;description&gt;概要</p>
<p>概要</p>
<p>概要</p>
<p>概要&lt;/description&gt;</p>
<p>&lt;dc:date&gt;2023-11-14 23:48:47.276148+00:00&lt;/dc:date&gt;</p>
<p>&lt;dc:publisher xml:lang="en"&gt;Publisher&lt;/dc:publisher&gt;</p>
<p>&lt;dc:subject&gt;2-public-nooai-guest-35-ja&lt;/dc:subject&gt;</p>
<p>&lt;dc:type&gt;デフォルトアイテムタイプ（フル）&lt;/dc:type&gt;</p>
<p>&lt;dc:format&gt;text/plain&lt;/dc:format&gt;</p>
<p>&lt;dc:identifier&gt;35&lt;/dc:identifier&gt;</p>
<p>&lt;dc:identifier&gt;https://weko3.example.org/record/35/files/1KB.pdf&lt;/dc:identifier&gt;</p>
<p>&lt;prism:aggregationType&gt;conference paper&lt;/prism:aggregationType&gt;</p>
<p>&lt;prism:creationDate&gt;2023-11-06T05:44:59.220388+00:00&lt;/prism:creationDate&gt;</p>
<p>&lt;prism:modificationDate&gt;2023-11-06T05:45:01.746520+00:00&lt;/prism:modificationDate&gt;</p>
<p>&lt;prism:url&gt;https://dev.ir.rcos.nii.ac.jp/records/35&lt;/prism:url&gt;</p>
<p>&lt;/item&gt;</p>
<p>&lt;/rdf:RDF&gt;</p></td>
</tr>
</tbody>
</table>

<table>
<thead>
<tr class="header">
<th>レスポンス例：format: jpcoar</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>/api/opensearch/search?title=nooai&amp;format=jpcoar&amp;size=1</strong></td>
</tr>
<tr class="even">
<td><p>This XML file does not appear to have any style information associated with it. The document tree is shown below.</p>
<p>&lt;rdf:RDF xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opensearch="http://a9.com/-/spec/opensearch/1.1/" xmlns:prism="http://prismstandard.org/namespaces/basic/2.0/" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"&gt;</p>
<p>&lt;header&gt;</p>
<p>&lt;opensearch:totalResults&gt;9&lt;/opensearch:totalResults&gt;</p>
<p>&lt;opensearch:startIndex&gt;1&lt;/opensearch:startIndex&gt;</p>
<p>&lt;opensearch:itemsPerPage&gt;1&lt;/opensearch:itemsPerPage&gt;</p>
<p>&lt;/header&gt;</p>
<p>&lt;items&gt;</p>
<p>&lt;rdf:Description rdf:about="https://dev.ir.rcos.nii.ac.jp/records/35"&gt;</p>
<p>&lt;jpcoar:jpcoar xmlns:datacite="https://schema.datacite.org/meta/kernel-4/" xmlns:dcndl="http://ndl.go.jp/dcndl/terms/" xmlns:dcterms="http://purl.org/dc/terms/" xmlns:jpcoar="https://github.com/JPCOAR/schema/blob/master/2.0/" xmlns:oaire="http://namespace.openaire.eu/schema/oaire/" xmlns:rioxxterms="http://www.rioxx.net/schema/v2.0/rioxxterms/" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns="https://github.com/JPCOAR/schema/blob/master/2.0/" xsi:schemaLocation="https://github.com/JPCOAR/schema/blob/master/2.0/jpcoar_scm.xsd"&gt;</p>
<p>&lt;dc:title xml:lang="ja"&gt;public-item-2-public-nooai-guest-35-ja&lt;/dc:title&gt;</p>
<p>&lt;dc:title xml:lang="en"&gt;public-item-2-public-nooai-guest-35-en&lt;/dc:title&gt;</p>
<p>&lt;dcterms:alternative xml:lang="en"&gt;Alternative Title&lt;/dcterms:alternative&gt;</p>
<p>&lt;dcterms:alternative xml:lang="ja"&gt;Alternative Title&lt;/dcterms:alternative&gt;</p>
<p>&lt;jpcoar:creator&gt;</p>
<p>&lt;jpcoar:nameIdentifier nameIdentifierURI="https://orcid.org/" nameIdentifierScheme="ORCID"&gt;xxxxxxx&lt;/jpcoar:nameIdentifier&gt;</p>
<p>&lt;jpcoar:creatorName xml:lang="ja"&gt;情報, 太郎&lt;/jpcoar:creatorName&gt;</p>
<p>&lt;jpcoar:creatorName xml:lang="ja-Kana"&gt;ジョウホウ タロウ&lt;/jpcoar:creatorName&gt;</p>
<p>&lt;jpcoar:creatorName xml:lang="en"&gt;Joho Taro&lt;/jpcoar:creatorName&gt;</p>
<p>&lt;jpcoar:familyName xml:lang="ja"&gt;情報&lt;/jpcoar:familyName&gt;</p>
<p>&lt;jpcoar:familyName xml:lang="ja-Kana"&gt;ジョウホウ&lt;/jpcoar:familyName&gt;</p>
<p>&lt;jpcoar:familyName xml:lang="en"&gt;Joho&lt;/jpcoar:familyName&gt;</p>
<p>&lt;jpcoar:givenName xml:lang="ja"&gt;太郎&lt;/jpcoar:givenName&gt;</p>
<p>&lt;jpcoar:givenName xml:lang="ja-Kana"&gt;タロウ&lt;/jpcoar:givenName&gt;</p>
<p>&lt;jpcoar:givenName xml:lang="en"&gt;Taro&lt;/jpcoar:givenName&gt;</p>
<p>&lt;jpcoar:affiliation&gt;</p>
<p>&lt;jpcoar:nameIdentifier nameIdentifierURI="http://isni.org/isni/0000000121691048" nameIdentifierScheme="ISNI"&gt;0000000121691048&lt;/jpcoar:nameIdentifier&gt;</p>
<p>&lt;jpcoar:affiliationName xml:lang="en"&gt;University&lt;/jpcoar:affiliationName&gt;</p>
<p>&lt;/jpcoar:affiliation&gt;</p>
<p>&lt;/jpcoar:creator&gt;</p>
<p>&lt;jpcoar:creator&gt;</p>
<p>&lt;jpcoar:nameIdentifier nameIdentifierURI="https://orcid.org/" nameIdentifierScheme="ORCID"&gt;xxxxxxx&lt;/jpcoar:nameIdentifier&gt;</p>
<p>&lt;jpcoar:creatorName xml:lang="ja"&gt;情報, 太郎&lt;/jpcoar:creatorName&gt;</p>
<p>&lt;jpcoar:creatorName xml:lang="ja-Kana"&gt;ジョウホウ タロウ&lt;/jpcoar:creatorName&gt;</p>
<p>&lt;jpcoar:creatorName xml:lang="en"&gt;Joho Taro&lt;/jpcoar:creatorName&gt;</p>
<p>&lt;jpcoar:familyName xml:lang="ja"&gt;情報&lt;/jpcoar:familyName&gt;</p>
<p>&lt;jpcoar:familyName xml:lang="ja-Kana"&gt;ジョウホウ&lt;/jpcoar:familyName&gt;</p>
<p>&lt;jpcoar:familyName xml:lang="en"&gt;Joho&lt;/jpcoar:familyName&gt;</p>
<p>&lt;jpcoar:givenName xml:lang="ja"&gt;太郎&lt;/jpcoar:givenName&gt;</p>
<p>&lt;jpcoar:givenName xml:lang="ja-Kana"&gt;タロウ&lt;/jpcoar:givenName&gt;</p>
<p>&lt;jpcoar:givenName xml:lang="en"&gt;Taro&lt;/jpcoar:givenName&gt;</p>
<p>&lt;/jpcoar:creator&gt;</p>
<p>&lt;jpcoar:creator&gt;</p>
<p>&lt;jpcoar:nameIdentifier nameIdentifierURI="https://orcid.org/" nameIdentifierScheme="ORCID"&gt;xxxxxxx&lt;/jpcoar:nameIdentifier&gt;</p>
<p>&lt;jpcoar:creatorName xml:lang="ja"&gt;情報, 太郎&lt;/jpcoar:creatorName&gt;</p>
<p>&lt;jpcoar:creatorName xml:lang="ja-Kana"&gt;ジョウホウ タロウ&lt;/jpcoar:creatorName&gt;</p>
<p>&lt;jpcoar:creatorName xml:lang="en"&gt;Joho Taro&lt;/jpcoar:creatorName&gt;</p>
<p>&lt;jpcoar:familyName xml:lang="ja"&gt;情報&lt;/jpcoar:familyName&gt;</p>
<p>&lt;jpcoar:familyName xml:lang="ja-Kana"&gt;ジョウホウ&lt;/jpcoar:familyName&gt;</p>
<p>&lt;jpcoar:familyName xml:lang="en"&gt;Joho&lt;/jpcoar:familyName&gt;</p>
<p>&lt;jpcoar:givenName xml:lang="ja"&gt;太郎&lt;/jpcoar:givenName&gt;</p>
<p>&lt;jpcoar:givenName xml:lang="ja-Kana"&gt;タロウ&lt;/jpcoar:givenName&gt;</p>
<p>&lt;jpcoar:givenName xml:lang="en"&gt;Taro&lt;/jpcoar:givenName&gt;</p>
<p>&lt;/jpcoar:creator&gt;</p>
<p>&lt;jpcoar:contributor contributorType="ContactPerson"&gt;</p>
<p>&lt;jpcoar:nameIdentifier nameIdentifierURI="https://orcid.org/" nameIdentifierScheme="ORCID"&gt;xxxxxxx&lt;/jpcoar:nameIdentifier&gt;</p>
<p>&lt;jpcoar:contributorName xml:lang="ja"&gt;情報, 太郎&lt;/jpcoar:contributorName&gt;</p>
<p>&lt;jpcoar:contributorName xml:lang="ja-Kana"&gt;ジョウホウ タロウ&lt;/jpcoar:contributorName&gt;</p>
<p>&lt;jpcoar:contributorName xml:lang="en"&gt;Joho Taro&lt;/jpcoar:contributorName&gt;</p>
<p>&lt;jpcoar:familyName xml:lang="ja"&gt;情報&lt;/jpcoar:familyName&gt;</p>
<p>&lt;jpcoar:familyName xml:lang="ja-Kana"&gt;ジョウホウ&lt;/jpcoar:familyName&gt;</p>
<p>&lt;jpcoar:familyName xml:lang="en"&gt;Joho&lt;/jpcoar:familyName&gt;</p>
<p>&lt;jpcoar:givenName xml:lang="ja"&gt;太郎&lt;/jpcoar:givenName&gt;</p>
<p>&lt;jpcoar:givenName xml:lang="ja-Kana"&gt;タロウ&lt;/jpcoar:givenName&gt;</p>
<p>&lt;jpcoar:givenName xml:lang="en"&gt;Taro&lt;/jpcoar:givenName&gt;</p>
<p>&lt;/jpcoar:contributor&gt;</p>
<p>&lt;dcterms:accessRights rdf:resource="http://purl.org/coar/access_right/c_abf2"&gt;open access&lt;/dcterms:accessRights&gt;</p>
<p>&lt;dc:rights xml:lang="ja" rdf:resource="http://localhost"&gt;Rights Information&lt;/dc:rights&gt;</p>
<p>&lt;jpcoar:rightsHolder&gt;</p>
<p>&lt;jpcoar:nameIdentifier nameIdentifierURI="https://orcid.org/" nameIdentifierScheme="ORCID"&gt;xxxxxx&lt;/jpcoar:nameIdentifier&gt;</p>
<p>&lt;jpcoar:rightsHolderName xml:lang="ja"&gt;Right Holder Name&lt;/jpcoar:rightsHolderName&gt;</p>
<p>&lt;/jpcoar:rightsHolder&gt;</p>
<p>&lt;jpcoar:subject xml:lang="ja" subjectURI="http://localhost/" subjectScheme="Other"&gt;Sibject1&lt;/jpcoar:subject&gt;</p>
<p>&lt;datacite:description xml:lang="en" descriptionType="Abstract"&gt;Description Description Description&lt;/datacite:description&gt;</p>
<p>&lt;datacite:description xml:lang="ja" descriptionType="Abstract"&gt;概要 概要 概要 概要&lt;/datacite:description&gt;</p>
<p>&lt;dc:publisher xml:lang="en"&gt;Publisher&lt;/dc:publisher&gt;</p>
<p>&lt;datacite:date dateType="Available"&gt;2021-06-30&lt;/datacite:date&gt;</p>
<p>&lt;dc:language&gt;jpn&lt;/dc:language&gt;</p>
<p>&lt;dc:type rdf:resource="http://purl.org/coar/resource_type/c_5794"&gt;conference paper&lt;/dc:type&gt;</p>
<p>&lt;datacite:version&gt;Version&lt;/datacite:version&gt;</p>
<p>&lt;oaire:version rdf:resource="http://purl.org/coar/version/c_b1a7d7d4d402bcce"&gt;AO&lt;/oaire:version&gt;</p>
<p>&lt;jpcoar:identifier identifierType="URI"&gt;http://localhost&lt;/jpcoar:identifier&gt;</p>
<p>&lt;jpcoar:relation relationType="isVersionOf"&gt;</p>
<p>&lt;jpcoar:relatedIdentifier identifierType="arXiv"&gt;xxxxx&lt;/jpcoar:relatedIdentifier&gt;</p>
<p>&lt;jpcoar:relatedTitle xml:lang="en"&gt;Related Title&lt;/jpcoar:relatedTitle&gt;</p>
<p>&lt;/jpcoar:relation&gt;</p>
<p>&lt;dcterms:temporal xml:lang="en"&gt;Temporal&lt;/dcterms:temporal&gt;</p>
<p>&lt;datacite:geoLocation&gt;</p>
<p>&lt;datacite:geoLocationPlace&gt;Japan&lt;/datacite:geoLocationPlace&gt;</p>
<p>&lt;/datacite:geoLocation&gt;</p>
<p>&lt;jpcoar:fundingReference&gt;</p>
<p>&lt;jpcoar:funderIdentifier funderIdentifierType="ISNI"&gt;http://xxx&lt;/jpcoar:funderIdentifier&gt;</p>
<p>&lt;jpcoar:funderName xml:lang="en"&gt;Funder Name&lt;/jpcoar:funderName&gt;</p>
<p>&lt;jpcoar:awardNumber awardURI="Award URI"&gt;Award Number&lt;/jpcoar:awardNumber&gt;</p>
<p>&lt;jpcoar:awardTitle xml:lang="en"&gt;Award Title&lt;/jpcoar:awardTitle&gt;</p>
<p>&lt;/jpcoar:fundingReference&gt;</p>
<p>&lt;jpcoar:sourceIdentifier identifierType="ISSN"&gt;xxxx-xxxx-xxxx&lt;/jpcoar:sourceIdentifier&gt;</p>
<p>&lt;jpcoar:sourceTitle xml:lang="en"&gt;Source Title&lt;/jpcoar:sourceTitle&gt;</p>
<p>&lt;jpcoar:volume&gt;1&lt;/jpcoar:volume&gt;</p>
<p>&lt;jpcoar:issue&gt;111&lt;/jpcoar:issue&gt;</p>
<p>&lt;jpcoar:numPages&gt;12&lt;/jpcoar:numPages&gt;</p>
<p>&lt;jpcoar:pageStart&gt;1&lt;/jpcoar:pageStart&gt;</p>
<p>&lt;jpcoar:pageEnd&gt;3&lt;/jpcoar:pageEnd&gt;</p>
<p>&lt;dcndl:degreeName xml:lang="en"&gt;Degree Name&lt;/dcndl:degreeName&gt;</p>
<p>&lt;dcndl:dateGranted&gt;2021-06-30&lt;/dcndl:dateGranted&gt;</p>
<p>&lt;jpcoar:degreeGrantor&gt;</p>
<p>&lt;jpcoar:nameIdentifier nameIdentifierScheme="kakenhi"&gt;xxxxxx&lt;/jpcoar:nameIdentifier&gt;</p>
<p>&lt;jpcoar:degreeGrantorName xml:lang="en"&gt;Degree Grantor Name&lt;/jpcoar:degreeGrantorName&gt;</p>
<p>&lt;/jpcoar:degreeGrantor&gt;</p>
<p>&lt;jpcoar:conference&gt;</p>
<p>&lt;jpcoar:conferenceName xml:lang="ja"&gt;Conference Name&lt;/jpcoar:conferenceName&gt;</p>
<p>&lt;jpcoar:conferenceSequence&gt;1&lt;/jpcoar:conferenceSequence&gt;</p>
<p>&lt;jpcoar:conferenceSponsor xml:lang="ja"&gt;Sponsor&lt;/jpcoar:conferenceSponsor&gt;</p>
<p>&lt;jpcoar:conferenceDate endDay="1" endYear="2020" endMonth="12" startDay="1" xml:lang="ja" startYear="2000" startMonth="12"&gt;2020/12/11&lt;/jpcoar:conferenceDate&gt;</p>
<p>&lt;jpcoar:conferenceVenue xml:lang="ja"&gt;Conference Venue&lt;/jpcoar:conferenceVenue&gt;</p>
<p>&lt;jpcoar:conferenceCountry&gt;JPN&lt;/jpcoar:conferenceCountry&gt;</p>
<p>&lt;/jpcoar:conference&gt;</p>
<p>&lt;jpcoar:file&gt;</p>
<p>&lt;jpcoar:URI&gt;https://weko3.example.org/record/35/files/1KB.pdf&lt;/jpcoar:URI&gt;</p>
<p>&lt;jpcoar:mimeType&gt;text/plain&lt;/jpcoar:mimeType&gt;</p>
<p>&lt;jpcoar:extent&gt;1 KB&lt;/jpcoar:extent&gt;</p>
<p>&lt;/jpcoar:file&gt;</p>
<p>&lt;system_file/&gt;</p>
<p>&lt;/jpcoar:jpcoar&gt;</p>
<p>&lt;/rdf:Description&gt;</p>
<p>&lt;/items&gt;</p>
<p>&lt;/rdf:RDF&gt;</p></td>
</tr>
</tbody>
</table>

  - 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
</tr>
</tbody>
</table>

  - 機能内容

**Opensearch API記述（opensearch/description.xml)　2022/10/28 opensearch api の description.xml は修正の必要性がある。**

  - /api/opensearch/description.xml

> 例：
> 
> **\<OpenSearchDescription** xmlns="http://a9.com/-/spec/opensearch/1.1/"**\>**
> 
> **\<ShortName\>**WEKO**\</ShortName\>**
> 
> **\<Description\>**WEKO - NII Scholarly and Academic Information Navigator**\</Description\>**
> 
> **\<Image** height="16" type="image/x-icon" width="16"**\>**https://localhost:8443/static/favicon.ico**\</Image\>**
> 
> **\<Url** template="https://localhost:8443/api/opensearch/search?q={searchTerms}" type="application/atom+xml"**/\>**
> 
> **\<Url** template="https://localhost:8443/api/opensearch/search?q={searchTerms}**\&amp;**format=atom" type="application/atom+xml"**/\>**
> 
> **\</OpenSearchDescription\>**

**/api/opensearch/search**

クエリパラメータ

  - 利用できるクエリパラメータは以下を参照
    
      - パス：https://github.com/RCOSDP/weko/blob/adbdfd55ce1d9a289e1dd0af8e4383663f6eddaf/modules/weko-search-ui/weko\_search\_ui/config.py\#L245
    
      - 設定キー：WEKO\_SEARCH\_KEYWORDS\_DICT

レスポンス

**format:rss**

> \<?xml version='1.0' encoding='UTF-8'?\>
> 
> \<rdf:RDF xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opensearch="http://a9.com/-/spec/opensearch/1.1/" xmlns:prism="http://prismstandard.org/namespaces/basic/2.0/" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns\#" xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema\#" xmlns="http://purl.org/rss/1.0/" xml:lang="en"\>
> 
> \<channel rdf:about="https://weko3.ir.rcos.nii.ac.jp/api/opensearch/search?format=rss\&amp;title=アブ\&amp;list\_view\_num=1"\>
> 
> \<title\>WEKO OpenSearch: \</title\>
> 
> \<link\>https://weko3.ir.rcos.nii.ac.jp/api/opensearch/search?format=rss\&amp;title=アブ\&amp;list\_view\_num=1\</link\>
> 
> \<docs\>http://www.rssboard.org/rss-specification\</docs\>
> 
> \<generator\>python-feedgen\</generator\>
> 
> \<language\>en\</language\>
> 
> \<items\>
> 
> \<rdf:Seq\>
> 
> \<rdf:li rdf:resource="https://weko3.ir.rcos.nii.ac.jp/records/88854"/\>
> 
> \</rdf:Seq\>
> 
> \</items\>
> 
> \<lastBuildDate\>Fri, 28 Oct 2022 05:22:20 +0000\</lastBuildDate\>
> 
> \<dc:date\>2022-10-28 05:22:20.844292+00:00\</dc:date\>
> 
> \<opensearch:totalResults\>8\</opensearch:totalResults\>
> 
> \<opensearch:startIndex\>1\</opensearch:startIndex\>
> 
> \<opensearch:itemsPerPage\>1\</opensearch:itemsPerPage\>
> 
> \</channel\>
> 
> \<item rdf:about="https://weko3.ir.rcos.nii.ac.jp/records/88854"\>
> 
> \<title\>宮古島のピンザアブ洞の後期更新世堆積物より発見されたヘビ類化石の分類学的帰属とその歴史生物地理学的意義\</title\>
> 
> \<link\>https://weko3.ir.rcos.nii.ac.jp/records/88854\</link\>
> 
> \<rdfs:seeAlso rdf:resource="https://weko3.ir.rcos.nii.ac.jp/oai?verb=GetRecord\&amp;metadataPrefix=jpcoar\&amp;identifier=oai:weko3.ir.rcos.nii.ac.jp:00088854"/\>
> 
> \<dc:date\>2022-10-28 05:22:20.856008+00:00\</dc:date\>
> 
> \<dc:publisher xml:lang="ja"\>琉球大学21世紀プログラム\</dc:publisher\>
> 
> \<dc:subject\>ja\_Index B-5-1\</dc:subject\>
> 
> \<dc:type\>Multiple\</dc:type\>
> 
> \<dc:identifier\>88854\</dc:identifier\>
> 
> \<dc:identifier\>https://u-ryukyu.repo.nii.ac.jp/record/2001096/files/2006PS-22.pdf\</dc:identifier\>
> 
> \<prism:aggregationType\>research report\</prism:aggregationType\>
> 
> \<prism:publicationName\>琉球大学21世紀プログラム「サンゴ礁島嶼系の生物多様性の総合解析」平成18年度成果発表会\</prism:publicationName\>
> 
> \<prism:creationDate\>2022-03-22T05:56:28.569325+00:00\</prism:creationDate\>
> 
> \<prism:modificationDate\>2022-03-22T05:56:29.259651+00:00\</prism:modificationDate\>
> 
> \<prism:url\>https://weko3.ir.rcos.nii.ac.jp/records/88854\</prism:url\>
> 
> \</item\>
> 
> \</rdf:RDF\>

**format:atom**

> \<?xml version='1.0' encoding='UTF-8'?\>
> 
> \<feed xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:opensearch="http://a9.com/-/spec/opensearch/1.1/" xmlns:prism="http://prismstandard.org/namespaces/basic/2.0/" xmlns="http://www.w3.org/2005/Atom" xml:lang="en"\>
> 
> \<id\>https://weko3.ir.rcos.nii.ac.jp/api/opensearch/search?format=atom\&amp;title=アブ\&amp;list\_view\_num=1\</id\>
> 
> \<title\>WEKO OpenSearch: \</title\>
> 
> \<updated\>2022-10-28T05:15:02.121033+00:00\</updated\>
> 
> \<link href="https://weko3.ir.rcos.nii.ac.jp/api/opensearch/search?format=atom\&amp;title=アブ\&amp;list\_view\_num=1"/\>
> 
> \<generator uri="http://lkiesow.github.io/python-feedgen" version="0.7.0"\>python-feedgen\</generator\>
> 
> \<opensearch:totalResults\>8\</opensearch:totalResults\>
> 
> \<opensearch:startIndex\>1\</opensearch:startIndex\>
> 
> \<opensearch:itemsPerPage\>1\</opensearch:itemsPerPage\>
> 
> \<entry\>
> 
> \<id\>https://weko3.ir.rcos.nii.ac.jp/oai?verb=GetRecord\&amp;metadataPrefix=jpcoar\&amp;identifier=oai:weko3.ir.rcos.nii.ac.jp:00088854\</id\>
> 
> \<title\>宮古島のピンザアブ洞の後期更新世堆積物より発見されたヘビ類化石の分類学的帰属とその歴史生物地理学的意義\</title\>
> 
> \<updated\>2022-03-22T05:56:29.259651+00:00\</updated\>
> 
> \<link href="https://weko3.ir.rcos.nii.ac.jp/records/88854"/\>
> 
> \<link href="https://weko3.ir.rcos.nii.ac.jp/oai?verb=GetRecord\&amp;metadataPrefix=jpcoar\&amp;identifier=oai:weko3.ir.rcos.nii.ac.jp:00088854"/\>
> 
> \<dc:publisher xml:lang="ja"\>琉球大学21世紀プログラム\</dc:publisher\>
> 
> \<dc:subject\>ja\_Index B-5-1\</dc:subject\>
> 
> \<dc:type\>Multiple\</dc:type\>
> 
> \<dc:identifier\>88854\</dc:identifier\>
> 
> \<dc:identifier\>https://u-ryukyu.repo.nii.ac.jp/record/2001096/files/2006PS-22.pdf\</dc:identifier\>
> 
> \<prism:aggregationType\>research report\</prism:aggregationType\>
> 
> \<prism:publicationName\>琉球大学21世紀プログラム「サンゴ礁島嶼系の生物多様性の総合解析」平成18年度成果発表会\</prism:publicationName\>
> 
> \<prism:creationDate\>2022-03-22T05:56:28.569325+00:00\</prism:creationDate\>
> 
> \<prism:modificationDate\>2022-03-22T05:56:29.259651+00:00\</prism:modificationDate\>
> 
> \</entry\>
> 
> \</feed\>

  - 
設定

> \# Opensearch description
> 
> WEKO\_OPENSEARCH\_SYSTEM\_SHORTNAME = 'WEKO'
> 
> WEKO\_OPENSEARCH\_SYSTEM\_DESCRIPTION = 'WEKO - NII Scholarly and Academic Information Navigator'
> 
> WEKO\_OPENSEARCH\_IMAGE\_URL = 'static/favicon.ico'

  - > 関連モジュール

<!-- end list -->

  - invenio\_records\_rest：検索を行いその結果を返すモジュール

  - weko\_records：返却値を作成するモジュール

  - weko\_search\_ui：OpenSearch Descriptionファイルを定義するモジュール

<!-- end list -->

  - > 処理概要

<!-- end list -->

  - パラメータの追加
    
      - modules/invenio-records-rest/invenio\_records\_rest/views.py

  - format変換：
    
      - modules/invenio-records-rest/invenio\_records\_rest/serializers/json.py
    
      - weko\_search\_ui/views.py
        
          - <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-search-ui/weko_search_ui/views.py#L310>

<!-- end list -->

  - weko\_search\_ui.views. opensearch\_description関数でOpenSearch Descriptionファイルを作成している
    
      - > invenio\_records\_rest.views.RecordsListResource.getメソッドで検索を行う
    
    <!-- end list -->
    
      - 検索自体は、ユーザ画面の詳細検索と同様にElasticSearchで行う
    
      - RecordsListResourceクラスはWEKOのソースにforkされていないinvenio\_rest.views. ContentNegotiatedMethodViewクラスのサブクラスであり、スーパークラスのmake\_responseメソッドを使用してgetメソッドの返却値を作成する
    
      - make\_responseメソッドの中でシリアライザを呼び出す。これによってweko\_records.serializers.opensearchresponse.opensearch\_responsify関数が呼び出される
    
      - その中で呼び出すOpenSearchSerializer.serialize\_searchメソッドの中でformatを確認して、内容によって異なるレスポンス作成処理を呼び出す
        
          - formatの指定が「rss」「atom」「jpcoar」「それ以外」で分岐する
        
          - 「rss」「atom」の場合は、weko\_records.serializers.utils. OpenSearchDetailDataクラスのインスタンスをoutput\_type=（指定したformatを表す値）として作成して、output\_open\_search\_detail\_dataメソッドによってレスポンスを作成する
        
          - 「それ以外」の場合は、json形式のレスポンスを作成する

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/11/14</p>
</blockquote></td>
<td>V0.9.27</td>
<td></td>
</tr>
</tbody>
</table>
### Workflow API

  - 目的・用途

GakuNinRDMと連携してアイテムを登録する際に使用するAPIである

  - 利用方法

scopeに「user:activity」をもつアクセストークンを使用してAPIを呼び出す

<table>
<thead>
<tr class="header">
<th><strong>Method</strong></th>
<th><strong>HTTP request</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>ActivityActionResource.post</td>
<td><p>POST</p>
<p>/api/depositactivity</p></td>
<td>ワークフローを作成する</td>
</tr>
<tr class="even">
<td>ActivityActionResource.get</td>
<td><p>GET</p>
<p>/api/depositactivity/&lt;string:activity_id&gt;</p></td>
<td>アクティビティの状態を取得する</td>
</tr>
<tr class="odd">
<td>ActivityActionResource.delete</td>
<td><p>DELETE</p>
<p>/api/depositactivity/&lt;string:activity_id&gt;</p></td>
<td>アクティビティを中断する</td>
</tr>
</tbody>
</table>

curlによるGETのリクエスト例

|                                                                                     |
| ----------------------------------------------------------------------------------- |
| curl <https://ホスト/api/depositactivity/>アクティビティID -H "Authorization:Bearer アクセストークン" |

  - 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td></td>
</tr>
</tbody>
</table>

  - 機能内容

<!-- end list -->

  - 使用方法については、[その他-10: GakuNinRDM連携](#gakuninrdm連携)を参照

<!-- end list -->

  - 関連モジュール

<!-- end list -->

  - weko\_workflow

<!-- end list -->

  - 処理概要

<!-- end list -->

  - Scope:
    
      - /weko-workflow/weko\_workflow/scopes.py

  - API:
    
      - /weko-workflow/weko\_workflow/views.py

  - ActivityActionResourceクラスのメソッドで処理を行う

  - POSTの場合、フォームからの送信としてリクエストに以下の情報を含める必要がある
    
      - アイテムタイプID
    
      - ファイル

  - POST、GETの場合は、返却値はactivity\_informationメソッドで作成する

  - POSTでは、以下の場合にInvalidInputRESTErrorが発生する
    
      - アイテムタイプIDまたはファイルがリクエストに含まれない場合
    
      - ファイルの形式が不正だった場合
    
      - ファイルの内容が不正だった場合
    
      - アクティビティを作成または取得できなかった場合

  - GETでは、以下の場合にActivityBaseRESTErrorが発生する
    
      - ActivityBaseRESTError：
        
          - > アクティビティIDが指定されていない場合
    
      - ActivityNotFoundRESTError：
        
          - > 指定のアクティビティIDでアクティビティを取得できなかった場合

  - DELETEでは、以下の場合にエラーが発生する
    
      - ActivityBaseRESTError：
        
          - > アクティビティIDが指定されていない場合
    
      - RegisteredActivityNotFoundRESTError：
        
          - > 指定のアクティビティIDでアクティビティを取得できなかった場合
    
      - DeleteActivityFailedRESTError：
        
          - > 取得したアクティビティのactibity\_statusがdoingでない場合
        
          - > 強制終了に失敗した場合

  - エラー発生時にはloging\_errorメソッドを呼び出して、ログレベルをINFOとしてログを出力する

<!-- end list -->

  - 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### Index操作API

  - 目的・用途

新規インデックスを作成する際に使用するAPIである

  - 利用方法

Scopeに「index:create」をもつアクセストークンを使用してAPIを呼び出す

| **Method**    | **HTTP request**           | **Description** |
| ------------- | -------------------------- | --------------- |
| create\_index | POST /api/indextree/create |                 |

パラメータは以下の内容のjsonとする

| **Parameter name**                 | **Value** | **Description**       |
| ---------------------------------- | --------- | --------------------- |
| Path parameters                    |           |                       |
| parent\_id                         | 数値        | 親インデックスのID            |
| index\_info                        | json      | 必須。以下の項目のうち少なくとも1つが必要 |
| index\_info.index\_name            | 文字列       | 日本語のインデックス名           |
| index\_info.index\_name\_english   | 文字列       | 英語のインデックス名            |
| index\_info.comment                | 文字列       | コメント                  |
| index\_info.public\_state          | 真偽値       | 公開設定                  |
| index\_info.harvest\_public\_state | 真偽値       | ハーベスト公開設定             |

curlによるリクエスト例

|                                                                                                                                                                                                                                                                            |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| curl https://ホスト/api/indextree/create -H "Authorization:Bearer アクセストークン" -H "Content-Type: application/json" -d '{"parent\_id":"0","index\_info":{"index\_name":"APIテスト","index\_name\_english":"API test","comment":"コメント","public\_state":false,"public\_state":false}}' |

  - 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td></td>
</tr>
</tbody>
</table>

  - 機能内容

<!-- end list -->

  - 以下を指定してインデックスを新規作成する
    
      - 親インデックス

  - > 指定されなかった場合はRoot Index直下に作成される
    
      - 日本語のインデックス名
    
      - 英語のインデックス名

  - > 各インデックス名は、指定されなかった場合は「New Index」が設定される
    
      - コメント
    
      - 公開設定

  - > 指定されなかった場合は「False」が設定される
    
      - ハーベスト公開設定

  - > 指定されなかった場合は「True」が設定される

<!-- end list -->

  - 関連モジュール

<!-- end list -->

  - weko\_index\_tree

<!-- end list -->

  - 処理概要

<!-- end list -->

  - Scope:
    
      - weko- index-tree /weko\_ index\_tree /scopes.py

  - API:
    
      - modules/weko-index-tree/weko\_index\_tree/views.py

  - create\_index関数でindexテーブルに新規インデックスを作成する
    
      - 以下の情報を用いてインデックスを新規作成する

  - > id：作成時のUNIX時間を1000倍したものを用いる

  - > parent\_id：パラメータで指定されなかった場合には0を設定する

  - > index\_name：「New Index」固定
    
      - 作成したインデックスを、index\_infoの内容を用いてupdateする
    
      - 作成が成功すると、以下の内容のレスポンスが返却される

  - > Indexes.updateメソッドの返却値をjson形式にエンコードしたものをレスポンスボディに入れようとする

  - > しかし、updateメソッドの返却値はNoneなので、実際に入るのはエラーメッセージ「'NoneType' object is not iterable」である
    
      - パラメータとして空のjsonを渡した場合は、400エラーとなりエラーメッセージ「No data to create.」が返却される
    
      - index\_infoが空だった場合は、400エラーとなりエラーメッセージ「index\_info can not be null.」が返却される

<!-- end list -->

  - 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>

### SWORD API

#### 目的・用途

クライアントからSWORDv3プロトコルに従いリポジトリ上のアイテム操作を実現する。

#### 利用方法

APIの認証にはOAuth2を利用する。

アクセストークンの発行はAPI-1:OAuth2を参照。

**Scope：**

deposit: write

**エンドポイント：**

<table>
<thead>
<tr class="header">
<th>
<p>項番</p>
</th>
<th>
<p>HTTP request</p>
</th>
<th>
<p>内容</p>
</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>
<p>1</p>
</td>
<td>
<p>GET /sword/service-document</p>
</td>
<td>
<p>リポジトリのサービスドキュメントを取得する。</p>
</td>
</tr>
<tr class="even">
<td>
<p>2</p></td>
<td><p>POST /sword/service-document</p>
</td>
<td>
<p>WEKO3の一括登録フォーマットを用いて、アイテムを登録する。</p>
</td>
</tr>
<tr class="odd">
<td>
<p>3</p>
</td>
<td>
<p>GET /sword/deposit/&lt;recid&gt;</p>
</td>
<td>
<p>recidを指定してリポジトリ上に存在するアイテムのステータスドキュメントを取得する。</p>
</td>
</tr>
<tr class="even">
<td>
<p>4</p>
</td>
<td>
<p>DELETE /sword/deposit/&lt;recid&gt;</p>
</td>
<td>
<p>recidを指定してアイテムを削除する。</p>
</td>
</tr>
</tbody>
</table>

##### CURLでのリクエスト実行例：

各APIのリクエスト仕様の詳細は後述。

###### GET /sword/service-document

```
curl https://192.168.56.103/sword/service-document -H "Authorization:Bearer Dp85qdLJefoKZ9AuUeIVCqL0Zj9lHxulU1ZSqWGZKI0xJUfxA4wKFnWgztEo" |
```


  - > \-H オプション
    
      - > Authorization は "Bearer" + " (半角スペース)" + "認証キー"の形式で指定する

###### POST /sword/service-document**


```
curl -s -k https://weko3.ir.rcos.nii.ac.jp/sword/service-document -F
 "file=@import.zip;type=application/zip" -H "Authorization:Bearer 50is1B9XcyHcyRckWx9z0V
2XZnpHq7" -H "Content-Disposition:attachment; filename=import.zip" -H "Packaging:http://
purl.org/net/sword/3.0/package/SimpleZip"| jq .
{
  "@context": "https://swordapp.github.io/swordv3/swordv3.jsonld",
  "@id": "https://weko3.ir.rcos.nii.ac.jp/sword/deposit/96568",
  "@type": "Status",
  "actions": {
    "appendFiles": false,
    "appendMetadata": false,
    "deleteFiles": false,
    "deleteMetadata": false,
    "deleteObject": true,
    "getFiles": false,
    "getMetadata": false,
    "replaceFiles": false,
    "replaceMetadata": false
  },
  "eTag": "5",
  "fileSet": {},
  "links": [
    {
      "@id": "https://weko3.ir.rcos.nii.ac.jp/records/96568",
      "contentType": "text/html",
      "rel": [
        "alternate"
      ]
    },
    {
      "@id": "http://hdl.handle.net/20.500.12465/0000096568",
      "contentType": "text/html",
      "rel": [
        "alternate"
      ]
    }
  ],
  "metadata": {},
  "service": "/sword/service-document",
  "state": [
    {
      "@id": "http://purl.org/net/sword/3.0/state/ingested",
      "description": ""
    }
  ]
}                                                                                       ```
                                                                                |
| ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| curl https://192.168.56.103/sword/service-document -F "file=@export-all3.zip;type=application/zip" -H "Authorization:Bearer Dp85qdLJefoKZ9AuUeIVCqL0Zj9lHxulU1ZSqWGZKI0xJUfxA4wKFnWgztEo" -H "Content-Disposition:attachment; filename=export-all3.zip" -H "Packaging:http://purl.org/net/sword/3.0/package/SimpleZip" |

  - > \-F オプション
    
      - multipart/form-data 形式で POSTするファイルを指定する
    
      - boundaryやContent-Lengthは自動で付加されるため自前で指定しなくてもよい
    
      - ファイル名の先頭には@を付加すること
    
      - ファイルのContent-Typeを"application/zip"とするため、ここでtypeを指定する（指定しないと application/octet-stream となってしまう）

  - > \-H オプション
    
      - Authorization は "Bearer" + " (半角スペース)" + "認証キー"の形式で指定する
    
      - Content-Disposition の filename は -Fオプションで指定したファイルのファイル名と一致させる
    
      - Packaging は "http://purl.org/net/sword/3.0/package/SimpleZip" を指定
    
      - 必須の Content-Length および Content-Type については前述の通り、-Fオプションにて自動付加されるため-Hオプションでの指定は不要


**　3. GET /sword/deposit/\<recid\>**

|                                                                                                                                    |
| ---------------------------------------------------------------------------------------------------------------------------------- |
| curl https://192.168.56.103/sword/deposit/1 -H "Authorization:Bearer Dp85qdLJefoKZ9AuUeIVCqL0Zj9lHxulU1ZSqWGZKI0xJUfxA4wKFnWgztEo" |

  - > \-H オプション
    
      - Authorization は "Bearer" + " (半角スペース)" + "認証キー"の形式で指定する

**　4. DELETE /sword/deposit/\<recid\>**

|                                                                                                                                              |
| -------------------------------------------------------------------------------------------------------------------------------------------- |
| curl -X DELETE https://192.168.56.103/sword/deposit/1 -H "Authorization:Bearer Dp85qdLJefoKZ9AuUeIVCqL0Zj9lHxulU1ZSqWGZKI0xJUfxA4wKFnWgztEo" |

  - > \-H オプション
    
      - Authorization は "Bearer" + " (半角スペース)" + "認証キー"の形式で指定する

<!-- end list -->

  - 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>○</td>
<td>×</td>
</tr>
</tbody>
</table>

  - 機能内容

<!-- end list -->

  - 各APIへのリクエストに応じて処理を実行しレスポンスを返す
    
      - OAuthアクセストークンによるユーザー認証を必須とする

  - アイテム登録機能で登録に使用するZIPファイルはインポートで使用するものと同様の形式のみ使用できる。
    
      - ZIPファイル形式の詳細は [ADMIN-2-4:インポート](./functional_design.md#インポート) を参照

> API仕様

  - > サービスドキュメント取得機能：GET /sword/service-document

<table>
<thead>
<tr class="header">
<th>エンドポイント</th>
<th>GET /sword/service-document</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>概要</td>
<td>リポジトリのサービスドキュメントを取得する。</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>リクエスト</td>
<td>ヘッダー</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>ヘッダー</td>
<td>必須</td>
<td>説明</td>
<td>例</td>
</tr>
<tr class="even">
<td></td>
<td>Authorization</td>
<td>○</td>
<td>操作するWEKOユーザーのOAuth認証情報。<br />
“Bearer”+” (半角スペース)”+“認証キー”の形式で指定する。</td>
<td>“Bearer xxxxxxx”</td>
</tr>
<tr class="odd">
<td></td>
<td>On-Behalf-Of</td>
<td>-</td>
<td>代理投稿ユーザーのメールアドレスを指定する。</td>
<td>user@example.com</td>
</tr>
<tr class="even">
<td>レスポンス</td>
<td>コード</td>
<td>ドキュメント</td>
<td>説明</td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>200</td>
<td>サービスドキュメント</td>
<td>サーバーのサービスドキュメントを返す。</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>400</td>
<td>エラードキュメント</td>
<td>リクエスト内容に何らかの不備がある場合。</td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>401</td>
<td></td>
<td>リクエストでAuthorization ヘッダーが提供されない場合。</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>403</td>
<td></td>
<td>認証に失敗した場合。</td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>412</td>
<td></td>
<td>サーバー側がOn-Behalf-Of をサポートしていないにもかかわらず、リクエストでOn-Behalf-Of ヘッダーが提供された場合。</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>500</td>
<td></td>
<td>サーバー内部エラーが発生した場合。</td>
<td></td>
</tr>
</tbody>
</table>

  - > アイテム登録機能：POST /sword/service-document

<table>
<thead>
<tr class="header">
<th>エンドポイント</th>
<th>POST /sword/service-document</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>概要</td>
<td>一括登録用のZIPファイルを用いてアイテムを新規登録する。</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>リクエスト</td>
<td>ヘッダー</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>ヘッダー</td>
<td>必須</td>
<td>説明</td>
<td>例</td>
</tr>
<tr class="even">
<td></td>
<td>Authorization</td>
<td>○</td>
<td>操作するWEKOユーザーのOAuth認証情報。<br />
“Bearer”+” (半角スペース)”+“認証キー”の形式で指定する。</td>
<td>“Bearer xxxxxxx”</td>
</tr>
<tr class="odd">
<td></td>
<td>On-Behalf-Of</td>
<td>-</td>
<td>代理投稿ユーザーのメールアドレスを指定する。</td>
<td>“user@example.com”</td>
</tr>
<tr class="even">
<td></td>
<td>Content-Disposition</td>
<td>○</td>
<td>リクエストボディに付加したファイルのファイル名を指定する。</td>
<td>“attachment; filename=example.zip”</td>
</tr>
<tr class="odd">
<td></td>
<td>Content-Length</td>
<td>○</td>
<td>リクエストボディに付加したファイルサイズを指定する。</td>
<td>1024000</td>
</tr>
<tr class="even">
<td></td>
<td>Content-Type</td>
<td>○</td>
<td>リクエストボディにファイルを付加するため multipart/form-data を指定する。</td>
<td>multipart/form-data; boundary=xxxxxxxx</td>
</tr>
<tr class="odd">
<td></td>
<td>Packaging</td>
<td>○</td>
<td>パッケージフォーマットと指定する。<br />
SWORDでは以下の3つのパッケージフォーマットが定義されている。<br />
http://purl.org/net/sword/3.0/package/Binary<br />
http://purl.org/net/sword/3.0/package/SimpleZip<br />
http://purl.org/net/sword/3.0/package/SWORDBagIt<br />
※現在はSimpleZip形式のみ対応</td>
<td>“http://purl.org/net/sword<br />
/3.0/package/SimpleZip”</td>
</tr>
<tr class="even">
<td></td>
<td>ボディ</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>Key</td>
<td>必須</td>
<td>説明</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>file</td>
<td>○</td>
<td>form-data 形式でボディにZIPファイルを付加する。<br />
ファイルのContent-Type には“application/zip”を指定すること。</td>
<td></td>
</tr>
<tr class="odd">
<td>レスポンス</td>
<td>コード</td>
<td>ドキュメント</td>
<td>説明</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>200</td>
<td>ステータスドキュメント</td>
<td>登録されたアイテムのステータスドキュメントを返す。</td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>400</td>
<td>エラードキュメント</td>
<td>リクエスト内容に何らかの不備がある場合。</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>401</td>
<td></td>
<td>リクエストでAuthorization ヘッダーが提供されない場合。</td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>403</td>
<td></td>
<td>認証に失敗した場合。<br />
認証したOAuthトークンが「deposit:write」スコープを持っていない場合。</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>412</td>
<td></td>
<td>サーバー側がOn-Behalf-Of をサポートしていないにもかかわらず、リクエストでOn-Behalf-Of ヘッダーが提供された場合。</td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>413</td>
<td></td>
<td>送信されたファイルのサイズがサーバーに設定されたmaxUploadSizeを超えている場合。</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>415</td>
<td></td>
<td>ヘッダーまたはボディに付加されたファイルのContent-Typeがサーバー側でサポートされていない場合。</td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>500</td>
<td></td>
<td>サーバー内部エラーが発生した場合。</td>
<td></td>
</tr>
</tbody>
</table>

  - > アイテム状態取得機能：GET /sword/deposit/\<recid\>

<table>
<thead>
<tr class="header">
<th>エンドポイント</th>
<th>GET /sword/deposit/&lt;recid&gt;</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>概要</td>
<td>指定したアイテムのステータスドキュメントを取得する。</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>リクエスト</td>
<td>ヘッダー</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>ヘッダー</td>
<td>必須</td>
<td>説明</td>
<td>例</td>
</tr>
<tr class="even">
<td></td>
<td>Authorization</td>
<td>○</td>
<td>操作するWEKOユーザーのOAuth認証情報。<br />
“Bearer”+” (半角スペース)”+“認証キー”の形式で指定する。</td>
<td>“Bearer xxxxxxx”</td>
</tr>
<tr class="odd">
<td></td>
<td>On-Behalf-Of</td>
<td>-</td>
<td>代理投稿ユーザーのメールアドレスを指定する。</td>
<td>“user@example.com”</td>
</tr>
<tr class="even">
<td></td>
<td>パスパラメータ</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>Key</td>
<td>必須</td>
<td>説明</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>&lt;recid&gt;</td>
<td>○</td>
<td>レコードID</td>
<td></td>
</tr>
<tr class="odd">
<td>レスポンス</td>
<td>コード</td>
<td>ドキュメント</td>
<td>説明</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>200</td>
<td>ステータスドキュメント</td>
<td>指定されたアイテムのステータスドキュメントを返す。</td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>400</td>
<td>エラードキュメント</td>
<td>リクエスト内容に何らかの不備がある場合。</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>401</td>
<td></td>
<td>リクエストでAuthorization ヘッダーが提供されない場合。</td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>403</td>
<td></td>
<td>認証に失敗した場合。</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>404</td>
<td></td>
<td>指定したrecidに該当するアイテムが存在しない（削除されている）場合。</td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>412</td>
<td></td>
<td>サーバー側がOn-Behalf-Of をサポートしていないにもかかわらず、リクエストでOn-Behalf-Of ヘッダーが提供された場合。</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>500</td>
<td></td>
<td>サーバー内部エラーが発生した場合。</td>
<td></td>
</tr>
</tbody>
</table>

  - > アイテム削除機能：DELETE /sword/deposit/\<recid\>

<table>
<thead>
<tr class="header">
<th>エンドポイント</th>
<th>DELETE /sword/deposit/&lt;recid&gt;</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>概要</td>
<td>指定したアイテムを削除する。</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>リクエスト</td>
<td>ヘッダー</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>ヘッダー</td>
<td>必須</td>
<td>説明</td>
<td>例</td>
</tr>
<tr class="even">
<td></td>
<td>Authorization</td>
<td>○</td>
<td>操作するWEKOユーザーのOAuth認証情報。<br />
“Bearer”+” (半角スペース)”+“認証キー”の形式で指定する。</td>
<td>“Bearer xxxxxxx”</td>
</tr>
<tr class="odd">
<td></td>
<td>On-Behalf-Of</td>
<td>-</td>
<td>代理投稿ユーザーのメールアドレスを指定する。</td>
<td>“user@example.com”</td>
</tr>
<tr class="even">
<td></td>
<td>パスパラメータ</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>Key</td>
<td>必須</td>
<td>説明</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>&lt;recid&gt;</td>
<td>○</td>
<td>レコードID</td>
<td></td>
</tr>
<tr class="odd">
<td>レスポンス</td>
<td>コード</td>
<td>ドキュメント</td>
<td>説明</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>204</td>
<td>なし</td>
<td>空のレスポンスを返す。</td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>400</td>
<td>エラードキュメント</td>
<td>リクエスト内容に何らかの不備がある場合。</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>401</td>
<td></td>
<td>リクエストでAuthorization ヘッダーが提供されない場合。</td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>403</td>
<td></td>
<td>認証に失敗した場合。</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td>412</td>
<td></td>
<td>サーバー側がOn-Behalf-Of をサポートしていないにもかかわらず、リクエストでOn-Behalf-Of ヘッダーが提供された場合。</td>
<td></td>
</tr>
<tr class="odd">
<td></td>
<td>500</td>
<td></td>
<td>サーバー内部エラーが発生した場合。</td>
<td></td>
</tr>
</tbody>
</table>

> ドキュメント仕様

  - > サービスドキュメント  
    > サーバー全体の機能と操作パラメータを定義したドキュメント

<table>
<thead>
<tr class="header">
<th>項目</th>
<th>型</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>@context</td>
<td>string</td>
<td>“https://swordapp.github.io/swordv3/swordv3.jsonld”を固定で出力。</td>
</tr>
<tr class="even">
<td>@id</td>
<td>string</td>
<td>"[WEKO3のURL]/sword/service-document"を出力。</td>
</tr>
<tr class="odd">
<td>@type</td>
<td>string</td>
<td>"ServiceDocument"を固定で出力。</td>
</tr>
<tr class="even">
<td>accept</td>
<td>array</td>
<td>サーバーに受け入れられるコンテンツタイプのリスト。<br />
”*/*”を出力する。</td>
</tr>
<tr class="odd">
<td>acceptArchiveFormat</td>
<td>array</td>
<td>サーバーが解凍できるアーカイブ形式のリスト。<br />
現状"application/zip"のみ対応。</td>
</tr>
<tr class="even">
<td>acceptDeposits</td>
<td>boolean</td>
<td>サーバーがデポジットを受け入れるか否か。</td>
</tr>
<tr class="odd">
<td>acceptMetadata</td>
<td>array</td>
<td>サーバーで受け入れ可能なメタデータ形式のリスト。<br />
現状では出力内容にかかわらず、Metadataの受け入れには対応していない。</td>
</tr>
<tr class="even">
<td>acceptPackaging</td>
<td>array</td>
<td>サーバーで受け入れ可能なパッケージ形式のリスト。<br />
現状すべての形式を受け入れるが、アイテム登録はWEKOの一括登録用ZIP形式でのみ可能。</td>
</tr>
<tr class="odd">
<td>authentication</td>
<td>Array</td>
<td>サーバーでサポートされている認証スキームのリスト。<br />
現状”OAuth”のみ対応。</td>
</tr>
<tr class="even">
<td>byReferenceDeposit</td>
<td>boolean</td>
<td>サーバーがbyReferenceDepositをサポートしているか否か。現状未対応のためFalseを出力。</td>
</tr>
<tr class="odd">
<td>collectionPolicy</td>
<td>object</td>
<td>コレクションポリシーを示すオブジェクト。</td>
</tr>
<tr class="even">
<td>collectionPolicy.@id</td>
<td>string</td>
<td>コレクションポリシーのURL。</td>
</tr>
<tr class="odd">
<td>collectionPolicy.description</td>
<td>string</td>
<td>コレクションポリシーの説明。</td>
</tr>
<tr class="even">
<td>dc:title</td>
<td>string</td>
<td>リポジトリの名称を出力。</td>
</tr>
<tr class="odd">
<td>dcterms:abstract</td>
<td>string</td>
<td>リポジトリの説明。</td>
</tr>
<tr class="even">
<td>digest</td>
<td>array</td>
<td>サーバーが受け入れるdigest形式のリスト。<br />
現状digestの検証は未対応。</td>
</tr>
<tr class="odd">
<td>maxAssembledSize</td>
<td>integer</td>
<td>Segmented File Upload時のファイル合計最大サイズ（単位：byte）。</td>
</tr>
<tr class="even">
<td>maxByReferenceSize</td>
<td>integer</td>
<td>By-Reference Deposit時のファイル最大サイズ（単位：byte）。</td>
</tr>
<tr class="odd">
<td>maxSegmentSize</td>
<td>integer</td>
<td>Segmented File Upload時の１ファイルの最大サイズ（単位：byte）。</td>
</tr>
<tr class="even">
<td>maxSegments</td>
<td>integer</td>
<td>Segmented File Upload時のセグメントの最大数。</td>
</tr>
<tr class="odd">
<td>maxUploadSize</td>
<td>integer</td>
<td>アップロードされるファイルの最大サイズ（単位：byte）。</td>
</tr>
<tr class="even">
<td>minSegmentSize</td>
<td>integer</td>
<td>Segmented File Upload時の１ファイルの最小サイズ（単位：byte）。</td>
</tr>
<tr class="odd">
<td>onBehalfOf</td>
<td>boolean</td>
<td>代理投稿をサポートしているか否か。<br />
現状未対応のためfalseを出力。</td>
</tr>
<tr class="even">
<td>root</td>
<td>string</td>
<td>サービスドキュメントのルートURL。</td>
</tr>
<tr class="odd">
<td>services</td>
<td>array</td>
<td>親サービスに含まれるサービスのリスト。<br />
現状未対応。</td>
</tr>
<tr class="even">
<td>staging</td>
<td>string</td>
<td>Segmented File Upload時にコンテンツをステージング先URL。現状未対応のため空文字を出力。</td>
</tr>
<tr class="odd">
<td>stagingMaxIdle</td>
<td>integer</td>
<td>ステージングされたファイルの最小保持時間。</td>
</tr>
<tr class="even">
<td>treatment</td>
<td>object</td>
<td>デポジット時に期待される処理のURLと説明を示すオブジェクト。</td>
</tr>
<tr class="odd">
<td>treatment.@id</td>
<td>string</td>
<td>処理のURL。</td>
</tr>
<tr class="even">
<td>treatment.description</td>
<td>string</td>
<td>処理の説明。</td>
</tr>
<tr class="odd">
<td>version</td>
<td>string</td>
<td>サポートしているSWORDバージョン。<br />
"http://purl.org/net/sword/3.0"を出力。</td>
</tr>
</tbody>
</table>

  - > ステータスドキュメント  
    > アイテムの内容と現在の状態に関する詳細情報を示すドキュメント

<table>
<thead>
<tr class="header">
<th>項目</th>
<th>型</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>@context</td>
<td>string</td>
<td>“https://swordapp.github.io/swordv3/swordv3.jsonld”を固定で出力。</td>
</tr>
<tr class="even">
<td>@id</td>
<td>string</td>
<td>"[WEKO3のURL]/sword/deposit/[アイテムのrecid]"を出力。</td>
</tr>
<tr class="odd">
<td>@type</td>
<td>string</td>
<td>"ServiceDocument"を固定で出力。</td>
</tr>
<tr class="even">
<td>actions</td>
<td>object</td>
<td>アイテムに対してSWORDで使用可能なアクション。<br />
現時点では deleteObject のみTrueを返し、それ以外はFalseを返すようになっている。</td>
</tr>
<tr class="odd">
<td>actions. appendFiles</td>
<td>boolean</td>
<td>ファイル追加要求が発行可能か否か。</td>
</tr>
<tr class="even">
<td>actions.appendMetadata</td>
<td>boolean</td>
<td>メタデータ追加要求が発行可能か否か。</td>
</tr>
<tr class="odd">
<td>actions. deleteFiles</td>
<td>boolean</td>
<td>ファイル削除要求が発行可能か否か。</td>
</tr>
<tr class="even">
<td>actions. deleteMetadata</td>
<td>boolean</td>
<td>メタデータ削除要求が発行可能か否か。</td>
</tr>
<tr class="odd">
<td>actions. deleteObject</td>
<td>boolean</td>
<td>アイテム削除要求が発行可能か否か。</td>
</tr>
<tr class="even">
<td>actions. getFiles</td>
<td>boolean</td>
<td>ファイル取得要求が発行可能か否か。</td>
</tr>
<tr class="odd">
<td>actions. getMetadata</td>
<td>boolean</td>
<td>メタデータ取得要求が発行可能か否か。</td>
</tr>
<tr class="even">
<td>actions. replaceFiles</td>
<td>boolean</td>
<td>ファイル置き換え要求が発行可能か否か。</td>
</tr>
<tr class="odd">
<td>actions. replaceMetadata</td>
<td>boolean</td>
<td>メタデータ置き換え要求が発行可能か否か。</td>
</tr>
<tr class="even">
<td>eTag</td>
<td>string</td>
<td>アイテムのeTag。<br />
WEKOではアイテムのリビジョン番号を返す。</td>
</tr>
<tr class="odd">
<td>fileSet</td>
<td>object</td>
<td>ファイルセットを示すオブジェクト。<br />
現時点では空オブジェクトを返す。</td>
</tr>
<tr class="even">
<td>fileSet.@id</td>
<td>string</td>
<td>ファイルセットのURL。</td>
</tr>
<tr class="odd">
<td>fileSet.eTag</td>
<td>string</td>
<td>ファイルセットのeTag。</td>
</tr>
<tr class="even">
<td>links</td>
<td>array</td>
<td>アイテムのリンクを示すオブジェクト。<br />
現時点ではアイテム詳細ページのURLを出力する。またDOIやCNRIハンドルを持つ場合も同様に出力する。</td>
</tr>
<tr class="odd">
<td>links[].@id</td>
<td>string</td>
<td>リソースのURL。</td>
</tr>
<tr class="even">
<td>links[].byReference</td>
<td>string</td>
<td>byReference deposit の際の参照元URL。</td>
</tr>
<tr class="odd">
<td>links[].contentType</td>
<td>string</td>
<td>リソースのコンテンツタイプ。</td>
</tr>
<tr class="even">
<td>links[].dcterms:isReplacedBy</td>
<td>string</td>
<td>同じオブジェクト内のファイルの新しいバージョンへのURL。</td>
</tr>
<tr class="odd">
<td>links[].dcterms:relation</td>
<td>string</td>
<td>非SWORDアクセスポイントへのURL。</td>
</tr>
<tr class="even">
<td>links[].dcterms:replaces</td>
<td>string</td>
<td>同じオブジェクト内の古いバージョンのファイルへのURL。</td>
</tr>
<tr class="odd">
<td>links[].depositedBy</td>
<td>string</td>
<td>アイテム登録を行ったユーザーの識別子。</td>
</tr>
<tr class="even">
<td>links[].depositedOn</td>
<td>string</td>
<td>アイテム登録日時のタイムスタンプ。</td>
</tr>
<tr class="odd">
<td>links[].depositedOnBehalfOf</td>
<td>string</td>
<td>代理投稿により登録を行ったユーザーの識別子。</td>
</tr>
<tr class="even">
<td>links[].derivedFrom</td>
<td>string</td>
<td>現在のリソースが派生したリソースのURLへの参照。</td>
</tr>
<tr class="odd">
<td>links[].eTag</td>
<td>string</td>
<td>リソースのeTag。</td>
</tr>
<tr class="even">
<td>links[].log</td>
<td>string</td>
<td>クライアントが知っておくべきデポジットに関連する情報。</td>
</tr>
<tr class="odd">
<td>links[].packaging</td>
<td>string</td>
<td>リソースがパッケージである場合、パッケージ形式の識別子を示す。</td>
</tr>
<tr class="even">
<td>links[].rel</td>
<td>string</td>
<td><p>リソースとオブジェクトの関係。<br />
以下の何れかの文字列を持つ。</p>
<ul>
<li>
<p>alternate</p>
</li>
<li>
<p>packaging</p>
</li>
<li>
<p>depositedOn</p>
</li>
<li><p>depositedOnBehalfOf</p></li>
<li><p>status</p></li>
<li><p>log</p></li>
<li><p>dcterms:relation</p></li>
<li><p>dcterms:replaces</p></li>
<li><p>dcterms:isReplacedBy</p></li>
<li><p>versionReplaced</p></li>
<li><p>eTag</p></li>
<li><p>byReference</p></li>
<li><p>derivedFrom</p></li>
<li><p>metadataFormat</p></li>
</ul></td>
</tr>
<tr class="odd">
<td>links[].status</td>
<td>string</td>
<td>取り込みに関するリソースのステータス。</td>
</tr>
<tr class="even">
<td>links[].versionReplacedOn</td>
<td>string</td>
<td>現在のリソースが新しいリソースに置き換えられた日付。</td>
</tr>
<tr class="odd">
<td>metadata</td>
<td>object</td>
<td>メタデータを示すオブジェクト。<br />
現時点では空オブジェクトを返す。</td>
</tr>
<tr class="even">
<td>metadata.@id</td>
<td>string</td>
<td>メタデータのURL。</td>
</tr>
<tr class="odd">
<td>metadata.eTag</td>
<td>string</td>
<td>メタデータのeTag。</td>
</tr>
<tr class="even">
<td>service</td>
<td>string</td>
<td>サービスドキュメントのURL。</td>
</tr>
<tr class="odd">
<td>state</td>
<td>array</td>
<td>アイテムがサーバー上にある状態のリスト。</td>
</tr>
<tr class="even">
<td>state[].@id</td>
<td>string</td>
<td>状態の識別子。<br />
現状では"http://purl.org/net/sword/3.0/state/ingested"を固定で出力。</td>
</tr>
<tr class="odd">
<td>state[].description</td>
<td>string</td>
<td>状態の説明</td>
</tr>
</tbody>
</table>

  - > エラードキュメント  
    > エラー内容を表すドキュメント

<table>
<thead>
<tr class="header">
<th>項目</th>
<th>型</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>@context</td>
<td>string</td>
<td>“https://swordapp.github.io/swordv3/swordv3.jsonld”を固定で出力。</td>
</tr>
<tr class="even">
<td>@type</td>
<td>string</td>
<td>エラータイプを示す文字列。<br />
4.3.3エラータイプ を参照。</td>
</tr>
<tr class="odd">
<td>error</td>
<td>string</td>
<td>エラー内容の説明。</td>
</tr>
<tr class="even">
<td>log</td>
<td>string</td>
<td>より詳細なエラー内容。<br />
現在は出力していない。</td>
</tr>
<tr class="odd">
<td>timestamp</td>
<td>string</td>
<td>エラー発生時のタイムスタンプ。</td>
</tr>
</tbody>
</table>

> エラータイプ

| エラータイプ文字列                    | エラーコード | エラー原因等                                               |
| ---------------------------- | ------ | ---------------------------------------------------- |
| AuthenticationFailed         | 403    | 認証に失敗。                                               |
| AuthenticationRequired       | 401    | 認証情報が不足。                                             |
| BadRequest                   | 400    | リクエストに何らかの不備がある。                                     |
| ByReferenceFileSizeExceeded  | 400    | サーバーの制限を超えるファイルをデポジットしようとした。                         |
| ByReferenceNotAllowed        | 412    | サーバーが By-Reference deposit をサポートしていない。               |
| ContentMalformed             | 400    | リクエスト本文の内容に不正がある。                                    |
| ContentTypeNotAcceptable     | 415    | サーバーで許可されていないコンテンツタイプをリクエストした。                       |
| DigestMismatch               | 412    | リクエストヘッダーによって提供されたdigestがサーバーで受け取ったコンテンツと一致していない。    |
| ETagNotMatched               | 412    | リクエストヘッダーによって提供されたIf-Matchの値が更新対象コンテンツのeTagと一致していない。 |
| ETagRequired                 | 412    | リクエストヘッダーにIf-Matchの値が指定されていない。                       |
| Forbidden                    | 403    | サーバーによって許可されていない操作をリクエストした。                          |
| FormatHeaderMismatch         | 415    | サーバーがサポートしていない形式のコンテンツがリクエストされた。                     |
| InvalidSegmentSize           | 400    | セグメントアップロード時のファイルサイズが範囲外。                            |
| MaxAssembledSizeExceeded     | 400    | セグメントアップロード時の合計ファイルサイズが最大値を超えている。                    |
| MaxUploadSizeExceeded        | 413    | アップロードされたコンテンツサイズが最大値を超えている                          |
| MetadataFormatNotAcceptable  | 415    | サーバーがサポートしていない形式のMetadata-Formatがリクエストされた。           |
| MethodNotAllowed             | 405    | メソッドへのアクセスが許可されていない。                                 |
| OnBehalfOfNotAllowed         | 412    | サーバーが On-Behalf-Of をサポートしていない。                       |
| PackagingFormatNotAcceptable | 415    | サーバーがサポートしていない形式のPackagingフォーマットがリクエストされた。           |
| SegmentedUploadTimedOut      | 410    | セグメントアップロード先のURLにアクセスできない。                           |
| SegmentLimitExceeded         | 400    | セグメント数が最大値を超えている。                                    |
| UnexpectedSegment            | 400    | サーバーが予期していないセグメントを受信した。                              |

  - 関連モジュール

<!-- end list -->

  - > invenio\_oauth2server：OAuthトークンによるユーザー認証を行う

  - > invenio\_deposit：OAuthトークンが参照するデポジット操作スコープを定義している

  - > weko\_records\_ui：レコード情報の取得、アイテムの削除を実行する

  - > weko\_search\_ui：インポート処理を実行する

<!-- end list -->

  - 処理概要

<!-- end list -->

  - > サービスドキュメント取得機能：GET /sword/service-document
    
      - リクエストをチェックする
        
          - Authorizationヘッダーに記載されたOAuth認証情報を使用しWEKOにログインする
        
          - On-Behalf-Ofヘッダーが存在する場合、サーバー設定を確認する
    
      - サーバー設定値を参照し、サービスドキュメントを生成する
    
      - サービスドキュメントを返却する

  - > アイテム登録機能：POST /sword/service-document
    
      - リクエストをチェックする
        
          - Authorizationヘッダーに記載されたOAuth認証情報を使用しWEKOにログインする
        
          - 認証に使用されたOAuthトークンのScopeを確認する
        
          - On-Behalf-Ofヘッダーが存在する場合、サーバー設定を確認する
        
          - 送付されたファイルの有無を確認する
        
          - ファイルサイズを確認する
        
          - Content-Typeを確認する
        
          - Packagingを確認する
    
      - ファイル内容に不備が無いかのチェックを行う
    
      - ファイル内のアイテムが新規登録か否かを確認する
    
      - インポート処理を行う
    
      - 登録したアイテムのステータスドキュメントを生成する
        
          - インポート処理から返されたrecidからアイテム情報を取得する
        
          - 取得したアイテム情報からステータスドキュメントを生成する
    
      - ステータスドキュメントを返却する

  - > アイテム状態取得機能：GET /sword/deposit/\<recid\>
    
      - リクエストをチェックする
        
          - Authorizationヘッダーに記載されたOAuth認証情報を使用しWEKOにログインする
        
          - On-Behalf-Ofヘッダーが存在する場合、サーバー設定を確認する
    
      - 指定されたrecidからアイテム情報を取得する
    
      - 取得したアイテム情報からステータスドキュメントを生成する
    
      - ステータスドキュメントを返却する

  - > アイテム削除機能：DELETE /sword/deposit/\<recid\>
    
      - リクエストをチェックする
        
          - Authorizationヘッダーに記載されたOAuth認証情報を使用しWEKOにログインする
        
          - On-Behalf-Ofヘッダーが存在する場合、サーバー設定を確認する
    
      - 指定されたrecidを引数にsoft\_delete処理を実行する
    
      - 空のレスポンスを返却する

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>
<p>2022/06/13</p>
</td>
<td>e6db31c99d459605f5bc09f15c4abd07ea573428</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td>
<p>2023/08/31</p>
</td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>ADMIN-2-4へのリンクを追加</td>
</tr>
</tbody>
</table>
### アイテム検索用API

  - 目的・用途

アイテム検索機能を提供する。

  - 利用方法

| **Method** | **HTTP request**     | **Description** |
| ---------- | -------------------- | --------------- |
|            | **GET /api/records** | アイテムを検索する       |

クエリパラメータ

<table>
<thead>
<tr class="header">
<th><strong>GET /api/opensearch/search</strong></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>パラメータ</td>
<td>必須</td>
<td>値</td>
<td>説明</td>
</tr>
<tr class="even">
<td>search_type</td>
<td></td>
<td><ul>
<li><p>0:フルテキスト</p></li>
<li><p>1:キーワード</p></li>
</ul></td>
<td><p>フルテキストを指定した場合は本文ファイルから抽出されたテキストも検索対象とする。</p>
<p>キーワードを指定した場合はメタデータ項目のみを検索対象とする。</p></td>
</tr>
<tr class="odd">
<td>q</td>
<td></td>
<td>string</td>
<td>検索キーワードを指定する。</td>
</tr>
<tr class="even">
<td>size</td>
<td></td>
<td>int</td>
<td>検索結果の件数を指定する</td>
</tr>
<tr class="odd">
<td>page</td>
<td></td>
<td>Int</td>
<td>検索結果で表示するページ番号を指定する。</td>
</tr>
<tr class="even">
<td>Sort</td>
<td></td>
<td><ul>
<li><p>+controlnumber</p></li>
<li><p>-controlnumber</p></li>
<li><p>+wtl</p></li>
<li><p>+wtl</p></li>
<li><p>+itemType</p></li>
<li><p>-itemType</p></li>
</ul>
<p>他</p></td>
<td>ソートキーを指定する。接頭辞「+」は昇順、「-」は降順となる。</td>
</tr>
<tr class="odd">
<td>以下は設定ファイルやアイテムタイプマッピングにより定義が変化する</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>title</td>
<td></td>
<td>string</td>
<td>dc:titleにマッピングされた項目の検索</td>
</tr>
<tr class="odd">
<td>des</td>
<td></td>
<td>strin</td>
<td>datacite:descriptionにマッピングされた項目の検索</td>
</tr>
<tr class="even">
<td>type</td>
<td></td>
<td>string</td>
<td>dc:typeにマッピングされた項目の検索</td>
</tr>
<tr class="odd">
<td>wid</td>
<td></td>
<td>Int</td>
<td>アイテムIDを指定して検索</td>
</tr>
<tr class="even">
<td>Iid</td>
<td></td>
<td>Int</td>
<td>インデックスIDを指定して検索</td>
</tr>
<tr class="odd">
<td><p>date_range1_from</p>
<p>date_range1_to</p></td>
<td></td>
<td>yyymmdd</td>
<td>dte_range1 に対して期間の範囲を指定して検索</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

レスポンス例：

<table>
<thead>
<tr class="header">
<th><strong>レスポンス例</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>/api/records/?page=1&amp;size=1&amp;sort=controlnumber&amp;search_type=0&amp;q=%E6%A6%82%E8%A6%81</strong></td>
</tr>
<tr class="even">
<td><p>{</p>
<p>"aggregations": {</p>
<p>"Access": {</p>
<p>"buckets": [</p>
<p>{</p>
<p>"doc_count": 1761,</p>
<p>"key": "open access"</p>
<p>}</p>
<p>],</p>
<p>"doc_count_error_upper_bound": 0,</p>
<p>"sum_other_doc_count": 0</p>
<p>},</p>
<p>"Data Language": {</p>
<p>"buckets": [</p>
<p>{</p>
<p>"doc_count": 1761,</p>
<p>"key": "jpn"</p>
<p>}</p>
<p>],</p>
<p>"doc_count_error_upper_bound": 0,</p>
<p>"sum_other_doc_count": 0</p>
<p>},</p>
<p>"Data Type": {</p>
<p>"Data Type": {</p>
<p>"buckets": [],</p>
<p>"doc_count_error_upper_bound": 0,</p>
<p>"sum_other_doc_count": 0</p>
<p>},</p>
<p>"doc_count": 0</p>
<p>},</p>
<p>"Distributor": {</p>
<p>"Distributor": {</p>
<p>"buckets": [],</p>
<p>"doc_count_error_upper_bound": 0,</p>
<p>"sum_other_doc_count": 0</p>
<p>},</p>
<p>"doc_count": 0</p>
<p>},</p>
<p>"Location": {</p>
<p>"buckets": [</p>
<p>{</p>
<p>"doc_count": 1761,</p>
<p>"key": "Japan"</p>
<p>}</p>
<p>],</p>
<p>"doc_count_error_upper_bound": 0,</p>
<p>"sum_other_doc_count": 0</p>
<p>},</p>
<p>"Temporal": {</p>
<p>"buckets": [</p>
<p>{</p>
<p>"doc_count": 1761,</p>
<p>"key": "Temporal"</p>
<p>}</p>
<p>],</p>
<p>"doc_count_error_upper_bound": 0,</p>
<p>"sum_other_doc_count": 0</p>
<p>},</p>
<p>"Topic": {</p>
<p>"buckets": [</p>
<p>{</p>
<p>"doc_count": 1761,</p>
<p>"key": "Sibject1"</p>
<p>}</p>
<p>],</p>
<p>"doc_count_error_upper_bound": 0,</p>
<p>"sum_other_doc_count": 0</p>
<p>},</p>
<p>"path": {</p>
<p>"buckets": [],</p>
<p>"doc_count_error_upper_bound": "0",</p>
<p>"sum_order_doc_count": "0"</p>
<p>}</p>
<p>},</p>
<p>"hits": {</p>
<p>"hits": [</p>
<p>{</p>
<p>"created": "2023-11-06T05:43:58.044449+00:00",</p>
<p>"id": 1,</p>
<p>"links": {</p>
<p>"self": "https://dev.ir.rcos.nii.ac.jp/api/records/1"</p>
<p>},</p>
<p>"metadata": {</p>
<p>"_comment": [</p>
<p>"public-item-0-public-oai-guest-1-en",</p>
<p>"Source Title,1,111,12,1,3,en,2021-06-30",</p>
<p>"Conference Name",</p>
<p>"1",</p>
<p>"JPN",</p>
<p>"Sponsor",</p>
<p>"Conference Venue",</p>
<p>"Conference Place"</p>
<p>],</p>
<p>"_creator_info": [</p>
<p>{</p>
<p>"creatorAffiliations": [</p>
<p>{</p>
<p>"affiliationNameIdentifiers": [</p>
<p>{</p>
<p>"affiliationNameIdentifier": "0000000121691048",</p>
<p>"affiliationNameIdentifierScheme": "ISNI",</p>
<p>"affiliationNameIdentifierURI": "http://isni.org/isni/0000000121691048"</p>
<p>}</p>
<p>],</p>
<p>"affiliationNames": [</p>
<p>{</p>
<p>"affiliationName": "University",</p>
<p>"affiliationNameLang": "en"</p>
<p>}</p>
<p>]</p>
<p>}</p>
<p>],</p>
<p>"creatorMails": [</p>
<p>{</p>
<p>"creatorMail": "wekosoftware@nii.ac.jp"</p>
<p>}</p>
<p>],</p>
<p>"creatorNames": {</p>
<p>"creatorName": "Joho\t Taro",</p>
<p>"creatorNameLang": "en",</p>
<p>"idx": 2</p>
<p>},</p>
<p>"familyNames": {</p>
<p>"familyName": "Joho",</p>
<p>"familyNameLang": "en",</p>
<p>"idx": 2</p>
<p>},</p>
<p>"givenNames": {</p>
<p>"givenName": "Taro",</p>
<p>"givenNameLang": "en",</p>
<p>"idx": 2</p>
<p>},</p>
<p>"nameIdentifiers": [</p>
<p>{</p>
<p>"nameIdentifier": "4",</p>
<p>"nameIdentifierScheme": "WEKO"</p>
<p>},</p>
<p>{</p>
<p>"nameIdentifier": "xxxxxxx",</p>
<p>"nameIdentifierScheme": "ORCID",</p>
<p>"nameIdentifierURI": "https://orcid.org/"</p>
<p>},</p>
<p>{</p>
<p>"nameIdentifier": "xxxxxxx",</p>
<p>"nameIdentifierScheme": "CiNii",</p>
<p>"nameIdentifierURI": "https://ci.nii.ac.jp/"</p>
<p>},</p>
<p>{</p>
<p>"nameIdentifier": "zzzzzzz",</p>
<p>"nameIdentifierScheme": "KAKEN2",</p>
<p>"nameIdentifierURI": "https://kaken.nii.ac.jp/"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>{</p>
<p>"creatorMails": [</p>
<p>{</p>
<p>"creatorMail": "wekosoftware@nii.ac.jp"</p>
<p>}</p>
<p>],</p>
<p>"creatorNames": {</p>
<p>"creatorName": "Joho\t Taro",</p>
<p>"creatorNameLang": "en",</p>
<p>"idx": 2</p>
<p>},</p>
<p>"familyNames": {</p>
<p>"familyName": "Joho",</p>
<p>"familyNameLang": "en",</p>
<p>"idx": 2</p>
<p>},</p>
<p>"givenNames": {</p>
<p>"givenName": "Taro",</p>
<p>"givenNameLang": "en",</p>
<p>"idx": 2</p>
<p>},</p>
<p>"nameIdentifiers": [</p>
<p>{</p>
<p>"nameIdentifier": "xxxxxxx",</p>
<p>"nameIdentifierScheme": "ORCID",</p>
<p>"nameIdentifierURI": "https://orcid.org/"</p>
<p>},</p>
<p>{</p>
<p>"nameIdentifier": "xxxxxxx",</p>
<p>"nameIdentifierScheme": "CiNii",</p>
<p>"nameIdentifierURI": "https://ci.nii.ac.jp/"</p>
<p>},</p>
<p>{</p>
<p>"nameIdentifier": "zzzzzzz",</p>
<p>"nameIdentifierScheme": "KAKEN2",</p>
<p>"nameIdentifierURI": "https://kaken.nii.ac.jp/"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>{</p>
<p>"creatorMails": [</p>
<p>{</p>
<p>"creatorMail": "wekosoftware@nii.ac.jp"</p>
<p>}</p>
<p>],</p>
<p>"creatorNames": {</p>
<p>"creatorName": "Joho\t Taro",</p>
<p>"creatorNameLang": "en",</p>
<p>"idx": 2</p>
<p>},</p>
<p>"familyNames": {</p>
<p>"familyName": "Joho",</p>
<p>"familyNameLang": "en",</p>
<p>"idx": 2</p>
<p>},</p>
<p>"givenNames": {</p>
<p>"givenName": "Taro",</p>
<p>"givenNameLang": "en",</p>
<p>"idx": 2</p>
<p>},</p>
<p>"nameIdentifiers": [</p>
<p>{</p>
<p>"nameIdentifier": "xxxxxxx",</p>
<p>"nameIdentifierScheme": "ORCID",</p>
<p>"nameIdentifierURI": "https://orcid.org/"</p>
<p>},</p>
<p>{</p>
<p>"nameIdentifier": "xxxxxxx",</p>
<p>"nameIdentifierScheme": "CiNii",</p>
<p>"nameIdentifierURI": "https://ci.nii.ac.jp/"</p>
<p>},</p>
<p>{</p>
<p>"nameIdentifier": "zzzzzzz",</p>
<p>"nameIdentifierScheme": "KAKEN2",</p>
<p>"nameIdentifierURI": "https://kaken.nii.ac.jp/"</p>
<p>}</p>
<p>]</p>
<p>}</p>
<p>],</p>
<p>"_files_info": [</p>
<p>{</p>
<p>"extention": "pdf",</p>
<p>"label": "1KB.pdf",</p>
<p>"url": "https://weko3.example.org/record/1/files/1KB.pdf"</p>
<p>}</p>
<p>],</p>
<p>"_item_metadata": {</p>
<p>"author_link": [</p>
<p>"4"</p>
<p>],</p>
<p>"control_number": "1",</p>
<p>"item_1617186331708": {</p>
<p>"attribute_name": "Title",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_title": "public-item-0-public-oai-guest-1-ja",</p>
<p>"subitem_title_language": "ja"</p>
<p>},</p>
<p>{</p>
<p>"subitem_title": "public-item-0-public-oai-guest-1-en",</p>
<p>"subitem_title_language": "en"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617186385884": {</p>
<p>"attribute_name": "Alternative Title",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_alternative_title": "Alternative Title",</p>
<p>"subitem_alternative_title_language": "en"</p>
<p>},</p>
<p>{</p>
<p>"subitem_alternative_title": "Alternative Title",</p>
<p>"subitem_alternative_title_language": "ja"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617186419668": {</p>
<p>"attribute_name": "Creator",</p>
<p>"attribute_type": "creator",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"creatorAffiliations": [</p>
<p>{</p>
<p>"affiliationNameIdentifiers": [</p>
<p>{</p>
<p>"affiliationNameIdentifier": "0000000121691048",</p>
<p>"affiliationNameIdentifierScheme": "ISNI",</p>
<p>"affiliationNameIdentifierURI": "http://isni.org/isni/0000000121691048"</p>
<p>}</p>
<p>],</p>
<p>"affiliationNames": [</p>
<p>{</p>
<p>"affiliationName": "University",</p>
<p>"affiliationNameLang": "en"</p>
<p>}</p>
<p>]</p>
<p>}</p>
<p>],</p>
<p>"creatorMails": [</p>
<p>{</p>
<p>"creatorMail": "wekosoftware@nii.ac.jp"</p>
<p>}</p>
<p>],</p>
<p>"creatorNames": {</p>
<p>"creatorName": "Joho\t Taro",</p>
<p>"creatorNameLang": "en",</p>
<p>"idx": 2</p>
<p>},</p>
<p>"familyNames": {</p>
<p>"familyName": "Joho",</p>
<p>"familyNameLang": "en",</p>
<p>"idx": 2</p>
<p>},</p>
<p>"givenNames": {</p>
<p>"givenName": "Taro",</p>
<p>"givenNameLang": "en",</p>
<p>"idx": 2</p>
<p>},</p>
<p>"nameIdentifiers": [</p>
<p>{</p>
<p>"nameIdentifier": "4",</p>
<p>"nameIdentifierScheme": "WEKO"</p>
<p>},</p>
<p>{</p>
<p>"nameIdentifier": "xxxxxxx",</p>
<p>"nameIdentifierScheme": "ORCID",</p>
<p>"nameIdentifierURI": "https://orcid.org/"</p>
<p>},</p>
<p>{</p>
<p>"nameIdentifier": "xxxxxxx",</p>
<p>"nameIdentifierScheme": "CiNii",</p>
<p>"nameIdentifierURI": "https://ci.nii.ac.jp/"</p>
<p>},</p>
<p>{</p>
<p>"nameIdentifier": "zzzzzzz",</p>
<p>"nameIdentifierScheme": "KAKEN2",</p>
<p>"nameIdentifierURI": "https://kaken.nii.ac.jp/"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>{</p>
<p>"creatorMails": [</p>
<p>{</p>
<p>"creatorMail": "wekosoftware@nii.ac.jp"</p>
<p>}</p>
<p>],</p>
<p>"creatorNames": {</p>
<p>"creatorName": "Joho\t Taro",</p>
<p>"creatorNameLang": "en",</p>
<p>"idx": 2</p>
<p>},</p>
<p>"familyNames": {</p>
<p>"familyName": "Joho",</p>
<p>"familyNameLang": "en",</p>
<p>"idx": 2</p>
<p>},</p>
<p>"givenNames": {</p>
<p>"givenName": "Taro",</p>
<p>"givenNameLang": "en",</p>
<p>"idx": 2</p>
<p>},</p>
<p>"nameIdentifiers": [</p>
<p>{</p>
<p>"nameIdentifier": "xxxxxxx",</p>
<p>"nameIdentifierScheme": "ORCID",</p>
<p>"nameIdentifierURI": "https://orcid.org/"</p>
<p>},</p>
<p>{</p>
<p>"nameIdentifier": "xxxxxxx",</p>
<p>"nameIdentifierScheme": "CiNii",</p>
<p>"nameIdentifierURI": "https://ci.nii.ac.jp/"</p>
<p>},</p>
<p>{</p>
<p>"nameIdentifier": "zzzzzzz",</p>
<p>"nameIdentifierScheme": "KAKEN2",</p>
<p>"nameIdentifierURI": "https://kaken.nii.ac.jp/"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>{</p>
<p>"creatorMails": [</p>
<p>{</p>
<p>"creatorMail": "wekosoftware@nii.ac.jp"</p>
<p>}</p>
<p>],</p>
<p>"creatorNames": {</p>
<p>"creatorName": "Joho\t Taro",</p>
<p>"creatorNameLang": "en",</p>
<p>"idx": 2</p>
<p>},</p>
<p>"familyNames": {</p>
<p>"familyName": "Joho",</p>
<p>"familyNameLang": "en",</p>
<p>"idx": 2</p>
<p>},</p>
<p>"givenNames": {</p>
<p>"givenName": "Taro",</p>
<p>"givenNameLang": "en",</p>
<p>"idx": 2</p>
<p>},</p>
<p>"nameIdentifiers": [</p>
<p>{</p>
<p>"nameIdentifier": "xxxxxxx",</p>
<p>"nameIdentifierScheme": "ORCID",</p>
<p>"nameIdentifierURI": "https://orcid.org/"</p>
<p>},</p>
<p>{</p>
<p>"nameIdentifier": "xxxxxxx",</p>
<p>"nameIdentifierScheme": "CiNii",</p>
<p>"nameIdentifierURI": "https://ci.nii.ac.jp/"</p>
<p>},</p>
<p>{</p>
<p>"nameIdentifier": "zzzzzzz",</p>
<p>"nameIdentifierScheme": "KAKEN2",</p>
<p>"nameIdentifierURI": "https://kaken.nii.ac.jp/"</p>
<p>}</p>
<p>]</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617186476635": {</p>
<p>"attribute_name": "Access Rights",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_access_right": "open access",</p>
<p>"subitem_access_right_uri": "http://purl.org/coar/access_right/c_abf2"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617186499011": {</p>
<p>"attribute_name": "Rights",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_rights": "Rights Information",</p>
<p>"subitem_rights_language": "ja",</p>
<p>"subitem_rights_resource": "http://localhost"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617186609386": {</p>
<p>"attribute_name": "Subject",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_subject": "Sibject1",</p>
<p>"subitem_subject_language": "ja",</p>
<p>"subitem_subject_scheme": "Other",</p>
<p>"subitem_subject_uri": "http://localhost/"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617186626617": {</p>
<p>"attribute_name": "Description",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_description": "Description\nDescription\nDescription",</p>
<p>"subitem_description_language": "en",</p>
<p>"subitem_description_type": "Abstract"</p>
<p>},</p>
<p>{</p>
<p>"subitem_description": "概要\n概要\n概要\n概要",</p>
<p>"subitem_description_language": "ja",</p>
<p>"subitem_description_type": "Abstract"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617186643794": {</p>
<p>"attribute_name": "Publisher",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_publisher": "en",</p>
<p>"subitem_publisher_languag": "Publisher"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617186660861": {</p>
<p>"attribute_name": "Date",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_date_issued_datetime": "2021-06-30",</p>
<p>"subitem_date_issued_type": "Available"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617186702042": {</p>
<p>"attribute_name": "Language",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_language": "jpn"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617186783814": {</p>
<p>"attribute_name": "Identifier",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_identifier_type": "URI",</p>
<p>"subitem_identifier_uri": "http://localhost"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617186859717": {</p>
<p>"attribute_name": "Temporal",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_temporal_languag": "en",</p>
<p>"subitem_temporal_text": "Temporal"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617186882738": {</p>
<p>"attribute_name": "Geo Location",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_geolocation_place": [</p>
<p>{</p>
<p>"subitem_geolocation_place_text": "Japan"</p>
<p>}</p>
<p>]</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617186901218": {</p>
<p>"attribute_name": "Funding Reference",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_award_numbers": {</p>
<p>"subitem_award_number": "Award Number",</p>
<p>"subitem_award_uri": "Award URI"</p>
<p>},</p>
<p>"subitem_award_titles": [</p>
<p>{</p>
<p>"subitem_award_title": "Award Title",</p>
<p>"subitem_award_title_language": "en"</p>
<p>}</p>
<p>],</p>
<p>"subitem_funder_identifiers": {</p>
<p>"subitem_funder_identifier": "http://xxx",</p>
<p>"subitem_funder_identifier_type": "ISNI"</p>
<p>},</p>
<p>"subitem_funder_names": [</p>
<p>{</p>
<p>"subitem_funder_name": "Funder Name",</p>
<p>"subitem_funder_name_language": "en"</p>
<p>}</p>
<p>]</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617186920753": {</p>
<p>"attribute_name": "Source Identifier",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_source_identifier": "xxxx-xxxx-xxxx",</p>
<p>"subitem_source_identifier_type": "ISSN"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617186941041": {</p>
<p>"attribute_name": "Source Title",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_record_name": "Source Title",</p>
<p>"subitem_record_name_languag": "en"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617186959569": {</p>
<p>"attribute_name": "Volume Number",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_volume": "1"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617186981471": {</p>
<p>"attribute_name": "Issue Number",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_issue": "111"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617186994930": {</p>
<p>"attribute_name": "Number of Pages",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_number_of_pages": "12"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617187024783": {</p>
<p>"attribute_name": "Page Start",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_start_page": "1"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617187045071": {</p>
<p>"attribute_name": "Page End",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_end_page": "3"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617187112279": {</p>
<p>"attribute_name": "Degree Name",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_degreename": "en",</p>
<p>"subitem_issue": "Degree Name"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617187136212": {</p>
<p>"attribute_name": "Date Granted",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_dategranted": "2021-06-30"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617187187528": {</p>
<p>"attribute_name": "Conference",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_conference_country": "JPN",</p>
<p>"subitem_conference_date": {</p>
<p>"subitem_conference_date_language": "ja",</p>
<p>"subitem_conference_end_day": "1",</p>
<p>"subitem_conference_end_month": "12",</p>
<p>"subitem_conference_end_year": "2020",</p>
<p>"subitem_conference_period": "2020/12/11",</p>
<p>"subitem_conference_start_day": "1",</p>
<p>"subitem_conference_start_month": "12",</p>
<p>"subitem_conference_start_year": "2000"</p>
<p>},</p>
<p>"subitem_conference_names": [</p>
<p>{</p>
<p>"subitem_conference_name": "Conference Name",</p>
<p>"subitem_conference_name_language": "ja"</p>
<p>}</p>
<p>],</p>
<p>"subitem_conference_places": [</p>
<p>{</p>
<p>"subitem_conference_place": "Conference Place",</p>
<p>"subitem_conference_place_language": "ja"</p>
<p>}</p>
<p>],</p>
<p>"subitem_conference_sequence": "1",</p>
<p>"subitem_conference_sponsors": [</p>
<p>{</p>
<p>"subitem_conference_sponsor": "Sponsor",</p>
<p>"subitem_conference_sponsor_language": "ja"</p>
<p>}</p>
<p>],</p>
<p>"subitem_conference_venues": [</p>
<p>{</p>
<p>"subitem_conference_venue": "Conference Venue",</p>
<p>"subitem_conference_venue_language": "ja"</p>
<p>}</p>
<p>]</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617258105262": {</p>
<p>"attribute_name": "Resource Type",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"resourcetype": "conference paper",</p>
<p>"resourceuri": "http://purl.org/coar/resource_type/c_5794"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617265215918": {</p>
<p>"attribute_name": "Version Type",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_version_resource": "http://purl.org/coar/version/c_b1a7d7d4d402bcce",</p>
<p>"subitem_version_type": "AO"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617349709064": {</p>
<p>"attribute_name": "Contributor",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"contributorMails": [</p>
<p>{</p>
<p>"contributorMail": "wekosoftware@nii.ac.jp"</p>
<p>}</p>
<p>],</p>
<p>"contributorNames": [</p>
<p>{</p>
<p>"contributorName": "情報, 太郎",</p>
<p>"lang": "ja"</p>
<p>},</p>
<p>{</p>
<p>"contributorName": "ジョウホウ\t タロウ",</p>
<p>"lang": "ja-Kana"</p>
<p>},</p>
<p>{</p>
<p>"contributorName": "Joho\t Taro",</p>
<p>"lang": "en"</p>
<p>}</p>
<p>],</p>
<p>"contributorType": "ContactPerson",</p>
<p>"familyNames": [</p>
<p>{</p>
<p>"familyName": "情報",</p>
<p>"familyNameLang": "ja"</p>
<p>},</p>
<p>{</p>
<p>"familyName": "ジョウホウ",</p>
<p>"familyNameLang": "ja-Kana"</p>
<p>},</p>
<p>{</p>
<p>"familyName": "Joho",</p>
<p>"familyNameLang": "en"</p>
<p>}</p>
<p>],</p>
<p>"givenNames": [</p>
<p>{</p>
<p>"givenName": "太郎",</p>
<p>"givenNameLang": "ja"</p>
<p>},</p>
<p>{</p>
<p>"givenName": "タロウ",</p>
<p>"givenNameLang": "ja-Kana"</p>
<p>},</p>
<p>{</p>
<p>"givenName": "Taro",</p>
<p>"givenNameLang": "en"</p>
<p>}</p>
<p>],</p>
<p>"nameIdentifiers": [</p>
<p>{</p>
<p>"nameIdentifier": "xxxxxxx",</p>
<p>"nameIdentifierScheme": "ORCID",</p>
<p>"nameIdentifierURI": "https://orcid.org/"</p>
<p>},</p>
<p>{</p>
<p>"nameIdentifier": "xxxxxxx",</p>
<p>"nameIdentifierScheme": "CiNii",</p>
<p>"nameIdentifierURI": "https://ci.nii.ac.jp/"</p>
<p>},</p>
<p>{</p>
<p>"nameIdentifier": "xxxxxxx",</p>
<p>"nameIdentifierScheme": "KAKEN2",</p>
<p>"nameIdentifierURI": "https://kaken.nii.ac.jp/"</p>
<p>}</p>
<p>]</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617349808926": {</p>
<p>"attribute_name": "Version",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_version": "Version"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617351524846": {</p>
<p>"attribute_name": "APC",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_apc": "Unknown"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617353299429": {</p>
<p>"attribute_name": "Relation",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_relation_name": [</p>
<p>{</p>
<p>"subitem_relation_name_language": "en",</p>
<p>"subitem_relation_name_text": "Related Title"</p>
<p>}</p>
<p>],</p>
<p>"subitem_relation_type": "isVersionOf",</p>
<p>"subitem_relation_type_id": {</p>
<p>"subitem_relation_type_id_text": "xxxxx",</p>
<p>"subitem_relation_type_select": "arXiv"</p>
<p>}</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617605131499": {</p>
<p>"attribute_name": "File",</p>
<p>"attribute_type": "file",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"accessrole": "open_access",</p>
<p>"date": [</p>
<p>{</p>
<p>"dateType": "Available",</p>
<p>"dateValue": "2021-07-12"</p>
<p>}</p>
<p>],</p>
<p>"displaytype": "simple",</p>
<p>"filename": "1KB.pdf",</p>
<p>"filesize": [</p>
<p>{</p>
<p>"value": "1 KB"</p>
<p>}</p>
<p>],</p>
<p>"format": "text/plain",</p>
<p>"mimetype": "application/pdf",</p>
<p>"url": {</p>
<p>"url": "https://dev.ir.rcos.nii.ac.jp/record/1/files/1KB.pdf"</p>
<p>},</p>
<p>"version_id": "b1a73fe7-5325-4819-953b-722518118e3d"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617610673286": {</p>
<p>"attribute_name": "Rights Holder",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"nameIdentifiers": [</p>
<p>{</p>
<p>"nameIdentifier": "xxxxxx",</p>
<p>"nameIdentifierScheme": "ORCID",</p>
<p>"nameIdentifierURI": "https://orcid.org/"</p>
<p>}</p>
<p>],</p>
<p>"rightHolderNames": [</p>
<p>{</p>
<p>"rightHolderLanguage": "ja",</p>
<p>"rightHolderName": "Right Holder Name"</p>
<p>}</p>
<p>]</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617620223087": {</p>
<p>"attribute_name": "Heading",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_heading_banner_headline": "Banner Headline",</p>
<p>"subitem_heading_headline": "Subheading",</p>
<p>"subitem_heading_language": "ja"</p>
<p>},</p>
<p>{</p>
<p>"subitem_heading_banner_headline": "Banner Headline",</p>
<p>"subitem_heading_headline": "Subheding",</p>
<p>"subitem_heading_language": "en"</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_1617944105607": {</p>
<p>"attribute_name": "Degree Grantor",</p>
<p>"attribute_value_mlt": [</p>
<p>{</p>
<p>"subitem_degreegrantor": [</p>
<p>{</p>
<p>"subitem_degreegrantor_language": "en",</p>
<p>"subitem_degreegrantor_name": "Degree Grantor Name"</p>
<p>}</p>
<p>],</p>
<p>"subitem_degreegrantor_identifie": [</p>
<p>{</p>
<p>"subitem_degreegrantor_identifier_name": "xxxxxx",</p>
<p>"subitem_degreegrantor_identifier_scheme": "kakenhi"</p>
<p>}</p>
<p>]</p>
<p>}</p>
<p>]</p>
<p>},</p>
<p>"item_title": "public-item-0-public-oai-guest-1-ja",</p>
<p>"item_type_id": "15",</p>
<p>"owner": "1",</p>
<p>"path": [</p>
<p>"1"</p>
<p>],</p>
<p>"pubdate": {</p>
<p>"attribute_name": "PubDate",</p>
<p>"attribute_value": "2021-11-20"</p>
<p>},</p>
<p>"publish_date": "2021-11-20",</p>
<p>"publish_status": "0",</p>
<p>"relation_version_is_last": true,</p>
<p>"title": [</p>
<p>"public-item-0-public-oai-guest-1-ja"</p>
<p>],</p>
<p>"weko_shared_id": -1</p>
<p>},</p>
<p>"_oai": {</p>
<p>"id": "oai:weko3.example.org:00000001",</p>
<p>"sets": [</p>
<p>"1"</p>
<p>]</p>
<p>},</p>
<p>"accessRights": [</p>
<p>"open access"</p>
<p>],</p>
<p>"alternative": [</p>
<p>"Alternative Title",</p>
<p>"Alternative Title"</p>
<p>],</p>
<p>"apc": [</p>
<p>"Unknown"</p>
<p>],</p>
<p>"author_link": [</p>
<p>"4"</p>
<p>],</p>
<p>"conference": {</p>
<p>"conferenceCountry": [</p>
<p>"JPN"</p>
<p>],</p>
<p>"conferenceDate": [</p>
<p>"2020/12/11"</p>
<p>],</p>
<p>"conferenceName": [</p>
<p>"Conference Name"</p>
<p>],</p>
<p>"conferenceSequence": [</p>
<p>"1"</p>
<p>],</p>
<p>"conferenceSponsor": [</p>
<p>"Sponsor"</p>
<p>],</p>
<p>"conferenceVenue": [</p>
<p>"Conference Venue"</p>
<p>]</p>
<p>},</p>
<p>"contributor": {</p>
<p>"@attributes": {</p>
<p>"contributorType": [</p>
<p>[</p>
<p>"ContactPerson"</p>
<p>]</p>
<p>]</p>
<p>},</p>
<p>"affiliation": {</p>
<p>"affiliationName": [],</p>
<p>"nameIdentifier": []</p>
<p>},</p>
<p>"contributorAlternative": [],</p>
<p>"contributorName": [</p>
<p>"情報, 太郎",</p>
<p>"ジョウホウ\t タロウ",</p>
<p>"Joho\t Taro"</p>
<p>],</p>
<p>"familyName": [</p>
<p>"情報",</p>
<p>"ジョウホウ",</p>
<p>"Joho"</p>
<p>],</p>
<p>"givenName": [</p>
<p>"太郎",</p>
<p>"タロウ",</p>
<p>"Taro"</p>
<p>],</p>
<p>"nameIdentifier": [</p>
<p>"xxxxxxx",</p>
<p>"xxxxxxx",</p>
<p>"xxxxxxx"</p>
<p>]</p>
<p>},</p>
<p>"control_number": "1",</p>
<p>"creator": {</p>
<p>"affiliation": {</p>
<p>"affiliationName": [</p>
<p>"University"</p>
<p>],</p>
<p>"nameIdentifier": [</p>
<p>"0000000121691048"</p>
<p>]</p>
<p>},</p>
<p>"creatorAlternative": [],</p>
<p>"creatorName": [</p>
<p>"情報, 太郎",</p>
<p>"ジョウホウ\t タロウ",</p>
<p>"Joho\t Taro",</p>
<p>"情報, 太郎",</p>
<p>"ジョウホウ\t タロウ",</p>
<p>"Joho\t Taro",</p>
<p>"情報, 太郎",</p>
<p>"ジョウホウ\t タロウ",</p>
<p>"Joho\t Taro"</p>
<p>],</p>
<p>"familyName": [</p>
<p>"情報",</p>
<p>"ジョウホウ",</p>
<p>"Joho",</p>
<p>"情報",</p>
<p>"ジョウホウ",</p>
<p>"Joho",</p>
<p>"情報",</p>
<p>"ジョウホウ",</p>
<p>"Joho"</p>
<p>],</p>
<p>"givenName": [</p>
<p>"太郎",</p>
<p>"タロウ",</p>
<p>"Taro",</p>
<p>"太郎",</p>
<p>"タロウ",</p>
<p>"Taro",</p>
<p>"太郎",</p>
<p>"タロウ",</p>
<p>"Taro"</p>
<p>],</p>
<p>"nameIdentifier": [</p>
<p>"4",</p>
<p>"xxxxxxx",</p>
<p>"xxxxxxx",</p>
<p>"zzzzzzz",</p>
<p>"xxxxxxx",</p>
<p>"xxxxxxx",</p>
<p>"zzzzzzz",</p>
<p>"xxxxxxx",</p>
<p>"xxxxxxx",</p>
<p>"zzzzzzz"</p>
<p>]</p>
<p>},</p>
<p>"date": [</p>
<p>{</p>
<p>"dateType": "Available",</p>
<p>"value": "2021-06-30"</p>
<p>}</p>
<p>],</p>
<p>"dateGranted": [</p>
<p>"2021-06-30"</p>
<p>],</p>
<p>"degreeGrantor": {</p>
<p>"degreeGrantorName": [</p>
<p>"Degree Grantor Name"</p>
<p>],</p>
<p>"nameIdentifier": [</p>
<p>"xxxxxx"</p>
<p>]</p>
<p>},</p>
<p>"degreeName": [</p>
<p>"en"</p>
<p>],</p>
<p>"description": [</p>
<p>{</p>
<p>"descriptionType": "Abstract",</p>
<p>"value": "Description\nDescription\nDescription"</p>
<p>},</p>
<p>{</p>
<p>"descriptionType": "Abstract",</p>
<p>"value": "概要\n概要\n概要\n概要"</p>
<p>}</p>
<p>],</p>
<p>"feedback_mail_list": [</p>
<p>{</p>
<p>"author_id": "",</p>
<p>"email": "wekosoftware@nii.ac.jp"</p>
<p>}</p>
<p>],</p>
<p>"fundingReference": {</p>
<p>"awardNumber": [</p>
<p>"Award Number"</p>
<p>],</p>
<p>"awardTitle": [</p>
<p>"Award Title"</p>
<p>],</p>
<p>"funderIdentifier": [</p>
<p>"http://xxx"</p>
<p>],</p>
<p>"funderName": [</p>
<p>"Funder Name"</p>
<p>]</p>
<p>},</p>
<p>"geoLocation": {</p>
<p>"geoLocationPlace": [</p>
<p>"Japan"</p>
<p>]</p>
<p>},</p>
<p>"identifier": [</p>
<p>{</p>
<p>"identifierType": "URI",</p>
<p>"value": "http://localhost"</p>
<p>}</p>
<p>],</p>
<p>"issue": [</p>
<p>"111"</p>
<p>],</p>
<p>"itemtype": "デフォルトアイテムタイプ（フル）",</p>
<p>"language": [</p>
<p>"jpn"</p>
<p>],</p>
<p>"numPages": [</p>
<p>"12"</p>
<p>],</p>
<p>"pageEnd": [</p>
<p>"3"</p>
<p>],</p>
<p>"pageStart": [</p>
<p>"1"</p>
<p>],</p>
<p>"path": [</p>
<p>"1"</p>
<p>],</p>
<p>"publish_date": "2021-11-20",</p>
<p>"publish_status": "0",</p>
<p>"publisher": [</p>
<p>"Publisher"</p>
<p>],</p>
<p>"relation": {</p>
<p>"@attributes": {</p>
<p>"relationType": [</p>
<p>[</p>
<p>"isVersionOf"</p>
<p>]</p>
<p>]</p>
<p>},</p>
<p>"relatedIdentifier": [</p>
<p>{</p>
<p>"identifierType": "arXiv",</p>
<p>"value": "xxxxx"</p>
<p>}</p>
<p>],</p>
<p>"relatedTitle": [</p>
<p>"Related Title"</p>
<p>]</p>
<p>},</p>
<p>"relation_version_is_last": true,</p>
<p>"rights": [</p>
<p>"Rights Information"</p>
<p>],</p>
<p>"rightsHolder": {</p>
<p>"nameIdentifier": [</p>
<p>"xxxxxx"</p>
<p>],</p>
<p>"rightsHolderName": [</p>
<p>"Right Holder Name"</p>
<p>]</p>
<p>},</p>
<p>"sourceIdentifier": [</p>
<p>{</p>
<p>"identifierType": "ISSN",</p>
<p>"value": "xxxx-xxxx-xxxx"</p>
<p>}</p>
<p>],</p>
<p>"sourceTitle": [</p>
<p>"Source Title"</p>
<p>],</p>
<p>"subject": [</p>
<p>{</p>
<p>"subjectScheme": "Other",</p>
<p>"value": "Sibject1"</p>
<p>}</p>
<p>],</p>
<p>"temporal": [</p>
<p>"Temporal"</p>
<p>],</p>
<p>"title": [</p>
<p>"public-item-0-public-oai-guest-1-en",</p>
<p>"public-item-0-public-oai-guest-1-ja"</p>
<p>],</p>
<p>"type": [</p>
<p>"conference paper"</p>
<p>],</p>
<p>"version": [</p>
<p>"Version"</p>
<p>],</p>
<p>"versiontype": [</p>
<p>"AO"</p>
<p>],</p>
<p>"volume": [</p>
<p>"1"</p>
<p>],</p>
<p>"weko_creator_id": "1",</p>
<p>"weko_shared_id": -1</p>
<p>},</p>
<p>"updated": "2023-11-15T02:46:32.217662+00:00"</p>
<p>}</p>
<p>],</p>
<p>"total": 1761</p>
<p>},</p>
<p>"links": {</p>
<p>"next": "https://dev.ir.rcos.nii.ac.jp/api/records/?page=2&amp;q=%E6%A6%82%E8%A6%81&amp;size=1",</p>
<p>"self": "https://dev.ir.rcos.nii.ac.jp/api/records/?page=1&amp;q=%E6%A6%82%E8%A6%81&amp;size=1"</p>
<p>}</p>
<p>}</p></td>
</tr>
</tbody>
</table>

  - 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>〇</td>
<td>〇</td>
<td>〇</td>
<td>〇</td>
<td>〇</td>
<td>〇</td>
</tr>
</tbody>
</table>

  - 機能内容

  - 関連モジュール

  - 処理概要

  - 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/11/14</p>
</blockquote></td>
<td>V0.9.27</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### インデックス検索用API

  - 目的・用途

インデックスIDを指定しての検索機能を提供する。

  - 利用方法

| **Method** | **HTTP request**   | **Description** |
| ---------- | ------------------ | --------------- |
|            | **GET /api/index** | アイテムを検索する       |

クエリパラメータ

| **GET /api/opensearch/search** |    |     |             |
| ------------------------------ | -- | --- | ----------- |
| パラメータ                          | 必須 | 値   | 説明          |
| q                              | 〇  | int | インデックスIDを指定 |

レスポンス例：



  - 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td>〇</td>
<td>〇</td>
<td>〇</td>
<td>〇</td>
<td>〇</td>
<td>〇</td>
</tr>
</tbody>
</table>

  - 機能内容

  - 関連モジュール

  - 処理概要

  - 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/11/14</p>
</blockquote></td>
<td>V0.9.27</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
### Render

<!-- end list -->

#### 目的・用途

他のウェブアプリがweko3のリソースにアクセスできるようAPI利用を承認することを目的としている。

#### 利用方法

API-8-5の機能を用いて、OAuthアプリケーション、またはトークンを登録する。その後、設定された値を利用してAPI接続の設定を行う。

#### 機能内容

/admin/itemtypes/{item type id}/render



#### 関連モジュール

#### 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>

### JSON Schema

  - 目的・用途

インデックスIDを指定しての検索機能を提供する。

  - 利用方法

| **Method** | **HTTP request**                         | **Description** |
| ---------- | ---------------------------------------- | --------------- |
|            | **GET /items/jsonschema/**{ITEMTYPE\_ID} | アイテムを検索する       |

パスパラメータ

| **GET /items/jsonschema/**{ITEMTYPE\_ID} |     |             |
| ---------------------------------------- | --- | ----------- |
| パラメータ                                    | 値   | 説明          |
| ITEMTYPE\_ID                             | int | インデックスIDを指定 |

レスポンス例：

<table>
<thead>
<tr class="header">
<th><strong>レスポンス例</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>/api/index/?q=9</strong></td>
</tr>
<tr class="even">
<td><p>{</p>
<p>"$schema":"http://json-schema.org/draft-04/schema#",</p>
<p>"description":"",</p>
<p>"properties":{</p>
<p>"item_1617186331708":{</p>
<p>"items":{</p>
<p>"properties":{</p>
<p>"subitem_1551255647225":{</p>
<p>"format":"text",</p>
<p>"title":"Title",</p>
<p>"title_i18n":{</p>
<p>"en":"Title",</p>
<p>"ja":"タイトル"</p>
<p>},</p>
<p>"type":"string"</p>
<p>},</p>
<p>"subitem_1551255648112":{</p>
<p>"currentEnum":[</p>
<p>"ja",</p>
<p>"ja-Kana",</p>
<p>"ja-Latn",</p>
<p>"en",</p>
<p>"fr",</p>
<p>"it",</p>
<p>"de",</p>
<p>"es",</p>
<p>"zh-cn",</p>
<p>"zh-tw",</p>
<p>"ru",</p>
<p>"la",</p>
<p>"ms",</p>
<p>"eo",</p>
<p>"ar",</p>
<p>"el",</p>
<p>"ko"</p>
<p>],</p>
<p>"enum":[</p>
<p>null,</p>
<p>"ja",</p>
<p>"ja-Kana",</p>
<p>"ja-Latn",</p>
<p>"en",</p>
<p>"fr",</p>
<p>"it",</p>
<p>"de",</p>
<p>"es",</p>
<p>"zh-cn",</p>
<p>"zh-tw",</p>
<p>"ru",</p>
<p>"la",</p>
<p>"ms",</p>
<p>"eo",</p>
<p>"ar",</p>
<p>"el",</p>
<p>"ko"</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"Language",</p>
<p>"type":[</p>
<p>"null",</p>
<p>"string"</p>
<p>]</p>
<p>}</p>
<p>},</p>
<p>"required":[</p>
<p>"subitem_1551255647225",</p>
<p>"subitem_1551255648112"</p>
<p>],</p>
<p>"type":"object"</p>
<p>},</p>
<p>"maxItems":9999,</p>
<p>"minItems":1,</p>
<p>"title":"Title",</p>
<p>"type":"array"</p>
<p>},</p>
<p>"item_1617186419668":{</p>
<p>"items":{</p>
<p>"properties":{</p>
<p>"creatorAffiliations":{</p>
<p>"format":"array",</p>
<p>"items":{</p>
<p>"format":"object",</p>
<p>"properties":{</p>
<p>"affiliationNameIdentifiers":{</p>
<p>"format":"array",</p>
<p>"items":{</p>
<p>"format":"object",</p>
<p>"properties":{</p>
<p>"affiliationNameIdentifier":{</p>
<p>"format":"text",</p>
<p>"title":"所属機関識別子",</p>
<p>"title_i18n":{</p>
<p>"en":"Affiliation Name Identifier",</p>
<p>"ja":"所属機関識別子"</p>
<p>},</p>
<p>"type":"string"</p>
<p>},</p>
<p>"affiliationNameIdentifierScheme":{</p>
<p>"currentEnum":[</p>
<p>"kakenhi",</p>
<p>"ISNI",</p>
<p>"Ringgold",</p>
<p>"GRID"</p>
<p>],</p>
<p>"enum":[</p>
<p>null,</p>
<p>"kakenhi",</p>
<p>"ISNI",</p>
<p>"Ringgold",</p>
<p>"GRID"</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"所属機関識別子スキーマ",</p>
<p>"type":[</p>
<p>"null",</p>
<p>"string"</p>
<p>]</p>
<p>},</p>
<p>"affiliationNameIdentifierURI":{</p>
<p>"format":"text",</p>
<p>"title":"所属機関識別子URI",</p>
<p>"title_i18n":{</p>
<p>"en":"Affiliation Name Identifier URI",</p>
<p>"ja":"所属機関識別子URI"</p>
<p>},</p>
<p>"type":"string"</p>
<p>}</p>
<p>},</p>
<p>"type":"object"</p>
<p>},</p>
<p>"title":"所属機関識別子",</p>
<p>"type":"array"</p>
<p>},</p>
<p>"affiliationNames":{</p>
<p>"format":"array",</p>
<p>"items":{</p>
<p>"format":"object",</p>
<p>"properties":{</p>
<p>"affiliationName":{</p>
<p>"format":"text",</p>
<p>"title":"所属機関名",</p>
<p>"title_i18n":{</p>
<p>"en":"Affiliation Name",</p>
<p>"ja":"所属機関名"</p>
<p>},</p>
<p>"type":"string"</p>
<p>},</p>
<p>"affiliationNameLang":{</p>
<p>"currentEnum":[</p>
<p>"ja",</p>
<p>"ja-Kana",</p>
<p>"ja-Latn",</p>
<p>"en",</p>
<p>"fr",</p>
<p>"it",</p>
<p>"de",</p>
<p>"es",</p>
<p>"zh-cn",</p>
<p>"zh-tw",</p>
<p>"ru",</p>
<p>"la",</p>
<p>"ms",</p>
<p>"eo",</p>
<p>"ar",</p>
<p>"el",</p>
<p>"ko"</p>
<p>],</p>
<p>"enum":[</p>
<p>null,</p>
<p>"ja",</p>
<p>"ja-Kana",</p>
<p>"ja-Latn",</p>
<p>"en",</p>
<p>"fr",</p>
<p>"it",</p>
<p>"de",</p>
<p>"es",</p>
<p>"zh-cn",</p>
<p>"zh-tw",</p>
<p>"ru",</p>
<p>"la",</p>
<p>"ms",</p>
<p>"eo",</p>
<p>"ar",</p>
<p>"el",</p>
<p>"ko"</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"言語",</p>
<p>"type":[</p>
<p>"null",</p>
<p>"string"</p>
<p>]</p>
<p>}</p>
<p>},</p>
<p>"type":"object"</p>
<p>},</p>
<p>"title":"所属機関名",</p>
<p>"type":"array"</p>
<p>}</p>
<p>},</p>
<p>"type":"object"</p>
<p>},</p>
<p>"title":"作成者所属",</p>
<p>"type":"array"</p>
<p>},</p>
<p>"creatorAlternatives":{</p>
<p>"format":"array",</p>
<p>"items":{</p>
<p>"format":"object",</p>
<p>"properties":{</p>
<p>"creatorAlternative":{</p>
<p>"format":"text",</p>
<p>"title":"別名",</p>
<p>"title_i18n":{</p>
<p>"en":"Alternative Name",</p>
<p>"ja":"別名"</p>
<p>},</p>
<p>"type":"string"</p>
<p>},</p>
<p>"creatorAlternativeLang":{</p>
<p>"currentEnum":[</p>
<p>"ja",</p>
<p>"ja-Kana",</p>
<p>"ja-Latn",</p>
<p>"en",</p>
<p>"fr",</p>
<p>"it",</p>
<p>"de",</p>
<p>"es",</p>
<p>"zh-cn",</p>
<p>"zh-tw",</p>
<p>"ru",</p>
<p>"la",</p>
<p>"ms",</p>
<p>"eo",</p>
<p>"ar",</p>
<p>"el",</p>
<p>"ko"</p>
<p>],</p>
<p>"enum":[</p>
<p>null,</p>
<p>"ja",</p>
<p>"ja-Kana",</p>
<p>"ja-Latn",</p>
<p>"en",</p>
<p>"fr",</p>
<p>"it",</p>
<p>"de",</p>
<p>"es",</p>
<p>"zh-cn",</p>
<p>"zh-tw",</p>
<p>"ru",</p>
<p>"la",</p>
<p>"ms",</p>
<p>"eo",</p>
<p>"ar",</p>
<p>"el",</p>
<p>"ko"</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"言語",</p>
<p>"type":[</p>
<p>"null",</p>
<p>"string"</p>
<p>]</p>
<p>}</p>
<p>},</p>
<p>"type":"object"</p>
<p>},</p>
<p>"title":"作成者別名",</p>
<p>"type":"array"</p>
<p>},</p>
<p>"creatorMails":{</p>
<p>"format":"array",</p>
<p>"items":{</p>
<p>"format":"object",</p>
<p>"properties":{</p>
<p>"creatorMail":{</p>
<p>"format":"text",</p>
<p>"title":"メールアドレス",</p>
<p>"title_i18n":{</p>
<p>"en":"Email Address",</p>
<p>"ja":"メールアドレス"</p>
<p>},</p>
<p>"type":"string"</p>
<p>}</p>
<p>},</p>
<p>"type":"object"</p>
<p>},</p>
<p>"title":"作成者メールアドレス",</p>
<p>"type":"array"</p>
<p>},</p>
<p>"creatorNames":{</p>
<p>"format":"array",</p>
<p>"items":{</p>
<p>"format":"object",</p>
<p>"properties":{</p>
<p>"creatorName":{</p>
<p>"format":"text",</p>
<p>"title":"姓名",</p>
<p>"title_i18n":{</p>
<p>"en":"Name",</p>
<p>"ja":"姓名"</p>
<p>},</p>
<p>"type":"string"</p>
<p>},</p>
<p>"creatorNameLang":{</p>
<p>"currentEnum":[</p>
<p>"ja",</p>
<p>"ja-Kana",</p>
<p>"ja-Latn",</p>
<p>"en",</p>
<p>"fr",</p>
<p>"it",</p>
<p>"de",</p>
<p>"es",</p>
<p>"zh-cn",</p>
<p>"zh-tw",</p>
<p>"ru",</p>
<p>"la",</p>
<p>"ms",</p>
<p>"eo",</p>
<p>"ar",</p>
<p>"el",</p>
<p>"ko"</p>
<p>],</p>
<p>"enum":[</p>
<p>null,</p>
<p>"ja",</p>
<p>"ja-Kana",</p>
<p>"ja-Latn",</p>
<p>"en",</p>
<p>"fr",</p>
<p>"it",</p>
<p>"de",</p>
<p>"es",</p>
<p>"zh-cn",</p>
<p>"zh-tw",</p>
<p>"ru",</p>
<p>"la",</p>
<p>"ms",</p>
<p>"eo",</p>
<p>"ar",</p>
<p>"el",</p>
<p>"ko"</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"言語",</p>
<p>"type":[</p>
<p>"null",</p>
<p>"string"</p>
<p>]</p>
<p>}</p>
<p>},</p>
<p>"type":"object"</p>
<p>},</p>
<p>"title":"作成者姓名",</p>
<p>"type":"array"</p>
<p>},</p>
<p>"familyNames":{</p>
<p>"format":"array",</p>
<p>"items":{</p>
<p>"format":"object",</p>
<p>"properties":{</p>
<p>"familyName":{</p>
<p>"format":"text",</p>
<p>"title":"姓",</p>
<p>"title_i18n":{</p>
<p>"en":"Family Name",</p>
<p>"ja":"姓"</p>
<p>},</p>
<p>"type":"string"</p>
<p>},</p>
<p>"familyNameLang":{</p>
<p>"currentEnum":[</p>
<p>"ja",</p>
<p>"ja-Kana",</p>
<p>"ja-Latn",</p>
<p>"en",</p>
<p>"fr",</p>
<p>"it",</p>
<p>"de",</p>
<p>"es",</p>
<p>"zh-cn",</p>
<p>"zh-tw",</p>
<p>"ru",</p>
<p>"la",</p>
<p>"ms",</p>
<p>"eo",</p>
<p>"ar",</p>
<p>"el",</p>
<p>"ko"</p>
<p>],</p>
<p>"enum":[</p>
<p>null,</p>
<p>"ja",</p>
<p>"ja-Kana",</p>
<p>"ja-Latn",</p>
<p>"en",</p>
<p>"fr",</p>
<p>"it",</p>
<p>"de",</p>
<p>"es",</p>
<p>"zh-cn",</p>
<p>"zh-tw",</p>
<p>"ru",</p>
<p>"la",</p>
<p>"ms",</p>
<p>"eo",</p>
<p>"ar",</p>
<p>"el",</p>
<p>"ko"</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"言語",</p>
<p>"type":[</p>
<p>"null",</p>
<p>"string"</p>
<p>]</p>
<p>}</p>
<p>},</p>
<p>"type":"object"</p>
<p>},</p>
<p>"title":"作成者姓",</p>
<p>"type":"array"</p>
<p>},</p>
<p>"givenNames":{</p>
<p>"format":"array",</p>
<p>"items":{</p>
<p>"format":"object",</p>
<p>"properties":{</p>
<p>"givenName":{</p>
<p>"format":"text",</p>
<p>"title":"名",</p>
<p>"title_i18n":{</p>
<p>"en":"Given Name",</p>
<p>"ja":"名"</p>
<p>},</p>
<p>"type":"string"</p>
<p>},</p>
<p>"givenNameLang":{</p>
<p>"currentEnum":[</p>
<p>"ja",</p>
<p>"ja-Kana",</p>
<p>"ja-Latn",</p>
<p>"en",</p>
<p>"fr",</p>
<p>"it",</p>
<p>"de",</p>
<p>"es",</p>
<p>"zh-cn",</p>
<p>"zh-tw",</p>
<p>"ru",</p>
<p>"la",</p>
<p>"ms",</p>
<p>"eo",</p>
<p>"ar",</p>
<p>"el",</p>
<p>"ko"</p>
<p>],</p>
<p>"enum":[</p>
<p>null,</p>
<p>"ja",</p>
<p>"ja-Kana",</p>
<p>"ja-Latn",</p>
<p>"en",</p>
<p>"fr",</p>
<p>"it",</p>
<p>"de",</p>
<p>"es",</p>
<p>"zh-cn",</p>
<p>"zh-tw",</p>
<p>"ru",</p>
<p>"la",</p>
<p>"ms",</p>
<p>"eo",</p>
<p>"ar",</p>
<p>"el",</p>
<p>"ko"</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"言語",</p>
<p>"type":[</p>
<p>"null",</p>
<p>"string"</p>
<p>]</p>
<p>}</p>
<p>},</p>
<p>"type":"object"</p>
<p>},</p>
<p>"title":"作成者名",</p>
<p>"type":"array"</p>
<p>},</p>
<p>"iscreator":{</p>
<p>"format":"text",</p>
<p>"title":"iscreator",</p>
<p>"title_i18n":{</p>
<p>"en":"",</p>
<p>"ja":""</p>
<p>},</p>
<p>"type":"string"</p>
<p>},</p>
<p>"nameIdentifiers":{</p>
<p>"format":"array",</p>
<p>"items":{</p>
<p>"format":"object",</p>
<p>"properties":{</p>
<p>"nameIdentifier":{</p>
<p>"format":"text",</p>
<p>"title":"作成者識別子",</p>
<p>"title_i18n":{</p>
<p>"en":"Creator Identifier",</p>
<p>"ja":"作成者識別子"</p>
<p>},</p>
<p>"type":"string"</p>
<p>},</p>
<p>"nameIdentifierScheme":{</p>
<p>"currentEnum":[</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"作成者識別子Scheme",</p>
<p>"type":[</p>
<p>"null",</p>
<p>"string"</p>
<p>]</p>
<p>},</p>
<p>"nameIdentifierURI":{</p>
<p>"format":"text",</p>
<p>"title":"作成者識別子URI",</p>
<p>"title_i18n":{</p>
<p>"en":"Creator Identifier URI",</p>
<p>"ja":"作成者識別子URI"</p>
<p>},</p>
<p>"type":"string"</p>
<p>}</p>
<p>},</p>
<p>"type":"object"</p>
<p>},</p>
<p>"title":"作成者識別子",</p>
<p>"type":"array"</p>
<p>}</p>
<p>},</p>
<p>"type":"object"</p>
<p>},</p>
<p>"maxItems":9999,</p>
<p>"minItems":1,</p>
<p>"title":"Creator",</p>
<p>"type":"array"</p>
<p>},</p>
<p>"item_1617258105262":{</p>
<p>"properties":{</p>
<p>"resourcetype":{</p>
<p>"currentEnum":[</p>
<p>"conference paper",</p>
<p>"data paper",</p>
<p>"departmental bulletin paper",</p>
<p>"editorial",</p>
<p>"journal article",</p>
<p>"newspaper",</p>
<p>"periodical",</p>
<p>"review article",</p>
<p>"software paper",</p>
<p>"article",</p>
<p>"book",</p>
<p>"book part",</p>
<p>"cartographic material",</p>
<p>"map",</p>
<p>"conference object",</p>
<p>"conference proceedings",</p>
<p>"conference poster",</p>
<p>"aggregated data",</p>
<p>"clinical trial data",</p>
<p>"compiled data",</p>
<p>"encoded data",</p>
<p>"experimental data",</p>
<p>"genomic data",</p>
<p>"geospatial data",</p>
<p>"laboratory notebook",</p>
<p>"measurement and test data",</p>
<p>"observational data",</p>
<p>"recorded data",</p>
<p>"simulation data",</p>
<p>"survey data",</p>
<p>"dataset",</p>
<p>"interview",</p>
<p>"image",</p>
<p>"still image",</p>
<p>"moving image",</p>
<p>"video",</p>
<p>"lecture",</p>
<p>"patent",</p>
<p>"internal report",</p>
<p>"report",</p>
<p>"research report",</p>
<p>"technical report",</p>
<p>"policy report",</p>
<p>"report part",</p>
<p>"working paper",</p>
<p>"data management plan",</p>
<p>"sound",</p>
<p>"thesis",</p>
<p>"bachelor thesis",</p>
<p>"master thesis",</p>
<p>"doctoral thesis",</p>
<p>"interactive resource",</p>
<p>"learning object",</p>
<p>"manuscript",</p>
<p>"musical notation",</p>
<p>"research proposal",</p>
<p>"software",</p>
<p>"technical documentation",</p>
<p>"workflow",</p>
<p>"other"</p>
<p>],</p>
<p>"enum":[</p>
<p>null,</p>
<p>"conference paper",</p>
<p>"data paper",</p>
<p>"departmental bulletin paper",</p>
<p>"editorial",</p>
<p>"journal article",</p>
<p>"newspaper",</p>
<p>"periodical",</p>
<p>"review article",</p>
<p>"software paper",</p>
<p>"article",</p>
<p>"book",</p>
<p>"book part",</p>
<p>"cartographic material",</p>
<p>"map",</p>
<p>"conference object",</p>
<p>"conference proceedings",</p>
<p>"conference poster",</p>
<p>"aggregated data",</p>
<p>"clinical trial data",</p>
<p>"compiled data",</p>
<p>"encoded data",</p>
<p>"experimental data",</p>
<p>"genomic data",</p>
<p>"geospatial data",</p>
<p>"laboratory notebook",</p>
<p>"measurement and test data",</p>
<p>"observational data",</p>
<p>"recorded data",</p>
<p>"simulation data",</p>
<p>"survey data",</p>
<p>"dataset",</p>
<p>"interview",</p>
<p>"image",</p>
<p>"still image",</p>
<p>"moving image",</p>
<p>"video",</p>
<p>"lecture",</p>
<p>"patent",</p>
<p>"internal report",</p>
<p>"report",</p>
<p>"research report",</p>
<p>"technical report",</p>
<p>"policy report",</p>
<p>"report part",</p>
<p>"working paper",</p>
<p>"data management plan",</p>
<p>"sound",</p>
<p>"thesis",</p>
<p>"bachelor thesis",</p>
<p>"master thesis",</p>
<p>"doctoral thesis",</p>
<p>"interactive resource",</p>
<p>"learning object",</p>
<p>"manuscript",</p>
<p>"musical notation",</p>
<p>"research proposal",</p>
<p>"software",</p>
<p>"technical documentation",</p>
<p>"workflow",</p>
<p>"other"</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"資源タイプ",</p>
<p>"type":[</p>
<p>"null",</p>
<p>"string"</p>
<p>]</p>
<p>},</p>
<p>"resourceuri":{</p>
<p>"format":"text",</p>
<p>"title":"資源タイプ識別子",</p>
<p>"title_i18n":{</p>
<p>"en":"Resource Type Identifier",</p>
<p>"ja":"資源タイプ識別子"</p>
<p>},</p>
<p>"type":"string"</p>
<p>}</p>
<p>},</p>
<p>"required":[</p>
<p>"resourcetype",</p>
<p>"resourceuri"</p>
<p>],</p>
<p>"title":"Resource Type",</p>
<p>"type":"object"</p>
<p>},</p>
<p>"item_1617605131499":{</p>
<p>"items":{</p>
<p>"properties":{</p>
<p>"accessrole":{</p>
<p>"enum":[</p>
<p>"open_access",</p>
<p>"open_date",</p>
<p>"open_login",</p>
<p>"open_no"</p>
<p>],</p>
<p>"format":"radios",</p>
<p>"title":"アクセス",</p>
<p>"type":[</p>
<p>"null",</p>
<p>"string"</p>
<p>]</p>
<p>},</p>
<p>"date":{</p>
<p>"format":"array",</p>
<p>"items":{</p>
<p>"format":"object",</p>
<p>"properties":{</p>
<p>"dateType":{</p>
<p>"currentEnum":[</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"日付タイプ",</p>
<p>"type":[</p>
<p>"null",</p>
<p>"string"</p>
<p>]</p>
<p>},</p>
<p>"dateValue":{</p>
<p>"format":"datetime",</p>
<p>"title":"日付",</p>
<p>"title_i18n":{</p>
<p>"en":"",</p>
<p>"ja":""</p>
<p>},</p>
<p>"type":"string"</p>
<p>}</p>
<p>},</p>
<p>"type":"object"</p>
<p>},</p>
<p>"title":"オープンアクセスの日付",</p>
<p>"type":"array"</p>
<p>},</p>
<p>"displaytype":{</p>
<p>"currentEnum":[</p>
<p>"detail",</p>
<p>"simple",</p>
<p>"preview"</p>
<p>],</p>
<p>"enum":[</p>
<p>null,</p>
<p>"detail",</p>
<p>"simple",</p>
<p>"preview"</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"表示形式",</p>
<p>"type":[</p>
<p>"null",</p>
<p>"string"</p>
<p>]</p>
<p>},</p>
<p>"fileDate":{</p>
<p>"format":"array",</p>
<p>"items":{</p>
<p>"format":"object",</p>
<p>"properties":{</p>
<p>"fileDateType":{</p>
<p>"currentEnum":[</p>
<p>"Accepted",</p>
<p>"Collected",</p>
<p>"Copyrighted",</p>
<p>"Created",</p>
<p>"Issued",</p>
<p>"Submitted",</p>
<p>"Updated",</p>
<p>"Valid"</p>
<p>],</p>
<p>"enum":[</p>
<p>null,</p>
<p>"Accepted",</p>
<p>"Collected",</p>
<p>"Copyrighted",</p>
<p>"Created",</p>
<p>"Issued",</p>
<p>"Submitted",</p>
<p>"Updated",</p>
<p>"Valid"</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"日付タイプ",</p>
<p>"type":[</p>
<p>"null",</p>
<p>"string"</p>
<p>]</p>
<p>},</p>
<p>"fileDateValue":{</p>
<p>"format":"datetime",</p>
<p>"title":"日付",</p>
<p>"title_i18n":{</p>
<p>"en":"Date",</p>
<p>"ja":"日付"</p>
<p>},</p>
<p>"type":"string"</p>
<p>}</p>
<p>},</p>
<p>"type":"object"</p>
<p>},</p>
<p>"title":"日付",</p>
<p>"type":"array"</p>
<p>},</p>
<p>"filename":{</p>
<p>"format":"text",</p>
<p>"title":"表示名",</p>
<p>"title_i18n":{</p>
<p>"en":"FileName",</p>
<p>"ja":"表示名"</p>
<p>},</p>
<p>"type":"string"</p>
<p>},</p>
<p>"filesize":{</p>
<p>"format":"array",</p>
<p>"items":{</p>
<p>"format":"object",</p>
<p>"properties":{</p>
<p>"value":{</p>
<p>"format":"text",</p>
<p>"title":"サイズ",</p>
<p>"title_i18n":{</p>
<p>"en":"Size",</p>
<p>"ja":"サイズ"</p>
<p>},</p>
<p>"type":"string"</p>
<p>}</p>
<p>},</p>
<p>"type":"object"</p>
<p>},</p>
<p>"title":"サイズ",</p>
<p>"type":"array"</p>
<p>},</p>
<p>"format":{</p>
<p>"format":"text",</p>
<p>"title":"フォーマット",</p>
<p>"title_i18n":{</p>
<p>"en":"Format",</p>
<p>"ja":"フォーマット"</p>
<p>},</p>
<p>"type":"string"</p>
<p>},</p>
<p>"groups":{</p>
<p>"currentEnum":[</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"グループ",</p>
<p>"type":[</p>
<p>"null",</p>
<p>"string"</p>
<p>]</p>
<p>},</p>
<p>"licensefree":{</p>
<p>"format":"textarea",</p>
<p>"title":"自由ライセンス",</p>
<p>"title_i18n":{</p>
<p>"en":"自由ライセンス",</p>
<p>"ja":"自由ライセンス"</p>
<p>},</p>
<p>"type":"string"</p>
<p>},</p>
<p>"licensetype":{</p>
<p>"currentEnum":[</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"ライセンス",</p>
<p>"type":[</p>
<p>"null",</p>
<p>"string"</p>
<p>]</p>
<p>},</p>
<p>"url":{</p>
<p>"format":"object",</p>
<p>"properties":{</p>
<p>"label":{</p>
<p>"format":"text",</p>
<p>"title":"ラベル",</p>
<p>"title_i18n":{</p>
<p>"en":"Label",</p>
<p>"ja":"ラベル"</p>
<p>},</p>
<p>"type":"string"</p>
<p>},</p>
<p>"objectType":{</p>
<p>"currentEnum":[</p>
<p>"abstract",</p>
<p>"summary",</p>
<p>"fulltext",</p>
<p>"thumbnail",</p>
<p>"other"</p>
<p>],</p>
<p>"enum":[</p>
<p>null,</p>
<p>"abstract",</p>
<p>"summary",</p>
<p>"fulltext",</p>
<p>"thumbnail",</p>
<p>"other"</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"オブジェクトタイプ",</p>
<p>"type":[</p>
<p>"null",</p>
<p>"string"</p>
<p>]</p>
<p>},</p>
<p>"url":{</p>
<p>"format":"text",</p>
<p>"title":"本文URL",</p>
<p>"title_i18n":{</p>
<p>"en":"Text URL",</p>
<p>"ja":"本文URL"</p>
<p>},</p>
<p>"type":"string"</p>
<p>}</p>
<p>},</p>
<p>"title":"本文URL",</p>
<p>"type":"object"</p>
<p>},</p>
<p>"version":{</p>
<p>"format":"text",</p>
<p>"title":"バージョン情報",</p>
<p>"title_i18n":{</p>
<p>"en":"Version Information",</p>
<p>"ja":"バージョン情報"</p>
<p>},</p>
<p>"type":"string"</p>
<p>}</p>
<p>},</p>
<p>"type":"object"</p>
<p>},</p>
<p>"maxItems":9999,</p>
<p>"minItems":1,</p>
<p>"title":"File",</p>
<p>"type":"array"</p>
<p>},</p>
<p>"pubdate":{</p>
<p>"format":"datetime",</p>
<p>"title":"PubDate",</p>
<p>"type":"string"</p>
<p>},</p>
<p>"system_file":{</p>
<p>"format":"object",</p>
<p>"properties":{</p>
<p>"subitem_systemfile_datetime":{</p>
<p>"format":"array",</p>
<p>"items":{</p>
<p>"format":"object",</p>
<p>"properties":{</p>
<p>"subitem_systemfile_datetime_date":{</p>
<p>"format":"datetime",</p>
<p>"title":"SYSTEMFILE DateTime Date",</p>
<p>"type":"string"</p>
<p>},</p>
<p>"subitem_systemfile_datetime_type":{</p>
<p>"enum":[</p>
<p>"Accepted",</p>
<p>"Available",</p>
<p>"Collected",</p>
<p>"Copyrighted",</p>
<p>"Created",</p>
<p>"Issued",</p>
<p>"Submitted",</p>
<p>"Updated",</p>
<p>"Valid"</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"SYSTEMFILE DateTime Type",</p>
<p>"type":"string"</p>
<p>}</p>
<p>},</p>
<p>"type":"object"</p>
<p>},</p>
<p>"title":"SYSTEMFILE DateTime",</p>
<p>"type":"array"</p>
<p>},</p>
<p>"subitem_systemfile_filename":{</p>
<p>"format":"array",</p>
<p>"items":{</p>
<p>"format":"object",</p>
<p>"properties":{</p>
<p>"subitem_systemfile_filename_label":{</p>
<p>"format":"text",</p>
<p>"title":"SYSTEMFILE Filename Label",</p>
<p>"type":"string"</p>
<p>},</p>
<p>"subitem_systemfile_filename_type":{</p>
<p>"enum":[</p>
<p>"Abstract",</p>
<p>"Fulltext",</p>
<p>"Summary",</p>
<p>"Thumbnail",</p>
<p>"Other"</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"SYSTEMFILE Filename Type",</p>
<p>"type":"string"</p>
<p>},</p>
<p>"subitem_systemfile_filename_uri":{</p>
<p>"format":"text",</p>
<p>"title":"SYSTEMFILE Filename URI",</p>
<p>"type":"string"</p>
<p>}</p>
<p>},</p>
<p>"type":"object"</p>
<p>},</p>
<p>"title":"SYSTEMFILE Filename",</p>
<p>"type":"array"</p>
<p>},</p>
<p>"subitem_systemfile_mimetype":{</p>
<p>"format":"text",</p>
<p>"title":"SYSTEMFILE MimeType",</p>
<p>"type":"string"</p>
<p>},</p>
<p>"subitem_systemfile_size":{</p>
<p>"format":"text",</p>
<p>"title":"SYSTEMFILE Size",</p>
<p>"type":"string"</p>
<p>},</p>
<p>"subitem_systemfile_version":{</p>
<p>"format":"text",</p>
<p>"title":"SYSTEMFILE Version",</p>
<p>"type":"string"</p>
<p>}</p>
<p>},</p>
<p>"system_prop":true,</p>
<p>"title":"File Information",</p>
<p>"type":"object"</p>
<p>},</p>
<p>"system_identifier_doi":{</p>
<p>"format":"object",</p>
<p>"properties":{</p>
<p>"subitem_systemidt_identifier":{</p>
<p>"format":"text",</p>
<p>"title":"SYSTEMIDT Identifier",</p>
<p>"type":"string"</p>
<p>},</p>
<p>"subitem_systemidt_identifier_type":{</p>
<p>"enum":[</p>
<p>"DOI",</p>
<p>"HDL",</p>
<p>"URI"</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"SYSTEMIDT Identifier Type",</p>
<p>"type":"string"</p>
<p>}</p>
<p>},</p>
<p>"system_prop":true,</p>
<p>"title":"Persistent Identifier(DOI)",</p>
<p>"type":"object"</p>
<p>},</p>
<p>"system_identifier_hdl":{</p>
<p>"format":"object",</p>
<p>"properties":{</p>
<p>"subitem_systemidt_identifier":{</p>
<p>"format":"text",</p>
<p>"title":"SYSTEMIDT Identifier",</p>
<p>"type":"string"</p>
<p>},</p>
<p>"subitem_systemidt_identifier_type":{</p>
<p>"enum":[</p>
<p>"DOI",</p>
<p>"HDL",</p>
<p>"URI"</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"SYSTEMIDT Identifier Type",</p>
<p>"type":"string"</p>
<p>}</p>
<p>},</p>
<p>"system_prop":true,</p>
<p>"title":"Persistent Identifier(HDL)",</p>
<p>"type":"object"</p>
<p>},</p>
<p>"system_identifier_uri":{</p>
<p>"format":"object",</p>
<p>"properties":{</p>
<p>"subitem_systemidt_identifier":{</p>
<p>"format":"text",</p>
<p>"title":"SYSTEMIDT Identifier",</p>
<p>"type":"string"</p>
<p>},</p>
<p>"subitem_systemidt_identifier_type":{</p>
<p>"enum":[</p>
<p>"DOI",</p>
<p>"HDL",</p>
<p>"URI"</p>
<p>],</p>
<p>"format":"select",</p>
<p>"title":"SYSTEMIDT Identifier Type",</p>
<p>"type":"string"</p>
<p>}</p>
<p>},</p>
<p>"system_prop":true,</p>
<p>"title":"Persistent Identifier(URI)",</p>
<p>"type":"object"</p>
<p>}</p>
<p>},</p>
<p>"required":[</p>
<p>"pubdate",</p>
<p>"item_1617186331708",</p>
<p>"item_1617258105262"</p>
<p>],</p>
<p>"type":"object"</p>
<p>}</p></td>
</tr>
</tbody>
</table>

  - 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - 機能内容

  - 関連モジュール

  - 処理概要

  - 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/11/14</p>
</blockquote></td>
<td>V0.9.27</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>

### JSON Form

  - 目的・用途

インデックスIDを指定しての検索機能を提供する。

  - 利用方法

| **Method** | **HTTP request**                         | **Description** |
| ---------- | ---------------------------------------- | --------------- |
|            | **GET /items/schemaform/**{ITEMTYPE\_ID} | アイテムを検索する       |

パスパラメータ

| **GET /items/schemaform/**{ITEMTYPE\_ID} |     |             |
| ---------------------------------------- | --- | ----------- |
| パラメータ                                    | 値   | 説明          |
| ITEMTYPE\_ID                             | int | インデックスIDを指定 |

レスポンス例：

<table>
<thead>
<tr class="header">
<th><strong>レスポンス例</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>/items/schemaform/</strong>{ITEMTYPE_ID}</td>
</tr>
<tr class="even">
<td><p>[</p>
<p>{</p>
<p>"format":"yyyy-MM-dd",</p>
<p>"key":"pubdate",</p>
<p>"required":true,</p>
<p>"templateUrl":"/static/templates/weko_deposit/datepicker.html",</p>
<p>"title":"PubDate",</p>
<p>"title_i18n":{</p>
<p>"en":"PubDate",</p>
<p>"ja":"公開日"</p>
<p>},</p>
<p>"type":"template"</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186331708[].subitem_1551255647225",</p>
<p>"title":"Title",</p>
<p>"title_i18n":{</p>
<p>"en":"Title",</p>
<p>"ja":"タイトル"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Title",</p>
<p>"ja":"タイトル"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186331708[].subitem_1551255648112",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Kana",</p>
<p>"value":"ja-Kana"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186331708",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Title",</p>
<p>"title_i18n":{</p>
<p>"en":"Title",</p>
<p>"ja":"タイトル"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186385884[].subitem_1551255720400",</p>
<p>"title":"Alternative Title",</p>
<p>"title_i18n":{</p>
<p>"en":"Alternative Title",</p>
<p>"ja":"その他のタイトル"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Alternative Title",</p>
<p>"ja":"その他のタイトル"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186385884[].subitem_1551255721061",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Kana",</p>
<p>"value":"ja-Kana"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186385884",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Alternative Title",</p>
<p>"title_i18n":{</p>
<p>"en":"Alternative Title",</p>
<p>"ja":"その他のタイトル"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"icon":"glyphicon glyphicon-search",</p>
<p>"key":"item_1617186419668[].authorInputButton",</p>
<p>"onClick":"searchAuthor('item_1617186419668', true, form)",</p>
<p>"style":"btn-default pull-right m-top-5",</p>
<p>"title":"著者DBから入力",</p>
<p>"type":"button"</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186419668[].nameIdentifiers[].nameIdentifierScheme",</p>
<p>"title":"Creator Identifier Scheme",</p>
<p>"titleMap":[</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Creator Identifier Scheme",</p>
<p>"ja":"作成者識別子Scheme"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Creator Identifier Scheme",</p>
<p>"ja":"作成者識別子Scheme"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186419668[].nameIdentifiers[].nameIdentifierURI",</p>
<p>"title":"Creator Identifier URI",</p>
<p>"title_i18n":{</p>
<p>"en":"Creator Identifier URI",</p>
<p>"ja":"作成者識別子URI"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Creator Identifier URI",</p>
<p>"ja":"作成者識別子URI"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186419668[].nameIdentifiers[].nameIdentifier",</p>
<p>"title":"Creator Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Creator Identifier",</p>
<p>"ja":"作成者識別子"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Creator Identifier",</p>
<p>"ja":"作成者識別子"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186419668[].nameIdentifiers",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Creator Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Creator Identifier",</p>
<p>"ja":"作成者識別子"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Creator Identifier",</p>
<p>"ja":"作成者識別子"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186419668[].creatorNames[].creatorName",</p>
<p>"title":"Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Name",</p>
<p>"ja":"姓名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Name",</p>
<p>"ja":"姓名"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186419668[].creatorNames[].creatorNameLang",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Kana",</p>
<p>"value":"ja-Kana"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186419668[].creatorNames",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Creator Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Creator Name",</p>
<p>"ja":"作成者姓名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Creator Name",</p>
<p>"ja":"作成者姓名"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186419668[].familyNames[].familyName",</p>
<p>"title":"Family Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Family Name",</p>
<p>"ja":"姓"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Family Name",</p>
<p>"ja":"姓"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186419668[].familyNames[].familyNameLang",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Kana",</p>
<p>"value":"ja-Kana"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186419668[].familyNames",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Creator Family Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Creator Family Name",</p>
<p>"ja":"作成者姓"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Creator Family Name",</p>
<p>"ja":"作成者姓"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186419668[].givenNames[].givenName",</p>
<p>"title":"Given Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Given Name",</p>
<p>"ja":"名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Given Name",</p>
<p>"ja":"名"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186419668[].givenNames[].givenNameLang",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Kana",</p>
<p>"value":"ja-Kana"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186419668[].givenNames",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Creator Given Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Creator Given Name",</p>
<p>"ja":"作成者名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Creator Given Name",</p>
<p>"ja":"作成者名"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186419668[].creatorAlternatives[].creatorAlternative",</p>
<p>"title":"Alternative Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Alternative Name",</p>
<p>"ja":"別名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Alternative Name",</p>
<p>"ja":"別名"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186419668[].creatorAlternatives[].creatorAlternativeLang",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Kana",</p>
<p>"value":"ja-Kana"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186419668[].creatorAlternatives",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Creator Alternative Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Creator Alternative Name",</p>
<p>"ja":"作成者別名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Creator Alternative Name",</p>
<p>"ja":"作成者別名"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186419668[].creatorMails[].creatorMail",</p>
<p>"title":"Email Address",</p>
<p>"title_i18n":{</p>
<p>"en":"Email Address",</p>
<p>"ja":"メールアドレス"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Email Address",</p>
<p>"ja":"メールアドレス"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186419668[].creatorMails",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Creator Email Address",</p>
<p>"title_i18n":{</p>
<p>"en":"Creator Email Address",</p>
<p>"ja":"作成者メールアレス"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Creator Email Address",</p>
<p>"ja":"作成者メールアレス"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186419668[].creatorAffiliations[].affiliationNameIdentifiers[].affiliationNameIdentifier",</p>
<p>"title":"Affiliation Name Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Affiliation Name Identifier",</p>
<p>"ja":"所属機関識別子"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Affiliation Name Identifier",</p>
<p>"ja":"所属機関識別子"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186419668[].creatorAffiliations[].affiliationNameIdentifiers[].affiliationNameIdentifierScheme",</p>
<p>"title":"Affiliation Name Identifier Scheme",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"kakenhi",</p>
<p>"value":"kakenhi"</p>
<p>},</p>
<p>{</p>
<p>"name":"ISNI",</p>
<p>"value":"ISNI"</p>
<p>},</p>
<p>{</p>
<p>"name":"Ringgold",</p>
<p>"value":"Ringgold"</p>
<p>},</p>
<p>{</p>
<p>"name":"GRID",</p>
<p>"value":"GRID"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Affiliation Name Identifier Scheme",</p>
<p>"ja":"所属機関識別子スキーマ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Affiliation Name Identifier Scheme",</p>
<p>"ja":"所属機関識別子スキーマ"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186419668[].creatorAffiliations[].affiliationNameIdentifiers[].affiliationNameIdentifierURI",</p>
<p>"title":"Affiliation Name Identifier URI",</p>
<p>"title_i18n":{</p>
<p>"en":"Affiliation Name Identifier URI",</p>
<p>"ja":"所属機関識別子URI"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Affiliation Name Identifier URI",</p>
<p>"ja":"所属機関識別子URI"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186419668[].creatorAffiliations[].affiliationNameIdentifiers",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Affiliation Name Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Affiliation Name Identifier",</p>
<p>"ja":"所属機関識別子"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Affiliation Name Identifier",</p>
<p>"ja":"所属機関識別子"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186419668[].creatorAffiliations[].affiliationNames[].affiliationName",</p>
<p>"title":"Affiliation Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Affiliation Name",</p>
<p>"ja":"所属機関名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Affiliation Name",</p>
<p>"ja":"所属機関名"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186419668[].creatorAffiliations[].affiliationNames[].affiliationNameLang",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Kana",</p>
<p>"value":"ja-Kana"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186419668[].creatorAffiliations[].affiliationNames",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Affiliation Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Affiliation Name",</p>
<p>"ja":"所属機関名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Affiliation Name",</p>
<p>"ja":"所属機関名"</p>
<p>}</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186419668[].creatorAffiliations",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Affiliation Name Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Affiliation Name Identifier",</p>
<p>"ja":"作成者所属"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Affiliation Name Identifier",</p>
<p>"ja":"作成者所属"</p>
<p>}</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186419668",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Creator",</p>
<p>"title_i18n":{</p>
<p>"en":"Creator",</p>
<p>"ja":"作成者"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617349709064[].contributorType",</p>
<p>"title":"Contributor Type",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ContactPerson",</p>
<p>"value":"ContactPerson"</p>
<p>},</p>
<p>{</p>
<p>"name":"DataCollector",</p>
<p>"value":"DataCollector"</p>
<p>},</p>
<p>{</p>
<p>"name":"DataCurator",</p>
<p>"value":"DataCurator"</p>
<p>},</p>
<p>{</p>
<p>"name":"DataManager",</p>
<p>"value":"DataManager"</p>
<p>},</p>
<p>{</p>
<p>"name":"Distributor",</p>
<p>"value":"Distributor"</p>
<p>},</p>
<p>{</p>
<p>"name":"Editor",</p>
<p>"value":"Editor"</p>
<p>},</p>
<p>{</p>
<p>"name":"HostingInstitution",</p>
<p>"value":"HostingInstitution"</p>
<p>},</p>
<p>{</p>
<p>"name":"Producer",</p>
<p>"value":"Producer"</p>
<p>},</p>
<p>{</p>
<p>"name":"ProjectLeader",</p>
<p>"value":"ProjectLeader"</p>
<p>},</p>
<p>{</p>
<p>"name":"ProjectManager",</p>
<p>"value":"ProjectManager"</p>
<p>},</p>
<p>{</p>
<p>"name":"ProjectMember",</p>
<p>"value":"ProjectMember"</p>
<p>},</p>
<p>{</p>
<p>"name":"RelatedPerson",</p>
<p>"value":"RelatedPerson"</p>
<p>},</p>
<p>{</p>
<p>"name":"Researcher",</p>
<p>"value":"Researcher"</p>
<p>},</p>
<p>{</p>
<p>"name":"ResearchGroup",</p>
<p>"value":"ResearchGroup"</p>
<p>},</p>
<p>{</p>
<p>"name":"Sponsor",</p>
<p>"value":"Sponsor"</p>
<p>},</p>
<p>{</p>
<p>"name":"Supervisor",</p>
<p>"value":"Supervisor"</p>
<p>},</p>
<p>{</p>
<p>"name":"WorkPackageLeader",</p>
<p>"value":"WorkPackageLeader"</p>
<p>},</p>
<p>{</p>
<p>"name":"Other",</p>
<p>"value":"Other"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Contributor Type",</p>
<p>"ja":"寄与者タイプ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Contributor Type",</p>
<p>"ja":"寄与者タイプ"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617349709064[].nameIdentifiers[].nameIdentifierScheme",</p>
<p>"title":"Contributor Identifier Scheme",</p>
<p>"titleMap":[</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Contributor Identifier Scheme",</p>
<p>"ja":"寄与者識別子Scheme"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Contributor Identifier Scheme",</p>
<p>"ja":"寄与者識別子Scheme"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617349709064[].nameIdentifiers[].nameIdentifierURI",</p>
<p>"title":"Contributor Identifier URI",</p>
<p>"title_i18n":{</p>
<p>"en":"Contributor Identifier URI",</p>
<p>"ja":"寄与者識別子URI"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Contributor Identifier URI",</p>
<p>"ja":"寄与者識別子URI"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617349709064[].nameIdentifiers[].nameIdentifier",</p>
<p>"title":"Contributor Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Contributor Identifier",</p>
<p>"ja":"寄与者識別子"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Contributor Identifier",</p>
<p>"ja":"寄与者識別子"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617349709064[].nameIdentifiers",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Contributor Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Contributor Identifier",</p>
<p>"ja":"寄与者識別子"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Contributor Identifier",</p>
<p>"ja":"寄与者識別子"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617349709064[].contributorNames[].contributorName",</p>
<p>"title":"Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Name",</p>
<p>"ja":"姓名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Name",</p>
<p>"ja":"姓名"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617349709064[].contributorNames[].lang",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Kana",</p>
<p>"value":"ja-Kana"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617349709064[].contributorNames",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Contributor Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Contributor Name",</p>
<p>"ja":"寄与者姓名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Contributor Name",</p>
<p>"ja":"寄与者姓名"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617349709064[].familyNames[].familyName",</p>
<p>"title":"Family Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Family Name",</p>
<p>"ja":"姓"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Family Name",</p>
<p>"ja":"姓"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617349709064[].familyNames[].familyNameLang",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Kana",</p>
<p>"value":"ja-Kana"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617349709064[].familyNames",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Contributor Family Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Contributor Family Name",</p>
<p>"ja":"寄与者姓"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Contributor Family Name",</p>
<p>"ja":"寄与者姓"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617349709064[].givenNames[].givenName",</p>
<p>"title":"Given Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Given Name",</p>
<p>"ja":"名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Given Name",</p>
<p>"ja":"名"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617349709064[].givenNames[].givenNameLang",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Kana",</p>
<p>"value":"ja-Kana"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617349709064[].givenNames",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Contributor Given Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Contributor Given Name",</p>
<p>"ja":"寄与者名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Contributor Given Name",</p>
<p>"ja":"寄与者名"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617349709064[].contributorAlternatives[].contributorAlternative",</p>
<p>"title":"Alternative Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Alternative Name",</p>
<p>"ja":"別名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Alternative Name",</p>
<p>"ja":"別名"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617349709064[].contributorAlternatives[].contributorAlternativeLang",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Kana",</p>
<p>"value":"ja-Kana"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617349709064[].contributorAlternatives",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Contributor Alternative Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Contributor Alternative Name",</p>
<p>"ja":"寄与者別名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Contributor Alternative Name",</p>
<p>"ja":"寄与者別名"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617349709064[].contributorAffiliations[].contributorAffiliationNameIdentifiers[].contributorAffiliationNameIdentifier",</p>
<p>"title":"Affiliation Name Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Affiliation Name Identifier",</p>
<p>"ja":"所属機関識別子"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Affiliation Name Identifier",</p>
<p>"ja":"所属機関識別子"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617349709064[].contributorAffiliations[].contributorAffiliationNameIdentifiers[].contributorAffiliationScheme",</p>
<p>"title":"Affiliation Name Identifier Scheme",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"kakenhi",</p>
<p>"value":"kakenhi"</p>
<p>},</p>
<p>{</p>
<p>"name":"ISNI",</p>
<p>"value":"ISNI"</p>
<p>},</p>
<p>{</p>
<p>"name":"Ringgold",</p>
<p>"value":"Ringgold"</p>
<p>},</p>
<p>{</p>
<p>"name":"GRID",</p>
<p>"value":"GRID"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Affiliation Name Identifier Scheme",</p>
<p>"ja":"所属機関識別子スキーマ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Affiliation Name Identifier Scheme",</p>
<p>"ja":"所属機関識別子スキーマ"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617349709064[].contributorAffiliations[].contributorAffiliationNameIdentifiers[].contributorAffiliationURI",</p>
<p>"title":"Affiliation Name Identifier URI",</p>
<p>"title_i18n":{</p>
<p>"en":"Affiliation Name Identifier URI",</p>
<p>"ja":"所属機関識別子URI"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Affiliation Name Identifier URI",</p>
<p>"ja":"所属機関識別子URI"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617349709064[].contributorAffiliations[].contributorAffiliationNameIdentifiers",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Affiliation Name Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Affiliation Name Identifier",</p>
<p>"ja":"所属機関識別子"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Affiliation Name Identifier",</p>
<p>"ja":"所属機関識別子"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617349709064[].contributorAffiliations[].contributorAffiliationNames[].contributorAffiliationName",</p>
<p>"title":"Affiliation Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Affiliation Name",</p>
<p>"ja":"所属機関名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Affiliation Name",</p>
<p>"ja":"所属機関名"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617349709064[].contributorAffiliations[].contributorAffiliationNames[].contributorAffiliationNameLang",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Kana",</p>
<p>"value":"ja-Kana"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617349709064[].contributorAffiliations[].contributorAffiliationNames",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Affiliation Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Affiliation Name",</p>
<p>"ja":"所属機関名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Affiliation Name",</p>
<p>"ja":"所属機関名"</p>
<p>}</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617349709064[].contributorAffiliations",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Affiliation Name Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Affiliation Name Identifier",</p>
<p>"ja":"寄与者所属"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Affiliation Name Identifier",</p>
<p>"ja":"寄与者所属"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617349709064[].contributorMails[].contributorMail",</p>
<p>"title":"Email Address",</p>
<p>"title_i18n":{</p>
<p>"en":"Email Address",</p>
<p>"ja":"メールアドレス"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Email Address",</p>
<p>"ja":"メールアドレス"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617349709064[].contributorMails",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Contributor Email Address",</p>
<p>"title_i18n":{</p>
<p>"en":"Contributor Email Address",</p>
<p>"ja":"寄与者メールアドレス"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Contributor Email Address",</p>
<p>"ja":"寄与者メールアドレス"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"icon":"glyphicon glyphicon-search",</p>
<p>"key":"item_1617349709064[].authorInputButton",</p>
<p>"onClick":"searchAuthor('item_1617349709064', true, form)",</p>
<p>"style":"btn-default pull-right m-top-5",</p>
<p>"title":"著者DBから入力",</p>
<p>"type":"button"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617349709064",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Contributor",</p>
<p>"title_i18n":{</p>
<p>"en":"Contributor",</p>
<p>"ja":"寄与者"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186476635.subitem_1522299639480",</p>
<p>"onChange":"changedAccessRights(this, modelValue)",</p>
<p>"title":"Access Rights",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"embargoed access",</p>
<p>"value":"embargoed access"</p>
<p>},</p>
<p>{</p>
<p>"name":"metadata only access",</p>
<p>"value":"metadata only access"</p>
<p>},</p>
<p>{</p>
<p>"name":"open access",</p>
<p>"value":"open access"</p>
<p>},</p>
<p>{</p>
<p>"name":"restricted access",</p>
<p>"value":"restricted access"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Access Rights",</p>
<p>"ja":"アクセス権"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Access Rights",</p>
<p>"ja":"アクセス権"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"fieldHtmlClass":"txt-access-rights-uri",</p>
<p>"key":"item_1617186476635.subitem_1600958577026",</p>
<p>"readonly":true,</p>
<p>"title":"Access Rights URI",</p>
<p>"title_i18n":{</p>
<p>"en":"Access Rights URI",</p>
<p>"ja":"アクセス権URI"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Access Rights URI",</p>
<p>"ja":"アクセス権URI"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186476635",</p>
<p>"title":"Access Rights",</p>
<p>"title_i18n":{</p>
<p>"en":"Access Rights",</p>
<p>"ja":"アクセス権"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617351524846.subitem_1523260933860",</p>
<p>"title":"APC",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"Paid",</p>
<p>"value":"Paid"</p>
<p>},</p>
<p>{</p>
<p>"name":"Fully waived",</p>
<p>"value":"Fully waived"</p>
<p>},</p>
<p>{</p>
<p>"name":"Not required",</p>
<p>"value":"Not required"</p>
<p>},</p>
<p>{</p>
<p>"name":"Partially waived",</p>
<p>"value":"Partially waived"</p>
<p>},</p>
<p>{</p>
<p>"name":"Not charged",</p>
<p>"value":"Not charged"</p>
<p>},</p>
<p>{</p>
<p>"name":"Unknown",</p>
<p>"value":"Unknown"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"APC",</p>
<p>"ja":"APC"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617351524846",</p>
<p>"title":"APC",</p>
<p>"title_i18n":{</p>
<p>"en":"APC",</p>
<p>"ja":"APC"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186499011[].subitem_1522650717957",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186499011[].subitem_1522650727486",</p>
<p>"title":"Rights Information Resource",</p>
<p>"title_i18n":{</p>
<p>"en":"Rights Information Resource",</p>
<p>"ja":"権利情報Resource"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Rights Information Resource",</p>
<p>"ja":"権利情報Resource"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186499011[].subitem_1522651041219",</p>
<p>"title":"Rights Information",</p>
<p>"title_i18n":{</p>
<p>"en":"Rights Information",</p>
<p>"ja":"権利情報"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Rights Information",</p>
<p>"ja":"権利情報"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186499011",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Rights",</p>
<p>"title_i18n":{</p>
<p>"en":"Rights",</p>
<p>"ja":"権利情報"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617610673286[].nameIdentifiers[].nameIdentifierScheme",</p>
<p>"title":"Right Holder Identifier Scheme",</p>
<p>"titleMap":[</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Right Holder Identifier Scheme",</p>
<p>"ja":"権利者識別子Scheme"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Right Holder Identifier Scheme",</p>
<p>"ja":"権利者識別子Scheme"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617610673286[].nameIdentifiers[].nameIdentifierURI",</p>
<p>"title":"Right Holder Identifier URI",</p>
<p>"title_i18n":{</p>
<p>"en":"Right Holder Identifier URI",</p>
<p>"ja":"権利者識別子URI"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Right Holder Identifier URI",</p>
<p>"ja":"権利者識別子URI"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617610673286[].nameIdentifiers[].nameIdentifier",</p>
<p>"title":"Right Holder Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Right Holder Identifier",</p>
<p>"ja":"権利者識別子"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Right Holder Identifier",</p>
<p>"ja":"権利者識別子"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617610673286[].nameIdentifiers",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Right Holder Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Right Holder Identifier",</p>
<p>"ja":"権利者識別子"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Right Holder Identifier",</p>
<p>"ja":"権利者識別子"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617610673286[].rightHolderNames[].rightHolderLanguage",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Kana",</p>
<p>"value":"ja-Kana"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617610673286[].rightHolderNames[].rightHolderName",</p>
<p>"title":"Right Holder Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Right Holder Name",</p>
<p>"ja":"権利者名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Right Holder Name",</p>
<p>"ja":"権利者名"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617610673286[].rightHolderNames",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Right Holder Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Right Holder Name",</p>
<p>"ja":"権利者名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Right Holder Name",</p>
<p>"ja":"権利者名"</p>
<p>}</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617610673286",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Rights Holder",</p>
<p>"title_i18n":{</p>
<p>"en":"Rights Holder",</p>
<p>"ja":"権利者情報"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186609386[].subitem_1522299896455",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Kana",</p>
<p>"value":"ja-Kana"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186609386[].subitem_1522300014469",</p>
<p>"title":"Subject Scheme",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"BSH",</p>
<p>"value":"BSH"</p>
<p>},</p>
<p>{</p>
<p>"name":"DDC",</p>
<p>"value":"DDC"</p>
<p>},</p>
<p>{</p>
<p>"name":"LCC",</p>
<p>"value":"LCC"</p>
<p>},</p>
<p>{</p>
<p>"name":"LCSH",</p>
<p>"value":"LCSH"</p>
<p>},</p>
<p>{</p>
<p>"name":"MeSH",</p>
<p>"value":"MeSH"</p>
<p>},</p>
<p>{</p>
<p>"name":"NDC",</p>
<p>"value":"NDC"</p>
<p>},</p>
<p>{</p>
<p>"name":"NDLC",</p>
<p>"value":"NDLC"</p>
<p>},</p>
<p>{</p>
<p>"name":"NDLSH",</p>
<p>"value":"NDLSH"</p>
<p>},</p>
<p>{</p>
<p>"name":"SciVal",</p>
<p>"value":"SciVal"</p>
<p>},</p>
<p>{</p>
<p>"name":"UDC",</p>
<p>"value":"UDC"</p>
<p>},</p>
<p>{</p>
<p>"name":"Other",</p>
<p>"value":"Other"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Subject Scheme",</p>
<p>"ja":"主題Scheme"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Subject Scheme",</p>
<p>"ja":"主題Scheme"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186609386[].subitem_1522300048512",</p>
<p>"title":"Subject URI",</p>
<p>"title_i18n":{</p>
<p>"en":"Subject URI",</p>
<p>"ja":"主題URI"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Subject URI",</p>
<p>"ja":"主題URI"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186609386[].subitem_1523261968819",</p>
<p>"title":"Subject",</p>
<p>"title_i18n":{</p>
<p>"en":"Subject",</p>
<p>"ja":"主題"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Subject",</p>
<p>"ja":"主題"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186609386",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Subject",</p>
<p>"title_i18n":{</p>
<p>"en":"Subject",</p>
<p>"ja":"主題"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186626617[].subitem_description_type",</p>
<p>"title":"Description Type",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"Abstract",</p>
<p>"value":"Abstract"</p>
<p>},</p>
<p>{</p>
<p>"name":"Methods",</p>
<p>"value":"Methods"</p>
<p>},</p>
<p>{</p>
<p>"name":"TableOfContents",</p>
<p>"value":"TableOfContents"</p>
<p>},</p>
<p>{</p>
<p>"name":"TechnicalInfo",</p>
<p>"value":"TechnicalInfo"</p>
<p>},</p>
<p>{</p>
<p>"name":"Other",</p>
<p>"value":"Other"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Description Type",</p>
<p>"ja":"内容記述タイプ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Description Type",</p>
<p>"ja":"内容記述タイプ"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186626617[].subitem_description",</p>
<p>"title":"Description",</p>
<p>"title_i18n":{</p>
<p>"en":"Description",</p>
<p>"ja":"内容記述"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Description",</p>
<p>"ja":"内容記述"</p>
<p>},</p>
<p>"type":"textarea"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186626617[].subitem_description_language",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186626617",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Description",</p>
<p>"title_i18n":{</p>
<p>"en":"Description",</p>
<p>"ja":"内容記述"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186643794[].subitem_1522300295150",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186643794[].subitem_1522300316516",</p>
<p>"title":"Publisher",</p>
<p>"title_i18n":{</p>
<p>"en":"Publisher",</p>
<p>"ja":"出版者"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Publisher",</p>
<p>"ja":"出版者"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186643794",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Publisher",</p>
<p>"title_i18n":{</p>
<p>"en":"Publisher",</p>
<p>"ja":"出版者"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186660861[].subitem_1522300695726",</p>
<p>"title":"Date Type",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"Accepted",</p>
<p>"value":"Accepted"</p>
<p>},</p>
<p>{</p>
<p>"name":"Available",</p>
<p>"value":"Available"</p>
<p>},</p>
<p>{</p>
<p>"name":"Collected",</p>
<p>"value":"Collected"</p>
<p>},</p>
<p>{</p>
<p>"name":"Copyrighted",</p>
<p>"value":"Copyrighted"</p>
<p>},</p>
<p>{</p>
<p>"name":"Created",</p>
<p>"value":"Created"</p>
<p>},</p>
<p>{</p>
<p>"name":"Issued",</p>
<p>"value":"Issued"</p>
<p>},</p>
<p>{</p>
<p>"name":"Submitted",</p>
<p>"value":"Submitted"</p>
<p>},</p>
<p>{</p>
<p>"name":"Updated",</p>
<p>"value":"Updated"</p>
<p>},</p>
<p>{</p>
<p>"name":"Valid",</p>
<p>"value":"Valid"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Date Type",</p>
<p>"ja":"日付タイプ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Date Type",</p>
<p>"ja":"日付タイプ"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"format":"yyyy-MM-dd",</p>
<p>"key":"item_1617186660861[].subitem_1522300722591",</p>
<p>"templateUrl":"/static/templates/weko_deposit/datepicker_multi_format.html",</p>
<p>"title":"Date",</p>
<p>"title_i18n":{</p>
<p>"en":"Date",</p>
<p>"ja":"日付"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Date",</p>
<p>"ja":"日付"</p>
<p>},</p>
<p>"type":"template"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186660861",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Date",</p>
<p>"title_i18n":{</p>
<p>"en":"Date",</p>
<p>"ja":"日付"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186702042[].subitem_1551255818386",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"jpn",</p>
<p>"value":"jpn"</p>
<p>},</p>
<p>{</p>
<p>"name":"eng",</p>
<p>"value":"eng"</p>
<p>},</p>
<p>{</p>
<p>"name":"fra",</p>
<p>"value":"fra"</p>
<p>},</p>
<p>{</p>
<p>"name":"ita",</p>
<p>"value":"ita"</p>
<p>},</p>
<p>{</p>
<p>"name":"spa",</p>
<p>"value":"spa"</p>
<p>},</p>
<p>{</p>
<p>"name":"zho",</p>
<p>"value":"zho"</p>
<p>},</p>
<p>{</p>
<p>"name":"rus",</p>
<p>"value":"rus"</p>
<p>},</p>
<p>{</p>
<p>"name":"lat",</p>
<p>"value":"lat"</p>
<p>},</p>
<p>{</p>
<p>"name":"msa",</p>
<p>"value":"msa"</p>
<p>},</p>
<p>{</p>
<p>"name":"epo",</p>
<p>"value":"epo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ara",</p>
<p>"value":"ara"</p>
<p>},</p>
<p>{</p>
<p>"name":"ell",</p>
<p>"value":"ell"</p>
<p>},</p>
<p>{</p>
<p>"name":"kor",</p>
<p>"value":"kor"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186702042",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Language",</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617258105262.resourcetype",</p>
<p>"onChange":"resourceTypeSelect()",</p>
<p>"title":"Resource Type",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"conference paper",</p>
<p>"value":"conference paper"</p>
<p>},</p>
<p>{</p>
<p>"name":"data paper",</p>
<p>"value":"data paper"</p>
<p>},</p>
<p>{</p>
<p>"name":"departmental bulletin paper",</p>
<p>"value":"departmental bulletin paper"</p>
<p>},</p>
<p>{</p>
<p>"name":"editorial",</p>
<p>"value":"editorial"</p>
<p>},</p>
<p>{</p>
<p>"name":"journal article",</p>
<p>"value":"journal article"</p>
<p>},</p>
<p>{</p>
<p>"name":"newspaper",</p>
<p>"value":"newspaper"</p>
<p>},</p>
<p>{</p>
<p>"name":"periodical",</p>
<p>"value":"periodical"</p>
<p>},</p>
<p>{</p>
<p>"name":"review article",</p>
<p>"value":"review article"</p>
<p>},</p>
<p>{</p>
<p>"name":"software paper",</p>
<p>"value":"software paper"</p>
<p>},</p>
<p>{</p>
<p>"name":"article",</p>
<p>"value":"article"</p>
<p>},</p>
<p>{</p>
<p>"name":"book",</p>
<p>"value":"book"</p>
<p>},</p>
<p>{</p>
<p>"name":"book part",</p>
<p>"value":"book part"</p>
<p>},</p>
<p>{</p>
<p>"name":"cartographic material",</p>
<p>"value":"cartographic material"</p>
<p>},</p>
<p>{</p>
<p>"name":"map",</p>
<p>"value":"map"</p>
<p>},</p>
<p>{</p>
<p>"name":"conference object",</p>
<p>"value":"conference object"</p>
<p>},</p>
<p>{</p>
<p>"name":"conference proceedings",</p>
<p>"value":"conference proceedings"</p>
<p>},</p>
<p>{</p>
<p>"name":"conference poster",</p>
<p>"value":"conference poster"</p>
<p>},</p>
<p>{</p>
<p>"name":"aggregated data",</p>
<p>"value":"aggregated data"</p>
<p>},</p>
<p>{</p>
<p>"name":"clinical trial data",</p>
<p>"value":"clinical trial data"</p>
<p>},</p>
<p>{</p>
<p>"name":"compiled data",</p>
<p>"value":"compiled data"</p>
<p>},</p>
<p>{</p>
<p>"name":"encoded data",</p>
<p>"value":"encoded data"</p>
<p>},</p>
<p>{</p>
<p>"name":"experimental data",</p>
<p>"value":"experimental data"</p>
<p>},</p>
<p>{</p>
<p>"name":"genomic data",</p>
<p>"value":"genomic data"</p>
<p>},</p>
<p>{</p>
<p>"name":"geospatial data",</p>
<p>"value":"geospatial data"</p>
<p>},</p>
<p>{</p>
<p>"name":"laboratory notebook",</p>
<p>"value":"laboratory notebook"</p>
<p>},</p>
<p>{</p>
<p>"name":"measurement and test data",</p>
<p>"value":"measurement and test data"</p>
<p>},</p>
<p>{</p>
<p>"name":"observational data",</p>
<p>"value":"observational data"</p>
<p>},</p>
<p>{</p>
<p>"name":"recorded data",</p>
<p>"value":"recorded data"</p>
<p>},</p>
<p>{</p>
<p>"name":"simulation data",</p>
<p>"value":"simulation data"</p>
<p>},</p>
<p>{</p>
<p>"name":"survey data",</p>
<p>"value":"survey data"</p>
<p>},</p>
<p>{</p>
<p>"name":"dataset",</p>
<p>"value":"dataset"</p>
<p>},</p>
<p>{</p>
<p>"name":"interview",</p>
<p>"value":"interview"</p>
<p>},</p>
<p>{</p>
<p>"name":"image",</p>
<p>"value":"image"</p>
<p>},</p>
<p>{</p>
<p>"name":"still image",</p>
<p>"value":"still image"</p>
<p>},</p>
<p>{</p>
<p>"name":"moving image",</p>
<p>"value":"moving image"</p>
<p>},</p>
<p>{</p>
<p>"name":"video",</p>
<p>"value":"video"</p>
<p>},</p>
<p>{</p>
<p>"name":"lecture",</p>
<p>"value":"lecture"</p>
<p>},</p>
<p>{</p>
<p>"name":"patent",</p>
<p>"value":"patent"</p>
<p>},</p>
<p>{</p>
<p>"name":"internal report",</p>
<p>"value":"internal report"</p>
<p>},</p>
<p>{</p>
<p>"name":"report",</p>
<p>"value":"report"</p>
<p>},</p>
<p>{</p>
<p>"name":"research report",</p>
<p>"value":"research report"</p>
<p>},</p>
<p>{</p>
<p>"name":"technical report",</p>
<p>"value":"technical report"</p>
<p>},</p>
<p>{</p>
<p>"name":"policy report",</p>
<p>"value":"policy report"</p>
<p>},</p>
<p>{</p>
<p>"name":"report part",</p>
<p>"value":"report part"</p>
<p>},</p>
<p>{</p>
<p>"name":"working paper",</p>
<p>"value":"working paper"</p>
<p>},</p>
<p>{</p>
<p>"name":"data management plan",</p>
<p>"value":"data management plan"</p>
<p>},</p>
<p>{</p>
<p>"name":"sound",</p>
<p>"value":"sound"</p>
<p>},</p>
<p>{</p>
<p>"name":"thesis",</p>
<p>"value":"thesis"</p>
<p>},</p>
<p>{</p>
<p>"name":"bachelor thesis",</p>
<p>"value":"bachelor thesis"</p>
<p>},</p>
<p>{</p>
<p>"name":"master thesis",</p>
<p>"value":"master thesis"</p>
<p>},</p>
<p>{</p>
<p>"name":"doctoral thesis",</p>
<p>"value":"doctoral thesis"</p>
<p>},</p>
<p>{</p>
<p>"name":"interactive resource",</p>
<p>"value":"interactive resource"</p>
<p>},</p>
<p>{</p>
<p>"name":"learning object",</p>
<p>"value":"learning object"</p>
<p>},</p>
<p>{</p>
<p>"name":"manuscript",</p>
<p>"value":"manuscript"</p>
<p>},</p>
<p>{</p>
<p>"name":"musical notation",</p>
<p>"value":"musical notation"</p>
<p>},</p>
<p>{</p>
<p>"name":"research proposal",</p>
<p>"value":"research proposal"</p>
<p>},</p>
<p>{</p>
<p>"name":"software",</p>
<p>"value":"software"</p>
<p>},</p>
<p>{</p>
<p>"name":"technical documentation",</p>
<p>"value":"technical documentation"</p>
<p>},</p>
<p>{</p>
<p>"name":"workflow",</p>
<p>"value":"workflow"</p>
<p>},</p>
<p>{</p>
<p>"name":"other",</p>
<p>"value":"other"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Resource Type",</p>
<p>"ja":"資源タイプ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Resource Type",</p>
<p>"ja":"資源タイプ"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617258105262.resourceuri",</p>
<p>"readonly":true,</p>
<p>"title":"Resource Type Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Resource Type Identifier",</p>
<p>"ja":"資源タイプ識別子"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Resource Type Identifier",</p>
<p>"ja":"資源タイプ識別子"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617258105262",</p>
<p>"title":"Resource Type",</p>
<p>"title_i18n":{</p>
<p>"en":"Resource Type",</p>
<p>"ja":"資源タイプ"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617349808926.subitem_1523263171732",</p>
<p>"title":"Version",</p>
<p>"title_i18n":{</p>
<p>"en":"Version",</p>
<p>"ja":"バージョン情報"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Version",</p>
<p>"ja":"バージョン情報"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617349808926",</p>
<p>"title":"Version",</p>
<p>"title_i18n":{</p>
<p>"en":"Version",</p>
<p>"ja":"バージョン情報"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617265215918.subitem_1522305645492",</p>
<p>"onChange":"changedVersionType(this, modelValue)",</p>
<p>"title":"Version Type",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"AO",</p>
<p>"value":"AO"</p>
<p>},</p>
<p>{</p>
<p>"name":"SMUR",</p>
<p>"value":"SMUR"</p>
<p>},</p>
<p>{</p>
<p>"name":"AM",</p>
<p>"value":"AM"</p>
<p>},</p>
<p>{</p>
<p>"name":"P",</p>
<p>"value":"P"</p>
<p>},</p>
<p>{</p>
<p>"name":"VoR",</p>
<p>"value":"VoR"</p>
<p>},</p>
<p>{</p>
<p>"name":"CVoR",</p>
<p>"value":"CVoR"</p>
<p>},</p>
<p>{</p>
<p>"name":"EVoR",</p>
<p>"value":"EVoR"</p>
<p>},</p>
<p>{</p>
<p>"name":"NA",</p>
<p>"value":"NA"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Version Type",</p>
<p>"ja":"出版タイプ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Version Type",</p>
<p>"ja":"出版タイプ"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"fieldHtmlClass":"txt-version-resource",</p>
<p>"key":"item_1617265215918.subitem_1600292170262",</p>
<p>"readonly":true,</p>
<p>"title":"Version Type Resource",</p>
<p>"title_i18n":{</p>
<p>"en":"Version Type Resource",</p>
<p>"ja":"出版タイプResource"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Version Type Resource",</p>
<p>"ja":"出版タイプResource"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617265215918",</p>
<p>"title":"Version Type",</p>
<p>"title_i18n":{</p>
<p>"en":"Version Type",</p>
<p>"ja":"出版タイプ"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186783814[].subitem_identifier_uri",</p>
<p>"title":"Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Identifier",</p>
<p>"ja":"識別子"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Identifier",</p>
<p>"ja":"識別子"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186783814[].subitem_identifier_type",</p>
<p>"title":"Identifier Type",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"DOI",</p>
<p>"value":"DOI"</p>
<p>},</p>
<p>{</p>
<p>"name":"HDL",</p>
<p>"value":"HDL"</p>
<p>},</p>
<p>{</p>
<p>"name":"URI",</p>
<p>"value":"URI"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Identifier Type",</p>
<p>"ja":"識別子タイプ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Identifier Type",</p>
<p>"ja":"識別子タイプ"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186783814",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Identifier",</p>
<p>"ja":"識別子"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186819068.subitem_identifier_reg_text",</p>
<p>"readonly":true,</p>
<p>"title":"Identifier Registration",</p>
<p>"title_i18n":{</p>
<p>"en":"Identifier Registration",</p>
<p>"ja":"ID登録"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Identifier Registration",</p>
<p>"ja":"ID登録"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186819068.subitem_identifier_reg_type",</p>
<p>"readonly":true,</p>
<p>"title":"Identifier Registration Type",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"JaLC",</p>
<p>"value":"JaLC"</p>
<p>},</p>
<p>{</p>
<p>"name":"Crossref",</p>
<p>"value":"Crossref"</p>
<p>},</p>
<p>{</p>
<p>"name":"DataCite",</p>
<p>"value":"DataCite"</p>
<p>},</p>
<p>{</p>
<p>"name":"PMID【現在不使用】",</p>
<p>"value":"PMID【現在不使用】"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Identifier Registration Type",</p>
<p>"ja":"ID登録タイプ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Identifier Registration Type",</p>
<p>"ja":"ID登録タイプ"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186819068",</p>
<p>"title":"Identifier Registration",</p>
<p>"title_i18n":{</p>
<p>"en":"Identifier Registration",</p>
<p>"ja":"ID登録"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617353299429[].subitem_1522306207484",</p>
<p>"title":"Relation Type",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"isVersionOf",</p>
<p>"value":"isVersionOf"</p>
<p>},</p>
<p>{</p>
<p>"name":"hasVersion",</p>
<p>"value":"hasVersion"</p>
<p>},</p>
<p>{</p>
<p>"name":"isPartOf",</p>
<p>"value":"isPartOf"</p>
<p>},</p>
<p>{</p>
<p>"name":"hasPart",</p>
<p>"value":"hasPart"</p>
<p>},</p>
<p>{</p>
<p>"name":"isReferencedBy",</p>
<p>"value":"isReferencedBy"</p>
<p>},</p>
<p>{</p>
<p>"name":"references",</p>
<p>"value":"references"</p>
<p>},</p>
<p>{</p>
<p>"name":"isFormatOf",</p>
<p>"value":"isFormatOf"</p>
<p>},</p>
<p>{</p>
<p>"name":"hasFormat",</p>
<p>"value":"hasFormat"</p>
<p>},</p>
<p>{</p>
<p>"name":"isReplacedBy",</p>
<p>"value":"isReplacedBy"</p>
<p>},</p>
<p>{</p>
<p>"name":"replaces",</p>
<p>"value":"replaces"</p>
<p>},</p>
<p>{</p>
<p>"name":"isRequiredBy",</p>
<p>"value":"isRequiredBy"</p>
<p>},</p>
<p>{</p>
<p>"name":"requires",</p>
<p>"value":"requires"</p>
<p>},</p>
<p>{</p>
<p>"name":"isSupplementTo",</p>
<p>"value":"isSupplementTo"</p>
<p>},</p>
<p>{</p>
<p>"name":"isSupplementedBy",</p>
<p>"value":"isSupplementedBy"</p>
<p>},</p>
<p>{</p>
<p>"name":"isIdenticalTo",</p>
<p>"value":"isIdenticalTo"</p>
<p>},</p>
<p>{</p>
<p>"name":"isDerivedFrom",</p>
<p>"value":"isDerivedFrom"</p>
<p>},</p>
<p>{</p>
<p>"name":"isSourceOf",</p>
<p>"value":"isSourceOf"</p>
<p>},</p>
<p>{</p>
<p>"name":"isCitedBy",</p>
<p>"value":"isCitedBy"</p>
<p>},</p>
<p>{</p>
<p>"name":"Cites",</p>
<p>"value":"Cites"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Relation Type",</p>
<p>"ja":"関連タイプ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Relation Type",</p>
<p>"ja":"関連タイプ"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617353299429[].subitem_1522306287251.subitem_1522306382014",</p>
<p>"title":"Identifier Type",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ARK",</p>
<p>"value":"ARK"</p>
<p>},</p>
<p>{</p>
<p>"name":"arXiv",</p>
<p>"value":"arXiv"</p>
<p>},</p>
<p>{</p>
<p>"name":"DOI",</p>
<p>"value":"DOI"</p>
<p>},</p>
<p>{</p>
<p>"name":"HDL",</p>
<p>"value":"HDL"</p>
<p>},</p>
<p>{</p>
<p>"name":"ICHUSHI",</p>
<p>"value":"ICHUSHI"</p>
<p>},</p>
<p>{</p>
<p>"name":"ISBN",</p>
<p>"value":"ISBN"</p>
<p>},</p>
<p>{</p>
<p>"name":"J-GLOBAL",</p>
<p>"value":"J-GLOBAL"</p>
<p>},</p>
<p>{</p>
<p>"name":"Local",</p>
<p>"value":"Local"</p>
<p>},</p>
<p>{</p>
<p>"name":"PISSN",</p>
<p>"value":"PISSN"</p>
<p>},</p>
<p>{</p>
<p>"name":"EISSN",</p>
<p>"value":"EISSN"</p>
<p>},</p>
<p>{</p>
<p>"name":"ISSN【非推奨】",</p>
<p>"value":"ISSN【非推奨】"</p>
<p>},</p>
<p>{</p>
<p>"name":"NAID",</p>
<p>"value":"NAID"</p>
<p>},</p>
<p>{</p>
<p>"name":"NCID",</p>
<p>"value":"NCID"</p>
<p>},</p>
<p>{</p>
<p>"name":"PMID",</p>
<p>"value":"PMID"</p>
<p>},</p>
<p>{</p>
<p>"name":"PURL",</p>
<p>"value":"PURL"</p>
<p>},</p>
<p>{</p>
<p>"name":"SCOPUS",</p>
<p>"value":"SCOPUS"</p>
<p>},</p>
<p>{</p>
<p>"name":"URI",</p>
<p>"value":"URI"</p>
<p>},</p>
<p>{</p>
<p>"name":"WOS",</p>
<p>"value":"WOS"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Identifier Type",</p>
<p>"ja":"識別子タイプ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Identifier Type",</p>
<p>"ja":"識別子タイプ"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617353299429[].subitem_1522306287251.subitem_1522306436033",</p>
<p>"title":"Relation Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Relation Identifier",</p>
<p>"ja":"関連識別子"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Relation Identifier",</p>
<p>"ja":"関連識別子"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617353299429[].subitem_1522306287251",</p>
<p>"title":"Relation Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Relation Identifier",</p>
<p>"ja":"関連識別子"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Relation Identifier",</p>
<p>"ja":"関連識別子"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617353299429[].subitem_1523320863692[].subitem_1523320867455",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617353299429[].subitem_1523320863692[].subitem_1523320909613",</p>
<p>"title":"Related Title",</p>
<p>"title_i18n":{</p>
<p>"en":"Related Title",</p>
<p>"ja":"関連名称"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Related Title",</p>
<p>"ja":"関連名称"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617353299429[].subitem_1523320863692",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Related Title",</p>
<p>"title_i18n":{</p>
<p>"en":"Related Title",</p>
<p>"ja":"関連名称"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Related Title",</p>
<p>"ja":"関連名称"</p>
<p>}</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617353299429",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Relation",</p>
<p>"title_i18n":{</p>
<p>"en":"Relation",</p>
<p>"ja":"関連情報"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186859717[].subitem_1522658018441",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186859717[].subitem_1522658031721",</p>
<p>"title":"Temporal",</p>
<p>"title_i18n":{</p>
<p>"en":"Temporal",</p>
<p>"ja":"時間的範囲"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Temporal",</p>
<p>"ja":"時間的範囲"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186859717",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Temporal",</p>
<p>"title_i18n":{</p>
<p>"en":"Temporal",</p>
<p>"ja":"時間的範囲"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186882738[].subitem_geolocation_point.subitem_point_longitude",</p>
<p>"title":"Point Longitude",</p>
<p>"title_i18n":{</p>
<p>"en":"Point Longitude",</p>
<p>"ja":"経度"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Point Longitude",</p>
<p>"ja":"経度"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186882738[].subitem_geolocation_point.subitem_point_latitude",</p>
<p>"title":"Point Latitude",</p>
<p>"title_i18n":{</p>
<p>"en":"Point Latitude",</p>
<p>"ja":"緯度"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Point Latitude",</p>
<p>"ja":"緯度"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186882738[].subitem_geolocation_point",</p>
<p>"title":"Geo Location Point",</p>
<p>"title_i18n":{</p>
<p>"en":"Geo Location Point",</p>
<p>"ja":"位置情報（点）"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Geo Location Point",</p>
<p>"ja":"位置情報（点）"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186882738[].subitem_geolocation_box.subitem_west_longitude",</p>
<p>"title":"West Bound Longitude",</p>
<p>"title_i18n":{</p>
<p>"en":"West Bound Longitude",</p>
<p>"ja":"西部経度"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"West Bound Longitude",</p>
<p>"ja":"西部経度"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186882738[].subitem_geolocation_box.subitem_east_longitude",</p>
<p>"title":"East Bound Longitude",</p>
<p>"title_i18n":{</p>
<p>"en":"East Bound Longitude",</p>
<p>"ja":"東部経度"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"East Bound Longitude",</p>
<p>"ja":"東部経度"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186882738[].subitem_geolocation_box.subitem_south_latitude",</p>
<p>"title":"South Bound Latitude",</p>
<p>"title_i18n":{</p>
<p>"en":"South Bound Latitude",</p>
<p>"ja":"南部緯度"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"South Bound Latitude",</p>
<p>"ja":"南部緯度"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186882738[].subitem_geolocation_box.subitem_north_latitude",</p>
<p>"title":"North Bound Latitude",</p>
<p>"title_i18n":{</p>
<p>"en":"North Bound Latitude",</p>
<p>"ja":"北部緯度"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"North Bound Latitude",</p>
<p>"ja":"北部緯度"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186882738[].subitem_geolocation_box",</p>
<p>"title":"Geo Location Box",</p>
<p>"title_i18n":{</p>
<p>"en":"Geo Location Box",</p>
<p>"ja":"位置情報（空間）"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Geo Location Box",</p>
<p>"ja":"位置情報（空間）"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186882738[].subitem_geolocation_place[].subitem_geolocation_place_text",</p>
<p>"title":"Geo Location Place",</p>
<p>"title_i18n":{</p>
<p>"en":"Geo Location Place",</p>
<p>"ja":"位置情報（自由記述）"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Geo Location Place",</p>
<p>"ja":"位置情報（自由記述）"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186882738[].subitem_geolocation_place",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Geo Location Place",</p>
<p>"title_i18n":{</p>
<p>"en":"Geo Location Place",</p>
<p>"ja":"位置情報（自由記述）"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Geo Location Place",</p>
<p>"ja":"位置情報（自由記述）"</p>
<p>}</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186882738",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Geo Location",</p>
<p>"title_i18n":{</p>
<p>"en":"Geo Location",</p>
<p>"ja":"位置情報"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186901218[].subitem_1522399143519.subitem_1522399281603",</p>
<p>"title":"Funder Identifier Type",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"Crossref Funder",</p>
<p>"value":"Crossref Funder"</p>
<p>},</p>
<p>{</p>
<p>"name":"GRID",</p>
<p>"value":"GRID"</p>
<p>},</p>
<p>{</p>
<p>"name":"ISNI",</p>
<p>"value":"ISNI"</p>
<p>},</p>
<p>{</p>
<p>"name":"Other",</p>
<p>"value":"Other"</p>
<p>},</p>
<p>{</p>
<p>"name":"kakenhi",</p>
<p>"value":"kakenhi"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Funder Identifier Type",</p>
<p>"ja":"助成機関識別子タイプ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Funder Identifier Type",</p>
<p>"ja":"助成機関識別子タイプ"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186901218[].subitem_1522399143519.subitem_1522399333375",</p>
<p>"title":"Funder Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Funder Identifier",</p>
<p>"ja":"助成機関識別子"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Funder Identifier",</p>
<p>"ja":"助成機関識別子"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186901218[].subitem_1522399143519",</p>
<p>"title":"Funder Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Funder Identifier",</p>
<p>"ja":"助成機関識別子"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Funder Identifier",</p>
<p>"ja":"助成機関識別子"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186901218[].subitem_1522399412622[].subitem_1522399416691",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186901218[].subitem_1522399412622[].subitem_1522737543681",</p>
<p>"title":"Funder Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Funder Name",</p>
<p>"ja":"助成機関名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Funder Name",</p>
<p>"ja":"助成機関名"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186901218[].subitem_1522399412622",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Funder Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Funder Name",</p>
<p>"ja":"助成機関名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Funder Name",</p>
<p>"ja":"助成機関名"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186901218[].subitem_1522399571623.subitem_1522399585738",</p>
<p>"title":"Award URI",</p>
<p>"title_i18n":{</p>
<p>"en":"Award URI",</p>
<p>"ja":"研究課題URI"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Award URI",</p>
<p>"ja":"研究課題URI"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186901218[].subitem_1522399571623.subitem_1522399628911",</p>
<p>"title":"Award Number",</p>
<p>"title_i18n":{</p>
<p>"en":"Award Number",</p>
<p>"ja":"研究課題番号"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Award Number",</p>
<p>"ja":"研究課題番号"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186901218[].subitem_1522399571623",</p>
<p>"title":"Award Number",</p>
<p>"title_i18n":{</p>
<p>"en":"Award Number",</p>
<p>"ja":"研究課題番号"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Award Number",</p>
<p>"ja":"研究課題番号"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186901218[].subitem_1522399651758[].subitem_1522721910626",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186901218[].subitem_1522399651758[].subitem_1522721929892",</p>
<p>"title":"Award Title",</p>
<p>"title_i18n":{</p>
<p>"en":"Award Title",</p>
<p>"ja":"研究課題名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Award Title",</p>
<p>"ja":"研究課題名"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186901218[].subitem_1522399651758",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Award Title",</p>
<p>"title_i18n":{</p>
<p>"en":"Award Title",</p>
<p>"ja":"研究課題名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Award Title",</p>
<p>"ja":"研究課題名"</p>
<p>}</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186901218",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Funding Reference",</p>
<p>"title_i18n":{</p>
<p>"en":"Funding Reference",</p>
<p>"ja":"助成情報"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186920753[].subitem_1522646500366",</p>
<p>"title":"Source Identifier Type",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"PISSN",</p>
<p>"value":"PISSN"</p>
<p>},</p>
<p>{</p>
<p>"name":"EISSN",</p>
<p>"value":"EISSN"</p>
<p>},</p>
<p>{</p>
<p>"name":"ISSN",</p>
<p>"value":"ISSN"</p>
<p>},</p>
<p>{</p>
<p>"name":"NCID",</p>
<p>"value":"NCID"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Source Identifier Type",</p>
<p>"ja":"収録物識別子タイプ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Source Identifier Type",</p>
<p>"ja":"収録物識別子タイプ"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186920753[].subitem_1522646572813",</p>
<p>"title":"Source Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Source Identifier",</p>
<p>"ja":"収録物識別子"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Source Identifier",</p>
<p>"ja":"収録物識別子"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186920753",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Source Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Source Identifier",</p>
<p>"ja":"収録物識別子"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186941041[].subitem_1522650068558",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617186941041[].subitem_1522650091861",</p>
<p>"title":"Source Title",</p>
<p>"title_i18n":{</p>
<p>"en":"Source Title",</p>
<p>"ja":"収録物名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Source Title",</p>
<p>"ja":"収録物名"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186941041",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Source Title",</p>
<p>"title_i18n":{</p>
<p>"en":"Source Title",</p>
<p>"ja":"収録物名"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186959569.subitem_1551256328147",</p>
<p>"title":"Volume Number",</p>
<p>"title_i18n":{</p>
<p>"en":"Volume Number",</p>
<p>"ja":"巻"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Volume Number",</p>
<p>"ja":"巻"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186959569",</p>
<p>"title":"Volume Number",</p>
<p>"title_i18n":{</p>
<p>"en":"Volume Number",</p>
<p>"ja":"巻"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186981471.subitem_1551256294723",</p>
<p>"title":"Issue Number",</p>
<p>"title_i18n":{</p>
<p>"en":"Issue Number",</p>
<p>"ja":"号"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Issue Number",</p>
<p>"ja":"号"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186981471",</p>
<p>"title":"Issue Number",</p>
<p>"title_i18n":{</p>
<p>"en":"Issue Number",</p>
<p>"ja":"号"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617186994930.subitem_1551256248092",</p>
<p>"title":"Number of Pages",</p>
<p>"title_i18n":{</p>
<p>"en":"Number of Pages",</p>
<p>"ja":"ページ数"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Number of Pages",</p>
<p>"ja":"ページ数"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617186994930",</p>
<p>"title":"Number of Pages",</p>
<p>"title_i18n":{</p>
<p>"en":"Number of Pages",</p>
<p>"ja":"ページ数"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617187024783.subitem_1551256198917",</p>
<p>"title":"Page Start",</p>
<p>"title_i18n":{</p>
<p>"en":"Page Start",</p>
<p>"ja":"開始ページ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Page Start",</p>
<p>"ja":"開始ページ"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617187024783",</p>
<p>"title":"Page Start",</p>
<p>"title_i18n":{</p>
<p>"en":"Page Start",</p>
<p>"ja":"開始ページ"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617187045071.subitem_1551256185532",</p>
<p>"title":"Page End",</p>
<p>"title_i18n":{</p>
<p>"en":"Page End",</p>
<p>"ja":"終了ページ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Page End",</p>
<p>"ja":"終了ページ"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617187045071",</p>
<p>"title":"Page End",</p>
<p>"title_i18n":{</p>
<p>"en":"Page End",</p>
<p>"ja":"終了ページ"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617187056579.bibliographic_titles[].bibliographic_title",</p>
<p>"title":"Title",</p>
<p>"title_i18n":{</p>
<p>"en":"Title",</p>
<p>"ja":"タイトル"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Title",</p>
<p>"ja":"タイトル"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187056579.bibliographic_titles[].bibliographic_titleLang",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617187056579.bibliographic_titles",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Journal Title",</p>
<p>"title_i18n":{</p>
<p>"en":"Journal Title",</p>
<p>"ja":"雑誌名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Journal Title",</p>
<p>"ja":"雑誌名"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187056579.bibliographicVolumeNumber",</p>
<p>"title":"Volume Number",</p>
<p>"title_i18n":{</p>
<p>"en":"Volume Number",</p>
<p>"ja":"巻"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Volume Number",</p>
<p>"ja":"巻"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187056579.bibliographicIssueNumber",</p>
<p>"title":"Issue Number",</p>
<p>"title_i18n":{</p>
<p>"en":"Issue Number",</p>
<p>"ja":"号"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Issue Number",</p>
<p>"ja":"号"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187056579.bibliographicPageStart",</p>
<p>"title":"Page Start",</p>
<p>"title_i18n":{</p>
<p>"en":"Page Start",</p>
<p>"ja":"開始ページ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Page Start",</p>
<p>"ja":"開始ページ"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187056579.bibliographicPageEnd",</p>
<p>"title":"Page End",</p>
<p>"title_i18n":{</p>
<p>"en":"Page End",</p>
<p>"ja":"終了ページ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Page End",</p>
<p>"ja":"終了ページ"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187056579.bibliographicNumberOfPages",</p>
<p>"title":"Number of Page",</p>
<p>"title_i18n":{</p>
<p>"en":"Number of Page",</p>
<p>"ja":"ページ数"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Number of Page",</p>
<p>"ja":"ページ数"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"format":"yyyy-MM-dd",</p>
<p>"key":"item_1617187056579.bibliographicIssueDates.bibliographicIssueDate",</p>
<p>"templateUrl":"/static/templates/weko_deposit/datepicker_multi_format.html",</p>
<p>"title":"Date",</p>
<p>"title_i18n":{</p>
<p>"en":"Date",</p>
<p>"ja":"日付"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Date",</p>
<p>"ja":"日付"</p>
<p>},</p>
<p>"type":"template"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187056579.bibliographicIssueDates.bibliographicIssueDateType",</p>
<p>"title":"Date Type",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"Issued",</p>
<p>"value":"Issued"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Date Type",</p>
<p>"ja":"日付タイプ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Date Type",</p>
<p>"ja":"日付タイプ"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617187056579.bibliographicIssueDates",</p>
<p>"title":"Issue Date",</p>
<p>"title_i18n":{</p>
<p>"en":"Issue Date",</p>
<p>"ja":"発行日"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Issue Date",</p>
<p>"ja":"発行日"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617187056579",</p>
<p>"title":"Bibliographic Information",</p>
<p>"title_i18n":{</p>
<p>"en":"Bibliographic Information",</p>
<p>"ja":"書誌情報"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617187087799.subitem_1551256171004",</p>
<p>"title":"Dissertation Number",</p>
<p>"title_i18n":{</p>
<p>"en":"Dissertation Number",</p>
<p>"ja":"学位授与番号"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Dissertation Number",</p>
<p>"ja":"学位授与番号"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617187087799",</p>
<p>"title":"Dissertation Number",</p>
<p>"title_i18n":{</p>
<p>"en":"Dissertation Number",</p>
<p>"ja":"学位授与番号"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617187112279[].subitem_1551256126428",</p>
<p>"title":"Degree Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Degree Name",</p>
<p>"ja":"学位名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Degree Name",</p>
<p>"ja":"学位名"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187112279[].subitem_1551256129013",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617187112279",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Degree Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Degree Name",</p>
<p>"ja":"学位名"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"format":"yyyy-MM-dd",</p>
<p>"key":"item_1617187136212.subitem_1551256096004",</p>
<p>"templateUrl":"/static/templates/weko_deposit/datepicker_multi_format.html",</p>
<p>"title":"Date Granted",</p>
<p>"title_i18n":{</p>
<p>"en":"Date Granted",</p>
<p>"ja":"学位授与年月日"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Date Granted",</p>
<p>"ja":"学位授与年月日"</p>
<p>},</p>
<p>"type":"template"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617187136212",</p>
<p>"title":"Date Granted",</p>
<p>"title_i18n":{</p>
<p>"en":"Date Granted",</p>
<p>"ja":"学位授与年月日"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617944105607[].subitem_1551256015892[].subitem_1551256027296",</p>
<p>"title":"Degree Grantor Name Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Degree Grantor Name Identifier",</p>
<p>"ja":"学位授与機関識別子"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Degree Grantor Name Identifier",</p>
<p>"ja":"学位授与機関識別子"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617944105607[].subitem_1551256015892[].subitem_1551256029891",</p>
<p>"title":"Degree Grantor Name Identifier Scheme",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"kakenhi",</p>
<p>"value":"kakenhi"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Degree Grantor Name Identifier Scheme",</p>
<p>"ja":"学位授与機関識別子Scheme"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Degree Grantor Name Identifier Scheme",</p>
<p>"ja":"学位授与機関識別子Scheme"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617944105607[].subitem_1551256015892",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Degree Grantor Name Identifier",</p>
<p>"title_i18n":{</p>
<p>"en":"Degree Grantor Name Identifier",</p>
<p>"ja":"学位授与機関識別子"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Degree Grantor Name Identifier",</p>
<p>"ja":"学位授与機関識別子"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617944105607[].subitem_1551256037922[].subitem_1551256042287",</p>
<p>"title":"Degree Grantor Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Degree Grantor Name",</p>
<p>"ja":"学位授与機関名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Degree Grantor Name",</p>
<p>"ja":"学位授与機関名"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617944105607[].subitem_1551256037922[].subitem_1551256047619",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617944105607[].subitem_1551256037922",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Degree Grantor Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Degree Grantor Name",</p>
<p>"ja":"学位授与機関名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Degree Grantor Name",</p>
<p>"ja":"学位授与機関名"</p>
<p>}</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617944105607",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Degree Grantor",</p>
<p>"title_i18n":{</p>
<p>"en":"Degree Grantor",</p>
<p>"ja":"学位授与機関"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617187187528[].subitem_1599711633003[].subitem_1599711636923",</p>
<p>"title":"Conference Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Conference Name",</p>
<p>"ja":"会議名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Conference Name",</p>
<p>"ja":"会議名"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187187528[].subitem_1599711633003[].subitem_1599711645590",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617187187528[].subitem_1599711633003",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Conference Name",</p>
<p>"title_i18n":{</p>
<p>"en":"Conference Name",</p>
<p>"ja":"会議名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Conference Name",</p>
<p>"ja":"会議名"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187187528[].subitem_1599711655652",</p>
<p>"title":"Conference Sequence",</p>
<p>"title_i18n":{</p>
<p>"en":"Conference Sequence",</p>
<p>"ja":"回次"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Conference Sequence",</p>
<p>"ja":"回次"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617187187528[].subitem_1599711660052[].subitem_1599711680082",</p>
<p>"title":"Conference Sponsor",</p>
<p>"title_i18n":{</p>
<p>"en":"Conference Sponsor",</p>
<p>"ja":"主催機関"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Conference Sponsor",</p>
<p>"ja":"主催機関"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187187528[].subitem_1599711660052[].subitem_1599711686511",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617187187528[].subitem_1599711660052",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Conference Sponsor",</p>
<p>"title_i18n":{</p>
<p>"en":"Conference Sponsor",</p>
<p>"ja":"主催機関"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Conference Sponsor",</p>
<p>"ja":"主催機関"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617187187528[].subitem_1599711699392.subitem_1599711731891",</p>
<p>"title":"Start Year",</p>
<p>"title_i18n":{</p>
<p>"en":"Start Year",</p>
<p>"ja":"開始年"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Start Year",</p>
<p>"ja":"開始年"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187187528[].subitem_1599711699392.subitem_1599711727603",</p>
<p>"title":"Start Month",</p>
<p>"title_i18n":{</p>
<p>"en":"Start Month",</p>
<p>"ja":"開始月"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Start Month",</p>
<p>"ja":"開始月"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187187528[].subitem_1599711699392.subitem_1599711712451",</p>
<p>"title":"Start Day",</p>
<p>"title_i18n":{</p>
<p>"en":"Start Day",</p>
<p>"ja":"開始日"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Start Day",</p>
<p>"ja":"開始日"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187187528[].subitem_1599711699392.subitem_1599711743722",</p>
<p>"title":"End Year",</p>
<p>"title_i18n":{</p>
<p>"en":"End Year",</p>
<p>"ja":"終了年"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"End Year",</p>
<p>"ja":"終了年"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187187528[].subitem_1599711699392.subitem_1599711739022",</p>
<p>"title":"End Month",</p>
<p>"title_i18n":{</p>
<p>"en":"End Month",</p>
<p>"ja":"終了月"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"End Month",</p>
<p>"ja":"終了月"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187187528[].subitem_1599711699392.subitem_1599711704251",</p>
<p>"title":"Conference Date",</p>
<p>"title_i18n":{</p>
<p>"en":"Conference Date",</p>
<p>"ja":"開催期間"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Conference Date",</p>
<p>"ja":"開催期間"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187187528[].subitem_1599711699392.subitem_1599711735410",</p>
<p>"title":"End Day",</p>
<p>"title_i18n":{</p>
<p>"en":"End Day",</p>
<p>"ja":"終了日"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"End Day",</p>
<p>"ja":"終了日"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187187528[].subitem_1599711699392.subitem_1599711745532",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617187187528[].subitem_1599711699392",</p>
<p>"title":"Conference Date",</p>
<p>"title_i18n":{</p>
<p>"en":"Conference Date",</p>
<p>"ja":"開催期間"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Conference Date",</p>
<p>"ja":"開催期間"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617187187528[].subitem_1599711758470[].subitem_1599711769260",</p>
<p>"title":"Conference Venue",</p>
<p>"title_i18n":{</p>
<p>"en":"Conference Venue",</p>
<p>"ja":"開催会場"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Conference Venue",</p>
<p>"ja":"開催会場"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187187528[].subitem_1599711758470[].subitem_1599711775943",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617187187528[].subitem_1599711758470",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Conference Venue",</p>
<p>"title_i18n":{</p>
<p>"en":"Conference Venue",</p>
<p>"ja":"開催会場"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Conference Venue",</p>
<p>"ja":"開催会場"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617187187528[].subitem_1599711788485[].subitem_1599711798761",</p>
<p>"title":"Conference Place",</p>
<p>"title_i18n":{</p>
<p>"en":"Conference Place",</p>
<p>"ja":"開催地"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Conference Place",</p>
<p>"ja":"開催地"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187187528[].subitem_1599711788485[].subitem_1599711803382",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617187187528[].subitem_1599711788485",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Conference Place",</p>
<p>"title_i18n":{</p>
<p>"en":"Conference Place",</p>
<p>"ja":"開催地"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Conference Place",</p>
<p>"ja":"開催地"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617187187528[].subitem_1599711813532",</p>
<p>"title":"Conference Country",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"JPN",</p>
<p>"value":"JPN"</p>
<p>},</p>
<p>{</p>
<p>"name":"ABW",</p>
<p>"value":"ABW"</p>
<p>},</p>
<p>{</p>
<p>"name":"AFG",</p>
<p>"value":"AFG"</p>
<p>},</p>
<p>{</p>
<p>"name":"AGO",</p>
<p>"value":"AGO"</p>
<p>},</p>
<p>{</p>
<p>"name":"AIA",</p>
<p>"value":"AIA"</p>
<p>},</p>
<p>{</p>
<p>"name":"ALA",</p>
<p>"value":"ALA"</p>
<p>},</p>
<p>{</p>
<p>"name":"ALB",</p>
<p>"value":"ALB"</p>
<p>},</p>
<p>{</p>
<p>"name":"AND",</p>
<p>"value":"AND"</p>
<p>},</p>
<p>{</p>
<p>"name":"ARE",</p>
<p>"value":"ARE"</p>
<p>},</p>
<p>{</p>
<p>"name":"ARG",</p>
<p>"value":"ARG"</p>
<p>},</p>
<p>{</p>
<p>"name":"ARM",</p>
<p>"value":"ARM"</p>
<p>},</p>
<p>{</p>
<p>"name":"ASM",</p>
<p>"value":"ASM"</p>
<p>},</p>
<p>{</p>
<p>"name":"ATA",</p>
<p>"value":"ATA"</p>
<p>},</p>
<p>{</p>
<p>"name":"ATF",</p>
<p>"value":"ATF"</p>
<p>},</p>
<p>{</p>
<p>"name":"ATG",</p>
<p>"value":"ATG"</p>
<p>},</p>
<p>{</p>
<p>"name":"AUS",</p>
<p>"value":"AUS"</p>
<p>},</p>
<p>{</p>
<p>"name":"AUT",</p>
<p>"value":"AUT"</p>
<p>},</p>
<p>{</p>
<p>"name":"AZE",</p>
<p>"value":"AZE"</p>
<p>},</p>
<p>{</p>
<p>"name":"BDI",</p>
<p>"value":"BDI"</p>
<p>},</p>
<p>{</p>
<p>"name":"BEL",</p>
<p>"value":"BEL"</p>
<p>},</p>
<p>{</p>
<p>"name":"BEN",</p>
<p>"value":"BEN"</p>
<p>},</p>
<p>{</p>
<p>"name":"BES",</p>
<p>"value":"BES"</p>
<p>},</p>
<p>{</p>
<p>"name":"BFA",</p>
<p>"value":"BFA"</p>
<p>},</p>
<p>{</p>
<p>"name":"BGD",</p>
<p>"value":"BGD"</p>
<p>},</p>
<p>{</p>
<p>"name":"BGR",</p>
<p>"value":"BGR"</p>
<p>},</p>
<p>{</p>
<p>"name":"BHR",</p>
<p>"value":"BHR"</p>
<p>},</p>
<p>{</p>
<p>"name":"BHS",</p>
<p>"value":"BHS"</p>
<p>},</p>
<p>{</p>
<p>"name":"BIH",</p>
<p>"value":"BIH"</p>
<p>},</p>
<p>{</p>
<p>"name":"BLM",</p>
<p>"value":"BLM"</p>
<p>},</p>
<p>{</p>
<p>"name":"BLR",</p>
<p>"value":"BLR"</p>
<p>},</p>
<p>{</p>
<p>"name":"BLZ",</p>
<p>"value":"BLZ"</p>
<p>},</p>
<p>{</p>
<p>"name":"BMU",</p>
<p>"value":"BMU"</p>
<p>},</p>
<p>{</p>
<p>"name":"BOL",</p>
<p>"value":"BOL"</p>
<p>},</p>
<p>{</p>
<p>"name":"BRA",</p>
<p>"value":"BRA"</p>
<p>},</p>
<p>{</p>
<p>"name":"BRB",</p>
<p>"value":"BRB"</p>
<p>},</p>
<p>{</p>
<p>"name":"BRN",</p>
<p>"value":"BRN"</p>
<p>},</p>
<p>{</p>
<p>"name":"BTN",</p>
<p>"value":"BTN"</p>
<p>},</p>
<p>{</p>
<p>"name":"BVT",</p>
<p>"value":"BVT"</p>
<p>},</p>
<p>{</p>
<p>"name":"BWA",</p>
<p>"value":"BWA"</p>
<p>},</p>
<p>{</p>
<p>"name":"CAF",</p>
<p>"value":"CAF"</p>
<p>},</p>
<p>{</p>
<p>"name":"CAN",</p>
<p>"value":"CAN"</p>
<p>},</p>
<p>{</p>
<p>"name":"CCK",</p>
<p>"value":"CCK"</p>
<p>},</p>
<p>{</p>
<p>"name":"CHE",</p>
<p>"value":"CHE"</p>
<p>},</p>
<p>{</p>
<p>"name":"CHL",</p>
<p>"value":"CHL"</p>
<p>},</p>
<p>{</p>
<p>"name":"CHN",</p>
<p>"value":"CHN"</p>
<p>},</p>
<p>{</p>
<p>"name":"CIV",</p>
<p>"value":"CIV"</p>
<p>},</p>
<p>{</p>
<p>"name":"CMR",</p>
<p>"value":"CMR"</p>
<p>},</p>
<p>{</p>
<p>"name":"COD",</p>
<p>"value":"COD"</p>
<p>},</p>
<p>{</p>
<p>"name":"COG",</p>
<p>"value":"COG"</p>
<p>},</p>
<p>{</p>
<p>"name":"COK",</p>
<p>"value":"COK"</p>
<p>},</p>
<p>{</p>
<p>"name":"COL",</p>
<p>"value":"COL"</p>
<p>},</p>
<p>{</p>
<p>"name":"COM",</p>
<p>"value":"COM"</p>
<p>},</p>
<p>{</p>
<p>"name":"CPV",</p>
<p>"value":"CPV"</p>
<p>},</p>
<p>{</p>
<p>"name":"CRI",</p>
<p>"value":"CRI"</p>
<p>},</p>
<p>{</p>
<p>"name":"CUB",</p>
<p>"value":"CUB"</p>
<p>},</p>
<p>{</p>
<p>"name":"CUW",</p>
<p>"value":"CUW"</p>
<p>},</p>
<p>{</p>
<p>"name":"CXR",</p>
<p>"value":"CXR"</p>
<p>},</p>
<p>{</p>
<p>"name":"CYM",</p>
<p>"value":"CYM"</p>
<p>},</p>
<p>{</p>
<p>"name":"CYP",</p>
<p>"value":"CYP"</p>
<p>},</p>
<p>{</p>
<p>"name":"CZE",</p>
<p>"value":"CZE"</p>
<p>},</p>
<p>{</p>
<p>"name":"DEU",</p>
<p>"value":"DEU"</p>
<p>},</p>
<p>{</p>
<p>"name":"DJI",</p>
<p>"value":"DJI"</p>
<p>},</p>
<p>{</p>
<p>"name":"DMA",</p>
<p>"value":"DMA"</p>
<p>},</p>
<p>{</p>
<p>"name":"DNK",</p>
<p>"value":"DNK"</p>
<p>},</p>
<p>{</p>
<p>"name":"DOM",</p>
<p>"value":"DOM"</p>
<p>},</p>
<p>{</p>
<p>"name":"DZA",</p>
<p>"value":"DZA"</p>
<p>},</p>
<p>{</p>
<p>"name":"ECU",</p>
<p>"value":"ECU"</p>
<p>},</p>
<p>{</p>
<p>"name":"EGY",</p>
<p>"value":"EGY"</p>
<p>},</p>
<p>{</p>
<p>"name":"ERI",</p>
<p>"value":"ERI"</p>
<p>},</p>
<p>{</p>
<p>"name":"ESH",</p>
<p>"value":"ESH"</p>
<p>},</p>
<p>{</p>
<p>"name":"ESP",</p>
<p>"value":"ESP"</p>
<p>},</p>
<p>{</p>
<p>"name":"EST",</p>
<p>"value":"EST"</p>
<p>},</p>
<p>{</p>
<p>"name":"ETH",</p>
<p>"value":"ETH"</p>
<p>},</p>
<p>{</p>
<p>"name":"FIN",</p>
<p>"value":"FIN"</p>
<p>},</p>
<p>{</p>
<p>"name":"FJI",</p>
<p>"value":"FJI"</p>
<p>},</p>
<p>{</p>
<p>"name":"FLK",</p>
<p>"value":"FLK"</p>
<p>},</p>
<p>{</p>
<p>"name":"FRA",</p>
<p>"value":"FRA"</p>
<p>},</p>
<p>{</p>
<p>"name":"FRO",</p>
<p>"value":"FRO"</p>
<p>},</p>
<p>{</p>
<p>"name":"FSM",</p>
<p>"value":"FSM"</p>
<p>},</p>
<p>{</p>
<p>"name":"GAB",</p>
<p>"value":"GAB"</p>
<p>},</p>
<p>{</p>
<p>"name":"GBR",</p>
<p>"value":"GBR"</p>
<p>},</p>
<p>{</p>
<p>"name":"GEO",</p>
<p>"value":"GEO"</p>
<p>},</p>
<p>{</p>
<p>"name":"GGY",</p>
<p>"value":"GGY"</p>
<p>},</p>
<p>{</p>
<p>"name":"GHA",</p>
<p>"value":"GHA"</p>
<p>},</p>
<p>{</p>
<p>"name":"GIB",</p>
<p>"value":"GIB"</p>
<p>},</p>
<p>{</p>
<p>"name":"GIN",</p>
<p>"value":"GIN"</p>
<p>},</p>
<p>{</p>
<p>"name":"GLP",</p>
<p>"value":"GLP"</p>
<p>},</p>
<p>{</p>
<p>"name":"GMB",</p>
<p>"value":"GMB"</p>
<p>},</p>
<p>{</p>
<p>"name":"GNB",</p>
<p>"value":"GNB"</p>
<p>},</p>
<p>{</p>
<p>"name":"GNQ",</p>
<p>"value":"GNQ"</p>
<p>},</p>
<p>{</p>
<p>"name":"GRC",</p>
<p>"value":"GRC"</p>
<p>},</p>
<p>{</p>
<p>"name":"GRD",</p>
<p>"value":"GRD"</p>
<p>},</p>
<p>{</p>
<p>"name":"GRL",</p>
<p>"value":"GRL"</p>
<p>},</p>
<p>{</p>
<p>"name":"GTM",</p>
<p>"value":"GTM"</p>
<p>},</p>
<p>{</p>
<p>"name":"GUF",</p>
<p>"value":"GUF"</p>
<p>},</p>
<p>{</p>
<p>"name":"GUM",</p>
<p>"value":"GUM"</p>
<p>},</p>
<p>{</p>
<p>"name":"GUY",</p>
<p>"value":"GUY"</p>
<p>},</p>
<p>{</p>
<p>"name":"HKG",</p>
<p>"value":"HKG"</p>
<p>},</p>
<p>{</p>
<p>"name":"HMD",</p>
<p>"value":"HMD"</p>
<p>},</p>
<p>{</p>
<p>"name":"HND",</p>
<p>"value":"HND"</p>
<p>},</p>
<p>{</p>
<p>"name":"HRV",</p>
<p>"value":"HRV"</p>
<p>},</p>
<p>{</p>
<p>"name":"HTI",</p>
<p>"value":"HTI"</p>
<p>},</p>
<p>{</p>
<p>"name":"HUN",</p>
<p>"value":"HUN"</p>
<p>},</p>
<p>{</p>
<p>"name":"IDN",</p>
<p>"value":"IDN"</p>
<p>},</p>
<p>{</p>
<p>"name":"IMN",</p>
<p>"value":"IMN"</p>
<p>},</p>
<p>{</p>
<p>"name":"IND",</p>
<p>"value":"IND"</p>
<p>},</p>
<p>{</p>
<p>"name":"IOT",</p>
<p>"value":"IOT"</p>
<p>},</p>
<p>{</p>
<p>"name":"IRL",</p>
<p>"value":"IRL"</p>
<p>},</p>
<p>{</p>
<p>"name":"IRN",</p>
<p>"value":"IRN"</p>
<p>},</p>
<p>{</p>
<p>"name":"IRQ",</p>
<p>"value":"IRQ"</p>
<p>},</p>
<p>{</p>
<p>"name":"ISL",</p>
<p>"value":"ISL"</p>
<p>},</p>
<p>{</p>
<p>"name":"ISR",</p>
<p>"value":"ISR"</p>
<p>},</p>
<p>{</p>
<p>"name":"ITA",</p>
<p>"value":"ITA"</p>
<p>},</p>
<p>{</p>
<p>"name":"JAM",</p>
<p>"value":"JAM"</p>
<p>},</p>
<p>{</p>
<p>"name":"JEY",</p>
<p>"value":"JEY"</p>
<p>},</p>
<p>{</p>
<p>"name":"JOR",</p>
<p>"value":"JOR"</p>
<p>},</p>
<p>{</p>
<p>"name":"KAZ",</p>
<p>"value":"KAZ"</p>
<p>},</p>
<p>{</p>
<p>"name":"KEN",</p>
<p>"value":"KEN"</p>
<p>},</p>
<p>{</p>
<p>"name":"KGZ",</p>
<p>"value":"KGZ"</p>
<p>},</p>
<p>{</p>
<p>"name":"KHM",</p>
<p>"value":"KHM"</p>
<p>},</p>
<p>{</p>
<p>"name":"KIR",</p>
<p>"value":"KIR"</p>
<p>},</p>
<p>{</p>
<p>"name":"KNA",</p>
<p>"value":"KNA"</p>
<p>},</p>
<p>{</p>
<p>"name":"KOR",</p>
<p>"value":"KOR"</p>
<p>},</p>
<p>{</p>
<p>"name":"KWT",</p>
<p>"value":"KWT"</p>
<p>},</p>
<p>{</p>
<p>"name":"LAO",</p>
<p>"value":"LAO"</p>
<p>},</p>
<p>{</p>
<p>"name":"LBN",</p>
<p>"value":"LBN"</p>
<p>},</p>
<p>{</p>
<p>"name":"LBR",</p>
<p>"value":"LBR"</p>
<p>},</p>
<p>{</p>
<p>"name":"LBY",</p>
<p>"value":"LBY"</p>
<p>},</p>
<p>{</p>
<p>"name":"LCA",</p>
<p>"value":"LCA"</p>
<p>},</p>
<p>{</p>
<p>"name":"LIE",</p>
<p>"value":"LIE"</p>
<p>},</p>
<p>{</p>
<p>"name":"LKA",</p>
<p>"value":"LKA"</p>
<p>},</p>
<p>{</p>
<p>"name":"LSO",</p>
<p>"value":"LSO"</p>
<p>},</p>
<p>{</p>
<p>"name":"LTU",</p>
<p>"value":"LTU"</p>
<p>},</p>
<p>{</p>
<p>"name":"LUX",</p>
<p>"value":"LUX"</p>
<p>},</p>
<p>{</p>
<p>"name":"LVA",</p>
<p>"value":"LVA"</p>
<p>},</p>
<p>{</p>
<p>"name":"MAC",</p>
<p>"value":"MAC"</p>
<p>},</p>
<p>{</p>
<p>"name":"MAF",</p>
<p>"value":"MAF"</p>
<p>},</p>
<p>{</p>
<p>"name":"MAR",</p>
<p>"value":"MAR"</p>
<p>},</p>
<p>{</p>
<p>"name":"MCO",</p>
<p>"value":"MCO"</p>
<p>},</p>
<p>{</p>
<p>"name":"MDA",</p>
<p>"value":"MDA"</p>
<p>},</p>
<p>{</p>
<p>"name":"MDG",</p>
<p>"value":"MDG"</p>
<p>},</p>
<p>{</p>
<p>"name":"MDV",</p>
<p>"value":"MDV"</p>
<p>},</p>
<p>{</p>
<p>"name":"MEX",</p>
<p>"value":"MEX"</p>
<p>},</p>
<p>{</p>
<p>"name":"MHL",</p>
<p>"value":"MHL"</p>
<p>},</p>
<p>{</p>
<p>"name":"MKD",</p>
<p>"value":"MKD"</p>
<p>},</p>
<p>{</p>
<p>"name":"MLI",</p>
<p>"value":"MLI"</p>
<p>},</p>
<p>{</p>
<p>"name":"MLT",</p>
<p>"value":"MLT"</p>
<p>},</p>
<p>{</p>
<p>"name":"MMR",</p>
<p>"value":"MMR"</p>
<p>},</p>
<p>{</p>
<p>"name":"MNE",</p>
<p>"value":"MNE"</p>
<p>},</p>
<p>{</p>
<p>"name":"MNG",</p>
<p>"value":"MNG"</p>
<p>},</p>
<p>{</p>
<p>"name":"MNP",</p>
<p>"value":"MNP"</p>
<p>},</p>
<p>{</p>
<p>"name":"MOZ",</p>
<p>"value":"MOZ"</p>
<p>},</p>
<p>{</p>
<p>"name":"MRT",</p>
<p>"value":"MRT"</p>
<p>},</p>
<p>{</p>
<p>"name":"MSR",</p>
<p>"value":"MSR"</p>
<p>},</p>
<p>{</p>
<p>"name":"MTQ",</p>
<p>"value":"MTQ"</p>
<p>},</p>
<p>{</p>
<p>"name":"MUS",</p>
<p>"value":"MUS"</p>
<p>},</p>
<p>{</p>
<p>"name":"MWI",</p>
<p>"value":"MWI"</p>
<p>},</p>
<p>{</p>
<p>"name":"MYS",</p>
<p>"value":"MYS"</p>
<p>},</p>
<p>{</p>
<p>"name":"MYT",</p>
<p>"value":"MYT"</p>
<p>},</p>
<p>{</p>
<p>"name":"NAM",</p>
<p>"value":"NAM"</p>
<p>},</p>
<p>{</p>
<p>"name":"NCL",</p>
<p>"value":"NCL"</p>
<p>},</p>
<p>{</p>
<p>"name":"NER",</p>
<p>"value":"NER"</p>
<p>},</p>
<p>{</p>
<p>"name":"NFK",</p>
<p>"value":"NFK"</p>
<p>},</p>
<p>{</p>
<p>"name":"NGA",</p>
<p>"value":"NGA"</p>
<p>},</p>
<p>{</p>
<p>"name":"NIC",</p>
<p>"value":"NIC"</p>
<p>},</p>
<p>{</p>
<p>"name":"NIU",</p>
<p>"value":"NIU"</p>
<p>},</p>
<p>{</p>
<p>"name":"NLD",</p>
<p>"value":"NLD"</p>
<p>},</p>
<p>{</p>
<p>"name":"NOR",</p>
<p>"value":"NOR"</p>
<p>},</p>
<p>{</p>
<p>"name":"NPL",</p>
<p>"value":"NPL"</p>
<p>},</p>
<p>{</p>
<p>"name":"NRU",</p>
<p>"value":"NRU"</p>
<p>},</p>
<p>{</p>
<p>"name":"NZL",</p>
<p>"value":"NZL"</p>
<p>},</p>
<p>{</p>
<p>"name":"OMN",</p>
<p>"value":"OMN"</p>
<p>},</p>
<p>{</p>
<p>"name":"PAK",</p>
<p>"value":"PAK"</p>
<p>},</p>
<p>{</p>
<p>"name":"PAN",</p>
<p>"value":"PAN"</p>
<p>},</p>
<p>{</p>
<p>"name":"PCN",</p>
<p>"value":"PCN"</p>
<p>},</p>
<p>{</p>
<p>"name":"PER",</p>
<p>"value":"PER"</p>
<p>},</p>
<p>{</p>
<p>"name":"PHL",</p>
<p>"value":"PHL"</p>
<p>},</p>
<p>{</p>
<p>"name":"PLW",</p>
<p>"value":"PLW"</p>
<p>},</p>
<p>{</p>
<p>"name":"PNG",</p>
<p>"value":"PNG"</p>
<p>},</p>
<p>{</p>
<p>"name":"POL",</p>
<p>"value":"POL"</p>
<p>},</p>
<p>{</p>
<p>"name":"PRI",</p>
<p>"value":"PRI"</p>
<p>},</p>
<p>{</p>
<p>"name":"PRK",</p>
<p>"value":"PRK"</p>
<p>},</p>
<p>{</p>
<p>"name":"PRT",</p>
<p>"value":"PRT"</p>
<p>},</p>
<p>{</p>
<p>"name":"PRY",</p>
<p>"value":"PRY"</p>
<p>},</p>
<p>{</p>
<p>"name":"PSE",</p>
<p>"value":"PSE"</p>
<p>},</p>
<p>{</p>
<p>"name":"PYF",</p>
<p>"value":"PYF"</p>
<p>},</p>
<p>{</p>
<p>"name":"QAT",</p>
<p>"value":"QAT"</p>
<p>},</p>
<p>{</p>
<p>"name":"REU",</p>
<p>"value":"REU"</p>
<p>},</p>
<p>{</p>
<p>"name":"ROU",</p>
<p>"value":"ROU"</p>
<p>},</p>
<p>{</p>
<p>"name":"RUS",</p>
<p>"value":"RUS"</p>
<p>},</p>
<p>{</p>
<p>"name":"RWA",</p>
<p>"value":"RWA"</p>
<p>},</p>
<p>{</p>
<p>"name":"SAU",</p>
<p>"value":"SAU"</p>
<p>},</p>
<p>{</p>
<p>"name":"SDN",</p>
<p>"value":"SDN"</p>
<p>},</p>
<p>{</p>
<p>"name":"SEN",</p>
<p>"value":"SEN"</p>
<p>},</p>
<p>{</p>
<p>"name":"SGP",</p>
<p>"value":"SGP"</p>
<p>},</p>
<p>{</p>
<p>"name":"SGS",</p>
<p>"value":"SGS"</p>
<p>},</p>
<p>{</p>
<p>"name":"SHN",</p>
<p>"value":"SHN"</p>
<p>},</p>
<p>{</p>
<p>"name":"SJM",</p>
<p>"value":"SJM"</p>
<p>},</p>
<p>{</p>
<p>"name":"SLB",</p>
<p>"value":"SLB"</p>
<p>},</p>
<p>{</p>
<p>"name":"SLE",</p>
<p>"value":"SLE"</p>
<p>},</p>
<p>{</p>
<p>"name":"SLV",</p>
<p>"value":"SLV"</p>
<p>},</p>
<p>{</p>
<p>"name":"SMR",</p>
<p>"value":"SMR"</p>
<p>},</p>
<p>{</p>
<p>"name":"SOM",</p>
<p>"value":"SOM"</p>
<p>},</p>
<p>{</p>
<p>"name":"SPM",</p>
<p>"value":"SPM"</p>
<p>},</p>
<p>{</p>
<p>"name":"SRB",</p>
<p>"value":"SRB"</p>
<p>},</p>
<p>{</p>
<p>"name":"SSD",</p>
<p>"value":"SSD"</p>
<p>},</p>
<p>{</p>
<p>"name":"STP",</p>
<p>"value":"STP"</p>
<p>},</p>
<p>{</p>
<p>"name":"SUR",</p>
<p>"value":"SUR"</p>
<p>},</p>
<p>{</p>
<p>"name":"SVK",</p>
<p>"value":"SVK"</p>
<p>},</p>
<p>{</p>
<p>"name":"SVN",</p>
<p>"value":"SVN"</p>
<p>},</p>
<p>{</p>
<p>"name":"SWE",</p>
<p>"value":"SWE"</p>
<p>},</p>
<p>{</p>
<p>"name":"SWZ",</p>
<p>"value":"SWZ"</p>
<p>},</p>
<p>{</p>
<p>"name":"SXM",</p>
<p>"value":"SXM"</p>
<p>},</p>
<p>{</p>
<p>"name":"SYC",</p>
<p>"value":"SYC"</p>
<p>},</p>
<p>{</p>
<p>"name":"SYR",</p>
<p>"value":"SYR"</p>
<p>},</p>
<p>{</p>
<p>"name":"TCA",</p>
<p>"value":"TCA"</p>
<p>},</p>
<p>{</p>
<p>"name":"TCD",</p>
<p>"value":"TCD"</p>
<p>},</p>
<p>{</p>
<p>"name":"TGO",</p>
<p>"value":"TGO"</p>
<p>},</p>
<p>{</p>
<p>"name":"THA",</p>
<p>"value":"THA"</p>
<p>},</p>
<p>{</p>
<p>"name":"TJK",</p>
<p>"value":"TJK"</p>
<p>},</p>
<p>{</p>
<p>"name":"TKL",</p>
<p>"value":"TKL"</p>
<p>},</p>
<p>{</p>
<p>"name":"TKM",</p>
<p>"value":"TKM"</p>
<p>},</p>
<p>{</p>
<p>"name":"TLS",</p>
<p>"value":"TLS"</p>
<p>},</p>
<p>{</p>
<p>"name":"TON",</p>
<p>"value":"TON"</p>
<p>},</p>
<p>{</p>
<p>"name":"TTO",</p>
<p>"value":"TTO"</p>
<p>},</p>
<p>{</p>
<p>"name":"TUN",</p>
<p>"value":"TUN"</p>
<p>},</p>
<p>{</p>
<p>"name":"TUR",</p>
<p>"value":"TUR"</p>
<p>},</p>
<p>{</p>
<p>"name":"TUV",</p>
<p>"value":"TUV"</p>
<p>},</p>
<p>{</p>
<p>"name":"TWN",</p>
<p>"value":"TWN"</p>
<p>},</p>
<p>{</p>
<p>"name":"TZA",</p>
<p>"value":"TZA"</p>
<p>},</p>
<p>{</p>
<p>"name":"UGA",</p>
<p>"value":"UGA"</p>
<p>},</p>
<p>{</p>
<p>"name":"UKR",</p>
<p>"value":"UKR"</p>
<p>},</p>
<p>{</p>
<p>"name":"UMI",</p>
<p>"value":"UMI"</p>
<p>},</p>
<p>{</p>
<p>"name":"URY",</p>
<p>"value":"URY"</p>
<p>},</p>
<p>{</p>
<p>"name":"USA",</p>
<p>"value":"USA"</p>
<p>},</p>
<p>{</p>
<p>"name":"UZB",</p>
<p>"value":"UZB"</p>
<p>},</p>
<p>{</p>
<p>"name":"VAT",</p>
<p>"value":"VAT"</p>
<p>},</p>
<p>{</p>
<p>"name":"VCT",</p>
<p>"value":"VCT"</p>
<p>},</p>
<p>{</p>
<p>"name":"VEN",</p>
<p>"value":"VEN"</p>
<p>},</p>
<p>{</p>
<p>"name":"VGB",</p>
<p>"value":"VGB"</p>
<p>},</p>
<p>{</p>
<p>"name":"VIR",</p>
<p>"value":"VIR"</p>
<p>},</p>
<p>{</p>
<p>"name":"VNM",</p>
<p>"value":"VNM"</p>
<p>},</p>
<p>{</p>
<p>"name":"VUT",</p>
<p>"value":"VUT"</p>
<p>},</p>
<p>{</p>
<p>"name":"WLF",</p>
<p>"value":"WLF"</p>
<p>},</p>
<p>{</p>
<p>"name":"WSM",</p>
<p>"value":"WSM"</p>
<p>},</p>
<p>{</p>
<p>"name":"YEM",</p>
<p>"value":"YEM"</p>
<p>},</p>
<p>{</p>
<p>"name":"ZAF",</p>
<p>"value":"ZAF"</p>
<p>},</p>
<p>{</p>
<p>"name":"ZMB",</p>
<p>"value":"ZMB"</p>
<p>},</p>
<p>{</p>
<p>"name":"ZWE",</p>
<p>"value":"ZWE"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Conference Country",</p>
<p>"ja":"開催国"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Conference Country",</p>
<p>"ja":"開催国"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617187187528",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Conference",</p>
<p>"title_i18n":{</p>
<p>"en":"Conference",</p>
<p>"ja":"会議記述"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"fieldHtmlClass":"file-name",</p>
<p>"key":"item_1617605131499[].filename",</p>
<p>"onChange":"fileNameSelect(this, form, modelValue)",</p>
<p>"templateUrl":"/static/templates/weko_deposit/datalist.html",</p>
<p>"title":"FileName",</p>
<p>"titleMap":[</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"FileName",</p>
<p>"ja":"表示名"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"FileName",</p>
<p>"ja":"表示名"</p>
<p>},</p>
<p>"type":"template"</p>
<p>},</p>
<p>{</p>
<p>"items":[</p>
<p>{</p>
<p>"disableSuccessState":true,</p>
<p>"feedback":false,</p>
<p>"fieldHtmlClass":"file-text-url",</p>
<p>"key":"item_1617605131499[].url.url",</p>
<p>"title":"Text URL",</p>
<p>"title_i18n":{</p>
<p>"en":"Text URL",</p>
<p>"ja":"本文URL"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Text URL",</p>
<p>"ja":"本文URL"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"disableSuccessState":true,</p>
<p>"feedback":false,</p>
<p>"key":"item_1617605131499[].url.label",</p>
<p>"title":"Label",</p>
<p>"title_i18n":{</p>
<p>"en":"Label",</p>
<p>"ja":"ラベル"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Label",</p>
<p>"ja":"ラベル"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"disableSuccessState":true,</p>
<p>"feedback":false,</p>
<p>"key":"item_1617605131499[].url.objectType",</p>
<p>"title":"Object Type",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"abstract",</p>
<p>"value":"abstract"</p>
<p>},</p>
<p>{</p>
<p>"name":"summary",</p>
<p>"value":"summary"</p>
<p>},</p>
<p>{</p>
<p>"name":"fulltext",</p>
<p>"value":"fulltext"</p>
<p>},</p>
<p>{</p>
<p>"name":"thumbnail",</p>
<p>"value":"thumbnail"</p>
<p>},</p>
<p>{</p>
<p>"name":"other",</p>
<p>"value":"other"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Object Type",</p>
<p>"ja":"オブジェクトタイプ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Object Type",</p>
<p>"ja":"オブジェクトタイプ"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617605131499[].url",</p>
<p>"title":"Text URL",</p>
<p>"title_i18n":{</p>
<p>"en":"Text URL",</p>
<p>"ja":"本文URL"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Text URL",</p>
<p>"ja":"本文URL"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617605131499[].format",</p>
<p>"title":"Format",</p>
<p>"title_i18n":{</p>
<p>"en":"Format",</p>
<p>"ja":"フォーマット"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Format",</p>
<p>"ja":"フォーマット"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617605131499[].filesize[].value",</p>
<p>"title":"Size",</p>
<p>"title_i18n":{</p>
<p>"en":"Size",</p>
<p>"ja":"サイズ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Size",</p>
<p>"ja":"サイズ"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617605131499[].filesize",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Size",</p>
<p>"title_i18n":{</p>
<p>"en":"Size",</p>
<p>"ja":"サイズ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Size",</p>
<p>"ja":"サイズ"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617605131499[].fileDate[].fileDateType",</p>
<p>"title":"Date Type",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"Accepted",</p>
<p>"value":"Accepted"</p>
<p>},</p>
<p>{</p>
<p>"name":"Collected",</p>
<p>"value":"Collected"</p>
<p>},</p>
<p>{</p>
<p>"name":"Copyrighted",</p>
<p>"value":"Copyrighted"</p>
<p>},</p>
<p>{</p>
<p>"name":"Created",</p>
<p>"value":"Created"</p>
<p>},</p>
<p>{</p>
<p>"name":"Issued",</p>
<p>"value":"Issued"</p>
<p>},</p>
<p>{</p>
<p>"name":"Submitted",</p>
<p>"value":"Submitted"</p>
<p>},</p>
<p>{</p>
<p>"name":"Updated",</p>
<p>"value":"Updated"</p>
<p>},</p>
<p>{</p>
<p>"name":"Valid",</p>
<p>"value":"Valid"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Date Type",</p>
<p>"ja":"日付タイプ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Date Type",</p>
<p>"ja":"日付タイプ"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"format":"yyyy-MM-dd",</p>
<p>"key":"item_1617605131499[].fileDate[].fileDateValue",</p>
<p>"templateUrl":"/static/templates/weko_deposit/datepicker_multi_format.html",</p>
<p>"title":"Date",</p>
<p>"title_i18n":{</p>
<p>"en":"Date",</p>
<p>"ja":"日付"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Date",</p>
<p>"ja":"日付"</p>
<p>},</p>
<p>"type":"template"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617605131499[].fileDate",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Date",</p>
<p>"title_i18n":{</p>
<p>"en":"Date",</p>
<p>"ja":"日付"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Date",</p>
<p>"ja":"日付"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617605131499[].version",</p>
<p>"title":"Version Information",</p>
<p>"title_i18n":{</p>
<p>"en":"Version Information",</p>
<p>"ja":"バージョン情報"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Version Information",</p>
<p>"ja":"バージョン情報"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617605131499[].displaytype",</p>
<p>"title":"Preview",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"Detail",</p>
<p>"name_i18n":{</p>
<p>"en":"Detail",</p>
<p>"ja":"詳細表示"</p>
<p>},</p>
<p>"value":"detail"</p>
<p>},</p>
<p>{</p>
<p>"name":"Simple",</p>
<p>"name_i18n":{</p>
<p>"en":"Simple",</p>
<p>"ja":"簡易表示"</p>
<p>},</p>
<p>"value":"simple"</p>
<p>},</p>
<p>{</p>
<p>"name":"Preview",</p>
<p>"name_i18n":{</p>
<p>"en":"Preview",</p>
<p>"ja":"プレビュー"</p>
<p>},</p>
<p>"value":"preview"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Preview",</p>
<p>"ja":"表示形式"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Preview",</p>
<p>"ja":"表示形式"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617605131499[].licensetype",</p>
<p>"title":"License",</p>
<p>"titleMap":[</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"License",</p>
<p>"ja":"ライセンス"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"License",</p>
<p>"ja":"ライセンス"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"condition":"model.item_1617605131499[arrayIndex].licensetype == 'license_free'",</p>
<p>"key":"item_1617605131499[].licensefree",</p>
<p>"notitle":true,</p>
<p>"title":"自由ライセンス",</p>
<p>"title_i18n":{</p>
<p>"en":"自由ライセンス",</p>
<p>"ja":"自由ライセンス"</p>
<p>},</p>
<p>"type":"textarea"</p>
<p>},</p>
<p>{</p>
<p>"template":"&lt;div class='text-center' style='display:none;'&gt;&lt;a class='btn btn-primary' href='/ezas/pdf-detect-weko.html' target='_blank' role='button'&gt;{{ form.title }}&lt;/a&gt;&lt;/div&gt;",</p>
<p>"title":"Check Plagiarism",</p>
<p>"title_i18n":{</p>
<p>"en":"Check Plagiarism",</p>
<p>"ja":"剽窃チェック"</p>
<p>},</p>
<p>"type":"template"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617605131499[].accessrole",</p>
<p>"onChange":"accessRoleChange()",</p>
<p>"title":"Access",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"Open access",</p>
<p>"name_i18n":{</p>
<p>"en":"Open access",</p>
<p>"ja":"オープンアクセス"</p>
<p>},</p>
<p>"value":"open_access"</p>
<p>},</p>
<p>{</p>
<p>"name":"Input Open Access Date",</p>
<p>"name_i18n":{</p>
<p>"en":"Input Open Access Date",</p>
<p>"ja":"オープンアクセス日を指定する"</p>
<p>},</p>
<p>"value":"open_date"</p>
<p>},</p>
<p>{</p>
<p>"name":"Registered User Only",</p>
<p>"name_i18n":{</p>
<p>"en":"Registered User Only",</p>
<p>"ja":"ログインユーザのみ"</p>
<p>},</p>
<p>"value":"open_login"</p>
<p>},</p>
<p>{</p>
<p>"name":"Do not Publish",</p>
<p>"name_i18n":{</p>
<p>"en":"Do not Publish",</p>
<p>"ja":"公開しない"</p>
<p>},</p>
<p>"value":"open_no"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Access",</p>
<p>"ja":"アクセス"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Access",</p>
<p>"ja":"アクセス"</p>
<p>},</p>
<p>"type":"radios"</p>
<p>},</p>
<p>{</p>
<p>"condition":"model.item_1617605131499[arrayIndex].accessrole == 'open_date'",</p>
<p>"format":"yyyy-MM-dd",</p>
<p>"key":"item_1617605131499[].date[0].dateValue",</p>
<p>"templateUrl":"/static/templates/weko_deposit/datepicker.html",</p>
<p>"title":"Opendate",</p>
<p>"title_i18n":{</p>
<p>"en":"Opendate",</p>
<p>"ja":"公開日"</p>
<p>},</p>
<p>"type":"template"</p>
<p>},</p>
<p>{</p>
<p>"condition":"model.item_1617605131499[arrayIndex].accessrole == 'open_login'",</p>
<p>"key":"item_1617605131499[].groups",</p>
<p>"title":"Group",</p>
<p>"titleMap":[</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Group",</p>
<p>"ja":"グループ"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Group",</p>
<p>"ja":"グループ"</p>
<p>},</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617605131499",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"File",</p>
<p>"title_i18n":{</p>
<p>"en":"File",</p>
<p>"ja":"ファイル情報"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"item_1617620223087[].subitem_1565671149650",</p>
<p>"title":"Language",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"ja",</p>
<p>"value":"ja"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Kana",</p>
<p>"value":"ja-Kana"</p>
<p>},</p>
<p>{</p>
<p>"name":"ja-Latn",</p>
<p>"value":"ja-Latn"</p>
<p>},</p>
<p>{</p>
<p>"name":"en",</p>
<p>"value":"en"</p>
<p>},</p>
<p>{</p>
<p>"name":"fr",</p>
<p>"value":"fr"</p>
<p>},</p>
<p>{</p>
<p>"name":"it",</p>
<p>"value":"it"</p>
<p>},</p>
<p>{</p>
<p>"name":"de",</p>
<p>"value":"de"</p>
<p>},</p>
<p>{</p>
<p>"name":"es",</p>
<p>"value":"es"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-cn",</p>
<p>"value":"zh-cn"</p>
<p>},</p>
<p>{</p>
<p>"name":"zh-tw",</p>
<p>"value":"zh-tw"</p>
<p>},</p>
<p>{</p>
<p>"name":"ru",</p>
<p>"value":"ru"</p>
<p>},</p>
<p>{</p>
<p>"name":"la",</p>
<p>"value":"la"</p>
<p>},</p>
<p>{</p>
<p>"name":"ms",</p>
<p>"value":"ms"</p>
<p>},</p>
<p>{</p>
<p>"name":"eo",</p>
<p>"value":"eo"</p>
<p>},</p>
<p>{</p>
<p>"name":"ar",</p>
<p>"value":"ar"</p>
<p>},</p>
<p>{</p>
<p>"name":"el",</p>
<p>"value":"el"</p>
<p>},</p>
<p>{</p>
<p>"name":"ko",</p>
<p>"value":"ko"</p>
<p>}</p>
<p>],</p>
<p>"title_i18n":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Language",</p>
<p>"ja":"言語"</p>
<p>},</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617620223087[].subitem_1565671169640",</p>
<p>"title":"Banner Headline",</p>
<p>"title_i18n":{</p>
<p>"en":"Banner Headline",</p>
<p>"ja":"大見出し"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Banner Headline",</p>
<p>"ja":"大見出し"</p>
<p>},</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"item_1617620223087[].subitem_1565671178623",</p>
<p>"title":"Subheading",</p>
<p>"title_i18n":{</p>
<p>"en":"Subheading",</p>
<p>"ja":"小見出し"</p>
<p>},</p>
<p>"title_i18n_temp":{</p>
<p>"en":"Subheading",</p>
<p>"ja":"小見出し"</p>
<p>},</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"item_1617620223087",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"Heading",</p>
<p>"title_i18n":{</p>
<p>"en":"Heading",</p>
<p>"ja":"見出し"</p>
<p>}</p>
<p>},</p>
<p>{</p>
<p>"condition":1,</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"parentkey.subitem_systemidt_identifier",</p>
<p>"title":"SYSTEMIDT Identifier",</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"parentkey.subitem_systemidt_identifier_type",</p>
<p>"title":"SYSTEMIDT Identifier Type",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"DOI",</p>
<p>"value":"DOI"</p>
<p>},</p>
<p>{</p>
<p>"name":"HDL",</p>
<p>"value":"HDL"</p>
<p>},</p>
<p>{</p>
<p>"name":"URI",</p>
<p>"value":"URI"</p>
<p>}</p>
<p>],</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"system_identifier_doi",</p>
<p>"title":"Persistent Identifier(DOI)",</p>
<p>"title_i18n":{</p>
<p>"en":"Persistent Identifier(DOI)",</p>
<p>"ja":"永続識別子（DOI）"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"condition":1,</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"parentkey.subitem_systemidt_identifier",</p>
<p>"title":"SYSTEMIDT Identifier",</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"parentkey.subitem_systemidt_identifier_type",</p>
<p>"title":"SYSTEMIDT Identifier Type",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"DOI",</p>
<p>"value":"DOI"</p>
<p>},</p>
<p>{</p>
<p>"name":"HDL",</p>
<p>"value":"HDL"</p>
<p>},</p>
<p>{</p>
<p>"name":"URI",</p>
<p>"value":"URI"</p>
<p>}</p>
<p>],</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"system_identifier_hdl",</p>
<p>"title":"Persistent Identifier(HDL)",</p>
<p>"title_i18n":{</p>
<p>"en":"Persistent Identifier(HDL)",</p>
<p>"ja":"永続識別子（HDL）"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"condition":1,</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"parentkey.subitem_systemidt_identifier",</p>
<p>"title":"SYSTEMIDT Identifier",</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"parentkey.subitem_systemidt_identifier_type",</p>
<p>"title":"SYSTEMIDT Identifier Type",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"DOI",</p>
<p>"value":"DOI"</p>
<p>},</p>
<p>{</p>
<p>"name":"HDL",</p>
<p>"value":"HDL"</p>
<p>},</p>
<p>{</p>
<p>"name":"URI",</p>
<p>"value":"URI"</p>
<p>}</p>
<p>],</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"system_identifier_uri",</p>
<p>"title":"Persistent Identifier(URI)",</p>
<p>"title_i18n":{</p>
<p>"en":"Persistent Identifier(URI)",</p>
<p>"ja":"永続識別子（URI）"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>},</p>
<p>{</p>
<p>"condition":1,</p>
<p>"items":[</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"key":"parentkey.subitem_systemfile_filename[].subitem_systemfile_filename_label",</p>
<p>"title":"SYSTEMFILE Filename Label",</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"parentkey.subitem_systemfile_filename[].subitem_systemfile_filename_type",</p>
<p>"title":"SYSTEMFILE Filename Type",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"Abstract",</p>
<p>"value":"Abstract"</p>
<p>},</p>
<p>{</p>
<p>"name":"Fulltext",</p>
<p>"value":"Fulltext"</p>
<p>},</p>
<p>{</p>
<p>"name":"Summary",</p>
<p>"value":"Summary"</p>
<p>},</p>
<p>{</p>
<p>"name":"Thumbnail",</p>
<p>"value":"Thumbnail"</p>
<p>},</p>
<p>{</p>
<p>"name":"Other",</p>
<p>"value":"Other"</p>
<p>}</p>
<p>],</p>
<p>"type":"select"</p>
<p>},</p>
<p>{</p>
<p>"key":"parentkey.subitem_systemfile_filename[].subitem_systemfile_filename_uri",</p>
<p>"title":"SYSTEMFILE Filename URI",</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"parentkey.subitem_systemfile_filename",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"SYSTEMFILE Filename"</p>
<p>},</p>
<p>{</p>
<p>"key":"parentkey.subitem_systemfile_mimetype",</p>
<p>"title":"SYSTEMFILE MimeType",</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"key":"parentkey.subitem_systemfile_size",</p>
<p>"title":"SYSTEMFILE Size",</p>
<p>"type":"text"</p>
<p>},</p>
<p>{</p>
<p>"add":"New",</p>
<p>"items":[</p>
<p>{</p>
<p>"format":"yyyy-MM-dd",</p>
<p>"key":"parentkey.subitem_systemfile_datetime[].subitem_systemfile_datetime_date",</p>
<p>"templateUrl":"/static/templates/weko_deposit/datepicker.html",</p>
<p>"title":"SYSTEMFILE DateTime Date",</p>
<p>"type":"template"</p>
<p>},</p>
<p>{</p>
<p>"key":"parentkey.subitem_systemfile_datetime[].subitem_systemfile_datetime_type",</p>
<p>"title":"SYSTEMFILE DateTime Type",</p>
<p>"titleMap":[</p>
<p>{</p>
<p>"name":"Accepted",</p>
<p>"value":"Accepted"</p>
<p>},</p>
<p>{</p>
<p>"name":"Available",</p>
<p>"value":"Available"</p>
<p>},</p>
<p>{</p>
<p>"name":"Collected",</p>
<p>"value":"Collected"</p>
<p>},</p>
<p>{</p>
<p>"name":"Copyrighted",</p>
<p>"value":"Copyrighted"</p>
<p>},</p>
<p>{</p>
<p>"name":"Created",</p>
<p>"value":"Created"</p>
<p>},</p>
<p>{</p>
<p>"name":"Issued",</p>
<p>"value":"Issued"</p>
<p>},</p>
<p>{</p>
<p>"name":"Submitted",</p>
<p>"value":"Submitted"</p>
<p>},</p>
<p>{</p>
<p>"name":"Updated",</p>
<p>"value":"Updated"</p>
<p>},</p>
<p>{</p>
<p>"name":"Valid",</p>
<p>"value":"Valid"</p>
<p>}</p>
<p>],</p>
<p>"type":"select"</p>
<p>}</p>
<p>],</p>
<p>"key":"parentkey.subitem_systemfile_datetime",</p>
<p>"style":{</p>
<p>"add":"btn-success"</p>
<p>},</p>
<p>"title":"SYSTEMFILE DateTime"</p>
<p>},</p>
<p>{</p>
<p>"key":"parentkey.subitem_systemfile_version",</p>
<p>"title":"SYSTEMFILE Version",</p>
<p>"type":"text"</p>
<p>}</p>
<p>],</p>
<p>"key":"system_file",</p>
<p>"title":"File Information",</p>
<p>"title_i18n":{</p>
<p>"en":"File Information",</p>
<p>"ja":"ファイル情報"</p>
<p>},</p>
<p>"type":"fieldset"</p>
<p>}</p>
<p>]</p></td>
</tr>
</tbody>
</table>

  - 利用可能なロール

<table>
<thead>
<tr class="header">
<th>ロール</th>
<th>システム<br />
管理者</th>
<th>リポジトリ<br />
管理者</th>
<th>コミュニティ<br />
管理者</th>
<th>登録ユーザー</th>
<th>一般ユーザー</th>
<th>ゲスト<br />
(未ログイン)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>利用可否</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>

  - 機能内容

  - 関連モジュール

  - 処理概要

  - 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/11/14</p>
</blockquote></td>
<td>V0.9.27</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>
### Render

<!-- end list -->

#### 目的・用途

他のウェブアプリがweko3のリソースにアクセスできるようAPI利用を承認することを目的としている。

#### 利用方法

API-8-5の機能を用いて、OAuthアプリケーション、またはトークンを登録する。その後、設定された値を利用してAPI接続の設定を行う。


#### 構造

```
- meta_fix : アイテムタイプの定義上必須となっている固定プロパティの辞書
    - pubdate
        - title: "PubDate"
        - option: 
            - crtf: false,
            - hidden: false,
            - multiple: false,
            - required: true,
            - showlist: false
        - input_type: "datetime",
        - title_i18n: 
            - en: "PubDate",
            - ja: "公開日"
        - input_value: ""
- meta_list：アイテムタイプに含まれる固定プロパティ以外のプロパティの辞書
    - "item_1617186331708": {"title": "Title", "option": {"crtf": true, "hidden": false, "multiple": true, "required": true, "showlist": true}, "input_type": "cus_1001", "title_i18n": {"en": "Title", "ja": "タイトル"}, "input_value": "", "input_maxItems": "9999", "input_minItems": "1"}
- table_row：アイテムタイプの順序順プロパティ名のリスト
    -  ["item_1617186331708", "item_1617186385884",...]
- edit_notes
- meta_system
    - system_file": {
        - "title": "File Information",
        - "option": {
            - "crtf": false,
            - "hidden": true,
            - "oneline": false,
            - "multiple": false,
            - "required": false,
            - "showlist": false
        - "input_type": "cus_125",
        - "title_i18n": {
            - "en": "File Information",
            - "ja": "ファイル情報"
        - "input_value": ""
    - "system_identifier_doi": 
        - "title": "Persistent Identifier(DOI)",
        - "option": {
            - "crtf": false,
            - "hidden": true,
            - "oneline": false,
            - "multiple": false,
            - "required": false,
            - "showlist": false
        - "input_type": "cus_123",
        - "title_i18n": {
            - "en": "Persistent Identifier(DOI)",
            - "ja": "永続識別子（DOI）"
        - "input_value": ""
    - "system_identifier_hdl": {
        - "title": "Persistent Identifier(HDL)",
        - "option": {
            - "crtf": false,
            - "hidden": true,
            - "oneline": false,
            - "multiple": false,
            - "required": false,
            - "showlist": false
        - "input_type": "cus_123",
        - "title_i18n": {
            - "en": "Persistent Identifier(HDL)",
            - "ja": "永続識別子（HDL）"
        - "input_value": ""
    - "system_identifier_uri": {
        - "title": "Persistent Identifier(URI)",
        - "option": {
            - "crtf": false,
            - "hidden": true,
            - "oneline": false,
            - "multiple": false,
            - "required": false,
            - "showlist": false
        - "input_type": "cus_123",
        - "title_i18n": {
            - "en": "Persistent Identifier(URI)",
            - "ja": "永続識別子（URI）"
        - "input_value": ""
- upload_file：true or false.  使っていない？
- schemaeditor
    - schema
- table_row_map
    - form：アイテムタイプのJSON Form
    - name： アイテムタイプの名前
    - action： "upt"
    - schema：アイテムタイプのJSON Schema
        - type
        - "type": "object",
        - "$schema": "http://json-schema.org/draft-04/schema#",
        - "required": []
        - properties: {}
        - description: ""
    - mapping：プロパティのマッピング
        - system_identifier_doi": {
            - "ddi_mapping": {
                - "stdyDscr": {
                    - "citation": {
                        - "holdings": {
                            - "@attributes": {
                                - "URI": "subitem_systemidt_identifier"
            - "lom_mapping": "",
            - "lido_mapping": "",
            - "spase_mapping": "",
            - "jpcoar_mapping": {
                - "identifier": {
                    - "@value": "subitem_systemidt_identifier",
                    - "@attributes": {
                        - "identifierType": "subitem_systemidt_identifier_type"
            - "junii2_mapping": "",
            - "oai_dc_mapping": {
                - "identifier": {
                    - "@value": "subitem_systemidt_identifier"      
            - "display_lang_type": "",
            - "jpcoar_v1_mapping": {
                - "identifier": {
                    - "@value": "subitem_systemidt_identifier",
                        - "@attributes": {
                            - "identifierType": "subitem_systemidt_identifier_type"
```

#### 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>
### Schema

  - > 目的・用途

他のウェブアプリがweko3のリソースにアクセスできるようAPI利用を承認することを目的としている。

  - > 利用方法

API-8-5の機能を用いて、OAuthアプリケーション、またはトークンを登録する。その後、設定された値を利用してAPI接続の設定を行う。

  - > 機能内容

/items/jsonschema/{item type id}

  - > 関連モジュール

<!-- end list -->

  - > Invenio\_oaiserver

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>## モジュール、ライブラリ

利用モジュール、ライブラリは以下のとおり

  - invenioモジュール（<https://github.com/RCOSDP/weko/blob/hfix/packages-invenio.txt>）

  - wekoモジュール（<https://github.com/RCOSDP/weko/blob/v0.9.22/requirements-weko-modules.txt>）

  - パッケージ（<https://github.com/RCOSDP/weko/blob/v0.9.22/packages.txt>）

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>## コンフィグ

1.優先度

invenio.cfg(instans.cfg) \> config.py(各モジュール)

2.invenio.cfg

  - webコンテナビルド時にinstance.cfgから invenio.cfg([コンフィグ一覧](https://redmine.devops.rcos.nii.ac.jp/attachments/26751/invenio_cfg.xlsx) )が生成される。
    
      - instance.cfg: <https://github.com/RCOSDP/weko/blob/v0.9.22/scripts/instance.cfg>

  - 各configのパラメータについて、以下のパラメータが「invenio.cfg」にてオーバーライド可能である。

> TEMPLATES\_AUTO\_RELOAD
> 
> SQLALCHEMY\_DATABASE\_URI
> 
> SQLALCHEMY\_TRACK\_MODIFICATIONS
> 
> DB\_POOL\_CLASS
> 
> COLLECT\_STORAGE
> 
> INDEXER\_BULK\_REQUEST\_TIMEOUT
> 
> CACHE\_TYPE
> 
> CACHE\_REDIS\_HOST
> 
> CACHE\_REDIS\_URL
> 
> ACCOUNTS\_SESSION\_REDIS\_URL
> 
> BROKER\_URL
> 
> CELERY\_BROKER\_URL
> 
> CELERY\_RESULT\_BACKEND
> 
> CELERY\_BEAT\_SCHEDULE
> 
> SEARCH\_ELASTIC\_HOSTS
> 
> SEARCH\_INDEX\_PREFIX
> 
> JSONSCHEMAS\_ENDPOINT
> 
> JSONSCHEMAS\_HOST
> 
> OAISERVER\_REPOSITORY\_NAME
> 
> OAISERVER\_RECORD\_INDEX
> 
> OAISERVER\_ID\_PREFIX
> 
> APP\_DEFAULT\_SECURE\_HEADERS
> 
> SESSION\_COOKIE\_DOMAIN
> 
> SESSION\_COOKIE\_SAMESITE
> 
> SESSION\_COOKIE\_SECURE
> 
> BABEL\_DEFAULT\_LOCALE
> 
> BABEL\_DEFAULT\_LANGUAGE
> 
> I18N\_LANGUAGES
> 
> I18N\_TRANSLATIONS\_PATHS
> 
> SECURITY\_EMAIL\_SENDER
> 
> THEME\_MATHJAX\_CDN
> 
> FILES\_REST\_STORAGE\_FACTORY
> 
> S3\_ACCCESS\_KEY\_ID
> 
> S3\_SECRECT\_ACCESS\_KEY
> 
> S3\_SEND\_FILE\_DIRECTLY
> 
> S3\_ENDPOINT\_URL
> 
> FILES\_REST\_LOCATION\_TYPE\_LIST
> 
> WEKO\_JUPYTERHUB\_ENABLE
> 
> WEKO\_JUPYTERHUB\_URL
> 
> THEME\_SITENAME
> 
> THEME\_SITEURL
> 
> WEKO\_RECORDS\_UI\_LICENSE\_ICON\_LOCATION
> 
> WEKO\_RECORDS\_UI\_LICENSE\_ICON\_PDF\_LOCATION
> 
> WEKO\_RECORDS\_UI\_LICENSE\_DICT
> 
> WEKO\_ACCOUNTS\_SHIB\_LOGIN\_ENABLED
> 
> WEKO\_ACCOUNTS\_SHIB\_IDP\_LOGIN\_URL
> 
> WEKO\_ACCOUNTS\_SSO\_ATTRIBUTE\_MAP
> 
> WEKO\_ACCOUNTS\_SHIB\_IDP\_LOGIN\_ENABLED
> 
> WEKO\_ACCOUNTS\_SHIB\_DP\_LOGIN\_DIRECTLY\_ENABLED
> 
> WEKO\_ACCOUNTS\_SHIB\_INST\_LOGIN\_DIRECTLY\_ENABLED
> 
> WEKO\_ITEMTYPES\_UI\_UPGRADE\_VERSION\_ENABLED
> 
> WEKO\_WORKFLOW\_MAIL\_TEMPLATE\_FOLDER\_PATH
> 
> WEKO\_WORKFLOW\_ACCESS\_ACTIVITY\_URL
> 
> WEKO\_WORKFLOW\_USAGE\_REPORT\_ACTIVITY\_URL
> 
> WEKO\_WORKFLOW\_APPROVE\_DONE
> 
> WEKO\_WORKFLOW\_APPROVE\_REJECTED
> 
> WEKO\_WORKFLOW\_REQUEST\_APPROVAL
> 
> WEKO\_WORKFLOW\_REQUEST\_FOR\_REGISTER\_USAGE\_REPORT
> 
> WEKO\_WORKFLOW\_USAGE\_REPORT\_WORKFLOW\_NAME
> 
> WEKO\_RECORDS\_UI\_SECRET\_KEY
> 
> WEKO\_ITEMS\_UI\_HIDE\_AUTO\_FILL\_METADATA

3.config.py

<table>
<thead>
<tr class="header">
<th><blockquote>
<p>モジュール</p>
</blockquote></th>
<th>configuration</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>invenio-accounts</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-accounts/invenio_accounts/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-accounts/invenio_accounts/config.py</a></td>
</tr>
<tr class="even">
<td>invenio-communities</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-communities/invenio_communities/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-communities/invenio_communities/config.py</a></td>
</tr>
<tr class="odd">
<td>invenio-db</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-db/invenio_db/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-db/invenio_db/config.py</a></td>
</tr>
<tr class="even">
<td>invenio-deposit</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-deposit/invenio_deposit/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-deposit/invenio_deposit/config.py</a></td>
</tr>
<tr class="odd">
<td>invenio-files-rest</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-files-rest/invenio_files_rest/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-files-rest/invenio_files_rest/config.py</a></td>
</tr>
<tr class="even">
<td>invenio-iiif</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-iiif/invenio_iiif/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-iiif/invenio_iiif/config.py</a></td>
</tr>
<tr class="odd">
<td>invenio-indexer</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-indexer/invenio_indexer/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-indexer/invenio_indexer/config.py</a></td>
</tr>
<tr class="even">
<td>invenio-mail</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-mail/invenio_mail/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-mail/invenio_mail/config.py</a></td>
</tr>
<tr class="odd">
<td>invenio-oaiharvester</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-oaiharvester/invenio_oaiharvester/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-oaiharvester/invenio_oaiharvester/config.py</a></td>
</tr>
<tr class="even">
<td>invenio-oaiserver</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-oaiserver/invenio_oaiserver/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-oaiserver/invenio_oaiserver/config.py</a></td>
</tr>
<tr class="odd">
<td>invenio-oauth2server</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-oauth2server/invenio_oauth2server/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-oauth2server/invenio_oauth2server/config.py</a></td>
</tr>
<tr class="even">
<td>invenio-previewer</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-previewer/invenio_previewer/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-previewer/invenio_previewer/config.py</a></td>
</tr>
<tr class="odd">
<td>invenio-queues</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-queues/invenio_queues/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-queues/invenio_queues/config.py</a></td>
</tr>
<tr class="even">
<td>invenio-records</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-records/invenio_records/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-records/invenio_records/config.py</a></td>
</tr>
<tr class="odd">
<td>invenio-records-rest</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-records-rest/invenio_records_rest/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-records-rest/invenio_records_rest/config.py</a></td>
</tr>
<tr class="even">
<td>invenio-resourcesyncclient</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-resourcesyncclient/invenio_resourcesyncclient/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-resourcesyncclient/invenio_resourcesyncclient/config.py</a></td>
</tr>
<tr class="odd">
<td>invenio-resourcesyncserver</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-resourcesyncserver/invenio_resourcesyncserver/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-resourcesyncserver/invenio_resourcesyncserver/config.py</a></td>
</tr>
<tr class="even">
<td>invenio-s3</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-s3/invenio_s3/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-s3/invenio_s3/config.py</a></td>
</tr>
<tr class="odd">
<td>invenio-stats</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/invenio_stats/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/invenio_stats/config.py</a></td>
</tr>
<tr class="even">
<td>weko-accounts</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-accounts/weko_accounts/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-accounts/weko_accounts/config.py</a></td>
</tr>
<tr class="odd">
<td>weko-admin</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-admin/weko_admin/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-admin/weko_admin/config.py</a></td>
</tr>
<tr class="even">
<td>weko-authors</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-authors/weko_authors/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-authors/weko_authors/config.py</a></td>
</tr>
<tr class="odd">
<td>weko-bulkupdate</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-bulkupdate/weko_bulkupdate/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-bulkupdate/weko_bulkupdate/config.py</a></td>
</tr>
<tr class="even">
<td>weko-deposit</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-deposit/weko_deposit/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-deposit/weko_deposit/config.py</a></td>
</tr>
<tr class="odd">
<td>weko-gridlayout</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-gridlayout/weko_gridlayout/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-gridlayout/weko_gridlayout/config.py</a></td>
</tr>
<tr class="even">
<td>weko-groups</td>
<td>config.py無し</td>
</tr>
<tr class="odd">
<td>weko-handle</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-handle/weko_handle/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-handle/weko_handle/config.py</a></td>
</tr>
<tr class="even">
<td>weko-index-tree</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-index-tree/weko_index_tree/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-index-tree/weko_index_tree/config.py</a></td>
</tr>
<tr class="odd">
<td>weko-indextree-journal</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-indextree-journal/weko_indextree_journal/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-indextree-journal/weko_indextree_journal/config.py</a></td>
</tr>
<tr class="even">
<td>weko-items-autofill</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-items-autofill/weko_items_autofill/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-items-autofill/weko_items_autofill/config.py</a></td>
</tr>
<tr class="odd">
<td>weko-items-ui</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-items-ui/weko_items_ui/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-items-ui/weko_items_ui/config.py</a></td>
</tr>
<tr class="even">
<td>weko-itemtypes-ui</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-itemtypes-ui/weko_itemtypes_ui/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-itemtypes-ui/weko_itemtypes_ui/config.py</a></td>
</tr>
<tr class="odd">
<td>weko-logging</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-logging/weko_logging/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-logging/weko_logging/config.py</a></td>
</tr>
<tr class="even">
<td>weko-plugins</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-plugins/weko_plugins/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-plugins/weko_plugins/config.py</a></td>
</tr>
<tr class="odd">
<td>weko-records</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records/weko_records/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records/weko_records/config.py</a></td>
</tr>
<tr class="even">
<td>weko-records-ui</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-records-ui/weko_records_ui/config.py</a></td>
</tr>
<tr class="odd">
<td>weko-redis</td>
<td>config.py無し</td>
</tr>
<tr class="even">
<td>weko-schema-ui</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-schema-ui/weko_schema_ui/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-schema-ui/weko_schema_ui/config.py</a></td>
</tr>
<tr class="odd">
<td>weko-search-ui</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-search-ui/weko_search_ui/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-search-ui/weko_search_ui/config.py</a></td>
</tr>
<tr class="even">
<td>weko-sitemap</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-sitemap/weko_sitemap/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-sitemap/weko_sitemap/config.py</a></td>
</tr>
<tr class="odd">
<td>weko-theme</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-theme/weko_theme/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-theme/weko_theme/config.py</a></td>
</tr>
<tr class="even">
<td>weko-user-profiles</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-user-profiles/weko_user_profiles/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-user-profiles/weko_user_profiles/config.py</a></td>
</tr>
<tr class="odd">
<td>weko-workflow</td>
<td><a href="https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-workflow/weko_workflow/config.py">https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-workflow/weko_workflow/config.py</a></td>
</tr>
</tbody>
</table>

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>## DB

  - 以下のテーブル定義書を参照。
    
      - <https://rcosms-my.sharepoint.com/:x:/g/personal/hayashi_rcosms_onmicrosoft_com/EWhQWKgVVz5Ji7mhWAopjkkBh7rlApLCcDcYCI1t9vPCgw?e=yghIXB>

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table># elasticsearch



indices

> $ docker-compose exec elasticsearch curl -s http://localhost:9200/\_cat/indices?h=i|sort
> 
> \~snip\~
> 
> tenant1-authors-author-v1.0.0
> 
> tenant1-deposits-deposit-v1.0.0
> 
> tenant1-events-stats-celery-task-000001
> 
> tenant1-events-stats-file-download-000001
> 
> tenant1-events-stats-file-preview-000001
> 
> tenant1-events-stats-item-create-000001
> 
> tenant1-events-stats-record-view-000001
> 
> tenant1-events-stats-search-000001
> 
> tenant1-events-stats-top-view-000001
> 
> tenant1-marc21-authority-ad-v1.0.0
> 
> tenant1-marc21-bibliographic-bd-v1.0.0
> 
> tenant1-marc21-holdings-hd-v1.0.0
> 
> tenant1-stats-bookmarks
> 
> tenant1-stats-celery-task-000001
> 
> tenant1-stats-file-download-000001
> 
> tenant1-stats-file-preview-000001
> 
> tenant1-stats-item-create-000001
> 
> tenant1-stats-record-view-000001
> 
> tenant1-stats-search-000001
> 
> tenant1-stats-top-view-000001
> 
> tenant1-weko-item-v1.0.0

template

> docker-compose exec elasticsearch curl -s http://localhost:9200/\_cat/templates?h=n,t|grep tenant1|sort
> 
> \~snip\~
> 
> tenant1-aggregations-aggr\_celery\_task/v6-aggr-celery-task-v1 \[tenant1-stats-celery-task-\*\]
> 
> tenant1-aggregations-aggr\_file\_download/v6-aggr-file-download-v1 \[tenant1-stats-file-download-\*\]
> 
> tenant1-aggregations-aggr\_file\_preview/v6-aggr-file-preview-v1 \[tenant1-stats-file-preview-\*\]
> 
> tenant1-aggregations-aggr\_item\_create/v6-aggr-item-create-v1 \[tenant1-stats-item-create-\*\]
> 
> tenant1-aggregations-aggr\_record\_view/v6-aggr-record-view-v1 \[tenant1-stats-record-view-\*\]
> 
> tenant1-aggregations-aggr\_search/v6-aggr-search-v1 \[tenant1-stats-search-\*\]
> 
> tenant1-aggregations-aggr\_top\_view/v6-aggr-top-view-v1 \[tenant1-stats-top-view-\*\]
> 
> tenant1-celery\_task/v6-celery-task-v1 \[tenant1-events-stats-celery-task-\*\]
> 
> tenant1-file\_download/v6-file-download-v1 \[tenant1-events-stats-file-download-\*\]
> 
> tenant1-file\_preview/v6-file-preview-v1 \[tenant1-events-stats-file-preview-\*\]
> 
> tenant1-item\_create/v6-item-create-v1 \[tenant1-events-stats-item-create-\*\]
> 
> tenant1-record\_view/v6-record-view-v1 \[tenant1-events-stats-record-view-\*\]
> 
> tenant1-search/v6-search-v1 \[tenant1-events-stats-search-\*\]
> 
> tenant1-top\_view/v6-top-view-v1 \[tenant1-events-stats-top-view-\*\]

  - マッピング
    
      - item（https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-schema-ui/weko\_schema\_ui/mappings/v6/weko/item-v1.0.0.json）
    
      - author（https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-authors/weko\_authors/mappings/v6/authors/author-v1.0.0.json）
    
      - file-download（https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats//contrib/file\_download/v6/file-download-v1.json）
    
      - file-preview（https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/invenio\_stats/contrib/file\_preview/v6/file-preview-v1.json）
    
      - item-create（https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/invenio\_stats/contrib/item\_create/v6/item-create-v1.json）
    
      - record-view（https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/ invenio\_stats /contrib/record\_view/v6/record-view-v1.json）
    
      - search（https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/invenio\_stats/contrib/search/v6/search-v1.json）
    
      - top-view（https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/invenio\_stats/contrib/top\_view/v6/top-view-v1.json）
    
      - celery-task（https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/invenio\_stats/contrib/celery\_task/v6/celery-task-v1.json）
    
      - aggr-file-download（https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/invenio\_stats/contrib/aggregations/aggr\_file\_download/v6/aggr-file-download-v1.json）
    
      - aggr-file-preview（https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/invenio\_stats/contrib/aggregations/aggr\_file\_preview/v6/aggr-file-preview-v1.json）
    
      - aggr-item-create（<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/invenio_stats/contrib/aggregations/aggr_item_create/v6/aggr-item-create-v1.json>）
    
      - aggr-record-view（<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/invenio_stats/contrib/aggregations/aggr_record_view/v6/aggr-record-view-v1.json>）
    
      - aggr-search（https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/invenio\_stats/contrib/aggregations/aggr\_search/v6/aggr-search-v1.json）
    
      - aggr-top-view（https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/invenio\_stats/contrib/aggregations/aggr\_top\_view/v6/aggr-top-view-v1.json）
    
      - aggr-celery-task（https://github.com/RCOSDP/weko/blob/v0.9.22/modules/invenio-stats/invenio\_stats/contrib/aggregations/aggr\_celery\_task/v6/aggr-celery-task-v1.json）

Invenio index コマンドによる再インデクシング

  - > reindexの処理概要


  ```
  Usage: invenio index reindex [OPTIONS]

  Reindex all records.

  :param pid_type: Pid type.

Options:
  --yes-i-know
  -t, --pid-type TEXT  [required]
  --include-delete
  --skip-exists
  --size INTEGER
  --help 
  ```

invenio index reindex -t recid --yes-i-know

  - select \* from pidstore\_pid where object\_type='rec' and status='R' and pid\_type='recid';
    
      - の、条件にあたるアイテム分のbulk indexing タスクがqueue に登録されます。
    
      - 親情報はpid\_type='parent' のためこの対象になりません。

  - invenio index run --skip-errors
    
      - queueに登録されたタスクが実行されます。
    
      - 既にアイテムのデータがあれば上書き、無ければ新規登録。
    
      - エラーが発生しても他のタスクは処理を続けます。エラーだったものは上書き/新規登録されません。




<!-- end list -->

  - > 使い方

1\) インデックス削除

$ docker-compose exec web invenio index destroy --yes-i-know

2\) インデックス初期化

$ docker-compose exec web invenio index init

3\) インデックスキュー初期化

$ docker-compose exec web invenio index queue init

4\) パイプライン設定　v.1.0.4より不要となりました。

$ curl -XPUT 'http://localhost:29202/\_ingest/pipeline/item-file-pipeline' -H 'Content-Type: application/json' -d '{

"description" : "Index contents of each file.",

"processors" : \[

{

"foreach": {

"field": "content",

"processor": {

"attachment": {

"indexed\_chars" : -1,

"target\_field": "\_ingest.\_value.attachment",

"field": "\_ingest.\_value.file",

"properties": \[

"content"

\]

}

}

}

}

\]

}'

5\) 再インデクシング

$ docker-compose exec web invenio index reindex -t recid --yes-i-know

6\) インデックス登録

$ docker-compose exec web invenio index run --skip-errors


| TH | TH | TH |
| ---- | ---- | ---- |
| Usage: invenio index reindex [OPTIONS] || |
| Reindex all records. | | |
| :param pid_type: Pid type. | | |
| Options: | | |
|  | -t, --pid-type TEXT  [required]  | |
|  | --include-delete  | 削除済みアイテムをreindexする |
|  | --skip-exists  | |
|  | --size INTEGER | |
|  | --help  | |


reindex時、ボディサイズがINDEXER\_MAX\_BODY\_SIZEを超える場合は、BASE64 fileを削除(v1.0.7では意味のない処理)。

```
INDEXER_MAX_BODY_SIZE = 62914560
```

## クエリ例

### root_file_idの値がない(null,"")ドキュメントを検索

```
curl "http://localhost:9200/tenant1-stats-file-download/_search?pretty" -d '{"query":{"bool":{"should":[{"bool":{"must_not":{"exists":{"field":"root_file_id"}}}},{"term":{"root_file_id":""}}]}},"_source":["_id","file_id","root_file_id","bucket_id","file_key"]}' -H 'Content-type: application/json'
```

curl "http://localhost:9200/tenant1-events-stats-file-download/_search?pretty" -d '{"query":{"bool":{"should":[{"bool":{"must_not":{"exists":{"field":"root_file_id"}}}},{"term":{"root_file_id":""}}]}},"_source":["_id","file_id","root_file_id","bucket_id","file_key"]}' -H 'Content-type: application/json'


curl "http://localhost:9200/grips_repo_nii_ac_jp-stats-file-download/_search?pretty" -d '{"query":{"bool":{"should":[{"bool":{"must_not":{"exists":{"field":"root_file_id"}}}},{"term":{"root_file_id":""}}]}},"_source":["_id","file_id","root_file_id","bucket_id","file_key"]}' -H 'Content-type: application/json'

curl "http://localhost:9200/grips_repo_nii_ac_jp-events-stats-file-download/_search?pretty" -d '{"query":{"bool":{"should":[{"bool":{"must_not":{"exists":{"field":"root_file_id"}}}},{"term":{"root_file_id":""}}]}},"_source":["_id","file_id","root_file_id","bucket_id","file_key"]}' -H 'Content-type: application/json'

# curl "http://localhost:9200/grips_repo_nii_ac_jp-events-stats-file-download/_search?pretty" -d '{"query":{"bool":{"must_not":{"exists":{"field":"root_file_id"}}}},"size":0}' -H 'Content-type: appli
cation/json'



curl 'http://localhost:9200/grips_repo_nii_ac_jp-events-stats-file-download-000001/stats-file-download/2021-10-01T10:00:00-6406d627e650ab25cd2bc0b46b07e866d5f09887?pretty'


curl 'http://localhost:9200/grips_repo_nii_ac_jp-stats-file-download-000001/file-download-day-aggregation/420494d5-6a5d-328d-b553-2dd7f3398952?pretty'

curl 'http://localhost:9200/grips_repo_nii_ac_jp-events-stats-file-download-000001/stats-file-download/2021-10-01T10:00:00-6406d627e650ab25cd2bc0b46b07e866d5f09887'



 curl -X POST 'http://localhost:9200/_snapshot/grips/snapshot_all/_restore?wait_for_completion=true' -H 'Content-Type: application/json' -d '{"indices": "grips_repo_nii_ac_jp*","ignore_unavailable": true,"include_global_state": true}'

 curl -X DELETE http://localhost:9200/grips_repo*


###

```
curl "http://localhost:9200/tenant1-events-stats-file-download-000001/stats-file-download/2024-05-02T15:40:30-9262f1675b96f8481cc7c924d4c88a4ebf816649/_update" -d '{"doc":{"file_id":"","root_file_id":""}}' -H 'Content-type: application/json' -X POST
```


## 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>## celery タスク

  - 定期実行するCeleryタスクはinstance.cfg(invenio.cfg)のCELERY\_BEAT\_SCHEDULE にて定義する。

> CELERY\_BEAT\_SCHEDULE = {
> 
> \# Stats
> 
> 'stats-process-events': {
> 
> 'task': 'invenio\_stats.tasks.process\_events',
> 
> 'schedule': timedelta(minutes=1),
> 
> 'args': \[('celery-task', 'item-create', 'top-view', 'record-view', 'file-download', 'file-preview', 'search')\],
> 
> },
> 
> 'stats-aggregate-events': {
> 
> 'task': 'invenio\_stats.tasks.aggregate\_events',
> 
> 'schedule': timedelta(days=1),
> 
> 'args': \[('celery-task-agg', 'file-download-agg', 'file-preview-agg', 'item-create-agg', 'record-view-agg', 'search-agg', 'top-view-agg')\],
> 
> },
> 
> \# WEKO-indextree-journal-export
> 
> 'indextree-journal-export-journal': {
> 
> 'task': 'weko\_indextree\_journal.tasks.export\_journal\_task',
> 
> 'schedule': timedelta(days=1),
> 
> 'args': \[('p\_path')\],
> 
> },
> 
> 'admin-send-report-emails': {
> 
> 'task': 'weko\_admin.tasks.check\_send\_all\_reports',
> 
> 'schedule': timedelta(days=1, minutes=0, hours=0),
> 
> 'args': \[\],
> 
> },
> 
> 'harvest-check-schedules': {
> 
> 'task': 'invenio\_oaiharvester.tasks.check\_schedules\_and\_run',
> 
> 'schedule': crontab(hour=0, minute=0, day\_of\_week='\*'),
> 
> 'args': \[\],
> 
> },
> 
> 'send-feedback-mail-schedules': {
> 
> 'task': 'weko\_admin.tasks.send\_feedback\_mail',
> 
> 'schedule': crontab(day\_of\_month='1', hour=0, minute=0),
> 
> 'args': \[\],
> 
> },
> 
> 'send\_storage\_alert\_mail': {
> 
> 'task': 'invenio\_files\_rest.tasks.check\_send\_alert\_mail',
> 
> 'schedule': timedelta(days=1, minutes=0, hours=0),
> 
> 'args': \[\],
> 
> },
> 
> 'send\_site\_access\_mail': {
> 
> 'task': 'weko\_admin.tasks.check\_send\_site\_access\_report',
> 
> 'schedule': timedelta(days=1, minutes=0, hours=0),
> 
> 'args': \[\],
> 
> },
> 
> 'remove\_preview\_pdf': {
> 
> 'task': 'invenio\_files\_rest.tasks.check\_file\_storage\_time',
> 
> 'schedule': timedelta(days=0, minutes=0, hours=1),
> 
> 'args': \[\],
> 
> },
> 
> 'update\_sitemap': {
> 
> 'task': 'weko\_sitemap.tasks.update\_sitemap',
> 
> 'schedule': timedelta(days=3, minutes=0, hours=0),
> 
> 'args': \[\],
> 
> },
> 
> 'resync': {
> 
> 'task': 'invenio\_resourcesyncclient.tasks.run\_sync\_auto',
> 
> 'schedule': crontab(hour=0, minute=0),
> 
> },
> 
> \# Execute cancel\_usage\_report\_activities daily at midnight
> 
> 'cancel\_usage\_report\_activities': {
> 
> 'task': 'weko\_workflow.tasks.cancel\_expired\_usage\_report\_activities',
> 
> 'schedule': crontab(minute=0, hour=0),
> 
> },
> 
> 'clean\_temp\_info': {
> 
> 'task': 'weko\_admin.tasks.clean\_temp\_info',
> 
> 'schedule': timedelta(hours=1),
> 
> 'args': \[\],
> 
> },
> 
> }

docker-compose -f docker-compose2.yml exec --user root web celery -A invenio_app.celery call weko_admin.tasks.send_feedback_mail
4f30e29f-f217-4103-8ddf-e7cd1159b36a

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
## ログ

  - > ログレベルの定義

| **レベル**  | **内容例**                      | **発生時に必要な対処例**                          |
| -------- | ---------------------------- | --------------------------------------- |
| CRITICAL | ・システムの継続運用が不可能なレベル           | ・発生時は24時間体制での初動が必要                      |
|          | ・ユーザーデータを破壊し続けるレベル           | ・24時間SMO/PMOへのエスカレーションが必要               |
| ERROR    | ・システムは継続運用可能だが特定の機能でエラーが発生   | ・営業時間外でもベストエフォートでの事象確認が必要               |
|          | ・ユーザーデータ破壊の可能性は低い            | ・営業時間外に発生した場合、詳細調査・対応・エスカレーションは翌営業時間に実施 |
| WARNING  | ・システムは継続運用可能かつエラーがあっても代替機能あり | ・営業時間内で事象を確認、対処方法を検討                    |
|          | ・ユーザーデータは破壊しない               |                                         |
| INFO     | ・システム稼動状況、非同期処理の開始終了状況など     | ・特に対処不要                                 |
|          | ・ユーザーオペレーションのイベントログ          | ・運用状況、ユーザー利用状況の確認などで定期的に集計              |
| DEBUG    | ・基本的に本番運用では出力しなくて良い情報。       | ・対処不要                                   |
|          | ・開発、運用テスト時に必要な情報             |                                         |

 

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table># 利用統計ログ

## 目的・用途

## 利用方法

## 利用可能なロール

## 機能内容


  - invenio-stats によるログ設定手順は、  
    別紙「Precedure\_of\_implementing\_file-download\_function\_V1.02.xlsx」を参照

  - CELERY SCHEDULE 設定  
    [https://github.com/RCOSDP/weko/blob/develop/scripts/instance.cfghttps://github.com/RCOSDP/weko/blob/v0.9.22/scripts/instance.cfg\#L70](https://github.com/RCOSDP/weko/blob/v0.9.22/scripts/instance.cfg#L70)  
    のCELERY\_BEAT\_SCHEDULE に、以下のように追加する

> CELERY\_BEAT\_SCHEDULE = {
> 
> \# Stats
> 
> 'stats-process-events': {
> 
> 'task': 'invenio\_stats.tasks.process\_events',
> 
> 'schedule': timedelta(minutes=1),
> 
> 'args': \[('celery-task', 'item-create', 'top-view', 'record-view', 'file-download', 'file-preview', 'search')\],
> 
> },

  - 各種ログはelasticsearchに格納されており、インデックスを指定して取得することができる
    
      - インデックスについては[その他-4: elasticsearch](#elasticsearch)を参照
    
      - 生データである「events-stats-{ログの種類}」から、統計情報「stats-{ログの種類}」を作成している

  - celery-task ログ
    
      - http://{Elasticsearch:port} /{stats-celery-task のインデックス}/\_search?pretty

> {
> 
> "took" : 6,
> 
> "timed\_out" : false,
> 
> "\_shards" : {
> 
> "total" : 5,
> 
> "successful" : 5,
> 
> "skipped" : 0,
> 
> "failed" : 0
> 
> },
> 
> "hits" : {
> 
> "total" : 1,
> 
> "max\_score" : 1.0,
> 
> "hits" : \[
> 
> {
> 
> "\_index" : "tenant1-stats-celery-task-000001",
> 
> "\_type" : "celery-task-day-aggregation",
> 
> "\_id" : "7b2c80be-4058-360f-a247-d228118032d2",
> 
> "\_score" : 1.0,
> 
> "\_source" : {
> 
> "timestamp" : "2023-05-10T00:00:00",
> 
> "unique\_id" : "7b2c80be-4058-360f-a247-d228118032d2",
> 
> "count" : 1,
> 
> "unique\_count" : 1,
> 
> "volume" : 0.0,
> 
> "task\_id" : "21c1fc79-9f16-4f5d-85d6-c556074a5db3",
> 
> "task\_name" : "harvest",
> 
> "task\_state" : "SUCCESS",
> 
> "start\_time" : "2023-05-10T09:36:35",
> 
> "end\_time" : "2023-05-10T00:36:37",
> 
> "total\_records" : 0,
> 
> "repository\_name" : "weko",
> 
> "execution\_time" : "-1 day, 15:00:02.734294"
> 
> }
> 
> }
> 
> \]
> 
> }
> 
> }

  - file-download ログ
    
      - http://{Elasticsearch:port} /{ stats-file-download のインデックス}/\_search?pretty

> {
> 
> "took" : 2,
> 
> "timed\_out" : false,
> 
> "\_shards" : {
> 
> "total" : 5,
> 
> "successful" : 5,
> 
> "skipped" : 0,
> 
> "failed" : 0
> 
> },
> 
> "hits" : {
> 
> "total" : 32,
> 
> "max\_score" : 1.0,
> 
> "hits" : \[
> 
> {
> 
> "\_index" : "tenant1-stats-file-download-000001",
> 
> "\_type" : "file-download-day-aggregation",
> 
> "\_id" : "b72c0fab-9215-3a8d-9ba1-bbae7162ea68",
> 
> "\_score" : 1.0,
> 
> "\_source" : {
> 
> "timestamp" : "2023-05-11T00:00:00",
> 
> "unique\_id" : "b72c0fab-9215-3a8d-9ba1-bbae7162ea68",
> 
> "count" : 1,
> 
> "unique\_count" : 1,
> 
> "volume" : 42786.0,
> 
> "country" : null,
> 
> "item\_id" : "4",
> 
> "item\_title" : "テストアイテム壱",
> 
> "file\_key" : "2.2.png",
> 
> "bucket\_id" : "c6202711-3af2-4ca1-943a-a14584b131a9",
> 
> "file\_id" : "fc178212-279a-49cd-ba8e-2ccbe8bc1a33",
> 
> "root\_file\_id" : "fc178212-279a-49cd-ba8e-2ccbe8bc1a33",
> 
> "accessrole" : "open\_access",
> 
> "userrole" : "System Administrator",
> 
> "index\_list" : "テストインデックス１",
> 
> "is\_billing\_item" : false,
> 
> "billing\_file\_price" : "",
> 
> "user\_group\_names" : "",
> 
> "site\_license\_name" : "",
> 
> "site\_license\_flag" : false,
> 
> "cur\_user\_id" : 1,
> 
> "hostname" : "None",
> 
> "remote\_addr" : "192.168.56.1"
> 
> }
> 
> },...
> 
> \]
> 
> }
> 
> }

  - file-preview ログ
    
      - http://{Elasticsearch:port} /{ stats- file-preview のインデックス}/\_search?pretty

> {
> 
> "took" : 1,
> 
> "timed\_out" : false,
> 
> "\_shards" : {
> 
> "total" : 5,
> 
> "successful" : 5,
> 
> "skipped" : 0,
> 
> "failed" : 0
> 
> },
> 
> "hits" : {
> 
> "total" : 1,
> 
> "max\_score" : 1.0,
> 
> "hits" : \[
> 
> {
> 
> "\_index" : "tenant1-stats-file-preview-000001",
> 
> "\_type" : "file-preview-day-aggregation",
> 
> "\_id" : "d665fc18-c050-3868-ae6f-45daaa06495d",
> 
> "\_score" : 1.0,
> 
> "\_source" : {
> 
> "timestamp" : "2023-07-15T00:00:00",
> 
> "unique\_id" : "d665fc18-c050-3868-ae6f-45daaa06495d",
> 
> "count" : 1,
> 
> "unique\_count" : 1,
> 
> "volume" : 42786.0,
> 
> "country" : null,
> 
> "item\_id" : "4",
> 
> "item\_title" : "テストアイテム壱",
> 
> "file\_key" : "2.2.png",
> 
> "bucket\_id" : "c88e1450-e3d2-4f33-8970-176f9d659410",
> 
> "file\_id" : "fc178212-279a-49cd-ba8e-2ccbe8bc1a33",
> 
> "root\_file\_id" : "fc178212-279a-49cd-ba8e-2ccbe8bc1a33",
> 
> "accessrole" : "open\_login",
> 
> "userrole" : "System Administrator",
> 
> "index\_list" : "テストインデックス１",
> 
> "is\_billing\_item" : false,
> 
> "billing\_file\_price" : "",
> 
> "user\_group\_names" : "テストグループ",
> 
> "site\_license\_name" : "",
> 
> "site\_license\_flag" : false,
> 
> "cur\_user\_id" : 1,
> 
> "hostname" : "None",
> 
> "remote\_addr" : "192.168.56.1"
> 
> }
> 
> }
> 
> \]
> 
> }
> 
> }

  - item-create ログ
    
      - http://{Elasticsearch:port} /{ stats-item-create のインデックス}/\_search?pretty

> {
> 
> "took" : 3,
> 
> "timed\_out" : false,
> 
> "\_shards" : {
> 
> "total" : 5,
> 
> "successful" : 5,
> 
> "skipped" : 0,
> 
> "failed" : 0
> 
> },
> 
> "hits" : {
> 
> "total" : 42,
> 
> "max\_score" : 1.0,
> 
> "hits" : \[
> 
> {
> 
> "\_index" : "tenant1-stats-item-create-000001",
> 
> "\_type" : "item-create-day-aggregation",
> 
> "\_id" : "item\_create\_11",
> 
> "\_score" : 1.0,
> 
> "\_source" : {
> 
> "timestamp" : "2023-06-09T00:00:00",
> 
> "unique\_id" : "item\_create\_11",
> 
> "count" : 1,
> 
> "unique\_count" : 1,
> 
> "country" : null,
> 
> "hostname" : "None",
> 
> "cur\_user\_id" : 1,
> 
> "remote\_addr" : "192.168.56.1",
> 
> "pid\_type" : "recid",
> 
> "pid\_value" : "11",
> 
> "record\_name" : ""
> 
> }
> 
> },...
> 
> \]
> 
> }
> 
> }

  - record-view ログ
    
      - http://{Elasticsearch:port} /{ stats-record-view のインデックス}/\_search?pretty

> {
> 
> "took" : 3,
> 
> "timed\_out" : false,
> 
> "\_shards" : {
> 
> "total" : 5,
> 
> "successful" : 5,
> 
> "skipped" : 0,
> 
> "failed" : 0
> 
> },
> 
> "hits" : {
> 
> "total" : 185,
> 
> "max\_score" : 1.0,
> 
> "hits" : \[
> 
> {
> 
> "\_index" : "tenant1-stats-record-view-000001",
> 
> "\_type" : "record-view-day-aggregation",
> 
> "\_id" : "8eefc281-f477-3639-9475-1d2b2621d33f",
> 
> "\_score" : 1.0,
> 
> "\_source" : {
> 
> "timestamp" : "2023-06-09T00:00:00",
> 
> "unique\_id" : "8eefc281-f477-3639-9475-1d2b2621d33f",
> 
> "count" : 2,
> 
> "unique\_count" : 1,
> 
> "country" : null,
> 
> "hostname" : "None",
> 
> "remote\_addr" : "192.168.56.1",
> 
> "record\_id" : "9b4bb507-3a6a-4eeb-8f82-300c2b0a6302",
> 
> "record\_name" : "テストアイテム03",
> 
> "record\_index\_names" : "テストインデックス１",
> 
> "pid\_type" : "recid",
> 
> "pid\_value" : "3",
> 
> "cur\_user\_id" : "1",
> 
> "site\_license\_name" : "",
> 
> "site\_license\_flag" : false
> 
> }
> 
> },...
> 
> \]
> 
> }
> 
> }

  - search ログ
    
      - http://{Elasticsearch:port} /{ stats-search のインデックス}/\_search?pretty

> {
> 
> "took" : 2,
> 
> "timed\_out" : false,
> 
> "\_shards" : {
> 
> "total" : 5,
> 
> "successful" : 5,
> 
> "skipped" : 0,
> 
> "failed" : 0
> 
> },
> 
> "hits" : {
> 
> "total" : 11,
> 
> "max\_score" : 1.0,
> 
> "hits" : \[
> 
> {
> 
> "\_index" : "tenant1-stats-search-000001",
> 
> "\_type" : "search-day-aggregation",
> 
> "\_id" : "1ef1be2d-9261-3182-91b6-a878ac568e83",
> 
> "\_score" : 1.0,
> 
> "\_source" : {
> 
> "timestamp" : "2023-07-07T00:00:00",
> 
> "unique\_id" : "1ef1be2d-9261-3182-91b6-a878ac568e83",
> 
> "count" : 1,
> 
> "unique\_count" : 1,
> 
> "country" : null,
> 
> "referrer" : "https://192.168.56.103/",
> 
> "search\_key" : "0718",
> 
> "search\_type" : "0",
> 
> "site\_license\_name" : "",
> 
> "site\_license\_flag" : false
> 
> }
> 
> },...
> 
> \]
> 
> }
> 
> }

  - top-view ログ
    
      - http://{Elasticsearch:port} /{ stats-top-view のインデックス}/\_search?pretty

> {
> 
> "took" : 1,
> 
> "timed\_out" : false,
> 
> "\_shards" : {
> 
> "total" : 5,
> 
> "successful" : 5,
> 
> "skipped" : 0,
> 
> "failed" : 0
> 
> },
> 
> "hits" : {
> 
> "total" : 562,
> 
> "max\_score" : 1.0,
> 
> "hits" : \[
> 
> {
> 
> "\_index" : "tenant1-stats-top-view-000001",
> 
> "\_type" : "top-view-day-aggregation",
> 
> "\_id" : "3569afb4-53bd-3ef6-823d-e864be85faee",
> 
> "\_score" : 1.0,
> 
> "\_source" : {
> 
> "timestamp" : "2023-05-09T00:00:00",
> 
> "unique\_id" : "3569afb4-53bd-3ef6-823d-e864be85faee",
> 
> "count" : 10,
> 
> "unique\_count" : 1,
> 
> "country" : null,
> 
> "hostname" : "None",
> 
> "remote\_addr" : "192.168.56.1",
> 
> "site\_license\_name" : "",
> 
> "site\_license\_flag" : false
> 
> }
> 
> },...
> 
> \]
> 
> }
> 
> }


### アイテム作成数

- アイテム個別登録時のアイテム作成イベントを記録
- 一括登録時のアイテム作成イベントを記録
- ハーベスト時のアイテム作成イベントを記録


## 関連モジュール

- invenio-oaiharvester
- invenio-stats
- weko-search-ui
- weko-workflow


  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="even">
<td><blockquote>
<p>2024/07/1</p>
</blockquote></td>
<td>7733de131da9ad59ab591b2df1c70ddefcfcad98</td>
<td>v1.0.7対応</td>
</tr>
</tbody>
</table>## セッション管理

  - invenioモジュールを利用しており、サーバ側のセッション管理、セッションアクティビティの追跡が可能。詳細なドキュメントは[invenio-accounts](https://github.com/inveniosoftware/invenio-accounts#invenio-accounts) で入手可能。

  - 一括登録画面のセッション維持期間のみカスタマイズ可能。設定WEKO\_ADMIN\_IMPORT\_PAGE\_LIFETIMEに秒数を設定する（デフォルトは12時間）。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/11/11</p>
</blockquote></td>
<td>V0.9.27</td>
<td>V0.9.27追加機能</td>
</tr>
</tbody>
</table>

## API Endpoint

invenio では、UI とAPI　のアプリケーションが２つあり（※）、統合して実行している。  
各アプリケーションに含まれるエンドポイントは以下を参照のこと。  
（invenioコマンドで取得できるエンドポイント一覧はUI部分のみ。APIはinvenio-baseをデバックして確認）

1.  UI \[https://rcosms-my.sharepoint.com/:x:/g/personal/hayashi\_rcosms\_onmicrosoft\_com/ESFoWv7Q-LlLu2KJbQQyXBQBA2wOZ-3aFba9XQQRRsxMaA?e=FhDHyj\]

2.  API　\[<https://rcosms-my.sharepoint.com/:x:/g/personal/hayashi_rcosms_onmicrosoft_com/EcR8uA8LSs5HtNFUrGgSmaIBULWfZ6yznzAMd6hIhqZlaw?e=l7Jvgg>\]

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>
## Shibboleth対応

1\. Shibboleth IdPからの属性情報に基づき、ユーザへのロール割り当てをする

  - Idpから取得した属性情報は、以下の設定に従ってWEKOに渡される
    
      - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/nginx/login.php#L16-L20>
    
      - 「$\_SERVER\\[Idp側での属性名\\]」で渡された情報を「$post\_args\\[WEKO側での属性名\\]」として受け取る

  - 認証時にIdPより取得した属性情報に基づきログインユーザに対してロール割り当てを行う
    
      - IdP属性情報は以下とする
        
          - ロール：wekoSocietyAffiliation
    
      - IdP属性値に対するロール割り当ては以下とする
        
          - 「管理者」→システム管理者ロール'System Administrator'
        
          - 「図書館員」→リポジトリ管理者ロール'Repository Administrator'
        
          - 「教員」→一般利用者ロール'Contributor'
        
          - 「教官」→一般利用者ロール'Contributor'
    
      - 上記のIdP属性値とロールとの対応は、以下のコンフィグで設定する
        
          - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-accounts/weko_accounts/config.py#L77-L82>
        
          - 設定キー：WEKO\_ACCOUNTS\_SHIB\_ROLE\_RELATION
    
      - IdP属性値がconfigに含まれないロールであった場合は、ロールを持たないユーザとなる

2\. Shibboleth IdPからの属性情報に基づき、サイトライセンス機能を制御する

  - 認証時にIdPより取得した属性情報に基づきログインユーザに対してサイトライセンス制御を行う
    
      - IdP属性情報は以下とする
        
          - サイトライセンス：wekoSiteUserWithinIpRange
    
      - IdP属性値に対するサイトライセンスは以下とする
        
          - "False"の場合は以下のエラーメッセージを表示し、ログイン不可とする  
            　JP: ログインに失敗しました。  
            　EN: Failed to login.

3\. Shibbolethでのアカウント情報(ロール含む)の利用

  - シボレス経由でログインする都度、シボレス属性値をWEKO3のユーザ情報に反映
    
      - SHIB\_ATTR\_USER\_NAME は、invenio の仕様でユニークである必要がある。
    
      - SHIB\_ATTR\_ROLE\_AUTHORITY\_NAMEについて、ロールの紐づけをconfig で指定できるものとし、configに含まれないロールであった場合は、WEKOのロールとしては設定しない
        
          - SHIB\_ATTR\_ROLE\_AUTHORITY\_NAMEに複数属性が含まれている場合は，複数ロールの割当を行えるようにする。（複数属性が含まれている場合は属性値を半角セミコロン「;」で区切られている）

  - シボレスユーザの紐づけキー
    
      - SHIB\_ATTR\_EPPNとする
    
      - 存在しない場合は、かわりにSHIB\_ATTR\_USER\_NAMEを利用することができる
    
      - SHIB\_ATTR\_USER\_NAMEを利用するかどうかは、以下のconfigで指定する
        
          - パス：<https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-accounts/weko_accounts/config.py#L97>
        
          - 設定キー：WEKO\_ACCOUNTS\_SHIB\_ALLOW\_USERNAME\_INST\_EPPN

4\. 実装

  - weko\_accounts.views. shib\_sp\_login関数によって、IdPからのリクエストを処理する
    
      - リクエストにSHIB\_ATTR\_SESSION\_IDが含まれず、以下のコンフィグWEKO\_ACCOUNTS\_SHIB\_LOGIN\_ENABLEDがfalseの場合はエラーとしてWEKOのログイン画面に遷移する
        
          - > パス（instance.cfg）：  
            > <https://github.com/RCOSDP/weko/blob/v0.9.22/scripts/instance.cfg#L436>
        
          - パス（config.py）：  
            <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-accounts/weko_accounts/config.py#L29>
    
      - weko\_accounts.utils. parse\_attributes関数によってリクエストの内容を確認し、必須の項目が含まれない場合はエラーとしてWEKOのログイン画面に遷移する
        
          - 必須項目は以下のコンフィグで設定する
            
              - > パス（instance.cfg）：  
                > <https://github.com/RCOSDP/weko/blob/v0.9.22/scripts/instance.cfg#L442-L448>
            
              - パス（config.py）：  
                <https://github.com/RCOSDP/weko/blob/v0.9.22/modules/weko-accounts/weko_accounts/config.py#L64-L74>
            
              - 設定キー：WEKO\_ACCOUNTS\_SSO\_ATTRIBUTE\_MAP
    
      - リクエストの内容にSHIB\_ATTR\_EPPNが含まれず、かわりにSHIB\_ATTR\_USER\_NAMEを利用しない設定である場合はエラーとしてWEKOのログイン画面に遷移する
    
      - セッション情報はRedisに保存する
        
          - キーは、以下のコンフィグの値にログイン画面での入力値SHIB\_ATTR\_SESSION\_IDを加えたものを用いる
            
              - パス：<https://github.com/RCOSDP/weko/blob/13c305a3048309dbda87a614ffedac18423820aa/modules/weko-accounts/weko_accounts/config.py#L32>
            
              - 設定キー：WEKO\_ACCOUNTS\_SHIB\_CACHE\_PREFIX
    
      - リクエストの内容をもとに、shibboleth\_userテーブルからSHIB\_ATTR\_EPPNまたはSHIB\_ATTR\_USER\_NAMEを使用してレコードの存在を確認する

  - 上記の処理で、shibboleth\_userテーブルにレコードが存在する場合は、weko\_accounts.views.shib\_auto\_login関数で続きの処理を行う
    
      - リクエストのSHIB\_ATTR\_SESSION\_IDとsession\['shib\_session\_id'\]のどちらかに情報がある場合は、ログインする
        
          - リクエストにSHIB\_ATTR\_SESSION\_IDが含まれず、session\['shib\_session\_id'\]に情報がある場合は、weko\_accounts.api.ShibUser.new\_relation\_infoメソッドによってshibboleth\_userテーブルにレコードを作成する
            
              - あわせて、userprofiles\_userprofileテーブルに以下の内容でレコードを作成する
                
                  - user\_id：shibboleth\_userテーブルに作成するレコードのidフィールドと同じ
                
                  - timezone：コンフィグのデフォルト値
                
                  - language：コンフィグのデフォルト値
                
                  - username：shibboleth\_userテーブルに作成するレコードのshib\_user\_nameフィールドと同じ
        
          - レコード作成の有無にかかわらず、weko\_accounts.api.ShibUser. check\_inメソッドの中で、ロールの割り当てを行う
    
      - 上記以外の場合は、WEKOのログイン画面に遷移する

  - shibboleth\_userテーブルにレコードが存在しなかった場合は、weko\_accounts.views.shib\_login関数でID選択画面に遷移する
    
      - 登録済みのIDでログインする場合は、weko\_accounts.views.confirm\_user関数で続きの処理を行う
        
          - リクエストに、有効なWEKOアカウントとパスワードが含まれない場合は、WEKOのログイン画面に遷移する
        
          - リクエストのWEKOアカウントのメールアドレスを使用して、shibboleth\_userテーブルにレコードを作成する
        
          - weko\_accounts.api.ShibUser. check\_inメソッドの中で、ロールの割り当てを行う
        
          - ログインする
    
      - 新規IDでログインする場合は、weko\_accounts.views.shib\_auto\_login関数でログインする

  - shibboleth\_userテーブルにレコードを作成する場合は、あわせてユーザ関連テーブルも上書きする
    
      - 1\) シボレス属性値をshibboleth\_userテーブルに登録する
        
          - SHIB\_ATTR\_MAIL ⇒ shibboleth\_user.shib\_mail
        
          - SHIB\_ATTR\_USER\_NAME ⇒ shibboleth\_user.shib\_user\_name
        
          - SHIB\_ATTR\_ROLE\_AUTHORITY\_NAME ⇒shibboleth\_user.shib\_role\_authority\_name
    
      - 2\) shibboleth\_userテーブルから各テーブルに登録する
        
          - shibboleth\_user.shib\_mail ⇒ accounts\_user.email
        
          - shibboleth\_user.shib\_user\_name ⇒ userprofiles\_userprofile.username
        
          - shibboleth\_user.shib\_role\_authority\_name ⇒ accounts\_userrole.user\_id,role\_id
    
      - 1),2) どちらの登録の際も値のチェックは行わず、登録先の値を上書きする。

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>## ワークフロー連携

  - > 1\. WEB APIを用いてGakuNinRDMから登録対象データを受領する

<!-- end list -->

  - WEB APIを用いて「WEKO3の一括登録フォーマット※」を取得する（OAuth2による認証・認可を行う）
    
      - (※)WEKO3での一括登録フォーマット：　アイテムタイプ単位のTSV形式ファイルのzipファイル  
        今回の実証では、「デフォルトアイテムタイプ(フル)」を使用する

  - 接続および対象データの取得が行えない場合は、受付エラーとしてWEB APIでの受領に対してのエラーとして返す。（APIエラー、認証エラーを想定）

  - 「WEKO３の一括登録フォーマット」として対象データを受取れなかった場合は、フォーマットエラーとしてWEB APIの受領に対してのエラーとして返す。（フォーマット不正を想定）

  - 受け付けた「WEKO3の一括登録フォーマット」の対象データを保持する。（WEKO3のアクティビティ生成で利用する）

  - WEB APIを介した登録データの受付情報を記録する。
    
      - タイムスタンプ、接続者の情報を記録する。エラーがある場合はエラー情報を記録する。

<!-- end list -->

  - 詳細のシーケンス図は以下を参照  
    <https://redmine.devops.rcos.nii.ac.jp/attachments/25959/SequenceDiagram.xlsx>

> ![](media/media/image6.png)

  - > 2\. アイテム登録するフローを用意する

<!-- end list -->

  - WEB API経由で受け取る「一括登録フォーマット」でのアイテム情報を、ワークフローでアイテム登録をするためのフローを用意する。
    
      - 使用するアクションおよびアクション実施順序を確定させる。
    
      - アクションを定義しフローを作成する。フローは以下の通り。
        
        1.  Item Registration
        
        2.  Item Link
        
        3.  Identifier Grant
        
        4.  Approval

<!-- end list -->

  - > 3\. 一括登録フォーマットのアイテム情報からアイテムを登録する

<!-- end list -->

  - 一括登録フォーマットに従ったアイテム情報1件分からアイテムを登録する
    
      - アクティビティに関連付けられるアイテムを指定されるアイテムタイプから生成する
        
          - 一括登録フォーマットに従ったアイテム情報を登録する処理において行う事前チェックを実施する。
    
      - 事前チェックにてエラーが発生した場合は、アクティビティの作成を中止する
        
          - エラー情報を返す。
    
      - 事前チェックにてエラーがなかった場合に、アイテムを登録する。

<!-- end list -->

  - ワークフロー上はItemRegistrationで留めておく
    
      - 登録完了までいかず、途中からワークフローを再開できるようにする

<!-- end list -->

  - システム連携において、一括登録フォーマットのアイテム情報からアイテムの  
    メタデータ項目とインデックス情報を取り込んだアクティビティを生成する。

<!-- end list -->

  - 該当のアクティビティは、アクティビティ一覧にDoingの状態で表示され、クリックすることでItemRegistration画面のメタデータ入力画面が表示される。  
    （このとき、メタデータ項目が入力されている状態である）

<!-- end list -->

  - \[次へ\]でインデックス選択画面を表示した際も、取り込んだ該当のインデックスにチェックが付いている状態で保持されているものとする

**【補足】**

  - アイテムIDは指定をしても、値は無視して自動採番する

<!-- end list -->

  - > 4\. システムからAPIを経由したアイテム登録の実証

<!-- end list -->

  - WEB APIを用いて、アイテムを取得し、WEKO3のワークフローを通したアイテム登録の流れは以下の通り

4.1. OAuth2による認証・認可設定

  - 連携システムからのAPI接続にはOAuth2認証を用いるため、事前に接続用の認証トークンを生成する

  - API経由での登録アクティビティを利用するためのScopeとして、「user:activity」を用いる

  - Access Admin\> Profile　画面の "New token" ボタンを押下し、生成したいScopesの選択肢から「user:activity」Scopesにチェックを入れる

  - 生成したトークンをシステム側のAPIで利用する

> ![グラフィカル ユーザー インターフェイス, アプリケーション 自動的に生成された説明](media/media/image7.png)
> 
> ![グラフィカル ユーザー インターフェイス, テキスト, アプリケーション, メール, Web サイト 自動的に生成された説明](media/media/image8.png)

  - ※実証実験にあたっては、上記で発行したアクセストークンをPosmanツールに指定して利用

  - ※実証用のプログラムをマージ後にクリーンビルドせずに、既に稼働している環境に取り込む場合、以下の設定を行う必要がある

> \* Update folder permission:
> 
> \-----
> 
> 　sudo chown -R 1000:1000 ./modules/invenio-oauth2server/
> 
> 　sudo chown -R 1000:1000 ./modules/weko-workflow/
> 
> \-----
> 
> \* Reinstall module's packages:
> 
> \-----
> 
> 　docker-compose exec web pip install -e /code/modules/invenio-oauth2server
> 
> 　docker-compose exec web pip install -e /code/modules/weko-workflow
> 
> \-----
> 
> \* Restart docker:
> 
> \-----
> 
> 　docker-compose stop; docker-compose up -d
> 
> \-----
> 
> \* Rebuild bundle/static files:
> 
> \-----
> 
> 　docker-compose exec web invenio collect -v;docker-compose exec web invenio assets build
> 
> \-----

4.2. アイテム登録連携用API

  - 以下、3つのAPIを利用する
    
      - アイテム登録アクティビティの開始: POST /DepositActivity
    
      - 登録アクティビティの取得: GET /DepositActivity/{activityId}
        
          - 登録アクティビティの状態を取得する
    
      - 登録アクティビティのキャンセル: DELETE /DepositActivity/{activityId}
        
          - 登録したアクティビティを「強制終了」する

4.3. アイテム登録連携用APIで利用するワークフローおよびフロー

  - アクティビティの生成とworkflow\_idについて
    
      - 連携システム側からAPIでファイルを受け渡し、ワークフローのItemRegistration画面で留めておくためには1件ずつ、アクティビティを生成しておく必要がある
    
      - また、アクティビティ生成にあたっては、どのワークフローで登録するか、workflow\_idを指定する必要がある
    
      - 今回の実証では、以下の設定値として、configファイル指定(WEKO\_WORKFLOW\_GAKUNINRDM\_DATA)を行った

<!-- end list -->

  - **ワークフロー定義**
    
      - ワークフロー名称：「GRDM\_デフォルトワークフロー」
    
      - 'workflow\_id': -1,

![グラフィカル ユーザー インターフェイス, アプリケーション, Word, メール 自動的に生成された説明](media/media/image9.png)

  - **アイテムタイプ定義**
    
      - アイテムタイプは「デフォルトアイテムタイプ（フル）」を使用する

  - **フロー定義**
    
      - 使用するフローは以下の通りとする
        
          - フロー名称：「GRDM\_デフォルトフロー」
            
            1.  Start
            
            2.  Item Registration
            
            3.  Item Link
            
            4.  Identifier Grant
            
            5.  Approval
            
            6.  End

![グラフィカル ユーザー インターフェイス, アプリケーション, Teams 自動的に生成された説明](media/media/image10.png)

4.4. 一括登録フォーマットのアイテム情報からアイテムを登録する

  - 一括登録フォーマットに従ったアイテム情報1件分からアイテムを登録する

<!-- end list -->

1.  アクティビティに関連付けられるアイテムを指定されるアイテムタイプから生成する
    
      - 一括登録フォーマットに従ったアイテム情報を登録する処理において行う事前チェックを実施する
        
          - アイテムの一括登録(インポート)では、ItemRegistrationの後続の処理、ID・DOI付与全ての工程を行えるが、このワークフロー連携では、ワークフロー上はItemRegistrationで留めておく必要がある（登録完了までいかず、途中からワークフローを再開できるようにするため）
        
          - そのため、ワークフロー連携では一括登録フォーマットに従うものの、以下の項目は指定しても処理に利用しない
            
              - .id （アイテムID。IDが自動採番されるため、IDのチェックが不要。）
            
              - .uri　（アイテムのURI。IDが自動採番されるため、URIのチェックが不要。）
            
              - .edit\_mode （アクティビティの新規作成のため無視する。入力しなくてもエラーとならない）
            
              - .cnri　（ハンドル情報。ハンドル設定がONの場合、Item Registrationの「Next」ボタンを押下する際に自動申請されるため、設定が不要。）
            
              - .doi\_ra　（DOI情報。Item Registrationに止めるので、DOI情報のチェックが不要）
            
              - .doi　（DOI情報。Item Registrationに止めるので、DOI情報のチェックが不要）
            
              - .Identifier Registration　（ID登録、ID登録タイプ。DOI情報ですが、DOI付与しないため、無視する）

2.  事前チェックにてエラーが発生した場合は、アクティビティの作成を中止する
    
      - チェックエラー情報をログに記録する。（今回の実証ではチェック内容の詳細定義や、チェック結果の返戻実装は対象外）

![テキスト 自動的に生成された説明](media/media/image11.png)

3.  事前チェックにてエラーがなかった場合に、アイテムを登録する
    
      - 以下は、疑似的にPostmanツールを使用して、外部からAPIを叩いてみた内容

![コンピューターのスクリーンショット 自動的に生成された説明](media/media/image12.png)

  - 上記APIを叩くことで、WEKO側に新規のアイテム登録アクティビティを生成することができる

<!-- end list -->

  - > 更新履歴

| 日付 | GitHubコミットID                             | 更新内容 |
| -- | ---------------------------------------- | ---- |
|    | 353ba1deb094af5056a58bb40f07596b8e95a562 | 初版作成 |
## ID体系

（１）アイテムタイプID

| **ID** | **説明**                                            |
| ------ | ------------------------------------------------- |
| 1～     | WEKO2で機関が独自に作成したアイテムタイプ。移行対象。△                    |
| 10001～ | WEKO2のデフォルトアイテムタイプ。移行対象。△                         |
| 20001～ | WEKO2のハーベスト用アイテムタイプ。移行対象。△                        |
| 30001～ | WEKO3のデフォルトアイテムタイプ。制限公開に利用する。                     |
| 40001～ | WEKO3でユーザがAdmin\>Item Types\>Metaで新規作成するアイテムタイプ。★ |

（２）プロパティID

| **ID** | **説明**                                            |
| ------ | ------------------------------------------------- |
| 1～     | WEKO3用の初期定義プロパティ。v0.9.22では1～191ある。                |
| 1001～  | 移行ツールで作成されたプロパティ。移行対象のアイテムタイプを構成。▲                |
| 30001～ | WEKO3のデフォルトプロパティ。制限公開に利用する。                       |
| 40001～ | WEKO3でユーザがAdmin\>ItemType\>Propertyで新規作成したプロパティ。★ |

△：移行ツールに関連。現在は移行元WEKO2で設定されているIDをそのまま移行している。現状でOK。  
▲：移行ツールに関連。移行ツールの対応が必要。  
★：移行ツール内で対応する。

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>## 解析基盤連携

  - > 目的・用途

本機能はリポジトリに公開されたデータを解析基盤で処理させるための機能である。

これによって、研究者がリポジトリに公開されたデータやプログラムを直接解析基盤で処理させることが可能となる。

  - > 利用方法

アイテム詳細画面で表示されるオンライン分析ボタンをクリックする。

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### アイテムタイプ管理（制限公開）

  - 制限公開機能に対して対応しているアイテムタイプは以下の通りである（日立納品時）
    
      - 「利用申請」
    
      - 「二段階利用申請」
    
      - 「利用報告-Data Usage Report」  
        これら3つのアイテムタイプの構成は以下の通りである

  - 制限公開アイテム登録用ファイル情報  
    制限公開機能を利用するには、「制限公開用のコンテンツファイル」が必要である
    
      - アイテム登録画面でファイルをアップロードすると、ファイル名を自動設定する
    
      - アップロードしたファイルのフォーマット・ファイルサイズをDBに格納する  
        \*\*Meta画面のAllow Multipleのオプションはオンに設定し非活性

<table>
<thead>
<tr class="header">
<th>プロパティ定義</th>
<th>備考</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>表示名</td>
<td>Text</td>
<td>-</td>
<td>-</td>
<td>ファイル名を登録する</td>
</tr>
<tr class="even">
<td>本文URL</td>
<td>Object</td>
<td>本文URL</td>
<td>Text</td>
<td>コンテンツファイルの格納先が自動で登録される<br />
コンテンツファイルが無い場合は手入力でURLを入力可能</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>ラベル</td>
<td>Text</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>オブジェクトタイプ</td>
<td>Select</td>
<td>選択肢<br />
　abstract/summary/fulltext/thumbnail/other　</td>
</tr>
<tr class="odd">
<td>フォーマット</td>
<td>Text</td>
<td>-</td>
<td>-</td>
<td>コンテンツファイルのMIMEタイプを取得して自動で登録される</td>
</tr>
<tr class="even">
<td>サイズ</td>
<td>List</td>
<td>サイズ</td>
<td>Text</td>
<td>コンテンツファイルのサイズを取得して自動で登録される</td>
</tr>
<tr class="odd">
<td>日付</td>
<td>List</td>
<td>日付</td>
<td>Datetime</td>
<td></td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>日付タイプ</td>
<td>Select</td>
<td>選択肢<br />
　Accepted/Collected/Copyrighted /Issued/Submitted/Updated/Valid　</td>
</tr>
<tr class="odd">
<td>バージョン情報</td>
<td>Text</td>
<td>-</td>
<td>-</td>
<td></td>
</tr>
<tr class="even">
<td>表示形式</td>
<td>Select</td>
<td>-</td>
<td>-</td>
<td>detail/simple/preview</td>
</tr>
<tr class="odd">
<td>ライセンス</td>
<td>Select</td>
<td>-</td>
<td>-</td>
<td></td>
</tr>
<tr class="even">
<td>自由ライセンス</td>
<td>Textarea</td>
<td>-</td>
<td>-</td>
<td>"ライセンス"で"自由入力"を選択した場合に登録する</td>
</tr>
<tr class="odd">
<td>アクセス</td>
<td>Radios</td>
<td>-</td>
<td>-</td>
<td>オープンアクセス/オープンアクセス日を指定する/ログインユーザのみ/公開しない/制限公開（デフォルト）</td>
</tr>
<tr class="even">
<td>グループ</td>
<td>Select</td>
<td>-</td>
<td>-</td>
<td>"アクセス"で"ログインユーザのみ"を選択したときに登録する</td>
</tr>
<tr class="odd">
<td>公開日（オープンアクセスの日付）</td>
<td>List</td>
<td>日付</td>
<td>Datetime</td>
<td>"アクセス"で"オープンアクセス日を指定する"を選択したときに登録する</td>
</tr>
<tr class="even">
<td></td>
<td></td>
<td>タイプ</td>
<td>Select</td>
<td>日付タイプは「Available」固定（Item Registration画面では入力エリアは存在しない）</td>
</tr>
<tr class="odd">
<td>データタイプ</td>
<td>Radios</td>
<td>-</td>
<td>-</td>
<td>"アクセス"で"ログインユーザのみ"を選択したときに登録するライフ/累積/組み合わせ分析l都道府県/地点情報</td>
</tr>
<tr class="even">
<td>提供方法</td>
<td>List</td>
<td>ロール</td>
<td>Select</td>
<td>"アクセス"で"制限公開"を選択したときに登録する/ Administration &gt;UserManagement&gt;Roleで管理しているロールと「非ログインユーザ（Guest）」をリストに表示する</td>
</tr>
<tr class="odd">
<td></td>
<td></td>
<td>ワークフロー</td>
<td>Select</td>
<td>Administration &gt;WorkFlow&gt;WorkFlow Listで管理しているワークフローのうち「制限公開フラグ」（関連ストーリー： <a href="https://redmine.devops.rcos.nii.ac.jp/issues/24080"><del>#24080</del></a>）が有効なものをリストに表示する</td>
</tr>
<tr class="even">
<td>利用規約</td>
<td>Select</td>
<td>-</td>
<td>-</td>
<td>"アクセス"で"制限公開"を選択したときに登録する。管理画面で登録した利用規約をリストで表示する。選択肢に「自由入力」を設ける</td>
</tr>
</tbody>
</table>

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### アイテム詳細(制限公開)

  - コンテンツのアクセスを「制限公開」とした場合のアイテム詳細画面、ファイル詳細画面の処理
    
      - アクセスしているユーザーが管理者権限があるかどうかは、「\_\_check\_user\_permission」のメソッドでチェックする。V0.9.22現在、システム管理者・リポジトリ管理者・コミュニティ管理者が管理者権限ありとして扱われている。

  - 管理者権限をもつユーザに対して、アイテム詳細画面、ファイル詳細画面に、ファイルの情報を取得し、ダウンロードできる

  - 権限がないユーザに対して、アイテム詳細画面に「アクセス制限」（英「Restricted Access」）と表示する。ファイル情報のリンクは不活性とし、ファイル詳細画面の「Action」にダウンロードボタンのかわりに「申請」ボタンを表示し、コンテンツ登録時に設定した「提供方法：ロール」のロールに一致するユーザーは「申請」ボタンをクリックことで以下の利用申請を実施することができる
    
      - 「提供方法：ロール」を「非ログインユーザ」とした場合、ログインしていないユーザは「申請」ボタンをクリックことで以下の利用申請を実施することができる

  - 制限公開用のコンテンツファイルでの提供方法に一致しないユーザが「申請」ボタンを押下した場合はモーダルで警告メッセージを表示する
    
      - 警告メッセージ：
        
          - 日本語：「このデータは利用できません（権限がないため）。」
        
          - 英語：「This data is not available for this user.」

  - コンテンツのアクセスを「制限公開」とした場合のコンテンツファイルのアクセス制御
    
      - アクセスしているユーザーが管理者権限があるかどうかは、「\_\_check\_user\_permission」のメソッドでチェックする
        
          - アクセス権限をもつユーザの場合（管理者・アイテム登録者・代理投稿者）
            
              - DLのURLを入力：　"Permission required"を表示する  
                ※入力するURLは登録者(Contributor)以上がボタンを押下したときのURL( } )とする
            
              - Informatonボタン押下：　"Permission required"を表示する
            
              - Informaton画面のURLを入力：　"Permission required"を表示する
        
          - 権限のないログインユーザの場合（「提供方法：ロール」の設定にかかわらず）
            
              - DLのURLを入力：　"Permission required"を表示する  
                ※入力するURLは登録者(Contributor)以上がボタンを押下したときのURL( } )とする
            
              - Informatonボタン押下：　"Permission required"を表示する
            
              - Informaton画面のURLを入力：　"Permission required"を表示する
        
          - 非ログインユーザの場合（「提供方法：ロール」の設定にかかわらず）
            
              - DLのURLを入力：　ログイン要求をする  
                ※入力するURLは登録者(Contributor)以上がボタンを押下したときのURL( } )とする
            
              - Informatonボタン押下：ログイン要求をする
            
              - Informaton画面のURLを入力：ログイン要求をする

  - 利用申請①:利用規約への同意
    
      - 提供方法に一致するユーザーがアイテム詳細画面の「申請」ボタンを押下した際に利用申請設定時に設定されている利用規約をモーダル画面に表示する
        
          - 利用規約について
            
              - 利用規約文表示エリア上部に「利用規約」を固定で表示する
            
              - 「利用規約に同意する」ラベルクリック時もチェックボックスのオンオフができるようにする
            
              - 「利用規約に同意する」チェックボックスのチェック/非チェックが、「次へ」ボタンが活性/非活性と連動する

  - 利用申請②：利用規約画面での「次へ」ボタンを押下した際の挙動
    
      - 「非ログインユーザ」で設定される場合、メールアドレスが入力できるモーダル画面が表示される
        
          - 受信したメール文のリンクをクリックするとワークフローに定義されているアクション画面（アイテム登録画面など）に遷移する
        
          - リンクはランダムなURLとトークン値から構成し、両者が一致した場合に利用登録ワークフローへのリンクとして機能する
    
      - 「 提供方法：ロール」で設定される場合、指定されたワークフローの画面に遷移する

  - 利用申請③：ワークフロー終了後の挙動
    
      - アイテム詳細画面の「申請」ボタンから起動したワークフローが「作業済み(Done)」となった際にダウンロード用のURIをメールで通知する。リンクの有効期限とダウンロード回数は【Administration \> Setting \> Restricted Access画面】での「コンテンツファイルのダウンロード」(Content File Download)エリアで設定される
    
      - ダウンロードのリンクへアクセスする時、リンクの有効期限とダウンロード回数が超えない場合、コンテンツファイルがダウンロードできる。ダウンロード回数（残り回数）がカウントダウンされる
        
          - 有効期限を超過した場合、エラーメッセージが表示される
            
              - 日本語：「ダウンロード有効期限を超過しています。」
            
              - 英語：「 The expiration date for download has been exceeded. 」
        
          - ダウンロード回数を超過した場合、エラーメッセージが表示される
            
              - 日本語：「ダウンロード上限回数を超過しています。」
            
              - 英語：「 The download limit has been exceeded. 」
        
          - 登録時にアイテムを制限公開としていたが、途中で非公開/削除した場合、DL期間内でもファイルはダウンロードできない
        
          - 登録時に指定したインデックスを非公開に変更した場合、DL期間内でもファイルはダウンロードできなくなる

  - 利用申請④：データダウンロード後の挙動
    
      - 利用申請が承認された制限公開コンテンツファイルを最初にダウンロードした際に、ダウンロードしたユーザのメールアドレスに向けて「利用報告の登録のお願い」メールを通知する。メールには利用報告ワークフローアクティビティの登録URLリンクが掲載されており、URLリンクから遷移する登録画面から利用報告を登録できる。
        
          - ゲストユーザーの利用報告WFに対して、リンクの有効期限は【Administration \> Setting \> Restricted Access画面】での「利用報告ワークフローへのアクセス」(Usage Report Workflow Access)エリアで設定できる

<!-- end list -->

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### ワークフロー管理（制限公開）

  - フロー:　Flow List
    
      - 【Admin \> WorkFlow \> Flow List画面】から利用申請フローを登録することができる
        
          - 現在利用申請フローとして動作が保証されているのは以下の2つである。
            
              - 利用申請： 　\[Start\]-\[Item Resistration\]-\[Approval(1)\]-\[End\]
            
              - 二段階利用申請：　\[Start\]-\[Item Resistration\]-\[Approval(1)\]-\[Approval(2)\]-\[End\]
            
              - 利用登録： 　\[Start\]-\[Item Resistration\]-\[End\]
            
              - 利用規約のみ： 　\[Start\] -\[End\]
        
          - 利用登録は、Approvalを承認扱いでスキップする利用申請。利用規約のみは、申請なしでそのまま制限公開のコンテンツファイルをダウンロードできる。
        
          - 利用報告フローは以下の通り定義している。
            
              - 利用報告： 　\[Start\]-\[Item Resistration\]-\[Approval(1)\]-\[End\]
    
      - 「Action Role」カラムに、アクションを実行するロールを限定できる
        
          - 「Action Role」プルダウンを選択する。「Action Role」プルダウンでの選択肢は現在システムに設定されたロールである
        
          - 「Deny」チェックボックスにチェックを入れる場合、選択されているロールが実施不可とする
    
      - 「Action User」カラムに、アクションを実行するユーザーを限定できる
        
          - 「Action User」プルダウンを選択する。「Action User」プルダウンでの選択肢は現在システムに登録されたユーザーである
            
              - 「Approval」アクションに対して
                
                  - 選択肢はシステムに登録しているユーザーと、「プロパティを指定」(Specify Property)である
                    
                      - 「プロパティを指定」(Specify Property)を選択した場合、「プロパティを指定する」(Specify Property)モーダル画面を表示する。当該画面でプロパティを選択する
                    
                      - モーダル画面には、プロパティ定義に「"approval":true」キーワードを持つプロパティ名を表示する
                    
                      - モーダルに表示しているプロパティを選択して「設定」(Setting)ボタンを押すことで、プロパティを指定できる
                    
                      - 「閉じる」（Close）ボタンを押すと、モーダルを閉じる
                
                  - 「Item Resistration」アクションの以下チェックボックスにチェックを入れることで、管理者画面で登録したメールを自動送信することができる
                    
                      - チェックボックス：「Send an email to the registrant」  
                        Item Resistration登録完了時に、登録者にリマインドメールを送信する  
                        **\*\***\*チェックボックスをクリックすると、チェックボックス下のリストボックスが活性する。
                        
                          - リストボックスから、【Admin \> 設定 \> メールテンプレート】で登録したメールのタイトルを選択することができる。
                
                  - 「Approval」アクションごとに以下チェックボックスにチェックを入れることで、管理者画面で登録したメールを自動送信することができる
                    
                      - チェックボックス
                        
                          - 「承認依頼通知メール」（Approval Request Notification Email）  
                            Approvalフロー遷移時に、設定した承認者に承認を依頼するメールを送信する
                        
                          - 「承認却下通知メール」（Approval Rejection Notification Email）  
                            Approvalフローにて承認者が却下を行った場合、登録者に承認者が却下された旨を通知するメールを送信する
                        
                          - 「承認通知メール」（Approval Notification Email）  
                            Approvalフローにて承認者が承認を行った場合、登録者に承認者が承認された旨を通知するメールを送信する
                    
                      - チェックボックスをクリックすると、チェックボックス下のリストボックスが活性する。
                        
                          - リストボックスから、【Admin \> 設定 \> メールテンプレート】で登録したメールのタイトルを選択することができる。
        
          - 「Deny」チェックボックスにチェックを入れる場合、選択されているユーザーが実施不可とする
    
      - 「Change Order」カラムにアクションの順序を設定できる  
        一番上の項目は、［↑］ボタンが無効になる。一番下の項目は、［↓］ボタンが無効になる
    
      - 画面の下部に表示されている［保存］を押すと、フローを保存し、メッセージを一覧画面の上部に表示する  
        メッセージ：「Updated flow action successfully」

  - ワークフロー:　WorkFlow List
    
      - 【Admin \> WorkFlow \> WorkFlow List画面】に登録されたワークフローが一覧に表示される
        
          - 制限公開機能を利用するためには、「利用報告/Data Usage Report」という名前のワークフローを用意しておく必要がある
            
              - 「利用報告/Data Usage Report」の推奨設定は以下のとおり  
                ワークフロー: 利用報告/Data Usage Report  
                フロー：利用報告  
                アイテムタイプ：利用報告  
                制限公開フラグ：チェックしない  
                GakuNinRDM Flag：チェックしない  
                登録インデックスの指定：利用報告（インデックスにて登録）  
                表示/非表示：利用者が自分でワークフローを作成させないために、「提供方法：ロール」にて設定したロールは非表示とするのが望ましい。
        
          - 利用申請用のワークフローの推奨設定は以下のとおり
            
              - 利用申請  
                ワークフロー: 利用申請  
                フロー：利用報申請  
                アイテムタイプ：利用申請  
                制限公開フラグ：チェックする  
                GakuNinRDM Flag：チェックしない  
                登録インデックスの指定：利用申請（インデックスにて登録）
            
              - 表示/非表示  
                　表示：System Administrator, Repository Administrator  
                　非表示：Contributor,Community Administrator
            
              - 二段階利用申請  
                ワークフロー: 二段階利用申請  
                フロー：二段階利用申請  
                アイテムタイプ：二段階利用申請  
                制限公開フラグ：チェックする  
                GakuNinRDM Flag：チェックしない  
                登録インデックスの指定：利用申請（インデックスにて登録)
            
              - 
              - 
表示/非表示 　

> 表示：System Administrator, Repository Administrator  
> 　 非表示：Contributor,Community Administrator

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>2024/01/19</td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### メールテンプレート

※v0.9.22現在、未実装。今後リリースの予定

  - 使用している画面  
    【Admin \> Setting \> メールテンプレート】：自動送信メールのタイトル、文面を設定する画面である

  - 自動送信メールの内容を設定する

  - 【Admin \> Setting \> メールテンプレート】に送信元の情報を設定する
    
      - 「Mail Template」にてメール文面の設定をする
    
      - 送信者は「設定」-\[メール送信\]-\[Mail Setting\]で設定したユーザー

設定項目は以下の2つである

  - Subject：メールタイトル

  - (メール内容）：メール内容

デフォルトで以下のメールが設定されており、それぞれ制限公開機能で用いる自動送信メールに関係している

*① 非ログインユーザに利用申請ワークフローURLを送信する  
Subject: 利用申請登録のご案内／Register Application for Use  
本文:  
\[restricted\_site\_name\_ja\]です。  
下記のリンクにアクセスしていただき、利用申請の登録を行ってください。*

*\[url\_guest\_user\]*

*このメールは自動送信されているので返信しないでください。  
お問い合わせは下記までお願いします。また、このメールに心当たりのない方は、\[restricted\_site\_name\_ja\]までご連絡ください。*

*\[restricted\_site\_name\_ja\]：\[restricted\_site\_url\]  
問い合わせ窓口：\[restricted\_site\_mail\]*

*This is a message from \[restricted\_site\_name\_en\].  
Please access the link below and register your Application.*

*\[url\_guest\_user\]*

*Please do not reply to this email as it has been sent automatically.  
Please direct all inquiries to the following address.  
Also, if you received this message in error, please notify \[restricted\_site\_name\_en\].*

*\[restricted\_site\_name\_en\]：\[restricted\_site\_url\]  
E-mail：\[restricted\_site\_mail\]*

*② 利用者に対して、利用申請登録のリマインドを行う  
Subject: データ利用申請の受付のお知らせ／Your Application was Received  
本文:  
\[restricted\_institution\_name\_ja\]です。  
\[restricted\_site\_name\_ja\]をご利用いただいて、ありがとうございます。*

*下記の利用申請を受け付けました。*

*申請番号： \[restricted\_activity\_id\]  
登録者名： \[restricted\_fullname\]  
メールアドレス： \[restricted\_mail\_address\]  
所属機関：\[restricted\_university\_institution\]  
研究題目：\[restricted\_research\_title\]  
申請データ：\[restricted\_data\_name\]  
申請年月日：\[restricted\_application\_date\]*

*\[restricted\_institution\_name\_ja\]で審査しますので、結果の連絡をお待ちください。*

*このメールは自動送信されているので返信しないでください。  
お問い合わせは下記までお願いします。また、このメールに心当たりのない方は、\[restricted\_institution\_name\_ja\]までご連絡ください。*

*\[restricted\_site\_name\_ja\]：\[restricted\_site\_url\]  
問い合わせ窓口：\[restricted\_site\_mail\]*

*Dear \[restricted\_fullname\],*

*This is a message from \[restricted\_institution\_name\_en\].  
Thank you for using \[restricted\_site\_name\_en\].*

*We received the below application:*

*Application No.：\[restricted\_activity\_id\]  
Name：\[restricted\_fullname\]  
E-mail：\[restricted\_mail\_address\]  
Affiliation：\[restricted\_university\_institution\]  
Title of research：\[restricted\_research\_title\]  
Dataset requested ：\[restricted\_data\_name\]  
Application date：\[restricted\_application\_date\]*

*You will be notified once the application is approved.*

*Please do not reply to this email as it has been sent automatically.  
Please direct all inquiries to the following address.  
Also, if you received this message in error, please notify \[restricted\_institution\_name\_en\].*

*\[restricted\_site\_name\_en\]：\[restricted\_site\_url\]  
E-mail：\[restricted\_site\_mail\]*

*③ 承認者に対して、利用申請の承認の依頼を行う  
Subject: 利用申請の承認のお願い／Request for Approval of Application for Use  
本文:  
\[restricted\_site\_name\_ja\]です。下記の方から利用申請がありました。*

*申請番号： \[restricted\_activity\_id\]  
登録者名： \[restricted\_fullname\]  
メールアドレス： \[restricted\_mail\_address\]  
所属機関：\[restricted\_university\_institution\]  
研究題目：\[restricted\_research\_title\]  
申請データ：\[restricted\_data\_name\]  
申請年月日：\[restricted\_application\_date\]*

*\[restricted\_site\_name\_ja\]（\[restricted\_site\_url\]）にアクセスしていただき、画面左上からログインしていただけますと、「ワークフロー」タブが現れます。ここから上記の申請内容をご確認ください。「承認」または「却下」のボタンをクリックしてください。*

*このメールに心当たりのない方は、\[restricted\_site\_name\_ja\] までご連絡ください。*

*\[restricted\_site\_name\_ja\]：\[restricted\_site\_url\]  
問い合わせ窓口：\[restricted\_site\_mail\]*

*This is a message from \[restricted\_site\_name\_en\].  
We received the below application.*

*Application No.：\[restricted\_activity\_id\]  
Name：\[restricted\_fullname\]  
E-mail：\[restricted\_mail\_address\]  
Affiliation：\[restricted\_university\_institution\]  
Title of research：\[restricted\_research\_title\]  
Dataset requested ：\[restricted\_data\_name\]  
Application date：\[restricted\_application\_date\]*

*Please access \[restricted\_site\_name\_en\]（\[restricted\_site\_url\]） and log in from the upper left corner of the screen, and the \[Workflow\] tab will appear. From here, please confirm the above application by clicking on “approve” or “reject”.*

*If you received this message in error, please notify the \[restricted\_site\_name\_en\]*

*\[restricted\_site\_name\_en\]：\[restricted\_site\_url\]  
E-mail：\[restricted\_site\_mail\]*

*④ 申請者に対して、利用申請が承認されたことを伝え、ダウンロードリンクを送付する  
Subject: 利用申請の承認のお知らせ／Your application was approved  
本文:  
\[restricted\_site\_name\_ja\]です。*

*下記の利用申請を承認しました。*

*申請番号： \[restricted\_activity\_id\]  
登録者名： \[restricted\_fullname\]  
メールアドレス： \[restricted\_mail\_address\]  
所属機関：\[restricted\_university\_institution\]  
研究題目：\[restricted\_research\_title\]  
申請データ：\[restricted\_data\_name\]  
申請年月日：\[restricted\_application\_date\]*

*データは、下記アドレスよりダウンロードすることができます。*

*\[restricted\_download\_link\]*

*当日より\[restricted\_expiration\_date\]\[restricted\_expiration\_date\_ja\]日後まで有効です。ダウンロード期限を過ぎると、再申請が必要です。*

*このメールは自動送信されているので返信しないでください。  
このメールに心当たりのない方は、\[restricted\_site\_name\_ja\]までご連絡ください。*

*\[restricted\_site\_name\_ja\]：\[restricted\_site\_url\]  
問い合わせ窓口：\[restricted\_site\_mail\]*

*This is a message from \[restricted\_site\_name\_en\].  
Your application below has been approved.*

*Application No.：\[restricted\_activity\_id\]  
Name：\[restricted\_fullname\]  
E-mail：\[restricted\_mail\_address\]  
Affiliation：\[restricted\_university\_institution\]  
Title of research：\[restricted\_research\_title\]  
Dataset requested ：\[restricted\_data\_name\]  
Application date：\[restricted\_application\_date\]*

*The data can be downloaded from the address below.*

*\[restricted\_download\_link\]*

*It is valid from that day until the day after \[restricted\_expiration\_date\]\[restricted\_expiration\_date\_en\]. You will need to resubmit your application once the link becomes unavailable.*

*Please do not reply to this email as it has been sent automatically.  
If you received this message in error, please notify the \[restricted\_site\_name\_en\].*

*\[restricted\_site\_name\_en\]：\[restricted\_site\_url\]  
E-mail：\[restricted\_site\_mail\]*

*⑤ 申請者に対して、利用申請が却下されたことを伝える  
Subject: 利用申請の審査結果について／The results of the review of your application  
本文:  
\[restricted\_site\_name\_ja\]です。*

*下記の利用申請を却下しました。*

*申請番号： \[restricted\_activity\_id\]  
登録者名： \[restricted\_fullname\]  
メールアドレス： \[restricted\_mail\_address\]  
所属機関：\[restricted\_university\_institution\]  
研究題目：\[restricted\_research\_title\]  
申請データ：\[restricted\_data\_name\]  
申請年月日：\[restricted\_application\_date\]*

*このメールは自動送信されているので返信しないでください。  
お問い合わせは下記までお願いします。また、このメールに心当たりのない方は、\[restricted\_site\_name\_ja\] までご連絡ください。*

*\[restricted\_site\_name\_ja\]：\[restricted\_site\_url\]  
問い合わせ窓口：\[restricted\_site\_mail\]*

*This is a message from \[restricted\_site\_name\_en\].  
Your application below has been rejected.*

*Application No.：\[restricted\_activity\_id\]  
Name：\[restricted\_fullname\]  
E-mail：\[restricted\_mail\_address\]  
Affiliation：\[restricted\_university\_institution\]  
Title of research：\[restricted\_research\_title\]  
Dataset requested ：\[restricted\_data\_name\]  
Application date：\[restricted\_application\_date\]*

*Please do not reply to this email as it has been sent automatically.  
Please direct all inquiries to the following address.  
Also, if you received this message in error, please notify \[restricted\_site\_name\_en\].*

*\[restricted\_site\_name\_en\]：\[restricted\_site\_url\]  
E-mail：\[restricted\_site\_mail\]*

*⑥ DLリンクをクリックし、DLした申請者に対して利用報告のアドレスが送付される  
Subject: 利用報告の登録のお願い／Request for register Data Usage Report  
本文:  
\[restricted\_site\_name\_ja\]です。  
下記で申請いただいデータについてダウンロードされたことを確認しました。*

*申請番号： \[restricted\_usage\_activity\_id\]  
登録者名： \[restricted\_fullname\]  
メールアドレス： \[restricted\_mail\_address\]  
所属機関：\[restricted\_university\_institution\]  
研究題目：\[restricted\_research\_title\]  
申請データ：\[restricted\_data\_name\]  
申請年月日：\[restricted\_application\_date\]*

*ダウンロードしたデータについて、下記のリンクから利用報告の登録をお願いします。*

*\[usage\_report\_url\]*

*このメールは自動送信されているので返信しないでください。  
お問い合わせは下記までお願いします。また、このメールに心当たりのない方は、\[restricted\_site\_name\_ja\]までご連絡ください。*

*\[restricted\_site\_name\_ja\]：\[restricted\_site\_url\]  
問い合わせ窓口：\[restricted\_site\_mail\]*

*This is a message from \[restricted\_site\_name\_en\].  
We have confirmed that the dataset which you registered at below has been downloaded.*

*Application No.：\[restricted\_usage\_activity\_id\]  
Name：\[restricted\_fullname\]  
E-mail：\[restricted\_mail\_address\]  
Affiliation：\[restricted\_university\_institution\]  
Title of research：\[restricted\_research\_title\]  
Dataset requested ：\[restricted\_data\_name\]  
Application date：\[restricted\_application\_date\]*

*For the downloaded data, please register the Data Usage Report by the link below.*

*\[usage\_report\_url\]*

*Please do not reply to this email as it has been sent automatically.  
Please direct all inquiries to the following address.  
Also, if you received this message in error, please notify \[restricted\_site\_name\_en\].*

*\[restricted\_site\_name\_en\]：\[restricted\_site\_url\]*

*E-mail：\[restricted\_site\_mail\]*

*⑦ 管理者画面より、申請者に対して利用報告のリマインドを行う  
Subject: 利用報告の登録のお願い／Request for register Data Usage Report  
本文:  
\[restricted\_site\_name\_ja\]です。  
現時点で、下記の利用報告が登録されていません*

*報告番号：\[restricted\_activity\_id\]  
登録者名：\[restricted\_fullname\]  
メールアドレス：\[restricted\_mail\_address\]  
所属機関：\[restricted\_university\_institution\]  
利用データ：\[restricted\_data\_name\]  
データダウンロード日：\[data\_download\_date\]*

*下記のリンクから利用報告の登録をお願いします。*

*\[usage\_report\_url\]*

*このメールは自動送信されているので返信しないでください。  
お問い合わせは下記までお願いします。また、このメールに心当たりのない方は、\[restricted\_site\_name\_ja\]までご連絡ください。*

*\[restricted\_site\_name\_ja\]：\[restricted\_site\_url\]  
問い合わせ窓口：\[restricted\_site\_mail\]*

*This is a message from \[restricted\_site\_name\_en\].  
At this time, the Data Usage Report below has not been registered.*

*Usage Report No.：\[restricted\_activity\_id\]  
Name：\[restricted\_fullname\]  
E-mail：\[restricted\_mail\_address\]  
Affiliation：\[restricted\_university\_institution\]  
Usage Dataset：\[restricted\_data\_name\]  
Download date：\[data\_download\_date\]*

*Please register the Data Usage Report from the link below.*

*\[usage\_report\_url\]*

*Please do not reply to this email as it has been sent automatically.  
Please direct all inquiries to the following address.  
Also, if you received this message in error, please notify \[restricted\_site\_name\_en\].*

*\[restricted\_site\_name\_en\]：\[restricted\_site\_url\]  
E-mail：\[restricted\_site\_mail\]*

  - > 更新履歴

<table>
<thead>
<tr class="header">
<th>日付</th>
<th>GitHubコミットID</th>
<th>更新内容</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><blockquote>
<p>2023/08/31</p>
</blockquote></td>
<td>353ba1deb094af5056a58bb40f07596b8e95a562</td>
<td>初版作成</td>
</tr>
</tbody>
</table>### Render

#### 目的・用途


#### 利用方法


#### 機能内容


#### 関連モジュール

#### 更新履歴

| 日付 | GithubコミットID | 更新内容 |
| :---         | :---:      | :---:|
| git status   | git status     | git status    |
| git diff     | git diff       | git diff      |
